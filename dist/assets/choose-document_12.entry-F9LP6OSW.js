import{ChooseDocument as yK}from"./choose-document-5d44cc5e-CaLmHEeo.js";import{r as ph,c as Eu,h as he,H as JO,g as Q4,F as Z4}from"./index-J-0ILV5s.js";import{i as js}from"./translations-d180e65d-Bu5TNlG5.js";import{a as jW}from"./store-88a4e8c3-BR2RF-gK.js";import{E as GW,S as $4,M as tH}from"./constants-b0586278-CreQZ6no.js";import{I as WW,R as GE}from"./index-Wls4Xw-r.js";import{TipWidget as bK}from"./tip-widget-41d24bce-U5QQnrgp.js";import{g as o5,c as YE}from"./_commonjsHelpers-1789f0cf-Cpj98o6Y.js";import{g as eH,E as Y1}from"./locale-1caf9e5c-N3Scn86z.js";import{S as MG}from"./constants-0e7bb44b-Hf6vwfXF.js";import"./browser-6b4c8cad-DKsL9QIc.js";const nH={AF:"Afghanistan",AX:"Aland Islands",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AQ:"Antarctica",AG:"Antigua And Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia And Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"British Indian Ocean Territory",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos (Keeling) Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CD:"Congo, Democratic Republic",CK:"Cook Islands",CR:"Costa Rica",CI:'Cote D"Ivoire',HR:"Croatia",CU:"Cuba",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands (Malvinas)",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Territories",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard Island & Mcdonald Islands",VA:"Holy See (Vatican City State)",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran, Islamic Republic Of",IQ:"Iraq",IE:"Ireland",IM:"Isle Of Man",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KR:"Korea",KP:"North Korea",KW:"Kuwait",KG:"Kyrgyzstan",LA:'Lao People"s Democratic Republic',LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia, Federated States Of",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory, Occupied",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",BL:"Saint Barthelemy",SH:"Saint Helena",KN:"Saint Kitts And Nevis",LC:"Saint Lucia",MF:"Saint Martin",PM:"Saint Pierre And Miquelon",VC:"Saint Vincent And Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome And Principe",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",GS:"South Georgia And Sandwich Isl.",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard And Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad And Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks And Caicos Islands",TV:"Tuvalu",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States Outlying Islands",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Vietnam",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",WF:"Wallis And Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"},iH=".sc-country-widget-h{width:var(--maxWidthField)}.dropdown.sc-country-widget{display:flex;align-items:center;justify-content:space-between;padding:0px 8px;border:1px solid var(--borderColor);background-color:var(--whiteColor);border-radius:8px;height:var(--heightField);width:100%;position:relative}.dropdown.sc-country-widget:hover,.dropdown.sc-country-widget:focus{border:1px solid var(--secondaryColor);cursor:pointer}.dropdown.sc-country-widget>input.sc-country-widget{flex:1;border:none;outline:none;height:100%;background-color:var(--whiteColor)}.dropdown-overlay.sc-country-widget{position:fixed;inset:0;z-index:9998}.dropdown-menu.sc-country-widget{border-radius:8px;overflow:auto;position:fixed;z-index:9999;width:100%;margin:0;left:0;padding:0;top:calc(var(--heightField) + 4px);border:1px solid var(--borderColor);max-height:calc(var(--heightField) * 6)}.dropdown-menu.sc-country-widget:hover,.dropdown-menu.sc-country-widget:focus{border:1px solid var(--secondaryColor)}.dropdown-menu-item.sc-country-widget{display:flex;align-items:center;padding:0 16px;height:40px;border-top:1px solid var(--borderColor);background-color:var(--whiteColor)}.dropdown-menu-item.is-selected.sc-country-widget{background-color:var(--primaryColor)}.dropdown-menu-item.sc-country-widget:first-of-type{border-top:none}.dropdown-menu-item.sc-country-widget:hover,.dropdown-menu-item.sc-country-widget:focus{background-color:var(--hoverBackground);cursor:pointer;font-weight:600}.dropdown-remove.sc-country-widget{cursor:pointer;border:none;background-color:transparent;padding:0;margin:0;margin-right:4px;width:24px;height:24px}",rH=iH,sH=class{constructor(Y){ph(this,Y),this.changeField=Eu(this,"changeField"),this.getPositionElement=()=>{const{top:Z,width:ct,left:mt}=this.el.getBoundingClientRect();this.position={top:Z,width:ct,left:mt}},this.handleOpenMenu=()=>{this.openMenu=!this.openMenu,this.getPositionElement()},this.handleSelectOption=Z=>{this.innerValue=Z,this.openMenu=!1,this.changeField.emit({name:this.name,value:Z})},this.handleInputChange=Z=>{const ct=Z.target;this.searchText=ct.value},this.handleRemoveValue=()=>{this.innerValue="",this.searchText="",this.changeField.emit({name:this.name,value:""})},this.excludeCountries=[],this.value="",this.name=void 0,this.openMenu=!1,this.searchText="",this.innerValue=this.value,this.position={top:0,width:0,left:0}}getCountries(){const Y=Object.entries(nH).filter(([Z])=>!this.excludeCountries.includes(Z));return this.searchText?Y.filter(([Z])=>js.t(Z).toLocaleLowerCase().includes(this.searchText.toLocaleLowerCase())).map(([Z])=>({code:Z,value:js.t(Z)})):Y.map(([Z])=>({code:Z,value:js.t(Z)}))}componentDidLoad(){window.addEventListener("resize",this.getPositionElement)}disconnectedCallback(){window.removeEventListener("resize",this.getPositionElement)}render(){return he(JO,{key:"a698ec0f2c53380ef9d1e6cfbbd99d225a9aaf9e"},he("div",{key:"1e04089a15a49d8cbf138e320f181cbafc993b4e",id:"dropdown",class:"dropdown",role:"button",onClick:this.handleOpenMenu},he("input",{key:"d892945d6ca7e97c193eb7c3d1b684a56746fa36",class:"fs-s",autoComplete:"off",value:this.innerValue?js.t(this.innerValue):void 0,onInput:this.handleInputChange,placeholder:js.t("Select a country"),required:!0}),this.innerValue&&he("button",{key:"4f07fcf2c73243883a3d12d23232d683b15a60eb",class:"dropdown-remove",type:"button",onClick:this.handleRemoveValue},he("icon-widget",{key:"5d6a1dd702d84e7508e7b007fbf82830218fc5d0",icon:"X"})),he("icon-widget",{key:"6f85086da88ba65e1ae35c11624899db35acf8aa",icon:"ChevronDown"})),this.openMenu&&he("div",{key:"c096100501b27015f21593cbf2f39f70bf554840"},he("span",{key:"1f2ddfd57e73f0611c94ebfb729f5f7532874fab",class:"dropdown-overlay",onClick:this.handleOpenMenu}),he("ul",{key:"e6a9586c000312bc81751bad8e6e24677f9303d0",class:"dropdown-menu",role:"menu",style:{top:`${this.position.top+44}px`,width:`${this.position.width}px`,left:`${this.position.left}px`}},this.getCountries().map(Y=>he("li",{key:Y.code,role:"menuitem",onClick:()=>this.handleSelectOption(Y.code),class:{"fs-s":!0,"dropdown-menu-item":!0,"is-selected":this.innerValue===Y.code}},Y.value)))))}get el(){return Q4(this)}};sH.style=rH;const oH="section.sc-desktop-view{height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;row-gap:48px;padding:0 8px}section.sc-desktop-view>p.sc-desktop-view{font-family:inherit;margin:0;font-size:18px;line-height:22px;text-align:center}",aH=oH,cH=class{constructor(Y){ph(this,Y),this.getAnimation=Z=>{const ct={[jW.selphid]:"document-desktop-loading.lottie",[jW.selphi]:"face-desktop-loading.lottie",default:"document-desktop-loading.lottie"};return ct[Z]||ct.default},this.widget=void 0,this.error=void 0}render(){return he("section",{key:"273c87893f8a989788122efb17819d9d4f1a4816"},he("lottie-widget",{key:"a7b5af738811e8f5b05446089af9ded945b7ccb8",animation:this.getAnimation(this.widget),width:250,height:250}),he("p",{key:"66d1bb85d11bf1547f2cc24c2d1eb94729115ba3"},js.t("We are")," ",he("strong",{key:"7d7074bbfea3d09a8f6f42232b5437c6b540517a"},js.t("validating your identity"),".",he("br",{key:"cfbb33cfaaf0e0cf206fed511b74aa92798ae807"})),js.t("Continue the process from your cell phone")))}};cH.style=aH;const dH=":host{flex:1;display:flex;flex-direction:column;justify-items:center;align-items:center;box-shadow:0px 2px 14px 0px #EAEEF6;max-width:800px;padding:20px 20px 70px 20px;margin:auto;width:100%;min-width:250px}.header{display:flex;align-items:center;position:relative;width:100%;padding-bottom:8px}.header>:first-child{display:flex;flex:1;justify-content:center}.header>:nth-child(2){position:absolute;right:0;cursor:pointer}h2{font-size:24px;line-height:32px;font-weight:600;margin:0}h3{font-size:18px;line-height:27px;font-weight:600;margin:0}.section-container{display:flex;flex-direction:column;justify-items:center;align-items:center}p{font-size:14px;margin:0}button{background-color:var(--UI--colors-primary400, #7636FC);min-width:300px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:0;color:var(--UI--colors-white, #FFFFFF);cursor:pointer;font-size:16px;line-height:24px;font-weight:600;font-family:inherit;margin-top:70px}button:hover{background-color:var(--UI--colors-primary500, #572BB6)}",uH=dH,lH=class{constructor(Y){ph(this,Y),this.exceptionError=Eu(this,"exceptionError"),this.recordingFinish=Eu(this,"recordingFinish"),this.userCancel=Eu(this,"userCancel"),this.handleRecordingResult=()=>Z=>{this.showWidget=!1,this.recordingFinish.emit(Z.detail)},this.handlePermissionError=()=>()=>{this.error=GW.MICROPHONE_PERMISSIONS},this.handleUserCancel=()=>()=>{this.showWidget=!1,this.userCancel.emit()},this.handleError=()=>()=>{this.showWidget=!1,this.exceptionError.emit()},this.clearAppTimeout=()=>{this.appTimeout&&clearTimeout(this.appTimeout)},this.handleRecording=()=>()=>{this.appTimeout=setTimeout(()=>{this.error=GW.TIMEOUT},this.timeout*60*1e3)},this.class=void 0,this.language=void 0,this.sentences=void 0,this.audioLength=$4,this.showUserCancel=!0,this.debugMode=!1,this.license=void 0,this.bundlePath=void 0,this.timeout=tH,this.showWidget=!0,this.error=void 0,this.timeExceeded=!1}componentWillLoad(){var Y;!((Y=this.sentences)===null||Y===void 0)&&Y.length||this.handleError()()}disconnectedCallback(){this.clearAppTimeout()}handleTimeout(){this.showWidget||this.clearAppTimeout()}render(){var Y;return this.showWidget?he(JO,{class:this.class},he("div",{class:"header"},he("facephi-logo",null),this.showUserCancel&&he("x-icon",{onClick:this.handleUserCancel()})),this.error?he("message-error",{type:this.error,language:this.language}):!((Y=this.sentences)===null||Y===void 0)&&Y.length?he("voice-recording",{bundlePath:this.bundlePath,license:this.license,language:this.language,audioLength:this.audioLength,sentences:this.sentences,debugMode:this.debugMode,onRecordingResult:this.handleRecordingResult(),onPermissionError:this.handlePermissionError(),onVoiceError:this.handleError(),onRecording:this.handleRecording()}):null):null}static get watchers(){return{showWidget:["handleTimeout"]}}};lH.style=uH;const hH=".sc-loading-ellipsis-h{display:flex;flex:1;flex-direction:column;width:100%;height:100%}.loading.sc-loading-ellipsis{display:flex;flex:1;height:100%;width:100%;justify-content:center;align-items:center;position:relative}.loading.sc-loading-ellipsis p.sc-loading-ellipsis{padding-top:200px;font-weight:bold;color:#243760}.lds-ellipsis.sc-loading-ellipsis{width:160px;height:100px;display:inline-block;overflow:hidden;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%)}.lds-ellipsis.sc-loading-ellipsis div.sc-loading-ellipsis{position:absolute;top:33px;width:24px;height:24px;border-radius:50%;background:#243760;animation-timing-function:cubic-bezier(0, 1, 1, 0)}.lds-ellipsis.sc-loading-ellipsis div.sc-loading-ellipsis:nth-child(1){left:20px;animation:lds-ellipsis1 0.45s infinite}.lds-ellipsis.sc-loading-ellipsis div.sc-loading-ellipsis:nth-child(2){left:20px;animation:lds-ellipsis2 0.45s infinite}.lds-ellipsis.sc-loading-ellipsis div.sc-loading-ellipsis:nth-child(3){left:calc(20px + 48px);animation:lds-ellipsis2 0.45s infinite}.lds-ellipsis.sc-loading-ellipsis div.sc-loading-ellipsis:nth-child(4){left:calc(20px + 48px + 48px);animation:lds-ellipsis3 0.45s infinite}@keyframes lds-ellipsis1{0%{transform:scale(0)}100%{transform:scale(1)}}@keyframes lds-ellipsis2{0%{transform:translate(0, 0)}100%{transform:translate(48px, 0)}}@keyframes lds-ellipsis3{0%{transform:scale(1)}100%{transform:scale(0)}}",pH=hH,_H=class{constructor(Y){ph(this,Y),this.text=void 0}render(){return he("div",{key:"c00c34e5f198340d6d64127b5a2dda350b1c8cf6",class:"loading"},he("div",{key:"0fd306327bf3bc71304302459df4c41249c9a8a5",class:"lds-ellipsis"},he("div",{key:"e91b43133031ff78688543d25b817b4327c38aa0"}),he("div",{key:"fdcf8aa8ed48ec70569afbc86b6dd361651a0faf"}),he("div",{key:"e12be63c05bc6342ab9eae37517623bf15f95448"}),he("div",{key:"bf11586103e013b09beb2d73840800a0d1def651"})),this.text&&he("p",{key:"77391ba4cda0e473164a025d063f7be6d90517d1"},this.text))}};_H.style=pH;const EH=".sc-radio-group-h{width:var(--maxWidthField)}.radio-group.sc-radio-group{display:flex;flex-direction:column;row-gap:18px;width:100%;padding:0;margin:0}.radio-button.sc-radio-group{display:inline-flex;align-items:center;position:relative;width:max-content}.radio-button.sc-radio-group input[type='radio'].sc-radio-group+span.sc-radio-group,.radio-button.sc-radio-group input[type='checkbox'].sc-radio-group+span.sc-radio-group{display:inline-block;width:16px;height:16px;position:relative;margin-right:8px;background:var(--whiteColor);border:1px solid var(--borderColor);transition:all 250ms ease}.radio-button.sc-radio-group input[type='radio'].sc-radio-group+span.sc-radio-group{border-radius:50%}.radio-button.sc-radio-group input[type='checkbox'].sc-radio-group+span.sc-radio-group{border-radius:2.5px}.radio-button.sc-radio-group input[type='radio'].sc-radio-group,.radio-button.sc-radio-group input[type='checkbox'].sc-radio-group{opacity:0;position:absolute;width:100%;border:0px;z-index:1;left:0px;top:0px;margin:0px;height:100%;cursor:pointer}.radio-button.sc-radio-group input.sc-radio-group:checked+span.sc-radio-group{background:var(--secondaryColor);box-shadow:inset 0 0 0 2.5px var(--whiteColor)}.radio-button.sc-radio-group input.sc-radio-group:disabled+span.sc-radio-group{background-color:var(--backgroundDisabled);border-color:var(--backgroundDisabled);cursor:default}.radio-button.sc-radio-group input.sc-radio-group:disabled:checked+span.sc-radio-group{background-color:var(--color-grey300)}.radio-button.sc-radio-group input.sc-radio-group:hover:not(:disabled)+span.sc-radio-group,.radio-button.sc-radio-group input.sc-radio-group:focus:not(:disabled)+span.sc-radio-group{border-color:var(--secondaryColor)}.radio-button.sc-radio-group input.sc-radio-group:hover:not(:disabled)+span.sc-radio-group+label.sc-radio-group,.radio-button.sc-radio-group input.sc-radio-group:focus:not(:disabled)+span.sc-radio-group+label.sc-radio-group{font-weight:600}",mH=EH,fH=class{constructor(Y){ph(this,Y),this.changeField=Eu(this,"changeField"),this.name=void 0,this.options=[],this.selected="",this.innerSelect=this.selected}handleChange(Y){const Z=Y.target;this.innerSelect=Z.value,this.changeField.emit({name:this.name,value:this.innerSelect})}render(){return he("ul",{key:"72909bda31ffd298e4d66222bb5d45f43544d938",class:"radio-group",role:"radiogroup"},this.options.map(Y=>he("li",{class:"radio-button"},he("input",{type:"radio",id:Y.value,name:this.name,value:Y.value,checked:this.innerSelect===Y.value,disabled:Y.disabled,onChange:Z=>this.handleChange(Z)}),he("span",null),he("label",{class:"fs-sm",htmlFor:Y.value},Y.label))))}};fH.style=mH;const gH=`.sc-results-info-h {
  --radius: 8px;
  --maxWidth: 800px;
  --gap: 16px;

  @media (max-width: 767px) {
    --maxWidth: 100%;
  }
}

.congratulations.sc-results-info {
  background-color: #243760;
  max-width: var(--maxWidth);
  padding: 20px 0;
  border-radius: var(--radius);
  width: 100%;
}

.grid.sc-results-info {
  display: flex;
  flex-direction: column;
  row-gap: var(--gap);
  padding-bottom: 12px;
}

.card.sc-results-info {
  background-color: var(--whiteColor);
  padding: 16px;
  box-shadow: 0px 2px 14px 0px #eaeef6;
  border-radius: var(--radius);
  max-width: var(--maxWidth);
  width: 100%;
}

.card.sc-results-info .results.sc-results-info {
  display: flex;
  flex-direction: column;
  row-gap: var(--gap);
  align-items: center;
  margin: 0 auto;
  max-width: 400px;

  @media (max-width: 767px) {
    max-width: 100%;
  }
}

.row.sc-results-info {
  display: flex;
  align-items: center;
  column-gap: 12px;
}

.row.sc-results-info img.sc-results-info {
  width: 164px;
  aspect-ratio: 1/1;
  margin-bottom: 8px;
  border-radius: 32px;
  object-fit: cover;

  @media (max-width: 767px) {
    width: 116px;
  }
}

.result-message.sc-results-info {
  padding: 16px;
  border-radius: 16px;
}

.result-message--success.sc-results-info {
  background-color: #d9f2e1;
}

.result-message--error.sc-results-info {
  background-color: #fcdad9;
}

.mb-16.sc-results-info {
  margin-bottom: 16px;
}

figure.sc-results-info {
  margin: 0;
}

.card-user.sc-results-info {
  background-color: var(--whiteColor);
  box-shadow: 0px 2px 14px 0px #eaeef6;
  border-radius: var(--radius);
  max-width: var(--maxWidth);
  width: 100%;
}

.card-user.sc-results-info > p.sc-results-info {
  padding: 14px 16px;
}

.card-user.sc-results-info li.sc-results-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  column-gap: 8px;
  padding: 14px 16px;
  border-top: 1px solid var(--backgroundDisabled);
}`,TH=gH,SH=class{constructor(Y){ph(this,Y),this.data={},this.finish=void 0,this.buttonText=void 0}render(){return he("div",{key:"3314bbb21ae0a41d84971492dedb75c97c1cedc2",class:"form"},he("section",{key:"9def1378e5d0952c7f2c5e98f8a26fe324a3af06",class:"form-content grid"},he("p",{key:"2695fcd258f71501443c7ba49e4e28ccb0789d85",class:"fs-l fw-600 fc-white text-center congratulations"},WW[this.data.status||GE.PENDING].title),he("p",{key:"f61ea0d3f877f6bbc3175404b912978787e60bbd"},WW[this.data.status||GE.PENDING].message),(!!Object.keys(this.data.faceMatch||{}).length||!!Object.keys(this.data.passiveLiveness||{}).length)&&he("div",{key:"c314f9d1ef2a09ff4d9b585d4312557b4cea542d",class:"card"},he("p",{key:"bf39fe4b307b3a15075e5d19bea1c0aad4388a61",class:"fs-sm fc-secondary mb-16"},js.t("BIOMETRIC VALIDATION")),he("div",{key:"0564e06a1505beba02113e5f8bf7a20472a3f153",class:"results"},he("p",{key:"d6b04669ff8668082573bab9837052099b19ab66",class:"fs-l fw-600"},js.t("FACE VERIFICATION")),he("div",{key:"824b8bd12e7a7f0548c0d341ce3c57bb6690ce02",class:"row"},this.data.faceMatch.sourceFace&&he("figure",{key:"971764b9368d0291b21157c2b813032123207b59"},he("img",{key:"a5dab85c06fa9df0615cae10a06d53a0ac087821",src:this.data.faceMatch.sourceFace}),he("p",{key:"c6f0fdae7d75e161decbfdb72a999f4b07ac65ba",class:"fs-sm fc-secondary text-center"},"Selfie")),he("icon-widget",{key:"b28aa9e454bad86f5b278c1ee04b7b6024dbb7ef",size:"40",icon:this.data.faceMatch.status===GE.SUCCEEDED?"ImageOK":this.data.faceMatch.status===GE.FAILED?"ImageKO":null}),this.data.faceMatch.targetFace&&he("figure",{key:"cf0ee9e2254dba7c91660dfbe5d20a0c2126a1bd"},he("img",{key:"3a720ffef64356ffe4bb3820aa2e68b9a627582a",src:this.data.faceMatch.targetFace}),he("p",{key:"34733315e20398a6bbc5b38e857a71452a230677",class:"fs-sm fc-secondary text-center"},js.t("Document")))),this.data.faceMatch.status!==GE.PENDING&&he("p",{key:"7aa0b6b7463fa5c3f9491fd3b5b445d7df97f098",class:{"fs-sm":!0,"text-center":!0,"result-message":!0,"fw-600":!0,"fc-error result-message--error":this.data.faceMatch.status!==GE.SUCCEEDED,"fc-success result-message--success":this.data.faceMatch.status===GE.SUCCEEDED}},`
                      ${this.data.faceMatch.status===GE.SUCCEEDED?js.t("The person in the selfie and the photo on the document are the same"):js.t("The person in the selfie and the photo on the document are not the same")}
                    `))),!!Object.keys(this.data.personalInformation||{}).length&&he("div",{key:"7a384e48e80d81ed5d63d87356640b86b8fbed5c",class:"card-user"},he("p",{key:"3a905ba137513705d857be0e6507362f5dd6ddb9",class:"fs-sm fc-secondary"},js.t("DATA OBTAINED")),he("ul",{key:"f8e219d2322c1a4435559ff44d8e6dc292dc0f46"},Object.entries(this.data.personalInformation).map(([Y,Z],ct)=>he("li",{key:ct},he("p",{class:"fs-m"},Y),he("p",{class:"fs-m fw-600"}," ",Z||"-")))))),he("section",{key:"35444d45d2995789467de7bedb8a459b5c34cdaa",class:"form-submit"},he("button",{key:"00402b1ced620255866cf64885278dbaeb208301",class:"button",onClick:this.finish},this.buttonText||js.t("FINISH"))))}};SH.style=TH;const RH=`.sc-results-loading-h {
  display: flex;
  flex-direction: column;
  row-gap: 16px;
  align-items: center;
  margin-top: 44px;
  padding: 16px;
  --radius: 8px;
  --maxWidth: 800px;

  @media (max-width: 767px) {
    --maxWidth: 100%;
  }
}

.title-card.sc-results-loading {
  background-color: var(--fontSecondaryColor);
  max-width: var(--maxWidth);
  width: 100%;
  padding: 4px 0;
  border-radius: var(--radius);
}

.card.sc-results-loading {
  background-color: var(--whiteColor);
  padding: 8px;
  padding-left: 16px;
  box-shadow: 0px 2px 14px 0px #eaeef6;
  max-width: var(--maxWidth);
  width: 100%;
  border-radius: var(--radius);
}

.text-info.sc-results-loading {
  text-align: center;
  @media (max-width: 767px) {
    text-align: start;
  }
}

.card-header.sc-results-loading {
  display: flex;
  align-items: center;
  justify-content: space-between;
}`,CH=RH,vH=class{constructor(Y){ph(this,Y),this.buttonText=void 0,this.finish=void 0}render(){return he(JO,{key:"1c2a8b78f78cccab0f575eb54680395a74c937f3"},he("h1",{key:"2179e4caf1f514eadd31c7f39514cd8896573ee9",class:"fs-xl"},js.t("Results")),he("p",{key:"f07ecb7f6365edf18edacb88ece6436c77524542",class:"title-card fs-m text-center fc-white text-uppercase"},js.t("ID Document")),he("section",{key:"42a65b5ed64e40e07b518aee847b7cf61ad66b18",class:"card"},he("div",{key:"12f04a6ddb056d3a7bd6320dee06af16e320b8bb",class:"card-header"},he("p",{key:"249df3697ead71a8583851b46519a61d9a03280b",class:"text-uppercase fs-sm"},js.t("ONBOARDING RESULT")),he("loading-spinner",{key:"89d6eeac8d7ef95ca0096b9fe3c38fc62abf9c6c"})),he("p",{key:"b02f68eee22ab27128a2bf2ee101bc0a486331de",class:"text-info fs-l fw-600"},js.t("ONBOARDING IN PROGRESS")),he("p",{key:"a08d53f02a6bc6869ae3df283c2492e01aba4896",class:"text-info fs-s fc-secondary"},js.t("We are analyzing the information"),"…")),he("button",{key:"04ac1f75dd922406977fae8077d3295c2d9f4b90",class:"button",onClick:this.finish},this.buttonText||js.t("FINISH")))}};vH.style=CH;const IH=".upload-document.sc-upload-widget{display:flex;flex-direction:column;align-items:center;row-gap:4px}.button-upload.sc-upload-widget{position:relative;height:48px;padding:0px 24px;border-radius:8px;cursor:pointer;background:var(--backgroundColor);display:flex;align-items:center;justify-content:center;column-gap:8px;outline:1px solid var(--secondaryColor)}.button-upload.sc-upload-widget p.sc-upload-widget{font-size:16px;line-height:24px;font-family:inherit;color:var(--fontColor);font-weight:600}.input-hide.sc-upload-widget{position:absolute;left:0;opacity:0;width:100%;height:100%;z-index:1;cursor:pointer}.svg.sc-upload-widget{fill:var(--secondaryColor) !important}.subtitle.sc-upload-widget{margin-bottom:12px}",yH=IH,AH=class{constructor(Y){ph(this,Y),this.changeField=Eu(this,"changeField"),this.handleAcceptFiles=()=>{if(this.mimeTypes)return this.mimeTypes.join(",")},this.getMBFileSize=Z=>(Z/1024/1024).toFixed(2),this.handleFileChange=Z=>{const ct=Z.target;if(ct.files&&ct.files[0]){const mt=ct.files[0];if(this.maxSize&&mt.size>this.maxSize)this.errorMessage=`The file size exceeds the limit (${this.getMBFileSize(mt.size)}MB).`;else{const Rt=new FileReader;Rt.readAsDataURL(mt),Rt.onloadend=()=>{this.errorMessage="",this.fileName=mt.name;const Nt=Rt.result;this.changeField.emit({name:this.name,value:Nt})}}}},this.normalizeMimeType=()=>this.mimeTypes.map(Z=>{const ct=Z.lastIndexOf("/");return ct!==-1?`.${Z.substring(ct+1)}`:Z}).join(", "),this.label=void 0,this.subTitle=void 0,this.errorMessage=void 0,this.name=void 0,this.isRequired=void 0,this.mimeTypes=void 0,this.maxSize=3145728,this.fileName=void 0}render(){return he("section",{key:"7e7c5a834f0c16042a5dc1b6581930c47445357a",class:"upload-document"},this.label&&he("p",{key:"32595cf977deebcd3fa36d30440b022d89ab674b",class:"fs-m text-center subtitle"},this.label),he("div",{key:"47ac3d9e24b26b755fef3fb538005aa42e7078d5",class:"button-upload"},he("input",{key:"739b77c73a014e598f262f19e5081e26162c032c",class:"input-hide",onChange:this.handleFileChange,accept:this.handleAcceptFiles(),type:"file",name:this.name,required:this.isRequired}),he("icon-widget",{key:"d6a5d7d7310a5c97dc32b69a1be96d3d555fe2d4",icon:"Plus",class:"svg"}),he("p",{key:"9228cae2406bbec6c29c8636395f69335ae719e3"},"Upload here your file")),he("p",{key:"4a70adade02f250e205433fd3b368207c842d832",class:"fs-s text-center"},this.fileName?this.fileName:he("span",null,this.mimeTypes&&`File must be ${this.normalizeMimeType()}`,this.mimeTypes&&this.maxSize&&" - ",this.maxSize&&`Max file size: ${this.getMBFileSize(this.maxSize)}MB`)),this.errorMessage&&he("p",{key:"e31b46762924d3719d550033141886343905833e",class:"fs-s fc-error"},this.errorMessage))}};AH.style=yH;const a5=({onChange:Y})=>{let Z=0,ct;const mt=()=>{ct=setInterval(()=>{const se=Z%60,te=Math.floor(Z/60),pe=String(se).length===1?`0${se}`:se,ve=String(te).length===1?`0${te}`:te;Z+=1,Y(`${ve}:${pe}`)},1e3)};return{start:()=>{Z=0,mt()},stop:()=>{ct&&clearInterval(ct),Z=0,Y("")}}};var WE;(function(Y){Y.CREDENTIALS_REQUEST="CREDENTIALS_REQUEST",Y.CREDENTIALS_RESPONSE="CREDENTIALS_RESPONSE",Y.WAITING_CONFIRMATION="WAITING_CONFIRMATION",Y.IDENTIFICATION_STARTED="IDENTIFICATION_STARTED",Y.STOP="STOP",Y.IDENTIFICATION_STOPPED="IDENTIFICATION_STOPPED"})(WE||(WE={}));const HW=3e4,bH=({apiUrl:Y,apiKey:Z,handleRecording:ct,handleCredentials:mt,handleError:Rt,handleClosed:Nt,handleTimeout:se})=>{let te,pe=!1,ve=!1,De,Qt,le;const Qe=({operation:di,tenant:Lr})=>{Zi(!1),le=Lr,Qt!==di&&(Qt=di)},Te=()=>{mt(void 0),ct==null||ct(!1),fu(!1)},dn=()=>{Te(),te&&te.close(),Zi(!1)},Ei=()=>{if(te&&te.readyState===te.OPEN&&dn(),te=null,Qt){const di=setTimeout(()=>{ji(!0)},HW),Lr=new WebSocket(Y);Lr.onerror=()=>ji(!0),Lr.onmessage=XC=>Da(XC.data),Lr.onopen=()=>{clearTimeout(di),fu(!0),kd()},te=Lr}},ji=di=>{pe!==di&&(Rt(di),pe=di,pe&&dn())},si=di=>{te&&te.readyState===te.OPEN&&te.send(JSON.stringify(di))},mi=()=>{Nt==null||Nt(),dn()},Da=di=>{if(di){const Lr=JSON.parse(di);switch(Lr.type){case WE.CREDENTIALS_RESPONSE:mt(Lr.credentials);break;case WE.IDENTIFICATION_STARTED:fu(!1),ct==null||ct(!0);break;case WE.IDENTIFICATION_STOPPED:mi();break}}},kd=()=>{si({type:WE.CREDENTIALS_REQUEST,apiKey:Z,sessionId:Qt})},fu=di=>{De&&clearTimeout(De),De=null,di&&(De=setTimeout(()=>{se==null||se(),dn()},HW))},Zi=di=>{di&&!ve?(ve=!0,pe=!1,Ei()):ve=!1};return{setParams:Qe,getCredentials:()=>{ve?ji(!0):Zi(!0)},startRecord:()=>{si({type:WE.WAITING_CONFIRMATION,sessionId:Qt,tenantId:le})},stopRecord:()=>{si({type:WE.STOP,apiKey:Z,sessionId:Qt,tenantId:le})}}};var c5={exports:{}};(function(Y,Z){(function(ct,mt){Y.exports=mt()})(YE,function(){function ct(t,n){return n.forEach(function(r){r&&typeof r!="string"&&!Array.isArray(r)&&Object.keys(r).forEach(function(a){if(a!=="default"&&!(a in t)){var d=Object.getOwnPropertyDescriptor(r,a);Object.defineProperty(t,a,d.get?d:{enumerable:!0,get:function(){return r[a]}})}})}),Object.freeze(t)}var mt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof YE<"u"?YE:typeof self<"u"?self:{};function Rt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Nt=function(t){try{return!!t()}catch{return!0}},se=!Nt(function(){var t=(function(){}).bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),te=se,pe=Function.prototype,ve=pe.call,De=te&&pe.bind.bind(ve,ve),Qt=te?De:function(t){return function(){return ve.apply(t,arguments)}},le=Qt({}.isPrototypeOf),Qe=function(t){return t&&t.Math==Math&&t},Te=Qe(typeof globalThis=="object"&&globalThis)||Qe(typeof window=="object"&&window)||Qe(typeof self=="object"&&self)||Qe(typeof mt=="object"&&mt)||function(){return this}()||mt||Function("return this")(),dn=se,Ei=Function.prototype,ji=Ei.apply,si=Ei.call,mi=typeof Reflect=="object"&&Reflect.apply||(dn?si.bind(ji):function(){return si.apply(ji,arguments)}),Da=Qt,kd=Da({}.toString),fu=Da("".slice),Zi=function(t){return fu(kd(t),8,-1)},br=Zi,ol=Qt,fi=function(t){if(br(t)==="Function")return ol(t)},di=typeof document=="object"&&document.all,Lr={all:di,IS_HTMLDDA:di===void 0&&di!==void 0},XC=Lr.all,wn=Lr.IS_HTMLDDA?function(t){return typeof t=="function"||t===XC}:function(t){return typeof t=="function"},gu={},wr=!Nt(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),$1=se,_h=Function.prototype.call,Wn=$1?_h.bind(_h):function(){return _h.apply(_h,arguments)},Eh={},QC={}.propertyIsEnumerable,ZC=Object.getOwnPropertyDescriptor,tU=ZC&&!QC.call({1:2},1);Eh.f=tU?function(t){var n=ZC(this,t);return!!n&&n.enumerable}:QC;var Oo,mh,No=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}},eU=Nt,nU=Zi,qE=Object,iU=Qt("".split),fh=eU(function(){return!qE("z").propertyIsEnumerable(0)})?function(t){return nU(t)=="String"?iU(t,""):qE(t)}:qE,Tu=function(t){return t==null},rU=Tu,sU=TypeError,Md=function(t){if(rU(t))throw sU("Can't call method on "+t);return t},oU=fh,aU=Md,$o=function(t){return oU(aU(t))},$C=wn,cU=Lr.all,fr=Lr.IS_HTMLDDA?function(t){return typeof t=="object"?t!==null:$C(t)||t===cU}:function(t){return typeof t=="object"?t!==null:$C(t)},$r={},zE=$r,JE=Te,dU=wn,tv=function(t){return dU(t)?t:void 0},qi=function(t,n){return arguments.length<2?tv(zE[t])||tv(JE[t]):zE[t]&&zE[t][n]||JE[t]&&JE[t][n]},ta=typeof navigator<"u"&&String(navigator.userAgent)||"",ev=Te,XE=ta,nv=ev.process,iv=ev.Deno,rv=nv&&nv.versions||iv&&iv.version,sv=rv&&rv.v8;sv&&(mh=(Oo=sv.split("."))[0]>0&&Oo[0]<4?1:+(Oo[0]+Oo[1])),!mh&&XE&&(!(Oo=XE.match(/Edge\/(\d+)/))||Oo[1]>=74)&&(Oo=XE.match(/Chrome\/(\d+)/))&&(mh=+Oo[1]);var Pa=mh,ov=Pa,uU=Nt,lU=Te.String,Kc=!!Object.getOwnPropertySymbols&&!uU(function(){var t=Symbol();return!lU(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&ov&&ov<41}),av=Kc&&!Symbol.sham&&typeof Symbol.iterator=="symbol",hU=qi,pU=wn,_U=le,EU=Object,Su=av?function(t){return typeof t=="symbol"}:function(t){var n=hU("Symbol");return pU(n)&&_U(n.prototype,EU(t))},mU=String,Yc=function(t){try{return mU(t)}catch{return"Object"}},fU=wn,gU=Yc,TU=TypeError,kr=function(t){if(fU(t))return t;throw TU(gU(t)+" is not a function")},SU=kr,RU=Tu,Yp=function(t,n){var r=t[n];return RU(r)?void 0:SU(r)},cv=Wn,dv=wn,uv=fr,CU=TypeError,lv={exports:{}},hv=Te,vU=Object.defineProperty,IU=function(t,n){try{vU(hv,t,{value:n,configurable:!0,writable:!0})}catch{hv[t]=n}return n},pv="__core-js_shared__",QE=Te[pv]||IU(pv,{}),_v=QE;(lv.exports=function(t,n){return _v[t]||(_v[t]=n!==void 0?n:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var qc=lv.exports,yU=Md,AU=Object,Ns=function(t){return AU(yU(t))},bU=Ns,wU=Qt({}.hasOwnProperty),Zn=Object.hasOwn||function(t,n){return wU(bU(t),n)},OU=Qt,NU=0,DU=Math.random(),PU=OU(1 .toString),ZE=function(t){return"Symbol("+(t===void 0?"":t)+")_"+PU(++NU+DU,36)},LU=qc,Ev=Zn,kU=ZE,MU=Kc,UU=av,zc=Te.Symbol,$E=LU("wks"),xU=UU?zc.for||zc:zc&&zc.withoutSetter||kU,ze=function(t){return Ev($E,t)||($E[t]=MU&&Ev(zc,t)?zc[t]:xU("Symbol."+t)),$E[t]},VU=Wn,mv=fr,fv=Su,FU=Yp,BU=function(t,n){var r,a;if(dv(r=t.toString)&&!uv(a=cv(r,t))||dv(r=t.valueOf)&&!uv(a=cv(r,t)))return a;throw CU("Can't convert object to primitive value")},jU=TypeError,GU=ze("toPrimitive"),WU=function(t,n){if(!mv(t)||fv(t))return t;var r,a=FU(t,GU);if(a){if(r=VU(a,t,n),!mv(r)||fv(r))return r;throw jU("Can't convert object to primitive value")}return BU(t)},HU=Su,gh=function(t){var n=WU(t,"string");return HU(n)?n:n+""},gv=fr,tm=Te.document,KU=gv(tm)&&gv(tm.createElement),em=function(t){return KU?tm.createElement(t):{}},YU=em,Tv=!wr&&!Nt(function(){return Object.defineProperty(YU("div"),"a",{get:function(){return 7}}).a!=7}),qU=wr,zU=Wn,JU=Eh,XU=No,QU=$o,ZU=gh,$U=Zn,t2=Tv,Sv=Object.getOwnPropertyDescriptor;gu.f=qU?Sv:function(t,n){if(t=QU(t),n=ZU(n),t2)try{return Sv(t,n)}catch{}if($U(t,n))return XU(!zU(JU.f,t,n),t[n])};var e2=Nt,n2=wn,i2=/#|\.prototype\./,Ru=function(t,n){var r=s2[r2(t)];return r==a2||r!=o2&&(n2(n)?e2(n):!!n)},r2=Ru.normalize=function(t){return String(t).replace(i2,".").toLowerCase()},s2=Ru.data={},o2=Ru.NATIVE="N",a2=Ru.POLYFILL="P",Rv=Ru,c2=kr,d2=se,u2=fi(fi.bind),Do=function(t,n){return c2(t),n===void 0?t:d2?u2(t,n):function(){return t.apply(n,arguments)}},_s={},Cv=wr&&Nt(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),l2=fr,h2=String,p2=TypeError,$i=function(t){if(l2(t))return t;throw p2(h2(t)+" is not an object")},_2=wr,E2=Tv,m2=Cv,Th=$i,vv=gh,f2=TypeError,nm=Object.defineProperty,g2=Object.getOwnPropertyDescriptor,im="enumerable",rm="configurable",sm="writable";_s.f=_2?m2?function(t,n,r){if(Th(t),n=vv(n),Th(r),typeof t=="function"&&n==="prototype"&&"value"in r&&sm in r&&!r[sm]){var a=g2(t,n);a&&a[sm]&&(t[n]=r.value,r={configurable:rm in r?r[rm]:a[rm],enumerable:im in r?r[im]:a[im],writable:!1})}return nm(t,n,r)}:nm:function(t,n,r){if(Th(t),n=vv(n),Th(r),E2)try{return nm(t,n,r)}catch{}if("get"in r||"set"in r)throw f2("Accessors not supported");return"value"in r&&(t[n]=r.value),t};var T2=_s,S2=No,Po=wr?function(t,n,r){return T2.f(t,n,S2(1,r))}:function(t,n,r){return t[n]=r,t},Sh=Te,R2=mi,C2=fi,v2=wn,I2=gu.f,y2=Rv,Jc=$r,A2=Do,Xc=Po,Iv=Zn,b2=function(t){var n=function(r,a,d){if(this instanceof n){switch(arguments.length){case 0:return new t;case 1:return new t(r);case 2:return new t(r,a)}return new t(r,a,d)}return R2(t,this,arguments)};return n.prototype=t.prototype,n},Ce=function(t,n){var r,a,d,l,p,E,f,T,R,v=t.target,y=t.global,w=t.stat,B=t.proto,k=y?Sh:w?Sh[v]:(Sh[v]||{}).prototype,U=y?Jc:Jc[v]||Xc(Jc,v,{})[v],G=U.prototype;for(l in n)a=!(r=y2(y?l:v+(w?".":"#")+l,t.forced))&&k&&Iv(k,l),E=U[l],a&&(f=t.dontCallGetSet?(R=I2(k,l))&&R.value:k[l]),p=a&&f?f:n[l],a&&typeof E==typeof p||(T=t.bind&&a?A2(p,Sh):t.wrap&&a?b2(p):B&&v2(p)?C2(p):p,(t.sham||p&&p.sham||E&&E.sham)&&Xc(T,"sham",!0),Xc(U,l,T),B&&(Iv(Jc,d=v+"Prototype")||Xc(Jc,d,{}),Xc(Jc[d],l,p),t.real&&G&&(r||!G[l])&&Xc(G,l,p)))},w2=Math.ceil,O2=Math.floor,N2=Math.trunc||function(t){var n=+t;return(n>0?O2:w2)(n)},yv=N2,Av=function(t){var n=+t;return n!=n||n===0?0:yv(n)},D2=Av,P2=Math.max,XO=Math.min,bv=function(t,n){var r=D2(t);return r<0?P2(r+n,0):XO(r,n)},L2=Av,k2=Math.min,Cu=function(t){return t>0?k2(L2(t),9007199254740991):0},M2=Cu,vu=function(t){return M2(t.length)},U2=$o,QO=bv,wv=vu,ZO=function(t){return function(n,r,a){var d,l=U2(n),p=wv(l),E=QO(a,p);if(t&&r!=r){for(;p>E;)if((d=l[E++])!=d)return!0}else for(;p>E;E++)if((t||E in l)&&l[E]===r)return t||E||0;return!t&&-1}},Ov={includes:ZO(!0),indexOf:ZO(!1)},al=Ov.includes;Ce({target:"Array",proto:!0,forced:Nt(function(){return!Array(1).includes()})},{includes:function(t){return al(this,t,arguments.length>1?arguments[1]:void 0)}});var x2=$r,fc=function(t){return x2[t+"Prototype"]},V2=fc("Array").includes,F2=fr,B2=Zi,j2=ze("match"),Nv=function(t){var n;return F2(t)&&((n=t[j2])!==void 0?!!n:B2(t)=="RegExp")},Dv=Nv,G2=TypeError,$O={};$O[ze("toStringTag")]="z";var qp=String($O)==="[object z]",W2=qp,H2=wn,Xg=Zi,cl=ze("toStringTag"),K2=Object,Y2=Xg(function(){return arguments}())=="Arguments",Es=W2?Xg:function(t){var n,r,a;return t===void 0?"Undefined":t===null?"Null":typeof(r=function(d,l){try{return d[l]}catch{}}(n=K2(t),cl))=="string"?r:Y2?Xg(n):(a=Xg(n))=="Object"&&H2(n.callee)?"Arguments":a},q2=Es,z2=String,La=function(t){if(q2(t)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return z2(t)},J2=ze("match"),tN=Ce,X2=function(t){if(Dv(t))throw G2("The method doesn't accept regular expressions");return t},Q2=Md,eN=La,nN=function(t){var n=/./;try{"/./"[t](n)}catch{try{return n[J2]=!1,"/./"[t](n)}catch{}}return!1},Z2=Qt("".indexOf);tN({target:"String",proto:!0,forced:!nN("includes")},{includes:function(t){return!!~Z2(eN(Q2(this)),eN(X2(t)),arguments.length>1?arguments[1]:void 0)}});var $2=fc("String").includes,Qg=le,Pv=V2,Jt=$2,Zg=Array.prototype,$g=String.prototype,tT=function(t){var n=t.includes;return t===Zg||Qg(Zg,t)&&n===Zg.includes?Pv:typeof t=="string"||t===$g||Qg($g,t)&&n===$g.includes?Jt:n},Mt=Rt(tT),tx=kr,ex=Ns,iN=fh,Lv=vu,rN=TypeError,sN=function(t){return function(n,r,a,d){tx(r);var l=ex(n),p=iN(l),E=Lv(l),f=t?E-1:0,T=t?-1:1;if(a<2)for(;;){if(f in p){d=p[f],f+=T;break}if(f+=T,t?f<0:E<=f)throw rN("Reduce of empty array with no initial value")}for(;t?f>=0:E>f;f+=T)f in p&&(d=r(d,p[f],f,l));return d}},kv={left:sN(!1)},oN=Nt,om=function(t,n){var r=[][t];return!!r&&oN(function(){r.call(null,n||function(){return 1},1)})},Rh=typeof process<"u"&&Zi(process)=="process",aN=kv.left;Ce({target:"Array",proto:!0,forced:!Rh&&Pa>79&&Pa<83||!om("reduce")},{reduce:function(t){var n=arguments.length;return aN(this,t,n,n>1?arguments[1]:void 0)}});var cN=fc("Array").reduce,dN=le,uN=cN,eT=Array.prototype,lN=function(t){var n=t.reduce;return t===eT||dN(eT,t)&&n===eT.reduce?uN:n},Mv=lN,ka=Rt(Mv);let Uv=!0,xv=!0;function am(t,n,r){const a=t.match(n);return a&&a.length>=r&&parseInt(a[r],10)}function dl(t,n,r){if(!t.RTCPeerConnection)return;const a=t.RTCPeerConnection.prototype,d=a.addEventListener;a.addEventListener=function(p,E){if(p!==n)return d.apply(this,arguments);const f=T=>{const R=r(T);R&&(E.handleEvent?E.handleEvent(R):E(R))};return this._eventMap=this._eventMap||{},this._eventMap[n]||(this._eventMap[n]=new Map),this._eventMap[n].set(E,f),d.apply(this,[p,f])};const l=a.removeEventListener;a.removeEventListener=function(p,E){if(p!==n||!this._eventMap||!this._eventMap[n])return l.apply(this,arguments);if(!this._eventMap[n].has(E))return l.apply(this,arguments);const f=this._eventMap[n].get(E);return this._eventMap[n].delete(E),this._eventMap[n].size===0&&delete this._eventMap[n],Object.keys(this._eventMap).length===0&&delete this._eventMap,l.apply(this,[p,f])},Object.defineProperty(a,"on"+n,{get(){return this["_on"+n]},set(p){this["_on"+n]&&(this.removeEventListener(n,this["_on"+n]),delete this["_on"+n]),p&&this.addEventListener(n,this["_on"+n]=p)},enumerable:!0,configurable:!0})}function Vv(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Uv=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function hN(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(xv=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function Fv(){if(typeof window=="object"){if(Uv)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function nT(t,n){xv&&console.warn(t+" is deprecated, please use "+n+" instead.")}function Bv(t){return Object.prototype.toString.call(t)==="[object Object]"}function jv(t){var n;return Bv(t)?ka(n=Object.keys(t)).call(n,function(r,a){const d=Bv(t[a]),l=d?jv(t[a]):t[a],p=d&&!Object.keys(l).length;return l===void 0||p?r:Object.assign(r,{[a]:l})},{}):t}function iT(t,n,r){n&&!r.has(n.id)&&(r.set(n.id,n),Object.keys(n).forEach(a=>{a.endsWith("Id")?iT(t,t.get(n[a]),r):a.endsWith("Ids")&&n[a].forEach(d=>{iT(t,t.get(d),r)})}))}function Gv(t,n,r){const a=r?"outbound-rtp":"inbound-rtp",d=new Map;if(n===null)return d;const l=[];return t.forEach(p=>{p.type==="track"&&p.trackIdentifier===n.id&&l.push(p)}),l.forEach(p=>{t.forEach(E=>{E.type===a&&E.trackId===p.id&&iT(t,E,d)})}),d}var pN=ZE,Wv=qc("keys"),cm=function(t){return Wv[t]||(Wv[t]=pN(t))},_N=!Nt(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),EN=Zn,mN=wn,fN=Ns,gN=_N,Hv=cm("IE_PROTO"),rT=Object,TN=rT.prototype,sT=gN?rT.getPrototypeOf:function(t){var n=fN(t);if(EN(n,Hv))return n[Hv];var r=n.constructor;return mN(r)&&n instanceof r?r.prototype:n instanceof rT?TN:null},SN=Qt,RN=kr,zp=wn,nx=String,oT=TypeError,Kv=function(t,n,r){try{return SN(RN(Object.getOwnPropertyDescriptor(t,n)[r]))}catch{}},aT=$i,cT=function(t){if(typeof t=="object"||zp(t))return t;throw oT("Can't set "+nx(t)+" as a prototype")},Yv=Object.setPrototypeOf||("__proto__"in{}?function(){var t,n=!1,r={};try{(t=Kv(Object.prototype,"__proto__","set"))(r,[]),n=r instanceof Array}catch{}return function(a,d){return aT(a),cT(d),n?t(a,d):a.__proto__=d,a}}():void 0),Jp={},Ch={},Xp=Zn,ix=$o,CN=Ov.indexOf,rx=Ch,vN=Qt([].push),qv=function(t,n){var r,a=ix(t),d=0,l=[];for(r in a)!Xp(rx,r)&&Xp(a,r)&&vN(l,r);for(;n.length>d;)Xp(a,r=n[d++])&&(~CN(l,r)||vN(l,r));return l},dT=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],sx=qv,ox=dT.concat("length","prototype");Jp.f=Object.getOwnPropertyNames||function(t){return sx(t,ox)};var dm={};dm.f=Object.getOwnPropertySymbols;var zv=qi,ax=Jp,cx=dm,dx=$i,ux=Qt([].concat),Jv=zv("Reflect","ownKeys")||function(t){var n=ax.f(dx(t)),r=cx.f;return r?ux(n,r(t)):n},IN=Zn,Xv=Jv,lx=gu,yN=_s,Qv={},hx=qv,AN=dT,uT=Object.keys||function(t){return hx(t,AN)},px=wr,bN=Cv,_x=_s,wN=$i,Zv=$o,Ex=uT;Qv.f=px&&!bN?Object.defineProperties:function(t,n){wN(t);for(var r,a=Zv(n),d=Ex(n),l=d.length,p=0;l>p;)_x.f(t,r=d[p++],a[r]);return t};var lT,Qp=qi("document","documentElement"),ON=$i,$v=Qv,tI=dT,mx=Ch,fx=Qp,gx=em,hT="prototype",eI="script",nI=cm("IE_PROTO"),iI=function(){},NN=function(t){return"<"+eI+">"+t+"</"+eI+">"},DN=function(t){t.write(NN("")),t.close();var n=t.parentWindow.Object;return t=null,n},pT=function(){try{lT=new ActiveXObject("htmlfile")}catch{}var t,n,r;pT=typeof document<"u"?document.domain&&lT?DN(lT):(n=gx("iframe"),r="java"+eI+":",n.style.display="none",fx.appendChild(n),n.src=String(r),(t=n.contentWindow.document).open(),t.write(NN("document.F=Object")),t.close(),t.F):DN(lT);for(var a=tI.length;a--;)delete pT[hT][tI[a]];return pT()};mx[nI]=!0;var um=Object.create||function(t,n){var r;return t!==null?(iI[hT]=ON(t),r=new iI,iI[hT]=null,r[nI]=t):r=pT(),n===void 0?r:$v.f(r,n)},Tx=fr,Sx=Po,PN=Error,Rx=Qt("".replace),LN=String(PN("zxcasd").stack),rI=/\n\s*at [^:]*:[^\n]*/,Cx=rI.test(LN),vx=No,Ix=!Nt(function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",vx(1,7)),t.stack!==7)}),kN=Po,yx=function(t,n){if(Cx&&typeof t=="string"&&!PN.prepareStackTrace)for(;n--;)t=Rx(t,rI,"");return t},Ax=Ix,_T=Error.captureStackTrace,Ud={},sI=Ud,bx=ze("iterator"),wx=Array.prototype,MN=function(t){return t!==void 0&&(sI.Array===t||wx[bx]===t)},UN=Es,oI=Yp,aI=Tu,Ox=Ud,Nx=ze("iterator"),vh=function(t){if(!aI(t))return oI(t,Nx)||oI(t,"@@iterator")||Ox[UN(t)]},Dx=Wn,Px=kr,Lx=$i,kx=Yc,Mx=vh,Ux=TypeError,Zp=function(t,n){var r=arguments.length<2?Mx(t):n;if(Px(r))return Lx(Dx(r,t));throw Ux(kx(t)+" is not iterable")},xN=Wn,VN=$i,FN=Yp,lm=function(t,n,r){var a,d;VN(t);try{if(!(a=FN(t,"return"))){if(n==="throw")throw r;return r}a=xN(a,t)}catch(l){d=!0,a=l}if(n==="throw")throw r;if(d)throw a;return VN(a),r},xx=Do,Vx=Wn,BN=$i,Fx=Yc,Bx=MN,jx=vu,ET=le,cI=Zp,jN=vh,mT=lm,GN=TypeError,hm=function(t,n){this.stopped=t,this.result=n},pm=hm.prototype,Iu=function(t,n,r){var a,d,l,p,E,f,T,R=r&&r.that,v=!(!r||!r.AS_ENTRIES),y=!(!r||!r.IS_RECORD),w=!(!r||!r.IS_ITERATOR),B=!(!r||!r.INTERRUPTED),k=xx(n,R),U=function(W){return a&&mT(a,"normal",W),new hm(!0,W)},G=function(W){return v?(BN(W),B?k(W[0],W[1],U):k(W[0],W[1])):B?k(W,U):k(W)};if(y)a=t.iterator;else if(w)a=t;else{if(!(d=jN(t)))throw GN(Fx(t)+" is not iterable");if(Bx(d)){for(l=0,p=jx(t);p>l;l++)if((E=G(t[l]))&&ET(pm,E))return E;return new hm(!1)}a=cI(t,d)}for(f=y?t.next:a.next;!(T=Vx(f,a)).done;){try{E=G(T.value)}catch(W){mT(a,"throw",W)}if(typeof E=="object"&&E&&ET(pm,E))return E}return new hm(!1)},fT=La,Gx=Ce,Wx=le,WN=sT,_m=Yv,Hx=function(t,n,r){for(var a=Xv(n),d=yN.f,l=lx.f,p=0;p<a.length;p++){var E=a[p];IN(t,E)||r&&IN(r,E)||d(t,E,l(n,E))}},HN=um,dI=Po,uI=No,lI=function(t,n){Tx(n)&&"cause"in n&&Sx(t,"cause",n.cause)},Kx=function(t,n,r,a){Ax&&(_T?_T(t,n):kN(t,"stack",yx(r,a)))},Yx=Iu,KN=function(t,n){return t===void 0?arguments.length<2?"":n:fT(t)},qx=ze("toStringTag"),Em=Error,mm=[].push,$p=function(t,n){var r,a=Wx(xd,this);_m?r=_m(Em(),a?WN(this):xd):(r=a?this:HN(xd),dI(r,qx,"Error")),n!==void 0&&dI(r,"message",KN(n)),Kx(r,$p,r.stack,1),arguments.length>2&&lI(r,arguments[2]);var d=[];return Yx(t,mm,{that:d}),dI(r,"errors",d),r};_m?_m($p,Em):Hx($p,Em,{name:!0});var xd=$p.prototype=HN(Em.prototype,{constructor:uI(1,$p),message:uI(1,""),name:uI(1,"AggregateError")});Gx({global:!0},{AggregateError:$p});var gT,ul,yu,zx=wn,fm=Te.WeakMap,gm=zx(fm)&&/native code/.test(String(fm)),Tm=Te,YN=fr,Jx=Po,hI=Zn,pI=QE,ts=cm,Xx=Ch,qN="Object already initialized",_I=Tm.TypeError,Qx=Tm.WeakMap;if(gm||pI.state){var Qc=pI.state||(pI.state=new Qx);Qc.get=Qc.get,Qc.has=Qc.has,Qc.set=Qc.set,gT=function(t,n){if(Qc.has(t))throw _I(qN);return n.facade=t,Qc.set(t,n),n},ul=function(t){return Qc.get(t)||{}},yu=function(t){return Qc.has(t)}}else{var t_=ts("state");Xx[t_]=!0,gT=function(t,n){if(hI(t,t_))throw _I(qN);return n.facade=t,Jx(t,t_,n),n},ul=function(t){return hI(t,t_)?t[t_]:{}},yu=function(t){return hI(t,t_)}}var Ih,zN,JN,yh={set:gT,get:ul,has:yu,enforce:function(t){return yu(t)?ul(t):gT(t,{})},getterFor:function(t){return function(n){var r;if(!YN(n)||(r=ul(n)).type!==t)throw _I("Incompatible receiver, "+t+" required");return r}}},EI=wr,Zx=Zn,mI=Function.prototype,ll=EI&&Object.getOwnPropertyDescriptor,XN=Zx(mI,"name"),fI={PROPER:XN&&(function(){}).name==="something",CONFIGURABLE:XN&&(!EI||EI&&ll(mI,"name").configurable)},$x=Po,Au=function(t,n,r,a){return a&&a.enumerable?t[n]=r:$x(t,n,r),t},tV=Nt,eV=wn,gI=fr,TI=um,QN=sT,nV=Au,TT=ze("iterator"),ST=!1;[].keys&&("next"in(JN=[].keys())?(zN=QN(QN(JN)))!==Object.prototype&&(Ih=zN):ST=!0);var iV=!gI(Ih)||tV(function(){var t={};return Ih[TT].call(t)!==t});eV((Ih=iV?{}:TI(Ih))[TT])||nV(Ih,TT,function(){return this});var Zc={IteratorPrototype:Ih,BUGGY_SAFARI_ITERATORS:ST},e_=Es,n_=qp?{}.toString:function(){return"[object "+e_(this)+"]"},rV=qp,sV=_s.f,oV=Po,aV=Zn,cV=n_,SI=ze("toStringTag"),hl=function(t,n,r,a){if(t){var d=r?t:t.prototype;aV(d,SI)||sV(d,SI,{configurable:!0,value:n}),a&&!rV&&oV(d,"toString",cV)}},dV=Zc.IteratorPrototype,RT=um,RI=No,CI=hl,uV=Ud,i_=function(){return this},pl=function(t,n,r,a){var d=n+" Iterator";return t.prototype=RT(dV,{next:RI(+!a,r)}),CI(t,d,!1,!0),uV[d]=i_,t},lV=Ce,Gs=Wn,hV=fI,vI=pl,CT=sT,II=hl,ZN=Au,vT=Ud,Sm=Zc,$N=hV.PROPER,IT=Sm.BUGGY_SAFARI_ITERATORS,yT=ze("iterator"),t0="keys",Rm="values",yI="entries",pV=function(){return this},AI=function(t,n,r,a,d,l,p){vI(r,n,a);var E,f,T,R=function(G){if(G===d&&k)return k;if(!IT&&G in w)return w[G];switch(G){case t0:case Rm:case yI:return function(){return new r(this,G)}}return function(){return new r(this)}},v=n+" Iterator",y=!1,w=t.prototype,B=w[yT]||w["@@iterator"]||d&&w[d],k=!IT&&B||R(d),U=n=="Array"&&w.entries||B;if(U&&(E=CT(U.call(new t)))!==Object.prototype&&E.next&&(II(E,v,!0,!0),vT[v]=pV),$N&&d==Rm&&B&&B.name!==Rm&&(y=!0,k=function(){return Gs(B,this)}),d)if(f={values:R(Rm),keys:l?k:R(t0),entries:R(yI)},p)for(T in f)(IT||y||!(T in w))&&ZN(w,T,f[T]);else lV({target:n,proto:!0,forced:IT||y},f);return p&&w[yT]!==k&&ZN(w,yT,k,{}),vT[n]=k,f},AT=function(t,n){return{value:t,done:n}},_V=$o,bT=Ud,bI=yh,e0=AI,n0=AT,i0="Array Iterator",EV=bI.set,mV=bI.getterFor(i0);e0(Array,"Array",function(t,n){EV(this,{type:i0,target:_V(t),index:0,kind:n})},function(){var t=mV(this),n=t.target,r=t.kind,a=t.index++;return!n||a>=n.length?(t.target=void 0,n0(void 0,!0)):n0(r=="keys"?a:r=="values"?n[a]:[a,n[a]],!1)},"values"),bT.Arguments=bT.Array;var fV=_s,Cm=function(t,n,r){return fV.f(t,n,r)},wT=qi,ea=Cm,OT=wr,r_=ze("species"),gV=le,r0=TypeError,Ma=function(t,n){if(gV(n,t))return t;throw r0("Incorrect invocation")},Ah=wn,s_=QE,TV=Qt(Function.toString);Ah(s_.inspectSource)||(s_.inspectSource=function(t){return TV(t)});var NT=s_.inspectSource,s0=Qt,bh=Nt,wI=wn,SV=Es,o0=NT,Vd=function(){},vm=[],a0=qi("Reflect","construct"),Im=/^\s*(?:class|function)\b/,OI=s0(Im.exec),NI=!Im.exec(Vd),_l=function(t){if(!wI(t))return!1;try{return a0(Vd,vm,t),!0}catch{return!1}},DT=function(t){if(!wI(t))return!1;switch(SV(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return NI||!!OI(Im,o0(t))}catch{return!0}};DT.sham=!0;var o_,wh,DI,PT,ym=!a0||bh(function(){var t;return _l(_l.call)||!_l(Object)||!_l(function(){t=!0})||t})?DT:_l,RV=ym,CV=Yc,vV=TypeError,c0=$i,d0=function(t){if(RV(t))return t;throw vV(CV(t)+" is not a constructor")},IV=Tu,PI=ze("species"),LI=function(t,n){var r,a=c0(t).constructor;return a===void 0||IV(r=c0(a)[PI])?n:d0(r)},LT=Qt([].slice),yV=TypeError,a_=function(t,n){if(t<n)throw yV("Not enough arguments");return t},u0=/(?:ipad|iphone|ipod).*applewebkit/i.test(ta),Ua=Te,l0=mi,h0=Do,kI=wn,AV=Zn,MI=Nt,p0=Qp,_0=LT,E0=em,m0=a_,f0=u0,bV=Rh,Oh=Ua.setImmediate,kT=Ua.clearImmediate,g0=Ua.process,MT=Ua.Dispatch,T0=Ua.Function,S0=Ua.MessageChannel,wV=Ua.String,UI=0,gc={},Am="onreadystatechange";MI(function(){o_=Ua.location});var UT=function(t){if(AV(gc,t)){var n=gc[t];delete gc[t],n()}},xI=function(t){return function(){UT(t)}},R0=function(t){UT(t.data)},C0=function(t){Ua.postMessage(wV(t),o_.protocol+"//"+o_.host)};Oh&&kT||(Oh=function(t){m0(arguments.length,1);var n=kI(t)?t:T0(t),r=_0(arguments,1);return gc[++UI]=function(){l0(n,void 0,r)},wh(UI),UI},kT=function(t){delete gc[t]},bV?wh=function(t){g0.nextTick(xI(t))}:MT&&MT.now?wh=function(t){MT.now(xI(t))}:S0&&!f0?(PT=(DI=new S0).port2,DI.port1.onmessage=R0,wh=h0(PT.postMessage,PT)):Ua.addEventListener&&kI(Ua.postMessage)&&!Ua.importScripts&&o_&&o_.protocol!=="file:"&&!MI(C0)?(wh=C0,Ua.addEventListener("message",R0,!1)):wh=Am in E0("script")?function(t){p0.appendChild(E0("script"))[Am]=function(){p0.removeChild(this),UT(t)}}:function(t){setTimeout(xI(t),0)});var xT={set:Oh,clear:kT},VI=function(){this.head=null,this.tail=null};VI.prototype={add:function(t){var n={item:t,next:null},r=this.tail;r?r.next=n:this.head=n,this.tail=n},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var Nh,VT,FT,FI,v0,BI=VI,OV=/ipad|iphone|ipod/i.test(ta)&&typeof Pebble<"u",NV=/web0s(?!.*chrome)/i.test(ta),Dh=Te,I0=Do,Ph=gu.f,BT=xT.set,y0=BI,DV=u0,c_=OV,jI=NV,GI=Rh,WI=Dh.MutationObserver||Dh.WebKitMutationObserver,A0=Dh.document,HI=Dh.process,bm=Dh.Promise,b0=Ph(Dh,"queueMicrotask"),KI=b0&&b0.value;if(!KI){var jT=new y0,GT=function(){var t,n;for(GI&&(t=HI.domain)&&t.exit();n=jT.get();)try{n()}catch(r){throw jT.head&&Nh(),r}t&&t.enter()};DV||GI||jI||!WI||!A0?!c_&&bm&&bm.resolve?((FI=bm.resolve(void 0)).constructor=bm,v0=I0(FI.then,FI),Nh=function(){v0(GT)}):GI?Nh=function(){HI.nextTick(GT)}:(BT=I0(BT,Dh),Nh=function(){BT(GT)}):(VT=!0,FT=A0.createTextNode(""),new WI(GT).observe(FT,{characterData:!0}),Nh=function(){FT.data=VT=!VT}),KI=function(t){jT.head||Nh(),jT.add(t)}}var w0=KI,Lh=function(t){try{return{error:!1,value:t()}}catch(n){return{error:!0,value:n}}},kh=Te.Promise,O0=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",YI=!O0&&!Rh&&typeof window=="object"&&typeof document=="object",PV=Te,wm=kh,LV=wn,kV=Rv,N0=NT,MV=ze,qI=YI,D0=O0,zI=Pa,JI=wm&&wm.prototype,UV=MV("species"),P0=LV(PV.PromiseRejectionEvent),xV=kV("Promise",function(){var t=N0(wm),n=t!==String(wm);if(!n&&zI===66||!JI.catch||!JI.finally)return!0;if(!zI||zI<51||!/native code/.test(t)){var r=new wm(function(d){d(1)}),a=function(d){d(function(){},function(){})};if((r.constructor={})[UV]=a,!(r.then(function(){})instanceof a))return!0}return!n&&(qI||D0)&&!P0}),Om={CONSTRUCTOR:xV,REJECTION_EVENT:P0},Fd={},L0=kr,k0=TypeError,VV=function(t){var n,r;this.promise=new t(function(a,d){if(n!==void 0||r!==void 0)throw k0("Bad Promise constructor");n=a,r=d}),this.resolve=L0(n),this.reject=L0(r)};Fd.f=function(t){return new VV(t)};var XI,M0,FV=Ce,WT=Rh,El=Te,Nm=Wn,BV=Au,jV=hl,GV=function(t){var n=wT(t);OT&&n&&!n[r_]&&ea(n,r_,{configurable:!0,get:function(){return this}})},WV=kr,QI=wn,HV=fr,KV=Ma,YV=LI,ZI=xT.set,HT=w0,qV=function(t,n){try{arguments.length==1?console.error(t):console.error(t,n)}catch{}},zV=Lh,KT=BI,YT=yh,qT=kh,Dm=Om,$I=Fd,zT="Promise",ty=Dm.CONSTRUCTOR,U0=Dm.REJECTION_EVENT,ey=YT.getterFor(zT),x0=YT.set,V0=qT&&qT.prototype,Pm=qT,JT=V0,ny=El.TypeError,iy=El.document,ry=El.process,sy=$I.f,JV=sy,XV=!!(iy&&iy.createEvent&&El.dispatchEvent),F0="unhandledrejection",oy=function(t){var n;return!(!HV(t)||!QI(n=t.then))&&n},ay=function(t,n){var r,a,d,l=n.value,p=n.state==1,E=p?t.ok:t.fail,f=t.resolve,T=t.reject,R=t.domain;try{E?(p||(n.rejection===2&&QV(n),n.rejection=1),E===!0?r=l:(R&&R.enter(),r=E(l),R&&(R.exit(),d=!0)),r===t.promise?T(ny("Promise-chain cycle")):(a=oy(r))?Nm(a,r,f,T):f(r)):T(l)}catch(v){R&&!d&&R.exit(),T(v)}},XT=function(t,n){t.notified||(t.notified=!0,HT(function(){for(var r,a=t.reactions;r=a.get();)ay(r,t);t.notified=!1,n&&!t.rejection&&dy(t)}))},cy=function(t,n,r){var a,d;XV?((a=iy.createEvent("Event")).promise=n,a.reason=r,a.initEvent(t,!1,!0),El.dispatchEvent(a)):a={promise:n,reason:r},!U0&&(d=El["on"+t])?d(a):t===F0&&qV("Unhandled promise rejection",r)},dy=function(t){Nm(ZI,El,function(){var n,r=t.facade,a=t.value;if(B0(t)&&(n=zV(function(){WT?ry.emit("unhandledRejection",a,r):cy(F0,r,a)}),t.rejection=WT||B0(t)?2:1,n.error))throw n.value})},B0=function(t){return t.rejection!==1&&!t.parent},QV=function(t){Nm(ZI,El,function(){var n=t.facade;WT?ry.emit("rejectionHandled",n):cy("rejectionhandled",n,t.value)})},d_=function(t,n,r){return function(a){t(n,a,r)}},Mh=function(t,n,r){t.done||(t.done=!0,r&&(t=r),t.value=n,t.state=2,XT(t,!0))},QT=function(t,n,r){if(!t.done){t.done=!0,r&&(t=r);try{if(t.facade===n)throw ny("Promise can't be resolved itself");var a=oy(n);a?HT(function(){var d={done:!1};try{Nm(a,n,d_(QT,d,t),d_(Mh,d,t))}catch(l){Mh(d,l,t)}}):(t.value=n,t.state=1,XT(t,!1))}catch(d){Mh({done:!1},d,t)}}};ty&&(JT=(Pm=function(t){KV(this,JT),WV(t),Nm(XI,this);var n=ey(this);try{t(d_(QT,n),d_(Mh,n))}catch(r){Mh(n,r)}}).prototype,(XI=function(t){x0(this,{type:zT,done:!1,notified:!1,parent:!1,reactions:new KT,rejection:!1,state:0,value:void 0})}).prototype=BV(JT,"then",function(t,n){var r=ey(this),a=sy(YV(this,Pm));return r.parent=!0,a.ok=!QI(t)||t,a.fail=QI(n)&&n,a.domain=WT?ry.domain:void 0,r.state==0?r.reactions.add(a):HT(function(){ay(a,r)}),a.promise}),M0=function(){var t=new XI,n=ey(t);this.promise=t,this.resolve=d_(QT,n),this.reject=d_(Mh,n)},$I.f=sy=function(t){return t===Pm||t===void 0?new M0(t):JV(t)}),FV({global:!0,wrap:!0,forced:ty},{Promise:Pm}),jV(Pm,zT,!1,!0),GV(zT);var j0=ze("iterator"),G0=!1;try{var uy=0,W0={next:function(){return{done:!!uy++}},return:function(){G0=!0}};W0[j0]=function(){return this},Array.from(W0,function(){throw 2})}catch{}var ZV=kh,H0=function(t,n){if(!G0)return!1;var r=!1;try{var a={};a[j0]=function(){return{next:function(){return{done:r=!0}}}},t(a)}catch{}return r},ZT=Om.CONSTRUCTOR||!H0(function(t){ZV.all(t).then(void 0,function(){})}),K0=Wn,$V=kr,tF=Fd,eF=Lh,$T=Iu;Ce({target:"Promise",stat:!0,forced:ZT},{all:function(t){var n=this,r=tF.f(n),a=r.resolve,d=r.reject,l=eF(function(){var p=$V(n.resolve),E=[],f=0,T=1;$T(t,function(R){var v=f++,y=!1;T++,K0(p,n,R).then(function(w){y||(y=!0,E[v]=w,--T||a(E))},d)}),--T||a(E)});return l.error&&d(l.value),r.promise}});var Y0=Ce,q0=Om.CONSTRUCTOR;Y0({target:"Promise",proto:!0,forced:q0,real:!0},{catch:function(t){return this.then(void 0,t)}});var nF=Wn,z0=kr,ly=Fd,J0=Lh,iF=Iu;Ce({target:"Promise",stat:!0,forced:ZT},{race:function(t){var n=this,r=ly.f(n),a=r.reject,d=J0(function(){var l=z0(n.resolve);iF(t,function(p){nF(l,n,p).then(r.resolve,a)})});return d.error&&a(d.value),r.promise}});var X0=Wn,Q0=Fd;Ce({target:"Promise",stat:!0,forced:Om.CONSTRUCTOR},{reject:function(t){var n=Q0.f(this);return X0(n.reject,void 0,t),n.promise}});var u_=$i,hy=fr,rF=Fd,Z0=function(t,n){if(u_(t),hy(n)&&n.constructor===t)return n;var r=rF.f(t);return(0,r.resolve)(n),r.promise},sF=Ce,oF=kh,$0=Om.CONSTRUCTOR,aF=Z0,tD=qi("Promise"),eD=!$0;sF({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return aF(eD&&this===tD?oF:this,t)}});var cF=Wn,dF=kr,nD=Fd,uF=Lh,iD=Iu;Ce({target:"Promise",stat:!0,forced:ZT},{allSettled:function(t){var n=this,r=nD.f(n),a=r.resolve,d=r.reject,l=uF(function(){var p=dF(n.resolve),E=[],f=0,T=1;iD(t,function(R){var v=f++,y=!1;T++,cF(p,n,R).then(function(w){y||(y=!0,E[v]={status:"fulfilled",value:w},--T||a(E))},function(w){y||(y=!0,E[v]={status:"rejected",reason:w},--T||a(E))})}),--T||a(E)});return l.error&&d(l.value),r.promise}});var rD=Wn,lF=kr,hF=qi,sD=Fd,Lm=Lh,pF=Iu,oD="No one promise resolved";Ce({target:"Promise",stat:!0,forced:ZT},{any:function(t){var n=this,r=hF("AggregateError"),a=sD.f(n),d=a.resolve,l=a.reject,p=Lm(function(){var E=lF(n.resolve),f=[],T=0,R=1,v=!1;pF(t,function(y){var w=T++,B=!1;R++,rD(E,n,y).then(function(k){B||v||(v=!0,d(k))},function(k){B||v||(B=!0,f[w]=k,--R||l(new r(f,oD)))})}),--R||l(new r(f,oD))});return p.error&&l(p.value),a.promise}});var A=Ce,py=kh,_F=Nt,EF=qi,mF=wn,fF=LI,tS=Z0,gF=py&&py.prototype;A({target:"Promise",proto:!0,real:!0,forced:!!py&&_F(function(){gF.finally.call({then:function(){}},function(){})})},{finally:function(t){var n=fF(this,EF("Promise")),r=mF(t);return this.then(r?function(a){return tS(n,t()).then(function(){return a})}:t,r?function(a){return tS(n,t()).then(function(){throw a})}:t)}});var lo=Qt,aD=Av,TF=La,cD=Md,SF=lo("".charAt),eS=lo("".charCodeAt),RF=lo("".slice),dD=function(t){return function(n,r){var a,d,l=TF(cD(n)),p=aD(r),E=l.length;return p<0||p>=E?t?"":void 0:(a=eS(l,p))<55296||a>56319||p+1===E||(d=eS(l,p+1))<56320||d>57343?t?SF(l,p):a:t?RF(l,p,p+2):d-56320+(a-55296<<10)+65536}},nS={codeAt:dD(!1),charAt:dD(!0)},CF=nS.charAt,_y=La,Ey=yh,vF=AI,uD=AT,my="String Iterator",IF=Ey.set,yF=Ey.getterFor(my);vF(String,"String",function(t){IF(this,{type:my,string:_y(t),index:0})},function(){var t,n=yF(this),r=n.string,a=n.index;return a>=r.length?uD(void 0,!0):(t=CF(r,a),n.index+=t.length,uD(t,!1))});var lD=$r.Promise,AF={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},bF=Te,hD=Es,wF=Po,fy=Ud,iS=ze("toStringTag");for(var gy in AF){var pD=bF[gy],rS=pD&&pD.prototype;rS&&hD(rS)!==iS&&wF(rS,iS,gy),fy[gy]=fy.Array}var _D=lD,Bt=Rt(_D);const Ty=Fv;function bu(t,n){const r=t&&t.navigator;if(!r.mediaDevices)return;const a=function(p){if(typeof p!="object"||p.mandatory||p.optional)return p;const E={};return Object.keys(p).forEach(f=>{if(f==="require"||f==="advanced"||f==="mediaSource")return;const T=typeof p[f]=="object"?p[f]:{ideal:p[f]};T.exact!==void 0&&typeof T.exact=="number"&&(T.min=T.max=T.exact);const R=function(v,y){return v?v+y.charAt(0).toUpperCase()+y.slice(1):y==="deviceId"?"sourceId":y};if(T.ideal!==void 0){E.optional=E.optional||[];let v={};typeof T.ideal=="number"?(v[R("min",f)]=T.ideal,E.optional.push(v),v={},v[R("max",f)]=T.ideal,E.optional.push(v)):(v[R("",f)]=T.ideal,E.optional.push(v))}T.exact!==void 0&&typeof T.exact!="number"?(E.mandatory=E.mandatory||{},E.mandatory[R("",f)]=T.exact):["min","max"].forEach(v=>{T[v]!==void 0&&(E.mandatory=E.mandatory||{},E.mandatory[R(v,f)]=T[v])})}),p.advanced&&(E.optional=(E.optional||[]).concat(p.advanced)),E},d=function(p,E){if(n.version>=61)return E(p);if((p=JSON.parse(JSON.stringify(p)))&&typeof p.audio=="object"){const f=function(T,R,v){R in T&&!(v in T)&&(T[v]=T[R],delete T[R])};f((p=JSON.parse(JSON.stringify(p))).audio,"autoGainControl","googAutoGainControl"),f(p.audio,"noiseSuppression","googNoiseSuppression"),p.audio=a(p.audio)}if(p&&typeof p.video=="object"){let f=p.video.facingMode;f=f&&(typeof f=="object"?f:{ideal:f});const T=n.version<66;if(f&&(f.exact==="user"||f.exact==="environment"||f.ideal==="user"||f.ideal==="environment")&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||T)){let R;if(delete p.video.facingMode,f.exact==="environment"||f.ideal==="environment"?R=["back","rear"]:f.exact!=="user"&&f.ideal!=="user"||(R=["front"]),R)return r.mediaDevices.enumerateDevices().then(v=>{let y=(v=v.filter(w=>w.kind==="videoinput")).find(w=>R.some(B=>{var k;return Mt(k=w.label.toLowerCase()).call(k,B)}));return!y&&v.length&&Mt(R).call(R,"back")&&(y=v[v.length-1]),y&&(p.video.deviceId=f.exact?{exact:y.deviceId}:{ideal:y.deviceId}),p.video=a(p.video),Ty("chrome: "+JSON.stringify(p)),E(p)})}p.video=a(p.video)}return Ty("chrome: "+JSON.stringify(p)),E(p)},l=function(p){return n.version>=64?p:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[p.name]||p.name,message:p.message,constraint:p.constraint||p.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(r.getUserMedia=(function(p,E,f){d(p,T=>{r.webkitGetUserMedia(T,E,R=>{f&&f(l(R))})})}).bind(r),r.mediaDevices.getUserMedia){const p=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(E){return d(E,f=>p(f).then(T=>{if(f.audio&&!T.getAudioTracks().length||f.video&&!T.getVideoTracks().length)throw T.getTracks().forEach(R=>{R.stop()}),new DOMException("","NotFoundError");return T},T=>Bt.reject(l(T))))}}}function Sy(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function ED(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(r){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=r)},enumerable:!0,configurable:!0});const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=r=>{r.stream.addEventListener("addtrack",a=>{let d;d=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(p=>p.track&&p.track.id===a.track.id):{track:a.track};const l=new Event("track");l.track=a.track,l.receiver=d,l.transceiver={receiver:d},l.streams=[r.stream],this.dispatchEvent(l)}),r.stream.getTracks().forEach(a=>{let d;d=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(p=>p.track&&p.track.id===a.id):{track:a};const l=new Event("track");l.track=a,l.receiver=d,l.transceiver={receiver:d},l.streams=[r.stream],this.dispatchEvent(l)})},this.addEventListener("addstream",this._ontrackpoly)),n.apply(this,arguments)}}else dl(t,"track",n=>(n.transceiver||Object.defineProperty(n,"transceiver",{value:{receiver:n.receiver}}),n))}function mD(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const n=function(d,l){return{track:l,get dtmf(){return this._dtmf===void 0&&(l.kind==="audio"?this._dtmf=d.createDTMFSender(l):this._dtmf=null),this._dtmf},_pc:d}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const d=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(p,E){let f=d.apply(this,arguments);return f||(f=n(this,p),this._senders.push(f)),f};const l=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(p){l.apply(this,arguments);const E=this._senders.indexOf(p);E!==-1&&this._senders.splice(E,1)}}const r=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(d){this._senders=this._senders||[],r.apply(this,[d]),d.getTracks().forEach(l=>{this._senders.push(n(this,l))})};const a=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(d){this._senders=this._senders||[],a.apply(this,[d]),d.getTracks().forEach(l=>{const p=this._senders.find(E=>E.track===l);p&&this._senders.splice(this._senders.indexOf(p),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const n=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const r=n.apply(this,[]);return r.forEach(a=>a._pc=this),r},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function fD(t){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[r,a,d]=arguments;if(arguments.length>0&&typeof r=="function")return n.apply(this,arguments);if(n.length===0&&(arguments.length===0||typeof r!="function"))return n.apply(this,[]);const l=function(E){const f={};return E.result().forEach(T=>{const R={id:T.id,timestamp:T.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[T.type]||T.type};T.names().forEach(v=>{R[v]=T.stat(v)}),f[R.id]=R}),f},p=function(E){return new Map(Object.keys(E).map(f=>[f,E[f]]))};if(arguments.length>=2){const E=function(f){a(p(l(f)))};return n.apply(this,[E,r])}return new Bt((E,f)=>{n.apply(this,[function(T){E(p(l(T)))},f])}).then(a,d)}}function gD(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const r=t.RTCPeerConnection.prototype.getSenders;r&&(t.RTCPeerConnection.prototype.getSenders=function(){const d=r.apply(this,[]);return d.forEach(l=>l._pc=this),d});const a=t.RTCPeerConnection.prototype.addTrack;a&&(t.RTCPeerConnection.prototype.addTrack=function(){const d=a.apply(this,arguments);return d._pc=this,d}),t.RTCRtpSender.prototype.getStats=function(){const d=this;return this._pc.getStats().then(l=>Gv(l,d.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const r=t.RTCPeerConnection.prototype.getReceivers;r&&(t.RTCPeerConnection.prototype.getReceivers=function(){const a=r.apply(this,[]);return a.forEach(d=>d._pc=this),a}),dl(t,"track",a=>(a.receiver._pc=a.srcElement,a)),t.RTCRtpReceiver.prototype.getStats=function(){const a=this;return this._pc.getStats().then(d=>Gv(d,a.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const r=arguments[0];let a,d,l;return this.getSenders().forEach(p=>{p.track===r&&(a?l=!0:a=p)}),this.getReceivers().forEach(p=>(p.track===r&&(d?l=!0:d=p),p.track===r)),l||a&&d?Bt.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):a?a.getStats():d?d.getStats():Bt.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return n.apply(this,arguments)}}function Ry(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(l=>this._shimmedLocalStreams[l][0])};const n=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(l,p){if(!p)return n.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const E=n.apply(this,arguments);return this._shimmedLocalStreams[p.id]?this._shimmedLocalStreams[p.id].indexOf(E)===-1&&this._shimmedLocalStreams[p.id].push(E):this._shimmedLocalStreams[p.id]=[p,E],E};const r=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(l){this._shimmedLocalStreams=this._shimmedLocalStreams||{},l.getTracks().forEach(f=>{if(this.getSenders().find(R=>R.track===f))throw new DOMException("Track already exists.","InvalidAccessError")});const p=this.getSenders();r.apply(this,arguments);const E=this.getSenders().filter(f=>p.indexOf(f)===-1);this._shimmedLocalStreams[l.id]=[l].concat(E)};const a=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(l){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[l.id],a.apply(this,arguments)};const d=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(l){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},l&&Object.keys(this._shimmedLocalStreams).forEach(p=>{const E=this._shimmedLocalStreams[p].indexOf(l);E!==-1&&this._shimmedLocalStreams[p].splice(E,1),this._shimmedLocalStreams[p].length===1&&delete this._shimmedLocalStreams[p]}),d.apply(this,arguments)}}function TD(t,n){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&n.version>=65)return Ry(t);const r=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const f=r.apply(this);return this._reverseStreams=this._reverseStreams||{},f.map(T=>this._reverseStreams[T.id])};const a=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(f){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},f.getTracks().forEach(T=>{if(this.getSenders().find(v=>v.track===T))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[f.id]){const T=new t.MediaStream(f.getTracks());this._streams[f.id]=T,this._reverseStreams[T.id]=f,f=T}a.apply(this,[f])};const d=t.RTCPeerConnection.prototype.removeStream;function l(f,T){let R=T.sdp;return Object.keys(f._reverseStreams||[]).forEach(v=>{const y=f._reverseStreams[v],w=f._streams[y.id];R=R.replace(new RegExp(w.id,"g"),y.id)}),new RTCSessionDescription({type:T.type,sdp:R})}t.RTCPeerConnection.prototype.removeStream=function(f){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.apply(this,[this._streams[f.id]||f]),delete this._reverseStreams[this._streams[f.id]?this._streams[f.id].id:f.id],delete this._streams[f.id]},t.RTCPeerConnection.prototype.addTrack=function(f,T){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const R=[].slice.call(arguments,1);if(R.length!==1||!R[0].getTracks().find(w=>w===f))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(w=>w.track===f))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const y=this._streams[T.id];if(y)y.addTrack(f),Bt.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const w=new t.MediaStream([f]);this._streams[T.id]=w,this._reverseStreams[w.id]=T,this.addStream(w)}return this.getSenders().find(w=>w.track===f)},["createOffer","createAnswer"].forEach(function(f){const T=t.RTCPeerConnection.prototype[f],R={[f](){const v=arguments;return arguments.length&&typeof arguments[0]=="function"?T.apply(this,[y=>{const w=l(this,y);v[0].apply(null,[w])},y=>{v[1]&&v[1].apply(null,y)},arguments[2]]):T.apply(this,arguments).then(y=>l(this,y))}};t.RTCPeerConnection.prototype[f]=R[f]});const p=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(f,T){let R=T.sdp;return Object.keys(f._reverseStreams||[]).forEach(v=>{const y=f._reverseStreams[v],w=f._streams[y.id];R=R.replace(new RegExp(y.id,"g"),w.id)}),new RTCSessionDescription({type:T.type,sdp:R})}(this,arguments[0]),p.apply(this,arguments)):p.apply(this,arguments)};const E=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const f=E.get.apply(this);return f.type===""?f:l(this,f)}}),t.RTCPeerConnection.prototype.removeTrack=function(f){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!f._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(f._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let T;this._streams=this._streams||{},Object.keys(this._streams).forEach(R=>{this._streams[R].getTracks().find(v=>f.track===v)&&(T=this._streams[R])}),T&&(T.getTracks().length===1?this.removeStream(this._reverseStreams[T.id]):T.removeTrack(f.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Cy(t,n){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&n.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const a=t.RTCPeerConnection.prototype[r],d={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=d[r]})}function SD(t,n){dl(t,"negotiationneeded",r=>{const a=r.target;if(!(n.version<72||a.getConfiguration&&a.getConfiguration().sdpSemantics==="plan-b")||a.signalingState==="stable")return r})}var sS=Object.freeze({__proto__:null,fixNegotiationNeeded:SD,shimAddTrackRemoveTrack:TD,shimAddTrackRemoveTrackWithNative:Ry,shimGetDisplayMedia:function(t,n){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof n=="function"?t.navigator.mediaDevices.getDisplayMedia=function(r){return n(r).then(a=>{const d=r.video&&r.video.width,l=r.video&&r.video.height,p=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxFrameRate:p||3}},d&&(r.video.mandatory.maxWidth=d),l&&(r.video.mandatory.maxHeight=l),t.navigator.mediaDevices.getUserMedia(r)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:mD,shimGetStats:fD,shimGetUserMedia:bu,shimMediaStream:Sy,shimOnTrack:ED,shimPeerConnection:Cy,shimSenderReceiverGetStats:gD});function l_(t,n){const r=t&&t.navigator,a=t&&t.MediaStreamTrack;if(r.getUserMedia=function(d,l,p){nT("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(d).then(l,p)},!(n.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const d=function(p,E,f){E in p&&!(f in p)&&(p[f]=p[E],delete p[E])},l=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(p){return typeof p=="object"&&typeof p.audio=="object"&&(p=JSON.parse(JSON.stringify(p)),d(p.audio,"autoGainControl","mozAutoGainControl"),d(p.audio,"noiseSuppression","mozNoiseSuppression")),l(p)},a&&a.prototype.getSettings){const p=a.prototype.getSettings;a.prototype.getSettings=function(){const E=p.apply(this,arguments);return d(E,"mozAutoGainControl","autoGainControl"),d(E,"mozNoiseSuppression","noiseSuppression"),E}}if(a&&a.prototype.applyConstraints){const p=a.prototype.applyConstraints;a.prototype.applyConstraints=function(E){return this.kind==="audio"&&typeof E=="object"&&(E=JSON.parse(JSON.stringify(E)),d(E,"autoGainControl","mozAutoGainControl"),d(E,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[E])}}}}function RD(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function vy(t,n){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),n.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(d){const l=t.RTCPeerConnection.prototype[d],p={[d](){return arguments[0]=new(d==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),l.apply(this,arguments)}};t.RTCPeerConnection.prototype[d]=p[d]});const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},a=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[d,l,p]=arguments;return a.apply(this,[d||null]).then(E=>{if(n.version<53&&!l)try{E.forEach(f=>{f.type=r[f.type]||f.type})}catch(f){if(f.name!=="TypeError")throw f;E.forEach((T,R)=>{E.set(R,Object.assign({},T,{type:r[T.type]||T.type}))})}return E}).then(l,p)}}function CD(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){const a=n.apply(this,[]);return a.forEach(d=>d._pc=this),a});const r=t.RTCPeerConnection.prototype.addTrack;r&&(t.RTCPeerConnection.prototype.addTrack=function(){const a=r.apply(this,arguments);return a._pc=this,a}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Bt.resolve(new Map)}}function vD(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){const r=n.apply(this,[]);return r.forEach(a=>a._pc=this),r}),dl(t,"track",r=>(r.receiver._pc=r.srcElement,r)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function ID(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(n){nT("removeStream","removeTrack"),this.getSenders().forEach(r=>{var a;r.track&&Mt(a=n.getTracks()).call(a,r.track)&&this.removeTrack(r)})})}function yD(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function Iy(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype.addTransceiver;n&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let r=arguments[1]&&arguments[1].sendEncodings;r===void 0&&(r=[]),r=[...r];const a=r.length>0;a&&r.forEach(l=>{if("rid"in l&&!/^[a-z0-9]{0,16}$/i.test(l.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in l&&!(parseFloat(l.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in l&&!(parseFloat(l.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const d=n.apply(this,arguments);if(a){const{sender:l}=d,p=l.getParameters();(!("encodings"in p)||p.encodings.length===1&&Object.keys(p.encodings[0]).length===0)&&(p.encodings=r,l.sendEncodings=r,this.setParametersPromises.push(l.setParameters(p).then(()=>{delete l.sendEncodings}).catch(()=>{delete l.sendEncodings})))}return d})}function AD(t){if(typeof t!="object"||!t.RTCRtpSender)return;const n=t.RTCRtpSender.prototype.getParameters;n&&(t.RTCRtpSender.prototype.getParameters=function(){const r=n.apply(this,arguments);return"encodings"in r||(r.encodings=[].concat(this.sendEncodings||[{}])),r})}function bD(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Bt.all(this.setParametersPromises).then(()=>n.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):n.apply(this,arguments)}}function wD(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Bt.all(this.setParametersPromises).then(()=>n.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):n.apply(this,arguments)}}var OD=Object.freeze({__proto__:null,shimAddTransceiver:Iy,shimCreateAnswer:wD,shimCreateOffer:bD,shimGetDisplayMedia:function(t,n){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const a=new DOMException("getDisplayMedia without video constraints is undefined");return a.name="NotFoundError",a.code=8,Bt.reject(a)}return r.video===!0?r.video={mediaSource:n}:r.video.mediaSource=n,t.navigator.mediaDevices.getUserMedia(r)})},shimGetParameters:AD,shimGetUserMedia:l_,shimOnTrack:RD,shimPeerConnection:vy,shimRTCDataChannel:yD,shimReceiverGetStats:vD,shimRemoveStream:ID,shimSenderGetStats:CD});function ND(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const n=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(r){var a;this._localStreams||(this._localStreams=[]),Mt(a=this._localStreams).call(a,r)||this._localStreams.push(r),r.getAudioTracks().forEach(d=>n.call(this,d,r)),r.getVideoTracks().forEach(d=>n.call(this,d,r))},t.RTCPeerConnection.prototype.addTrack=function(r){for(var a=arguments.length,d=new Array(a>1?a-1:0),l=1;l<a;l++)d[l-1]=arguments[l];return d&&d.forEach(p=>{var E;this._localStreams?Mt(E=this._localStreams).call(E,p)||this._localStreams.push(p):this._localStreams=[p]}),n.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(n){this._localStreams||(this._localStreams=[]);const r=this._localStreams.indexOf(n);if(r===-1)return;this._localStreams.splice(r,1);const a=n.getTracks();this.getSenders().forEach(d=>{Mt(a).call(a,d.track)&&this.removeTrack(d)})})}}function yy(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(r){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=r),this.addEventListener("track",this._onaddstreampoly=a=>{a.streams.forEach(d=>{var l;if(this._remoteStreams||(this._remoteStreams=[]),Mt(l=this._remoteStreams).call(l,d))return;this._remoteStreams.push(d);const p=new Event("addstream");p.stream=d,this.dispatchEvent(p)})})}});const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const r=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(a){a.streams.forEach(d=>{if(r._remoteStreams||(r._remoteStreams=[]),r._remoteStreams.indexOf(d)>=0)return;r._remoteStreams.push(d);const l=new Event("addstream");l.stream=d,r.dispatchEvent(l)})}),n.apply(r,arguments)}}}function DD(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,r=n.createOffer,a=n.createAnswer,d=n.setLocalDescription,l=n.setRemoteDescription,p=n.addIceCandidate;n.createOffer=function(f,T){const R=arguments.length>=2?arguments[2]:arguments[0],v=r.apply(this,[R]);return T?(v.then(f,T),Bt.resolve()):v},n.createAnswer=function(f,T){const R=arguments.length>=2?arguments[2]:arguments[0],v=a.apply(this,[R]);return T?(v.then(f,T),Bt.resolve()):v};let E=function(f,T,R){const v=d.apply(this,[f]);return R?(v.then(T,R),Bt.resolve()):v};n.setLocalDescription=E,E=function(f,T,R){const v=l.apply(this,[f]);return R?(v.then(T,R),Bt.resolve()):v},n.setRemoteDescription=E,E=function(f,T,R){const v=p.apply(this,[f]);return R?(v.then(T,R),Bt.resolve()):v},n.addIceCandidate=E}function PD(t){const n=t&&t.navigator;if(n.mediaDevices&&n.mediaDevices.getUserMedia){const r=n.mediaDevices,a=r.getUserMedia.bind(r);n.mediaDevices.getUserMedia=d=>a(Ay(d))}!n.getUserMedia&&n.mediaDevices&&n.mediaDevices.getUserMedia&&(n.getUserMedia=(function(r,a,d){n.mediaDevices.getUserMedia(r).then(a,d)}).bind(n))}function Ay(t){return t&&t.video!==void 0?Object.assign({},t,{video:jv(t.video)}):t}function LD(t){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection;t.RTCPeerConnection=function(r,a){if(r&&r.iceServers){const d=[];for(let l=0;l<r.iceServers.length;l++){let p=r.iceServers[l];!p.hasOwnProperty("urls")&&p.hasOwnProperty("url")?(nT("RTCIceServer.url","RTCIceServer.urls"),p=JSON.parse(JSON.stringify(p)),p.urls=p.url,delete p.url,d.push(p)):d.push(r.iceServers[l])}r.iceServers=d}return new n(r,a)},t.RTCPeerConnection.prototype=n.prototype,"generateCertificate"in n&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>n.generateCertificate})}function kD(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function MD(t){const n=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(r){if(r){r.offerToReceiveAudio!==void 0&&(r.offerToReceiveAudio=!!r.offerToReceiveAudio);const a=this.getTransceivers().find(l=>l.receiver.track.kind==="audio");r.offerToReceiveAudio===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):r.offerToReceiveAudio!==!0||a||this.addTransceiver("audio",{direction:"recvonly"}),r.offerToReceiveVideo!==void 0&&(r.offerToReceiveVideo=!!r.offerToReceiveVideo);const d=this.getTransceivers().find(l=>l.receiver.track.kind==="video");r.offerToReceiveVideo===!1&&d?d.direction==="sendrecv"?d.setDirection?d.setDirection("sendonly"):d.direction="sendonly":d.direction==="recvonly"&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive"):r.offerToReceiveVideo!==!0||d||this.addTransceiver("video",{direction:"recvonly"})}return n.apply(this,arguments)}}function UD(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var xD=Object.freeze({__proto__:null,shimAudioContext:UD,shimCallbacksAPI:DD,shimConstraints:Ay,shimCreateOfferLegacy:MD,shimGetUserMedia:PD,shimLocalStreamsAPI:ND,shimRTCIceServerUrls:LD,shimRemoteStreamsAPI:yy,shimTrackEventTransceiver:kD}),VD=`	
\v\f\r                　\u2028\u2029\uFEFF`,FD=Md,OF=La,by=VD,BD=Qt("".replace),jD=RegExp("^["+by+"]+"),NF=RegExp("(^|[^"+by+"])["+by+"]+$"),GD=function(t){return function(n){var r=OF(FD(n));return 1&t&&(r=BD(r,jD,"")),2&t&&(r=BD(r,NF,"$1")),r}},DF={trim:GD(3)},PF=fI.PROPER,LF=Nt,km=VD,kF=DF.trim;Ce({target:"String",proto:!0,forced:function(t){return LF(function(){return!!km[t]()||"​᠎"[t]()!=="​᠎"||PF&&km[t].name!==t})}("trim")},{trim:function(){return kF(this)}});var MF=fc("String").trim,UF=le,xF=MF,wy=String.prototype,VF=function(t){var n=t.trim;return typeof t=="string"||t===wy||UF(wy,t)&&n===wy.trim?xF:n},ms=Rt(VF),WD={exports:{}};(function(t){const n={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};n.localCName=n.generateIdentifier(),n.splitLines=function(r){return r.trim().split(`
`).map(a=>a.trim())},n.splitSections=function(r){return r.split(`
m=`).map((a,d)=>(d>0?"m="+a:a).trim()+`\r
`)},n.getDescription=function(r){const a=n.splitSections(r);return a&&a[0]},n.getMediaSections=function(r){const a=n.splitSections(r);return a.shift(),a},n.matchPrefix=function(r,a){return n.splitLines(r).filter(d=>d.indexOf(a)===0)},n.parseCandidate=function(r){let a;a=r.indexOf("a=candidate:")===0?r.substring(12).split(" "):r.substring(10).split(" ");const d={foundation:a[0],component:{1:"rtp",2:"rtcp"}[a[1]]||a[1],protocol:a[2].toLowerCase(),priority:parseInt(a[3],10),ip:a[4],address:a[4],port:parseInt(a[5],10),type:a[7]};for(let l=8;l<a.length;l+=2)switch(a[l]){case"raddr":d.relatedAddress=a[l+1];break;case"rport":d.relatedPort=parseInt(a[l+1],10);break;case"tcptype":d.tcpType=a[l+1];break;case"ufrag":d.ufrag=a[l+1],d.usernameFragment=a[l+1];break;default:d[a[l]]===void 0&&(d[a[l]]=a[l+1])}return d},n.writeCandidate=function(r){const a=[];a.push(r.foundation);const d=r.component;d==="rtp"?a.push(1):d==="rtcp"?a.push(2):a.push(d),a.push(r.protocol.toUpperCase()),a.push(r.priority),a.push(r.address||r.ip),a.push(r.port);const l=r.type;return a.push("typ"),a.push(l),l!=="host"&&r.relatedAddress&&r.relatedPort&&(a.push("raddr"),a.push(r.relatedAddress),a.push("rport"),a.push(r.relatedPort)),r.tcpType&&r.protocol.toLowerCase()==="tcp"&&(a.push("tcptype"),a.push(r.tcpType)),(r.usernameFragment||r.ufrag)&&(a.push("ufrag"),a.push(r.usernameFragment||r.ufrag)),"candidate:"+a.join(" ")},n.parseIceOptions=function(r){return r.substring(14).split(" ")},n.parseRtpMap=function(r){let a=r.substring(9).split(" ");const d={payloadType:parseInt(a.shift(),10)};return a=a[0].split("/"),d.name=a[0],d.clockRate=parseInt(a[1],10),d.channels=a.length===3?parseInt(a[2],10):1,d.numChannels=d.channels,d},n.writeRtpMap=function(r){let a=r.payloadType;r.preferredPayloadType!==void 0&&(a=r.preferredPayloadType);const d=r.channels||r.numChannels||1;return"a=rtpmap:"+a+" "+r.name+"/"+r.clockRate+(d!==1?"/"+d:"")+`\r
`},n.parseExtmap=function(r){const a=r.substring(9).split(" ");return{id:parseInt(a[0],10),direction:a[0].indexOf("/")>0?a[0].split("/")[1]:"sendrecv",uri:a[1],attributes:a.slice(2).join(" ")}},n.writeExtmap=function(r){return"a=extmap:"+(r.id||r.preferredId)+(r.direction&&r.direction!=="sendrecv"?"/"+r.direction:"")+" "+r.uri+(r.attributes?" "+r.attributes:"")+`\r
`},n.parseFmtp=function(r){const a={};let d;const l=r.substring(r.indexOf(" ")+1).split(";");for(let p=0;p<l.length;p++)d=l[p].trim().split("="),a[d[0].trim()]=d[1];return a},n.writeFmtp=function(r){let a="",d=r.payloadType;if(r.preferredPayloadType!==void 0&&(d=r.preferredPayloadType),r.parameters&&Object.keys(r.parameters).length){const l=[];Object.keys(r.parameters).forEach(p=>{r.parameters[p]!==void 0?l.push(p+"="+r.parameters[p]):l.push(p)}),a+="a=fmtp:"+d+" "+l.join(";")+`\r
`}return a},n.parseRtcpFb=function(r){const a=r.substring(r.indexOf(" ")+1).split(" ");return{type:a.shift(),parameter:a.join(" ")}},n.writeRtcpFb=function(r){let a="",d=r.payloadType;return r.preferredPayloadType!==void 0&&(d=r.preferredPayloadType),r.rtcpFeedback&&r.rtcpFeedback.length&&r.rtcpFeedback.forEach(l=>{a+="a=rtcp-fb:"+d+" "+l.type+(l.parameter&&l.parameter.length?" "+l.parameter:"")+`\r
`}),a},n.parseSsrcMedia=function(r){const a=r.indexOf(" "),d={ssrc:parseInt(r.substring(7,a),10)},l=r.indexOf(":",a);return l>-1?(d.attribute=r.substring(a+1,l),d.value=r.substring(l+1)):d.attribute=r.substring(a+1),d},n.parseSsrcGroup=function(r){const a=r.substring(13).split(" ");return{semantics:a.shift(),ssrcs:a.map(d=>parseInt(d,10))}},n.getMid=function(r){const a=n.matchPrefix(r,"a=mid:")[0];if(a)return a.substring(6)},n.parseFingerprint=function(r){const a=r.substring(14).split(" ");return{algorithm:a[0].toLowerCase(),value:a[1].toUpperCase()}},n.getDtlsParameters=function(r,a){return{role:"auto",fingerprints:n.matchPrefix(r+a,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(r,a){let d="a=setup:"+a+`\r
`;return r.fingerprints.forEach(l=>{d+="a=fingerprint:"+l.algorithm+" "+l.value+`\r
`}),d},n.parseCryptoLine=function(r){const a=r.substring(9).split(" ");return{tag:parseInt(a[0],10),cryptoSuite:a[1],keyParams:a[2],sessionParams:a.slice(3)}},n.writeCryptoLine=function(r){return"a=crypto:"+r.tag+" "+r.cryptoSuite+" "+(typeof r.keyParams=="object"?n.writeCryptoKeyParams(r.keyParams):r.keyParams)+(r.sessionParams?" "+r.sessionParams.join(" "):"")+`\r
`},n.parseCryptoKeyParams=function(r){if(r.indexOf("inline:")!==0)return null;const a=r.substring(7).split("|");return{keyMethod:"inline",keySalt:a[0],lifeTime:a[1],mkiValue:a[2]?a[2].split(":")[0]:void 0,mkiLength:a[2]?a[2].split(":")[1]:void 0}},n.writeCryptoKeyParams=function(r){return r.keyMethod+":"+r.keySalt+(r.lifeTime?"|"+r.lifeTime:"")+(r.mkiValue&&r.mkiLength?"|"+r.mkiValue+":"+r.mkiLength:"")},n.getCryptoParameters=function(r,a){return n.matchPrefix(r+a,"a=crypto:").map(n.parseCryptoLine)},n.getIceParameters=function(r,a){const d=n.matchPrefix(r+a,"a=ice-ufrag:")[0],l=n.matchPrefix(r+a,"a=ice-pwd:")[0];return d&&l?{usernameFragment:d.substring(12),password:l.substring(10)}:null},n.writeIceParameters=function(r){let a="a=ice-ufrag:"+r.usernameFragment+`\r
a=ice-pwd:`+r.password+`\r
`;return r.iceLite&&(a+=`a=ice-lite\r
`),a},n.parseRtpParameters=function(r){const a={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},d=n.splitLines(r)[0].split(" ");a.profile=d[2];for(let p=3;p<d.length;p++){const E=d[p],f=n.matchPrefix(r,"a=rtpmap:"+E+" ")[0];if(f){const T=n.parseRtpMap(f),R=n.matchPrefix(r,"a=fmtp:"+E+" ");switch(T.parameters=R.length?n.parseFmtp(R[0]):{},T.rtcpFeedback=n.matchPrefix(r,"a=rtcp-fb:"+E+" ").map(n.parseRtcpFb),a.codecs.push(T),T.name.toUpperCase()){case"RED":case"ULPFEC":a.fecMechanisms.push(T.name.toUpperCase())}}}n.matchPrefix(r,"a=extmap:").forEach(p=>{a.headerExtensions.push(n.parseExtmap(p))});const l=n.matchPrefix(r,"a=rtcp-fb:* ").map(n.parseRtcpFb);return a.codecs.forEach(p=>{l.forEach(E=>{p.rtcpFeedback.find(f=>f.type===E.type&&f.parameter===E.parameter)||p.rtcpFeedback.push(E)})}),a},n.writeRtpDescription=function(r,a){let d="";d+="m="+r+" ",d+=a.codecs.length>0?"9":"0",d+=" "+(a.profile||"UDP/TLS/RTP/SAVPF")+" ",d+=a.codecs.map(p=>p.preferredPayloadType!==void 0?p.preferredPayloadType:p.payloadType).join(" ")+`\r
`,d+=`c=IN IP4 0.0.0.0\r
`,d+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,a.codecs.forEach(p=>{d+=n.writeRtpMap(p),d+=n.writeFmtp(p),d+=n.writeRtcpFb(p)});let l=0;return a.codecs.forEach(p=>{p.maxptime>l&&(l=p.maxptime)}),l>0&&(d+="a=maxptime:"+l+`\r
`),a.headerExtensions&&a.headerExtensions.forEach(p=>{d+=n.writeExtmap(p)}),d},n.parseRtpEncodingParameters=function(r){const a=[],d=n.parseRtpParameters(r),l=d.fecMechanisms.indexOf("RED")!==-1,p=d.fecMechanisms.indexOf("ULPFEC")!==-1,E=n.matchPrefix(r,"a=ssrc:").map(y=>n.parseSsrcMedia(y)).filter(y=>y.attribute==="cname"),f=E.length>0&&E[0].ssrc;let T;const R=n.matchPrefix(r,"a=ssrc-group:FID").map(y=>y.substring(17).split(" ").map(w=>parseInt(w,10)));R.length>0&&R[0].length>1&&R[0][0]===f&&(T=R[0][1]),d.codecs.forEach(y=>{if(y.name.toUpperCase()==="RTX"&&y.parameters.apt){let w={ssrc:f,codecPayloadType:parseInt(y.parameters.apt,10)};f&&T&&(w.rtx={ssrc:T}),a.push(w),l&&(w=JSON.parse(JSON.stringify(w)),w.fec={ssrc:f,mechanism:p?"red+ulpfec":"red"},a.push(w))}}),a.length===0&&f&&a.push({ssrc:f});let v=n.matchPrefix(r,"b=");return v.length&&(v=v[0].indexOf("b=TIAS:")===0?parseInt(v[0].substring(7),10):v[0].indexOf("b=AS:")===0?1e3*parseInt(v[0].substring(5),10)*.95-16e3:void 0,a.forEach(y=>{y.maxBitrate=v})),a},n.parseRtcpParameters=function(r){const a={},d=n.matchPrefix(r,"a=ssrc:").map(E=>n.parseSsrcMedia(E)).filter(E=>E.attribute==="cname")[0];d&&(a.cname=d.value,a.ssrc=d.ssrc);const l=n.matchPrefix(r,"a=rtcp-rsize");a.reducedSize=l.length>0,a.compound=l.length===0;const p=n.matchPrefix(r,"a=rtcp-mux");return a.mux=p.length>0,a},n.writeRtcpParameters=function(r){let a="";return r.reducedSize&&(a+=`a=rtcp-rsize\r
`),r.mux&&(a+=`a=rtcp-mux\r
`),r.ssrc!==void 0&&r.cname&&(a+="a=ssrc:"+r.ssrc+" cname:"+r.cname+`\r
`),a},n.parseMsid=function(r){let a;const d=n.matchPrefix(r,"a=msid:");if(d.length===1)return a=d[0].substring(7).split(" "),{stream:a[0],track:a[1]};const l=n.matchPrefix(r,"a=ssrc:").map(p=>n.parseSsrcMedia(p)).filter(p=>p.attribute==="msid");return l.length>0?(a=l[0].value.split(" "),{stream:a[0],track:a[1]}):void 0},n.parseSctpDescription=function(r){const a=n.parseMLine(r),d=n.matchPrefix(r,"a=max-message-size:");let l;d.length>0&&(l=parseInt(d[0].substring(19),10)),isNaN(l)&&(l=65536);const p=n.matchPrefix(r,"a=sctp-port:");if(p.length>0)return{port:parseInt(p[0].substring(12),10),protocol:a.fmt,maxMessageSize:l};const E=n.matchPrefix(r,"a=sctpmap:");if(E.length>0){const f=E[0].substring(10).split(" ");return{port:parseInt(f[0],10),protocol:f[1],maxMessageSize:l}}},n.writeSctpDescription=function(r,a){let d=[];return d=r.protocol!=="DTLS/SCTP"?["m="+r.kind+" 9 "+r.protocol+" "+a.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+a.port+`\r
`]:["m="+r.kind+" 9 "+r.protocol+" "+a.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+a.port+" "+a.protocol+` 65535\r
`],a.maxMessageSize!==void 0&&d.push("a=max-message-size:"+a.maxMessageSize+`\r
`),d.join("")},n.generateSessionId=function(){return Math.random().toString().substr(2,22)},n.writeSessionBoilerplate=function(r,a,d){let l;const p=a!==void 0?a:2;return l=r||n.generateSessionId(),`v=0\r
o=`+(d||"thisisadapterortc")+" "+l+" "+p+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},n.getDirection=function(r,a){const d=n.splitLines(r);for(let l=0;l<d.length;l++)switch(d[l]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return d[l].substring(2)}return a?n.getDirection(a):"sendrecv"},n.getKind=function(r){return n.splitLines(r)[0].split(" ")[0].substring(2)},n.isRejected=function(r){return r.split(" ",2)[1]==="0"},n.parseMLine=function(r){const a=n.splitLines(r)[0].substring(2).split(" ");return{kind:a[0],port:parseInt(a[1],10),protocol:a[2],fmt:a.slice(3).join(" ")}},n.parseOLine=function(r){const a=n.matchPrefix(r,"o=")[0].substring(2).split(" ");return{username:a[0],sessionId:a[1],sessionVersion:parseInt(a[2],10),netType:a[3],addressType:a[4],address:a[5]}},n.isValidSDP=function(r){if(typeof r!="string"||r.length===0)return!1;const a=n.splitLines(r);for(let d=0;d<a.length;d++)if(a[d].length<2||a[d].charAt(1)!=="=")return!1;return!0},t.exports=n})(WD);var Oy=WD.exports,h_=Rt(Oy),HD=ct({__proto__:null,default:h_},[Oy]);function oS(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const n=t.RTCIceCandidate;t.RTCIceCandidate=function(r){if(typeof r=="object"&&r.candidate&&r.candidate.indexOf("a=")===0&&((r=JSON.parse(JSON.stringify(r))).candidate=r.candidate.substr(2)),r.candidate&&r.candidate.length){const a=new n(r),d=h_.parseCandidate(r.candidate),l=Object.assign(a,d);return l.toJSON=function(){return{candidate:l.candidate,sdpMid:l.sdpMid,sdpMLineIndex:l.sdpMLineIndex,usernameFragment:l.usernameFragment}},l}return new n(r)},t.RTCIceCandidate.prototype=n.prototype,dl(t,"icecandidate",r=>(r.candidate&&Object.defineProperty(r,"candidate",{value:new t.RTCIceCandidate(r.candidate),writable:"false"}),r))}function Ny(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||dl(t,"icecandidate",n=>{if(n.candidate){const r=h_.parseCandidate(n.candidate.candidate);r.type==="relay"&&(n.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[r.priority>>24])}return n})}function aS(t,n){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const r=function(E){if(!E||!E.sdp)return!1;const f=h_.splitSections(E.sdp);return f.shift(),f.some(T=>{const R=h_.parseMLine(T);return R&&R.kind==="application"&&R.protocol.indexOf("SCTP")!==-1})},a=function(E){const f=E.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(f===null||f.length<2)return-1;const T=parseInt(f[1],10);return T!=T?-1:T},d=function(E){let f=65536;return n.browser==="firefox"&&(f=n.version<57?E===-1?16384:2147483637:n.version<60?n.version===57?65535:65536:2147483637),f},l=function(E,f){let T=65536;n.browser==="firefox"&&n.version===57&&(T=65535);const R=h_.matchPrefix(E.sdp,"a=max-message-size:");return R.length>0?T=parseInt(R[0].substr(19),10):n.browser==="firefox"&&f!==-1&&(T=2147483637),T},p=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,n.browser==="chrome"&&n.version>=76){const{sdpSemantics:E}=this.getConfiguration();E==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(r(arguments[0])){const E=a(arguments[0]),f=d(E),T=l(arguments[0],E);let R;R=f===0&&T===0?Number.POSITIVE_INFINITY:f===0||T===0?Math.max(f,T):Math.min(f,T);const v={};Object.defineProperty(v,"maxMessageSize",{get:()=>R}),this._sctp=v}return p.apply(this,arguments)}}function cS(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function n(a,d){const l=a.send;a.send=function(){const p=arguments[0],E=p.length||p.size||p.byteLength;if(a.readyState==="open"&&d.sctp&&E>d.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+d.sctp.maxMessageSize+" bytes)");return l.apply(a,arguments)}}const r=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const a=r.apply(this,arguments);return n(a,this),a},dl(t,"datachannel",a=>(n(a.channel,a.target),a))}function Dy(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype;Object.defineProperty(n,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(n,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(r){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),r&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=r)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(r=>{const a=n[r];n[r]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=d=>{const l=d.target;if(l._lastConnectionState!==l.connectionState){l._lastConnectionState=l.connectionState;const p=new Event("connectionstatechange",d);l.dispatchEvent(p)}return d},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),a.apply(this,arguments)}})}function Py(t,n){if(!t.RTCPeerConnection||n.browser==="chrome"&&n.version>=71||n.browser==="safari"&&n.version>=605)return;const r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(a){if(a&&a.sdp&&a.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const d=a.sdp.split(`
`).filter(l=>ms(l).call(l)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&a instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:a.type,sdp:d}):a.sdp=d}return r.apply(this,arguments)}}function Mm(t,n){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const r=t.RTCPeerConnection.prototype.addIceCandidate;r&&r.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(n.browser==="chrome"&&n.version<78||n.browser==="firefox"&&n.version<68||n.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Bt.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Bt.resolve())})}function dS(t,n){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const r=t.RTCPeerConnection.prototype.setLocalDescription;r&&r.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let a=arguments[0]||{};if(typeof a!="object"||a.type&&a.sdp)return r.apply(this,arguments);if(a={type:a.type,sdp:a.sdp},!a.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":a.type="offer";break;default:a.type="answer"}return a.sdp||a.type!=="offer"&&a.type!=="answer"?r.apply(this,[a]):(a.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(d=>r.apply(this,[d]))})}var FF=Object.freeze({__proto__:null,removeExtmapAllowMixed:Py,shimAddIceCandidateNullOrEmpty:Mm,shimConnectionState:Dy,shimMaxMessageSize:aS,shimParameterlessSetLocalDescription:dS,shimRTCIceCandidate:oS,shimRTCIceCandidateRelayProtocol:Ny,shimSendThrowTypeError:cS});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const r=Fv,a=function(l){const p={browser:null,version:null};if(l===void 0||!l.navigator)return p.browser="Not a browser.",p;const{navigator:E}=l;if(E.mozGetUserMedia)p.browser="firefox",p.version=am(E.userAgent,/Firefox\/(\d+)\./,1);else if(E.webkitGetUserMedia||l.isSecureContext===!1&&l.webkitRTCPeerConnection)p.browser="chrome",p.version=am(E.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!l.RTCPeerConnection||!E.userAgent.match(/AppleWebKit\/(\d+)\./))return p.browser="Not a supported browser.",p;p.browser="safari",p.version=am(E.userAgent,/AppleWebKit\/(\d+)\./,1),p.supportsUnifiedPlan=l.RTCRtpTransceiver&&"currentDirection"in l.RTCRtpTransceiver.prototype}return p}(t),d={browserDetails:a,commonShim:FF,extractVersion:am,disableLog:Vv,disableWarnings:hN,sdp:HD};switch(a.browser){case"chrome":if(!sS||!Cy||!n.shimChrome)return r("Chrome shim is not included in this adapter release."),d;if(a.version===null)return r("Chrome shim can not determine version, not shimming."),d;r("adapter.js shimming chrome."),d.browserShim=sS,Mm(t,a),dS(t),bu(t,a),Sy(t),Cy(t,a),ED(t),TD(t,a),mD(t),fD(t),gD(t),SD(t,a),oS(t),Ny(t),Dy(t),aS(t,a),cS(t),Py(t,a);break;case"firefox":if(!OD||!vy||!n.shimFirefox)return r("Firefox shim is not included in this adapter release."),d;r("adapter.js shimming firefox."),d.browserShim=OD,Mm(t,a),dS(t),l_(t,a),vy(t,a),RD(t),ID(t),CD(t),vD(t),yD(t),Iy(t),AD(t),bD(t),wD(t),oS(t),Dy(t),aS(t,a),cS(t);break;case"safari":if(!xD||!n.shimSafari)return r("Safari shim is not included in this adapter release."),d;r("adapter.js shimming safari."),d.browserShim=xD,Mm(t,a),dS(t),LD(t),MD(t),DD(t),ND(t),yy(t),kD(t),PD(t),UD(t),oS(t),Ny(t),aS(t,a),cS(t),Py(t,a);break;default:r("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var KD=fc("Array").keys,BF=Es,uS=Zn,YD=le,Um=KD,Ly=Array.prototype,jF={DOMTokenList:!0,NodeList:!0},GF=function(t){var n=t.keys;return t===Ly||YD(Ly,t)&&n===Ly.keys||uS(jF,BF(t))?Um:n},na=Rt(GF),xm=Yc,WF=TypeError,qD=gh,ky=_s,My=No,lS=function(t,n,r){var a=qD(n);a in t?ky.f(t,a,My(0,r)):t[a]=r},zD=bv,HF=vu,KF=lS,YF=Array,hS=Math.max,Uy=function(t,n,r){for(var a=HF(t),d=zD(n,a),l=zD(r===void 0?a:r,a),p=YF(hS(l-d,0)),E=0;d<l;d++,E++)KF(p,E,t[d]);return p.length=E,p},Uh=Uy,xy=Math.floor,xh=function(t,n){var r=t.length,a=xy(r/2);return r<8?p_(t,n):JD(t,xh(Uh(t,0,a),n),xh(Uh(t,a),n),n)},p_=function(t,n){for(var r,a,d=t.length,l=1;l<d;){for(a=l,r=t[l];a&&n(t[a-1],r)>0;)t[a]=t[--a];a!==l++&&(t[a]=r)}return t},JD=function(t,n,r,a){for(var d=n.length,l=r.length,p=0,E=0;p<d||E<l;)t[p+E]=p<d&&E<l?a(n[p],r[E])<=0?n[p++]:r[E++]:p<d?n[p++]:r[E++];return t},pS=xh,__=ta.match(/firefox\/(\d+)/i),qF=!!__&&+__[1],zF=/MSIE|Trident/.test(ta),XD=ta.match(/AppleWebKit\/(\d+)\./),QD=!!XD&&+XD[1],JF=Ce,ZD=Qt,Vy=kr,XF=Ns,$D=vu,QF=function(t,n){if(!delete t[n])throw WF("Cannot delete property "+xm(n)+" of "+xm(t))},Fy=La,By=Nt,ZF=pS,$F=om,jy=qF,tB=zF,Vm=Pa,Gy=QD,Is=[],tP=ZD(Is.sort),eB=ZD(Is.push),eP=By(function(){Is.sort(void 0)}),nB=By(function(){Is.sort(null)}),nP=$F("sort"),Wy=!By(function(){if(Vm)return Vm<70;if(!(jy&&jy>3)){if(tB)return!0;if(Gy)return Gy<603;var t,n,r,a,d="";for(t=65;t<76;t++){switch(n=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:r=3;break;case 68:case 71:r=4;break;default:r=2}for(a=0;a<47;a++)Is.push({k:n+a,v:r})}for(Is.sort(function(l,p){return p.v-l.v}),a=0;a<Is.length;a++)n=Is[a].k.charAt(0),d.charAt(d.length-1)!==n&&(d+=n);return d!=="DGBEFHACIJK"}});JF({target:"Array",proto:!0,forced:eP||!nB||!nP||!Wy},{sort:function(t){t!==void 0&&Vy(t);var n=XF(this);if(Wy)return t===void 0?tP(n):tP(n,t);var r,a,d=[],l=$D(n);for(a=0;a<l;a++)a in n&&eB(d,n[a]);for(ZF(d,function(p){return function(E,f){return f===void 0?-1:E===void 0?1:p!==void 0?+p(E,f)||0:Fy(E)>Fy(f)?1:-1}}(t)),r=$D(d),a=0;a<r;)n[a]=d[a++];for(;a<l;)QF(n,a++);return n}});var iB=fc("Array").sort,iP=le,rB=iB,Hy=Array.prototype,sB=function(t){var n=t.sort;return t===Hy||iP(Hy,t)&&n===Hy.sort?rB:n},Vh=Rt(sB),_S={exports:{}};(function(t,n){(function(r,a){var d="function",l="undefined",p="object",E="string",f="major",T="model",R="name",v="type",y="vendor",w="version",B="architecture",k="console",U="mobile",G="tablet",W="smarttv",$="wearable",rt="embedded",ot="Amazon",Et="Apple",vt="ASUS",Lt="BlackBerry",wt="Browser",$t="Chrome",Ye="Firefox",bn="Google",ri="Huawei",mr="LG",Li="Microsoft",_u="Motorola",Ct="Opera",Pt="Samsung",Zt="Sharp",we="Sony",Sn="Xiaomi",Ft="Zebra",L="Facebook",X="Chromium OS",tt="Mac OS",Ot=function(or){for(var Ar={},Ci=0;Ci<or.length;Ci++)Ar[or[Ci].toUpperCase()]=or[Ci];return Ar},Oe=function(or,Ar){return typeof or===E&&Gn(Ar).indexOf(Gn(or))!==-1},Gn=function(or){return or.toLowerCase()},Gr=function(or,Ar){if(typeof or===E)return or=or.replace(/^\s\s*/,""),typeof Ar===l?or:or.substring(0,350)},wa=function(or,Ar){for(var Ci,mc,lh,ar,Rn,Oa,jE=0;jE<Ar.length&&!Rn;){var rl=Ar[jE],BW=Ar[jE+1];for(Ci=mc=0;Ci<rl.length&&!Rn&&rl[Ci];)if(Rn=rl[Ci++].exec(or))for(lh=0;lh<BW.length;lh++)Oa=Rn[++mc],typeof(ar=BW[lh])===p&&ar.length>0?ar.length===2?typeof ar[1]==d?this[ar[0]]=ar[1].call(this,Oa):this[ar[0]]=ar[1]:ar.length===3?typeof ar[1]!==d||ar[1].exec&&ar[1].test?this[ar[0]]=Oa?Oa.replace(ar[1],ar[2]):a:this[ar[0]]=Oa?ar[1].call(this,Oa,ar[2]):a:ar.length===4&&(this[ar[0]]=Oa?ar[3].call(this,Oa.replace(ar[1],ar[2])):a):this[ar]=Oa||a;jE+=2}},Kp=function(or,Ar){for(var Ci in Ar)if(typeof Ar[Ci]===p&&Ar[Ci].length>0){for(var mc=0;mc<Ar[Ci].length;mc++)if(Oe(Ar[Ci][mc],or))return Ci==="?"?a:Ci}else if(Oe(Ar[Ci],or))return Ci==="?"?a:Ci;return or},H1={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},K1={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[w,[R,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[w,[R,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[R,w],[/opios[\/ ]+([\w\.]+)/i],[w,[R,Ct+" Mini"]],[/\bopr\/([\w\.]+)/i],[w,[R,Ct]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[R,w],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[w,[R,"UC"+wt]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[w,[R,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[w,[R,"WeChat"]],[/konqueror\/([\w\.]+)/i],[w,[R,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[w,[R,"IE"]],[/yabrowser\/([\w\.]+)/i],[w,[R,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[R,/(.+)/,"$1 Secure "+wt],w],[/\bfocus\/([\w\.]+)/i],[w,[R,Ye+" Focus"]],[/\bopt\/([\w\.]+)/i],[w,[R,Ct+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[w,[R,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[w,[R,"Dolphin"]],[/coast\/([\w\.]+)/i],[w,[R,Ct+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[w,[R,"MIUI "+wt]],[/fxios\/([-\w\.]+)/i],[w,[R,Ye]],[/\bqihu|(qi?ho?o?|360)browser/i],[[R,"360 "+wt]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[R,/(.+)/,"$1 "+wt],w],[/(comodo_dragon)\/([\w\.]+)/i],[[R,/_/g," "],w],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[R,w],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[R],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[R,L],w],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[R,w],[/\bgsa\/([\w\.]+) .*safari\//i],[w,[R,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[w,[R,$t+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[R,$t+" WebView"],w],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[w,[R,"Android "+wt]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[R,w],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[w,[R,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[w,R],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[R,[w,Kp,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[R,w],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[R,"Netscape"],w],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[w,[R,Ye+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[R,w],[/(cobalt)\/([\w\.]+)/i],[R,[w,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[B,"amd64"]],[/(ia32(?=;))/i],[[B,Gn]],[/((?:i[346]|x)86)[;\)]/i],[[B,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[B,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[B,"armhf"]],[/windows (ce|mobile); ppc;/i],[[B,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[B,/ower/,"",Gn]],[/(sun4\w)[;\)]/i],[[B,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[B,Gn]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[T,[y,Pt],[v,G]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[T,[y,Pt],[v,U]],[/\((ip(?:hone|od)[\w ]*);/i],[T,[y,Et],[v,U]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[T,[y,Et],[v,G]],[/(macintosh);/i],[T,[y,Et]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[T,[y,Zt],[v,U]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[T,[y,ri],[v,G]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[T,[y,ri],[v,U]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[T,/_/g," "],[y,Sn],[v,U]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[T,/_/g," "],[y,Sn],[v,G]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[T,[y,"OPPO"],[v,U]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[T,[y,"Vivo"],[v,U]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[T,[y,"Realme"],[v,U]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[T,[y,_u],[v,U]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[T,[y,_u],[v,G]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[T,[y,mr],[v,G]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[T,[y,mr],[v,U]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[T,[y,"Lenovo"],[v,G]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[T,/_/g," "],[y,"Nokia"],[v,U]],[/(pixel c)\b/i],[T,[y,bn],[v,G]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[T,[y,bn],[v,U]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[T,[y,we],[v,U]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[T,"Xperia Tablet"],[y,we],[v,G]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[T,[y,"OnePlus"],[v,U]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[T,[y,ot],[v,G]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[T,/(.+)/g,"Fire Phone $1"],[y,ot],[v,U]],[/(playbook);[-\w\),; ]+(rim)/i],[T,y,[v,G]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[T,[y,Lt],[v,U]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[T,[y,vt],[v,G]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[T,[y,vt],[v,U]],[/(nexus 9)/i],[T,[y,"HTC"],[v,G]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[y,[T,/_/g," "],[v,U]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[T,[y,"Acer"],[v,G]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[T,[y,"Meizu"],[v,U]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[y,T,[v,U]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[y,T,[v,G]],[/(surface duo)/i],[T,[y,Li],[v,G]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[T,[y,"Fairphone"],[v,U]],[/(u304aa)/i],[T,[y,"AT&T"],[v,U]],[/\bsie-(\w*)/i],[T,[y,"Siemens"],[v,U]],[/\b(rct\w+) b/i],[T,[y,"RCA"],[v,G]],[/\b(venue[\d ]{2,7}) b/i],[T,[y,"Dell"],[v,G]],[/\b(q(?:mv|ta)\w+) b/i],[T,[y,"Verizon"],[v,G]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[T,[y,"Barnes & Noble"],[v,G]],[/\b(tm\d{3}\w+) b/i],[T,[y,"NuVision"],[v,G]],[/\b(k88) b/i],[T,[y,"ZTE"],[v,G]],[/\b(nx\d{3}j) b/i],[T,[y,"ZTE"],[v,U]],[/\b(gen\d{3}) b.+49h/i],[T,[y,"Swiss"],[v,U]],[/\b(zur\d{3}) b/i],[T,[y,"Swiss"],[v,G]],[/\b((zeki)?tb.*\b) b/i],[T,[y,"Zeki"],[v,G]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[y,"Dragon Touch"],T,[v,G]],[/\b(ns-?\w{0,9}) b/i],[T,[y,"Insignia"],[v,G]],[/\b((nxa|next)-?\w{0,9}) b/i],[T,[y,"NextBook"],[v,G]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[y,"Voice"],T,[v,U]],[/\b(lvtel\-)?(v1[12]) b/i],[[y,"LvTel"],T,[v,U]],[/\b(ph-1) /i],[T,[y,"Essential"],[v,U]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[T,[y,"Envizen"],[v,G]],[/\b(trio[-\w\. ]+) b/i],[T,[y,"MachSpeed"],[v,G]],[/\btu_(1491) b/i],[T,[y,"Rotor"],[v,G]],[/(shield[\w ]+) b/i],[T,[y,"Nvidia"],[v,G]],[/(sprint) (\w+)/i],[y,T,[v,U]],[/(kin\.[onetw]{3})/i],[[T,/\./g," "],[y,Li],[v,U]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[T,[y,Ft],[v,G]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[T,[y,Ft],[v,U]],[/smart-tv.+(samsung)/i],[y,[v,W]],[/hbbtv.+maple;(\d+)/i],[[T,/^/,"SmartTV"],[y,Pt],[v,W]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[y,mr],[v,W]],[/(apple) ?tv/i],[y,[T,Et+" TV"],[v,W]],[/crkey/i],[[T,$t+"cast"],[y,bn],[v,W]],[/droid.+aft(\w)( bui|\))/i],[T,[y,ot],[v,W]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[T,[y,Zt],[v,W]],[/(bravia[\w ]+)( bui|\))/i],[T,[y,we],[v,W]],[/(mitv-\w{5}) bui/i],[T,[y,Sn],[v,W]],[/Hbbtv.*(technisat) (.*);/i],[y,T,[v,W]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[y,Gr],[T,Gr],[v,W]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[v,W]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[y,T,[v,k]],[/droid.+; (shield) bui/i],[T,[y,"Nvidia"],[v,k]],[/(playstation [345portablevi]+)/i],[T,[y,we],[v,k]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[T,[y,Li],[v,k]],[/((pebble))app/i],[y,T,[v,$]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[T,[y,Et],[v,$]],[/droid.+; (glass) \d/i],[T,[y,bn],[v,$]],[/droid.+; (wt63?0{2,3})\)/i],[T,[y,Ft],[v,$]],[/(quest( 2| pro)?)/i],[T,[y,L],[v,$]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[y,[v,rt]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[T,[v,U]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[T,[v,G]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[v,G]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[v,U]],[/(android[-\w\. ]{0,9});.+buil/i],[T,[y,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[w,[R,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[w,[R,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[R,w],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[w,R]],os:[[/microsoft (windows) (vista|xp)/i],[R,w],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[R,[w,Kp,H1]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[R,"Windows"],[w,Kp,H1]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[w,/_/g,"."],[R,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[R,tt],[w,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[w,R],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[R,w],[/\(bb(10);/i],[w,[R,Lt]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[w,[R,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[w,[R,Ye+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[w,[R,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[w,[R,"watchOS"]],[/crkey\/([\d\.]+)/i],[w,[R,$t+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[R,X],w],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[R,w],[/(sunos) ?([\w\.\d]*)/i],[[R,"Solaris"],w],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[R,w]]},Ld=function(or,Ar){if(typeof or===p&&(Ar=or,or=a),!(this instanceof Ld))return new Ld(or,Ar).getResult();var Ci=typeof r!==l&&r.navigator?r.navigator:a,mc=or||(Ci&&Ci.userAgent?Ci.userAgent:""),lh=Ci&&Ci.userAgentData?Ci.userAgentData:a,ar=Ar?function(Rn,Oa){var jE={};for(var rl in Rn)Oa[rl]&&Oa[rl].length%2==0?jE[rl]=Oa[rl].concat(Rn[rl]):jE[rl]=Rn[rl];return jE}(K1,Ar):K1;return this.getBrowser=function(){var Rn={};return Rn[R]=a,Rn[w]=a,wa.call(Rn,mc,ar.browser),Rn[f]=function(Oa){return typeof Oa===E?Oa.replace(/[^\d\.]/g,"").split(".")[0]:a}(Rn[w]),Ci&&Ci.brave&&typeof Ci.brave.isBrave==d&&(Rn[R]="Brave"),Rn},this.getCPU=function(){var Rn={};return Rn[B]=a,wa.call(Rn,mc,ar.cpu),Rn},this.getDevice=function(){var Rn={};return Rn[y]=a,Rn[T]=a,Rn[v]=a,wa.call(Rn,mc,ar.device),!Rn[v]&&lh&&lh.mobile&&(Rn[v]=U),Rn[T]=="Macintosh"&&Ci&&typeof Ci.standalone!==l&&Ci.maxTouchPoints&&Ci.maxTouchPoints>2&&(Rn[T]="iPad",Rn[v]=G),Rn},this.getEngine=function(){var Rn={};return Rn[R]=a,Rn[w]=a,wa.call(Rn,mc,ar.engine),Rn},this.getOS=function(){var Rn={};return Rn[R]=a,Rn[w]=a,wa.call(Rn,mc,ar.os),!Rn[R]&&lh&&lh.platform!="Unknown"&&(Rn[R]=lh.platform.replace(/chrome os/i,X).replace(/macos/i,tt)),Rn},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return mc},this.setUA=function(Rn){return mc=typeof Rn===E&&Rn.length>350?Gr(Rn,350):Rn,this},this.setUA(mc),this};Ld.VERSION="0.7.34",Ld.BROWSER=Ot([R,w,f]),Ld.CPU=Ot([B]),Ld.DEVICE=Ot([T,y,v,k,U,W,G,$,rt]),Ld.ENGINE=Ld.OS=Ot([R,w]),t.exports&&(n=t.exports=Ld),n.UAParser=Ld;var BE=typeof r!==l&&(r.jQuery||r.Zepto);if(BE&&!BE.ua){var WC=new Ld;BE.ua=WC.getResult(),BE.ua.get=function(){return WC.getUA()},BE.ua.set=function(or){WC.setUA(or);var Ar=WC.getResult();for(var Ci in Ar)BE.ua[Ci]=Ar[Ci]}}})(typeof window=="object"?window:mt)})(_S,_S.exports);var oB=Rt(_S.exports),Ky=Es,aB=Zn,rP=Tu,cB=Ud,Yy=ze("iterator"),Fm=Object,sP=function(t){if(rP(t))return!1;var n=Fm(t);return n[Yy]!==void 0||"@@iterator"in n||aB(cB,Ky(n))},qy=Rt(sP),Bm=Te;Ce({global:!0,forced:Bm.globalThis!==Bm},{globalThis:Bm});var zy=Rt(Te),Jy=xT.clear;Ce({global:!0,bind:!0,forced:Te.clearImmediate!==Jy},{clearImmediate:Jy});var oP=typeof Bun=="function"&&Bun&&typeof Bun.version=="string",Xy=Te,E_=mi,Qy=wn,Zy=oP,$y=ta,aP=LT,cP=a_,dB=Xy.Function,uB=/MSIE .\./.test($y)||Zy&&function(){var t=Xy.Bun.version.split(".");return t.length<3||t[0]==0&&(t[1]<3||t[1]==3&&t[2]==0)}(),Fh=Ce,tA=Te,dP=xT.set,eA=function(t,n){var r=1;return uB?function(a,d){var l=cP(arguments.length,1)>r,p=Qy(a)?a:dB(a),E=l?aP(arguments,r):[],f=l?function(){E_(p,this,E)}:p;return t(f)}:t},uP=tA.setImmediate?eA(dP):dP;Fh({global:!0,bind:!0,forced:tA.setImmediate!==uP},{setImmediate:uP});var lP=Rt($r.setImmediate),lB=Ce,hB=w0,nA=kr,hP=a_,pP=Rh,_P=Te.process;lB({global:!0,dontCallGetSet:!0},{queueMicrotask:function(t){hP(arguments.length,1),nA(t);var n=pP&&_P.domain;hB(n?n.bind(t):t)}});var jm=Rt($r.queueMicrotask);function iA(t,n){return function(){return t.apply(n,arguments)}}const{toString:rA}=Object.prototype,{getPrototypeOf:m_}=Object,Bh=(sA=Object.create(null),t=>{const n=rA.call(t);return sA[n]||(sA[n]=n.slice(8,-1).toLowerCase())});var sA;const ho=t=>(t=t.toLowerCase(),n=>Bh(n)===t),ml=t=>n=>typeof n===t,{isArray:jh}=Array,Gm=ml("undefined"),EP=ho("ArrayBuffer"),Wm=ml("string"),xa=ml("function"),mP=ml("number"),ES=t=>t!==null&&typeof t=="object",mS=t=>{if(Bh(t)!=="object")return!1;const n=m_(t);return!(n!==null&&n!==Object.prototype&&Object.getPrototypeOf(n)!==null||Symbol.toStringTag in t||qy(t))},pB=ho("Date"),_B=ho("File"),oA=ho("Blob"),fP=ho("FileList"),EB=ho("URLSearchParams"),[gP,mB,Hm,Bd]=["ReadableStream","Request","Response","Headers"].map(ho);function f_(t,n){let r,a,{allOwnKeys:d=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),jh(t))for(r=0,a=t.length;r<a;r++)n.call(null,t[r],r,t);else{const l=d?Object.getOwnPropertyNames(t):Object.keys(t),p=l.length;let E;for(r=0;r<p;r++)E=l[r],n.call(null,t[E],E,t)}}function TP(t,n){n=n.toLowerCase();const r=Object.keys(t);let a,d=r.length;for(;d-- >0;)if(a=r[d],n===a.toLowerCase())return a;return null}const Gh=zy!==void 0?zy:typeof self<"u"?self:typeof window<"u"?window:YE,fS=t=>!Gm(t)&&t!==Gh,SP=(aA=typeof Uint8Array<"u"&&m_(Uint8Array),t=>aA&&t instanceof aA);var aA;const gS=ho("HTMLFormElement"),wu=(t=>{let{hasOwnProperty:n}=t;return(r,a)=>n.call(r,a)})(Object.prototype),Km=ho("RegExp"),RP=(t,n)=>{const r=Object.getOwnPropertyDescriptors(t),a={};f_(r,(d,l)=>{let p;(p=n(d,l,t))!==!1&&(a[l]=p||d)}),Object.defineProperties(t,a)},cA="abcdefghijklmnopqrstuvwxyz",CP="0123456789",vP={DIGIT:CP,ALPHA:cA,ALPHA_DIGIT:cA+cA.toUpperCase()+CP},dA=ho("AsyncFunction"),IP=(yP=typeof lP=="function",AP=xa(Gh.postMessage),yP?lP:AP?(TS="axios@".concat(Math.random()),g_=[],Gh.addEventListener("message",t=>{let{source:n,data:r}=t;n===Gh&&r===TS&&g_.length&&g_.shift()()},!1),t=>{g_.push(t),Gh.postMessage(TS,"*")}):t=>setTimeout(t));var yP,AP,TS,g_;const fB=jm!==void 0?jm.bind(Gh):typeof process<"u"&&process.nextTick||IP;var Ut={isArray:jh,isArrayBuffer:EP,isBuffer:function(t){return t!==null&&!Gm(t)&&t.constructor!==null&&!Gm(t.constructor)&&xa(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let n;return t&&(typeof FormData=="function"&&t instanceof FormData||xa(t.append)&&((n=Bh(t))==="formdata"||n==="object"&&xa(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let n;return n=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&EP(t.buffer),n},isString:Wm,isNumber:mP,isBoolean:t=>t===!0||t===!1,isObject:ES,isPlainObject:mS,isReadableStream:gP,isRequest:mB,isResponse:Hm,isHeaders:Bd,isUndefined:Gm,isDate:pB,isFile:_B,isBlob:oA,isRegExp:Km,isFunction:xa,isStream:t=>ES(t)&&xa(t.pipe),isURLSearchParams:EB,isTypedArray:SP,isFileList:fP,forEach:f_,merge:function t(){const{caseless:n}=fS(this)&&this||{},r={},a=(d,l)=>{const p=n&&TP(r,l)||l;mS(r[p])&&mS(d)?r[p]=t(r[p],d):mS(d)?r[p]=t({},d):jh(d)?r[p]=d.slice():r[p]=d};for(let d=0,l=arguments.length;d<l;d++)arguments[d]&&f_(arguments[d],a);return r},extend:function(t,n,r){let{allOwnKeys:a}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return f_(n,(d,l)=>{r&&xa(d)?t[l]=iA(d,r):t[l]=d},{allOwnKeys:a}),t},trim:t=>ms(t)?ms(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,n,r,a)=>{t.prototype=Object.create(n.prototype,a),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:n.prototype}),r&&Object.assign(t.prototype,r)},toFlatObject:(t,n,r,a)=>{let d,l,p;const E={};if(n=n||{},t==null)return n;do{for(d=Object.getOwnPropertyNames(t),l=d.length;l-- >0;)p=d[l],a&&!a(p,t,n)||E[p]||(n[p]=t[p],E[p]=!0);t=r!==!1&&m_(t)}while(t&&(!r||r(t,n))&&t!==Object.prototype);return n},kindOf:Bh,kindOfTest:ho,endsWith:(t,n,r)=>{t=String(t),(r===void 0||r>t.length)&&(r=t.length),r-=n.length;const a=t.indexOf(n,r);return a!==-1&&a===r},toArray:t=>{if(!t)return null;if(jh(t))return t;let n=t.length;if(!mP(n))return null;const r=new Array(n);for(;n-- >0;)r[n]=t[n];return r},forEachEntry:(t,n)=>{const r=(t&&t[Symbol.iterator]).call(t);let a;for(;(a=r.next())&&!a.done;){const d=a.value;n.call(t,d[0],d[1])}},matchAll:(t,n)=>{let r;const a=[];for(;(r=t.exec(n))!==null;)a.push(r);return a},isHTMLForm:gS,hasOwnProperty:wu,hasOwnProp:wu,reduceDescriptors:RP,freezeMethods:t=>{RP(t,(n,r)=>{if(xa(t)&&["arguments","caller","callee"].indexOf(r)!==-1)return!1;const a=t[r];xa(a)&&(n.enumerable=!1,"writable"in n?n.writable=!1:n.set||(n.set=()=>{throw Error("Can not rewrite read-only method '"+r+"'")}))})},toObjectSet:(t,n)=>{const r={},a=d=>{d.forEach(l=>{r[l]=!0})};return jh(t)?a(t):a(String(t).split(n)),r},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(n,r,a){return r.toUpperCase()+a}),noop:()=>{},toFiniteNumber:(t,n)=>t!=null&&Number.isFinite(t=+t)?t:n,findKey:TP,global:Gh,isContextDefined:fS,ALPHABET:vP,generateString:function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:vP.ALPHA_DIGIT,r="";const{length:a}=n;for(;t--;)r+=n[Math.random()*a|0];return r},isSpecCompliantForm:function(t){return!!(t&&xa(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])},toJSONObject:t=>{const n=new Array(10),r=(a,d)=>{if(ES(a)){if(n.indexOf(a)>=0)return;if(!("toJSON"in a)){n[d]=a;const l=jh(a)?[]:{};return f_(a,(p,E)=>{const f=r(p,d+1);!Gm(f)&&(l[E]=f)}),n[d]=void 0,l}}return a};return r(t,0)},isAsyncFn:dA,isThenable:t=>t&&(ES(t)||xa(t))&&xa(t.then)&&xa(t.catch),setImmediate:IP,asap:fB};function Pn(t,n,r,a,d){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",n&&(this.code=n),r&&(this.config=r),a&&(this.request=a),d&&(this.response=d,this.status=d.status?d.status:null)}Ut.inherits(Pn,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Ut.toJSONObject(this.config),code:this.code,status:this.status}}});const uA=Pn.prototype,SS={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{SS[t]={value:t}}),Object.defineProperties(Pn,SS),Object.defineProperty(uA,"isAxiosError",{value:!0}),Pn.from=(t,n,r,a,d,l)=>{const p=Object.create(uA);return Ut.toFlatObject(t,p,function(E){return E!==Error.prototype},E=>E!=="isAxiosError"),Pn.call(p,t.message,n,r,a,d),p.cause=t,p.name=t.name,l&&Object.assign(p,l),p};function RS(t){return Ut.isPlainObject(t)||Ut.isArray(t)}function lA(t){return Ut.endsWith(t,"[]")?t.slice(0,-2):t}function Ym(t,n,r){return t?t.concat(n).map(function(a,d){return a=lA(a),!r&&d?"["+a+"]":a}).join(r?".":""):n}const bP=Ut.toFlatObject(Ut,{},null,function(t){return/^is[A-Z]/.test(t)});function CS(t,n,r){if(!Ut.isObject(t))throw new TypeError("target must be an object");n=n||new FormData;const a=(r=Ut.toFlatObject(r,{metaTokens:!0,dots:!1,indexes:!1},!1,function(y,w){return!Ut.isUndefined(w[y])})).metaTokens,d=r.visitor||T,l=r.dots,p=r.indexes,E=(r.Blob||typeof Blob<"u"&&Blob)&&Ut.isSpecCompliantForm(n);if(!Ut.isFunction(d))throw new TypeError("visitor must be a function");function f(y){if(y===null)return"";if(Ut.isDate(y))return y.toISOString();if(!E&&Ut.isBlob(y))throw new Pn("Blob is not supported. Use a Buffer instead.");return Ut.isArrayBuffer(y)||Ut.isTypedArray(y)?E&&typeof Blob=="function"?new Blob([y]):Buffer.from(y):y}function T(y,w,B){let k=y;if(y&&!B&&typeof y=="object"){if(Ut.endsWith(w,"{}"))w=a?w:w.slice(0,-2),y=JSON.stringify(y);else if(Ut.isArray(y)&&function(U){return Ut.isArray(U)&&!U.some(RS)}(y)||(Ut.isFileList(y)||Ut.endsWith(w,"[]"))&&(k=Ut.toArray(y)))return w=lA(w),k.forEach(function(U,G){!Ut.isUndefined(U)&&U!==null&&n.append(p===!0?Ym([w],G,l):p===null?w:w+"[]",f(U))}),!1}return!!RS(y)||(n.append(Ym(B,w,l),f(y)),!1)}const R=[],v=Object.assign(bP,{defaultVisitor:T,convertValue:f,isVisitable:RS});if(!Ut.isObject(t))throw new TypeError("data must be an object");return function y(w,B){if(!Ut.isUndefined(w)){if(R.indexOf(w)!==-1)throw Error("Circular reference detected in "+B.join("."));R.push(w),Ut.forEach(w,function(k,U){(!(Ut.isUndefined(k)||k===null)&&d.call(n,k,Ut.isString(U)?ms(U).call(U):U,B,v))===!0&&y(k,B?B.concat(U):[U])}),R.pop()}}(t),n}function vS(t){const n={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(r){return n[r]})}function hA(t,n){this._pairs=[],t&&CS(t,this,n)}const wP=hA.prototype;function qm(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function IS(t,n,r){if(!n)return t;const a=r&&r.encode||qm,d=r&&r.serialize;let l;if(l=d?d(n,r):Ut.isURLSearchParams(n)?n.toString():new hA(n,r).toString(a),l){const p=t.indexOf("#");p!==-1&&(t=t.slice(0,p)),t+=(t.indexOf("?")===-1?"?":"&")+l}return t}wP.append=function(t,n){this._pairs.push([t,n])},wP.toString=function(t){const n=t?function(r){return t.call(this,r,vS)}:vS;return this._pairs.map(function(r){return n(r[0])+"="+n(r[1])},"").join("&")};var pA=class{constructor(){this.handlers=[]}use(t,n,r){return this.handlers.push({fulfilled:t,rejected:n,synchronous:!!r&&r.synchronous,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){Ut.forEach(this.handlers,function(n){n!==null&&t(n)})}},yS={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},AS={exports:{}},_A=Ce,gB=wr,OP=_s.f;_A({target:"Object",stat:!0,forced:Object.defineProperty!==OP,sham:!gB},{defineProperty:OP});var EA=$r.Object,NP=AS.exports=function(t,n,r){return EA.defineProperty(t,n,r)};EA.defineProperty.sham&&(NP.sham=!0);var mA=Rt(AS.exports),DP=Zi,T_=Array.isArray||function(t){return DP(t)=="Array"},TB=TypeError,fA=T_,SB=ym,S_=fr,R_=ze("species"),bS=Array,PP=function(t){var n;return fA(t)&&(n=t.constructor,(SB(n)&&(n===bS||fA(n.prototype))||S_(n)&&(n=n[R_])===null)&&(n=void 0)),n===void 0?bS:n},gA=function(t,n){return new(PP(t))(n===0?0:n)},RB=Nt,LP=Pa,CB=ze("species"),kP=function(t){return LP>=51||!RB(function(){var n=[];return(n.constructor={})[CB]=function(){return{foo:1}},n[t](Boolean).foo!==1})},wS=Ce,vB=Nt,IB=T_,yB=fr,AB=Ns,bB=vu,MP=function(t){if(t>9007199254740991)throw TB("Maximum allowed index exceeded");return t},UP=lS,wB=gA,OB=kP,NB=Pa,xP=ze("isConcatSpreadable"),DB=NB>=51||!vB(function(){var t=[];return t[xP]=!1,t.concat()[0]!==t}),PB=function(t){if(!yB(t))return!1;var n=t[xP];return n!==void 0?!!n:IB(t)};wS({target:"Array",proto:!0,forced:!DB||!OB("concat")},{concat:function(t){var n,r,a,d,l,p=AB(this),E=wB(p,0),f=0;for(n=-1,a=arguments.length;n<a;n++)if(PB(l=n===-1?p:arguments[n]))for(d=bB(l),MP(f+d),r=0;r<d;r++,f++)r in l&&UP(E,f,l[r]);else MP(f+1),UP(E,f++,l);return E.length=f,E}});var VP={},LB=Zi,kB=$o,FP=Jp.f,BP=Uy,jP=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];VP.f=function(t){return jP&&LB(t)=="Window"?function(n){try{return FP(n)}catch{return BP(jP)}}(t):FP(kB(t))};var C_={},MB=ze;C_.f=MB;var GP=$r,UB=Zn,xB=C_,VB=_s.f,es=function(t){var n=GP.Symbol||(GP.Symbol={});UB(n,t)||VB(n,t,{value:xB.f(t)})},FB=Wn,BB=qi,jB=ze,GB=Au,WP=function(){var t=BB("Symbol"),n=t&&t.prototype,r=n&&n.valueOf,a=jB("toPrimitive");n&&!n[a]&&GB(n,a,function(d){return FB(r,this)},{})},WB=Do,HB=fh,KB=Ns,YB=vu,HP=gA,KP=Qt([].push),TA=function(t){var n=t==1,r=t==2,a=t==3,d=t==4,l=t==6,p=t==7,E=t==5||l;return function(f,T,R,v){for(var y,w,B=KB(f),k=HB(B),U=WB(T,R),G=YB(k),W=0,$=v||HP,rt=n?$(f,G):r||p?$(f,0):void 0;G>W;W++)if((E||W in k)&&(w=U(y=k[W],W,B),t))if(n)rt[W]=w;else if(w)switch(t){case 3:return!0;case 5:return y;case 6:return W;case 2:KP(rt,y)}else switch(t){case 4:return!1;case 7:KP(rt,y)}return l?-1:a||d?d:rt}},YP={forEach:TA(0)},OS=Ce,SA=Te,RA=Wn,qP=Qt,v_=wr,Wh=Kc,ut=Nt,Ws=Zn,zm=le,I_=$i,Hh=$o,Tc=gh,gr=La,un=No,Kh=um,CA=uT,Ou=Jp,NS=VP,ln=dm,Jm=gu,vA=_s,DS=Qv,zP=Eh,JP=Au,Nu=Cm,Or=qc,Ln=Ch,ys=ZE,IA=ze,XP=C_,QP=es,ZP=WP,$P=hl,Yh=yh,y_=YP.forEach,Lo=cm("hidden"),Va="Symbol",A_="prototype",tL=Yh.set,Du=Yh.getterFor(Va),ia=Object[A_],$c=SA.Symbol,j=$c&&$c[A_],ft=SA.TypeError,td=SA.QObject,cr=Jm.f,hn=vA.f,PS=NS.f,fs=zP.f,jd=qP([].push),xn=Or("symbols"),b_=Or("op-symbols"),eL=Or("wks"),LS=!td||!td[A_]||!td[A_].findChild,fl=v_&&ut(function(){return Kh(hn({},"a",{get:function(){return hn(this,"a",{value:7}).a}})).a!=7})?function(t,n,r){var a=cr(ia,n);a&&delete ia[n],hn(t,n,r),a&&t!==ia&&hn(ia,n,a)}:hn,w_=function(t,n){var r=xn[t]=Kh(j);return tL(r,{type:Va,tag:t,description:n}),v_||(r.description=n),r},Xm=function(t,n,r){t===ia&&Xm(b_,n,r),I_(t);var a=Tc(n);return I_(r),Ws(xn,a)?(r.enumerable?(Ws(t,Lo)&&t[Lo][a]&&(t[Lo][a]=!1),r=Kh(r,{enumerable:un(0,!1)})):(Ws(t,Lo)||hn(t,Lo,un(1,{})),t[Lo][a]=!0),fl(t,a,r)):hn(t,a,r)},Qm=function(t,n){I_(t);var r=Hh(n),a=CA(r).concat(oi(r));return y_(a,function(d){v_&&!RA(yA,r,d)||Xm(t,d,r[d])}),t},yA=function(t){var n=Tc(t),r=RA(fs,this,n);return!(this===ia&&Ws(xn,n)&&!Ws(b_,n))&&(!(r||!Ws(this,n)||!Ws(xn,n)||Ws(this,Lo)&&this[Lo][n])||r)},nL=function(t,n){var r=Hh(t),a=Tc(n);if(r!==ia||!Ws(xn,a)||Ws(b_,a)){var d=cr(r,a);return!d||!Ws(xn,a)||Ws(r,Lo)&&r[Lo][a]||(d.enumerable=!0),d}},kS=function(t){var n=PS(Hh(t)),r=[];return y_(n,function(a){Ws(xn,a)||Ws(Ln,a)||jd(r,a)}),r},oi=function(t){var n=t===ia,r=PS(n?b_:Hh(t)),a=[];return y_(r,function(d){!Ws(xn,d)||n&&!Ws(ia,d)||jd(a,xn[d])}),a};Wh||($c=function(){if(zm(j,this))throw ft("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?gr(arguments[0]):void 0,n=ys(t),r=function(a){this===ia&&RA(r,b_,a),Ws(this,Lo)&&Ws(this[Lo],n)&&(this[Lo][n]=!1),fl(this,n,un(1,a))};return v_&&LS&&fl(ia,n,{configurable:!0,set:r}),w_(n,t)},JP(j=$c[A_],"toString",function(){return Du(this).tag}),JP($c,"withoutSetter",function(t){return w_(ys(t),t)}),zP.f=yA,vA.f=Xm,DS.f=Qm,Jm.f=nL,Ou.f=NS.f=kS,ln.f=oi,XP.f=function(t){return w_(IA(t),t)},v_&&Nu(j,"description",{configurable:!0,get:function(){return Du(this).description}})),OS({global:!0,wrap:!0,forced:!Wh,sham:!Wh},{Symbol:$c}),y_(CA(eL),function(t){QP(t)}),OS({target:Va,stat:!0,forced:!Wh},{useSetter:function(){LS=!0},useSimple:function(){LS=!1}}),OS({target:"Object",stat:!0,forced:!Wh,sham:!v_},{create:function(t,n){return n===void 0?Kh(t):Qm(Kh(t),n)},defineProperty:Xm,defineProperties:Qm,getOwnPropertyDescriptor:nL}),OS({target:"Object",stat:!0,forced:!Wh},{getOwnPropertyNames:kS}),ZP(),$P($c,Va),Ln[Lo]=!0;var O_=Kc&&!!Symbol.for&&!!Symbol.keyFor,iL=Ce,tr=qi,gi=Zn,AA=La,Fe=qc,We=O_,Tr=Fe("string-to-symbol-registry"),Ds=Fe("symbol-to-string-registry");iL({target:"Symbol",stat:!0,forced:!We},{for:function(t){var n=AA(t);if(gi(Tr,n))return Tr[n];var r=tr("Symbol")(n);return Tr[n]=r,Ds[r]=n,r}});var Pu=Ce,rL=Zn,N_=Su,sL=Yc,oL=O_,zi=qc("symbol-to-string-registry");Pu({target:"Symbol",stat:!0,forced:!oL},{keyFor:function(t){if(!N_(t))throw TypeError(sL(t)+" is not a symbol");if(rL(zi,t))return zi[t]}});var kn=T_,ko=wn,gl=Zi,er=La,aL=Qt([].push),qB=Ce,cL=qi,dL=mi,zB=Wn,Zm=Qt,uL=Nt,lL=wn,hL=Su,pL=LT,bA=function(t){if(ko(t))return t;if(kn(t)){for(var n=t.length,r=[],a=0;a<n;a++){var d=t[a];typeof d=="string"?aL(r,d):typeof d!="number"&&gl(d)!="Number"&&gl(d)!="String"||aL(r,er(d))}var l=r.length,p=!0;return function(E,f){if(p)return p=!1,f;if(kn(this))return f;for(var T=0;T<l;T++)if(r[T]===E)return f}}},Lu=Kc,_L=String,ra=cL("JSON","stringify"),qh=Zm(/./.exec),zh=Zm("".charAt),MS=Zm("".charCodeAt),Jn=Zm("".replace),Jh=Zm(1 .toString),EL=/[\uD800-\uDFFF]/g,Xh=/^[\uD800-\uDBFF]$/,D_=/^[\uDC00-\uDFFF]$/,Qh=!Lu||uL(function(){var t=cL("Symbol")();return ra([t])!="[null]"||ra({a:t})!="{}"||ra(Object(t))!="{}"}),wA=uL(function(){return ra("\uDF06\uD834")!=='"\\udf06\\ud834"'||ra("\uDEAD")!=='"\\udead"'}),Gd=function(t,n){var r=pL(arguments),a=bA(n);if(lL(a)||t!==void 0&&!hL(t))return r[1]=function(d,l){if(lL(a)&&(l=zB(a,this,_L(d),l)),!hL(l))return l},dL(ra,null,r)},mL=function(t,n,r){var a=zh(r,n-1),d=zh(r,n+1);return qh(Xh,t)&&!qh(D_,d)||qh(D_,t)&&!qh(Xh,a)?"\\u"+Jh(MS(t,0),16):t};ra&&qB({target:"JSON",stat:!0,forced:Qh||wA},{stringify:function(t,n,r){var a=pL(arguments),d=dL(Qh?Gd:ra,null,a);return wA&&typeof d=="string"?Jn(d,EL,mL):d}});var fL=dm,Mr=Ns;Ce({target:"Object",stat:!0,forced:!Kc||Nt(function(){fL.f(1)})},{getOwnPropertySymbols:function(t){var n=fL.f;return n?n(Mr(t)):[]}}),es("asyncIterator"),es("hasInstance"),es("isConcatSpreadable"),es("iterator"),es("match"),es("matchAll"),es("replace"),es("search"),es("species"),es("split");var Hn=WP;es("toPrimitive"),Hn();var OA=qi,US=hl;es("toStringTag"),US(OA("Symbol"),"Symbol"),es("unscopables"),hl(Te.JSON,"JSON",!0);var gL=$r.Symbol,TL=ze,SL=_s.f,xS=TL("metadata"),NA=Function.prototype;NA[xS]===void 0&&SL(NA,xS,{value:null}),es("dispose"),es("metadata");var JB=gL;es("asyncDispose");var VS=Qt,Sr=qi("Symbol"),P_=Sr.keyFor,nr=VS(Sr.prototype.valueOf),$m=Sr.isRegisteredSymbol||function(t){try{return P_(nr(t))!==void 0}catch{return!1}};Ce({target:"Symbol",stat:!0},{isRegisteredSymbol:$m});for(var ed=qc,FS=qi,RL=Qt,XB=Su,DA=ze,Zh=FS("Symbol"),BS=Zh.isWellKnownSymbol,nd=FS("Object","getOwnPropertyNames"),jS=RL(Zh.prototype.valueOf),$h=ed("wks"),tp=0,PA=nd(Zh),QB=PA.length;tp<QB;tp++)try{var Fa=PA[tp];XB(Zh[Fa])&&DA(Fa)}catch{}var LA=function(t){if(BS&&BS(t))return!0;try{for(var n=jS(t),r=0,a=nd($h),d=a.length;r<d;r++)if($h[a[r]]==n)return!0}catch{}return!1};Ce({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:LA}),es("matcher"),es("observable"),Ce({target:"Symbol",stat:!0},{isRegistered:$m}),Ce({target:"Symbol",stat:!0,forced:!0},{isWellKnown:LA}),es("metadataKey"),es("patternMatch"),es("replaceAll");var ku=Rt(JB),tf=Rt(C_.f("iterator"));function ef(t){return ef=typeof ku=="function"&&typeof tf=="symbol"?function(n){return typeof n}:function(n){return n&&typeof ku=="function"&&n.constructor===ku&&n!==ku.prototype?"symbol":typeof n},ef(t)}var ZB=Rt(C_.f("toPrimitive"));function $B(t){var n=function(r,a){if(ef(r)!=="object"||r===null)return r;var d=r[ZB];if(d!==void 0){var l=d.call(r,a);if(ef(l)!=="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(r)}(t,"string");return ef(n)==="symbol"?n:String(n)}function F(t,n,r){return(n=$B(n))in t?mA(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}var tj=Nt,nf=ze("iterator"),GS=!tj(function(){var t=new URL("b?a=1&b=2&c=3","http://a"),n=t.searchParams,r=new URLSearchParams("a=1&a=2"),a="";return t.pathname="c%20d",n.forEach(function(d,l){n.delete("b"),a+=l+d}),r.delete("a",2),!t.toJSON||!r.has("a",1)||r.has("a",2)||!n.size&&!0||!n.sort||t.href!=="http://a/c%20d?a=1&c=3"||n.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!n[nf]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://тест").host!=="xn--e1aybc"||new URL("http://a#б").hash!=="#%D0%B1"||a!=="a1c3"||new URL("http://x",void 0).host!=="x"}),CL=Au,WS=Ce,L_=Te,k_=Wn,Wd=Qt,ep=wr,vL=GS,kA=Au,MA=Cm,IL=function(t,n,r){for(var a in n)r&&r.unsafe&&t[a]?t[a]=n[a]:CL(t,a,n[a],r);return t},yL=hl,ej=pl,Yt=yh,ui=Ma,HS=wn,AL=Zn,UA=Do,bL=Es,wL=$i,OL=fr,Hs=La,NL=um,KS=No,YS=Zp,nj=vh,np=a_,DL=pS,PL=ze("iterator"),rf="URLSearchParams",xA=rf+"Iterator",LL=Yt.set,Ba=Yt.getterFor(rf),ij=Yt.getterFor(xA),Hd=Object.getOwnPropertyDescriptor,qS=function(t){if(!ep)return L_[t];var n=Hd(L_,t);return n&&n.value},zS=qS("fetch"),M_=qS("Request"),sf=qS("Headers"),JS=M_&&M_.prototype,U_=sf&&sf.prototype,XS=L_.RegExp,VA=L_.TypeError,of=L_.decodeURIComponent,Mu=L_.encodeURIComponent,FA=Wd("".charAt),BA=Wd([].join),id=Wd([].push),jA=Wd("".replace),kL=Wd([].shift),ML=Wd([].splice),GA=Wd("".split),rj=Wd("".slice),WA=/\+/g,HA=Array(4),sj=function(t){return HA[t-1]||(HA[t-1]=XS("((?:%[\\da-f]{2}){"+t+"})","gi"))},UL=function(t){try{return of(t)}catch{return t}},QS=function(t){var n=jA(t,WA," "),r=4;try{return of(n)}catch{for(;r;)n=jA(n,sj(r--),UL);return n}},xL=/[!'()~]|%20/g,VL={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},x_=function(t){return VL[t]},KA=function(t){return jA(Mu(t),xL,x_)},af=ej(function(t,n){LL(this,{type:xA,iterator:YS(Ba(t).entries),kind:n})},"Iterator",function(){var t=ij(this),n=t.kind,r=t.iterator.next(),a=r.value;return r.done||(r.value=n==="keys"?a.key:n==="values"?a.value:[a.key,a.value]),r},!0),YA=function(t){this.entries=[],this.url=null,t!==void 0&&(OL(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?FA(t,0)==="?"?rj(t,1):t:Hs(t)))};YA.prototype={type:rf,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var n,r,a,d,l,p,E,f=nj(t);if(f)for(r=(n=YS(t,f)).next;!(a=k_(r,n)).done;){if(l=(d=YS(wL(a.value))).next,(p=k_(l,d)).done||(E=k_(l,d)).done||!k_(l,d).done)throw VA("Expected sequence with length 2");id(this.entries,{key:Hs(p.value),value:Hs(E.value)})}else for(var T in t)AL(t,T)&&id(this.entries,{key:T,value:Hs(t[T])})},parseQuery:function(t){if(t)for(var n,r,a=GA(t,"&"),d=0;d<a.length;)(n=a[d++]).length&&(r=GA(n,"="),id(this.entries,{key:QS(kL(r)),value:QS(BA(r,"="))}))},serialize:function(){for(var t,n=this.entries,r=[],a=0;a<n.length;)t=n[a++],id(r,KA(t.key)+"="+KA(t.value));return BA(r,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var V_=function(){ui(this,ja);var t=LL(this,new YA(arguments.length>0?arguments[0]:void 0));ep||(this.size=t.entries.length)},ja=V_.prototype;if(IL(ja,{append:function(t,n){var r=Ba(this);np(arguments.length,2),id(r.entries,{key:Hs(t),value:Hs(n)}),ep||this.length++,r.updateURL()},delete:function(t){for(var n=Ba(this),r=np(arguments.length,1),a=n.entries,d=Hs(t),l=r<2?void 0:arguments[1],p=l===void 0?l:Hs(l),E=0;E<a.length;){var f=a[E];if(f.key!==d||p!==void 0&&f.value!==p)E++;else if(ML(a,E,1),p!==void 0)break}ep||(this.size=a.length),n.updateURL()},get:function(t){var n=Ba(this).entries;np(arguments.length,1);for(var r=Hs(t),a=0;a<n.length;a++)if(n[a].key===r)return n[a].value;return null},getAll:function(t){var n=Ba(this).entries;np(arguments.length,1);for(var r=Hs(t),a=[],d=0;d<n.length;d++)n[d].key===r&&id(a,n[d].value);return a},has:function(t){for(var n=Ba(this).entries,r=np(arguments.length,1),a=Hs(t),d=r<2?void 0:arguments[1],l=d===void 0?d:Hs(d),p=0;p<n.length;){var E=n[p++];if(E.key===a&&(l===void 0||E.value===l))return!0}return!1},set:function(t,n){var r=Ba(this);np(arguments.length,1);for(var a,d=r.entries,l=!1,p=Hs(t),E=Hs(n),f=0;f<d.length;f++)(a=d[f]).key===p&&(l?ML(d,f--,1):(l=!0,a.value=E));l||id(d,{key:p,value:E}),ep||(this.size=d.length),r.updateURL()},sort:function(){var t=Ba(this);DL(t.entries,function(n,r){return n.key>r.key?1:-1}),t.updateURL()},forEach:function(t){for(var n,r=Ba(this).entries,a=UA(t,arguments.length>1?arguments[1]:void 0),d=0;d<r.length;)a((n=r[d++]).value,n.key,this)},keys:function(){return new af(this,"keys")},values:function(){return new af(this,"values")},entries:function(){return new af(this,"entries")}},{enumerable:!0}),kA(ja,PL,ja.entries,{}),kA(ja,"toString",function(){return Ba(this).serialize()},{enumerable:!0}),ep&&MA(ja,"size",{get:function(){return Ba(this).entries.length},configurable:!0,enumerable:!0}),yL(V_,rf),WS({global:!0,forced:!vL},{URLSearchParams:V_}),!vL&&HS(sf)){var ZS=Wd(U_.has),$S=Wd(U_.set),tR=function(t){if(OL(t)){var n,r=t.body;if(bL(r)===rf)return n=t.headers?new sf(t.headers):new sf,ZS(n,"content-type")||$S(n,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),NL(t,{body:KS(0,Hs(r)),headers:KS(0,n)})}return t};if(HS(zS)&&WS({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return zS(t,arguments.length>1?tR(arguments[1]):{})}}),HS(M_)){var qA=function(t){return ui(this,JS),new M_(t,arguments.length>1?tR(arguments[1]):{})};JS.constructor=qA,qA.prototype=JS,WS({global:!0,dontCallGetSet:!0,forced:!0},{Request:qA})}}var zA={URLSearchParams:V_,getState:Ba},FL=Rt($r.URLSearchParams),As={isBrowser:!0,classes:{URLSearchParams:FL!==void 0?FL:hA,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const Ks=typeof window<"u"&&typeof document<"u",eR=typeof navigator=="object"&&navigator||void 0,BL=Ks&&(!eR||["ReactNative","NativeScript","NS"].indexOf(eR.product)<0),nR=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",iR=Ks&&window.location.href||"http://localhost";function rR(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function sR(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?rR(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):rR(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}var sa=sR(sR({},Object.freeze({__proto__:null,hasBrowserEnv:Ks,hasStandardBrowserEnv:BL,hasStandardBrowserWebWorkerEnv:nR,navigator:eR,origin:iR})),As),oj=$i,jL=Wn,Ga=Zn,JA=le,Uu=function(){var t=oj(this),n="";return t.hasIndices&&(n+="d"),t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.dotAll&&(n+="s"),t.unicode&&(n+="u"),t.unicodeSets&&(n+="v"),t.sticky&&(n+="y"),n},oR=RegExp.prototype,bs=function(t){var n=t.flags;return n!==void 0||"flags"in oR||Ga(t,"flags")||!JA(oR,t)?n:jL(Uu,t)},Mn=nS.charAt,Q=Wn,Tl=$i,GL=wn,re=Zi,Be=/./.exec,aj=TypeError,Sl=Ce,XA=Wn,QA=fi,cj=pl,cf=AT,ip=Md,WL=Cu,Rl=La,dj=$i,ZA=Tu,HL=Zi,Wa=Nv,df=bs,uf=Yp,O=Nt,KL=LI,YL=function(t,n,r){return n+(r?Mn(t,n).length:1)},uj=function(t,n){var r=t.exec;if(GL(r)){var a=Q(r,t,n);return a!==null&&Tl(a),a}if(re(t)==="RegExp")return Q(Be,t,n);throw aj("RegExp#exec called on incompatible receiver")},qL=yh,Rr=ze("matchAll"),ei="RegExp String",$A=ei+" Iterator",zL=qL.set,JL=qL.getterFor($A),Le=TypeError,rp=QA("".indexOf),ce=QA("".matchAll),ne=!!ce&&!O(function(){ce("a",/./)}),lj=cj(function(t,n,r,a){zL(this,{type:$A,regexp:t,string:n,global:r,unicode:a,done:!1})},ei,function(){var t=JL(this);if(t.done)return cf(void 0,!0);var n=t.regexp,r=t.string,a=uj(n,r);return a===null?(t.done=!0,cf(void 0,!0)):t.global?(Rl(a[0])===""&&(n.lastIndex=YL(r,WL(n.lastIndex),t.unicode)),cf(a,!1)):(t.done=!0,cf(a,!1))}),Ps=function(t){var n,r,a,d=dj(this),l=Rl(t),p=KL(d,RegExp),E=Rl(df(d));return n=new p(p===RegExp?d.source:d,E),r=!!~rp(E,"g"),a=!!~rp(E,"u"),n.lastIndex=WL(d.lastIndex),new lj(n,l,r,a)};Sl({target:"String",proto:!0,forced:ne},{matchAll:function(t){var n,r,a,d,l=ip(this);if(ZA(t)){if(ne)return ce(l,t)}else{if(Wa(t)&&(n=Rl(ip(df(t))),!~rp(n,"g")))throw Le("`.matchAll` does not allow non-global regexes");if(ne)return ce(l,t);if((a=uf(t,Rr))===void 0&&HL(t)=="RegExp"&&(a=Ps),a)return XA(a,t,l)}return r=Rl(l),d=new RegExp(t,"g"),XA(Ps,d,r)}});var XL=fc("String").matchAll,Cl=le,sp=XL,lf=String.prototype,po=function(t){var n=t.matchAll;return typeof t=="string"||t===lf||Cl(lf,t)&&n===lf.matchAll?sp:n},F_=Rt(po);function B_(t){function n(r,a,d,l){let p=r[l++];if(p==="__proto__")return!0;const E=Number.isFinite(+p),f=l>=r.length;return p=!p&&Ut.isArray(d)?d.length:p,f?(Ut.hasOwnProp(d,p)?d[p]=[d[p],a]:d[p]=a,!E):(d[p]&&Ut.isObject(d[p])||(d[p]=[]),n(r,a,d[p],l)&&Ut.isArray(d[p])&&(d[p]=function(T){const R={},v=Object.keys(T);let y;const w=v.length;let B;for(y=0;y<w;y++)B=v[y],R[B]=T[B];return R}(d[p])),!E)}if(Ut.isFormData(t)&&Ut.isFunction(t.entries)){const r={};return Ut.forEachEntry(t,(a,d)=>{n(function(l){return F_(Ut).call(Ut,/\w+|\[(\w*)]/g,l).map(p=>p[0]==="[]"?"":p[1]||p[0])}(a),d,r,0)}),r}return null}const _o={transitional:yS,adapter:["xhr","http","fetch"],transformRequest:[function(t,n){const r=n.getContentType()||"",a=r.indexOf("application/json")>-1,d=Ut.isObject(t);if(d&&Ut.isHTMLForm(t)&&(t=new FormData(t)),Ut.isFormData(t))return a?JSON.stringify(B_(t)):t;if(Ut.isArrayBuffer(t)||Ut.isBuffer(t)||Ut.isStream(t)||Ut.isFile(t)||Ut.isBlob(t)||Ut.isReadableStream(t))return t;if(Ut.isArrayBufferView(t))return t.buffer;if(Ut.isURLSearchParams(t))return n.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let l;if(d){if(r.indexOf("application/x-www-form-urlencoded")>-1)return function(p,E){return CS(p,new sa.classes.URLSearchParams,Object.assign({visitor:function(f,T,R,v){return sa.isNode&&Ut.isBuffer(f)?(this.append(T,f.toString("base64")),!1):v.defaultVisitor.apply(this,arguments)}},E))}(t,this.formSerializer).toString();if((l=Ut.isFileList(t))||r.indexOf("multipart/form-data")>-1){const p=this.env&&this.env.FormData;return CS(l?{"files[]":t}:t,p&&new p,this.formSerializer)}}return d||a?(n.setContentType("application/json",!1),function(p,E,f){if(Ut.isString(p))try{return(E||JSON.parse)(p),ms(Ut).call(Ut,p)}catch(T){if(T.name!=="SyntaxError")throw T}return(f||JSON.stringify)(p)}(t)):t}],transformResponse:[function(t){const n=this.transitional||_o.transitional,r=n&&n.forcedJSONParsing,a=this.responseType==="json";if(Ut.isResponse(t)||Ut.isReadableStream(t))return t;if(t&&Ut.isString(t)&&(r&&!this.responseType||a)){const d=!(n&&n.silentJSONParsing)&&a;try{return JSON.parse(t)}catch(l){if(d)throw l.name==="SyntaxError"?Pn.from(l,Pn.ERR_BAD_RESPONSE,this,null,this.response):l}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:sa.classes.FormData,Blob:sa.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Ut.forEach(["delete","get","head","post","put","patch"],t=>{_o.headers[t]={}});var ns=_o;const ae=Ut.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Me=Symbol("internals");function Gt(t){var n;return t&&ms(n=String(t)).call(n).toLowerCase()}function ie(t){return t===!1||t==null?t:Ut.isArray(t)?t.map(ie):String(t)}function rd(t,n,r,a,d){return Ut.isFunction(a)?a.call(this,n,r):(d&&(n=r),Ut.isString(n)?Ut.isString(a)?n.indexOf(a)!==-1:Ut.isRegExp(a)?a.test(n):void 0:void 0)}class Re{constructor(n){n&&this.set(n)}set(n,r,a){const d=this;function l(f,T,R){const v=Gt(T);if(!v)throw new Error("header name must be a non-empty string");const y=Ut.findKey(d,v);(!y||d[y]===void 0||R===!0||R===void 0&&d[y]!==!1)&&(d[y||T]=ie(f))}const p=(f,T)=>Ut.forEach(f,(R,v)=>l(R,v,T));if(Ut.isPlainObject(n)||n instanceof this.constructor)p(n,r);else if(Ut.isString(n)&&(n=ms(n).call(n))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(ms(E=n).call(E)))p((f=>{const T={};let R,v,y;return f&&f.split(`
`).forEach(function(w){var B,k;y=w.indexOf(":"),R=ms(B=w.substring(0,y)).call(B).toLowerCase(),v=ms(k=w.substring(y+1)).call(k),!R||T[R]&&ae[R]||(R==="set-cookie"?T[R]?T[R].push(v):T[R]=[v]:T[R]=T[R]?T[R]+", "+v:v)}),T})(n),r);else if(Ut.isHeaders(n))for(const[f,T]of n.entries())l(T,f,a);else n!=null&&l(r,n,a);var E;return this}get(n,r){if(n=Gt(n)){const a=Ut.findKey(this,n);if(a){const d=this[a];if(!r)return d;if(r===!0)return function(l){const p=Object.create(null),E=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let f;for(;f=E.exec(l);)p[f[1]]=f[2];return p}(d);if(Ut.isFunction(r))return r.call(this,d,a);if(Ut.isRegExp(r))return r.exec(d);throw new TypeError("parser must be boolean|regexp|function")}}}has(n,r){if(n=Gt(n)){const a=Ut.findKey(this,n);return!(!a||this[a]===void 0||r&&!rd(0,this[a],a,r))}return!1}delete(n,r){const a=this;let d=!1;function l(p){if(p=Gt(p)){const E=Ut.findKey(a,p);!E||r&&!rd(0,a[E],E,r)||(delete a[E],d=!0)}}return Ut.isArray(n)?n.forEach(l):l(n),d}clear(n){const r=Object.keys(this);let a=r.length,d=!1;for(;a--;){const l=r[a];n&&!rd(0,this[l],l,n,!0)||(delete this[l],d=!0)}return d}normalize(n){const r=this,a={};return Ut.forEach(this,(d,l)=>{var p;const E=Ut.findKey(a,l);if(E)return r[E]=ie(d),void delete r[l];const f=n?function(T){return ms(T).call(T).toLowerCase().replace(/([a-z\d])(\w*)/g,(R,v,y)=>v.toUpperCase()+y)}(l):ms(p=String(l)).call(p);f!==l&&delete r[l],r[f]=ie(d),a[f]=!0}),this}concat(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return this.constructor.concat(this,...r)}toJSON(n){const r=Object.create(null);return Ut.forEach(this,(a,d)=>{a!=null&&a!==!1&&(r[d]=n&&Ut.isArray(a)?a.join(", "):a)}),r}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(n=>{let[r,a]=n;return r+": "+a}).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(n){return n instanceof this?n:new this(n)}static concat(n){const r=new this(n);for(var a=arguments.length,d=new Array(a>1?a-1:0),l=1;l<a;l++)d[l-1]=arguments[l];return d.forEach(p=>r.set(p)),r}static accessor(n){const r=(this[Me]=this[Me]={accessors:{}}).accessors,a=this.prototype;function d(l){const p=Gt(l);r[p]||(function(E,f){const T=Ut.toCamelCase(" "+f);["get","set","has"].forEach(R=>{Object.defineProperty(E,R+T,{value:function(v,y,w){return this[R].call(this,f,v,y,w)},configurable:!0})})}(a,l),r[p]=!0)}return Ut.isArray(n)?n.forEach(d):d(n),this}}Re.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Ut.reduceDescriptors(Re.prototype,(t,n)=>{let{value:r}=t,a=n[0].toUpperCase()+n.slice(1);return{get:()=>r,set(d){this[a]=d}}}),Ut.freezeMethods(Re);var Sc=Re;function is(t,n){const r=this||ns,a=n||r,d=Sc.from(a.headers);let l=a.data;return Ut.forEach(t,function(p){l=p.call(r,l,d.normalize(),n?n.status:void 0)}),d.normalize(),l}function Se(t){return!(!t||!t.__CANCEL__)}function ki(t,n,r){Pn.call(this,t??"canceled",Pn.ERR_CANCELED,n,r),this.name="CanceledError"}function xu(t,n,r){const a=r.config.validateStatus;r.status&&a&&!a(r.status)?n(new Pn("Request failed with status code "+r.status,[Pn.ERR_BAD_REQUEST,Pn.ERR_BAD_RESPONSE][Math.floor(r.status/100)-4],r.config,r.request,r)):t(r)}Ut.inherits(ki,Pn,{__CANCEL__:!0});const aR=function(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,a=0;const d=function(l,p){l=l||10;const E=new Array(l),f=new Array(l);let T,R=0,v=0;return p=p!==void 0?p:1e3,function(y){const w=Date.now(),B=f[v];T||(T=w),E[R]=y,f[R]=w;let k=v,U=0;for(;k!==R;)U+=E[k++],k%=l;if(R=(R+1)%l,R===v&&(v=(v+1)%l),w-T<p)return;const G=B&&w-B;return G?Math.round(1e3*U/G):void 0}}(50,250);return function(l,p){let E,f,T=0,R=1e3/p;const v=function(y){T=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),E=null,f&&(clearTimeout(f),f=null),l.apply(null,y)};return[function(){const y=Date.now(),w=y-T;for(var B=arguments.length,k=new Array(B),U=0;U<B;U++)k[U]=arguments[U];w>=R?v(k,y):(E=k,f||(f=setTimeout(()=>{f=null,v(E)},R-w)))},()=>E&&v(E)]}(l=>{const p=l.loaded,E=l.lengthComputable?l.total:void 0,f=p-a,T=d(f);a=p,t({loaded:p,total:E,progress:E?p/E:void 0,bytes:f,rate:T||void 0,estimated:T&&E&&p<=E?(E-p)/T:void 0,event:l,lengthComputable:E!=null,[n?"download":"upload"]:!0})},r)},QL=(t,n)=>{const r=t!=null;return[a=>n[0]({lengthComputable:r,total:t,loaded:a}),n[1]]},ZL=t=>function(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return Ut.asap(()=>t(...r))};var hj=sa.hasStandardBrowserEnv?function(){const t=sa.navigator&&/(msie|trident)/i.test(sa.navigator.userAgent),n=document.createElement("a");let r;function a(d){let l=d;return t&&(n.setAttribute("href",l),l=n.href),n.setAttribute("href",l),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:n.pathname.charAt(0)==="/"?n.pathname:"/"+n.pathname}}return r=a(window.location.href),function(d){const l=Ut.isString(d)?a(d):d;return l.protocol===r.protocol&&l.host===r.host}}():function(){return!0},pj=sa.hasStandardBrowserEnv?{write(t,n,r,a,d,l){const p=[t+"="+encodeURIComponent(n)];Ut.isNumber(r)&&p.push("expires="+new Date(r).toGMTString()),Ut.isString(a)&&p.push("path="+a),Ut.isString(d)&&p.push("domain="+d),l===!0&&p.push("secure"),document.cookie=p.join("; ")},read(t){const n=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return n?decodeURIComponent(n[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function cR(t,n){return t&&!function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}(n)?function(r,a){return a?r.replace(/\/?\/$/,"")+"/"+a.replace(/^\/+/,""):r}(t,n):n}function $L(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}const Rc=t=>t instanceof Sc?function(n){for(var r=1;r<arguments.length;r++){var a=arguments[r]!=null?arguments[r]:{};r%2?$L(Object(a),!0).forEach(function(d){F(n,d,a[d])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):$L(Object(a)).forEach(function(d){Object.defineProperty(n,d,Object.getOwnPropertyDescriptor(a,d))})}return n}({},t):t;function Tt(t,n){n=n||{};const r={};function a(T,R,v){return Ut.isPlainObject(T)&&Ut.isPlainObject(R)?Ut.merge.call({caseless:v},T,R):Ut.isPlainObject(R)?Ut.merge({},R):Ut.isArray(R)?R.slice():R}function d(T,R,v){return Ut.isUndefined(R)?Ut.isUndefined(T)?void 0:a(void 0,T,v):a(T,R,v)}function l(T,R){if(!Ut.isUndefined(R))return a(void 0,R)}function p(T,R){return Ut.isUndefined(R)?Ut.isUndefined(T)?void 0:a(void 0,T):a(void 0,R)}function E(T,R,v){return v in n?a(T,R):v in t?a(void 0,T):void 0}const f={url:l,method:l,data:l,baseURL:p,transformRequest:p,transformResponse:p,paramsSerializer:p,timeout:p,timeoutMessage:p,withCredentials:p,withXSRFToken:p,adapter:p,responseType:p,xsrfCookieName:p,xsrfHeaderName:p,onUploadProgress:p,onDownloadProgress:p,decompress:p,maxContentLength:p,maxBodyLength:p,beforeRedirect:p,transport:p,httpAgent:p,httpsAgent:p,cancelToken:p,socketPath:p,responseEncoding:p,validateStatus:E,headers:(T,R)=>d(Rc(T),Rc(R),!0)};return Ut.forEach(Object.keys(Object.assign({},t,n)),function(T){const R=f[T]||d,v=R(t[T],n[T],T);Ut.isUndefined(v)&&R!==E||(r[T]=v)}),r}var V=t=>{const n=Tt({},t);let r,{data:a,withXSRFToken:d,xsrfHeaderName:l,xsrfCookieName:p,headers:E,auth:f}=n;if(n.headers=E=Sc.from(E),n.url=IS(cR(n.baseURL,n.url),t.params,t.paramsSerializer),f&&E.set("Authorization","Basic "+btoa((f.username||"")+":"+(f.password?unescape(encodeURIComponent(f.password)):""))),Ut.isFormData(a)){if(sa.hasStandardBrowserEnv||sa.hasStandardBrowserWebWorkerEnv)E.setContentType(void 0);else if((r=E.getContentType())!==!1){const[T,...R]=r?r.split(";").map(v=>ms(v).call(v)).filter(Boolean):[];E.setContentType([T||"multipart/form-data",...R].join("; "))}}if(sa.hasStandardBrowserEnv&&(d&&Ut.isFunction(d)&&(d=d(n)),d||d!==!1&&hj(n.url))){const T=l&&p&&pj.read(p);T&&E.set(l,T)}return n},st=typeof XMLHttpRequest<"u"&&function(t){return new Bt(function(n,r){const a=V(t);let d=a.data;const l=Sc.from(a.headers).normalize();let p,E,f,T,R,{responseType:v,onUploadProgress:y,onDownloadProgress:w}=a;function B(){T&&T(),R&&R(),a.cancelToken&&a.cancelToken.unsubscribe(p),a.signal&&a.signal.removeEventListener("abort",p)}let k=new XMLHttpRequest;function U(){if(!k)return;const W=Sc.from("getAllResponseHeaders"in k&&k.getAllResponseHeaders());xu(function($){n($),B()},function($){r($),B()},{data:v&&v!=="text"&&v!=="json"?k.response:k.responseText,status:k.status,statusText:k.statusText,headers:W,config:t,request:k}),k=null}k.open(a.method.toUpperCase(),a.url,!0),k.timeout=a.timeout,"onloadend"in k?k.onloadend=U:k.onreadystatechange=function(){k&&k.readyState===4&&(k.status!==0||k.responseURL&&k.responseURL.indexOf("file:")===0)&&setTimeout(U)},k.onabort=function(){k&&(r(new Pn("Request aborted",Pn.ECONNABORTED,t,k)),k=null)},k.onerror=function(){r(new Pn("Network Error",Pn.ERR_NETWORK,t,k)),k=null},k.ontimeout=function(){let W=a.timeout?"timeout of "+a.timeout+"ms exceeded":"timeout exceeded";const $=a.transitional||yS;a.timeoutErrorMessage&&(W=a.timeoutErrorMessage),r(new Pn(W,$.clarifyTimeoutError?Pn.ETIMEDOUT:Pn.ECONNABORTED,t,k)),k=null},d===void 0&&l.setContentType(null),"setRequestHeader"in k&&Ut.forEach(l.toJSON(),function(W,$){k.setRequestHeader($,W)}),Ut.isUndefined(a.withCredentials)||(k.withCredentials=!!a.withCredentials),v&&v!=="json"&&(k.responseType=a.responseType),w&&([f,R]=aR(w,!0),k.addEventListener("progress",f)),y&&k.upload&&([E,T]=aR(y),k.upload.addEventListener("progress",E),k.upload.addEventListener("loadend",T)),(a.cancelToken||a.signal)&&(p=W=>{k&&(r(!W||W.type?new ki(null,t,k):W),k.abort(),k=null)},a.cancelToken&&a.cancelToken.subscribe(p),a.signal&&(a.signal.aborted?p():a.signal.addEventListener("abort",p)));const G=function(W){const $=/^([-+\w]{1,25})(:?\/\/|:)/.exec(W);return $&&$[1]||""}(a.url);G&&sa.protocols.indexOf(G)===-1?r(new Pn("Unsupported protocol "+G+":",Pn.ERR_BAD_REQUEST,t)):k.send(d||null)})},tb=(t,n)=>{const{length:r}=t=t?t.filter(Boolean):[];if(n||r){let a,d=new AbortController;const l=function(T){if(!a){a=!0,E();const R=T instanceof Error?T:this.reason;d.abort(R instanceof Pn?R:new ki(R instanceof Error?R.message:R))}};let p=n&&setTimeout(()=>{p=null,l(new Pn("timeout ".concat(n," of ms exceeded"),Pn.ETIMEDOUT))},n);const E=()=>{t&&(p&&clearTimeout(p),p=null,t.forEach(T=>{T.unsubscribe?T.unsubscribe(l):T.removeEventListener("abort",l)}),t=null)};t.forEach(T=>T.addEventListener("abort",l));const{signal:f}=d;return f.unsubscribe=()=>Ut.asap(E),f}},eb=_D,_j=Fd;Ce({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var t=_j.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var nb=Fd,ib=Lh;Ce({target:"Promise",stat:!0,forced:!0},{try:function(t){var n=nb.f(this),r=ib(t);return(r.error?n.reject:n.resolve)(r.value),n.promise}});var rb=Rt(eb),tk=C_.f("asyncIterator"),Cc=Rt(tk);function vl(t,n){this.v=t,this.k=n}function vi(t){var n,r;function a(l,p){try{var E=t[l](p),f=E.value,T=f instanceof vl;rb.resolve(T?f.v:f).then(function(R){if(T){var v=l==="return"?"return":"next";if(!f.k||R.done)return a(v,R);R=t[v](R).value}d(E.done?"return":"normal",R)},function(R){a("throw",R)})}catch(R){d("throw",R)}}function d(l,p){switch(l){case"return":n.resolve({value:p,done:!0});break;case"throw":n.reject(p);break;default:n.resolve({value:p,done:!1})}(n=n.next)?a(n.key,n.arg):r=null}this._invoke=function(l,p){return new rb(function(E,f){var T={key:l,arg:p,resolve:E,reject:f,next:null};r?r=r.next=T:(n=r=T,a(l,p))})},typeof t.return!="function"&&(this.return=void 0)}function oa(t){return function(){return new vi(t.apply(this,arguments))}}function Ae(t){return new vl(t,0)}function aa(t){var n={},r=!1;function a(d,l){return r=!0,{done:!1,value:new vl(l=new rb(function(p){p(t[d](l))}),1)}}return n[ku!==void 0&&tf||"@@iterator"]=function(){return this},n.next=function(d){return r?(r=!1,d):a("next",d)},typeof t.throw=="function"&&(n.throw=function(d){if(r)throw r=!1,d;return a("throw",d)}),typeof t.return=="function"&&(n.return=function(d){return r?(r=!1,d):a("return",d)}),n}vi.prototype[typeof ku=="function"&&Cc||"@@asyncIterator"]=function(){return this},vi.prototype.next=function(t){return this._invoke("next",t)},vi.prototype.throw=function(t){return this._invoke("throw",t)},vi.prototype.return=function(t){return this._invoke("return",t)};var ws=Rt(tk);function Kd(t){var n,r,a,d=2;for(typeof Symbol<"u"&&(r=ws,a=Symbol.iterator);d--;){if(r&&(n=t[r])!=null)return n.call(t);if(a&&(n=t[a])!=null)return new rn(n.call(t));r="@@asyncIterator",a="@@iterator"}throw new TypeError("Object is not async iterable")}function rn(t){function n(r){if(Object(r)!==r)return Bt.reject(new TypeError(r+" is not an object."));var a=r.done;return Bt.resolve(r.value).then(function(d){return{value:d,done:a}})}return rn=function(r){this.s=r,this.n=r.next},rn.prototype={s:null,n:null,next:function(){return n(this.n.apply(this.s,arguments))},return:function(r){var a=this.s.return;return a===void 0?Bt.resolve({value:r,done:!0}):n(a.apply(this.s,arguments))},throw:function(r){var a=this.s.return;return a===void 0?Bt.reject(r):n(a.apply(this.s,arguments))}},new rn(t)}const Ni=function*(t,n){let r=t.byteLength;if(!n||r<n)return void(yield t);let a,d=0;for(;d<r;)a=d+n,yield t.slice(d,a),d=a},op=function(){var t=oa(function*(n,r){var a,d=!1,l=!1;try{for(var p,E=Kd(dr(n));d=!(p=yield Ae(E.next())).done;d=!1){const f=p.value;yield*aa(Kd(Ni(f,r)))}}catch(f){l=!0,a=f}finally{try{d&&E.return!=null&&(yield Ae(E.return()))}finally{if(l)throw a}}});return function(n,r){return t.apply(this,arguments)}}(),dr=function(){var t=oa(function*(n){if(n[ws])return void(yield*aa(Kd(n)));const r=n.getReader();try{for(;;){const{done:a,value:d}=yield Ae(r.read());if(a)break;yield d}}finally{yield Ae(r.cancel())}});return function(n){return t.apply(this,arguments)}}(),hf=(t,n,r,a)=>{const d=op(t,n);let l,p=0,E=f=>{l||(l=!0,a&&a(f))};return new ReadableStream({async pull(f){try{const{done:T,value:R}=await d.next();if(T)return E(),void f.close();let v=R.byteLength;if(r){let y=p+=v;r(y)}f.enqueue(new Uint8Array(R))}catch(T){throw E(T),T}},cancel:f=>(E(f),d.return())},{highWaterMark:2})};function tn(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function sb(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?tn(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):tn(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const pf=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",Ur=pf&&typeof ReadableStream=="function",dR=pf&&(typeof TextEncoder=="function"?(j_=new TextEncoder,t=>j_.encode(t)):async t=>new Uint8Array(await new Response(t).arrayBuffer()));var j_;const ob=function(t){try{for(var n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return!!t(...r)}catch{return!1}},Xt=Ur&&ob(()=>{let t=!1;const n=new Request(sa.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!n}),Wr=Ur&&ob(()=>Ut.isReadableStream(new Response("").body)),ca={stream:Wr&&(t=>t.body)};var yt;pf&&(yt=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!ca[t]&&(ca[t]=Ut.isFunction(yt[t])?n=>n[t]():(n,r)=>{throw new Pn("Response type '".concat(t,"' is not supported"),Pn.ERR_NOT_SUPPORT,r)})}));const En=async(t,n)=>{const r=Ut.toFiniteNumber(t.getContentLength());return r??(async a=>a==null?0:Ut.isBlob(a)?a.size:Ut.isSpecCompliantForm(a)?(await new Request(sa.origin,{method:"POST",body:a}).arrayBuffer()).byteLength:Ut.isArrayBufferView(a)||Ut.isArrayBuffer(a)?a.byteLength:(Ut.isURLSearchParams(a)&&(a+=""),Ut.isString(a)?(await dR(a)).byteLength:void 0))(n)};var _e=pf&&(async t=>{let{url:n,method:r,data:a,signal:d,cancelToken:l,timeout:p,onDownloadProgress:E,onUploadProgress:f,responseType:T,headers:R,withCredentials:v="same-origin",fetchOptions:y}=V(t);T=T?(T+"").toLowerCase():"text";let w,B=tb([d,l&&l.toAbortSignal()],p);const k=B&&B.unsubscribe&&(()=>{B.unsubscribe()});let U;try{if(f&&Xt&&r!=="get"&&r!=="head"&&(U=await En(R,a))!==0){let ot,Et=new Request(n,{method:"POST",body:a,duplex:"half"});if(Ut.isFormData(a)&&(ot=Et.headers.get("content-type"))&&R.setContentType(ot),Et.body){const[vt,Lt]=QL(U,aR(ZL(f)));a=hf(Et.body,65536,vt,Lt)}}Ut.isString(v)||(v=v?"include":"omit");const G="credentials"in Request.prototype;w=new Request(n,sb(sb({},y),{},{signal:B,method:r.toUpperCase(),headers:R.normalize().toJSON(),body:a,duplex:"half",credentials:G?v:void 0}));let W=await fetch(w);const $=Wr&&(T==="stream"||T==="response");if(Wr&&(E||$&&k)){const ot={};["status","statusText","headers"].forEach(wt=>{ot[wt]=W[wt]});const Et=Ut.toFiniteNumber(W.headers.get("content-length")),[vt,Lt]=E&&QL(Et,aR(ZL(E),!0))||[];W=new Response(hf(W.body,65536,vt,()=>{Lt&&Lt(),k&&k()}),ot)}T=T||"text";let rt=await ca[Ut.findKey(ca,T)||"text"](W,t);return!$&&k&&k(),await new Bt((ot,Et)=>{xu(ot,Et,{data:rt,headers:Sc.from(W.headers),status:W.status,statusText:W.statusText,config:t,request:w})})}catch(G){throw k&&k(),G&&G.name==="TypeError"&&/fetch/i.test(G.message)?Object.assign(new Pn("Network Error",Pn.ERR_NETWORK,t,w),{cause:G.cause||G}):Pn.from(G,G&&G.code,t,w)}});const uR={http:null,xhr:st,fetch:_e};Ut.forEach(uR,(t,n)=>{if(t){try{Object.defineProperty(t,"name",{value:n})}catch{}Object.defineProperty(t,"adapterName",{value:n})}});const Mo=t=>"- ".concat(t),da=t=>Ut.isFunction(t)||t===null||t===!1;var ur={getAdapter:t=>{t=Ut.isArray(t)?t:[t];const{length:n}=t;let r,a;const d={};for(let l=0;l<n;l++){let p;if(r=t[l],a=r,!da(r)&&(a=uR[(p=String(r)).toLowerCase()],a===void 0))throw new Pn("Unknown adapter '".concat(p,"'"));if(a)break;d[p||"#"+l]=a}if(!a){const l=Object.entries(d).map(p=>{let[E,f]=p;return"adapter ".concat(E," ")+(f===!1?"is not supported by the environment":"is not available in the build")});throw new Pn("There is no suitable adapter to dispatch the request "+(n?l.length>1?`since :
`+l.map(Mo).join(`
`):" "+Mo(l[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return a},adapters:uR};function vc(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new ki(null,t)}function Mi(t){return vc(t),t.headers=Sc.from(t.headers),t.data=is.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),ur.getAdapter(t.adapter||ns.adapter)(t).then(function(n){return vc(t),n.data=is.call(t,t.transformResponse,n),n.headers=Sc.from(n.headers),n},function(n){return Se(n)||(vc(t),n&&n.response&&(n.response.data=is.call(t,t.transformResponse,n.response),n.response.headers=Sc.from(n.response.headers))),Bt.reject(n)})}const Ha="1.7.7",lR={};["object","boolean","number","function","string","symbol"].forEach((t,n)=>{lR[t]=function(r){return typeof r===t||"a"+(n<1?"n ":" ")+t}});const Eo={};lR.transitional=function(t,n,r){function a(d,l){return"[Axios v"+Ha+"] Transitional option '"+d+"'"+l+(r?". "+r:"")}return(d,l,p)=>{if(t===!1)throw new Pn(a(l," has been removed"+(n?" in "+n:"")),Pn.ERR_DEPRECATED);return n&&!Eo[l]&&(Eo[l]=!0,console.warn(a(l," has been deprecated since v"+n+" and will be removed in the near future"))),!t||t(d,l,p)}};var Uo={assertOptions:function(t,n,r){if(typeof t!="object")throw new Pn("options must be an object",Pn.ERR_BAD_OPTION_VALUE);const a=Object.keys(t);let d=a.length;for(;d-- >0;){const l=a[d],p=n[l];if(p){const E=t[l],f=E===void 0||p(E,l,t);if(f!==!0)throw new Pn("option "+l+" must be "+f,Pn.ERR_BAD_OPTION_VALUE)}else if(r!==!0)throw new Pn("Unknown option "+l,Pn.ERR_BAD_OPTION)}},validators:lR};const xo=Uo.validators;let li=class{constructor(t){this.defaults=t,this.interceptors={request:new pA,response:new pA}}async request(t,n){try{return await this._request(t,n)}catch(r){if(r instanceof Error){let a;Error.captureStackTrace?Error.captureStackTrace(a={}):a=new Error;const d=a.stack?a.stack.replace(/^.+\n/,""):"";try{r.stack?d&&!String(r.stack).endsWith(d.replace(/^.+\n.+\n/,""))&&(r.stack+=`
`+d):r.stack=d}catch{}}throw r}}_request(t,n){typeof t=="string"?(n=n||{}).url=t:n=t||{},n=Tt(this.defaults,n);const{transitional:r,paramsSerializer:a,headers:d}=n;r!==void 0&&Uo.assertOptions(r,{silentJSONParsing:xo.transitional(xo.boolean),forcedJSONParsing:xo.transitional(xo.boolean),clarifyTimeoutError:xo.transitional(xo.boolean)},!1),a!=null&&(Ut.isFunction(a)?n.paramsSerializer={serialize:a}:Uo.assertOptions(a,{encode:xo.function,serialize:xo.function},!0)),n.method=(n.method||this.defaults.method||"get").toLowerCase();let l=d&&Ut.merge(d.common,d[n.method]);d&&Ut.forEach(["delete","get","head","post","put","patch","common"],w=>{delete d[w]}),n.headers=Sc.concat(l,d);const p=[];let E=!0;this.interceptors.request.forEach(function(w){typeof w.runWhen=="function"&&w.runWhen(n)===!1||(E=E&&w.synchronous,p.unshift(w.fulfilled,w.rejected))});const f=[];let T;this.interceptors.response.forEach(function(w){f.push(w.fulfilled,w.rejected)});let R,v=0;if(!E){const w=[Mi.bind(this),void 0];for(w.unshift.apply(w,p),w.push.apply(w,f),R=w.length,T=Bt.resolve(n);v<R;)T=T.then(w[v++],w[v++]);return T}R=p.length;let y=n;for(v=0;v<R;){const w=p[v++],B=p[v++];try{y=w(y)}catch(k){B.call(this,k);break}}try{T=Mi.call(this,y)}catch(w){return Bt.reject(w)}for(v=0,R=f.length;v<R;)T=T.then(f[v++],f[v++]);return T}getUri(t){return IS(cR((t=Tt(this.defaults,t)).baseURL,t.url),t.params,t.paramsSerializer)}};Ut.forEach(["delete","get","head","options"],function(t){li.prototype[t]=function(n,r){return this.request(Tt(r||{},{method:t,url:n,data:(r||{}).data}))}}),Ut.forEach(["post","put","patch"],function(t){function n(r){return function(a,d,l){return this.request(Tt(l||{},{method:t,headers:r?{"Content-Type":"multipart/form-data"}:{},url:a,data:d}))}}li.prototype[t]=n(),li.prototype[t+"Form"]=n(!0)});var sd=li;class Ic{constructor(n){if(typeof n!="function")throw new TypeError("executor must be a function.");let r;this.promise=new Bt(function(d){r=d});const a=this;this.promise.then(d=>{if(!a._listeners)return;let l=a._listeners.length;for(;l-- >0;)a._listeners[l](d);a._listeners=null}),this.promise.then=d=>{let l;const p=new Bt(E=>{a.subscribe(E),l=E}).then(d);return p.cancel=function(){a.unsubscribe(l)},p},n(function(d,l,p){a.reason||(a.reason=new ki(d,l,p),r(a.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(n){this.reason?n(this.reason):this._listeners?this._listeners.push(n):this._listeners=[n]}unsubscribe(n){if(!this._listeners)return;const r=this._listeners.indexOf(n);r!==-1&&this._listeners.splice(r,1)}toAbortSignal(){const n=new AbortController,r=a=>{n.abort(a)};return this.subscribe(r),n.signal.unsubscribe=()=>this.unsubscribe(r),n.signal}static source(){let n;return{token:new Ic(function(r){n=r}),cancel:n}}}var ek=Ic;const _f={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(_f).forEach(t=>{let[n,r]=t;_f[r]=n});var nk=_f;const Hr=function t(n){const r=new sd(n),a=iA(sd.prototype.request,r);return Ut.extend(a,sd.prototype,r,{allOwnKeys:!0}),Ut.extend(a,r,null,{allOwnKeys:!0}),a.create=function(d){return t(Tt(n,d))},a}(ns);Hr.Axios=sd,Hr.CanceledError=ki,Hr.CancelToken=ek,Hr.isCancel=Se,Hr.VERSION=Ha,Hr.toFormData=CS,Hr.AxiosError=Pn,Hr.Cancel=Hr.CanceledError,Hr.all=function(t){return Bt.all(t)},Hr.spread=function(t){return function(n){return t.apply(null,n)}},Hr.isAxiosError=function(t){return Ut.isObject(t)&&t.isAxiosError===!0},Hr.mergeConfig=Tt,Hr.AxiosHeaders=Sc,Hr.formToJSON=t=>B_(Ut.isHTMLForm(t)?new FormData(t):t),Hr.getAdapter=ur.getAdapter,Hr.HttpStatusCode=nk,Hr.default=Hr;var Xs=Hr;const hR=()=>{};function Ef(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:hR};return t.promise=new Bt((n,r)=>{t.resolve=a=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,n(a),t.value=a)},t.reject=a=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,r(a))}}),t}const Yd=new Map,mf=new Map,yc=new Map;let Cr=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),mn=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({});const ik=new oB;let od=ik.getResult(),ab=null;function en(t){if(!ab){od=ik.getResult();const n=function(E){if(E.engine.name==="Blink"&&E.browser.name!=="WeChat")return mn.CHROME;switch(E.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return mn.CHROME;case"Safari":case"Mobile Safari":return mn.SAFARI;case"Edge":return mn.EDGE;case"Firefox":return mn.FIREFOX;case"QQ":case"QQBrowser":return mn.QQ;case"Opera":return mn.OPERA;case"WeChat":return mn.WECHAT;default:return E.browser.name||""}}(od),r=rk(od),a=function(E){return E.os.name==="Windows"?E.os.version?E.os.name+" "+E.os.version:E.os.name:E.os.name||""}(od),d=od.os.version,l=rk(od,!1),p=od.device.type;if(!(n&&r&&a&&d))return{name:n,version:r,os:a,osVersion:d,browserVersion:l,deviceType:p};ab={name:n,version:r,os:a,osVersion:d,browserVersion:l,deviceType:p}}return ab}function rk(t){let n,r=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return n=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",r?n.split(".")[0]:n}function pR(){return en().os}function cb(){const t=en();return"".concat(t.os," ").concat(t.osVersion)}function ff(){const t=en();return!!(od.engine.name==="WebKit"&&t.os===Cr.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==mn.SAFARI||Ys()&&t.name!==mn.SAFARI)}function Ac(){return en().name===mn.CHROME}function vr(){return en().name===mn.SAFARI}function db(){return en().name===mn.EDGE}function Ii(){return en().name===mn.FIREFOX}function Ys(){return en().os===Cr.IOS}function ub(t){const n=en();return!(n.name!==mn.CHROME||!n.osVersion)&&Number(n.version)>=t}function _R(t){const n=en();return!(n.name!==mn.CHROME||!n.osVersion)&&Number(n.version)<t}function lb(t){const n=en();return!(n.name!==mn.EDGE||!n.osVersion)&&Number(n.version)>=t}function sk(t){const n=en();return!(n.name!==mn.SAFARI||!n.osVersion)&&Number(n.version)>=t}function ok(t,n,r){const a=en();if(a.os!==Cr.IOS||!a.osVersion)return!1;const d=a.osVersion.split(".");return n&&Number(d[0])===t&&Number(d[1])<n||Number(d[0])<t}function ak(t,n,r){const a=en();if(a.name!==mn.SAFARI||!a.osVersion||!a.browserVersion)return!1;const d=a.browserVersion.split(".");return r?n&&Number(d[0])===t&&Number(d[1])<n||Number(d[0])<t:n?Number(d[0])===t&&Number(d[1])<=n||Number(d[0])<t:Number(d[0])<=t}function ck(t){const n=en();return!(n.name!==mn.OPERA||!n.osVersion)&&Number(n.version)>=t}function dk(){const t=en();if(t.os!==Cr.IOS||!t.osVersion)return!1;const n=t.osVersion.split(".");return Number(n[0])<14||Number(n[0])===14&&Number(n[1])<=6}function G_(){const t=en();if(t.os!==Cr.IOS||!t.osVersion)return!1;const n=t.osVersion.split(".");return Number(n[0])===15}function ER(){const t=en();if(t.os!==Cr.IOS||!t.osVersion)return!1;const n=t.osVersion.split(".");return Number(n[0])===16}function uk(){const t=en();if(t.os!==Cr.IOS||!t.osVersion)return!1;const n=t.osVersion.split(".");return Number(n[0])===15&&Number(n[1])>=1}function hi(){return vr()&&navigator.maxTouchPoints>0}function ua(){return en().name===mn.WECHAT}function lk(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function hb(){const t=pR();return function(){const{deviceType:n}=en();return n==="mobile"||n==="tablet"}()||t===Cr.ANDROID||t===Cr.IOS||t===Cr.HARMONY_OS}function Il(){const t=en();return t.name!==mn.EDGE&&t.name!==mn.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function W_(){return pR()===Cr.ANDROID}function ap(){const t=en();return W_()&&(t.name===mn.CHROME||t.name===mn.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function $n(t,n,r){return(n=function(a){var d=function(l,p){if(typeof l!="object"||!l)return l;var E=l[Symbol.toPrimitive];if(E!==void 0){var f=E.call(l,"string");if(typeof f!="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}(a);return typeof d=="symbol"?d:d+""}(n))in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}function gf(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function qt(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?gf(Object(r),!0).forEach(function(a){$n(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):gf(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let H=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({}),_t=class extends Error{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",r=arguments.length>2?arguments[2]:void 0;super(n),$n(this,"code",void 0),$n(this,"message",void 0),$n(this,"data",void 0),$n(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(n),this.data=r}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",n=arguments.length>1?arguments[1]:void 0;return t==="error"&&(n||console).error(this.toString()),t==="warning"&&(n||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function qd(t,n){if(typeof t!="boolean")throw new _t(H.INVALID_PARAMS,"Invalid ".concat(n,": The value is of the boolean type."))}function lr(t,n,r){if(!Mt(r).call(r,t))throw new _t(H.INVALID_PARAMS,"".concat(n," can only be set as ").concat(JSON.stringify(r)))}function yn(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<r||t>a||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(d){return typeof d=="number"&&d%1==0}(t))throw new _t(H.INVALID_PARAMS,"invalid ".concat(n,": the value range is [").concat(r,", ").concat(a,"]. integer only"))}function pb(t,n){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new _t(H.INVALID_PARAMS,"".concat(n," is not a valid ConstrainLong"));t.min!==void 0&&yn(t.min,"".concat(n,".min"),0,1/0),t.max!==void 0&&yn(t.max,"".concat(n,".max"),1,1/0),t.exact!==void 0&&yn(t.exact,"".concat(n,".exact"),1,1/0),t.ideal!==void 0&&yn(t.ideal,"".concat(n,".ideal"),1,1/0)}else yn(t,n,1,1/0)}function Nr(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,d=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new _t(H.INVALID_PARAMS,"".concat(n||"param"," cannot be empty"));if(!hk(t,r,a,d))throw new _t(H.INVALID_PARAMS,"Invalid ".concat(n||"string param",": Length of the string: [").concat(r,",").concat(a,"].").concat(d?" ASCII characters only.":""))}function mo(t,n){if(!Array.isArray(t))throw new _t(H.INVALID_PARAMS,"".concat(n," should be an array"))}function Ti(t){return t==null}function hk(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,a=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=r&&t.length>=n&&(!a||function(d){if(typeof d!="string")return!1;for(let l=0;l<d.length;l+=1){const p=d.charCodeAt(l);if(p<0||p>255)return!1}return!0}(t))}var Tf=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(Tf||{}),mR=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(mR||{});const zd=new class{constructor(){$n(this,"_clientSize",null),$n(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),$n(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),$n(this,"getStyle",t=>window.getComputedStyle(t,null)),$n(this,"checkCssVisibleProperty",t=>{var n;let r=!0;const a=this.getStyle(t),{display:d,visibility:l,opacity:p,filter:E}=a;return(d==="none"||Mt(n=["hidden","collapse"]).call(n,l)||Number(p)<.1)&&(r=!1),!!r&&(E&&E.split(" ").filter(f=>{var T;const R=f.split("(")[0];return Mt(T=["brightness","blur","opacity"]).call(T,R)}).map(f=>{const[T,R]=f.split(/\(|\)/);return[T,Number(R.match(/^[0-9\.]+/))]}).forEach(f=>{const[T,R]=f;switch(T){case"brightness":(R<.1||R>3)&&(r=!1);break;case"blur":R>3&&(r=!1);break;case"opacity":R<.1&&(r=!1)}}),r)}),$n(this,"checkPropertyUpToAllParentNodes",(t,n)=>{let r=!0,a=!0;const d=p=>n(p);let l=t;for(;l&&a;)d(l)||(r=!1,a=!1),l=l.parentElement,l||(a=!1);return r}),$n(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),$n(this,"getSizeAboutClient",t=>{const{width:n,height:r,left:a,right:d,top:l,bottom:p}=t.getBoundingClientRect(),E=this.getClientWidth(),f=this.getClientHeight();return{width:n,height:r,left:a,right:d,top:l,bottom:p,clientWidth:E,clientHeight:f,clientMin:Math.min(E,f)}}),$n(this,"checkActualSize",()=>{const{width:t,height:n,clientMin:r}=this._clientSize;return this.checkSizeIsVisible(t,n,r)}),$n(this,"elementFromPoint",(t,n)=>document.elementFromPoint?document.elementFromPoint(t,n):null),$n(this,"checkCoverForAPoint",(t,n,r)=>{const a=this.elementFromPoint(t,n);return a!==null&&a!==r}),$n(this,"getPointPositionList",()=>{const{width:t,height:n,left:r,top:a}=this._clientSize,d=t/6,l=n/6,p=[],E=10**6;for(let f=0;f<5;f++)for(let T=0;T<5;T++){const R=(r*E+(f===0?.1:f===4?(d*f*E-1e5)/E:d*f)*E)/E,v=(a*E+(T===0?.1:T===4?(l*T*E-1e5)/E:l*T)*E)/E;p.push({x:R,y:v})}return[...p]}),$n(this,"checkElementCover",t=>this.getPointPositionList().map(n=>this.checkCoverForAPoint(n.x,n.y,t)).filter(n=>!!n).length>6),$n(this,"checkSizeIsVisible",(t,n,r)=>(t>50||r/t<=10)&&(n>50||r/n<=10)),$n(this,"checkSizeOfPartInClient",()=>{const{left:t,right:n,top:r,bottom:a,clientHeight:d,clientWidth:l,clientMin:p}=this._clientSize;let E,f,T,R;if(t<0)E=0;else{if(!(t<l))return!1;E=t}if(n<0)return!1;if(f=n<l?n:l,r<0)T=0;else{if(!(r<d))return!1;T=r}if(a<0)return!1;R=a<d?a:d;const v=f-E,y=R-T;return this.checkSizeIsVisible(v,y,p)}),$n(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),$n(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Tf.COVERED);{const n=this.checkActualSize(),r=this.checkSizeOfPartInClient();return n&&!r?this.returnHiddenResult(Tf.POSITION):n?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Tf.SIZE)}}return this.returnHiddenResult(Tf.STYLE)}return this.returnHiddenResult(mR.UNMOUNTED)}return this.returnHiddenResult(mR.INVALID_HTML_ELEMENT)}),$n(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,n=>n.nodeName.toUpperCase()!=="HTML"?n.parentElement!==null:!!document.documentElement))}};function Vu(t){return new TextEncoder().encode(t)}const _b=function(t,n){const r=new Uint8Array(t.byteLength+n.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(n),t.byteLength),r},fR=async t=>function(n,r){let a="";return new Uint8Array(n).forEach(d=>{a+=d.toString(r).padStart(2,"0")}),a}(await crypto.subtle.digest("SHA-256",Vu(t)),16);class An{constructor(){$n(this,"_events",{}),$n(this,"addListener",this.on)}getListeners(n){return this._events[n]?this._events[n].map(r=>r.listener):[]}on(n,r){this._events[n]||(this._events[n]=[]);const a=this._events[n];this._indexOfListener(a,r)===-1&&a.push({listener:r,once:!1})}once(n,r){this._events[n]||(this._events[n]=[]);const a=this._events[n];this._indexOfListener(a,r)===-1&&a.push({listener:r,once:!0})}off(n,r){if(!this._events[n])return;const a=this._events[n],d=this._indexOfListener(a,r);d!==-1&&a.splice(d,1),this._events[n].length===0&&delete this._events[n]}removeAllListeners(n){n?delete this._events[n]:this._events={}}emit(n){this._events[n]||(this._events[n]=[]);const r=this._events[n].map(p=>p);for(var a=arguments.length,d=new Array(a>1?a-1:0),l=1;l<a;l++)d[l-1]=arguments[l];for(let p=0;p<r.length;p+=1){const E=r[p];E.once&&this.off(n,E.listener),E.listener.apply(this,d||[])}}safeEmit(n){for(var r=arguments.length,a=new Array(r>1?r-1:0),d=1;d<r;d++)a[d-1]=arguments[d];[...this._events[n]||[]].forEach(l=>{l.once&&this.off(n,l.listener);try{l.listener.apply(this,a)}catch(p){console.error("safeEmit event:".concat(n," error ").concat(p==null?void 0:p.toString()))}})}_indexOfListener(n,r){let a=n.length;for(;a--;)if(n[a].listener===r)return a;return-1}}let cp=null;function pk(){if(cp)return cp;if(window.electron)return cp=window.electron;if(!window.require)return null;try{return cp=window.require("electron"),cp}catch{return null}}let Gi=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t}({}),Si=function(t){return t.TRACER="tracer",t}({});function Jd(t){return yn(t.timeout,"config.timeout",0,1e5),yn(t.timeoutFactor,"config.timeoutFactor",0,100,!1),yn(t.maxRetryCount,"config.maxRetryConfig",0,1/0),yn(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let gR=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),Cn=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function TR(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(n=>{if(!n.urls)throw Error()})}catch{return!1}return!0}function Sf(t){return Nr(t.turnServerURL,"turnServerURL"),Nr(t.username,"username"),Nr(t.password,"password"),t.udpport&&yn(t.udpport,"udpport",1,99999,!0),t.forceturn&&qd(t.forceturn,"forceturn"),t.security&&qd(t.security,"security"),t.tcpport&&yn(t.tcpport,"tcpport",1,99999,!0),!0}function Rf(t){return t.level!==void 0&&lr(t.level,"level",[1,2,3]),t.delay!==void 0&&yn(t.delay,"delay",0,3e3,!0),!0}let Ke=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),rs=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),fo=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),yl=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function Kr(t,n){for(var r=arguments.length,a=new Array(r>2?r-2:0),d=2;d<r;d++)a[d-2]=arguments[d];return t.getListeners(n).length===0?Bt.reject(new _t(H.UNEXPECTED_ERROR,"can not emit promise")):new Bt((l,p)=>{t.emit(n,...a,l,p)})}function On(t,n){if(t.getListeners(n).length===0)return Bt.resolve();for(var r=arguments.length,a=new Array(r>2?r-2:0),d=2;d<r;d++)a[d-2]=arguments[d];return Kr(t,n,...a)}function Vo(t,n){if(t.getListeners(n).length===0)return null;for(var r=arguments.length,a=new Array(r>2?r-2:0),d=2;d<r;d++)a[d-2]=arguments[d];return Cf(t,n,...a)}function Cf(t,n){let r=null,a=null;for(var d=arguments.length,l=new Array(d>2?d-2:0),p=2;p<d;p++)l[p-2]=arguments[p];if(t.emit(n,...l,E=>{r=E},E=>{a=E}),a!==null)throw a;if(r===null)throw new _t(H.UNEXPECTED_ERROR,"handler is not sync");return r}const Ui=new class extends An{set networkState(t){this.emit(yl.NETWORK_STATE_CHANGE,t,this._networkState),t===fo.ONLINE?this.emit(yl.ONLINE):t===fo.OFFLINE&&(this.onlineWaiter=new Bt(n=>{this.once(yl.ONLINE,()=>{this.onlineWaiter=void 0,n(fo.ONLINE)})}),this.emit(yl.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===fo.ONLINE}constructor(){super(),$n(this,"_moduleName","network-indicator"),$n(this,"_networkState",fo.ONLINE),$n(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=fo.ONLINE}),window.addEventListener("offline",()=>{this.networkState=fo.OFFLINE})}};function vf(t,n){const r=t.indexOf(n);r!==-1&&t.splice(r,1)}function dp(t){const n=[];return t.forEach(r=>{n.indexOf(r)===-1&&n.push(r)}),n}function If(t){Bt!==void 0?Bt.resolve().then(t):setTimeout(t,0)}function xi(t){return JSON.parse(JSON.stringify(t))}function up(t){try{return xi(t)}catch{return t}}const Eb={};function Al(t,n){Eb[n]||(Eb[n]=!0,t())}function bc(t){const n=window.atob(t),r=new Uint8Array(new ArrayBuffer(n.length));for(let a=0;a<n.length;a+=1)r[a]=n.charCodeAt(a);return r}function Ka(t){let n="";for(let r=0;r<t.length;r+=1)n+=String.fromCharCode(t[r]);return window.btoa(n)}function H_(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,r=new TextEncoder().encode(t);if(r.length>n)r=r.slice(0,n);else if(r.length<n){const a=new Uint8Array(n);a.set(r),r=a}return r}function SR(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const a=ka(n).call(n,(p,E)=>p+E.length,0),d=new Uint8Array(new ArrayBuffer(a));let l=0;return n.forEach(p=>{d.set(p,l),l+=p.length}),d}function ad(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function mb(t){let n=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(r=>{n+=typeof r=="string"?ad(r):r.size}),n+138}function Ej(t){const n=new _t(H.TIMEOUT,"timeout");return new Bt((r,a)=>{window.setTimeout(()=>a(n),t)})}function xr(t){return new Bt(n=>{window.setTimeout(n,t)})}function Vn(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,n=arguments.length>1?arguments[1]:void 0;const r=Math.random().toString(16).substr(2,t).toLowerCase();return r.length===t?"".concat(n).concat(r):"".concat(n).concat(r)+Vn(t-r.length,"")}function K_(){return Vn(32,"").toUpperCase()}const RR=()=>{},fb=new class{constructor(){$n(this,"fnMap",new Map)}throttleByKey(t,n,r,a){for(var d=arguments.length,l=new Array(d>4?d-4:0),p=4;p<d;p++)l[p-4]=arguments[p];if(this.fnMap.has(n)){const E=this.fnMap.get(n);if(E.threshold!==r){E.fn(...E.args),clearTimeout(E.timer);const f=window.setTimeout(()=>{const T=this.fnMap.get(n);T&&T.fn(...T.args),this.fnMap.delete(n)},r);this.fnMap.set(n,{fn:t,threshold:r,timer:f,args:l,skipFn:a})}else E.skipFn&&E.skipFn(...E.args),this.fnMap.set(n,qt(qt({},E),{},{fn:t,args:l,skipFn:a}))}else{const E=window.setTimeout(()=>{const f=this.fnMap.get(n);f&&f.fn(...f.args),this.fnMap.delete(n)},r);this.fnMap.set(n,{fn:t,threshold:r,timer:E,args:l,skipFn:a})}}},gb=fb.throttleByKey.bind(fb);function _k(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function ss(t,n){if(!_k(t)||!_k(n)||Array.isArray(t)&&!Array.isArray(n)||!Array.isArray(t)&&Array.isArray(n))return n;if(Array.isArray(n)&&Array.isArray(t)){const r=[...t];for(let a=0;a<n.length;a++)r[a]=ss(t[a],n[a]);return r}{const r=qt({},t);for(const a in n)Object.prototype.hasOwnProperty.call(n,a)&&(Object.prototype.hasOwnProperty.call(t,a)?r[a]=ss(t[a],n[a]):r[a]=n[a]);return r}}function sn(t,n){let r=[0];if(r=new Array(n).fill(0),t===0)return r;let a=0;for(;t>0&&(r[a]=255&t,t>>=8,a++,a!==n););return r}function hr(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function lp(t){const n="0123456789abcdef";function r($){let rt,ot="";for(rt=0;rt<=3;rt++)ot+=n.charAt($>>8*rt+4&15)+n.charAt($>>8*rt&15);return ot}function a($,rt){const ot=(65535&$)+(65535&rt);return($>>16)+(rt>>16)+(ot>>16)<<16|65535&ot}function d($,rt,ot,Et,vt,Lt){return a(function(wt,$t){return wt<<$t|wt>>>32-$t}(a(a(rt,$),a(Et,Lt)),vt),ot)}function l($,rt,ot,Et,vt,Lt,wt){return d(rt&ot|~rt&Et,$,rt,vt,Lt,wt)}function p($,rt,ot,Et,vt,Lt,wt){return d(rt&Et|ot&~Et,$,rt,vt,Lt,wt)}function E($,rt,ot,Et,vt,Lt,wt){return d(rt^ot^Et,$,rt,vt,Lt,wt)}function f($,rt,ot,Et,vt,Lt,wt){return d(ot^(rt|~Et),$,rt,vt,Lt,wt)}const T=function($){let rt;const ot=1+($.length+8>>6),Et=new Array(16*ot);for(rt=0;rt<16*ot;rt++)Et[rt]=0;for(rt=0;rt<$.length;rt++)Et[rt>>2]|=$.charCodeAt(rt)<<rt%4*8;return Et[rt>>2]|=128<<rt%4*8,Et[16*ot-2]=8*$.length,Et}(t);let R,v,y,w,B,k=1732584193,U=-271733879,G=-1732584194,W=271733878;for(R=0;R<T.length;R+=16)v=k,y=U,w=G,B=W,k=l(k,U,G,W,T[R+0],7,-680876936),W=l(W,k,U,G,T[R+1],12,-389564586),G=l(G,W,k,U,T[R+2],17,606105819),U=l(U,G,W,k,T[R+3],22,-1044525330),k=l(k,U,G,W,T[R+4],7,-176418897),W=l(W,k,U,G,T[R+5],12,1200080426),G=l(G,W,k,U,T[R+6],17,-1473231341),U=l(U,G,W,k,T[R+7],22,-45705983),k=l(k,U,G,W,T[R+8],7,1770035416),W=l(W,k,U,G,T[R+9],12,-1958414417),G=l(G,W,k,U,T[R+10],17,-42063),U=l(U,G,W,k,T[R+11],22,-1990404162),k=l(k,U,G,W,T[R+12],7,1804603682),W=l(W,k,U,G,T[R+13],12,-40341101),G=l(G,W,k,U,T[R+14],17,-1502002290),U=l(U,G,W,k,T[R+15],22,1236535329),k=p(k,U,G,W,T[R+1],5,-165796510),W=p(W,k,U,G,T[R+6],9,-1069501632),G=p(G,W,k,U,T[R+11],14,643717713),U=p(U,G,W,k,T[R+0],20,-373897302),k=p(k,U,G,W,T[R+5],5,-701558691),W=p(W,k,U,G,T[R+10],9,38016083),G=p(G,W,k,U,T[R+15],14,-660478335),U=p(U,G,W,k,T[R+4],20,-405537848),k=p(k,U,G,W,T[R+9],5,568446438),W=p(W,k,U,G,T[R+14],9,-1019803690),G=p(G,W,k,U,T[R+3],14,-187363961),U=p(U,G,W,k,T[R+8],20,1163531501),k=p(k,U,G,W,T[R+13],5,-1444681467),W=p(W,k,U,G,T[R+2],9,-51403784),G=p(G,W,k,U,T[R+7],14,1735328473),U=p(U,G,W,k,T[R+12],20,-1926607734),k=E(k,U,G,W,T[R+5],4,-378558),W=E(W,k,U,G,T[R+8],11,-2022574463),G=E(G,W,k,U,T[R+11],16,1839030562),U=E(U,G,W,k,T[R+14],23,-35309556),k=E(k,U,G,W,T[R+1],4,-1530992060),W=E(W,k,U,G,T[R+4],11,1272893353),G=E(G,W,k,U,T[R+7],16,-155497632),U=E(U,G,W,k,T[R+10],23,-1094730640),k=E(k,U,G,W,T[R+13],4,681279174),W=E(W,k,U,G,T[R+0],11,-358537222),G=E(G,W,k,U,T[R+3],16,-722521979),U=E(U,G,W,k,T[R+6],23,76029189),k=E(k,U,G,W,T[R+9],4,-640364487),W=E(W,k,U,G,T[R+12],11,-421815835),G=E(G,W,k,U,T[R+15],16,530742520),U=E(U,G,W,k,T[R+2],23,-995338651),k=f(k,U,G,W,T[R+0],6,-198630844),W=f(W,k,U,G,T[R+7],10,1126891415),G=f(G,W,k,U,T[R+14],15,-1416354905),U=f(U,G,W,k,T[R+5],21,-57434055),k=f(k,U,G,W,T[R+12],6,1700485571),W=f(W,k,U,G,T[R+3],10,-1894986606),G=f(G,W,k,U,T[R+10],15,-1051523),U=f(U,G,W,k,T[R+1],21,-2054922799),k=f(k,U,G,W,T[R+8],6,1873313359),W=f(W,k,U,G,T[R+15],10,-30611744),G=f(G,W,k,U,T[R+6],15,-1560198380),U=f(U,G,W,k,T[R+13],21,1309151649),k=f(k,U,G,W,T[R+4],6,-145523070),W=f(W,k,U,G,T[R+11],10,-1120210379),G=f(G,W,k,U,T[R+2],15,718787259),U=f(U,G,W,k,T[R+9],21,-343485551),k=a(k,v),U=a(U,y),G=a(G,w),W=a(W,B);return r(k)+r(U)+r(G)+r(W)}let Ze=1,Ya=console,Yr=class{static setLogger(t){Ya=t}constructor(t,n){$n(this,"id",void 0),$n(this,"lockingPromise",Bt.resolve()),$n(this,"locks",0),$n(this,"name",""),$n(this,"lockId",void 0),this.lockId=Ze++,t&&(this.name=t),n&&(this.id=n),this.logger("created")}logger(t,n){const r=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),a=t==="created"?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(n??"");Ya.debug("".concat(r," ").concat(a))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let n;this.locks+=1,this.logger("locked",t);const r=new Bt(d=>{n=()=>{this.locks-=1,this.logger("unlocked",t),d()}}),a=this.lockingPromise.then(()=>n);return this.lockingPromise=this.lockingPromise.then(()=>r),a}};function Y_(t,n){return function(r,a,d){const l=d.value;if(typeof l!="function")throw new Error("Cannot use mutex on object property.");return d.value=async function(){const p=this[n];if(!p)throw new Error("mutex property key ".concat(n," doesn't exist on ").concat(t));const E=await p.lock("From ".concat(t,".").concat(a));try{for(var f=arguments.length,T=new Array(f),R=0;R<f;R++)T[R]=arguments[R];return await l.apply(this,T)}finally{E()}},d}}const Vi={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Tb(t,n){const r=Math.floor(n.timeout*Math.pow(n.timeoutFactor,t));return Math.min(n.maxRetryTimeout,r)}function cd(t,n,r,a){const d=Object.assign({},Vi,a);let l=d.timeout;const p=async()=>{await function(T){return new Bt(R=>{window.setTimeout(R,T)})}(l),l*=d.timeoutFactor,l=Math.min(d.maxRetryTimeout,l)};let E=!1;const f=new Bt(async(T,R)=>{n=n||(()=>!1),r=r||(()=>!0);for(let v=0;v<d.maxRetryCount;v+=1){if(E)return R(new _t(H.OPERATION_ABORTED));try{const y=await t();if(!n(y,v)||v+1===d.maxRetryCount)return T(y);await p()}catch(y){if(!r(y,v)||v+1===d.maxRetryCount)return R(y);await p()}}});return f.cancel=()=>E=!0,f}class dd{constructor(n){$n(this,"input",[]),$n(this,"size",void 0),this.size=n}add(n){this.input.push(n),this.input.length>this.size&&this.input.splice(0,1)}mean(){var n;return this.input.length===0?0:ka(n=this.input).call(n,(r,a)=>r+a)/this.input.length}}let q_,hp=0,Sb=0;function z_(t,n,r,a){return new Bt((d,l)=>{n.responseType=n.responseType||"json",n.data&&!r?(n.data=JSON.stringify(n.data),hp+=ad(n.data)):r&&(n.data.size?hp+=n.data.size:n.data instanceof FormData?hp+=mb(n.data):hp+=ad(JSON.stringify(n.data))),n.headers=n.headers||{},n.headers["Content-Type"]=n.headers["Content-Type"]||"application/json",n.method="POST",n.url=t,Xs.request(n).then(p=>{typeof p.data=="string"?Sb+=ad(p.data):p.data instanceof ArrayBuffer||p.data instanceof Uint8Array?Sb+=p.data.byteLength:Sb+=ad(JSON.stringify(p.data)),d(p.data)}).catch(p=>{Xs.isCancel(p)?l(new _t(H.OPERATION_ABORTED,"cancel token canceled")):p.code==="ECONNABORTED"?l(new _t(H.NETWORK_TIMEOUT,p.message)):p.response?l(new _t(H.NETWORK_RESPONSE_ERROR,p.response.status)):l(new _t(H.NETWORK_ERROR,p.message))})})}async function J_(t,n){const r=new Blob([n.data],{type:"buffer"});return await z_(t,qt(qt({},n),{},{data:r,headers:{"Content-Type":"application/octet-stream"}}),!0)}const Rb=()=>window.isSecureContext!==void 0,Vt=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const n=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(n&&n[1]&&n[2]){const r=n[1],a=n[2];return"".concat(r,".").concat(a)}return"4.0.0.999"}("4.22.2"),Fn=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let la=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({});const Vr=function(){const t="us".concat("erna","me"),n="pa".concat("sswo","rd"),r=["t","s","t"];r.splice(1,0,"e");const a=r.join(""),d=[];for(let E=0;E<6;E++)d.push("1");const l=d.join(""),p={};return p[t]=a,p[n]=l,Object.assign(p,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Vr;const yf={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Xd="v4.22.2-0-g4caa29bb(10/28/2024, 2:37:34 PM)",ni=qt(qt({PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:yf,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0,DISABLE_SCREEN_SHARE_REMB:!1},{ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_DATASTREAM_2:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,ENABLE_PREALLOC_PC:!1,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:2,ENABLE_PRE_SUB:!1,ENABLE_AUT_FEEDBACK:!1}),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"]});function on(t,n,r){var a,d,l;Mt(a=Object.keys(ni)).call(a,t)&&(!r&&Mt(d=Object.keys(Fu)).call(d,t)||(ni[t]=n,t==="ENABLE_VIDEO_SEI"&&n===!0&&(ni.ENABLE_ENCODED_TRANSFORM=!0),t==="USE_NEW_NETWORK_CONFIG"&&n&&(l=!!n,ni.USE_NEW_NETWORK_CONFIG=l,l&&(ni.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],ni.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],ni.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ni.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],ni.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",ni.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",ni.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),t==="ENABLE_PRE_SUB"&&n&&(ni.ENABLE_INSTANT_VIDEO=!0,ni.ENABLE_PREALLOC_PC=!0),t==="ENABLE_SVC"&&n&&(ni.ENABLE_AUT_CC=!0)))}function J(t){return ni[t]}Fn||(ni.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],ni.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],ni.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],ni.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ni.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],ni.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],ni.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",ni.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",ni.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",ni.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",ni.AREAS=["NORTH_AMERICA","OVERSEA"]);const Fu={};var He=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(He||{});class Cb{constructor(n,r,a,d){$n(this,"state",void 0),this.state={codec:n,audioCodec:r,mode:a,clientId:d,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:la.Default}}dispatch(n){this.state=function(r,a){switch(a.type){case He.SET_SESSION_ID:return qt(qt({},r),{},{sessionId:a.sessionId});case He.SET_P2P_ID:return qt(qt({},r),{},{p2pId:a.p2pId});case He.SET_UID:return qt(qt({},r),{},{uid:a.uid});case He.SET_INT_UID:return qt(qt({},r),{},{intUid:a.intUid});case He.SET_PUB_ID:return qt(qt({},r),{},{pubId:a.pubId});case He.KEY_METRIC_CLIENT_CREATED:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{clientCreated:a.metric})});case He.KEY_METRIC_JOIN_START:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{joinStart:a.metric})});case He.AVOID_JOIN_START:return qt(qt({},r),{},{avoidJoinStart:a.avoidJoinStart});case He.KEY_METRIC_JOIN_END:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{joinEnd:a.metric})});case He.KEY_METRIC_REQUEST_AP_START:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{requestAPStart:a.metric})});case He.KEY_METRIC_REQUEST_AP_END:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{requestAPEnd:a.metric})});case He.KEY_METRIC_JOIN_GATEWAY_START:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{joinGatewayStart:a.metric})});case He.KEY_METRIC_JOIN_GATEWAY_END:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{joinGatewayEnd:a.metric})});case He.KEY_METRIC_PEER_CONNECTION_START:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{peerConnectionStart:a.metric})});case He.KEY_METRIC_PEER_CONNECTION_END:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{peerConnectionEnd:a.metric})});case He.KEY_METRIC_DESCRIPTION_START:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{descriptionStart:a.metric})});case He.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{signalChannelOpen:a.metric})});case He.KEY_METRIC_ICE_CONNECTION_END:return qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{iceConnectionEnd:a.metric})});case He.KEY_METRIC_PUBLISH:{const d=r.keyMetrics.publish,l=d.findIndex(p=>p.trackId===a.metric.trackId);return l!==-1?(d[l]=qt(qt({},d[l]),a.metric),qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{publish:[...d]})})):qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{publish:[...r.keyMetrics.publish,a.metric]})})}case He.KEY_METRIC_SUBSCRIBE:{const d=r.keyMetrics.subscribe,l=d.findIndex(p=>p.userId===a.metric.userId&&p.type===a.metric.type);return l!==-1?(d[l]=qt(qt({},d[l]),a.metric),qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{subscribe:[...d]})})):qt(qt({},r),{},{keyMetrics:qt(qt({},r.keyMetrics),{},{subscribe:[...r.keyMetrics.subscribe,a.metric]})})}case He.SET_CLOUD_PROXY_SERVER_MODE:return r.cloudProxyServerMode=a.mode,r;case He.RECORD_JOIN_CHANNEL_SERVICE:return typeof a.index!="number"?r.joinChannelServiceRecords=[...r.joinChannelServiceRecords,a.record]:(r.joinChannelServiceRecords[a.index]=qt(qt({},r.joinChannelServiceRecords[a.index]),a.record),r.joinChannelServiceRecords=[...r.joinChannelServiceRecords]),r;case He.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return r.joinChannelServiceRecords=[],r;case He.RESET_KEY_METRICS:return r.keyMetrics={publish:[],subscribe:[]},r;case He.SET_USE_P2P:return qt(qt({},r),{},{useP2P:a.val});case He.SET_TRANSPORT_TYPE:return qt(qt({},r),{},{p2pTransport:a.val});default:return r}}(this.state,n)}set sessionId(n){this.dispatch({type:He.SET_SESSION_ID,sessionId:n})}get sessionId(){return this.state.sessionId}set codec(n){this.state.codec=n}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(n){this.dispatch({type:He.SET_P2P_ID,p2pId:n})}get p2pId(){return this.state.p2pId}set dcId(n){this.dispatch({type:He.SET_DC_ID,dcId:n})}get dcId(){return this.state.dcId}set uid(n){this.dispatch({type:He.SET_UID,uid:n})}get uid(){return this.state.uid}set intUid(n){this.dispatch({type:He.SET_INT_UID,intUid:n})}get intUid(){return this.state.intUid}set pubId(n){this.dispatch({type:He.SET_PUB_ID,pubId:n})}get pubId(){return this.state.pubId}set cloudProxyServerMode(n){this.dispatch({type:He.SET_CLOUD_PROXY_SERVER_MODE,mode:n})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(n){this.dispatch({type:He.SET_USE_P2P,val:n})}get useP2P(){return this.state.useP2P}set p2pTransport(n){this.dispatch({type:He.SET_TRANSPORT_TYPE,val:n})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:He.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:He.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:He.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:He.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:He.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:He.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:He.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:He.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:He.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:He.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:He.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:He.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(n,r,a,d){this.dispatch({type:He.KEY_METRIC_PUBLISH,metric:qt(qt({trackId:n,type:r},a&&{publishStart:a}),d&&{publishEnd:d})})}subscribe(n,r,a,d,l,p,E){this.dispatch({type:He.KEY_METRIC_SUBSCRIBE,metric:qt(qt(qt(qt(qt({userId:n,type:r},a&&{subscribeStart:a}),d&&{subscribeEnd:d}),l&&{firstFrame:l}),p&&{streamAdded:p}),E&&{firstDecoded:E})})}massSubscribe(n,r,a,d){n.forEach(l=>{this.dispatch({type:He.KEY_METRIC_SUBSCRIBE,metric:qt(qt(qt({userId:l.userId,type:l.type},r&&{subscribeStart:r}),a&&{subscribeEnd:a}),d&&{firstFrame:d})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(n,r){n.service==="gateway"&&Array.isArray(n.urls)&&(n.urls=n.urls.map(a=>a.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof r!="number"?(this.dispatch({type:He.RECORD_JOIN_CHANNEL_SERVICE,record:qt(qt({},n),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(r<0||r>=this.state.joinChannelServiceRecords.length||this.dispatch({type:He.RECORD_JOIN_CHANNEL_SERVICE,record:n,index:r}),r)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:He.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:He.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(n){this.dispatch({type:He.AVOID_JOIN_START,avoidJoinStart:n})}}let Af=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});const Ek=128,mk=96,gs=1e3,Ts=10;let pp=0;function Kn(t,n,r){return(n=function(a){var d=function(l,p){if(typeof l!="object"||!l)return l;var E=l[Symbol.toPrimitive];if(E!==void 0){var f=E.call(l,"string");if(typeof f!="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}(a);return typeof d=="symbol"?d:d+""}(n))in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}function Ss(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Ie(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Ss(Object(r),!0).forEach(function(a){Kn(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Ss(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const CR=new class extends An{constructor(){super(...arguments),Kn(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:n}=t;n[n.length-1]&&n[n.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=n[n.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class X_{constructor(n){Kn(this,"logger",void 0),Kn(this,"prefixLists",[]),this.logger=n}debug(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];this.logger.debug(...this.prefixLists,...r)}info(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];this.logger.info(...this.prefixLists,...r)}warning(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];this.logger.warning(...this.prefixLists,...r)}error(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];this.logger.error(...this.prefixLists,...r)}prefix(n){return this.prefixLists.push(n),this}popPrefix(){return this.prefixLists.pop(),this}}function vR(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function os(){const t=new Date,n=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return n?(n==null?void 0:n[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const ha={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},bf=Date.now(),qs=t=>{for(const n in ha)if(Object.prototype.hasOwnProperty.call(ha,n)&&ha[n]===t)return n;return"DEFAULT"},N=new class{constructor(){Kn(this,"proxyServerURL",void 0),Kn(this,"logLevel",ha.DEBUG),Kn(this,"uploadState","collecting"),Kn(this,"uploadLogWaitingList",[]),Kn(this,"uploadLogUploadingList",[]),Kn(this,"uploadErrorCount",0),Kn(this,"currentLogID",0),Kn(this,"url",void 0),Kn(this,"extLog",(t,n)=>{this.appendLogToWaitingList(t,...n)})}debug(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const a=[ha.DEBUG].concat(n);this.log.apply(this,a)}info(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const a=[ha.INFO].concat(n);this.log.apply(this,a)}warning(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const a=[ha.WARNING].concat(n);this.log.apply(this,a)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const a=[ha.ERROR].concat(n);this.log.apply(this,a)}upload(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const a=[ha.DEBUG].concat(n);this.uploadLog.apply(this,a)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){on("UPLOAD_LOG",!0)}disableLogUpload(){on("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new X_(this).prefix(t)}log(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];if(Date.now()-bf<100)return void setTimeout(()=>{this.log(...n)},Date.now()-bf);const a=Math.max(0,Math.min(4,n[0]));if(n[0]=vR()+" Agora-SDK [".concat(qs(a),"]:"),this.appendLogToWaitingList(a,...n),a<this.logLevel)return;const d=vR()+" %cAgora-SDK [".concat(qs(a),"]:");let l=[];if(!J("USE_NEW_LOG"))switch(a){case ha.DEBUG:l=[d,"color: #64B5F6;"].concat(n.slice(1)),console.log.apply(console,l);break;case ha.INFO:l=[d,"color: #1E88E5; font-weight: bold;"].concat(n.slice(1)),console.log.apply(console,l);break;case ha.WARNING:l=[d,"color: #FB8C00; font-weight: bold;"].concat(n.slice(1)),console.warn.apply(console,l);break;case ha.ERROR:l=[d,"color: #B00020; font-weight: bold;"].concat(n.slice(1)),console.error.apply(console,l)}}uploadLog(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];if(Date.now()-bf<100)return void setTimeout(()=>{this.uploadLog(...n)},Date.now()-bf);const a=Math.max(0,Math.min(4,n[0]));n[0]=vR()+" Agora-SDK [".concat(qs(a),"]:"),this.appendLogToWaitingList(a,...n)}appendLogToWaitingList(t){if(!J("UPLOAD_LOG"))return;for(var n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];Array.isArray(r[0])?r[0][0]=os()+" Agora-SDK [".concat(qs(t),"]:"):r[0]=os()+" Agora-SDK [".concat(qs(t),"]:");let d="";r.forEach(l=>{typeof l=="object"&&(l=JSON.stringify(l)),d+="".concat(l," ")}),this.uploadLogWaitingList.push({payload_str:d,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,n={sdk_version:Vt,process_id:J("PROCESS_ID"),payload:JSON.stringify(t)};return cd(async()=>{const r=await Xs.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(J("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(J("LOG_UPLOAD_SERVER"),"/upload/v1")),n,{responseType:"text"});if(r.data!=="OK"){const a=new Error("unexpected upload log response");throw a.response=r,a}},()=>(this.uploadLogUploadingList=[],!1),r=>{const a={status:-1,message:r.message,errorRange:t.map(d=>d.log_item_id)};return r.response?(a.status=r.response.status,a.data=r.response.data,a.headers=r.response.headers):r.request&&(a.status=r.request.status),CR.reportLogUploadError(a),!0},{timeout:J("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:J("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,J("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),J("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),J("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),J("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var fk;function Q_(t){return Nr(t.reportId,"params.reportId",0,100,!1),Nr(t.category,"params.category",0,100,!1),Nr(t.event,"params.event",0,100,!1),Nr(t.label,"params.label",0,100,!1),yn(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(fk={}).FREE="free",fk.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});const _p={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let Dr=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t}({}),pi=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t}({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let gk=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});function me(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(n,r,a){const d=a.value;if(typeof d=="function"){const l=t.className||n.__className__||(n.constructor.name==="AgoraRTCClient"?"Client":n.constructor.name);a.value=function(){for(var p,E=arguments.length,f=new Array(E),T=0;T<E;T++)f[T]=arguments[T];let R=f;if(t.argsMap)try{R=t.argsMap(this,...f)}catch(y){N.warning(y),R=[]}try{JSON.stringify(R)}catch{N.warning("arguments for method ".concat(l,".").concat(String(r)," not serializable for apiInvoke.")),R=[]}const v=(t.report||ee).reportApiInvoke(this._sessionId||null,{id:this._clientId||((p=this.store)===null||p===void 0?void 0:p.clientId)||this._ID,name:"".concat(l,".").concat(String(r)),options:R,tag:Si.TRACER,reportResult:t.reportResult},t.throttleTime);try{const y=d.apply(this,f);return y instanceof Bt?y.then(w=>(v.onSuccess(t.reportResult&&w),w)).catch(w=>{throw v.onError(w),w}):(v.onSuccess(t.reportResult&&y),y)}catch(y){throw v.onError(y),y}}}return a}}const ee=new class{constructor(){Kn(this,"baseInfoMap",new Map),Kn(this,"proxyServer",void 0),Kn(this,"eventUploadTimer",void 0),Kn(this,"setSessionIdTimer",void 0),Kn(this,"url",void 0),Kn(this,"sids",new Set),Kn(this,"backupUrl",void 0),Kn(this,"_appId",void 0),Kn(this,"keyEventUploadPendingItems",[]),Kn(this,"normalEventUploadPendingItems",[]),Kn(this,"apiInvokeUploadPendingItems",[]),Kn(this,"apiInvokeCount",0),Kn(this,"apiInvokeLoggedCount",0),Kn(this,"ltsList",[]),Kn(this,"lastSendNormalEventTime",Date.now()),Kn(this,"customReportCounterTimer",void 0),Kn(this,"customReportCount",0),Kn(this,"extApiInvoke",async t=>{for(const n of t){const r=Ie(Ie({},n),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Si.TRACER});this.sendApiInvoke(r)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),J("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),J("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t}reportApiInvoke(t,n,r){n.timeout=n.timeout||6e4,n.reportResult=n.reportResult===void 0||n.reportResult;const a=Date.now();this.apiInvokeCount+=1;const d=this.apiInvokeCount,l=!!J("SHOW_REPORT_INVOKER_LOG"),p=!!J("SHOW_REPORT_USER_INVOKER_LOG"),E=l||p&&n.id;E&&(this.apiInvokeLoggedCount+=1);const f=this.apiInvokeLoggedCount;function T(w,B){if(E){let k="[apiInvoke-".concat(f,"]");n.id&&(k+="[".concat(n.id,"]")),n.name&&(k+="[".concat(n.name,"]")),N.info("".concat(k," ").concat(w),w==="start"?n.options:B||"")}}const R=()=>({tag:n.tag,invokeId:d,sid:t,name:n.name,apiInvokeTime:a,options:n.options,states:n.states||null});T("start");let v=!1;xr(n.timeout).then(()=>{v||(this.sendApiInvoke(Ie(Ie({},R()),{},{error:H.API_INVOKE_TIMEOUT,success:!1})),T("timeout"))});const y=new _t(H.UNEXPECTED_ERROR,"".concat(n.name,": this api invoke is end"));return{onSuccess:w=>{const B=()=>{if(v)throw y;return v=!0,this.sendApiInvoke(Ie(Ie({},R()),{},{success:!0},n.reportResult&&{result:w})),T("onSuccess"),w};return r?gb(B,n.name+"Success",r,()=>v=!0):B()},onError:w=>{const B=()=>{if(v)throw w;v=!0,this.sendApiInvoke(Ie(Ie({},R()),{},{success:!1,error:w})),T("onFailure",w.toString())};return r?gb(B,n.name+"Error",r,()=>v=!0):B()}}}sessionInit(t,n){if(this.baseInfoMap.has(t))return;const r=Date.now(),a=this.createBaseInfo(t,r);a.cname=n.cname;const d=Object.assign({},{willUploadConsoleLog:J("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Fn?"global":"oversea",areas:J("AREAS")&&J("AREAS").join(",")},n.extend),{stringUid:l,channelProfile:p,channelMode:E,isABTestSuccess:f,lsid:T,clientRole:R}=n,v=Date.now(),y=Ie(Ie({},a),{},{eventType:Dr.SESSION_INIT,appid:n.appid,browser:navigator.userAgent,buildFormat:n.buildFormat,build:Xd,lts:v,elapse:v-r,extend:JSON.stringify(d),mode:n.mode,process:J("PROCESS_ID"),appType:J("APP_TYPE"),success:!0,version:Vt,stringUid:l,channelProfile:p,channelMode:E,isABTestSuccess:f,lsid:T,clientType:Mt(w=window.navigator.userAgent).call(w,"AgoraWebView")?42:20,clientRole:R,serviceId:J("PROCESS_ID"),extensionID:J("PLUGIN_INFO").join(",")||""});var w;this.send({type:pi.SESSION,data:y},!0)}joinChooseServer(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{eventType:Dr.JOIN_CHOOSE_SERVER,lts:d,eventElapse:n.elapse||d-n.lts,chooseServerAddr:n.csAddr,errorCode:n.ec,elapse:d-r.startTime,success:n.succ,chooseServerAddrList:JSON.stringify(n.serverList),uid:n.uid?parseInt(n.uid):null,cid:n.cid?parseInt(n.cid):null,chooseServerIp:n.csIp||"",opid:n.opid,unilbsServerIds:n.unilbsServerIds,extend:n.extend||void 0,isHttp3:n.isHttp3,corssRegionTagReq:n.corssRegionTagReq||void 0,corssRegionTagRes:n.corssRegionTagRes||void 0});this.send({type:pi.JOIN_CHOOSE_SERVER,data:l},!0)}reqUserAccount(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{eventType:Dr.REQ_USER_ACCOUNT,lts:d,success:n.success,serverAddress:n.serverAddr,stringUid:n.stringUid,uid:n.uid,errorCode:n.errorCode,elapse:n.elapse||d-r.startTime,eventElapse:d-n.lts,extend:JSON.stringify(n.extend)});this.send({type:pi.REQ_USER_ACCOUNT,data:l},!0)}joinGateway(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info;n.vid&&(a.vid=n.vid),a.uid=n.uid,a.cid=n.cid;const d=Date.now(),{firstSuccess:l,avoidJoinStartTime:p}=n,E=d-(l&&p?p:r.startTime),f=Ie(Ie({},a),{},{eventType:Dr.JOIN_GATEWAY,lts:d,gatewayAddr:n.addr,success:n.succ,errorCode:n.ec,errorMsg:n.errorMsg||"",elapse:E,eventElapse:d-n.lts,firstSuccess:l,signalChannel:n.signalChannel,preload:n.preload?1:0});n.succ&&(r.lastJoinSuccessTime=d),this.send({type:pi.JOIN_GATEWAY,data:f},!0)}joinChannelTimeout(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=Date.now(),d=Ie(Ie({},r.info),{},{lts:a,timeout:n,elapse:a-r.startTime});this.send({type:pi.JOIN_CHANNEL_TIMEOUT,data:d},!0)}publish(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{eventType:Dr.PUBLISH,lts:d,eventElapse:n.eventElapse,elapse:d-r.startTime,success:n.succ,errorCode:n.ec,videoName:n.videoName,audioName:n.audioName,screenName:n.screenName,screenshare:n.screenshare,audio:n.audio,video:n.video,p2pid:n.p2pid,publishRequestid:n.publishRequestid});this.send({type:pi.PUBLISH,data:l},!0)}subscribe(t,n,r){const a=this.baseInfoMap.get(t);if(!a)return;const d=a.info,l=Date.now(),p=Ie(Ie({},d),{},{eventType:Dr.SUBSCRIBE,lts:l,eventElapse:n.eventElapse,elapse:l-a.startTime,success:n.succ,errorCode:n.ec,video:n.video,audio:n.audio,subscribeRequestid:n.subscribeRequestid,p2pid:n.p2pid,preSsrc:n.preSsrc?1:0},r&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof n.peerid=="string"?p.peerSuid=n.peerid:p.peer=n.peerid,this.send({type:pi.SUBSCRIBE,data:p},!0)}wsCompressorInit(t){var n;const r=[...na(n=this.baseInfoMap).call(n)],a=r.length?r[0]:"UnableToGetSid",d=this.baseInfoMap.get(a);if(!d)return;const l=d.info,p=Date.now(),E=Ie(Ie({},l),{},{eventType:Dr.WS_COMPRESSOR_INIT,lts:p,eventElapse:t.eventElapse,elapse:p-d.startTime,status:t.status?1:2});this.send({type:pi.WS_COMPRESSOR_INIT,data:E},!0)}firstRemoteVideoDecode(t,n,r,a){const d=this.baseInfoMap.get(t);if(!d)return;const l=d.info,p=Date.now(),E=Ie(Ie(Ie({},l),a),{},{elapse:p-d.startTime,eventType:n,lts:p,firstDecodeFrame:Math.max((a.firstFrame||p)-d.startTime,0),apEnd:Math.max(a.apEnd-d.startTime,0),apStart:Math.max(a.apStart-d.startTime,0),joinGwEnd:Math.max(a.joinGwEnd-d.startTime,0),joinGwStart:Math.max(a.joinGwStart-d.startTime,0),pcEnd:Math.max(a.pcEnd-d.startTime,0),pcStart:Math.max(a.pcStart-d.startTime,0),subscriberEnd:Math.max(a.subscriberEnd-d.startTime,0),subscriberStart:Math.max(a.subscriberStart-d.startTime,0),videoAddNotify:Math.max(a.videoAddNotify-d.startTime,0)});this.send({type:r,data:E},!0)}firstRemoteFrame(t,n,r,a){const d=this.baseInfoMap.get(t);if(!d)return;const l=d.info,p=Date.now(),E=Ie(Ie(Ie({},l),a),{},{elapse:p-d.startTime,eventType:n,lts:p});this.send({type:r,data:E},!0)}pcStats(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie(Ie({},a),n),{},{vid:a.vid===void 0?0:Number(a.vid),elapse:d-r.startTime,eventType:Dr.PC_STATS,lts:d,preallocation:n.preallocation?1:0});this.send({type:pi.PC_STATS,data:l},!0)}updateRemoteRTPCapabilities(t,n){if(t){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie(Ie({},a),n),{},{vid:a.vid===void 0?0:Number(a.vid),eventType:Dr.UPDATE_REMOTE_RTPCAPABILITIES,lts:d});this.send({type:pi.UPDATE_REMOTE_RTPCAPABILITIES,data:l},!0)}}onGatewayStream(t,n,r,a){const d=this.baseInfoMap.get(t);if(!d)return;const l=d.info,p=Date.now(),E=Ie(Ie(Ie({},l),a),{},{eventType:n,lts:p});this.send({type:r,data:E},!0)}streamSwitch(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{eventType:Dr.STREAM_SWITCH,lts:d,isDual:n.isdual,elapse:d-r.startTime,success:n.succ});this.send({type:pi.STREAM_SWITCH,data:l},!0)}requestProxyAppCenter(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{eventType:Dr.REQUEST_PROXY_APPCENTER,lts:d,eventElapse:d-n.lts,elapse:d-r.startTime,APAddr:n.APAddr,workerManagerList:n.workerManagerList,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:pi.REQUEST_PROXY_APPCENTER,data:l},!0)}requestProxyWorkerManager(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{eventType:Dr.REQUEST_PROXY_WORKER_MANAGER,lts:d,eventElapse:d-n.lts,elapse:d-r.startTime,workerManagerAddr:n.workerManagerAddr,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:pi.REQUEST_PROXY_WORKER_MANAGER,data:l},!0)}setProxyServer(t){this.proxyServer=t,t?N.debug("reportProxyServerurl: ".concat(t)):N.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie({},a),{},{subscribeElapse:n.subscribeElapse,peer:n.peer,peerPublishDuration:Math.max(n.audioPublishDuration,n.videoPublishDuration),audiotag:n.audioPublishDuration>0?1:-1,videotag:n.videoPublishDuration>0?1:-1,lts:d,elapse:d-r.startTime,joinChannelSuccessElapse:d-(r.lastJoinSuccessTime||d),peerPublishDurationVideo:n.videoPublishDuration,peerPublishDurationAudio:n.audioPublishDuration});this.send({type:pi.PEER_PUBLISH_STATUS,data:l},!0)}workerEvent(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now();(function(l,p,E){const f=l[p];if(!f||typeof f!="string")return[l];l[p]="";const T=ad(JSON.stringify(l));let R=0;const v=[];let y=0;for(let w=0;w<f.length;w++)y+=f.charCodeAt(w)<=127?1:3,y<=E-T||(v[v.length]=qt(qt({},l),{},{[p]:f.substring(R,w)}),R=w,y=f.charCodeAt(w)<=127?1:3);return R!==f.length-1&&(v[v.length]=qt(qt({},l),{},{[p]:f.substring(R)})),v})(Ie(Ie(Ie({},a),n),{},{elapse:d-r.startTime,lts:d,productType:"WebRTC"}),"payload",1300).forEach(l=>this.send({type:pi.WORKER_EVENT,data:l},!0))}apworkerEvent(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie(Ie({},a),n),{},{elapse:d-r.startTime,lts:d});this.send({type:pi.AP_WORKER_EVENT,data:l},!0)}joinWebProxyAP(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie(Ie({},a),n),{},{elapse:d-r.startTime,lts:d,extend:n.extend||void 0});this.send({type:pi.JOIN_WEB_PROXY_AP,data:l},!0)}WebSocketQuit(t,n){const r=this.baseInfoMap.get(t);if(!r)return;const a=r.info,d=Date.now(),l=Ie(Ie(Ie({},a),n),{},{elapse:d-r.startTime,lts:d});this.send({type:pi.WEBSOCKET_QUIT,data:l},!0)}async sendCustomReportMessage(t,n){if(this.customReportCount+=n.length,this.customReportCount>J("CUSTOM_REPORT_LIMIT"))throw new _t(H.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const r=Date.now(),a=n.map(d=>({type:pi.USER_ANALYTICS,data:Ie(Ie({sid:t},d),{},{lts:r})}));try{J("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(a):await this.postDataToStatsCollector(a)}catch(d){throw N.error("send custom report message failed",d.toString()),new _t(H.CUSTOM_REPORT_SEND_FAILED,d.message)}}sendApiInvoke(t){const n=J("NOT_REPORT_EVENT");if(t.tag&&Mt(n)&&Mt(n).call(n,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const r=this.baseInfoMap.get(t.sid);if(!r)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:a,uid:d,cid:l}=r.info;let p;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof _t){const{code:f,message:T}=t.error;p=f||T||t.error.toString()}else p=t.error.toString();const E={invokeId:t.invokeId,sid:t.sid,cname:a,cid:l,uid:d,lts:t.lts,success:t.success,elapse:t.lts-r.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?p:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:pi.API_INVOKE,data:E},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){const t=this.apiInvokeUploadPendingItems;if(t.length===0)return;const n=Array.from(this.sids).find(r=>r!==null);n&&t.forEach(r=>{r&&(r.sid=n,this.sendApiInvoke(Object.assign({},r)))}),t.length=0}send(t,n){if(n)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>J("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,n){const r=[],a=[];for(;t.length;){const l=t.shift();r.length<20?r.push(l):a.push(l)}t.push(...a);for(const l of[...r]){var d;this.ltsList.indexOf(l.data.lts)!==-1?(l.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(l.data.lts)):(this.ltsList.push(l.data.lts),Vh(d=this.ltsList).call(d,(p,E)=>p-E))}return n||(this.lastSendNormalEventTime=Date.now()),J("ENABLE_EVENT_REPORT")&&r.length&&(J("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(r):this.postDataToStatsCollector(r)).catch((l=>p=>{J("EVENT_REPORT_RETRY")&&(n?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(l):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(l),this.normalEventUploadPendingItems.length>J("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-J("NORMAL_EVENT_QUEUE_CAPACITY")),N.warning("report: drop normal events"))))})(r)),t}async postDataToStatsCollector2(t){Ui.networkState===fo.OFFLINE&&await Bt.race([Ui.onlineWaiter,xr(2*Vi.maxRetryTimeout)]);const n=d=>{let l=new Uint8Array;return d.forEach(p=>{const E=Vu(JSON.stringify(p.data)),f=new ArrayBuffer(5),T=(v=>{let y=0;return Object.entries(pi).forEach(w=>{let[B,k]=w;k===v.type&&(y=gk[B])}),y})(p),R=new DataView(f);R.setUint16(0,E.byteLength,!0),R.setUint8(2,255&T),R.setUint8(3,T>>>8&255),R.setUint8(4,T>>>16&255),l=_b(l,new Uint8Array(f)),l=_b(l,E)}),l},r="event";let a=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(J("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(r):"https://".concat(J("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(r);for(let d=0;d<2;d+=1){d===1&&(a=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(J("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(r):"https://".concat(J("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(r));try{await z_(a,{timeout:1e4,data:n(t),headers:Ie(Ie({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(l){if(d===1)throw l;continue}return}}async postDataToStatsCollector(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(l=>JSON.stringify(l)),vid:(l=>{const p=l&&l.data.sid&&this.baseInfoMap.get(l.data.sid);return p&&p.info.vid&&+p.info.vid||0})(t[0])};Ui.networkState===fo.OFFLINE&&await Bt.race([Ui.onlineWaiter,xr(2*Vi.maxRetryTimeout)]);const a=n?"/events/proto-raws":"/events/messages";let d=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(J("EVENT_REPORT_DOMAIN"),"&p=").concat(J("STATS_COLLECTOR_PORT"),"&d=").concat(a):"https://".concat(J("EVENT_REPORT_DOMAIN"),":").concat(J("STATS_COLLECTOR_PORT")).concat(a));for(let l=0;l<2;l+=1){l===1&&(d=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(J("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(J("STATS_COLLECTOR_PORT"),"&d=").concat(a):"https://".concat(J("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(J("STATS_COLLECTOR_PORT")).concat(a)));try{n?await J_(d,{timeout:1e4,data:r}):await z_(d,{timeout:1e4,data:r})}catch(p){if(l===1)throw p;continue}return}}createBaseInfo(t,n){const r=Object.assign({},_p);return r.sid=t,this.baseInfoMap.set(t,{info:r,startTime:n}),r}reportResourceTiming(t,n){const r=performance.getEntriesByName(t),a=r[r.length-1];a&&this.reportApiInvoke(n,{name:"Client.resourceTiming",options:a,tag:Si.TRACER}).onSuccess()}};CR.on("REPORT_LOG_UPLOAD",t=>{t.networkState=Ui.networkState,ee.reportApiInvoke(null,{name:"logUploadError",options:t,tag:Si.TRACER}).onSuccess("logUploadError")});class lt extends _t{constructor(n){super(n,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Kn(this,"name","AgoraRTCException")}print(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(n,N)}throw(){super.throw(N)}}const mj=["CHINA","GLOBAL"],vb=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],bl=[];function Bu(t,n){return!!n&&bl.some(r=>r.uid===t&&r.channelName===n)}var Tk=YP.forEach,Ib=om("forEach")?[].forEach:function(t){return Tk(this,t,arguments.length>1?arguments[1]:void 0)};Ce({target:"Array",proto:!0,forced:[].forEach!=Ib},{forEach:Ib});var pa=fc("Array").forEach,fj=Es,IR=Zn,Z_=le,_a=pa,wf=Array.prototype,Ea={DOMTokenList:!0,NodeList:!0},Sk=function(t){var n=t.forEach;return t===wf||Z_(wf,t)&&n===wf.forEach||IR(Ea,fj(t))?_a:n},Rk=Rt(Sk),Ck=Ns,yb=uT;Ce({target:"Object",stat:!0,forced:Nt(function(){yb(1)})},{keys:function(t){return yb(Ck(t))}});var vk=Rt($r.Object.keys),Qs=Rt(Mv),Wi=Ce,Ik=T_,yR=Qt([].reverse),Ab=[1,2];Wi({target:"Array",proto:!0,forced:String(Ab)===String(Ab.reverse())},{reverse:function(){return Ik(this)&&(this.length=this.length),yR(this)}});var yk=fc("Array").reverse,Ak=le,bk=yk,Of=Array.prototype,gj=function(t){var n=t.reverse;return t===Of||Ak(Of,t)&&n===Of.reverse?bk:n},bb=gj,wb=Rt(bb),Nn=Ce,wl=T_,Ol=ym,pr=fr,Nf=bv,wk=vu,Tj=$o,Ok=lS,Sj=ze,Ob=LT,Nk=kP("slice"),Dk=Sj("species"),AR=Array,Nb=Math.max;Nn({target:"Array",proto:!0,forced:!Nk},{slice:function(t,n){var r,a,d,l=Tj(this),p=wk(l),E=Nf(t,p),f=Nf(n===void 0?p:n,p);if(wl(l)&&(r=l.constructor,(Ol(r)&&(r===AR||wl(r.prototype))||pr(r)&&(r=r[Dk])===null)&&(r=void 0),r===AR||r===void 0))return Ob(l,E,f);for(a=new(r===void 0?AR:r)(Nb(f-E,0)),d=0;E<f;E++,d++)E in l&&Ok(a,d,l[E]);return a.length=d,a}});var Pk=fc("Array").slice,Lk=le,kk=Pk,Db=Array.prototype,Mk=function(t){var n=t.slice;return t===Db||Lk(Db,t)&&n===Db.slice?kk:n},Uk=Rt(Mk);function jt(t,n,r,a,d){var l,p,E,f={};return Rk(l=vk(a)).call(l,function(T){f[T]=a[T]}),f.enumerable=!!f.enumerable,f.configurable=!!f.configurable,("value"in f||f.initializer)&&(f.writable=!0),f=Qs(p=wb(E=Uk(r).call(r)).call(E)).call(p,function(T,R){return R(t,n,T)||T},f),d&&f.initializer!==void 0&&(f.value=f.initializer?f.initializer.call(d):void 0,f.initializer=void 0),f.initializer===void 0&&(mA(t,n,f),f=null),f}let ke=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),Rs=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({}),Df=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),$_=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),ma=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),Ls=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),de=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),Yn=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),fe=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t}({}),ue=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),qa=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),Ue=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),Os=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),be=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});function Nl(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw N.error("Invalid Channel Name ".concat(t)),new lt(H.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Dl(t){if(!function(n){return typeof n=="number"&&Math.floor(n)===n&&0<=n&&n<=4294967295}(t)&&!hk(t,1,255))throw new lt(H.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");typeof t=="string"&&N.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let ud=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t}({});const bR={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Pb={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function wR(t,n){Nr(t.url,"".concat(n,".url"),1,1e3,!1),Ti(t.x)||yn(t.x,"".concat(n,".x"),0,1e4),Ti(t.y)||yn(t.y,"".concat(n,".y"),0,1e4),Ti(t.width)||yn(t.width,"".concat(n,".width"),0,1e4),Ti(t.height)||yn(t.height,"".concat(n,".height"),0,1e4),Ti(t.zOrder)||yn(t.zOrder,"".concat(n,".zOrder"),0,255),Ti(t.alpha)||yn(t.alpha,"".concat(n,".alpha"),0,1,!1)}const ju={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let wc=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),Ep=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),Fi=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function OR(t){if(!t.channelName)throw new lt(H.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new lt(H.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Nr(t.token,"info.token",1,2047),Dl(t.uid),Nl(t.channelName),!0}let Cs=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),ld=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),Zs=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),mp=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),fn=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),Fr=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t}({}),Pf=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),Ji=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),xe=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({});const hd=[xe.AFRICA,xe.ASIA,xe.CHINA,xe.EUROPE,xe.GLOBAL,xe.INDIA,xe.JAPAN,xe.NORTH_AMERICA,xe.OCEANIA,xe.OVERSEA,xe.SOUTH_AMERICA];let as=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({});const Lf={CHINA:{},ASIA:{CODE:as.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:as.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:as.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:as.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:as.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:as.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:as.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:as.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:as.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:as.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:as.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:as.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:as.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Fn&&(Lf.CHINA={CODE:as.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let NR=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t}({});class Lb extends An{constructor(n,r){super(),F(this,"onICEConnectionStateChange",void 0),F(this,"onConnectionStateChange",void 0),F(this,"onDTLSTransportStateChange",void 0),F(this,"onDTLSTransportError",void 0),F(this,"onICETransportStateChange",void 0),F(this,"onFirstAudioReceived",void 0),F(this,"onFirstVideoReceived",void 0),F(this,"onFirstAudioDecoded",void 0),F(this,"onFirstVideoDecoded",void 0),F(this,"onFirstVideoDecodedTimeout",void 0),F(this,"onSelectedLocalCandidateChanged",void 0),F(this,"onSelectedRemoteCandidateChanged",void 0),F(this,"getLocalVideoStats",void 0)}}class kb extends Lb{constructor(n,r){super(n,r),F(this,"establishPromise",void 0)}}let Kt=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),go=function(t){return t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.RELAY=2]="RELAY",t}({}),pd=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.TCP_RESTART=1]="TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({}),At=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),gn=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),ge=function(t){return t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),za=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Oc=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),Br=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),xk=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t}({}),Qd=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),$s=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),_d=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),qr=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),ai=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),Gu=function(t){return t.ABORT="abort",t}({}),Pl=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),Mb=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({});const Rj={[Df.ACCESS_POINT]:{[Ls.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Ls.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Ls.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Ls.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Ls.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Ls.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Ls.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Df.UNILBS]:{[ma.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ma.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ma.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ma.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ma.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ma.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ma.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ma.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ma.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ma.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ma.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ma.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Df.STRING_UID_ALLOCATOR]:{[$_.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[$_.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[$_.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Ja(t){const n=Rj[Math.floor(t/1e4)];if(!n)return{desc:"unknown error",retry:!1};const r=n[t%1e4];if(!r){if(Math.floor(t/1e4)===Df.ACCESS_POINT){const a=t%1e4;if(a.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(a.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return r}const Cj={[de.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[de.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[de.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[de.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[de.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[de.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[de.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[de.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[de.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[de.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[de.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[de.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[de.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[de.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[de.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[de.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[de.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[de.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[de.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[de.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[de.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[de.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[de.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[de.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[de.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[de.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[de.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[de.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[de.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[de.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[de.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[de.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[de.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[de.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[de.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[de.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[de.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[de.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[de.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[de.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[de.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[de.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[de.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[de.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[de.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[de.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[de.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[de.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[de.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[de.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[de.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[de.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[de.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[de.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[de.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[de.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[de.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[de.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[de.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[de.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[de.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[de.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[de.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Nc(t){return Cj[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function Vk(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Ub(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Vk(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Vk(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}function Xa(t){return t.every(n=>n.readyState===WebSocket.CLOSED||n.readyState===WebSocket.CLOSING)}function xb(t,n){if(typeof t=="string")return t;const{proxy:r,host:a,port:d}=t;if(n){const l=J("JOIN_GATEWAY_FALLBACK_PORT")||443;return l===443?"wss://".concat(a,"/ws/?p=").concat(Number(d)+150):"wss://".concat(a,":").concat(l,"/ws/?p=").concat(Number(d)+150)}return r?"wss://".concat(r,"/ws/?h=").concat(a,"&p=").concat(d):"wss://".concat(a,":").concat(d)}const to=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,Fk=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Zd=/wss:\/\/(.+):([0-9]+)\/?/,vj=/wss:\/\/(.[^\/]+)\/?/;let Vb=0;class Ij{constructor(n,r){F(this,"id",0),F(this,"store",void 0),F(this,"recordIndex",void 0),F(this,"websockets",[]),F(this,"try443PortDuration",2e3),F(this,"forceCloseWSDuration",5e3),F(this,"try443PortTimeout",null),F(this,"forceCloseTimeout",null),F(this,"isTry443PortFailed",!1),F(this,"isNormalPortFailed",!1),F(this,"useDoubleDomain",!1),F(this,"useProxy",!1),F(this,"startTime",Date.now()),this.id=++Vb,this.try443PortDuration=J("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=n||5e3,this.store=r}closeAllWebsockets(){this.websockets.forEach(n=>{n.onopen=null,n.onclose=null,n.onmessage=null,n.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var n;const r=Date.now()-this.startTime;for(var a=arguments.length,d=new Array(a),l=0;l<a;l++)d[l]=arguments[l];N.debug("[choose-best-ws ".concat((n=this.store)===null||n===void 0?void 0:n.clientId," ").concat(this.id,"] ").concat(r,"ms:"),...d)}createWebSocket(n,r,a){this.logger("createWebSocket:",n,{isTry443Port:r,hasTimeoutDetection:a});const d=J("GATEWAY_DOMAINS"),l=Date.now(),p=[],E=d.find(R=>{var v;return Mt(v=n.host).call(v,R)});E||(this.useDoubleDomain=!1);const f=[];if(this.useDoubleDomain)d.forEach(R=>{f.push(xb(Ub(Ub({},n),{},{host:n.host.replace(E,R)}),r))});else{const R=Ub({},n);if(r&&E){const v=d.find(y=>y!==E);v&&(R.host=R.host.replace(E,v))}f.push(xb(R,r))}try{f.forEach(R=>{const v=new WebSocket(R);v.binaryType="arraybuffer",p.push(v),this.logger("ws is connecting:",v.url)})}catch(R){if(this.logger("ws create failed"),p.forEach(v=>v.close()),p.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(n,r,a);if(!r&&Number(n.port)!==443)return this.createWebSocket(n,!0,a);throw new lt(H.WS_ERR,"init websocket failed! Error: ".concat(R.toString()))}const T=Ef();return this.store&&this.store.recordJoinChannelService({urls:p.map(R=>R.url),service:"gateway"},this.recordIndex),p.forEach(R=>{R.onopen=()=>{this.logger("onopen: ws ".concat(R.url," open cost ").concat(Date.now()-l,"ms")),this.websockets.forEach(v=>{v!==R&&(v.onopen=null,v.onclose=null,v.onmessage=null,v.close(),this.logger("close backup websocket: ".concat(v.url)))}),this.websockets.length=0,T.resolve(R)},R.onclose=v=>{this.logger("onclose: ws ".concat(R.url," closed cost ").concat(Date.now()-l,"ms state: ").concat(R.readyState)),r?this.isTry443PortFailed=Xa(p):this.isNormalPortFailed=Xa(p),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(r&&this.isTry443PortFailed||!r&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(v.reason)),T.reject({code:v.code,reason:Pf.A_ROUND_WS_FAILED}))},R.onmessage=v=>this.logger("".concat(R.url," onmessage: ").concat(v.data))}),this.websockets.push(...p),a||(()=>{const R=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",T.isResolved),this.websockets.forEach(v=>v.readyState!==WebSocket.OPEN&&v.close())};if(r||this.useProxy)return this.logger("add 5s timeout at ".concat(r?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(R,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",T.isResolved),T.isResolved)return R();en().os===Cr.MAC_OS&&Ii()&&R(),this.createWebSocket(n,!0,!0).then(v=>T.resolve(v)).catch(v=>{this.isNormalPortFailed&&T.reject(v),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(R,this.forceCloseWSDuration)},this.try443PortDuration)})(),T.promise}chooseBestWebsocket(n,r,a,d){return this.useDoubleDomain=!!r,typeof n=="string"&&(n=function(l){let p,E,f;return[,p,E,f]=l.match(to)||[],p||([,E,f]=l.match(Fk)||[]),E&&f||([,E,f]=l.match(Zd)||[]),E&&f||([,E]=l.match(vj)||[]),E||N.warning("un-destructible url: ",l),{proxy:p,host:E,port:f||"443"}}(n)),this.recordIndex=d,this.useProxy=!!n.proxy,a&&this.useProxy&&(N.warn("cannot use 443 only when use proxy"),a=!1),this.createWebSocket(n,!!a,!1).finally(()=>this.clearTimeout())}}function Bk(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}class kf extends An{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(n){var r;Mt(r=["tryNext","recover"]).call(r,n)&&this.resetReconnectCount(n),this._reconnectMode=n}get state(){return this._state}set state(n){n!==this._state&&(this._state=n,this._state==="reconnecting"?this.emit(be.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(be.CONNECTED):this._state==="closed"?this.emit(be.CLOSED):this._state==="failed"&&this.emit(be.FAILED))}resetReconnectCount(n){N.debug("websocket reset reconnect count, reason: "+n),this.reconnectCount=0}constructor(n,r){let a=arguments.length>2&&arguments[2]!==void 0&&arguments[2],d=arguments.length>3&&arguments[3]!==void 0&&arguments[3],l=arguments.length>4&&arguments[4]!==void 0&&arguments[4],p=arguments.length>5?arguments[5]:void 0;super(),F(this,"connectionID",0),F(this,"currentURLIndex",0),F(this,"urls",[]),F(this,"_reconnectMode","tryNext"),F(this,"reconnectReason",void 0),F(this,"_initMutex",void 0),F(this,"name",void 0),F(this,"_state","closed"),F(this,"reconnectInterrupter",void 0),F(this,"websocket",void 0),F(this,"retryConfig",void 0),F(this,"reconnectCount",0),F(this,"forceCloseTimeout",5e3),F(this,"onlineReconnectListener",void 0),F(this,"useCompress",void 0),F(this,"tryDoubleDomain",!1),F(this,"use443PortOnly",!1),F(this,"wsInflateLength",0),F(this,"wsDeflateLength",0),F(this,"closeEstablishingWs",()=>{}),F(this,"store",void 0),F(this,"joinGatewayRecordIndex",void 0),this.store=p,this.name=n,this.retryConfig=function(v){for(var y=1;y<arguments.length;y++){var w=arguments[y]!=null?arguments[y]:{};y%2?Bk(Object(w),!0).forEach(function(B){F(v,B,w[B])}):Object.getOwnPropertyDescriptors?Object.defineProperties(v,Object.getOwnPropertyDescriptors(w)):Bk(Object(w)).forEach(function(B){Object.defineProperty(v,B,Object.getOwnPropertyDescriptor(w,B))})}return v}({},r),this.useCompress=a,this.tryDoubleDomain=d,this.use443PortOnly=l,this._initMutex=new Yr("websocket",p?p.clientId:void 0);const{timeout:E,timeoutFactor:f}=r,T=Math.max(300,Math.floor(3*E/5)),R=Math.max(1.2,Math.floor(8*f)/10);fo.ONLINE&&(this.retryConfig.timeout=T,this.retryConfig.timeoutFactor=R),Ui.on(yl.NETWORK_STATE_CHANGE,(v,y)=>{v!==y&&(this.resetReconnectCount("network state change: ".concat(y," -> ").concat(v)),v===fo.ONLINE?(this.retryConfig.timeout=T,this.retryConfig.timeoutFactor=R):(this.retryConfig.timeout=E,this.retryConfig.timeoutFactor=f))})}getConnection(){return this.websocket||void 0}async init(n){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const a=await this._initMutex.lock();this.forceCloseTimeout=r,this.urls=n,this.state="connecting";try{const d=Ef(),l=this.urls[this.currentURLIndex];J("ENABLE_PREALLOC_PC")&&this.emit(xk.PRE_CONNECT_PC),this.createWebSocketConnection(l).then(d.resolve).catch(d.reject),this.once(be.CLOSED,()=>{d.reject(new _t(H.WS_DISCONNECT))}),this.once(be.CONNECTED,d.resolve),await d.promise}catch{}finally{a()}}close(n,r){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const a=this.websocket;r?setTimeout(()=>a.close(),500):a.close(),this.websocket=void 0}this.state=n?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(n,r){if(!this.websocket)return void N.warning("[".concat(this.name,"] can not reconnect, no websocket"));n!==void 0&&(this.reconnectMode=n),N.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(r)]},this.joinGatewayRecordIndex);const a=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),a&&a.bind(this.websocket)({code:9999,reason:r})}sendMessage(n){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new _t(H.WS_ABORT,"websocket is not ready");try{r||(n=JSON.stringify(n)),this.websocket.send(n)}catch(a){throw new _t(H.WS_ERR,"send websocket message error"+a.toString())}}setWsInflateData(n){this.wsDeflateLength=this.wsDeflateLength+n.originLength,this.wsInflateLength=this.wsInflateLength+n.compressedLength}getWsInflateData(){const n=this.wsInflateLength,r=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:n,wsDeflateLength:r}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(n){var r;const a=Ef();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const d=R=>{var v;(v=this.store)===null||v===void 0||v.signalChannelOpen(),N.debug("[".concat(this.name,"] websocket opened:"),R),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),a.resolve()},l=async R=>{var v;if(N.debug("[".concat(this.name,"] websocket close ").concat((v=this.websocket)===null||v===void 0?void 0:v.url,", code: ").concat(R.code,", reason: ").concat(R.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)a.reject(new _t(H.WS_DISCONNECT,"websocket close: ".concat(R.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=R.reason,this.state="reconnecting");const y=Vo(this,be.WILL_RECONNECT,this.reconnectMode,R.reason)||this.reconnectMode,w=await this.reconnectWithAction(y);if(this.state==="closed")return void N.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!w)return a.reject(new _t(H.WS_DISCONNECT,"websocket reconnect failed: ".concat(R.code))),this.close(!0);a.resolve()}},p=R=>{this.emit(be.ON_MESSAGE,R)},E=R=>{N.warn("[".concat(this.connectionID,"] ws open error ").concat(R))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),J("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(n=J("GATEWAY_WSS_ADDRESS")),N.debug("[".concat(this.name,"] start connect, url:"),n);const f=(r=this.store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var T;const R=await this.chooseBestWebsocketConnection(n);this.websocket=R,d&&d(this.websocket.url),this.websocket.onclose=l,this.websocket.onmessage=p,this.websocket.onerror=E,(T=this.store)===null||T===void 0||T.recordJoinChannelService({endTs:Date.now(),status:"success"},f),this.joinGatewayRecordIndex=f}catch(R){const v=this.state==="closed",y=R instanceof _t,w=y&&R.code===H.WS_ABORT,B=y&&R.code===H.WS_ERR,k=y?R.message:R&&(R.reason||R.toString());N.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(k)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:w?"aborted":"error",errors:[R]},f),v||B?(a.reject(v?new _t(H.WS_DISCONNECT,"websocket is closed: ".concat(k)):new _t(H.WS_ERR,"init websocket failed: ".concat(k))),B&&N.error("[".concat(this.name,"] init websocket failed: ").concat(k))):l&&l(R)}return a.promise}async reconnectWithAction(n){let r=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;N.warning("[choose-best-ws] action: =>",n),this.onlineReconnectListener||Ui.isOnline||!Ui.onlineWaiter||(this.onlineReconnectListener=Ui.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let a=!0;if(this.reconnectInterrupter=()=>a=!1,r){const p=Tb(this.reconnectCount,this.retryConfig);N.debug("[".concat(this.name,"] wait ").concat(p,"ms to reconnect websocket, mode: ").concat(n)),await Bt.race([xr(p),this.onlineReconnectListener||new Bt(()=>{})])}if(this._state==="closed"||!a)return!1;this.reconnectCount+=1;const d=async(p,E)=>{this.emit(be.RECONNECT_CREATE_CONNECTION,E),await this.createWebSocketConnection(p)};try{if(n==="retry")await d(this.urls[this.currentURLIndex],n);else if(n==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);N.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await d(this.urls[this.currentURLIndex],n)}else n==="recover"&&(N.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await Kr(this,be.REQUEST_NEW_URLS),this.currentURLIndex=0,await d(this.urls[this.currentURLIndex],n))}catch(p){var l;N.error("[".concat(this.name,"] reconnect failed ").concat(p&&p.toString()));const E=p==null||(l=p.data)===null||l===void 0?void 0:l.desc;return Array.isArray(E)&&Mt(E).call(E,"dynamic key expired")?(this.emit(be.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(n,r)}return!0}}class Fb extends kf{constructor(n,r){super(n,r,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(n,r){const a=Ef(),d=function(p,E){return new Ij(p,E)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{N.debug("[choose-best-ws] close establishing websockets"),d.closeAllWebsockets(),a.reject(new _t(H.WS_ABORT,"choose best websocket aborted"))};const l=J("GATEWAY_DOMAINS");return N.debug("[choose-best-ws] currentDomain: ",n,", domains: ",l,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),d.chooseBestWebsocket(n,this.tryDoubleDomain,this.use443PortOnly,r).then(a.resolve).catch(a.reject),a.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Mf extends kf{constructor(n,r){super(n,r,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(n,r){return new Bt((a,d)=>{let l=!1;const p=[];this.closeEstablishingWs=()=>{N.debug("[choose-best-ws] close establishing websockets"),p.forEach(B=>{B.onclose=null,B.onopen=null,B.onmessage=null,B.close()}),d(new _t(H.WS_ABORT,"choose best websocket aborted"))};const E=J("GATEWAY_DOMAINS");let f;const T=n.indexOf("?h="),R=E.find(B=>T!==-1?Mt(n).call(n,B,T):Mt(n).call(n,B));N.debug("[choose-best-ws] currentDomain: ",R,", domains: ",E);let v=!this.tryDoubleDomain||!R;if(!v&&R){var y;const B=Date.now();try{E.forEach(k=>{const U=T===-1?n.replace(R,k):n.substr(0,T)+n.substr(T).replace(R,k),G=new WebSocket(U);G.binaryType="arraybuffer",p.push(G),N.debug("[choose-best-ws] ws is connecting:",G.url)})}catch{for(N.debug("[choose-best-ws] ws create failed, fallback to single url"),p.forEach(U=>U.close());p.length;)p.pop();v=!0}(y=this.store)===null||y===void 0||y.recordJoinChannelService({urls:p.map(k=>k.url),service:"gateway"},r),p.forEach(k=>{k.onopen=()=>{if(l)return;const U=Date.now()-B;N.debug("[choose-best-ws] ws open cost ".concat(U,"ms")),p.filter(G=>G!==k).forEach(G=>{N.debug("[choose-best-ws]close backup websocket: ".concat(G.url)),G.close()}),l=!0,a(k)},k.onclose=U=>{f=U,!l&&(p.find(G=>!(G.readyState===WebSocket.CLOSED||G.readyState===WebSocket.CLOSING))||(N.debug("[choose-best-ws] all websocket is closed"),l=!0,d(f)))},k.onmessage=U=>{N.debug("[choose-best-ws]".concat(k.url," onmessage: ").concat(U.data))}}),xr(this.forceCloseTimeout).then(()=>{p.forEach(k=>{k.readyState!==WebSocket.OPEN&&k.close()})})}if(v){var w;let B;N.debug("[choose-best-ws] use single url: ",n),(w=this.store)===null||w===void 0||w.recordJoinChannelService({urls:[n],service:"gateway"},r);try{B=new WebSocket(n),p.push(B),B.binaryType="arraybuffer"}catch(k){const U=new _t(H.WS_ERR,"init websocket failed! Error: ".concat(k.toString()));return N.error("[".concat(this.name,"]").concat(U)),void d(U)}B.onopen=()=>{a(B)},B.onclose=k=>{d(k)},B.onmessage=k=>{N.debug("[choose-best-ws]".concat(B.url," onmessage: ").concat(k.data))},xr(this.forceCloseTimeout).then(()=>{B&&B.readyState!==WebSocket.OPEN&&B.close()})}}).then(a=>(this.closeEstablishingWs=void 0,a)).catch(a=>{throw this.closeEstablishingWs=void 0,a})}}class yj extends An{get connectionState(){return this._connectionState}set connectionState(n){n!==this._connectionState&&(this._connectionState=n,n===Yn.CONNECTED?this.emit(fe.WS_CONNECTED):n===Yn.RECONNECTING?this.emit(fe.WS_RECONNECTING,this._websocketReconnectReason):n===Yn.CLOSED&&this.emit(fe.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(n,r){super(),F(this,"_disconnectedReason",void 0),F(this,"_websocketReconnectReason",void 0),F(this,"_connectionState",Yn.CLOSED),F(this,"reconnectToken",void 0),F(this,"websocket",void 0),F(this,"openConnectionTime",void 0),F(this,"clientId",void 0),F(this,"lastMsgTime",Date.now()),F(this,"uploadCache",[]),F(this,"uploadCacheInterval",void 0),F(this,"rttRolling",new dd(5)),F(this,"pingpongTimer",void 0),F(this,"wsInflateDataTimer",void 0),F(this,"pingpongTimeoutCount",0),F(this,"joinResponse",void 0),F(this,"multiIpOption",void 0),F(this,"initError",void 0),F(this,"spec",void 0),F(this,"store",void 0),F(this,"onWebsocketMessage",a=>{if(a.data instanceof ArrayBuffer)return void this.emit(fe.ON_BINARY_DATA,a.data);const d=JSON.parse(a.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(d,"_id")){const l="res-@".concat(d._id);this.emit(l,d._result,d._message)}else if(Object.prototype.hasOwnProperty.call(d,"_type")){if(this.emit(d._type,d._message),d._type===Ue.ON_NOTIFICATION&&this.handleNotification(d._message),d._type===Ue.ON_USER_BANNED)switch(d._message.error_code){case 14:this.close(Cn.UID_BANNED);break;case 15:this.close(Cn.IP_BANNED);break;case 16:this.close(Cn.CHANNEL_BANNED)}if(d._type===Ue.ON_USER_LICENSE_BANNED)switch(d._message.error_code){case de.ERR_LICENSE_MISSING:this.close(Cn.LICENSE_MISSING);break;case de.ERR_LICENSE_EXPIRED:this.close(Cn.LICENSE_EXPIRED);break;case de.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Cn.LICENSE_MINUTES_EXCEEDED);break;case de.ERR_LICENSE_PERIOD_INVALID:this.close(Cn.LICENSE_PERIOD_INVALID);break;case de.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Cn.LICENSE_MULTIPLE_SDK_SERVICE);break;case de.ERR_LICENSE_ILLEGAL:this.close(Cn.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=n.clientId,this.spec=n,this.store=r,this.websocket=new Fb("gateway-".concat(this.clientId),this.spec.retryConfig,!0,J("JOIN_GATEWAY_USE_DUAL_DOMAIN"),J("JOIN_GATEWAY_USE_443PORT_ONLY"),r),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Yn.CONNECTED&&this.reconnect("retry",rs.OFFLINE)})}async request(n,r,a,d){const l=Vn(6,""),p={_id:l,_type:n,_message:r},E=this.websocket.connectionID,f=()=>new Bt((B,k)=>{if(this.connectionState===Yn.CONNECTED)return B();const U=()=>{this.off(fe.WS_CLOSED,G),B()},G=()=>{this.off(fe.WS_CONNECTED,U),k(new lt(H.WS_ABORT))};this.once(fe.WS_CONNECTED,U),this.once(fe.WS_CLOSED,G),n!==ue.PUBLISH&&n!==ue.PUBLISH_DATASTREAM&&n!==ue.SUBSCRIBE&&n!==ue.SUBSCRIBE_DATASTREAM&&n!==ue.UNSUBSCRIBE&&n!==ue.UNSUBSCRIBE_DATASTREAM&&n!==ue.UNPUBLISH&&n!==ue.UNPUBLISH_DATASTREAM&&n!==ue.CONTROL&&n!==ue.RESTART_ICE||this.once(fe.DISCONNECT_P2P,()=>{k(new lt(H.DISCONNECT_P2P))}),n!==ue.PUBLISH&&n!==ue.RESTART_ICE||this.once(fe.ABORT_P2P_EXECUTION,()=>{k(new lt(H.DISCONNECT_P2P))})});if(this.connectionState!==Yn.CONNECTING&&this.connectionState!==Yn.RECONNECTING||n===ue.JOIN||n===ue.REJOIN||await f(),this.websocket.sendMessage(p,!0),d)return;const T=new Bt((B,k)=>{let U=!1;const G=($,rt)=>{U=!0,B({isSuccess:$==="success",message:rt||{}}),this.off(fe.WS_CLOSED,W),this.off(fe.WS_RECONNECTING,W),this.emit(fe.REQUEST_SUCCESS,n,r)};this.once("res-@".concat(l),G);const W=()=>{k(new lt(H.WS_ABORT,"type: ".concat(n))),this.off(fe.WS_CLOSED,W),this.off(fe.WS_RECONNECTING,W),this.off("res-@".concat(l),G)};this.once(fe.WS_CLOSED,W),this.once(fe.WS_RECONNECTING,W),xr(J("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==E||U||(N.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(n)),this.emit(fe.REQUEST_TIMEOUT,n,r))})});let R=null;try{R=await T}catch(B){if(this.connectionState===Yn.CLOSED||n===ue.LEAVE)throw new lt(H.WS_ABORT);return!this.spec.forceWaitGatewayResponse||a?B.throw():n===ue.JOIN||n===ue.REJOIN?null:(await f(),await this.request(n,r))}if(R.isSuccess)return R.message;const v=Number(R.message.error_code||R.message.code),y=Nc(v),w=new lt(H.UNEXPECTED_RESPONSE,"".concat(y.desc,": ").concat(R.message.error_str),{code:v,data:R.message,desc:y.desc});return y.action==="success"?R.message:(N.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(n,", error_code: ").concat(v,", message: ").concat(y.desc,", action: ").concat(y.action)),v===de.ERR_TOO_MANY_BROADCASTERS?((n===ue.JOIN||n===ue.REJOIN)&&(this.initError=w,this.close()),w.throw()):y.action==="failed"?w.throw():y.action==="quit"?(this.initError=w,this.close(),w.throw()):(v===de.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=R.message.option,N.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",rs.MULTI_IP)):this.reconnect(y.action,rs.SERVER_ERROR),n===ue.JOIN||n===ue.REJOIN?null:await this.request(n,r)))}waitMessage(n,r){return new Bt(a=>{const d=l=>{(!r||r(l))&&(this.off(n,d),a(l))};this.on(n,d)})}uploadWRTCStats(n){if(!this.store.sessionId)return void N.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const r={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:n};this.upload(qa.WRTC_STATS,r)}upload(n,r){const a={_type:n,_message:r};try{this.websocket.sendMessage(a)}catch{const l=J("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(a),this.uploadCache.length>l&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Yn.CONNECTED)return;const p=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(p._type,p._message)},J("UPLOAD_CACHE_INTERVAL")||2e3))}}send(n,r){const a={_type:n,_message:r};this.websocket.sendMessage(a)}init(n,r){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Bt((a,d)=>{this.once(fe.WS_CONNECTED,()=>a(this.joinResponse)),this.once(fe.WS_CLOSED,()=>d(this.initError||new lt(H.WS_ABORT))),this.connectionState=Yn.CONNECTING,this.websocket.init(n).catch(d),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=n||Cn.LEAVE,this.connectionState=Yn.CLOSED,N.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(fe.ABORT_P2P_EXECUTION);const n=await Kr(this,fe.REQUEST_JOIN_INFO),r=await this.request(ue.JOIN,n);if(!r)return this.emit(fe.REPORT_JOIN_GATEWAY,Pf.TIMEOUT,this.url||""),!1;this.joinResponse=r,this.emit(fe.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Yn.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new lt(H.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const n=Cf(this,fe.REQUEST_REJOIN_INFO);n.token=this.reconnectToken;const r=await this.request(ue.REJOIN,n);return!!r&&(this.connectionState=Yn.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),r.peers&&r.peers.forEach(a=>{this.emit(Ue.ON_USER_ONLINE,{uid:a.uid}),a.audio&&this.emit(Ue.ON_ADD_AUDIO_STREAM,{uid:a.uid,uint_id:a.uint_id,audio:!0,ssrcId:a.audio_ssrc}),a.video&&this.emit(Ue.ON_ADD_VIDEO_STREAM,{uid:a.uid,uint_id:a.uint_id,video:!0,ssrcId:a.video_ssrc}),a.audio_mute?this.emit(Ue.MUTE_AUDIO,{uid:a.uid}):this.emit(Ue.UNMUTE_AUDIO,{uid:a.uid}),a.video_mute?this.emit(Ue.MUTE_VIDEO,{uid:a.uid}):this.emit(Ue.UNMUTE_VIDEO,{uid:a.uid}),a.audio_enable_local?this.emit(Ue.ENABLE_LOCAL_AUDIO,{uid:a.uid}):this.emit(Ue.DISABLE_LOCAL_AUDIO,{uid:a.uid}),a.video_enable_local?this.emit(Ue.ENABLE_LOCAL_VIDEO,{uid:a.uid}):this.emit(Ue.DISABLE_LOCAL_VIDEO,{uid:a.uid}),a.audio||a.video||this.emit(Ue.ON_REMOVE_STREAM,{uid:a.uid,uint_id:a.uint_id})}),!0)}reconnect(n,r){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(n,r)}handleNotification(n){N.debug("[".concat(this.clientId,"] receive notification: "),n);const r=Nc(n.code);if(n.code===28&&"detail"in n&&(N.info("[".concat(this.clientId,"] receive recover notification: "),n.detail),this.emit(fe.RECOVER_NOTIFICATION,n.detail)),r.action!=="success"){if(r.action!=="failed")return r.action==="quit"?(r.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Cn.UID_BANNED),void this.close()):void this.reconnect(r.action,rs.SERVER_ERROR);N.error("[".concat(this.clientId,"] ignore error: "),r.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const n=J("PING_PONG_TIME_OUT"),r=Date.now();this.pingpongTimeoutCount>=n&&(N.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(r-this.lastMsgTime,"ms")),r-this.lastMsgTime>J("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",rs.TIMEOUT):this.request(ue.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const a=Date.now()-r;this.rttRolling.add(a),J("REPORT_STATS")&&this.send(ue.PING_BACK,{pingpongElapse:a})}).catch(a=>{})}handleWsInflateData(){const{wsInflateLength:n,wsDeflateLength:r}=this.websocket.getWsInflateData();n!==0&&r!==0&&this.upload(qa.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:r,ws_inflate_length:n})}handleWebsocketEvents(){this.websocket.on(be.RECONNECT_CREATE_CONNECTION,n=>{this.emit(fe.WS_RECONNECT_CREATE_CONNECTION,n)}),this.websocket.on(be.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(be.CLOSED,()=>{this.connectionState=Yn.CLOSED}),this.websocket.on(be.FAILED,()=>{this._disconnectedReason=Cn.NETWORK_ERROR,this.connectionState=Yn.CLOSED}),this.websocket.on(be.RECONNECTING,n=>{this._websocketReconnectReason=n,this.joinResponse=void 0,this.connectionState===Yn.CONNECTED?this.connectionState=Yn.RECONNECTING:this.connectionState=Yn.CONNECTING}),this.websocket.on(be.WILL_RECONNECT,(n,r,a)=>{const d=Cf(this,fe.IS_P2P_DISCONNECTED),l=d||n!=="retry";d&&n==="retry"&&(N.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),n="tryNext",r=Pf.P2P_DISCONNECTED),l&&(N.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(n)),this.emit(fe.REPORT_JOIN_GATEWAY,r||Pf.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(fe.DISCONNECT_P2P)),a(n)}),this.websocket.on(be.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(n=>{N.warning("[".concat(this.clientId,"] rejoin failed ").concat(n)),this.reconnect("tryNext",rs.SERVER_ERROR)}):this.join().catch(n=>{if(this.emit(fe.REPORT_JOIN_GATEWAY,n,this.url||""),n instanceof lt){if(n.code===H.UNEXPECTED_RESPONSE&&n.data.code===de.ERR_NO_AUTHORIZED)return this.initError=new lt(H.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),N.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",rs.SERVER_ERROR);N.error("[".concat(this.clientId,"] join gateway request failed"),n.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",rs.SERVER_ERROR):(this.initError=n,this.close())}})}),this.websocket.on(be.REQUEST_NEW_URLS,(n,r)=>{Kr(this,fe.REQUEST_RECOVER,this.multiIpOption).then(n).catch(r)}),this.websocket.on(be.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(xk.PRE_CONNECT_PC,()=>{this.emit(fe.PRE_CONNECT_PC)})}}let Xi=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function Uf(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function tE(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Uf(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Uf(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}function eE(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(J("TURN_DOMAIN")):(N.debug("Cannot recognized as ip address: ".concat(t,", use as host")),t)}function Bb(t,n){t.addresses||(t.addresses=[]);const r=function(E,f){if(J("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return E.map(v=>{let{ip:y,port:w}=v;return{address:"".concat(y,":").concat(w)}});const T=J("GATEWAY_DOMAINS");let R=T[1]&&Mt(f).call(f,T[1])?1:0;return E.map(v=>{let{domain_prefix:y,port:w,ip:B}=v;if(y)return{address:"".concat(y,".").concat(T[R++%T.length],":").concat(w)};const k=/^[\.\:\d]+$/.test(B),U=k?"".concat(B.replace(/[^\d]/g,"-"),".").concat(T[R++%T.length],":").concat(w):"".concat(B,":").concat(w);return k||N.debug("Cannot recognized as ip address: ".concat(B,", use as host")),{ip:B,port:w,address:U}})}(t.addresses,n),a=Array.isArray(t.detail)&&t.detail[18];if(a&&typeof a=="string"){const E=a.split(";");for(let f=0;f<E.length;f++){var d;const T=ms(d=E[f]).call(d);r[f]&&T&&(r[f].ip6=T)}}const l=t.detail&&t.detail.candidate;let p;if(l){const[E,f]=l.split(":");E&&f&&(p={port:Number(f),ip:E,address:"".concat(E,":").concat(f)})}return{gatewayAddrs:r,apGatewayAddress:p,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Fo(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function jk(t){const n=t._encoderConfig;if(!n)return{};const r={resolution:n.width&&n.height?"".concat(Fo(n.width),"x").concat(Fo(n.height)):void 0,maxVideoBW:n.bitrateMax,minVideoBW:n.bitrateMin};return typeof n.frameRate=="number"?(r.maxFrameRate=n.frameRate,r.minFrameRate=n.frameRate):n.frameRate&&(r.maxFrameRate=n.frameRate.max||n.frameRate.ideal||n.frameRate.exact||n.frameRate.min,r.minFrameRate=n.frameRate.min||n.frameRate.ideal||n.frameRate.exact||n.frameRate.max),r}function Ll(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function fa(t,n){let r,a,d;switch(n){case Xi.CHOOSE_SERVER:a=4096,d="choose server";break;case Xi.CLOUD_PROXY:a=1048576,d="proxy";break;case Xi.CLOUD_PROXY_5:a=4194304,d="proxy5";break;case Xi.CLOUD_PROXY_FALLBACK:a=4194310,d="proxy fallback";break;default:throw new lt(H.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(l=>{l.buffer&&l.buffer.flag===a&&(r={code:l.buffer.code,addresses:(l.buffer.edges_services||[]).map(p=>tE(tE({},p),{},{ticket:l.buffer.cert})),server_ts:t.enter_ts,uid:l.buffer.uid,cid:l.buffer.cid,cname:l.buffer.cname,detail:tE(tE({},l.buffer.detail),t.detail),flag:l.buffer.flag,opid:t.opid,cert:l.buffer.cert})}),!r)throw new lt(H.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(d," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return r}async function fp(t,n){return await Bt.all(t.addresses.map(async r=>({address:eE(r.ip),tcpport:r.port,udpport:r.port,username:n&&J("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?n.toString():Vr.username,password:n&&J("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await fR(n.toString()):Vr.password})))}function Wu(t,n){const r=n.getMediaStreamTrack(!0).getSettings(),a=n.videoHeight||r.height,d=n.videoWidth||r.width;return a&&d?Math.max(Math.min(a,d)/Math.min(Fo(t.height),Fo(t.width)),1):(N.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Dc(t){let{candidateType:n,relayProtocol:r,type:a,address:d,port:l,protocol:p}=t;const E={candidateType:n,relayProtocol:r,protocol:p};if(a!=="local-candidate"){const f=d.split(".");f.length>=4&&(f[1]="*",f[2]="*"),E.address=f.join("."),E.port=l}return E}var zs,Gk=Rt(bb),kl=fc("Array").values,Aj=Es,Ml=Zn,Qa=le,Za=kl,yi=Array.prototype,xf={DOMTokenList:!0,NodeList:!0},jb=function(t){var n=t.values;return t===yi||Qa(yi,t)&&n===yi.values||Ml(xf,Aj(t))?Za:n},$d=Rt(jb),gp=wr,Wk=Qt,Gb=Wn,nE=Nt,Pc=uT,Vf=dm,bj=Eh,Ff=Ns,Hk=fh,Tp=Object.assign,Wb=Object.defineProperty,wj=Wk([].concat),Oj=!Tp||nE(function(){if(gp&&Tp({b:1},Tp(Wb({},"a",{enumerable:!0,get:function(){Wb(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},n={},r=Symbol(),a="abcdefghijklmnopqrst";return t[r]=7,a.split("").forEach(function(d){n[d]=d}),Tp({},t)[r]!=7||Pc(Tp({},n)).join("")!=a})?function(t,n){for(var r=Ff(t),a=arguments.length,d=1,l=Vf.f,p=bj.f;a>d;)for(var E,f=Hk(arguments[d++]),T=l?wj(Pc(f),l(f)):Pc(f),R=T.length,v=0;R>v;)E=T[v++],gp&&!Gb(p,f,E)||(r[E]=f[E]);return r}:Tp,Bf=$i,Nj=lm,DR=Do,Kk=Wn,jf=Ns,Gf=function(t,n,r,a){try{return a?n(Bf(r)[0],r[1]):n(r)}catch(d){Nj(t,"throw",d)}},Yk=MN,qk=ym,Dj=vu,zk=lS,Pj=Zp,Lj=vh,Wf=Array,Sp=Qt,Hb=2147483647,kj=/[^\0-\u007E]/,Jk=/[.\u3002\uFF0E\uFF61]/g,Hf="Overflow: input needs wider integers to process",Xk=RangeError,Mj=Sp(Jk.exec),Hu=Math.floor,Kb=String.fromCharCode,Kf=Sp("".charCodeAt),Qk=Sp([].join),Ul=Sp([].push),Uj=Sp("".replace),xj=Sp("".split),Yf=Sp("".toLowerCase),Yb=function(t){return t+22+75*(t<26)},Vj=function(t,n,r){var a=0;for(t=r?Hu(t/700):t>>1,t+=Hu(t/n);t>455;)t=Hu(t/35),a+=36;return Hu(a+36*t/(t+38))},PR=function(t){var n=[];t=function(G){for(var W=[],$=0,rt=G.length;$<rt;){var ot=Kf(G,$++);if(ot>=55296&&ot<=56319&&$<rt){var Et=Kf(G,$++);(64512&Et)==56320?Ul(W,((1023&ot)<<10)+(1023&Et)+65536):(Ul(W,ot),$--)}else Ul(W,ot)}return W}(t);var r,a,d=t.length,l=128,p=0,E=72;for(r=0;r<t.length;r++)(a=t[r])<128&&Ul(n,Kb(a));var f=n.length,T=f;for(f&&Ul(n,"-");T<d;){var R=Hb;for(r=0;r<t.length;r++)(a=t[r])>=l&&a<R&&(R=a);var v=T+1;if(R-l>Hu((Hb-p)/v))throw Xk(Hf);for(p+=(R-l)*v,l=R,r=0;r<t.length;r++){if((a=t[r])<l&&++p>Hb)throw Xk(Hf);if(a==l){for(var y=p,w=36;;){var B=w<=E?1:w>=E+26?26:w-E;if(y<B)break;var k=y-B,U=36-B;Ul(n,Kb(Yb(B+k%U))),y=Hu(k/U),w+=36}Ul(n,Kb(Yb(y))),E=Vj(p,v,T==f),p=0,T++}}p++,l++}return Qk(n,"")},Rp=Ce,qb=wr,Fj=GS,ga=Te,zb=Do,$a=Qt,LR=Au,tc=Cm,kR=Ma,iE=Zn,Ed=Oj,xl=function(t){var n=jf(t),r=qk(this),a=arguments.length,d=a>1?arguments[1]:void 0,l=d!==void 0;l&&(d=DR(d,a>2?arguments[2]:void 0));var p,E,f,T,R,v,y=Lj(n),w=0;if(!y||this===Wf&&Yk(y))for(p=Dj(n),E=r?new this(p):Wf(p);p>w;w++)v=l?d(n[w],w):n[w],zk(E,w,v);else for(R=(T=Pj(n,y)).next,E=r?new this:[];!(f=Kk(R,T)).done;w++)v=l?Gf(T,d,[f.value,w],!0):f.value,zk(E,w,v);return E.length=w,E},ec=Uy,MR=nS.codeAt,UR=function(t){var n,r,a=[],d=xj(Uj(Yf(t),Jk,"."),".");for(n=0;n<d.length;n++)r=d[n],Ul(a,Mj(kj,r)?"xn--"+PR(r):r);return Qk(a,".")},md=La,jr=hl,Zk=a_,$k=zA,Vl=yh,tM=Vl.set,qf=Vl.getterFor("URL"),eM=$k.URLSearchParams,nM=$k.getState,Cp=ga.URL,zf=ga.TypeError,Jf=ga.parseInt,Bj=Math.floor,Jb=Math.pow,Lc=$a("".charAt),ks=$a(/./.exec),Xf=$a([].join),iM=$a(1 .toString),jj=$a([].pop),rE=$a([].push),vp=$a("".replace),Xb=$a([].shift),Qb=$a("".split),Qf=$a("".slice),Zf=$a("".toLowerCase),Gj=$a([].unshift),sE="Invalid scheme",Ip="Invalid host",rM="Invalid port",sM=/[a-z]/i,Wj=/[\d+-.a-z]/i,$f=/\d/,Hj=/^0x/i,Kj=/^[0-7]+$/,Yj=/^\d+$/,Zb=/^[\da-f]+$/i,qj=/[\0\t\n\r #%/:<>?@[\\\]^|]/,oM=/[\0\t\n\r #/:<>?@[\\\]^|]/,zj=/^[\u0000-\u0020]+/,Jj=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,$b=/[\t\n\r]/g,tg=function(t){var n,r,a,d;if(typeof t=="number"){for(n=[],r=0;r<4;r++)Gj(n,t%256),t=Bj(t/256);return Xf(n,".")}if(typeof t=="object"){for(n="",a=function(l){for(var p=null,E=1,f=null,T=0,R=0;R<8;R++)l[R]!==0?(T>E&&(p=f,E=T),f=null,T=0):(f===null&&(f=R),++T);return T>E&&(p=f,E=T),p}(t),r=0;r<8;r++)d&&t[r]===0||(d&&(d=!1),a===r?(n+=r?":":"::",d=!0):(n+=iM(t[r],16),r<7&&(n+=":")));return"["+n+"]"}return t},oE={},yp=Ed({},oE,{" ":1,'"':1,"<":1,">":1,"`":1}),eg=Ed({},yp,{"#":1,"?":1,"{":1,"}":1}),kc=Ed({},eg,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),nc=function(t,n){var r=MR(t,0);return r>32&&r<127&&!iE(n,t)?t:encodeURIComponent(t)},ng={ftp:21,file:null,http:80,https:443,ws:80,wss:443},aE=function(t,n){var r;return t.length==2&&ks(sM,Lc(t,0))&&((r=Lc(t,1))==":"||!n&&r=="|")},aM=function(t){var n;return t.length>1&&aE(Qf(t,0,2))&&(t.length==2||(n=Lc(t,2))==="/"||n==="\\"||n==="?"||n==="#")},Xj=function(t){return t==="."||Zf(t)==="%2e"},tw={},cM={},ig={},ew={},xR={},nw={},dM={},uM={},VR={},rg={},eo={},iw={},FR={},sg={},lM={},Fl={},cE={},tu={},dE={},Bl={},eu={},Ta=function(t,n,r){var a,d,l,p=md(t);if(n){if(d=this.parse(p))throw zf(d);this.searchParams=null}else{if(r!==void 0&&(a=new Ta(r,!0)),d=this.parse(p,null,a))throw zf(d);(l=nM(new eM)).bindURL(this),this.searchParams=l}};Ta.prototype={type:"URL",parse:function(t,n,r){var a,d,l,p,E,f=this,T=n||tw,R=0,v="",y=!1,w=!1,B=!1;for(t=md(t),n||(f.scheme="",f.username="",f.password="",f.host=null,f.port=null,f.path=[],f.query=null,f.fragment=null,f.cannotBeABaseURL=!1,t=vp(t,zj,""),t=vp(t,Jj,"$1")),t=vp(t,$b,""),a=xl(t);R<=a.length;){switch(d=a[R],T){case tw:if(!d||!ks(sM,d)){if(n)return sE;T=ig;continue}v+=Zf(d),T=cM;break;case cM:if(d&&(ks(Wj,d)||d=="+"||d=="-"||d=="."))v+=Zf(d);else{if(d!=":"){if(n)return sE;v="",T=ig,R=0;continue}if(n&&(f.isSpecial()!=iE(ng,v)||v=="file"&&(f.includesCredentials()||f.port!==null)||f.scheme=="file"&&!f.host))return;if(f.scheme=v,n)return void(f.isSpecial()&&ng[f.scheme]==f.port&&(f.port=null));v="",f.scheme=="file"?T=sg:f.isSpecial()&&r&&r.scheme==f.scheme?T=ew:f.isSpecial()?T=uM:a[R+1]=="/"?(T=xR,R++):(f.cannotBeABaseURL=!0,rE(f.path,""),T=dE)}break;case ig:if(!r||r.cannotBeABaseURL&&d!="#")return sE;if(r.cannotBeABaseURL&&d=="#"){f.scheme=r.scheme,f.path=ec(r.path),f.query=r.query,f.fragment="",f.cannotBeABaseURL=!0,T=eu;break}T=r.scheme=="file"?sg:nw;continue;case ew:if(d!="/"||a[R+1]!="/"){T=nw;continue}T=VR,R++;break;case xR:if(d=="/"){T=rg;break}T=tu;continue;case nw:if(f.scheme=r.scheme,d==zs)f.username=r.username,f.password=r.password,f.host=r.host,f.port=r.port,f.path=ec(r.path),f.query=r.query;else if(d=="/"||d=="\\"&&f.isSpecial())T=dM;else if(d=="?")f.username=r.username,f.password=r.password,f.host=r.host,f.port=r.port,f.path=ec(r.path),f.query="",T=Bl;else{if(d!="#"){f.username=r.username,f.password=r.password,f.host=r.host,f.port=r.port,f.path=ec(r.path),f.path.length--,T=tu;continue}f.username=r.username,f.password=r.password,f.host=r.host,f.port=r.port,f.path=ec(r.path),f.query=r.query,f.fragment="",T=eu}break;case dM:if(!f.isSpecial()||d!="/"&&d!="\\"){if(d!="/"){f.username=r.username,f.password=r.password,f.host=r.host,f.port=r.port,T=tu;continue}T=rg}else T=VR;break;case uM:if(T=VR,d!="/"||Lc(v,R+1)!="/")continue;R++;break;case VR:if(d!="/"&&d!="\\"){T=rg;continue}break;case rg:if(d=="@"){y&&(v="%40"+v),y=!0,l=xl(v);for(var k=0;k<l.length;k++){var U=l[k];if(U!=":"||B){var G=nc(U,kc);B?f.password+=G:f.username+=G}else B=!0}v=""}else if(d==zs||d=="/"||d=="?"||d=="#"||d=="\\"&&f.isSpecial()){if(y&&v=="")return"Invalid authority";R-=xl(v).length+1,v="",T=eo}else v+=d;break;case eo:case iw:if(n&&f.scheme=="file"){T=Fl;continue}if(d!=":"||w){if(d==zs||d=="/"||d=="?"||d=="#"||d=="\\"&&f.isSpecial()){if(f.isSpecial()&&v=="")return Ip;if(n&&v==""&&(f.includesCredentials()||f.port!==null))return;if(p=f.parseHost(v))return p;if(v="",T=cE,n)return;continue}d=="["?w=!0:d=="]"&&(w=!1),v+=d}else{if(v=="")return Ip;if(p=f.parseHost(v))return p;if(v="",T=FR,n==iw)return}break;case FR:if(!ks($f,d)){if(d==zs||d=="/"||d=="?"||d=="#"||d=="\\"&&f.isSpecial()||n){if(v!=""){var W=Jf(v,10);if(W>65535)return rM;f.port=f.isSpecial()&&W===ng[f.scheme]?null:W,v=""}if(n)return;T=cE;continue}return rM}v+=d;break;case sg:if(f.scheme="file",d=="/"||d=="\\")T=lM;else{if(!r||r.scheme!="file"){T=tu;continue}if(d==zs)f.host=r.host,f.path=ec(r.path),f.query=r.query;else if(d=="?")f.host=r.host,f.path=ec(r.path),f.query="",T=Bl;else{if(d!="#"){aM(Xf(ec(a,R),""))||(f.host=r.host,f.path=ec(r.path),f.shortenPath()),T=tu;continue}f.host=r.host,f.path=ec(r.path),f.query=r.query,f.fragment="",T=eu}}break;case lM:if(d=="/"||d=="\\"){T=Fl;break}r&&r.scheme=="file"&&!aM(Xf(ec(a,R),""))&&(aE(r.path[0],!0)?rE(f.path,r.path[0]):f.host=r.host),T=tu;continue;case Fl:if(d==zs||d=="/"||d=="\\"||d=="?"||d=="#"){if(!n&&aE(v))T=tu;else if(v==""){if(f.host="",n)return;T=cE}else{if(p=f.parseHost(v))return p;if(f.host=="localhost"&&(f.host=""),n)return;v="",T=cE}continue}v+=d;break;case cE:if(f.isSpecial()){if(T=tu,d!="/"&&d!="\\")continue}else if(n||d!="?")if(n||d!="#"){if(d!=zs&&(T=tu,d!="/"))continue}else f.fragment="",T=eu;else f.query="",T=Bl;break;case tu:if(d==zs||d=="/"||d=="\\"&&f.isSpecial()||!n&&(d=="?"||d=="#")){if((E=Zf(E=v))===".."||E==="%2e."||E===".%2e"||E==="%2e%2e"?(f.shortenPath(),d=="/"||d=="\\"&&f.isSpecial()||rE(f.path,"")):Xj(v)?d=="/"||d=="\\"&&f.isSpecial()||rE(f.path,""):(f.scheme=="file"&&!f.path.length&&aE(v)&&(f.host&&(f.host=""),v=Lc(v,0)+":"),rE(f.path,v)),v="",f.scheme=="file"&&(d==zs||d=="?"||d=="#"))for(;f.path.length>1&&f.path[0]==="";)Xb(f.path);d=="?"?(f.query="",T=Bl):d=="#"&&(f.fragment="",T=eu)}else v+=nc(d,eg);break;case dE:d=="?"?(f.query="",T=Bl):d=="#"?(f.fragment="",T=eu):d!=zs&&(f.path[0]+=nc(d,oE));break;case Bl:n||d!="#"?d!=zs&&(d=="'"&&f.isSpecial()?f.query+="%27":f.query+=d=="#"?"%23":nc(d,oE)):(f.fragment="",T=eu);break;case eu:d!=zs&&(f.fragment+=nc(d,yp))}R++}},parseHost:function(t){var n,r,a;if(Lc(t,0)=="["){if(Lc(t,t.length-1)!="]"||(n=function(d){var l,p,E,f,T,R,v,y=[0,0,0,0,0,0,0,0],w=0,B=null,k=0,U=function(){return Lc(d,k)};if(U()==":"){if(Lc(d,1)!=":")return;k+=2,B=++w}for(;U();){if(w==8)return;if(U()!=":"){for(l=p=0;p<4&&ks(Zb,U());)l=16*l+Jf(U(),16),k++,p++;if(U()=="."){if(p==0||(k-=p,w>6))return;for(E=0;U();){if(f=null,E>0){if(!(U()=="."&&E<4))return;k++}if(!ks($f,U()))return;for(;ks($f,U());){if(T=Jf(U(),10),f===null)f=T;else{if(f==0)return;f=10*f+T}if(f>255)return;k++}y[w]=256*y[w]+f,++E!=2&&E!=4||w++}if(E!=4)return;break}if(U()==":"){if(k++,!U())return}else if(U())return;y[w++]=l}else{if(B!==null)return;k++,B=++w}}if(B!==null)for(R=w-B,w=7;w!=0&&R>0;)v=y[w],y[w--]=y[B+R-1],y[B+--R]=v;else if(w!=8)return;return y}(Qf(t,1,-1)),!n))return Ip;this.host=n}else if(this.isSpecial()){if(t=UR(t),ks(qj,t)||(n=function(d){var l,p,E,f,T,R,v,y=Qb(d,".");if(y.length&&y[y.length-1]==""&&y.length--,(l=y.length)>4)return d;for(p=[],E=0;E<l;E++){if((f=y[E])=="")return d;if(T=10,f.length>1&&Lc(f,0)=="0"&&(T=ks(Hj,f)?16:8,f=Qf(f,T==8?1:2)),f==="")R=0;else{if(!ks(T==10?Yj:T==8?Kj:Zb,f))return d;R=Jf(f,T)}rE(p,R)}for(E=0;E<l;E++)if(R=p[E],E==l-1){if(R>=Jb(256,5-l))return null}else if(R>255)return null;for(v=jj(p),E=0;E<p.length;E++)v+=p[E]*Jb(256,3-E);return v}(t),n===null))return Ip;this.host=n}else{if(ks(oM,t))return Ip;for(n="",r=xl(t),a=0;a<r.length;a++)n+=nc(r[a],oE);this.host=n}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return iE(ng,this.scheme)},shortenPath:function(){var t=this.path,n=t.length;!n||this.scheme=="file"&&n==1&&aE(t[0],!0)||t.length--},serialize:function(){var t=this,n=t.scheme,r=t.username,a=t.password,d=t.host,l=t.port,p=t.path,E=t.query,f=t.fragment,T=n+":";return d!==null?(T+="//",t.includesCredentials()&&(T+=r+(a?":"+a:"")+"@"),T+=tg(d),l!==null&&(T+=":"+l)):n=="file"&&(T+="//"),T+=t.cannotBeABaseURL?p[0]:p.length?"/"+Xf(p,"/"):"",E!==null&&(T+="?"+E),f!==null&&(T+="#"+f),T},setHref:function(t){var n=this.parse(t);if(n)throw zf(n);this.searchParams.update()},getOrigin:function(){var t=this.scheme,n=this.port;if(t=="blob")try{return new uE(t.path[0]).origin}catch{return"null"}return t!="file"&&this.isSpecial()?t+"://"+tg(this.host)+(n!==null?":"+n:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(md(t)+":",tw)},getUsername:function(){return this.username},setUsername:function(t){var n=xl(md(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var r=0;r<n.length;r++)this.username+=nc(n[r],kc)}},getPassword:function(){return this.password},setPassword:function(t){var n=xl(md(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var r=0;r<n.length;r++)this.password+=nc(n[r],kc)}},getHost:function(){var t=this.host,n=this.port;return t===null?"":n===null?tg(t):tg(t)+":"+n},setHost:function(t){this.cannotBeABaseURL||this.parse(t,eo)},getHostname:function(){var t=this.host;return t===null?"":tg(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,iw)},getPort:function(){var t=this.port;return t===null?"":md(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=md(t))==""?this.port=null:this.parse(t,FR))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+Xf(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,cE))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=md(t))==""?this.query=null:(Lc(t,0)=="?"&&(t=Qf(t,1)),this.query="",this.parse(t,Bl)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=md(t))!=""?(Lc(t,0)=="#"&&(t=Qf(t,1)),this.fragment="",this.parse(t,eu)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var uE=function(t){var n=kR(this,Bo),r=Zk(arguments.length,1)>1?arguments[1]:void 0,a=tM(n,new Ta(t,!1,r));qb||(n.href=a.serialize(),n.origin=a.getOrigin(),n.protocol=a.getProtocol(),n.username=a.getUsername(),n.password=a.getPassword(),n.host=a.getHost(),n.hostname=a.getHostname(),n.port=a.getPort(),n.pathname=a.getPathname(),n.search=a.getSearch(),n.searchParams=a.getSearchParams(),n.hash=a.getHash())},Bo=uE.prototype,Sa=function(t,n){return{get:function(){return qf(this)[t]()},set:n&&function(r){return qf(this)[n](r)},configurable:!0,enumerable:!0}};if(qb&&(tc(Bo,"href",Sa("serialize","setHref")),tc(Bo,"origin",Sa("getOrigin")),tc(Bo,"protocol",Sa("getProtocol","setProtocol")),tc(Bo,"username",Sa("getUsername","setUsername")),tc(Bo,"password",Sa("getPassword","setPassword")),tc(Bo,"host",Sa("getHost","setHost")),tc(Bo,"hostname",Sa("getHostname","setHostname")),tc(Bo,"port",Sa("getPort","setPort")),tc(Bo,"pathname",Sa("getPathname","setPathname")),tc(Bo,"search",Sa("getSearch","setSearch")),tc(Bo,"searchParams",Sa("getSearchParams")),tc(Bo,"hash",Sa("getHash","setHash"))),LR(Bo,"toJSON",function(){return qf(this).serialize()},{enumerable:!0}),LR(Bo,"toString",function(){return qf(this).serialize()},{enumerable:!0}),Cp){var rw=Cp.createObjectURL,og=Cp.revokeObjectURL;rw&&LR(uE,"createObjectURL",zb(rw,Cp)),og&&LR(uE,"revokeObjectURL",zb(og,Cp))}jr(uE,"URL"),Rp({global:!0,forced:!Fj,sham:!qb},{URL:uE});var ag=Ce,sw=Nt,hM=a_,pM=La,Qj=GS,ow=qi("URL");ag({target:"URL",stat:!0,forced:!(Qj&&sw(function(){ow.canParse()}))},{canParse:function(t){var n=hM(arguments.length,1),r=pM(t),a=n<2||arguments[1]===void 0?void 0:pM(arguments[1]);try{return!!new ow(r,a)}catch{return!1}}});var _M=Rt($r.URL);const zr={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function nn(){return zr}function jl(){return"setSinkId"in HTMLAudioElement.prototype&&(!J("RESTRICTION_SET_PLAYBACK_DEVICE")||(Ac()||db())&&!hb())}function BR(){return!zr.supportUnifiedPlan||J("CHROME_FORCE_PLAN_B")&&Il()}let Jr=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function Ap(t,n,r){return{sampleRate:t,stereo:n,bitrate:r}}function Xe(t,n,r,a,d){return{width:t,height:n,frameRate:r,bitrateMin:a,bitrateMax:d}}function Mc(t,n,r,a,d){return{width:{max:t},height:{max:n},frameRate:r,bitrateMin:a,bitrateMax:d}}function aw(t,n){return{numSpatialLayers:t,numTemporalLayers:n}}const EM={"90p":Xe(160,90),"90p_1":Xe(160,90),"120p":Xe(160,120,15,30,65),"120p_1":Xe(160,120,15,30,65),"120p_3":Xe(120,120,15,30,50),"120p_4":Xe(212,120),"180p":Xe(320,180,15,30,140),"180p_1":Xe(320,180,15,30,140),"180p_3":Xe(180,180,15,30,100),"180p_4":Xe(240,180,15,30,120),"240p":Xe(320,240,15,40,200),"240p_1":Xe(320,240,15,40,200),"240p_3":Xe(240,240,15,40,140),"240p_4":Xe(424,240,15,40,220),"360p":Xe(640,360,15,80,400),"360p_1":Xe(640,360,15,80,400),"360p_3":Xe(360,360,15,80,260),"360p_4":Xe(640,360,30,80,600),"360p_6":Xe(360,360,30,80,400),"360p_7":Xe(480,360,15,80,320),"360p_8":Xe(480,360,30,80,490),"360p_9":Xe(640,360,15,80,800),"360p_10":Xe(640,360,24,80,800),"360p_11":Xe(640,360,24,80,1e3),"480p":Xe(640,480,15,100,500),"480p_1":Xe(640,480,15,100,500),"480p_2":Xe(640,480,30,100,1e3),"480p_3":Xe(480,480,15,100,400),"480p_4":Xe(640,480,30,100,750),"480p_6":Xe(480,480,30,100,600),"480p_8":Xe(848,480,15,100,610),"480p_9":Xe(848,480,30,100,930),"480p_10":Xe(640,480,10,100,400),"720p":Xe(1280,720,15,120,1130),"720p_auto":Xe(1280,720,30,900,3e3),"720p_1":Xe(1280,720,15,120,1130),"720p_2":Xe(1280,720,30,120,2e3),"720p_3":Xe(1280,720,30,120,1710),"720p_5":Xe(960,720,15,120,910),"720p_6":Xe(960,720,30,120,1380),"1080p":Xe(1920,1080,15,120,2080),"1080p_1":Xe(1920,1080,15,120,2080),"1080p_2":Xe(1920,1080,30,120,3e3),"1080p_3":Xe(1920,1080,30,120,3150),"1080p_5":Xe(1920,1080,60,120,4780),"1440p":Xe(2560,1440,30,120,4850),"1440p_1":Xe(2560,1440,30,120,4850),"1440p_2":Xe(2560,1440,60,120,7350),"4k":Xe(3840,2160,30,120,8910),"4k_1":Xe(3840,2160,30,120,8910),"4k_3":Xe(3840,2160,60,120,13500)},Zj={"480p":Mc(640,480,5),"480p_1":Mc(640,480,5),"480p_2":Mc(640,480,30),"480p_3":Mc(640,480,15),"720p":Mc(1280,720,5),"720p_auto":Xe(1280,720,30,900,3e3),"720p_1":Mc(1280,720,5),"720p_2":Mc(1280,720,30),"720p_3":Mc(1280,720,15),"1080p":Mc(1920,1080,5),"1080p_1":Mc(1920,1080,5),"1080p_2":Mc(1920,1080,30),"1080p_3":Mc(1920,1080,15)},$j={"1SL1TL":aw(1,1),"3SL3TL":aw(3,3),"2SL3TL":aw(2,3)};function fd(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},EM[t]):t}function cw(t){return typeof t=="string"?Object.assign({},Zj[t]):t}function jR(t){return typeof t=="string"?Object.assign({},$j[t]):t}const tG={speech_low_quality:Ap(16e3,!1),speech_standard:Ap(32e3,!1,18),music_standard:Ap(48e3,!1),standard_stereo:Ap(48e3,!0,56),high_quality:Ap(48e3,!1,128),high_quality_stereo:Ap(48e3,!0,192)};function cg(t){return typeof t=="string"?Object.assign({},tG[t]):t}const Gl=[];function dw(t){return lr(t,"mediaSource",["screen","window","application"]),!0}let Wt=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),vn=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t}({}),lE=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),eG=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t}({}),mM=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t}({}),Ku=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),no=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),hE=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),bp=function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t}({}),Ra=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});const uw={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},lw={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},GR={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},nG={uplinkNetworkQuality:0,downlinkNetworkQuality:0},fM={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Js=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),Ca=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),nu=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),Wl=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),Ms=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),iu=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({});const hw={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let WR=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function $e(t,n,r,a,d){var l,p,E={};return Object.keys(a).forEach(function(f){E[f]=a[f]}),E.enumerable=!!E.enumerable,E.configurable=!!E.configurable,("value"in E||E.initializer)&&(E.writable=!0),E=ka(l=Gk(p=r.slice()).call(p)).call(l,function(f,T){return T(t,n,f)||f},E),d&&E.initializer!==void 0&&(E.value=E.initializer?E.initializer.call(d):void 0,E.initializer=void 0),E.initializer===void 0&&(Object.defineProperty(t,n,E),E=null),E}function gt(t,n,r){return(n=function(a){var d=function(l,p){if(typeof l!="object"||!l)return l;var E=l[Symbol.toPrimitive];if(E!==void 0){var f=E.call(l,"string");if(typeof f!="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}(a);return typeof d=="symbol"?d:d+""}(n))in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}function gM(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function _i(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?gM(Object(r),!0).forEach(function(a){gt(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):gM(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class TM extends An{set _mediaStreamTrack(n){n!==this.mediaStreamTrack&&(this.safeEmit(Ku.TRACK_UPDATED,n),this.mediaStreamTrack=n)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(n,r){super(),gt(this,"trackMediaType",void 0),gt(this,"_ID",void 0),gt(this,"_rtpTransceiver",void 0),gt(this,"_lowRtpTransceiver",void 0),gt(this,"_hints",[]),gt(this,"_isClosed",!1),gt(this,"_originMediaStreamTrack",void 0),gt(this,"mediaStreamTrack",void 0),gt(this,"_external",{}),this._ID=r||Vn(8,"track-"),this._originMediaStreamTrack=n,this.mediaStreamTrack=n,function(a){Mt(Gl).call(Gl,a)||Gl.push(a)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(n){return n||Al(()=>{var r;ee.reportApiInvoke(null,{name:Gi.GET_MEDIA_STREAM_TRACK,options:[],tag:Si.TRACER}).onSuccess(((r=this._mediaStreamTrack)===null||r===void 0?void 0:r.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(n){return n===lE.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(n){const r=Gl.indexOf(n);r!==-1&&Gl.splice(r,1)}(this),this.emit(no.CLOSED),this.removeAllListeners(Ku.SEI_RECEIVED)}_updateRtpTransceiver(n,r){if(r===lE.LOW_STREAM){if(this._lowRtpTransceiver===n)return;this._lowRtpTransceiver=n}else{if(this._rtpTransceiver===n)return;this._rtpTransceiver=n}this.emit(Ku.TRANSCEIVER_UPDATED,n,r)}}class pE extends TM{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(n,r){super(n,r),gt(this,"_enabled",!0),gt(this,"_muted",!1),gt(this,"_isExternalTrack",!1),gt(this,"_isClosed",!1),gt(this,"_enabledMutex",void 0),gt(this,"processor",void 0),gt(this,"_processorContext",void 0),gt(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Yr("".concat(this.getTrackId())),n.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var n,r;return(n=(r=this._originMediaStreamTrack)===null||r===void 0?void 0:r.label)!==null&&n!==void 0?n:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,N.debug("[".concat(this.getTrackId(),"] close")),this.emit(Wt.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(n,r){let a=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=a,n!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),r&&this._originMediaStreamTrack.stop()),n.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=n,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await On(this,Wt.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){N.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(no.TRACK_ENDED)}stateCheck(n,r){if(N.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(n,": ").concat(r,"]")),qd(r,n),this._enabled&&this._muted&&n==="enabled"&&r===!1)throw new _t(H.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",N);if(!this._enabled&&!this._muted&&n==="muted"&&r===!0)throw new _t(H.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",N)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Bt.resolve([])}}const SM=window.AudioContext||window.webkitAudioContext;let jo=null;const Dn=new class extends An{constructor(){super(...arguments),gt(this,"prevState",void 0),gt(this,"curState",void 0),gt(this,"currentTime",void 0),gt(this,"currentTimeStuckAt",void 0),gt(this,"interruptDetectorTrack",void 0),gt(this,"onLocalAudioTrackMute",()=>{N.info("ios15-interruption-start"),this.emit(Jr.IOS_15_16_INTERRUPTION_START)}),gt(this,"onLocalAudioTrackUnmute",async()=>{N.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?N.info("ios15-interruption-end-canceled"):(jo&&await jo.suspend(),this.emit(Jr.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){N.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){N.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function _E(){if(!jo){if(function(){if(!SM)return void N.error("your browser is not support web audio");N.info("create audio context");const t=_i({},J("WEBAUDIO_INIT_OPTIONS"));N.debug("audio context init option:",JSON.stringify(t)),jo=new SM(t),Dn.curState=jo.state,jo.onstatechange=()=>{Dn.prevState=Dn.curState,Dn.curState=jo?jo.state:void 0;const{prevState:n,curState:r}=Dn,a=r==="running",d=r==="interrupted",l=n==="running",p=n==="suspended",E=n==="interrupted",f=en().osVersion;(Ys()||hi())&&l&&d&&(N.info("ios".concat(f,"-interruption-start")),Dn.emit(Jr.IOS_INTERRUPTION_START)),(Ys()||hi())&&(p||E)&&a&&(N.info("ios".concat(f,"-interruption-end")),Dn.emit(Jr.IOS_INTERRUPTION_END)),n!==r&&Dn.emit(Jr.STATE_CHANGE,r,n)},setInterval(()=>{var n;const r=(n=jo)===null||n===void 0?void 0:n.currentTime;Dn.currentTime!==r?(Dn.currentTimeStuckAt&&(N.debug("AudioContext current time resume at ".concat(r)),Dn.currentTimeStuckAt=void 0),Dn.currentTime=r):(r!==Dn.currentTimeStuckAt&&(ee.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:r},tag:Si.TRACER}).onSuccess(),N.warning("AudioContext current time stuck at ".concat(r))),Dn.currentTimeStuckAt=r)},5e3),async function(n){const r=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let a,d=!1,l=!1,p=!1;function E(k){n.state==="running"?f(!1):Ys()||hi()?n.state==="suspended"&&(f(!0),k&&n.resume().then(T,T)):n.state!=="closed"&&(f(!0),k&&n.resume().then(T,T))}function f(k){if(d!==k){d=k;for(let U=0,G=r;U<G.length;U+=1){const W=G[U];k?window.addEventListener(W,R,{capture:!0,passive:!0}):window.removeEventListener(W,R,{capture:!0,passive:!0})}}}function T(){E(!1)}function R(){E(!0)}function v(k){if(!p)if(a.paused)if(k){let U;y(!1),p=!0;try{U=a.play(),U?U.then(w,w):(a.addEventListener("playing",w),a.addEventListener("abort",w),a.addEventListener("error",w))}catch{w()}}else y(!0);else y(!1)}function y(k){if(l!==k){l=k;for(let U=0,G=r;U<G.length;U++){const W=G[U];k?window.addEventListener(W,B,{capture:!0,passive:!0}):window.removeEventListener(W,B,{capture:!0,passive:!0})}}}function w(){a.removeEventListener("playing",w),a.removeEventListener("abort",w),a.removeEventListener("error",w),p=!1,v(!1)}function B(){v(!0)}if(Ys()){const k=n.createMediaStreamDestination(),U=document.createElement("div");U.innerHTML="<audio x-webkit-airplay='deny'></audio>",a=U.children.item(0),a.controls=!1,a.disableRemotePlayback=!0,a.preload="auto",a.srcObject=k.stream,v(!0)}Dn.on(Jr.STATE_CHANGE,function(){E(!0)}),E(!1)}(jo)}(),!jo)throw new _t(H.NOT_SUPPORTED,"can not create audio context");return jo}return jo}function Hl(t){if(function(){if(Yu!==null)return Yu;const a=_E(),d=a.createBufferSource(),l=a.createGain(),p=a.createGain();d.connect(l),d.connect(p),d.disconnect(l);let E=!1;try{d.disconnect(l)}catch{E=!0}return d.disconnect(),Yu=E,E}())return;const n=t.connect,r=t.disconnect;t.connect=(a,d,l)=>{var p;return t._inputNodes||(t._inputNodes=[]),Mt(p=t._inputNodes).call(p,a)||(a instanceof AudioNode?(t._inputNodes.push(a),n.call(t,a,d,l)):n.call(t,a,d)),t},t.disconnect=(a,d,l)=>{r.call(t),a?vf(t._inputNodes,a):t._inputNodes=[];for(const p of t._inputNodes)n.call(t,p)}}let Yu=null;function dg(t,n){let r=!1;const a=1/n;if(J("DISABLE_WEBAUDIO")){const d=window.setInterval(()=>{r?window.clearInterval(d):t(performance.now()/1e3)},1e3*a)}else{const d=_E();let l=d.createGain();l.gain.value=0,l.connect(d.destination);const p=()=>{if(r)return void(l=null);const E=d.createOscillator();E.onended=p,E.connect(l),E.start(0),E.stop(d.currentTime+a),t(d.currentTime)};p()}return()=>{r=!0}}class RM{constructor(){gt(this,"context",void 0),gt(this,"analyserNode",void 0),gt(this,"sourceNode",void 0),this.context=_E(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(n){if(n!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=n,n==null||n.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Ys()||hi()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const n=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(n);else{const a=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(a);for(let d=0;d<n.length;++d)n[d]=a[d]/128-1}const r=ka(n).call(n,(a,d)=>a+d*d,0)/n.length;return Math.max(10*Math.log10(r)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var n,r;(n=this.sourceNode)===null||n===void 0||n.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(r=this.sourceNode)===null||r===void 0||r.connect(this.analyserNode)}catch{N.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class pw extends An{get processSourceNode(){return this.sourceNode}set processedNode(n){var r;if(!this.isDestroyed&&this._processedNode!==n){try{var a;(a=this.sourceNode)===null||a===void 0||a.disconnect(this.outputNode)}catch{}(r=this._processedNode)===null||r===void 0||r.disconnect(),this._processedNode=n,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),gt(this,"outputNode",void 0),gt(this,"outputTrack",void 0),gt(this,"isPlayed",!1),gt(this,"sourceNode",void 0),gt(this,"context",void 0),gt(this,"audioBufferNode",void 0),gt(this,"destNode",void 0),gt(this,"audioOutputLevel",0),gt(this,"volumeLevelAnalyser",void 0),gt(this,"_processedNode",void 0),gt(this,"playNode",void 0),gt(this,"isDestroyed",!1),gt(this,"onNoAudioInput",void 0),gt(this,"isNoAudioInput",!1),gt(this,"_noAudioInputCount",0),this.context=_E(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Hl(this.outputNode),this.volumeLevelAnalyser=new RM}startGetAudioBuffer(n){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(n),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=r=>{this.emit(Ra.ON_AUDIO_BUFFER,function(a){for(let d=0;d<a.outputBuffer.numberOfChannels;d+=1){const l=a.outputBuffer.getChannelData(d);for(let p=0;p<l.length;p+=1)l[p]=0}return a.inputBuffer}(r))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!nn().webAudioMediaStreamDest)throw new _t(H.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(n){this.context.state!=="running"&&If(()=>{Dn.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=n||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(n>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Ys()||hi()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const r=this.volumeLevelAnalyser.getAnalyserNode();let a;r.getFloatTimeDomainData?(a=new Float32Array(r.fftSize),r.getFloatTimeDomainData(a)):(a=new Uint8Array(r.fftSize),r.getByteTimeDomainData(a));let d=!1;for(let l=0;l<a.length;l++)a[l]!==0&&(d=!0);return d?(this.isNoAudioInput=!1,!0):(await xr(200),await this.checkHasAudioInput(n?n+1:1)&&d)}getAudioVolume(){return this.outputNode.gain.value}setVolume(n){this.outputNode.gain.setValueAtTime(n,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var n,r;(n=this.processedNode)===null||n===void 0||n.disconnect(),(r=this.sourceNode)===null||r===void 0||r.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var n;this.processedNode?(n=this.processedNode)===null||n===void 0||n.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class _w extends pw{get isFreeze(){return!1}constructor(n,r,a){var d;if(super(),gt(this,"sourceNode",void 0),gt(this,"track",void 0),gt(this,"clonedTrack",void 0),gt(this,"audioElement",void 0),gt(this,"isCurrentTrackCloned",!1),gt(this,"isRemoteTrack",!1),gt(this,"originVolumeLevelAnalyser",void 0),gt(this,"rebuildWebAudio",async()=>{if(N.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void N.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>N.info("resume success")),N.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const E=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?E.stop():this.isCurrentTrackCloned=!0;const f=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(f),Hl(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const T=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(T,this.context.currentTime),Hl(this.outputNode),this.emit(Ra.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=f,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),n.kind!=="audio")throw new _t(H.UNEXPECTED_ERROR);this.track=n;const l=new MediaStream([this.track]);if(this.isRemoteTrack=!!r,this.sourceNode=this.context.createMediaStreamSource(l),Hl(this.sourceNode),a){const E=a.clone();E.enabled=!0,this.clonedTrack=E,N.debug("create an unmuted track ".concat(E.id," from the original track ").concat(a.id," to get the volume"));const f=this.context.createMediaStreamSource(new MediaStream([E]));Hl(f),this.originVolumeLevelAnalyser=new RM,this.originVolumeLevelAnalyser.updateSource(f)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=l;const p=en();r&&p.os===Cr.IOS&&Number((d=p.osVersion)===null||d===void 0?void 0:d.split(".")[0])<15&&(Dn.on(Jr.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(E=>{E||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(n){this.sourceNode.disconnect(),this.track=n,this.isCurrentTrackCloned=!1;const r=new MediaStream([n]);this.sourceNode=this.context.createMediaStreamSource(r),Hl(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Ra.UPDATE_SOURCE),this.audioElement.srcObject=r}destroy(){var n;this.audioElement.srcObject=null,this.audioElement.remove(),Dn.off("state-change",this.rebuildWebAudio),(n=this.originVolumeLevelAnalyser)===null||n===void 0||n.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(n){return this.context.createMediaStreamSource(new MediaStream([n]))}updateOriginTrack(n){const r=n.clone();r.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=r),N.debug("create an unmuted track ".concat(r.id," from the original track ").concat(n.id," to get the volume"));const a=this.context.createMediaStreamSource(new MediaStream([r]));Hl(a),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(a)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function Ew(t,n,r){const a=(l,p)=>l?typeof l!="number"?l.max||l.exact||l.ideal||l.min||p:l:p,d={audio:!!r&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:a(n.height,1080),maxWidth:a(n.width,1920)}}};return n.frameRate&&typeof n.frameRate!="number"?(d.video.mandatory.maxFrameRate=n.frameRate.max,d.video.mandatory.minFrameRate=n.frameRate.min):typeof n.frameRate=="number"&&(d.video.mandatory.maxFrameRate=n.frameRate),await navigator.mediaDevices.getUserMedia(d)}async function iG(t,n){const r=await wp(t.mediaSource),{sourceId:a,audio:d}=await function(l){let p=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Bt((E,f)=>{const T=document.createElement("div");T.innerText="share screen",T.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const R=document.createElement("div");R.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const v=document.createElement("div");v.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",v.setAttribute("style","height: 12%;");const y=document.createElement("div");y.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const w=document.createElement("div");w.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const B=document.createElement("button");B.innerHTML="cancel",B.setAttribute("style","width: 85px;"),B.onclick=()=>{document.body.removeChild(G);const W=new Error("NotAllowedError");W.name="NotAllowedError",f(W)};let k=p;const U=document.createElement("div");if(p){const W=document.createElement("input");W.setAttribute("type","checkbox");const $=document.createElement("span");W.setAttribute("style","margin-right: 6px;"),$.innerText="Share audio",W.checked=k,W.onchange=()=>{k=W.checked},U.appendChild(W),U.appendChild($)}w.appendChild(U),w.appendChild(B),R.appendChild(v),R.appendChild(y),R.appendChild(w);const G=document.createElement("div");G.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),G.appendChild(T),G.appendChild(R),document.body.appendChild(G),l.map(W=>{if(W.id){const $=document.createElement("div");$.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let rt=W.thumbnail;try{const{width:ot}=rt.getSize();ot>1920&&(rt=rt.resize({width:1920}))}catch(ot){throw ot&&ot.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),ot}$.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+rt.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+W.name.replace(/[\u00A0-\u9999<>\&]/g,function(ot){return"&#"+ot.charCodeAt(0)+";"})+"</span>",$.onclick=()=>{document.body.removeChild(G),E({sourceId:W.id,audio:k})},y.appendChild($)}})})}(r,n);return await Ew(a,t,d)}async function wp(t){let n=["window","screen"];t!=="application"&&t!=="window"||(n=["window"]),t==="screen"&&(n=["screen"]);const r=pk();if(!r)throw console.error("failed to fetch electron, please mount it to window"),new _t(H.ELECTRON_IS_NULL);let a=null;try{var d;a=((d=r.desktopCapturer)===null||d===void 0?void 0:d.getSources({types:n}))||r.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:n})}catch{a=null}a&&a.then||(a=new Bt((l,p)=>{r.desktopCapturer.getSources({types:n},(E,f)=>{E?p(E):l(f)})}));try{return await a}catch(l){throw new _t(H.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,l.toString())}}const ug=new Yr("safari");let mw=!1,fw=!1;async function vs(t,n){let r=0,a=null;for(;r<2;)try{a=await rG(t,n,r>0);break}catch(d){if(d instanceof _t)throw N.error("[".concat(n,"] ").concat(d.toString())),d;const l=HR(d.name||d.code||d,d.message);if(l.code===H.MEDIA_OPTION_INVALID){N.debug("[".concat(n,"] detect media option invalid, retry")),r+=1,await xr(500);continue}throw N.error("[".concat(n,"] ").concat(l.toString())),l}if(!a)throw new _t(H.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return a}async function rG(t,n,r){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new _t(H.NOT_SUPPORTED,"can not find getUserMedia");r&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const a=nn(),d=new MediaStream;if(t.audioSource&&d.addTrack(t.audioSource),t.videoSource&&d.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return N.debug("Using Video Source/ Audio Source"),d;if(t.screen)if(pk())t.screen.sourceId?EE(d,await Ew(t.screen.sourceId,t.screen,!!t.screenAudio)):EE(d,await iG(t.screen,!!t.screenAudio));else if(Ac()&&t.screen.extensionId&&t.screen.mandatory){if(!a.getStreamFromExtension)throw new _t(H.NOT_SUPPORTED,"This browser does not support screen sharing");N.debug("[".concat(n,'] Screen access on chrome stable, looking for extension"'));const y=await(p=t.screen.extensionId,E=n,new Bt((w,B)=>{try{chrome.runtime.sendMessage(p,{getStream:!0},k=>{if(!k||!k.streamId)return N.error("[".concat(E,"] No response from Chrome Plugin. Plugin not installed properly"),k),void B(new _t(H.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));w(k.streamId)})}catch(k){N.error("[".concat(E,"] AgoraRTC screensharing plugin is not accessible(").concat(p,")"),k.toString()),B(new _t(H.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=y,EE(d,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(a.getDisplayMedia){var l;t.screen.mediaSource&&dw(t.screen.mediaSource);const y={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(l=t.screen.displaySurface)!==null&&l!==void 0?l:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:w,surfaceSwitching:B,systemAudio:k}=t.screen,U={selfBrowserSurface:w,surfaceSwitching:B,systemAudio:k};!w&&delete U.selfBrowserSurface,!B&&delete U.surfaceSwitching,!k&&delete U.systemAudio,N.debug("[".concat(n,"] getDisplayMedia:"),JSON.stringify({video:y,audio:t.screenAudio,controls:U})),EE(d,await navigator.mediaDevices.getDisplayMedia(_i({video:y,audio:t.screenAudio},U)))}else{if(!Ii())throw N.error("[".concat(n,"] This browser does not support screenSharing")),new _t(H.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&dw(t.screen.mediaSource);const y={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};N.debug("[".concat(n,"] getUserMedia: ").concat(JSON.stringify(y))),EE(d,await navigator.mediaDevices.getUserMedia(y))}}var p,E;if(!t.video&&!t.audio)return d;let f={video:t.video,audio:t.audio},T=J("MEDIA_DEVICE_CONSTRAINTS");if(T)try{typeof T=="string"&&(T=JSON.parse(T)),f=ss(f,T)}catch{}N.debug("[".concat(n,"] GetUserMedia"),JSON.stringify(f)),en();let R,v=null;(vr()||Ys()||ff())&&(v=await ug.lock());try{R=await navigator.mediaDevices.getUserMedia(f)}catch(y){throw v&&v(),y}return f.audio&&(mw=!0),f.video&&(fw=!0),EE(d,R),v&&v(),d}function HR(t,n){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new _t(H.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(n));case"NotFoundError":case"DevicesNotFoundError":return new _t(H.DEVICE_NOT_FOUND,"".concat(t,": ").concat(n));case"NotSupportedError":return new _t(H.NOT_SUPPORTED,"".concat(t,": ").concat(n));case"NotReadableError":return new _t(H.NOT_READABLE,"".concat(t,": ").concat(n));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new _t(H.PERMISSION_DENIED,"".concat(t,": ").concat(n));case"ConstraintNotSatisfiedError":return new _t(H.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(n));default:return N.error("getUserMedia unexpected error",t),new _t(H.UNEXPECTED_ERROR,"".concat(t,": ").concat(n))}}function EE(t,n){const r=t.getVideoTracks()[0],a=t.getAudioTracks()[0],d=n.getVideoTracks()[0],l=n.getAudioTracks()[0];l&&(a&&t.removeTrack(a),t.addTrack(l)),d&&(r&&t.removeTrack(r),t.addTrack(d))}const Go=new class extends An{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Wl.STATE_CHANGE,t),this._state=t)}constructor(){super(),gt(this,"_state",nu.IDLE),gt(this,"isAccessMicrophonePermission",!1),gt(this,"isAccessCameraPermission",!1),gt(this,"lastAccessMicrophonePermission",!1),gt(this,"lastAccessCameraPermission",!1),gt(this,"checkdeviceMatched",!1),gt(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(J("ENUMERATE_DEVICES_INTERVAL")||(W_()||pR()===Cr.HARMONY_OS)&&Il())&&this.updateDevicesInfo()},J("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>N.error(t.toString()))}async enumerateDevices(t,n){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new _t(H.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const a=await navigator.mediaDevices.enumerateDevices(),d=this.checkMediaDeviceInfoIsOk(a);let l=!this.isAccessMicrophonePermission&&t,p=!this.isAccessCameraPermission&&n;d.audio&&(l=!1),d.video&&(p=!1);let E=null,f=null,T=null;if(!r&&(l||p)){if(ug.isLocked&&(N.debug("[device manager] wait GUM lock"),(await ug.lock())(),N.debug("[device manager] GUM unlock")),mw&&(l=!1,this.isAccessMicrophonePermission=!0),fw&&(p=!1,this.isAccessCameraPermission=!0),N.debug("[device manager] check media device permissions",t,n,l,p),l&&p){try{T=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(R){const v=HR(R.name||R.code||R,R.message);if(v.code===H.PERMISSION_DENIED)throw v;N.warning("getUserMedia failed in getDevices",v)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(l){try{E=await navigator.mediaDevices.getUserMedia({audio:t})}catch(R){const v=HR(R.name||R.code||R,R.message);if(v.code===H.PERMISSION_DENIED)throw v;N.warning("getUserMedia failed in getDevices",v)}this.isAccessMicrophonePermission=!0}else if(p){try{f=await navigator.mediaDevices.getUserMedia({video:n})}catch(R){const v=HR(R.name||R.code||R,R.message);if(v.code===H.PERMISSION_DENIED)throw v;N.warning("getUserMedia failed in getDevices",v)}this.isAccessCameraPermission=!0}N.debug("[device manager] mic permission",t,"cam permission",n)}try{const R=await navigator.mediaDevices.enumerateDevices();return E&&E.getTracks().forEach(v=>v.stop()),f&&f.getTracks().forEach(v=>v.stop()),T&&T.getTracks().forEach(v=>v.stop()),E=null,f=null,T=null,R}catch(R){return E&&E.getTracks().forEach(v=>v.stop()),f&&f.getTracks().forEach(v=>v.stop()),T&&T.getTracks().forEach(v=>v.stop()),E=null,f=null,T=null,new _t(H.ENUMERATE_DEVICES_FAILED,R.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(n=>n.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(n=>n.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(n=>n.kind==="audiooutput")}searchDeviceIdByName(t){let n=null;return this.deviceInfoMap.forEach(r=>{r.device.label===t&&(n=r.device.deviceId)}),n}async getDeviceById(t){const n=(await this.enumerateDevices(!0,!0,!0)).find(r=>r.deviceId===t);if(!n)throw new _t(H.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return n}async init(){this.state=nu.INITING;try{await this.updateDevicesInfo(),this.state=nu.INITEND}catch(t){throw N.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=nu.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new _t(H.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),n=Date.now(),r=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const d=t.find(p=>p.kind==="audioinput"&&p.deviceId==="default"),l=t.find(p=>p.kind==="audiooutput"&&p.deviceId==="default");d&&l?l.groupId===d.groupId?N.debug("[device-check] default input ".concat(d.label," and output ").concat(l.label," is the same group")):N.debug("[device-check] default input ".concat(d.label," and output ").concat(l.label," is not the same group")):N.debug("[device-check] default input or output not found")}const a=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(d=>{if(!d.deviceId)return;const l=this.deviceInfoMap.get("".concat(d.kind,"_").concat(d.deviceId));if((l?l.state:"INACTIVE")!=="ACTIVE"){const p={initAt:n,updateAt:n,device:d,state:"ACTIVE"};this.deviceInfoMap.set("".concat(d.kind,"_").concat(d.deviceId),p),r.push(p)}l&&(l.updateAt=n)}),this.deviceInfoMap.forEach((d,l)=>{d.state==="ACTIVE"&&d.updateAt!==n&&(d.state="INACTIVE",r.push(d))}),this.state!==nu.INITEND)return a.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(a.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));r.forEach(d=>{switch(d.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Wl.RECORDING_DEVICE_CHANGED,d);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Wl.CAMERA_DEVICE_CHANGED,d);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Wl.PLAYOUT_DEVICE_CHANGED,d)}}),a.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),a.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const n=t.filter(d=>d.kind==="audioinput"),r=t.filter(d=>d.kind==="videoinput"),a={audio:!1,video:!1};for(const d of n)if(d.label&&d.deviceId){a.audio=!0;break}for(const d of r)if(d.label&&d.deviceId){a.video=!0;break}return a}};let gw=!1;const va=new class extends An{constructor(){super(...arguments),gt(this,"onAutoplayFailed",void 0),gt(this,"onAudioAutoplayFailed",void 0)}};function CM(){if(en(),!gw){const t=n=>{n.preventDefault(),gw=!1,ap()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};gw=!0,ap()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),N.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),va.onAutoplayFailed?va.onAutoplayFailed():va.onAudioAutoplayFailed?N.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):N.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),va.emit("autoplay-failed")}}function KR(t,n,r,a){if(!t)return;const d=ee.getBaseInfoBySessionId(t);if(!d)return;const l=d.info,p=Date.now(),E=_i(_i({},l),{},{vid:l.vid===void 0?0:Number(l.vid),lts:p,elapse:p-d.startTime,cbRegistered:va.onAutoplayFailed||va.onAudioAutoplayFailed?1:-1,errorMsg:r,mediaType:n,trackId:a,extend:void 0});ee.send({type:pi.AUTOPLAY_FAILED,data:E},!0)}const sG=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Us=new class{constructor(){gt(this,"onAutoplayFailed",void 0),gt(this,"elementMap",new Map),gt(this,"elementStateMap",new Map),gt(this,"elementsNeedToResume",[]),gt(this,"sinkIdMap",new Map),gt(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(n=>{let[r,a]=n;const d=this.elementStateMap.get(r),l=a.srcObject.getAudioTracks()[0],p=l&&l.readyState;if(N.debug("resume after interrupted, ele: ".concat(d," audio: ").concat(p," ").concat(t)),p==="live"){if(t)return a.pause(),void a.play();if(Dn.curState==="running")return G_()?(a.pause(),void a.play()):void(d&&d==="paused"&&a.play())}})}),gt(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[n,r]=t;const a=r.srcObject.getAudioTracks()[0];a&&a.readyState==="live"&&(N.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),r.pause(),r.play())})}),this.autoResumeAudioElement(),Dn.on(Jr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Dn.on(Jr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Dn.on(Jr.STATE_CHANGE,()=>{Ys()&&Dn.prevState==="suspended"&&Dn.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(t,n){const r=this.elementMap.get(t);if(this.sinkIdMap.set(t,n),r)try{await r.setSinkId(n)}catch(a){throw new _t(H.PERMISSION_DENIED,"can not set sink id: "+a.toString())}}play(t,n,r,a){if(this.elementMap.has(n))return;const d=document.createElement("audio");d.autoplay=!0,d.srcObject=new MediaStream([t]),this.bindAudioElementEvents(n,d),this.elementMap.set(n,d),this.elementStateMap.set(n,Ms.INIT),this.setVolume(n,r);const l=this.sinkIdMap.get(n);if(l)try{d.setSinkId(l).catch(E=>{N.warning("[".concat(n,"] set sink id failed"),E.toString())})}catch(E){N.warning("[".concat(n,"] set sink id failed"),E.toString())}const p=d.play();p&&p.then&&p.catch(E=>{a&&KR(a,"audio",E.message,n),N.warning("audio element play warning",E.toString()),this.elementMap.has(n)&&E.name==="NotAllowedError"&&(N.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(d),If(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),CM()}))})}updateTrack(t,n){const r=this.elementMap.get(t);r&&(r.srcObject=new MediaStream([n]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,n){const r=this.elementMap.get(t);r&&(n=Math.max(0,Math.min(100,n)),r.volume=n/100)}stop(t){const n=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!n)return;const r=this.elementsNeedToResume.indexOf(n);this.elementsNeedToResume.splice(r,1),n.srcObject=null,n.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,n){sG.forEach(r=>{n.addEventListener(r,a=>{const d=this.elementStateMap.get(t),l=a.type==="pause"?"paused":a.type;if(N.debug("[".concat(t,"] audio-element-status change ").concat(d," => ").concat(l)),a.type==="error"){const p=n==null?void 0:n.error;p&&N.error("[".concat(t,"] media error, code: ").concat(p.code,", message: ").concat(p.message))}this.elementStateMap.set(t,l)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach(n=>{n.play().then(r=>{N.debug("Auto resume audio element success")}).catch(r=>{N.warning("Auto resume audio element failed!",r)})}),this.elementsNeedToResume=[]};new Bt(n=>{document.body?n():window.addEventListener("load",()=>n())}).then(()=>{ap()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function Bi(){return function(t,n,r){const a=r.value;return typeof a=="function"&&(r.value=function(){this._isClosed&&new _t(H.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",N);for(var d=arguments.length,l=new Array(d),p=0;p<d;p++)l[p]=arguments[p];const E=a.apply(this,l);return E instanceof Bt?new Bt((f,T)=>{E.then(f).catch(T)}):E}),r}}class ic extends An{constructor(n){super(),gt(this,"name","VideoProcessorDestination"),gt(this,"ID","0"),gt(this,"_source",void 0),gt(this,"videoContext",void 0),gt(this,"inputTrack",void 0),this.videoContext=n}get kind(){return"video"}get enabled(){return!0}pipe(){throw new _t(H.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new _t(H.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(n){if(n.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);n.track&&n.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=n.track,this.emit(Js.ON_TRACK,n.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Js.ON_TRACK,void 0)}}class lg extends An{set chained(n){this._chained=n}get chained(){return this._chained}constructor(n,r){super(),gt(this,"constraintsMap",new Map),gt(this,"statsRegistry",[]),gt(this,"usageRegistry",[]),gt(this,"trackId",void 0),gt(this,"direction",void 0),gt(this,"_chained",!1),this.trackId=n,this.direction=r}async getConstraints(){return await Kr(this,Ca.REQUEST_CONSTRAINTS)}async requestApplyConstraints(n,r){var a;return N.info("processor ".concat(r.name," requestApplyConstraints for ").concat(this.trackId)),n&&this.constraintsMap.set(r,n),On(this,Ca.REQUEST_UPDATE_CONSTRAINTS,Array.from($d(a=this.constraintsMap).call(a)))}async requestRevertConstraints(n){var r;if(this.constraintsMap.has(n))return N.info("processor ".concat(n.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(n),On(this,Ca.REQUEST_UPDATE_CONSTRAINTS,Array.from($d(r=this.constraintsMap).call(r)))}registerStats(n,r,a){this.statsRegistry.find(d=>d.processorID===n.ID&&d.processorName===n.name&&d.type===r)||this.statsRegistry.push({processorName:n.name,processorID:n.ID,type:r,cb:a})}unregisterStats(n,r){const a=this.statsRegistry.findIndex(d=>d.processorID===n.ID&&d.processorName===n.name&&d.type===r);a!==-1&&this.statsRegistry.splice(a,1)}gatherStats(){const n=[];for(const{processorID:r,processorName:a,type:d,cb:l}of this.statsRegistry)try{const p=l();n.push({processorID:r,processorName:a,type:d,stats:p})}catch(p){N.error(new _t(H.UNEXPECTED_ERROR,p.message))}return n}registerUsage(n,r){this.usageRegistry.find(a=>a.processorID===n.ID&&a.processorName===n.name)||this.usageRegistry.push({processorID:n.ID,processorName:n.name,cb:r})}unregisterUsage(n){const r=this.usageRegistry.findIndex(a=>a.processorID===n.ID&&a.processorName===n.name);r!==-1&&this.usageRegistry.splice(r,1)}async gatherUsage(){const n=[];if(!this.chained)return[];for(const{cb:r}of this.usageRegistry)try{let a=r();a instanceof Bt&&(a=await a),n.push(_i(_i({},a),{},{direction:this.direction}))}catch(a){N.error("gather extension usage error",a)}return n}getDirection(){return this.direction}}class rc extends An{constructor(n){super(),gt(this,"name","AudioProcessorDestination"),gt(this,"ID","0"),gt(this,"inputTrack",void 0),gt(this,"inputNode",void 0),gt(this,"audioProcessorContext",void 0),gt(this,"_source",void 0),this.audioProcessorContext=n}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new _t(H.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new _t(H.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Js.ON_TRACK,void 0),this.emit(Js.ON_NODE,void 0)}updateInput(n){if(n.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);n.track&&this.inputTrack!==n.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=n.track,this.emit(Js.ON_TRACK,this.inputTrack)),n.node&&this.inputNode!==n.node&&(this.audioProcessorContext.chained=!0,this.inputNode=n.node,this.emit(Js.ON_NODE,this.inputNode))}}class vM extends An{set chained(n){this._chained=n}get chained(){return this._chained}constructor(n,r,a){super(),gt(this,"constraintsMap",new Map),gt(this,"statsRegistry",[]),gt(this,"audioContext",void 0),gt(this,"trackId",void 0),gt(this,"direction",void 0),gt(this,"usageRegistry",[]),gt(this,"_chained",!1),this.audioContext=n,this.trackId=r,this.direction=a}async getConstraints(){return Kr(this,Ca.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(n,r){var a;return N.info("processor ".concat(r.name," requestApplyConstraints for ").concat(this.trackId)),n&&this.constraintsMap.set(r,n),On(this,Ca.REQUEST_UPDATE_CONSTRAINTS,Array.from($d(a=this.constraintsMap).call(a)))}async requestRevertConstraints(n){var r;if(this.constraintsMap.has(n))return this.constraintsMap.delete(n),On(this,Ca.REQUEST_UPDATE_CONSTRAINTS,Array.from($d(r=this.constraintsMap).call(r)))}registerStats(n,r,a){this.statsRegistry.find(d=>d.processorID===n.ID&&d.processorName===n.name&&d.type===r)||this.statsRegistry.push({processorName:n.name,processorID:n.ID,type:r,cb:a})}unregisterStats(n,r){const a=this.statsRegistry.findIndex(d=>d.processorID===n.ID&&d.processorName===n.name&&d.type===r);a!==-1&&this.statsRegistry.splice(a,1)}gatherStats(){const n=[];for(const{processorID:r,processorName:a,type:d,cb:l}of this.statsRegistry)try{const p=l();n.push({processorID:r,processorName:a,type:d,stats:p})}catch(p){N.error(new _t(H.UNEXPECTED_ERROR,p.message))}return n}registerUsage(n,r){this.usageRegistry.find(a=>a.processorID===n.ID&&a.processorName===n.name)||this.usageRegistry.push({processorID:n.ID,processorName:n.name,cb:r})}unregisterUsage(n){const r=this.usageRegistry.findIndex(a=>a.processorID===n.ID&&a.processorName===n.name);r!==-1&&this.usageRegistry.splice(r,1)}async gatherUsage(){const n=[];if(!this.chained)return[];for(const{cb:r}of this.usageRegistry)try{let a=r();a instanceof Bt&&(a=await a),n.push(_i(_i({},a),{},{direction:this.direction}))}catch(a){N.error("gather extension usage error",a)}return n}getDirection(){return this.direction}}class hg extends An{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),gt(this,"context",void 0),gt(this,"processSourceNode",void 0),gt(this,"outputTrack",void 0),gt(this,"processedNode",void 0),gt(this,"clonedTrack",void 0),gt(this,"outputNode",void 0),this.outputNode=new Tw}setVolume(){}createOutputTrack(){throw new _t(H.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class Tw{disconnect(){}connect(){}}function Op(t){return new Bt((n,r)=>{let a=!1;const d=document.createElement("video");d.setAttribute("autoplay",""),d.setAttribute("muted",""),d.muted=!0,d.autoplay=!0,d.setAttribute("playsinline",""),d.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(d);const l=Ys()?"canplay":"playing";d.addEventListener(l,()=>{const p=d.videoWidth,E=d.videoHeight;!p&&Ii()||(a=!0,d.srcObject=null,d.remove(),n([p,E]))}),d.srcObject=new MediaStream([t]),d.play().catch(RR),setTimeout(()=>{a||(d.srcObject=null,d.remove(),n([d.videoWidth,d.videoHeight]))},4e3)})}function Ia(t){const n={};t.facingMode&&(n.facingMode=t.facingMode),t.cameraId&&(n.deviceId={exact:t.cameraId});const r=fd(t.encoderConfig);return r.width!=null&&(n.width=r.width),r.height!=null&&(n.height=r.height),!lk()&&r.frameRate&&(n.frameRate=r.frameRate),db()&&typeof n.frameRate=="object"&&(n.frameRate.max=60),Ii()&&(n.frameRate={ideal:30,max:30}),n}function IM(t){const n={};return lk()||(t.AGC!==void 0&&(n.autoGainControl=t.AGC),t.AEC!==void 0&&(n.echoCancellation=t.AEC),t.ANS!==void 0&&(n.noiseSuppression=t.ANS,Ac()&&t.ANS&&(n.googHighpassFilter=t.ANS))),n}function yM(t){const n=IM(t);if(t.encoderConfig){const r=cg(t.encoderConfig);n.channelCount=r.stereo?2:1,n.sampleRate=r.sampleRate,n.sampleSize=r.sampleSize}return t.microphoneId&&(n.deviceId={exact:t.microphoneId}),W_()&&(n.sampleRate=void 0),n}const qu=t=>{const n=t._encoderConfig;if(!n)return;const{frameRate:r,width:a,height:d}=t.getMediaStreamTrackSettings();let{frameRate:l=r,width:p=a,height:E=d}=n;if(!l||!p||!E)return;p=hr(p),E=hr(E),l=hr(l);const{max:f,min:T}=function(w,B,k){const U=200*Math.pow(k/15,.6)*Math.pow(w*B/640/360,.75);return{min:Math.floor(U),max:Math.floor(4*U)}}(p,E,l),{bitrateMax:R,bitrateMin:v}=n||{};R||N.debug("calculate bitrate: [w: ".concat(p,", h: ").concat(E,", fps: ").concat(l,"] => [brMax: ").concat(R,", brMin: ").concat(v,"]"));const{maxFramerate:y}=J("ENCODER_CONFIG_LIMIT");return y&&typeof y=="number"&&(l=Math.min(l,y)),{frameRate:l,bitrateMax:R||f,bitrateMin:v||T,scaleResolutionDownBy:1,scale:0}},AM=async(t,n,r)=>await(async(a,d,l)=>{const p=function(T){const R=[];for(let v=0;v<T.length;v+=2)R.push(parseInt(T.slice(v,v+2),16));return Uint8Array.from(R)}(lp(""+d+l)).slice(0,16),E=p.slice(0,12),f=await window.crypto.subtle.importKey("raw",p,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:E},f,a))})(t.buffer,n,r),Sw=t=>{const n=document.createElement("canvas");return n.width=2,n.height=2,new Bt((r,a)=>{n.toBlob(async d=>{if(n.remove(),d){const l=await Rw(d);r({buffer:l,width:n.width,height:n.height})}else a(new _t(H.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,1)})},Rw=async t=>{const n=await t.arrayBuffer();return new Uint8Array(n)};var Cw,bM,pg,wM,OM,mE,YR,_g,NM,vw,sc,Uc,fE,DM,PM,Np,qR,LM,Ri,gE,Eg,kM,zR,Kl,Iw,gd,MM,JR,UM,xM,VM,yw,FM,BM,jM,GM,WM,TE,mg,Xr;let Ai=(Cw=me({argsMap:(t,n)=>[t.getTrackId(),n],throttleTime:300}),bM=me({argsMap:(t,n)=>[t.getTrackId(),n]}),pg=Bi(),wM=Y_("LocalAudioTrack","_enabledMutex"),OM=me({argsMap:(t,n)=>[t.getTrackId(),n]}),mE=Bi(),YR=Y_("LocalAudioTrack","_enabledMutex"),_g=me({argsMap:(t,n)=>[t.getTrackId(),n]}),NM=Bi(),vw=Bi(),sc=Bi(),Uc=me({argsMap:t=>[t.getTrackId()]}),fE=Bi(),DM=me({argsMap:t=>[t.getTrackId()]}),PM=Bi(),Np=me({argsMap:t=>[t.getTrackId()]}),qR=me({argsMap:(t,n)=>[t.getTrackId(),n.name]}),LM=me({argsMap:t=>[t.getTrackId()]}),$e((Ri=class extends pE{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Us.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,n,r,a){super(t,r),gt(this,"trackMediaType",bp.AUDIO),gt(this,"_encoderConfig",void 0),gt(this,"_trackSource",void 0),gt(this,"_enabled",!0),gt(this,"_volume",100),gt(this,"_useAudioElement",!0),gt(this,"_bypassWebAudio",!1),gt(this,"processor",void 0),gt(this,"_processorContext",void 0),gt(this,"_processorDestination",void 0),gt(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=n,this._getOriginVolumeLevel=!!a,this._trackSource=new hg,J("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),J("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),vr()&&!jo?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){yn(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&Us.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void N.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const n=this._source.createOutputTrack();this._mediaStreamTrack!==n&&(this._mediaStreamTrack=n,On(this,Wt.NEED_REPLACE_TRACK,this).then(()=>{N.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(r=>{N.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),r)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!jl())throw new _t(H.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Us.setSinkID(this.getTrackId(),t)}async setEnabled(t,n,r){return this._setEnabled(t,n,r)}async _setEnabled(t,n,r){if(!r){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(N.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{r||(this._enabled=!0),await On(this,Wt.NEED_ENABLE_TRACK,this),N.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(a){throw r||(this._enabled=!1),N.error("[".concat(this.getTrackId(),"] setEnabled to true error"),a.toString()),a}}else{this._originMediaStreamTrack.enabled=!1,r||(this._enabled=!1);try{await On(this,Wt.NEED_DISABLE_TRACK,this)}catch(a){throw r||(this._enabled=!0),N.error("[".concat(this.getTrackId(),"] setEnabled to false error"),a.toString()),a}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,N.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await On(this,Wt.NEED_MUTE_TRACK,this):await On(this,Wt.NEED_UNMUTE_TRACK,this))}getStats(){return Al(()=>{N.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Vo(this,Wt.GET_STATS)||_i({},uw)}setAudioFrameCallback(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Ra.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(n),this._source.removeAllListeners(Ra.ON_AUDIO_BUFFER),this._source.on(Ra.ON_AUDIO_BUFFER,r=>t(r))}play(){N.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(N.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Us.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){N.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Us.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];N.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Us.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,n){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await On(this,Wt.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return Bt.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new _t(H.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new _t(H.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const n=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,n.reset()}bindProcessorDestinationEvents(t){t.on(Js.ON_TRACK,async n=>{n?n!==this._mediaStreamTrack&&(this._mediaStreamTrack=n,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(n),await On(this,Wt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await On(this,Wt.NEED_REPLACE_TRACK,this))}),t.on(Js.ON_NODE,n=>{this._source.processedNode=n})}unbindProcessorDestinationEvents(t){t.removeAllListeners(Js.ON_TRACK),t.removeAllListeners(Js.ON_NODE)}bindProcessorContextEvents(t){t.on(Ca.REQUEST_CONSTRAINTS,async n=>{n(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(t){t.removeAllListeners(Ca.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof hg&&(this._trackSource=new _w(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const t=new vM(this._source.context,this.getTrackId(),"local"),n=new rc(t);return this._processorContext=t,this._processorDestination=n,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(n),this._source.on(Ra.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Us.stop(this.getTrackId()),this._source.play()),On(this,Wt.NEED_REPLACE_MIXING_TRACK,this).then(()=>{N.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(r=>{N.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),r)})),{processorContext:t,processorDestination:n}}}).prototype,"setVolume",[Cw],Object.getOwnPropertyDescriptor(Ri.prototype,"setVolume"),Ri.prototype),$e(Ri.prototype,"setPlaybackDevice",[bM,pg],Object.getOwnPropertyDescriptor(Ri.prototype,"setPlaybackDevice"),Ri.prototype),$e(Ri.prototype,"setEnabled",[wM,OM,mE],Object.getOwnPropertyDescriptor(Ri.prototype,"setEnabled"),Ri.prototype),$e(Ri.prototype,"setMuted",[YR,_g,NM],Object.getOwnPropertyDescriptor(Ri.prototype,"setMuted"),Ri.prototype),$e(Ri.prototype,"getStats",[vw],Object.getOwnPropertyDescriptor(Ri.prototype,"getStats"),Ri.prototype),$e(Ri.prototype,"setAudioFrameCallback",[sc],Object.getOwnPropertyDescriptor(Ri.prototype,"setAudioFrameCallback"),Ri.prototype),$e(Ri.prototype,"play",[Uc,fE],Object.getOwnPropertyDescriptor(Ri.prototype,"play"),Ri.prototype),$e(Ri.prototype,"stop",[DM,PM],Object.getOwnPropertyDescriptor(Ri.prototype,"stop"),Ri.prototype),$e(Ri.prototype,"close",[Np],Object.getOwnPropertyDescriptor(Ri.prototype,"close"),Ri.prototype),$e(Ri.prototype,"pipe",[qR],Object.getOwnPropertyDescriptor(Ri.prototype,"pipe"),Ri.prototype),$e(Ri.prototype,"unpipe",[LM],Object.getOwnPropertyDescriptor(Ri.prototype,"unpipe"),Ri.prototype),Ri),SE=(gE=me({argsMap:(t,n)=>[t.getTrackId(),n]}),Eg=Bi(),kM=Y_("MicrophoneAudioTrack","_enabledMutex"),zR=me({argsMap:(t,n,r)=>[t.getTrackId(),n,r]}),Kl=Bi(),Iw=me({argsMap:t=>[t.getTrackId()]}),$e((gd=class extends Ai{get __className__(){return"MicrophoneAudioTrack"}constructor(t,n,r,a){super(t,n.encoderConfig?cg(n.encoderConfig):{},a,J("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),gt(this,"_config",void 0),gt(this,"_deviceName","default"),gt(this,"_constraints",void 0),gt(this,"_originalConstraints",void 0),gt(this,"_enabled",!0),this._config=n,this._constraints=r,this._originalConstraints=r,this._deviceName=t.label,typeof n.bypassWebAudio=="boolean"&&(this._bypassWebAudio=n.bypassWebAudio),(G_()||ER())&&Dn.bindInterruptDetectorTrack(this)}async setDevice(t){if(N.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const n=await Go.getDeviceById(t),r={};r.audio=_i({},this._constraints),r.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let a=null;try{a=await vs(r,this.getTrackId())}catch(d){throw N.error("[".concat(this.getTrackId(),"] setDevice failed"),d.toString()),a=await vs({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),d}await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),this._deviceName=n.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(n){throw N.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await Go.getDeviceById(t);this._deviceName=n.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(n){throw N.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}N.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,n,r){if(n)return N.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!r){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(N.info("[".concat(this.getTrackId(),"] start setEnabled"),t),J("AUTO_RESET_AUDIO_ROUTE")&&(Ys()||hi())){const p=navigator.audioSession;p&&(t||(p.type="playback"),p.type="auto")}if(!t){var a;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(a=this._source.clonedTrack)===null||a===void 0||a.stop(),r||(this._enabled=!1);try{await On(this,Wt.NEED_DISABLE_TRACK,this)}catch(p){throw N.error("[".concat(this.getTrackId(),"] setEnabled false failed"),p.toString()),p}return}const d=_i({},this._constraints),l=Go.searchDeviceIdByName(this._deviceName);l&&!d.deviceId&&(d.deviceId=l);try{r||(this._enabled=!0);const p=await vs({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(p.getAudioTracks()[0],!1),await On(this,Wt.NEED_ENABLE_TRACK,this)}catch(p){throw r||(this._enabled=!1),N.error("[".concat(this.getTrackId(),"] setEnabled true failed"),p.toString()),p}N.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(G_()||ER())&&Dn.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Ys()||hi())&&this._enabled&&!this._isClosed&&Dn.duringInterruption){const t=async()=>{Dn.off(Jr.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(N.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Dn.on(Jr.IOS_INTERRUPTION_END,t)}else N.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(no.TRACK_ENDED)}async renewMediaStreamTrack(t){const n=t||this._constraints,r=Go.searchDeviceIdByName(this._deviceName);if(r&&!n.deviceId&&(n.deviceId=r),this._constraints=n,this._enabled){this._originMediaStreamTrack.stop();const a=await vs({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!0)}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(Ca.REQUEST_UPDATE_CONSTRAINTS,async(n,r,a)=>{try{const d=Object.assign({},this._originalConstraints,...n);await this.renewMediaStreamTrack(d),r()}catch(d){a(d)}})}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(Ca.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[gE,Eg],Object.getOwnPropertyDescriptor(gd.prototype,"setDevice"),gd.prototype),$e(gd.prototype,"setEnabled",[kM,zR,Kl],Object.getOwnPropertyDescriptor(gd.prototype,"setEnabled"),gd.prototype),$e(gd.prototype,"close",[Iw],Object.getOwnPropertyDescriptor(gd.prototype,"close"),gd.prototype),gd),Yl=(MM=me({argsMap:(t,n)=>[t.getTrackId(),n,t.duration]}),JR=Bi(),UM=me({argsMap:t=>[t.getTrackId()]}),xM=Bi(),VM=me({argsMap:t=>[t.getTrackId()]}),yw=Bi(),FM=me({argsMap:t=>[t.getTrackId()]}),BM=Bi(),jM=me({argsMap:t=>[t.getTrackId()]}),GM=Bi(),WM=me({argsMap:t=>[t.getTrackId()]}),TE=me({argsMap:t=>[t.getTrackId()]}),mg=Bi(),$e((Xr=class extends Ai{get __className__(){return"BufferSourceAudioTrack"}constructor(t,n,r,a){super(n.createOutputTrack(),r,a),gt(this,"source",void 0),gt(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=n,this._bufferSource.on(Ra.AUDIO_SOURCE_STATE_CHANGE,d=>{this.safeEmit(no.SOURCE_STATE_CHANGE,d)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){yn(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[MM,JR],Object.getOwnPropertyDescriptor(Xr.prototype,"startProcessAudioBuffer"),Xr.prototype),$e(Xr.prototype,"pauseProcessAudioBuffer",[UM,xM],Object.getOwnPropertyDescriptor(Xr.prototype,"pauseProcessAudioBuffer"),Xr.prototype),$e(Xr.prototype,"seekAudioBuffer",[VM,yw],Object.getOwnPropertyDescriptor(Xr.prototype,"seekAudioBuffer"),Xr.prototype),$e(Xr.prototype,"resumeProcessAudioBuffer",[FM,BM],Object.getOwnPropertyDescriptor(Xr.prototype,"resumeProcessAudioBuffer"),Xr.prototype),$e(Xr.prototype,"stopProcessAudioBuffer",[jM,GM],Object.getOwnPropertyDescriptor(Xr.prototype,"stopProcessAudioBuffer"),Xr.prototype),$e(Xr.prototype,"close",[WM],Object.getOwnPropertyDescriptor(Xr.prototype,"close"),Xr.prototype),$e(Xr.prototype,"setAudioBufferPlaybackSpeed",[TE,mg],Object.getOwnPropertyDescriptor(Xr.prototype,"setAudioBufferPlaybackSpeed"),Xr.prototype),Xr);class Hi extends Ai{get __className__(){return"MixingAudioTrack"}get isActive(){for(const n of this.trackList)if(n._enabled&&!n._isClosed&&!n.muted)return!0;return!1}constructor(){const n=_E().createMediaStreamDestination();super(n.stream.getAudioTracks()[0],void 0,Vn(8,"track-mix-")),gt(this,"trackList",void 0),gt(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=n,this.trackList=[]}hasAudioTrack(n){return this.trackList.indexOf(n)!==-1}addAudioTrack(n){this.trackList.indexOf(n)===-1?(N.debug("add ".concat(n.getTrackId()," to mixing track")),n._source.outputNode.connect(this.destNode),this.trackList.push(n),this.updateEncoderConfig()):N.debug("track ".concat(n.getTrackId()," is already added"))}removeAudioTrack(n){if(this.trackList.indexOf(n)!==-1){N.debug("remove ".concat(n.getTrackId()," from mixing track"));try{n._source.outputNode.disconnect(this.destNode)}catch{}vf(this.trackList,n),this.updateEncoderConfig()}}updateEncoderConfig(){const n={};this.trackList.forEach(r=>{r._encoderConfig&&((r._encoderConfig.bitrate||0)>(n.bitrate||0)&&(n.bitrate=r._encoderConfig.bitrate),(r._encoderConfig.sampleRate||0)>(n.sampleRate||0)&&(n.sampleRate=r._encoderConfig.sampleRate),(r._encoderConfig.sampleSize||0)>(n.sampleSize||0)&&(n.sampleSize=r._encoderConfig.sampleSize),r._encoderConfig.stereo&&(n.stereo=!0))}),this._encoderConfig=n}_updateRtpTransceiver(n){this._rtpTransceiver!==n&&(this._rtpTransceiver=n,this.trackList.forEach(r=>{r instanceof Hi?r.emit(Ku.TRANSCEIVER_UPDATED,n):r._updateRtpTransceiver(n)}))}}class fg extends pw{set currentState(n){n!==this._currentState&&(this._currentState=n,this.safeEmit(Ra.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(n){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),gt(this,"audioBuffer",void 0),gt(this,"sourceNode",void 0),gt(this,"startPlayTime",0),gt(this,"startPlayOffset",0),gt(this,"pausePlayTime",0),gt(this,"options",void 0),gt(this,"currentLoopCount",0),gt(this,"currentPlaybackSpeed",100),gt(this,"_currentState","stopped"),this.audioBuffer=n,this.options=r,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(n){this.currentState==="stopped"?(this.options=n,this.startPlayOffset=this.options.startPlayTime||0):N.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(n){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=n,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=n))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(n){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=n/100),this.currentPlaybackSpeed=n}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const n=this.context.createBufferSource();return n.buffer=this.audioBuffer,n.loop=!!this.options.loop,n.connect(this.outputNode),n.playbackRate.value=this.currentPlaybackSpeed/100,n}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const Aw=new Map;class bw{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const n=this.renderStats.curTs-this.renderStats.lastTs,r=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/n;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,r}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(n){n!==this._videoElementStatus&&(N.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(n)),this._videoElementStatus=n)}get videoState(){return this._videoState}set videoState(n){var r;n!==this._videoState&&(this._videoState=n,(r=this.onVideoStateChanged)===null||r===void 0||r.call(this,this.videoState))}constructor(n){gt(this,"trackId",void 0),gt(this,"config",void 0),gt(this,"onFirstVideoFrameDecoded",void 0),gt(this,"onVideoStateChanged",void 0),gt(this,"freezeTimeCounterList",[]),gt(this,"renderFreezeAccTime",0),gt(this,"isKeepLastFrame",!1),gt(this,"timeUpdatedCount",0),gt(this,"freezeTime",0),gt(this,"playbackTime",0),gt(this,"lastTimeUpdatedTime",0),gt(this,"autoplayFailed",!1),gt(this,"videoTrack",void 0),gt(this,"videoElement",void 0),gt(this,"cacheVideoElement",void 0),gt(this,"renderStats",void 0),gt(this,"_videoState",iu.VideoStateStopped),gt(this,"videoElementCheckInterval",void 0),gt(this,"videoElementFreezeTimeout",void 0),gt(this,"_videoElementStatus",Ms.NONE),gt(this,"isGettingVideoDimensions",!1),gt(this,"startGetVideoDimensions",()=>{const r=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return N.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(r,500)};!this.isGettingVideoDimensions&&r()}),gt(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Dn.curState==="running"&&(N.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(cb())),uk()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),gt(this,"handleVideoEvents",r=>{switch(r.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Ms.PLAYING;break;case"loadeddata":if(this.videoState=iu.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Ms.CANPLAY;break;case"stalled":this.videoElementStatus=Ms.STALLED;break;case"suspend":this.videoElementStatus=Ms.SUSPEND;break;case"pause":this.videoElementStatus=Ms.PAUSED,Ys()||hi()||vr()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(N.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Ms.WAITING;break;case"abort":this.videoElementStatus=Ms.ABORT;break;case"ended":this.videoElementStatus=Ms.ENDED;break;case"emptied":this.videoElementStatus=Ms.EMPTIED;break;case"error":{const a=this.videoElement.error;a&&(this.videoElementStatus=Ms.ERROR,N.error("[".concat(this.trackId,"] media error: ").concat(a.message," (").concat(a.code,")")));break}case"timeupdate":{const a=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=a);const d=a-this.lastTimeUpdatedTime,l=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=a,zu.lastVisibleTime<zu.lastHiddenTime||l<zu.lastHiddenTime||l<zu.lastVisibleTime)return;for(d>J("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=d),this.playbackTime+=d;this.playbackTime>=6e3;){this.playbackTime-=6e3;const p=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(p),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),gt(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(N.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(cb())),uk()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=n.trackId,this.config=n,n.element instanceof HTMLVideoElement?this.videoElement=n.element:this.videoElement=document.createElement("video"),Dn.on(Jr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Dn.on(Jr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var n;return(n=this.videoElement.parentElement)!==null&&n!==void 0?n:void 0}updateConfig(n){this.config=n,this.trackId=n.trackId,n.element!==this.videoElement&&(this.destroy(),this.videoElement=n.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(n){this.videoTrack!==n&&(this.videoTrack=n,this.initVideoElement())}play(n){const r=this.videoElement.play();r&&r.catch&&r.catch(d=>{n&&KR(n,"video",d.message,this.trackId),d.name==="NotAllowedError"?(N.warning("detected video element autoplay failed",d),this.autoplayFailed=!0,this.handleAutoPlayFailed()):N.warning("[".concat(this.trackId,"] play warning: "),d)});const a=en();if((a.name==="Safari"&&Number(a.version)===15||G_())&&r&&r.then){const d=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};r.then(d).catch(d)}}getCurrentFrame(){const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const r=n.getContext("2d");if(!r)return N.error("create canvas context failed!"),new ImageData(2,2);r.drawImage(this.videoElement,0,0,n.width,n.height);const a=r.getImageData(0,0,n.width,n.height);return n.remove(),a}async getCurrentFrameToUint8Array(n){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const a=document.createElement("canvas");a.width=this.videoElement.videoWidth,a.height=this.videoElement.videoHeight;const d=a.getContext("2d");return d?(d.drawImage(this.videoElement,0,0,a.width,a.height),new Bt((l,p)=>{a.toBlob(async E=>{if(a.remove(),E){const f=await Rw(E);l({buffer:f,width:a.width,height:a.height})}else p(new _t(H.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},n,r<0?.1:r>1?1:r)})):await Sw(n)}destroy(){this.renderStats=void 0,Dn.off(Jr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Dn.off(Jr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=iu.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Ms.INIT,!this.videoElementCheckInterval&&(XR.forEach(l=>{this.videoElement.addEventListener(l,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(l){return l!==document.body&&document.body.contains(l)})(this.videoElement)||(this.videoElementStatus=Ms.DESTROYED)},1e3),J("ENABLE_VIDEO_FRAME_CALLBACK"))){var n,r;let l;const p=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",p),this.videoElementFreezeTimeout=window.setTimeout(E,J("VIDEO_FREEZE_DURATION")))},E=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===iu.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=iu.VideoStateFrozen:document.addEventListener("visibilitychange",p))},f=(T,R)=>{if(this.videoElementStatus===Ms.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=R.mediaTime):this.renderStats={lastTs:R.mediaTime,curTs:R.mediaTime,lastRenderNum:0,renderNum:0},l){const w=R.presentationTime-l.presentationTime;this.videoState===iu.VideoStateStarting&&(this.videoState=iu.VideoStateDecoding),this.videoState===iu.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(E,J("VIDEO_FREEZE_DURATION"))),w<J("VIDEO_FREEZE_DURATION")&&this.videoState===iu.VideoStateFrozen&&(this.videoState=iu.VideoStateDecoding),w>J("VIDEO_FREEZE_DURATION")&&zu.lastVisibleTime>=zu.lastHiddenTime&&l.timestamp>zu.lastVisibleTime&&l.timestamp>zu.lastHiddenTime&&(this.renderFreezeAccTime+=w)}l=_i(_i({},R),{},{timestamp:T})}var v,y;J("ENABLE_VIDEO_FRAME_CALLBACK")&&((v=(y=this.videoElement).requestVideoFrameCallback)===null||v===void 0||v.call(y,f))};(n=(r=this.videoElement).requestVideoFrameCallback)===null||n===void 0||n.call(r,f)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),W_()&&!J("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const a=en();a.name==="Safari"&&Number(a.version)===15||G_()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ii()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ii()&&this.videoElement.load());const d=this.videoElement.play();d!==void 0&&d.catch(l=>{N.debug("[".concat(this.trackId,"] playback interrupted"),l.toString())})}resetVideoElement(){XR.forEach(n=>{this.videoElement&&this.videoElement.removeEventListener(n,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Ms.NONE}handleAutoPlayFailed(){const n=r=>{r.preventDefault(),this.videoElement.play().then(()=>{N.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(a=>{N.error(a)}),this.autoplayFailed=!1,ap()?document.body.removeEventListener("click",n,!0):(document.body.removeEventListener("touchstart",n,!0),document.body.removeEventListener("mousedown",n,!0))};ap()?document.body.addEventListener("click",n,!0):(document.body.addEventListener("touchstart",n,!0),document.body.addEventListener("mousedown",n,!0)),CM()}}const XR=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class ww extends bw{constructor(n){super(n),gt(this,"container",void 0),gt(this,"slot",void 0),this.slot=n.element,this.updateConfig(n)}updateConfig(n){this.config=n,this.trackId=n.trackId;const r=n.element;r!==this.slot&&(this.destroy(),this.slot=r),this.createElements()}updateVideoTrack(n){this.videoTrack!==n&&(this.videoTrack=n,this.createElements())}play(n){var r;(r=this.container)!==null&&r!==void 0&&r.contains(this.videoElement)&&super.play(n)}getCurrentFrame(){var n;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(n){var r;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(r=this.container)!==null&&r!==void 0&&r.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(n,a):await Sw(n)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",J("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var n;!this.container||(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var n;if((n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var QR,Ow,Nw,ZR,Dw,Pw,gg,Tg,$R,tC,eC,nC,Lw,iC,Dp,Td,kw,ql,ru,rC,Pp,To,oc,Mw,Je,HM,KM,YM,Uw,qM,xw,Vw,Sg,io;let qn=(QR=me({argsMap:(t,n,r)=>[t.getTrackId(),typeof n=="string"?n:n instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",r]}),Ow=Bi(),Nw=me({argsMap:t=>[t.getTrackId()]}),ZR=Y_("LocalVideoTrack","_enabledMutex"),Dw=me({argsMap:(t,n)=>[t.getTrackId(),n]}),Pw=Bi(),gg=Y_("LocalVideoTrack","_enabledMutex"),Tg=me({argsMap:(t,n)=>[t.getTrackId(),n]}),$R=Bi(),tC=me({argsMap:(t,n)=>[t.getTrackId(),n]}),eC=Bi(),nC=Bi(),Lw=me({argsMap:(t,n,r)=>[t.getTrackId(),n,r]}),iC=Bi(),Dp=Bi(),Td=Bi(),kw=Bi(),ql=Bi(),ru=Bi(),rC=Bi(),Pp=me({argsMap:(t,n)=>[t.getTrackId(),n.name]}),To=me({argsMap:t=>[t.getTrackId()]}),oc=me({argsMap:t=>[t.getTrackId()]}),Mw=me({argsMap:(t,n,r)=>[t.getTrackId(),n.label,r]}),Je=class d5 extends pE{get videoHeight(){if(vr()){const{height:n}=this._mediaStreamTrack.getSettings();return this._videoHeight=n,this._videoHeight}return this._videoHeight}get videoWidth(){if(vr()){const{width:n}=this._mediaStreamTrack.getSettings();return this._videoWidth=n,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Ms.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(n){this._processorContext=n}get __className__(){return"LocalVideoTrack"}constructor(n,r,a,d,l,p){if(super(n,l),gt(this,"trackMediaType",bp.VIDEO),gt(this,"_player",void 0),gt(this,"isUseScaleResolutionDownBy",!1),gt(this,"_videoVisibleTimer",null),gt(this,"_previousVideoVisibleStatus",void 0),gt(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),gt(this,"_encoderConfig",void 0),gt(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),gt(this,"_optimizationMode",void 0),gt(this,"_videoHeight",void 0),gt(this,"_videoWidth",void 0),gt(this,"_forceBitrateLimit",void 0),gt(this,"_enabled",!0),gt(this,"_processorDestination",void 0),gt(this,"_processorContext",void 0),vr()){const{width:E,height:f}=n.getSettings();this._videoWidth=E,this._videoHeight=f}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=r,this._scalabilityMode=a,this._optimizationMode=d,this._hints=p||[],this._hints.indexOf(vn.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(E,f,T){const R=en();return!(R.name!==E||!R.osVersion)&&Number(R.version)===f}(mn.CHROME,115)&&pR().indexOf("Windows")!==-1){const E=function(f,T){if("VideoFrame"in window&&"TransformStream"in window&&nn().supportWebRTCInsertableStream){const R=new MediaStreamTrackProcessor(f),v=new MediaStreamTrackGenerator({kind:"video"});let y,w,B=Date.now();const k=()=>{U&&(clearInterval(U),U=void 0),y&&(y.close(),y=void 0),f.stop(),w=void 0,v.removeEventListener("ended",k)};let U=window.setInterval(()=>{if(w&&y&&Date.now()-B>1e3)try{v.readyState==="live"?w.enqueue(y.clone()):k()}catch{k()}},1e3);const G=new TransformStream({transform:(W,$)=>{v.readyState==="live"?(w=$,B=Date.now(),y===void 0?(y=W,$.enqueue(W.clone())):($.enqueue(y),y=W)):W.close()}});return v.addEventListener("ended",k),R.readable.pipeThrough(G).pipeTo(v.writable),v}}(n);E&&(N.info("local screen video track begin to inject frame"),this._mediaStreamTrack=E)}r&&this._hints.indexOf(vn.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(r),this._processorContext=new lg(this.getTrackId(),"local"),this._processorDestination=new ic(this.processorContext),this.bindProcessorDestinationEvents()}play(n){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof n=="string"){const d=document.getElementById(n);d?n=d:(N.warning("[".concat(this.getTrackId(),'] can not find "#').concat(n,'" element, use document.body')),n=document.body)}N.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(n instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(r));const a=_i(_i(_i({},this._getDefaultPlayerConfig()),r),{},{trackId:this.getTrackId(),element:n});this._player?this._player.updateConfig(a):(n instanceof HTMLVideoElement?this._player=new bw(a):this._player=new ww(a),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const d=this.getVideoElementVisibleStatus();this.safeEmit(no.VIDEO_ELEMENT_VISIBLE_STATUS,d)}catch{}},J("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,N.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(n,r){if(!r){if(n===this._enabled)return;this.stateCheck("enabled",n)}if(N.info("[".concat(this.getTrackId(),"] start setEnabled"),n),!n){this._originMediaStreamTrack.enabled=!1;try{await On(this,Wt.NEED_DISABLE_TRACK,this)}catch(a){throw N.error("[".concat(this.getTrackId(),"] setEnabled to false error"),a.toString()),a}return r||(this._enabled=!1),void N.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await On(this,Wt.NEED_ENABLE_TRACK,this)}catch(a){throw N.error("[".concat(this.getTrackId(),"] setEnabled to true error"),a.toString()),a}N.info("[".concat(this.getTrackId(),"] setEnabled to true success")),r||(this._enabled=!0)}async setMuted(n){n!==this._muted&&(this.stateCheck("muted",n),this._muted=n,this._originMediaStreamTrack.enabled=!n,N.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(n)),n?await On(this,Wt.NEED_MUTE_TRACK,this):await On(this,Wt.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(n,r){if(!this._enabled)throw new _t(H.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(n=fd(n),this._forceBitrateLimit&&(n.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:n.bitrateMax,n.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:n.bitrateMin),n.width||n.height||n.frameRate){const a=Ia({encoderConfig:n});(vr()||Ys()||hi())&&(a.deviceId=void 0),N.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(n),JSON.stringify(a));try{await this._originMediaStreamTrack.applyConstraints(a),this.updateMediaStreamTrackResolution()}catch(d){const l=new _t(H.UNEXPECTED_ERROR,d.toString());throw N.error("[".concat(this.getTrackId(),"] applyConstraints error"),l.toString()),l}}this._encoderConfig=n,this._hints.indexOf(vn.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await On(this,Wt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(a){return a.throw(N)}}getStats(){return Al(()=>{N.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Vo(this,Wt.GET_STATS)||_i({},lw)}async setBeautyEffect(n){N.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(n){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(n,r):await Sw(n)}async setBitrateLimit(n){if(N.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(n))),n){this._forceBitrateLimit=n,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<n.max_bitrate?this._encoderConfig.bitrateMax:n.max_bitrate:this._encoderConfig.bitrateMax=n.max_bitrate,this._encoderConfig.bitrateMin=n.min_bitrate);try{await On(this,Wt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(N)}}}async setOptimizationMode(n){if(n!=="motion"&&n!=="detail"&&n!=="balanced")return void N.error(H.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const r=this._optimizationMode;try{this._optimizationMode=n,await On(this,Wt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(a){throw this._optimizationMode=r,N.error("[".concat(this.getTrackId(),"] set optimization mode failed"),a.toString()),a}N.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(n,")"))}setScalabiltyMode(n){if(n.numSpatialLayers===1&&n.numTemporalLayers!==1)return N.error(H.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=n,N.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(n,")"))}updateMediaStreamTrackResolution(){Op(this._originMediaStreamTrack).then(n=>{let[r,a]=n;this._videoHeight=a,this._videoWidth=r}).catch(RR)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(n){if(!this._enabled)throw new _t(H.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");N.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(n)),n=fd(n),this._forceBitrateLimit&&(n.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:n.bitrateMax,n.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:n.bitrateMin),this._encoderConfig=n,this._hints.indexOf(vn.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await On(this,Wt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(N)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:n,height:r,frameRate:a}=this.getMediaStreamTrackSettings();if(!n||!r||!a)return;const{bitrateMax:d,bitrateMin:l}=this._encoderConfig;if(l==null||d==null){const{max:p,min:E}=function(f,T,R,v,y){const w=J("BITRATE_ADAPTER_TYPE");if(w==="DEFAULT_BITRATE")return{min:v,max:y};if(y===void 0){var B;const U=Math.floor(200*Math.pow(R/15,.6)*Math.pow(f*T/640/360,.75));y=w==="STANDARD_BITRATE"?4*U:2*U,v=(B=v)!==null&&B!==void 0?B:U}else{var k;v=(k=v)!==null&&k!==void 0?k:Math.floor(y/10)}return{min:v,max:y}}(n,r,a,l,d);this._encoderConfig.bitrateMin=E,this._encoderConfig.bitrateMax=p,N.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(n,", h: ").concat(r,", fps: ").concat(a,"] => [brMax: ").concat(p,", brMin: ").concat(E,"]"))}}getVideoElementVisibleStatus(){try{var n,r;const a=this==null||(n=this._player)===null||n===void 0?void 0:n.getContainerElement(),d={track:this,element:this==null||(r=this._player)===null||r===void 0?void 0:r.getVideoElement(),slot:a==null?void 0:a.parentElement},{element:l,slot:p}=d;if(this.isPlaying&&l instanceof HTMLVideoElement&&p instanceof HTMLElement){const E=zd.checkOneElementVisible(l),f=Object.assign({},E);if(f.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=f.visible;const T=ee.reportApiInvoke(null,{tag:Si.TRACER,name:Gi.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});f.visible?T.onSuccess("Video is visible"):T.onSuccess("Invisible because of ".concat(f.reason))}return f}return}catch(a){throw new _t(H.GET_VIDEO_ELEMENT_VISIBLE_ERROR,a.message)}}async renewMediaStreamTrack(n){}pipe(n){if(this.processor===n)return n;if(n._source)throw new _t(H.INVALID_OPERATION,"Processor ".concat(n.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=n,this.processor._source=this,n.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),n}unpipe(){if(!this.processor)return;const n=this.processor;this.processor._source=void 0,this.processor=void 0,n.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(n){let r=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],a=this._encoderConfig;n&&(a=_i(_i({},a),fd(n))),a=up(a);const d=Vn(8,"track-video-cloned-"),l=new d5(r?this._mediaStreamTrack.clone():this._mediaStreamTrack,a,up(this._scalabilityMode),this._optimizationMode,d,up(this._hints));return n&&a&&l.setEncoderConfiguration(a),N.debug("clone video track from ".concat(this.getTrackId()," to ").concat(d,", clone ").concat(r)),l}async replaceTrack(n,r){if(!(n instanceof MediaStreamTrack))throw new _t(H.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(n.kind!=="video")throw new _t(H.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(n,r,!0),this.updateMediaStreamTrackResolution()}sendSeiData(n){if(Al(()=>{ee.reportApiInvoke(null,{name:Gi.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Si.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!J("ENABLE_VIDEO_SEI")||!J("ENABLE_ENCODED_TRANSFORM"))return void N.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(n instanceof Uint8Array==0)return new _t(H.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const r=this.getRTCRtpTransceiver();if(!r)return void N.warning("Video track is not published, SEI can not be send");const a=r.sender.getParameters();if(a.codecs.length===0)return;const d=a.codecs[0].mimeType.toLocaleLowerCase();d==="video/h264"?this.safeEmit("sei-to-send",n):N.warning("SEI is not supported by ".concat(d))}bindProcessorDestinationEvents(){this.processorDestination.on(Js.ON_TRACK,async n=>{n?n!==this._mediaStreamTrack&&(this._mediaStreamTrack=n,this._updatePlayerSource(),await On(this,Wt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await On(this,Wt.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Js.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ca.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ca.REQUEST_CONSTRAINTS)}},$e(Je.prototype,"play",[QR,Ow],Object.getOwnPropertyDescriptor(Je.prototype,"play"),Je.prototype),$e(Je.prototype,"stop",[Nw],Object.getOwnPropertyDescriptor(Je.prototype,"stop"),Je.prototype),$e(Je.prototype,"setEnabled",[ZR,Dw,Pw],Object.getOwnPropertyDescriptor(Je.prototype,"setEnabled"),Je.prototype),$e(Je.prototype,"setMuted",[gg,Tg,$R],Object.getOwnPropertyDescriptor(Je.prototype,"setMuted"),Je.prototype),$e(Je.prototype,"setEncoderConfiguration",[tC,eC],Object.getOwnPropertyDescriptor(Je.prototype,"setEncoderConfiguration"),Je.prototype),$e(Je.prototype,"getStats",[nC],Object.getOwnPropertyDescriptor(Je.prototype,"getStats"),Je.prototype),$e(Je.prototype,"setBeautyEffect",[Lw,iC],Object.getOwnPropertyDescriptor(Je.prototype,"setBeautyEffect"),Je.prototype),$e(Je.prototype,"getCurrentFrameData",[Dp],Object.getOwnPropertyDescriptor(Je.prototype,"getCurrentFrameData"),Je.prototype),$e(Je.prototype,"getCurrentFrameImage",[Td],Object.getOwnPropertyDescriptor(Je.prototype,"getCurrentFrameImage"),Je.prototype),$e(Je.prototype,"setBitrateLimit",[kw],Object.getOwnPropertyDescriptor(Je.prototype,"setBitrateLimit"),Je.prototype),$e(Je.prototype,"setOptimizationMode",[ql],Object.getOwnPropertyDescriptor(Je.prototype,"setOptimizationMode"),Je.prototype),$e(Je.prototype,"setScalabiltyMode",[ru],Object.getOwnPropertyDescriptor(Je.prototype,"setScalabiltyMode"),Je.prototype),$e(Je.prototype,"updateMediaStreamTrackResolution",[rC],Object.getOwnPropertyDescriptor(Je.prototype,"updateMediaStreamTrackResolution"),Je.prototype),$e(Je.prototype,"pipe",[Pp],Object.getOwnPropertyDescriptor(Je.prototype,"pipe"),Je.prototype),$e(Je.prototype,"unpipe",[To],Object.getOwnPropertyDescriptor(Je.prototype,"unpipe"),Je.prototype),$e(Je.prototype,"close",[oc],Object.getOwnPropertyDescriptor(Je.prototype,"close"),Je.prototype),$e(Je.prototype,"replaceTrack",[Mw],Object.getOwnPropertyDescriptor(Je.prototype,"replaceTrack"),Je.prototype),Je),Fw=(HM=me({argsMap:(t,n)=>[t.getTrackId(),n]}),KM=Bi(),YM=Y_("CameraVideoTrack","_enabledMutex"),Uw=me({argsMap:(t,n)=>[t.getTrackId(),n]}),qM=Bi(),xw=me({argsMap:(t,n)=>[t.getTrackId(),n]}),Vw=Bi(),Sg=me({argsMap:t=>[t.getTrackId()]}),io=class u5 extends qn{get __className__(){return"CameraVideoTrack"}constructor(n,r,a,d,l,p){super(n,fd(r.encoderConfig),d,l,p),gt(this,"_config",void 0),gt(this,"_originalConstraints",void 0),gt(this,"_constraints",void 0),gt(this,"_enabled",!0),gt(this,"_deviceName","default"),gt(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(G_()||ER())&&!function(){const E=en();if(E.os!==Cr.IOS||!E.osVersion)return!1;const f=E.osVersion.split(".");return Number(f[0])===15&&Number(f[1])>=2}()&&ua()&&this._enabled&&!this._isClosed&&(N.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=r,this._originalConstraints=a,this._constraints=a,this._deviceName=n.label,this._encoderConfig=fd(this._config.encoderConfig),Dn.on(Jr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Dn.on(Jr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(n){return typeof n=="string"?this._setDeviceById(n):n.deviceId?this._setDeviceById(n.deviceId):n.facingMode?this._setDeviceByFacingModel(n.facingMode):void 0}async _setDeviceById(n){if(N.info("[".concat(this.getTrackId(),"] set device to ").concat(n)),this._enabled)try{const r=await Go.getDeviceById(n),a={};a.video=_i({},this._constraints),a.video.deviceId={exact:n},a.video.facingMode=void 0,this._originMediaStreamTrack.stop();let d=null;try{d=await vs(a,this.getTrackId())}catch(l){throw N.error("[".concat(this.getTrackId(),"] setDevice failed"),l.toString()),d=await vs({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(d.getVideoTracks()[0],!1),l}await this._updateOriginMediaStreamTrack(d.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=r.label,this._config.cameraId=n,this._constraints.deviceId={exact:n}}catch(r){throw N.error("[".concat(this.getTrackId(),"] setDevice error"),r.toString()),r}else try{const r=await Go.getDeviceById(n);this._deviceName=r.label,this._config.cameraId=n,this._constraints.deviceId={exact:n}}catch(r){throw N.error("[".concat(this.getTrackId(),"] setDevice error"),r.toString()),r}N.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(n){N.info("[".concat(this.getTrackId(),"] set facingMode ").concat(n));const r={video:_i(_i({},this._constraints),{},{deviceId:void 0,facingMode:{exact:n}})};if(this._enabled){this._originMediaStreamTrack.stop();let a=null;try{a=await vs(r,this.getTrackId())}catch(d){throw N.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),d.toString()),a=await vs({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(a.getVideoTracks()[0],!1),d}await this._updateOriginMediaStreamTrack(a.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=n,this._config.cameraId=void 0,this._constraints=_i({},r.video),N.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(n,r){if(!r){if(n===this._enabled)return;this.stateCheck("enabled",n)}if(N.info("[".concat(this.getTrackId(),"] start setEnabled"),n),n){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const a=await vs({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getVideoTracks()[0],!1)}await On(this,Wt.NEED_ENABLE_TRACK,this)}catch(a){throw N.error("[".concat(this.getTrackId(),"] setEnabled true error"),a.toString()),a}this.updateMediaStreamTrackResolution(),N.info("[".concat(this.getTrackId(),"] setEnabled to true success")),r||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),r||(this._enabled=!1);try{await On(this,Wt.NEED_DISABLE_TRACK,this)}catch(a){throw N.error("[".concat(this.getTrackId(),"] setEnabled to false error"),a.toString()),a}N.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(n,r){if(!this._enabled)throw new _t(H.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");n=fd(n),this._forceBitrateLimit&&(n.bitrateMax=this._forceBitrateLimit.max_bitrate||n.bitrateMax,n.bitrateMin=this._forceBitrateLimit.min_bitrate||n.bitrateMin);const a=xi(this._config);a.encoderConfig=n;const d=Ia(a);(vr()||Ys()||hi())&&(d.deviceId=void 0),N.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(n),JSON.stringify(d));try{await this._originMediaStreamTrack.applyConstraints(d),this.updateMediaStreamTrackResolution()}catch(l){const p=new _t(H.UNEXPECTED_ERROR,l.toString());throw N.error("[".concat(this.getTrackId(),"] applyConstraints error"),p.toString()),p}this._config=a,this._constraints=d,this._originalConstraints=d,this._encoderConfig=n,this._hints.indexOf(vn.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await On(this,Wt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(l){return l.throw(N)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Ys()||hi())&&this._enabled&&!this._isClosed&&Dn.duringInterruption){const n=async()=>{Dn.off(Jr.IOS_INTERRUPTION_END,n),this._enabled&&!this._isClosed&&(N.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Dn.on(Jr.IOS_INTERRUPTION_END,n)}else N.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(no.TRACK_ENDED)}async renewMediaStreamTrack(n){const r=n||this._constraints,a=Go.searchDeviceIdByName(this._deviceName);if(a&&!r.deviceId&&(r.deviceId={exact:a}),this._enabled){const d=await vs({video:r},this.getTrackId());this._constraints=r,await this._updateOriginMediaStreamTrack(d.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Dn.off(Jr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Dn.off(Jr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(n){let r=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],a=this._encoderConfig;n&&(a=_i(_i({},a),fd(n))),a=up(a);const d=Vn(8,"track-cam-cloned-"),l=new u5(r?this._mediaStreamTrack.clone():this._mediaStreamTrack,up(_i(_i({},this._config),{},{encoderConfig:a})),up(this._constraints),up(this._scalabilityMode),this._optimizationMode,d);return n&&a&&l.setEncoderConfiguration(a),N.debug("clone track from ".concat(this.getTrackId()," to ").concat(d,", clone ").concat(r)),l}bindProcessorContextEvents(){this.processorContext.on(Ca.REQUEST_UPDATE_CONSTRAINTS,async(n,r,a)=>{try{const d=Object.assign({},this._originalConstraints,...n);await this.renewMediaStreamTrack(d),r()}catch(d){a(d)}}),this.processorContext.on(Ca.REQUEST_CONSTRAINTS,async n=>{n(this._originMediaStreamTrack.getSettings())})}},$e(io.prototype,"setDevice",[HM,KM],Object.getOwnPropertyDescriptor(io.prototype,"setDevice"),io.prototype),$e(io.prototype,"setEnabled",[YM,Uw,qM],Object.getOwnPropertyDescriptor(io.prototype,"setEnabled"),io.prototype),$e(io.prototype,"setEncoderConfiguration",[xw,Vw],Object.getOwnPropertyDescriptor(io.prototype,"setEncoderConfiguration"),io.prototype),$e(io.prototype,"close",[Sg],Object.getOwnPropertyDescriptor(io.prototype,"close"),io.prototype),io);function Bw(t,n,r,a){r.optimizationMode&&(a&&a.width&&a.height?(r.encoderConfig=_i(_i({},a),{},{bitrateMin:a.bitrateMin,bitrateMax:a.bitrateMax}),r.optimizationMode!=="motion"&&r.optimizationMode!=="detail"||(n.contentHint=r.optimizationMode,n.contentHint===r.optimizationMode?N.debug("[".concat(t,"] set content hint to"),r.optimizationMode):N.debug("[".concat(t,"] set content hint failed")))):N.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var zM,Rg,RE,JM,ac,jw,cs,sC,Pe,XM,QM,xs;class ZM extends TM{getUserId(){return this._userId}constructor(n,r,a,d){super(n,"track-".concat(n.kind,"-").concat(r,"-").concat(d.clientId,"_").concat(Vn(5,""))),gt(this,"_userId",void 0),gt(this,"_uintId",void 0),gt(this,"_isDestroyed",!1),gt(this,"store",void 0),gt(this,"processor",void 0),gt(this,"processorContext",void 0),this._userId=r,this._uintId=a,this.store=d}_updateOriginMediaStreamTrack(n){this._originMediaStreamTrack=n,this._mediaStreamTrack=n,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,N.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let zl=(zM=me({argsMap:(t,n,r)=>[t.getTrackId(),typeof n=="string"?n:n instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",r]}),Rg=me({argsMap:t=>[t.getTrackId()]}),RE=me({argsMap:(t,n)=>[t.getTrackId(),n.name]}),JM=me({argsMap:t=>[t.getTrackId()]}),$e((ac=class extends ZM{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Ms.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,n,r,a){super(t,n,r,a),gt(this,"_videoVisibleTimer",null),gt(this,"_previousVideoVisibleStatus",void 0),gt(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),gt(this,"trackMediaType",bp.VIDEO),gt(this,"_videoWidth",void 0),gt(this,"_videoHeight",void 0),gt(this,"_player",void 0),gt(this,"processorDestination",void 0),gt(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new lg(this.getTrackId(),"remote"),this.processorDestination=new ic(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Al(()=>{N.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Vo(this,Wt.GET_STATS)||_i({},fM)}play(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const a=document.getElementById(t);a?t=a:(N.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}N.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const r=_i(_i({fit:"cover"},n),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(r):(t instanceof HTMLVideoElement?this._player=new bw(r):this._player=new ww(r),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(hE.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=a=>{this.safeEmit(hE.VIDEO_STATE_CHANGED,a)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const a=this.getVideoElementVisibleStatus();this.safeEmit(hE.VIDEO_ELEMENT_VISIBLE_STATUS,a)}catch{}},J("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,N.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){Op(this._originMediaStreamTrack).then(t=>{let[n,r]=t;this._videoHeight=r,this._videoWidth=n}).catch(RR)}_updatePlayerSource(){N.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,n;const r=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),a={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:d,slot:l}=a;if(this.isPlaying&&d instanceof HTMLVideoElement&&l instanceof HTMLElement){const p=zd.checkOneElementVisible(d),E=Object.assign({},p);if(E.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=E.visible;const f=ee.reportApiInvoke(null,{tag:Si.TRACER,name:Gi.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});E.visible?f.onSuccess("Video is visible"):f.onSuccess("Invisible because of ".concat(E.reason))}return E}return}catch(r){throw new _t(H.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new _t(H.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Js.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Js.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(Ku.SEI_RECEIVED,t)}}).prototype,"play",[zM],Object.getOwnPropertyDescriptor(ac.prototype,"play"),ac.prototype),$e(ac.prototype,"stop",[Rg],Object.getOwnPropertyDescriptor(ac.prototype,"stop"),ac.prototype),$e(ac.prototype,"pipe",[RE],Object.getOwnPropertyDescriptor(ac.prototype,"pipe"),ac.prototype),$e(ac.prototype,"unpipe",[JM],Object.getOwnPropertyDescriptor(ac.prototype,"unpipe"),ac.prototype),ac),Lp=(jw=me({argsMap:(t,n)=>[t.getTrackId(),n],throttleTime:300}),cs=me({argsMap:(t,n)=>[t.getTrackId(),n]}),sC=me({argsMap:t=>[t.getTrackId()]}),Pe=me({argsMap:t=>[t.getTrackId()]}),XM=me({argsMap:(t,n)=>[t.getTrackId(),n.name]}),QM=me({argsMap:t=>[t.getTrackId()]}),$e((xs=class extends ZM{get isPlaying(){return this._useAudioElement?Us.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,n,r,a){super(t,n,r,a),gt(this,"trackMediaType",bp.AUDIO),gt(this,"_source",void 0),gt(this,"_useAudioElement",!0),gt(this,"_volume",100),gt(this,"processorContext",void 0),gt(this,"processorDestination",void 0),gt(this,"_played",!1),gt(this,"_bypassWebAudio",!1),J("DISABLE_WEBAUDIO")?(this._source=new hg,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new _w(t,!0),J("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Ra.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(hE.FIRST_FRAME_DECODED)}),this.processorContext=new vM(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new rc(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Ra.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Ra.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(n),this._source.removeAllListeners(Ra.ON_AUDIO_BUFFER),this._source.on(Ra.ON_AUDIO_BUFFER,r=>t(r))}setVolume(t){this._volume=t,this._useAudioElement?Us.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!jl())throw new _t(H.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Us.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Al(()=>{N.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Vo(this,Wt.GET_STATS)||_i({},GR)}play(){N.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(N.debug("[".concat(this.getTrackId(),"] use audio element to play")),Us.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){N.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Us.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];N.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Us.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new _t(H.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new _t(H.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new _t(H.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const n=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,n.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Js.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Js.ON_NODE,t=>{this._source.processedNode=t;const n=!t;this._useAudioElement!==n&&(this._played?(this.stop(),this._useAudioElement=n,this.play()):this._useAudioElement=n)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Js.ON_TRACK),this.processorDestination.removeAllListeners(Js.ON_NODE)}}).prototype,"setVolume",[jw],Object.getOwnPropertyDescriptor(xs.prototype,"setVolume"),xs.prototype),$e(xs.prototype,"setPlaybackDevice",[cs],Object.getOwnPropertyDescriptor(xs.prototype,"setPlaybackDevice"),xs.prototype),$e(xs.prototype,"play",[sC],Object.getOwnPropertyDescriptor(xs.prototype,"play"),xs.prototype),$e(xs.prototype,"stop",[Pe],Object.getOwnPropertyDescriptor(xs.prototype,"stop"),xs.prototype),$e(xs.prototype,"pipe",[XM],Object.getOwnPropertyDescriptor(xs.prototype,"pipe"),xs.prototype),$e(xs.prototype,"unpipe",[QM],Object.getOwnPropertyDescriptor(xs.prototype,"unpipe"),xs.prototype),xs);const zu=new class extends An{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),gt(this,"_lastHiddenTime",0),gt(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),N.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};class CE extends An{constructor(n,r){super(),gt(this,"trackMediaType",bp.DATA),gt(this,"_version",1),gt(this,"_type",3),gt(this,"_config",void 0),gt(this,"_originDataChannel",void 0),gt(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),gt(this,"_dataStreamPacketHandler",{serialize:a=>a,deserialize:a=>a}),gt(this,"_datachannelEventMap",new Map),this._config=n,r&&(this._originDataChannel=r,this._bandDataChannelEvents(r)),this._initPacketHeader()}useDataStream(n){this._dataStreamPacketHandler=n}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return J("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var n,r;return(n=(r=this._originDataChannel)===null||r===void 0?void 0:r.readyState)!==null&&n!==void 0?n:"connecting"}get _originDataChannelId(){var n,r;return(n=(r=this._originDataChannel)===null||r===void 0?void 0:r.id)!==null&&n!==void 0?n:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Bt((n,r)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&n();const a=setTimeout(()=>{var d;r(new _t(H.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((d=this._originDataChannel)===null||d===void 0?void 0:d.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(a),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),n()},this._originDataChannel.onerror=()=>{throw clearTimeout(a),new _t(H.DATACHANNEL_CONNECTION_TIMEOUT)}}else r(new _t(H.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(n){this._originDataChannel=n,this._bandDataChannelEvents(n)}_initPacketHeader(){const n=new DataView(this._dataStreamPacketHeader);n.setUint16(0,this._version),n.setUint8(2,this._type),n.setUint8(3,this._config.id)}_bandDataChannelEvents(n){this._unbindDataChannelEvents(n),[WR.OPEN,WR.CLOSE,WR.ERROR].forEach(r=>{const a=()=>{this.emit(r)};this._datachannelEventMap.set(r,a),n.addEventListener(r,a)})}_unbindDataChannelEvents(n){Array.from(this._datachannelEventMap.entries()).forEach(r=>{let[a,d]=r;n.removeEventListener(a,d)}),this._datachannelEventMap.clear()}}class Wo extends CE{constructor(n){super(n),gt(this,"_messageListener",void 0),this._messageListener=r=>{if(r.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const a=r.data.slice(0,this._dataStreamPacketHeader.byteLength),d=new DataView(a).getUint8(3);if(d!==this.id)return void(J("SHOW_DATASTREAM2_LOG")&&N.debug("invalid datachannel id: ".concat(d," !== ").concat(this.id)));let l=r.data.slice(this._dataStreamPacketHeader.byteLength);l=this._dataStreamPacketHandler.deserialize(l),this.emit(WR.MESSAGE,l)}}_updateOriginDataChannel(n){super._updateOriginDataChannel(n),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class $M extends CE{send(n){if(this._originDataChannel){let r=n;r=this._dataStreamPacketHandler.serialize(n);const a=new Uint8Array(this._dataStreamPacketHeader.byteLength+r.byteLength);a.set(new Uint8Array(this._dataStreamPacketHeader),0),a.set(new Uint8Array(r),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(a.buffer)}}}function oC(){const t=new Blob([atob("ZnVuY3Rpb24gZShlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLGE9W10sbz0wO2Zvcig7YS5sZW5ndGg8bjspbyszPG4mJjA9PT1yW29dJiYwPT09cltvKzFdJiYzPT09cltvKzJdJiYoMD09PXJbbyszXXx8MT09PXJbbyszXXx8Mj09PXJbbyszXXx8Mz09PXJbbyszXSk/KGEucHVzaChyW29dLHJbbysxXSxyW28rM10pLG8rPTQpOihhLnB1c2gocltvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYSl9ZnVuY3Rpb24gdChlLHQpe2NvbnN0IG49ZnVuY3Rpb24oZSl7Y29uc3QgdD1lLmxlbmd0aDtsZXQgbj1bXSxyPTA7Zm9yKDtyPHQ7KXIrMjx0JiYwPT09ZVtyXSYmMD09PWVbcisxXSYmKDA9PT1lW3IrMl18fDE9PT1lW3IrMl18fDI9PT1lW3IrMl18fDM9PT1lW3IrMl0pPyhuLnB1c2goZVtyXSxlW3IrMV0sMyxlW3IrMl0pLHIrPTMpOihuLnB1c2goZVtyXSkscisrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobil9KHQpLHI9bi5sZW5ndGgsYT1NYXRoLmZsb29yKHIvMjU1KSxvPXIlMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNithKzErcitlLmJ5dGVMZW5ndGgpO3NbMF09MCxzWzFdPTAsc1syXT0wLHNbM109MSxzWzRdPTYsc1s1XT0xMDE7bGV0IGk9MDtmb3IoO2k8YTspc1s2K2ldPTI1NSxpKys7cmV0dXJuIHNbNitpXT1vLGkrKyxzLnNldChuLDYraSkscy5zZXQobmV3IFVpbnQ4QXJyYXkoZSksNitpK3IpLHMuYnVmZmVyfW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiU2FmYXJpIik+LTEmJi0xPT09bmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSYmKHNlbGYub25ydGN0cmFuc2Zvcm09bj0+e2NvbnN0IHI9bi50cmFuc2Zvcm1lcjtsZXQgYT1bXTtyLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9ZT0+e2UuZGF0YS5zZWkmJmEucHVzaChlLmRhdGEuc2VpKX0sc2VsZi5wb3N0TWVzc2FnZSgic3RhcnRlZCIpO2NvbnN0IG89ci5yZWFkYWJsZS5nZXRSZWFkZXIoKSxzPXIud3JpdGFibGUuZ2V0V3JpdGVyKCk7InJ4Ij09PXIub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1mdW5jdGlvbih0KXtjb25zdCBuPW5ldyBEYXRhVmlldyh0LmRhdGEpO2xldCByPTA7Zm9yKDtyKzQ8dC5kYXRhLmJ5dGVMZW5ndGg7KXtpZigwPT09bi5nZXRVaW50OChyKzApJiYwPT09bi5nZXRVaW50OChyKzEpJiYwPT09bi5nZXRVaW50OChyKzIpJiYxPT09bi5nZXRVaW50OChyKzMpJiY2PT09bi5nZXRVaW50OChyKzQpKXtsZXQgYT1yKzYsbz0wLHM9MDtmb3IoOzI1NT09PShzPW4uZ2V0VWludDgoYSsrKSk7KW8rPTI1NTtvKz1zO2NvbnN0IGk9ZSh0LmRhdGEsYSxvKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoaSl9cisrfXJldHVybiBudWxsfShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1hLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>_M.revokeObjectURL(t),0),new Worker(_M.createObjectURL(t))}const aC=new Map,cC=new Map;function Gw(t,n,r){let a=new Uint8Array(t,n,r),d=[],l=0;for(;d.length<r;)l+3<r&&a[l]===0&&a[l+1]===0&&a[l+2]===3&&(a[l+3]===0||a[l+3]===1||a[l+3]===2||a[l+3]===3)?(d.push(a[l],a[l+1],a[l+3]),l+=4):(d.push(a[l]),l++);return new Uint8Array(d)}const Cg=new Map;async function oG(t,n){if(!nn().supportWebRTCEncodedTransform)return void N.warning("browser not support video encoded transform");if(Cg.has(t)||!t.track)return;const r={track:t.track};if(Ac()){if(!t.createEncodedStreams)return void N.warning("browser not support createEncodedStreams() API");let d=null;try{d=t.createEncodedStreams()}catch(E){return void N.error("create video-encoded-streams error",E&&E.message)}let l=[];n.on("sei-to-send",E=>{l.push(E)});const p=new TransformStream({transform(E,f){r.controller||(r.controller=f),t.track&&t.track.id!==r.track.id&&(N.debug("video track changed: ".concat(r.track.id," => ").concat(t.track.id)),r.track.removeEventListener("ended",a),r.track=t.track,r.track.addEventListener("ended",a));const T=l.shift();T&&(E.data=function(R,v){const y=function(W){const $=W.length;let rt=[],ot=0;for(;ot<$;)ot+2<$&&W[ot]===0&&W[ot+1]===0&&(W[ot+2]===0||W[ot+2]===1||W[ot+2]===2||W[ot+2]===3)?(rt.push(W[ot],W[ot+1],3,W[ot+2]),ot+=3):(rt.push(W[ot]),ot++);return new Uint8Array(rt)}(v),w=y.length,B=Math.floor(w/255),k=w%255,U=new Uint8Array(6+B+1+w+R.byteLength);U[0]=0,U[1]=0,U[2]=0,U[3]=1,U[4]=6,U[5]=101;let G=0;for(;G<B;)U[6+G]=255,G++;return U[6+G]=k,G++,U.set(y,6+G),U.set(new Uint8Array(R),6+G+w),U.buffer}(E.data,T)),f.enqueue(E)}});d.readable.pipeThrough(p).pipeTo(d.writable)}else{if(!vr())return;{if(typeof RTCRtpScriptTransform>"u")return void N.warning("browser not support RTCRtpScriptTransform");const d=oC(),l=new MessageChannel;await new Bt(E=>d.onmessage=f=>{f.data==="registered"&&E(void 0)});const p=new RTCRtpScriptTransform(d,{name:"tx",port:l.port2},[l.port2]);t.transform=p,await new Bt(E=>d.onmessage=f=>{f.data==="started"&&E(void 0)}),n.on("sei-to-send",E=>{l.port1.postMessage({sei:E})}),l.port1.onmessage=E=>{var f;E.data.transformed&&t.track&&((f=t.track)===null||f===void 0?void 0:f.id)!==r.track.id&&(N.debug("video track changed: ".concat(r.track.id," => ").concat(t.track.id)),r.track.removeEventListener("ended",a),r.track=t.track,r.track.addEventListener("ended",a))},r.worker=d}}function a(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",a)}const d=Cg.get(t);if(d){Cg.delete(t);try{var l,p;(l=d.controller)===null||l===void 0||l.terminate(),(p=d.worker)===null||p===void 0||p.terminate()}catch(E){N.warning(E&&E.message)}}}Cg.set(t,r),t.track.addEventListener("ended",a)}const vg=new Map;(function(){const t=en();zr.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),zr.getStreamFromExtension=t.name===mn.CHROME&&Number(t.version)>34,zr.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const n=new RTCPeerConnection;let r=!1;try{n.addTransceiver("audio"),r=!0}catch{}return n.close(),r}(),zr.supportMinBitrate=t.name===mn.CHROME||t.name===mn.EDGE,zr.supportSetRtpSenderParameters=function(){const n=en();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Il()||!(!vr()&&!ff())||n.name===mn.FIREFOX&&Number(n.version)>=64)}(),t.name===mn.SAFARI&&(Number(t.version)>=14?zr.supportDualStream=!0:zr.supportDualStream=!1),zr.webAudioMediaStreamDest=function(){const n=en();return!(n.name===mn.SAFARI&&Number(n.version)<12)}(),zr.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",zr.supportWebGL=typeof WebGLRenderingContext<"u",zr.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Il()||(zr.webAudioWithAEC=!0),zr.supportShareAudio=function(){const n=en();return(n.os===Cr.WIN_10||n.os===Cr.WIN_81||n.os===Cr.WIN_7||n.os===Cr.LINUX||n.os===Cr.MAC_OS||n.os===Cr.CHROMIUM_OS)&&n.name===mn.CHROME&&Number(n.version)>=74}(),zr.supportDataChannel=!!(ub(76)||function(n){const r=en();return!(r.name!==mn.FIREFOX||!r.osVersion)&&Number(r.version)>=n}(68)||sk(14)),zr.supportPCSetConfiguration=function(){const n=window.RTCPeerConnection;return!Ii()&&!!n&&n.prototype.setConfiguration instanceof Function}(),zr.supportWebRTCEncodedTransform=function(){const n=en();return n.name==="Chrome"&&Number(n.version)>=86||n.name==="Safari"&&Number(n.version)>=15}(),zr.supportWebRTCInsertableStream=function(){const n=en();return(n.name===mn.CHROME||n.name===mn.EDGE)&&Number(n.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),zr.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,zr.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,If(()=>{zr.supportDualStreamEncoding=function(){const n=en();return!!J("DISABLE_WEBAUDIO")||n.name==="Safari"&&Number(n.version)>=14||!!(n.name==="Chrome"&&/Windows/i.test(n.os||"")&&Number(n.version)>=100&&J("CHROME_DUAL_STREAM_USE_ENCODING"))}(),N.debug("browser ua: ",navigator.userAgent),N.info("browser info: ",t),N.info("browser compatibility: ",zr)})})();class kp extends An{constructor(n,r){super(),F(this,"signal",void 0),F(this,"token",void 0),F(this,"tokenTimeout",void 0),F(this,"tokenInterval",void 0),F(this,"_sequence",0),F(this,"userMap",new Map),F(this,"encoder",new TextEncoder),this.signal=n,this.token=r;const a=()=>{this.signal.connectionState===Yn.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(a,1e3):this.tokenInterval=window.setTimeout(a,3*J("P2P_TOKEN_INTERVAL"))};a()}async send(n,r,a,d,l){var p,E,f;if(this.userMap.size===0)return;const T=Array.from($d(p=this.userMap).call(p))[0].token;typeof r!="string"&&(r=JSON.stringify(r)),d=(E=d)!==null&&E!==void 0?E:Vn(6,""),l=(f=l)!==null&&f!==void 0?f:this._sequence++;const R={_id:d,_type:n,_seq:l,_message:r,token:"".concat(this.token,"_").concat(T)};J("SHOW_P2P_LOG")&&N.debug("send message",R,"noNeedResponse : ".concat(a)),this.splitMessage(JSON.stringify(R)).forEach(y=>{this.signal.request(ue.DATA_STREAM,{payload:Ka(this.encoder.encode(y))})});const v=new Bt((y,w)=>{const B=window.setTimeout(()=>{this.off("res-@".concat(d,"_ack"),k),this.off("res-@".concat(d),G),this.off(Gu.ABORT,U),N.debug("[external-signal] request timeout, type: ".concat(n,", requestId: ").concat(d)),this.userMap.size===0?w(new _t(H.INVALID_REMOTE_USER)):w(new _t(H.TIMEOUT))},J("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),k=()=>{B&&window.clearTimeout(B),this.off(Gu.ABORT,U),a&&y()},U=()=>{B&&window.clearTimeout(B),this.off("res-@".concat(d,"_ack"),k),this.off("res-@".concat(d),G),w(new _t(H.EXTERNAL_SIGNAL_ABORT,"type: ".concat(n,", requestId: ").concat(d)))};this.once(Gu.ABORT,U),this.once("res-@".concat(d,"_ack"),k);const G=($,rt)=>{W=!0,B&&window.clearTimeout(B),this.off("res-@".concat(d,"_ack"),k),this.off(Gu.ABORT,U),$==="success"?y(rt):w(new _t(H.P2P_MESSAGE_FAILED,"request ".concat(n," failed, requestId: ").concat(d)))};let W=!1;a||(this.once("res-@".concat(d),G),xr(J("SIGNAL_REQUEST_TIMEOUT")).then(()=>{W||N.warning("external_signal request timeout, type: ".concat(n,", requestId: ").concat(d,", ").concat(R))}))});try{return await v}catch(y){if(y.code===H.TIMEOUT)return await this.send(n,r,a,d,l);throw y}}onMessage(n){var r;const{_uid:a}=n;let d,l=this.userMap.get(a);if(l)d=l.splitMessageMap;else{if(this.userMap.size>0||!("_type"in n)||n._type!==ai.CHECK)return;const{token:T}=n;d=new Map,l={uid:a,isStart:!0,token:T,splitMessageMap:d,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(a,l),this.signal.emit(Ue.ON_USER_ONLINE,{uid:a}),this.handleUserOnline()}if("id"in n&&"total"in n){var p;const{id:T,total:R}=n,v=(p=d.get(T))!==null&&p!==void 0?p:[];if(v.push(n),d.has(T)||d.set(T,v),v.length!==R)return;{const y=Vh(v).call(v,(w,B)=>w.index-B.index).map(w=>w.payload).join("");d.delete(T),(n=JSON.parse(y))._uid=a}}const{_type:E,token:f}=n;if(Mt(r=[ai.ACK,ai.CHECK]).call(r,E))return E===ai.CHECK&&this.handleCheckToken(l,f),void this.receiveMessage(n);f==="".concat(l.token,"_").concat(this.token)?this.handleReceivedMessage(n):N.debug('Receive unexpected message", '.concat(f,", cur_token: ").concat(l.token,"_").concat(this.token),n)}check(){const n={_id:Vn(6,""),token:this.token,_type:ai.CHECK};J("SHOW_P2P_LOG")&&N.debug("send message",n),this.signal.request(ue.DATA_STREAM,{payload:Ka(this.encoder.encode(JSON.stringify(n)))})}ack(n){const r={_id:n,_type:ai.ACK,token:this.token};J("SHOW_P2P_LOG")&&N.debug("send message",r),this.signal.request(ue.DATA_STREAM,{payload:Ka(this.encoder.encode(JSON.stringify(r)))})}response(n,r,a){this.send(ai.RESPONSE,JSON.stringify({success:!a,message:r}),!0,n)}handleReceivedMessage(n){const r=()=>{this.userMap.forEach(T=>{const{receivedMessagesMap:R,nextExpectedSequenceNumber:v}=T;for(;R.has(v);){const y=R.get(v);R.delete(v),this.receiveMessage(y),T.nextExpectedSequenceNumber++}})};if(!n)return void r();const{_uid:a,_seq:d}=n,l=this.userMap.get(a),{receivedMessagesMap:p,isStart:E,nextExpectedSequenceNumber:f}=l;if(d<f)return this.ack(n._id),void N.debug("[external-signal] receive old message, seq: ".concat(d,", ").concat(n._message));p.set(d,n),E&&d===f&&(this.receiveMessage(n),p.delete(f),l.nextExpectedSequenceNumber++,r())}receiveMessage(n){const{_id:r,_type:a,_message:d,_uid:l}=n;if(J("SHOW_P2P_LOG")&&N.debug("receive message",n),r){let p;switch(n._type!==ai.ACK&&(d&&(p=JSON.parse(d)),this.ack(n._id)),n._type){case ai.CANDIDATE:case ai.CONTROL:this.signal.emit(a,p,l);break;case ai.PUBLISH:case ai.UNPUBLISH:case ai.RESTART_ICE:case ai.CALL:p.uid=l,Kr(this.signal,a,p).then(E=>{this.response(n._id,E)}).catch(()=>{this.response(n._id,void 0,!0)});break;case ai.ACK:this.getListeners("res-@".concat(r,"_ack")).length>0&&this.emit("res-@".concat(r,"_ack"));break;case ai.RESPONSE:{const{success:E,message:f}=p;this.emit("res-@".concat(r),E?"success":"failed",f);break}}}}splitMessage(n){if(n.length<kp.MAX_MESSAGE_SIZE)return[n];const r=[],{remoteToken:a}=JSON.parse(n),d=Vn(6,"");let l=0,p=800;const E=Math.ceil(n.length/p);for(;n.length>0;){l++;const f={id:d,index:l,total:E,payload:n.slice(0,p),token:"".concat(this.token,"_").concat(a)};JSON.stringify(f).length>kp.MAX_MESSAGE_SIZE?p-=50:(r.push(f),n=n.slice(p))}return r.map(f=>JSON.stringify(f))}handleCheckToken(n,r){return n.token!==r?(N.debug("token changed, from ".concat(n.token," to ").concat(r)),this.reset(n.uid,r),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{N.debug("token timeout, ".concat(r)),this.reset(n.uid)},J("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const n=await Kr(this.signal,ai.CALL,void 0),r=await this.send(ai.CALL,n);this.signal.emit(fe.P2P_CONNECTION,r,!0)}async reset(n,r){const a=this.userMap.get(n);a&&(this.emit(Gu.ABORT),this.signal.emit(Ue.ON_USER_OFFLINE,{uid:a.uid,reason:Mb.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),r||(N.debug("change local token from ".concat(r," to ").concat(r)),this.token=Vn(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Gu.ABORT)}}F(kp,"MAX_SIZE",1),F(kp,"MAX_MESSAGE_SIZE",1024);class dC extends An{get connectionState(){return this._connectionState}set connectionState(n){n!==this._connectionState&&(this._connectionState=n,n===Yn.CONNECTED?this.emit(fe.WS_CONNECTED):n===Yn.RECONNECTING?this.emit(fe.WS_RECONNECTING,this._websocketReconnectReason):n===Yn.CLOSED&&this.emit(fe.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(n,r){super(),F(this,"_disconnectedReason",void 0),F(this,"_websocketReconnectReason",void 0),F(this,"_connectionState",Yn.CLOSED),F(this,"reconnectToken",void 0),F(this,"p2pToken",void 0),F(this,"websocket",void 0),F(this,"openConnectionTime",void 0),F(this,"clientId",void 0),F(this,"lastMsgTime",Date.now()),F(this,"uploadCache",[]),F(this,"uploadCacheInterval",void 0),F(this,"rttRolling",new dd(5)),F(this,"pingpongTimer",void 0),F(this,"pingpongTimeoutCount",0),F(this,"joinResponse",void 0),F(this,"multiIpOption",void 0),F(this,"initError",void 0),F(this,"spec",void 0),F(this,"store",void 0),F(this,"_external_signal",void 0),F(this,"onWebsocketMessage",a=>{if(a.data instanceof ArrayBuffer)return void this.emit(fe.ON_BINARY_DATA,a.data);const d=JSON.parse(a.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(d,"_id")){const l="res-@".concat(d._id);this.emit(l,d._result,d._message)}else if(Object.prototype.hasOwnProperty.call(d,"_type")){switch(d._type){case Ue.ON_DATA_STREAM:return void this.handleDataStream(d._message);case Ue.MUTE_AUDIO:case Ue.MUTE_VIDEO:case Ue.ON_P2P_LOST:case Ue.ON_USER_ONLINE:return;case Ue.ON_USER_OFFLINE:const{uid:l}=d._message;return N.debug("[".concat(this.clientId,"] user-offline uid: ").concat(l)),void this._external_signal.reset(l)}if(this.emit(d._type,d._message),d._type===Ue.ON_NOTIFICATION&&this.handleNotification(d._message),d._type===Ue.ON_USER_BANNED)switch(d._message.error_code){case 14:this.close(Cn.UID_BANNED);break;case 15:this.close(Cn.IP_BANNED);break;case 16:this.close(Cn.CHANNEL_BANNED)}if(d._type===Ue.ON_USER_LICENSE_BANNED)switch(d._message.error_code){case de.ERR_LICENSE_MISSING:this.close(Cn.LICENSE_MISSING);break;case de.ERR_LICENSE_EXPIRED:this.close(Cn.LICENSE_EXPIRED);break;case de.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Cn.LICENSE_MINUTES_EXCEEDED);break;case de.ERR_LICENSE_PERIOD_INVALID:this.close(Cn.LICENSE_PERIOD_INVALID);break;case de.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Cn.LICENSE_MULTIPLE_SDK_SERVICE);break;case de.ERR_LICENSE_ILLEGAL:this.close(Cn.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=n.clientId,this.spec=n,this.store=r,this.websocket=new Fb("gateway-".concat(this.clientId),this.spec.retryConfig,!0,J("JOIN_GATEWAY_USE_DUAL_DOMAIN"),J("JOIN_GATEWAY_USE_443PORT_ONLY"),r),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Yn.CONNECTED&&this.reconnect("retry",rs.OFFLINE)}),this.p2pToken=Vn(6,""),this._external_signal=new kp(this,this.p2pToken)}async request(n,r,a,d){const l=Vn(6,""),p={_id:l,_type:n,_message:r},E=this.websocket.connectionID,f=()=>new Bt((B,k)=>{if(this.connectionState===Yn.CONNECTED)return B();const U=()=>{this.off(fe.WS_CLOSED,G),B()},G=()=>{this.off(fe.WS_CONNECTED,U),k(new _t(H.WS_ABORT))};this.once(fe.WS_CONNECTED,U),this.once(fe.WS_CLOSED,G)});if(this.connectionState!==Yn.CONNECTING&&this.connectionState!==Yn.RECONNECTING||n===ue.JOIN||n===ue.REJOIN||await f(),this.websocket.sendMessage(p,!0),d)return;const T=new Bt((B,k)=>{let U=!1;const G=($,rt)=>{U=!0,B({isSuccess:$==="success",message:rt||{}}),this.off(fe.WS_CLOSED,W),this.off(fe.WS_RECONNECTING,W),this.emit(fe.REQUEST_SUCCESS,n,r)};this.once("res-@".concat(l),G);const W=()=>{k(new _t(H.WS_ABORT,"type: ".concat(n))),this.off(fe.WS_CLOSED,W),this.off(fe.WS_RECONNECTING,W),this.off("res-@".concat(l),G)};this.once(fe.WS_CLOSED,W),this.once(fe.WS_RECONNECTING,W),xr(J("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==E||U||(N.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(n)),this.emit(fe.REQUEST_TIMEOUT,n,r))})});let R=null;try{R=await T}catch(B){if(this.connectionState===Yn.CLOSED||n===ue.LEAVE)throw new _t(H.WS_ABORT);return!this.spec.forceWaitGatewayResponse||a?B.throw():n===ue.JOIN||n===ue.REJOIN?null:(await f(),await this.request(n,r))}if(R.isSuccess)return R.message;const v=Number(R.message.error_code||R.message.code),y=Nc(v),w=new _t(H.UNEXPECTED_RESPONSE,"".concat(y.desc,": ").concat(R.message.error_str),{code:v,data:R.message,desc:y.desc});return y.action==="success"?R.message:(N.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(n,", error_code: ").concat(v,", message: ").concat(y.desc,", action: ").concat(y.action)),v===de.ERR_TOO_MANY_BROADCASTERS?((n===ue.JOIN||n===ue.REJOIN)&&(this.initError=w,this.close()),w.throw()):y.action==="failed"?w.throw():y.action==="quit"?(this.initError=w,this.close(),w.throw()):(v===de.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=R.message.option,N.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",rs.MULTI_IP)):this.reconnect(y.action,rs.SERVER_ERROR),n===ue.JOIN||n===ue.REJOIN?null:await this.request(n,r)))}waitMessage(n,r){return new Bt(a=>{const d=l=>{(!r||r(l))&&(this.off(n,d),a(l))};this.on(n,d)})}uploadWRTCStats(n){if(!this.store.sessionId)return void N.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const r={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:n};this.upload(qa.WRTC_STATS,r)}upload(n,r){const a={_type:n,_message:r};try{this.websocket.sendMessage(a)}catch{const l=J("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(a),this.uploadCache.length>l&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Yn.CONNECTED)return;const p=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(p._type,p._message)},J("UPLOAD_CACHE_INTERVAL")||2e3))}}send(n,r){const a={_type:n,_message:r};this.websocket.sendMessage(a)}async sendExtensionMessage(n,r,a){return await this._external_signal.send(n,r,a)}init(n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Bt((r,a)=>{this.once(fe.WS_CONNECTED,()=>r(this.joinResponse)),this.once(fe.WS_CLOSED,()=>a(this.initError||new _t(H.WS_ABORT))),this.connectionState=Yn.CONNECTING,this.websocket.init(n).catch(a)})}close(n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=n||Cn.LEAVE,this.connectionState=Yn.CLOSED,N.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=Vn(6,""),this._external_signal.clear(),this._external_signal=new kp(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(fe.ABORT_P2P_EXECUTION);const n=await Kr(this,fe.REQUEST_JOIN_INFO),r=await this.request(ue.JOIN,n);if(!r)return this.emit(fe.REPORT_JOIN_GATEWAY,H.TIMEOUT,this.url||""),!1;this.joinResponse=r,this.emit(fe.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Yn.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(n,r){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(n,r)}handleDataStream(n){try{var r;const a=bc(n.payload),d=new TextDecoder().decode(a),l=JSON.parse(d);"total"in l&&"id"in l||Mt(r=Object.values(ai)).call(r,l._type)?(l._uid=n.uid,this._external_signal.onMessage(l)):this.emit(Ue.ON_DATA_STREAM,n)}catch{this.emit(Ue.ON_DATA_STREAM,n)}}handleNotification(n){N.debug("[".concat(this.clientId,"] receive notification: "),n);const r=Nc(n.code);if(r.action!=="success"){if(r.action!=="failed")return r.action==="quit"?(r.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Cn.UID_BANNED),void this.close()):void this.reconnect(r.action,rs.SERVER_ERROR);N.error("[".concat(this.clientId,"] ignore error: "),r.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const n=J("PING_PONG_TIME_OUT"),r=Date.now();this.pingpongTimeoutCount>=n&&(N.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(r-this.lastMsgTime,"ms")),r-this.lastMsgTime>J("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",rs.TIMEOUT):this.request(ue.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const a=Date.now()-r;this.rttRolling.add(a),J("REPORT_STATS")&&this.send(ue.PING_BACK,{pingpongElapse:a})}).catch(a=>{})}handleWebsocketEvents(){this.websocket.on(be.RECONNECT_CREATE_CONNECTION,n=>{this.emit(fe.WS_RECONNECT_CREATE_CONNECTION,n)}),this.websocket.on(be.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(be.CLOSED,()=>{this.connectionState=Yn.CLOSED}),this.websocket.on(be.FAILED,()=>{this._disconnectedReason=Cn.NETWORK_ERROR,this.connectionState=Yn.CLOSED}),this.websocket.on(be.RECONNECTING,n=>{this._websocketReconnectReason=n,this.joinResponse=void 0,this.connectionState===Yn.CONNECTED?this.connectionState=Yn.RECONNECTING:this.connectionState=Yn.CONNECTING}),this.websocket.on(be.WILL_RECONNECT,(n,r,a)=>{n!=="retry"?(N.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(n)),this.reconnectToken=void 0):N.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),a(n)}),this.websocket.on(be.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(n=>{if(this.emit(fe.REPORT_JOIN_GATEWAY,n,this.url||""),n instanceof _t&&n.code===H.UNEXPECTED_RESPONSE&&n.data.code===de.ERR_NO_AUTHORIZED)return N.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",rs.SERVER_ERROR);N.error("[".concat(this.clientId,"] join gateway request failed"),n.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",rs.SERVER_ERROR):(this.initError=n,this.close())})}),this.websocket.on(be.REQUEST_NEW_URLS,(n,r)=>{Kr(this,fe.REQUEST_RECOVER,this.multiIpOption).then(n).catch(r)}),this.websocket.on(be.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var Ww={exports:{}};(function(t,n){t.exports=(()=>{var r={8:(l,p,E)=>{E.r(p),E.d(p,{Parser:()=>Ye,Printer:()=>_u,parse:()=>we,print:()=>Sn});const f=`
`,T="".concat("\r").concat(f),R=" ";let v;function y(Ft){return Ft>="0"&&Ft<="9"}function w(Ft){return Ft>="!"&&Ft<="~"}function B(Ft){return w(Ft)||Ft>=""&&Ft<="ÿ"}function k(Ft){return Ft==="!"||Ft>="#"&&Ft<="'"||Ft>="*"&&Ft<="+"||Ft>="-"&&Ft<="."||Ft>="0"&&Ft<="9"||Ft>="A"&&Ft<="Z"||Ft>="^"&&Ft<="~"}function U(Ft){return Ft>="1"&&Ft<="9"}function G(Ft){return Ft>="A"&&Ft<="Z"||Ft>="a"&&Ft<="z"}function W(Ft){return Ft==="d"||Ft==="h"||Ft==="m"||Ft==="s"}function $(Ft){return Ft>""&&Ft<"	"||Ft>"\v"&&Ft<"\f"||Ft>""&&Ft<"ÿ"}function rt(Ft){return G(Ft)||y(Ft)||Ft==="+"||Ft==="/"}function ot(Ft){return y(Ft)||G(Ft)||Ft==="+"||Ft==="/"||Ft==="-"||Ft==="_"}function Et(Ft){return G(Ft)||y(Ft)||Ft==="+"||Ft==="/"}function vt(Ft,L){var X=Object.keys(Ft);if(Object.getOwnPropertySymbols){var tt=Object.getOwnPropertySymbols(Ft);L&&(tt=tt.filter(function(Ot){return Object.getOwnPropertyDescriptor(Ft,Ot).enumerable})),X.push.apply(X,tt)}return X}function Lt(Ft){for(var L=1;L<arguments.length;L++){var X=arguments[L]!=null?arguments[L]:{};L%2?vt(Object(X),!0).forEach(function(tt){wt(Ft,tt,X[tt])}):Object.getOwnPropertyDescriptors?Object.defineProperties(Ft,Object.getOwnPropertyDescriptors(X)):vt(Object(X)).forEach(function(tt){Object.defineProperty(Ft,tt,Object.getOwnPropertyDescriptor(X,tt))})}return Ft}function wt(Ft,L,X){return L in Ft?Object.defineProperty(Ft,L,{value:X,enumerable:!0,configurable:!0,writable:!0}):Ft[L]=X,Ft}(function(Ft){Ft.VERSION="v",Ft.ORIGIN="o",Ft.SESSION_NAME="s",Ft.INFORMATION="i",Ft.URI="u",Ft.EMAIL="e",Ft.PHONE="p",Ft.CONNECTION="c",Ft.BANDWIDTH="b",Ft.TIME="t",Ft.REPEAT="r",Ft.ZONE_ADJUSTMENTS="z",Ft.KEY="k",Ft.ATTRIBUTE="a",Ft.MEDIA="m"})(v||(v={}));class $t{consumeText(L,X){let tt=X;for(;tt<L.length;){const Ot=L[tt];if(Ot==="\0"||Ot==="\r"||Ot===f)break;tt+=1}if(tt-X==0)throw new Error("Invalid text, at ".concat(L));return tt}consumeUnicastAddress(L,X,tt){return this.consumeTill(L,X,R)}consumeOneOrMore(L,X,tt){let Ot=X;for(;tt(L[Ot]);)Ot++;if(Ot-X==0)throw new Error("Invalid rule at ".concat(X,"."));return Ot}consumeSpace(L,X){if(L[X]===R)return X+1;throw new Error("Invalid space at ".concat(X,"."))}consumeIP4Address(L,X){let tt=X;for(let Ot=0;Ot<4;Ot++)if(tt=this.consumeDecimalUChar(L,tt),Ot!==3){if(L[tt]!==".")throw new Error("Invalid IP4 address.");tt++}return tt}consumeDecimalUChar(L,X){let tt=X;for(let Oe=0;Oe<3&&y(L[tt]);Oe++,tt++);if(tt-X==0)throw new Error("Invalid decimal uchar.");const Ot=parseInt(L.slice(X,tt));if(Ot>=0&&Ot<=255)return tt;throw new Error("Invalid decimal uchar")}consumeIP6Address(L,X){let tt=this.consumeHexpart(L,X);return L[tt]===":"&&(tt+=1,tt=this.consumeIP4Address(L,tt)),tt}consumeHexpart(L,X){let tt=X;if(L[tt]===":"&&L[tt+1]===":"){tt+=2;try{tt=this.consumeHexseq(L,tt)}catch{}return tt}if(tt=this.consumeHexseq(L,tt),L[tt]===":"&&L[tt+1]===":"){tt+=2;try{tt=this.consumeHexseq(L,tt)}catch{}return tt}return tt}consumeHexseq(L,X){let tt=X;for(;tt=this.consumeHex4(L,tt),L[tt]===":"&&L[tt+1]!==":";)tt+=1;return tt}consumeHex4(L,X){let tt=0;for(;tt<4;tt++)if(!((Ot=L[X+tt])>="0"&&Ot<="9"||Ot>="a"&&Ot<="f"||Ot>="A"&&Ot<="F")){if(tt===0)throw new Error("Invalid hex 4");break}var Ot;return X+tt}consumeFQDN(L,X){let tt=X;for(;y(L[tt])||G(L[tt])||L[tt]==="-"||L[tt]===".";)tt+=1;if(tt-X<4)throw new Error("Invalid FQDN");return tt}consumeExtnAddr(L,X){return this.consumeOneOrMore(L,X,B)}consumeMulticastAddress(L,X,tt){switch(tt){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(L,X);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(L,X);default:try{return this.consumeFQDN(L,X)}catch{return this.consumeExtnAddr(L,X)}}}consumeIP6MulticastAddress(L,X){const tt=this.consumeHexpart(L,X);return L[tt]==="/"?this.consumeInteger(L,tt+1):tt}consumeIP4MulticastAddress(L,X){let tt=X+3;const Ot=L.slice(X,tt),Oe=parseInt(Ot);if(Oe<224||Oe>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Gn=0;Gn<3;Gn++){if(L[tt]!==".")throw new Error("Invalid IP4 multicast address.");tt+=1,tt=this.consumeDecimalUChar(L,tt)}return L[tt]==="/"&&(tt+=1),tt=this.consumeTTL(L,tt),L[tt]==="/"&&(tt=this.consumeInteger(L,tt)),tt}consumeInteger(L,X){if(!U(L[X]))throw new Error("Invalid integer.");for(X+=1;y(L[X]);)X+=1;return X}consumeTTL(L,X){if(L[X]==="0")return X+1;if(!U(L[X]))throw new Error("Invalid TTL.");X+=1;for(let tt=0;tt<2&&y(L[X]);tt++)X+=1;return X}consumeToken(L,X){return this.consumeOneOrMore(L,X,k)}consumeTime(L,X){let tt=X;if(L[tt]==="0")return tt+1;for(U(L[tt])&&(tt+=1);y(L[tt]);)tt++;if(tt-X<10)throw new Error("Invalid time");return tt}consumeAddress(L,X){return this.consumeTill(L,X,R)}consumeTypedTime(L,X){let tt=X;return tt=this.consumeOneOrMore(L,tt,y),W(L[tt])?tt+1:tt}consumeRepeatInterval(L,X){if(!U(L[X]))throw new Error("Invalid repeat interval");for(X+=1;y(L[X]);)X+=1;return W(L[X])&&(X+=1),X}consumePort(L,X){return this.consumeOneOrMore(L,X,y)}consume(L,X,tt){for(let Ot=0;Ot<tt.length;Ot++){if(X+Ot>=L.length)throw new Error("consume exceeding value length");if(L[X+Ot]!==tt[Ot])throw new Error("consume ".concat(tt," failed at ").concat(Ot))}return X+tt.length}consumeTill(L,X,tt){let Ot=X;for(;Ot<L.length&&(typeof tt!="string"||L[Ot]!==tt)&&(typeof tt!="function"||!tt(L[Ot]));)Ot++;return Ot}}class Ye extends $t{constructor(){super(),wt(this,"records",[]),wt(this,"currentLine",0)}parse(L){const X=this.probeEOL(L);this.records=L.split(X).filter(Ar=>!!ms(Ar).call(Ar)).map(this.parseLine),this.currentLine=0;const tt=this.parseVersion(),Ot=this.parseOrigin(),Oe=this.parseSessionName(),Gn=this.parseInformation(),Gr=this.parseUri(),wa=this.parseEmail(),Kp=this.parsePhone(),H1=this.parseConnection(),K1=this.parseBandWidth(),Ld=this.parseTimeFields(),BE=this.parseKey(),WC=this.parseSessionAttribute(),or=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:tt,origin:Ot,sessionName:Oe,information:Gn,uri:Gr,emails:wa,phones:Kp,connection:H1,bandwidths:K1,timeFields:Ld,key:BE,attributes:WC,mediaDescriptions:or}}getCurrentRecord(){const L=this.records[this.currentLine];if(!L)throw new Error("Record doesn't exit.");return L}probeEOL(L){for(let X=0;X<L.length;X++)if(L[X]===f)return L[X-1]==="\r"?T:f;throw new Error("Invalid newline character.")}parseLine(L,X){if(L.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const tt=L[0];if(L[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:tt,value:L.slice(2),line:X,cur:0}}parseSessionAttribute(){const L=new ri;for(;this.currentLine<this.records.length;){const X=this.getCurrentRecord();if(X.type!==v.ATTRIBUTE)break;const tt={attField:this.extractOneOrMore(X,Ot=>k(Ot)&&Ot!==":"),_cur:0};X.value[X.cur]===":"&&(X.cur+=1,tt.attValue=this.extractOneOrMore(X,$)),L.parse(tt),this.currentLine++}return L.digest()}parseMediaAttributes(L){const X=new mr(L);for(;this.currentLine<this.records.length;){const tt=this.getCurrentRecord();if(tt.type!==v.ATTRIBUTE)break;const Ot={attField:this.extractOneOrMore(tt,Oe=>k(Oe)&&Oe!==":"),_cur:0};tt.value[tt.cur]===":"&&(tt.cur+=1,Ot.attValue=this.extractOneOrMore(tt,$)),X.parse(Ot),this.currentLine++}return X.digest()}parseKey(){const L=this.getCurrentRecord();if(L.type===v.KEY){if(L.value==="prompt"||L.value==="clear:"||L.value==="base64:"||L.value==="uri:")return L.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const L=this.getCurrentRecord();if(L.type===v.ZONE_ADJUSTMENTS){const X=[];for(;;)try{const tt=this.extract(L,this.consumeTime);this.consumeSpaceForRecord(L);let Ot=!1;L.value[L.cur]==="-"&&(Ot=!0,L.cur+=1);const Oe=this.extract(L,this.consumeTypedTime);X.push({time:tt,typedTime:Oe,back:Ot})}catch{break}if(X.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,X}return[]}parseRepeat(){const L=[];for(;;){const X=this.getCurrentRecord();if(X.type!==v.REPEAT)break;{const tt=this.extract(X,this.consumeRepeatInterval),Ot=this.parseTypedTime(X);L.push({repeatInterval:tt,typedTimes:Ot}),this.currentLine++}}return L}parseTypedTime(L){const X=[];for(;;)try{this.consumeSpaceForRecord(L),X.push(this.extract(L,this.consumeTypedTime))}catch{break}if(X.length===0)throw new Error("Invalid typed time.");return X}parseTime(){const L=this.getCurrentRecord(),X=this.extract(L,this.consumeTime);this.consumeSpaceForRecord(L);const tt=this.extract(L,this.consumeTime);return this.currentLine++,{startTime:X,stopTime:tt}}parseBandWidth(){const L=[];for(;this.currentLine<this.records.length;){const X=this.getCurrentRecord();if(X.type!==v.BANDWIDTH)break;{const tt=this.extractOneOrMore(X,k);if(X.value[X.cur]!==":")throw new Error("Invalid bandwidth field.");X.cur++;const Ot=this.extractOneOrMore(X,y);L.push({bwtype:tt,bandwidth:Ot}),this.currentLine++}}return L}parseVersion(){const L=this.getCurrentRecord();if(L.type!==v.VERSION)throw new Error("first sdp record must be version");const X=L.value.slice(0,this.consumeOneOrMore(L.value,0,y));if(X.length!==L.value.length)throw new Error('invalid proto version, "v='.concat(L.value,'"'));return this.currentLine++,X}parseOrigin(){const L=this.getCurrentRecord();if(L.type!==v.ORIGIN)throw new Error("second line of sdp must be origin");const X=this.extractOneOrMore(L,B);this.consumeSpaceForRecord(L);const tt=this.extractOneOrMore(L,y);this.consumeSpaceForRecord(L);const Ot=this.extractOneOrMore(L,y);this.consumeSpaceForRecord(L);const Oe=this.extractOneOrMore(L,k);this.consumeSpaceForRecord(L);const Gn=this.extractOneOrMore(L,k);this.consumeSpaceForRecord(L);const Gr=this.extract(L,this.consumeUnicastAddress);return this.currentLine++,{username:X,sessId:tt,sessVersion:Ot,nettype:Oe,addrtype:Gn,unicastAddress:Gr}}parseSessionName(){const L=this.getCurrentRecord();if(L.type===v.SESSION_NAME){const X=this.extract(L,this.consumeText);return this.currentLine++,X}}parseInformation(){const L=this.getCurrentRecord();if(L.type!==v.INFORMATION)return;const X=this.extract(L,this.consumeText);return this.currentLine++,X}parseUri(){const L=this.getCurrentRecord();if(L.type===v.URI)return this.currentLine++,L.value}parseEmail(){const L=[];for(;;){const X=this.getCurrentRecord();if(X.type!==v.EMAIL)break;L.push(X.value),this.currentLine++}return L}parsePhone(){const L=[];for(;;){const X=this.getCurrentRecord();if(X.type!==v.PHONE)break;L.push(X.value),this.currentLine++}return L}parseConnection(){const L=this.getCurrentRecord();if(L.type===v.CONNECTION){const X=this.extractOneOrMore(L,k);this.consumeSpaceForRecord(L);const tt=this.extractOneOrMore(L,k);this.consumeSpaceForRecord(L);const Ot=this.extract(L,this.consumeAddress);return this.currentLine++,{nettype:X,addrtype:tt,address:Ot}}}parseMedia(){const L=this.getCurrentRecord(),X=this.extract(L,this.consumeToken);this.consumeSpaceForRecord(L);let tt=this.extract(L,this.consumePort);L.value[L.cur]==="/"&&(L.cur+=1,tt+=this.extract(L,this.consumeInteger)),this.consumeSpaceForRecord(L);const Ot=[];for(Ot.push(this.extract(L,this.consumeToken));L.value[L.cur]==="/";)L.cur+=1,Ot.push(this.extract(L,this.consumeToken));if(Ot.length===0)throw new Error("Invalid proto");const Oe=this.parseFmt(L);return this.currentLine++,{mediaType:X,port:tt,protos:Ot,fmts:Oe}}parseTimeFields(){const L=[];for(;this.getCurrentRecord().type===v.TIME;){const X=this.parseTime(),tt=this.parseRepeat(),Ot=this.parseZone();L.push({time:X,repeats:tt,zones:Ot})}return L}parseMediaDescription(){const L=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===v.MEDIA;){const X=this.parseMedia(),tt=this.parseInformation(),Ot=this.parseConnections(),Oe=this.parseBandWidth(),Gn=this.parseKey(),Gr=this.parseMediaAttributes(X);L.push({media:X,information:tt,connections:Ot,bandwidths:Oe,key:Gn,attributes:Gr})}return L}parseConnections(){const L=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===v.CONNECTION;)L.push(this.parseConnection());return L}parseFmt(L){const X=[];for(;;)try{this.consumeSpaceForRecord(L),X.push(this.extract(L,this.consumeToken))}catch{break}if(X.length===0)throw new Error("Invalid fmts");return X}extract(L,X){for(var tt=arguments.length,Ot=new Array(tt>2?tt-2:0),Oe=2;Oe<tt;Oe++)Ot[Oe-2]=arguments[Oe];const Gn=X.call(this,L.value,L.cur,...Ot),Gr=L.value.slice(L.cur,Gn);return L.cur=Gn,Gr}extractOneOrMore(L,X){const tt=this.consumeOneOrMore(L.value,L.cur,X),Ot=L.value.slice(L.cur,tt);return L.cur=tt,Ot}consumeSpaceForRecord(L){if(L.value[L.cur]!==R)throw new Error("Invalid space at ".concat(L.cur,"."));L.cur+=1}}class bn extends $t{constructor(){super(...arguments),wt(this,"attributes",void 0),wt(this,"digested",!1)}extractOneOrMore(L,X,tt){const Ot=this.consumeOneOrMore(L.attValue,L._cur,X),Oe=L.attValue.slice(L._cur,Ot),[Gn,Gr]=tt||[];if(typeof Gn=="number"&&Oe.length<Gn)throw new Error("error in length, should be more or equal than ".concat(Gn," characters."));if(typeof Gr=="number"&&Oe.length>Gr)throw new Error("error in length, should be less or equal than ".concat(Gr," characters."));return L._cur=Ot,Oe}consumeAttributeSpace(L){if(L.attValue[L._cur]!==R)throw new Error("Invalid space at ".concat(L._cur,"."));L._cur+=1}extract(L,X){if(!L.attValue)throw new Error("Nothing to extract from attValue.");for(var tt=arguments.length,Ot=new Array(tt>2?tt-2:0),Oe=2;Oe<tt;Oe++)Ot[Oe-2]=arguments[Oe];const Gn=X.call(this,L.attValue,L._cur,...Ot),Gr=L.attValue.slice(L._cur,Gn);return L._cur=Gn,Gr}atEnd(L){if(!L.attValue)throw new Error;return L._cur>=L.attValue.length}peekChar(L){if(!L.attValue)throw new Error;return L.attValue[L._cur]}peek(L,X){if(!L.attValue)throw new Error;for(let tt=0;tt<X.length;tt++)if(X[tt]!==L.attValue[L._cur+tt])return!1;return!0}parseIceUfrag(L){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(L,rt,[4,256])}parseIcePwd(L){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(L,rt,[22,256])}parseIceOptions(L){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const X=[];for(;!this.atEnd(L);){X.push(this.extractOneOrMore(L,rt));try{this.consumeAttributeSpace(L)}catch(tt){if(this.atEnd(L))break;throw tt}}this.attributes.iceOptions=X}parseFingerprint(L){const X=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);const tt=this.extract(L,this.consumeTill);this.attributes.fingerprints.push({hashFunction:X,fingerprint:tt})}parseExtmap(L){const X=this.extractOneOrMore(L,y);let tt;this.peekChar(L)==="/"&&(this.extract(L,this.consume,"/"),tt=this.extract(L,this.consumeToken)),this.consumeAttributeSpace(L);const Ot=this.extract(L,this.consumeTill,R),Oe=Lt(Lt({entry:parseInt(X,10)},tt&&{direction:tt}),{},{extensionName:Ot});this.peekChar(L)===R&&(this.consumeAttributeSpace(L),Oe.extensionAttributes=this.extract(L,this.consumeTill)),this.attributes.extmaps.push(Oe)}parseSetup(L){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const X=this.extract(L,this.consumeTill);if(X!=="active"&&X!=="passive"&&X!=="actpass"&&X!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=X}}class ri extends bn{constructor(){super(...arguments),wt(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(L){if(this.digested)throw new Error("already digested");try{switch(L.attField){case"group":this.parseGroup(L);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(L);break;case"ice-pwd":this.parseIcePwd(L);break;case"ice-options":this.parseIceOptions(L);break;case"fingerprint":this.parseFingerprint(L);break;case"setup":this.parseSetup(L);break;case"tls-id":this.parseTlsId(L);break;case"identity":this.parseIdentity(L);break;case"extmap":this.parseExtmap(L);break;case"msid-semantic":this.parseMsidSemantic(L);break;default:L.ignored=!0,this.attributes.unrecognized.push(L)}}catch(X){throw console.error("parsing session attribute ".concat(L.attField,' error, "a=').concat(L.attField,":").concat(L.attValue,'"')),X}if(!L.ignored&&L.attValue&&!this.atEnd(L))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(L){const X=this.extract(L,this.consumeToken),tt=[];for(;!this.atEnd(L)&&this.peekChar(L)===R;)this.consumeAttributeSpace(L),tt.push(this.extract(L,this.consumeToken));this.attributes.groups.push({semantic:X,identificationTag:tt})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(L){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(L,ot)}parseIdentity(L){const X=this.extractOneOrMore(L,Et),tt=[];for(;!this.atEnd(L)&&this.peekChar(L)===R;){this.consumeAttributeSpace(L);const Ot=this.extract(L,this.consumeToken);this.extract(L,this.consume,"=");const Oe=this.extractOneOrMore(L,Gn=>Gn!==R&&$(Gn));tt.push({name:Ot,value:Oe})}this.attributes.identities.push({assertionValue:X,extensions:tt})}parseMsidSemantic(L){this.peekChar(L)===R&&this.consumeAttributeSpace(L);const X={semantic:this.extract(L,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(L)}catch{break}if(this.peekChar(L)==="*"){this.extract(L,this.consume,"*"),X.applyForAll=!0;break}{const tt=this.extract(L,this.consumeTill,R);X.identifierList.push(tt)}}this.attributes.msidSemantic=X}}class mr extends bn{constructor(L){super(),wt(this,"attributes",void 0),L.protos.indexOf("RTP")!==-1||L.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(L){if(this.digested)throw new Error("already digested");try{switch(L.attField){case"extmap":this.parseExtmap(L);break;case"setup":this.parseSetup(L);break;case"ice-ufrag":this.parseIceUfrag(L);break;case"ice-pwd":this.parseIcePwd(L);break;case"ice-options":this.parseIceOptions(L);break;case"candidate":this.parseCandidate(L);break;case"remote-candidate":this.parseRemoteCandidate(L);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(L);break;case"rtpmap":this.parseRtpmap(L);break;case"ptime":this.parsePtime(L);break;case"maxptime":this.parseMaxPtime(L);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(L);break;case"ssrc":this.parseSSRC(L);break;case"fmtp":this.parseFmtp(L);break;case"rtcp-fb":this.parseRtcpFb(L);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(L);break;case"mid":this.parseMid(L);break;case"msid":this.parseMsid(L);break;case"imageattr":this.parseImageAttr(L);break;case"rid":this.parseRid(L);break;case"simulcast":this.parseSimulcast(L);break;case"sctp-port":this.parseSctpPort(L);break;case"max-message-size":this.parseMaxMessageSize(L);break;case"ssrc-group":this.parseSSRCGroup(L);break;default:L.ignored=!0,this.attributes.unrecognized.push(L)}}catch(X){throw console.error("parsing media attribute ".concat(L.attField,' error, "a=').concat(L.attField,":").concat(L.attValue,'"')),X}if(!L.ignored&&L.attValue&&!this.atEnd(L))throw new Error("attribute parsing error")}parseCandidate(L){const X=this.extractOneOrMore(L,rt,[1,32]);this.consumeAttributeSpace(L);const tt=this.extractOneOrMore(L,y,[1,5]);this.consumeAttributeSpace(L);const Ot=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);const Oe=this.extractOneOrMore(L,y,[1,10]);this.consumeAttributeSpace(L);const Gn=this.extract(L,this.consumeAddress);this.consumeAttributeSpace(L);const Gr=this.extract(L,this.consumePort);this.consumeAttributeSpace(L),this.extract(L,this.consume,"typ"),this.consumeAttributeSpace(L);const wa={foundation:X,componentId:tt,transport:Ot,priority:Oe,connectionAddress:Gn,port:Gr,type:this.extract(L,this.consumeToken),extension:{}};for(this.peek(L," raddr")&&(this.extract(L,this.consume," raddr"),this.consumeAttributeSpace(L),wa.relAddr=this.extract(L,this.consumeAddress)),this.peek(L," rport")&&(this.extract(L,this.consume," rport"),this.consumeAttributeSpace(L),wa.relPort=this.extract(L,this.consumePort));this.peekChar(L)===R;){this.consumeAttributeSpace(L);const Kp=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L),wa.extension[Kp]=this.extractOneOrMore(L,w)}this.attributes.candidates.push(wa)}parseRemoteCandidate(L){const X=[];for(;;){const tt=this.extractOneOrMore(L,y,[1,5]);this.consumeAttributeSpace(L);const Ot=this.extract(L,this.consumeAddress);this.consumeAttributeSpace(L);const Oe=this.extract(L,this.consumePort);X.push({componentId:tt,connectionAddress:Ot,port:Oe});try{this.consumeAttributeSpace(L)}catch{break}}this.attributes.remoteCandidatesList.push(X)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(L){const X=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);const tt=this.extract(L,this.consumeTill,"/");this.extract(L,this.consume,"/");const Ot={encodingName:tt,clockRate:this.extractOneOrMore(L,y)};this.atEnd(L)||this.peekChar(L)!=="/"||(this.extract(L,this.consume,"/"),Ot.encodingParameters=parseInt(this.extract(L,this.consumeTill),10));const Oe=this.attributes.payloads.find(Gn=>Gn.payloadType===parseInt(X,10));Oe?Oe.rtpMap=Ot:this.attributes.payloads.push({payloadType:parseInt(X,10),rtpMap:Ot,rtcpFeedbacks:[]})}parsePtime(L){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(L,this.consumeTill)}parseMaxPtime(L){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(L,this.consumeTill)}parseDirection(L){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=L.attField}parseSSRC(L){const X=this.extractOneOrMore(L,y);this.consumeAttributeSpace(L);const tt=this.extract(L,this.consumeTill,":");let Ot;this.peekChar(L)===":"&&(this.extract(L,this.consume,":"),Ot=this.extract(L,this.consumeTill));const Oe=this.attributes.ssrcs.find(Gn=>Gn.ssrcId===parseInt(X,10));Oe?Oe.attributes[tt]=Ot:this.attributes.ssrcs.push({ssrcId:parseInt(X,10),attributes:{[tt]:Ot}})}parseFmtp(L){const X=this.extract(L,this.consumeTill,R);this.consumeAttributeSpace(L);const tt=this.extract(L,this.consumeTill),Ot={};tt.split(";").forEach(Gn=>{let[Gr,wa]=Gn.split("=");Gr=ms(Gr).call(Gr);const Kp=typeof wa=="string"?ms(wa).call(wa):null;typeof Gr=="string"&&Gr.length>0&&(Ot[Gr]=Kp)});const Oe=this.attributes.payloads.find(Gn=>Gn.payloadType===parseInt(X,10));Oe?Oe.fmtp={parameters:Ot}:this.attributes.payloads.push({payloadType:parseInt(X,10),rtcpFeedbacks:[],fmtp:{parameters:Ot}})}parseFmtParameters(L){const X={},tt=this.extract(L,this.consumeTill,"=");L._cur++;const Ot=this.extract(L,this.consumeTill,";");for(X[tt]=Ot;L.attValue[L._cur]===";";){const Oe=this.extract(L,this.consumeTill,"=");L._cur++;const Gn=this.extract(L,this.consumeTill,";");X[Oe]=Gn}return X}parseRtcpFb(L){let X="";X=this.peekChar(L)==="*"?this.extract(L,this.consume,"*"):this.extract(L,this.consumeTill,R),this.consumeAttributeSpace(L);const tt=this.extract(L,this.consumeTill,R);let Ot;if(tt==="trr-int")Ot={type:tt,interval:this.extract(L,this.consumeTill)};else{const Oe={type:tt};this.peekChar(L)===R&&(this.consumeAttributeSpace(L),Oe.parameter=this.extract(L,this.consumeToken),this.peekChar(L)===R&&(Oe.additional=this.extract(L,this.consumeTill))),Ot=Oe}if(X==="*")this.attributes.rtcpFeedbackWildcards.push(Ot);else{const Oe=this.attributes.payloads.find(Gn=>Gn.payloadType===parseInt(X,10));Oe?Oe.rtcpFeedbacks.push(Ot):this.attributes.payloads.push({payloadType:parseInt(X,10),rtcpFeedbacks:[Ot]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(L){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const X={port:this.extract(L,this.consumePort)};this.peekChar(L)===R&&(this.consumeAttributeSpace(L),X.netType=this.extractOneOrMore(L,k),this.consumeAttributeSpace(L),X.addressType=this.extractOneOrMore(L,k),this.consumeAttributeSpace(L),X.address=this.extract(L,this.consumeAddress)),this.attributes.rtcp=X}parseMsid(L){const X={id:this.extractOneOrMore(L,k,[1,64])};this.peekChar(L)===R&&(this.consumeAttributeSpace(L),X.appdata=this.extractOneOrMore(L,k,[1,64])),this.attributes.msids.push(X)}parseImageAttr(L){this.attributes.imageattr.push(L.attValue)}parseRid(L){const X=this.extractOneOrMore(L,Ot=>G(Ot)||y(Ot)||Ot==="_"||Ot==="-");this.consumeAttributeSpace(L);const tt={id:X,direction:this.extract(L,this.consumeToken),params:[]};if(this.peekChar(L)===R){if(this.consumeAttributeSpace(L),this.peek(L,"pt=")){this.extract(L,this.consume,"pt=");const Ot=[];for(;;){const Oe=this.extract(L,this.consumeToken);Ot.push(Oe);try{this.extract(L,this.consume,",")}catch{break}}tt.payloads=Ot,this.peekChar(L)===R&&this.extract(L,this.consume,R)}for(;;){const Ot=this.extract(L,this.consumeToken);switch(Ot){case"depend":{const Oe={type:Ot,rids:this.extract(L,this.consume,"=").split(",")};tt.params.push(Oe);break}default:{const Oe={type:Ot};this.peekChar(L)==="="&&(this.extract(L,this.consume,"="),Oe.val=this.extract(L,this.consumeTill,";")),tt.params.push(Oe)}}try{this.extract(L,this.consume,";")}catch{break}}}this.attributes.rids.push(tt)}parseSimulcast(L){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=L.attValue,this.extract(L,this.consumeTill)}parseSctpPort(L){this.attributes.sctpPort=this.extractOneOrMore(L,y,[1,5])}parseMaxMessageSize(L){this.attributes.maxMessageSize=this.extractOneOrMore(L,y,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(L){this.attributes.mid=this.extract(L,this.consumeToken)}parseSSRCGroup(L){const X=this.extract(L,this.consumeToken),tt=[];for(;;)try{this.consumeAttributeSpace(L);const Ot=this.extract(L,this.consumeInteger);tt.push(parseInt(Ot,10))}catch{break}this.attributes.ssrcGroups.push({semantic:X,ssrcIds:tt})}}function Li(Ft,L,X){return L in Ft?Object.defineProperty(Ft,L,{value:X,enumerable:!0,configurable:!0,writable:!0}):Ft[L]=X,Ft}class _u{constructor(){Li(this,"eol",T)}print(L,X){let tt="";return X&&(this.eol=X),tt+=this.printVersion(L.version),tt+=this.printOrigin(L.origin),tt+=this.printSessionName(L.sessionName),tt+=this.printInformation(L.information),tt+=this.printUri(L.uri),tt+=this.printEmail(L.emails),tt+=this.printPhone(L.phones),tt+=this.printConnection(L.connection),tt+=this.printBandwidth(L.bandwidths),tt+=this.printTimeFields(L.timeFields),tt+=this.printKey(L.key),tt+=this.printSessionAttributes(L.attributes),tt+=this.printMediaDescription(L.mediaDescriptions),tt}printVersion(L){return"v=".concat(L).concat(this.eol)}printOrigin(L){return"o=".concat(L.username," ").concat(L.sessId," ").concat(L.sessVersion," ").concat(L.nettype," ").concat(L.addrtype," ").concat(L.unicastAddress).concat(this.eol)}printSessionName(L){return L?"s=".concat(L).concat(this.eol):""}printInformation(L){return L?"i=".concat(L).concat(this.eol):""}printUri(L){return L?"u=".concat(L).concat(this.eol):""}printEmail(L){let X="";for(const tt of L)X+="e=".concat(tt).concat(this.eol);return X}printPhone(L){let X="";for(const tt of L)X+="e=".concat(tt).concat(this.eol);return X}printConnection(L){return L?"c=".concat(L.nettype," ").concat(L.addrtype," ").concat(L.address).concat(this.eol):""}printBandwidth(L){let X="";for(const tt of L)X+="b=".concat(tt.bwtype,":").concat(tt.bandwidth).concat(this.eol);return X}printTimeFields(L){let X="";for(const tt of L){X+="t=".concat(tt.time.startTime," ").concat(tt.time.startTime).concat(this.eol);for(const Ot of tt.repeats)X+="r=".concat(Ot.repeatInterval," ").concat(Ot.typedTimes.join(" ")).concat(this.eol);tt.zoneAdjustments&&(X+="z=",X+="z=".concat(tt.zoneAdjustments.map(Ot=>"".concat(Ot.time," ").concat(Ot.back?"-":""," ").concat(Ot.typedTime)).join(" ")).concat(this.eol),X+=this.eol)}return X}printKey(L){return L?"k=".concat(L).concat(this.eol):""}printAttributes(L){let X="";for(const tt of L)X+="a=".concat(tt.attField).concat(tt.attValue?":".concat(tt.attValue):"").concat(this.eol);return X}printMediaDescription(L){let X="";for(const tt of L)X+=this.printMedia(tt.media),X+=this.printInformation(tt.information),X+=this.printConnections(tt.connections),X+=this.printBandwidth(tt.bandwidths),X+=this.printKey(tt.key),X+=this.printMediaAttributes(tt);return X}printConnections(L){let X="";for(const tt of L)X+=this.printConnection(tt);return X}printMedia(L){return"m=".concat(L.mediaType," ").concat(L.port," ").concat(L.protos.join("/")," ").concat(L.fmts.join(" ")).concat(this.eol)}printSessionAttributes(L){return new Pt(this.eol).print(L)}printMediaAttributes(L){return new Zt(this.eol).print(L)}}class Ct{constructor(L){Li(this,"eol",void 0),this.eol=L}printIceUfrag(L){return L===void 0?"":"a=ice-ufrag:".concat(L).concat(this.eol)}printIcePwd(L){return L===void 0?"":"a=ice-pwd:".concat(L).concat(this.eol)}printIceOptions(L){return L===void 0?"":"a=ice-options:".concat(L.join(R)).concat(this.eol)}printFingerprints(L){return L.length>0?L.map(X=>"a=fingerprint:".concat(X.hashFunction).concat(R).concat(X.fingerprint)).join(this.eol)+this.eol:""}printExtmap(L){return L.map(X=>"a=extmap:".concat(X.entry).concat(X.direction?"/".concat(X.direction):"").concat(R).concat(X.extensionName).concat(X.extensionAttributes?"".concat(R).concat(X.extensionAttributes):"").concat(this.eol)).join("")}printSetup(L){return L===void 0?"":"a=setup:".concat(L).concat(this.eol)}printUnrecognized(L){return L.map(X=>"a=".concat(X.attField).concat(X.attValue?":".concat(X.attValue):"").concat(this.eol)).join("")}}class Pt extends Ct{print(L){let X="";return X+=this.printGroups(L.groups),X+=this.printMsidSemantic(L.msidSemantic),X+=this.printIceLite(L.iceLite),X+=this.printIceUfrag(L.iceUfrag),X+=this.printIcePwd(L.icePwd),X+=this.printIceOptions(L.iceOptions),X+=this.printFingerprints(L.fingerprints),X+=this.printSetup(L.setup),X+=this.printTlsId(L.tlsId),X+=this.printIdentity(L.identities),X+=this.printExtmap(L.extmaps),X+=this.printUnrecognized(L.unrecognized),X}printGroups(L){let X="";return L.length>0&&(X+=L.map(tt=>"a=group:".concat(tt.semantic).concat(tt.identificationTag.map(Ot=>"".concat(R).concat(Ot)).join("")).concat(this.eol)).join("")),X}printIceLite(L){return L===void 0?"":"a=ice-lite"+this.eol}printTlsId(L){return L?"a=tls-id:".concat(L).concat(this.eol):""}printIdentity(L){return L.length===0?"":L.map(X=>"a=identity:".concat(X.assertionValue).concat(X.extensions.map(tt=>"".concat(R).concat(tt.name).concat(tt.value?"=".concat(tt.value):"")))).join(this.eol)+this.eol}printMsidSemantic(L){if(!L)return"";let X="a=msid-semantic:".concat(L.semantic);return L.applyForAll?X+="".concat(R,"*"):L.identifierList.length>0&&(X+=L.identifierList.map(tt=>"".concat(R).concat(tt))),X+this.eol}}class Zt extends Ct{print(L){const X=L.attributes;let tt="";return tt+=this.printRTCP(X.rtcp),tt+=this.printIceUfrag(X.iceUfrag),tt+=this.printIcePwd(X.icePwd),tt+=this.printIceOptions(X.iceOptions),tt+=this.printCandidates(X.candidates),tt+=this.printRemoteCandidatesList(X.remoteCandidatesList),tt+=this.printEndOfCandidates(X.endOfCandidates),tt+=this.printFingerprints(X.fingerprints),tt+=this.printSetup(X.setup),tt+=this.printMid(X.mid),tt+=this.printExtmap(X.extmaps),tt+=this.printRTPRelated(X),tt+=this.printPtime(X.ptime),tt+=this.printMaxPtime(X.maxPtime),tt+=this.printDirection(X.direction),tt+=this.printSSRCGroups(X.ssrcGroups),tt+=this.printSSRC(X.ssrcs),tt+=this.printRTCPMux(X.rtcpMux),tt+=this.printRTCPMuxOnly(X.rtcpMuxOnly),tt+=this.printRTCPRsize(X.rtcpRsize),tt+=this.printMSId(X.msids),tt+=this.printImageattr(X.imageattr),tt+=this.printRid(X.rids),tt+=this.printSimulcast(X.simulcast),tt+=this.printSCTPPort(X.sctpPort),tt+=this.printMaxMessageSize(X.maxMessageSize),tt+=this.printUnrecognized(X.unrecognized),tt}printCandidates(L){return L.map(X=>"a=candidate:".concat(X.foundation).concat(R).concat(X.componentId).concat(R).concat(X.transport).concat(R).concat(X.priority).concat(R).concat(X.connectionAddress).concat(R).concat(X.port).concat(R,"typ").concat(R).concat(X.type).concat(X.relAddr?"".concat(R,"raddr").concat(R).concat(X.relAddr):"").concat(X.relPort?"".concat(R,"rport").concat(R).concat(X.relPort):"").concat(Object.keys(X.extension).map(tt=>"".concat(R).concat(tt).concat(R).concat(X.extension[tt])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(L){return L.map(X=>"a=remote-candidates:".concat(X.join(R)).concat(this.eol)).join("")}printEndOfCandidates(L){return L===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(L){if(!L.payloads)return"";const X=L.payloads;let tt="";tt+=L.rtcpFeedbackWildcards.map(Ot=>this.printRTCPFeedback("*",Ot)).join("");for(const Ot of X)tt+=this.printRtpMap(Ot.payloadType,Ot.rtpMap),tt+=this.printFmtp(Ot.payloadType,Ot.fmtp),tt+=Ot.rtcpFeedbacks.map(Oe=>this.printRTCPFeedback(Ot.payloadType,Oe)).join("");return tt}printFmtp(L,X){if(!X)return"";const tt=Object.keys(X.parameters);return tt.length===1&&X.parameters[tt[0]]===null?"a=fmtp:".concat(L).concat(R).concat(tt[0]).concat(this.eol):"a=fmtp:".concat(L).concat(R).concat(Object.keys(X.parameters).map(Ot=>"".concat(Ot,"=").concat(X.parameters[Ot])).join(";")).concat(this.eol)}printRtpMap(L,X){return X?"a=rtpmap:".concat(L).concat(R).concat(X.encodingName,"/").concat(X.clockRate).concat(X.encodingParameters?"/".concat(X.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(L,X){let tt="a=rtcp-fb:".concat(L).concat(R),Ot=X;return Ot.type==="trr-int"?tt+="ttr-int".concat(R).concat(Ot.interval):(tt+="".concat(Ot.type),Ot.parameter&&(tt+="".concat(R).concat(Ot.parameter),Ot.additional&&(tt+="".concat(R).concat(Ot.additional)))),tt+this.eol}printPtime(L){return L===void 0?"":"a=ptime:".concat(L).concat(this.eol)}printMaxPtime(L){return L===void 0?"":"a=maxptime:".concat(L).concat(this.eol)}printDirection(L){return L===void 0?"":"a=".concat(L).concat(this.eol)}printSSRC(L){return L.map(X=>Object.keys(X.attributes).map(tt=>"a=ssrc:".concat(X.ssrcId.toString(10)).concat(R).concat(tt).concat(X.attributes[tt]?":".concat(X.attributes[tt]):"").concat(this.eol)).join("")).join("")}printRTCPMux(L){return L===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(L){return L===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(L){return L===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(L){if(L===void 0)return"";let X="a=rtcp:".concat(L.port);return L.netType&&(X+="".concat(R).concat(L.netType)),L.addressType&&(X+="".concat(R).concat(L.addressType)),L.address&&(X+="".concat(R).concat(L.address)),X+this.eol}printMSId(L){return L.map(X=>"a=msid:".concat(X.id).concat(X.appdata?"".concat(R).concat(X.appdata):"").concat(this.eol)).join("")}printImageattr(L){return L.map(X=>"a=imageattr:".concat(X).concat(this.eol)).join("")}printRid(L){return L.map(X=>{let tt="a=rid:".concat(X.id).concat(R).concat(X.direction);return X.payloads&&(tt+="".concat(R,"pt=").concat(X.payloads.join(","))),X.params.length>0&&(tt+="".concat(R).concat(X.params.map(Ot=>Ot.type==="depend"?"depend=".concat(Ot.rids.join(",")):"".concat(Ot.type,"=").concat(Ot.val)).join(";"))),tt+this.eol}).join("")}printSimulcast(L){return L===void 0?"":"a=simulcast:".concat(L).concat(this.eol)}printSCTPPort(L){return L===void 0?"":"a=sctp-port:".concat(L).concat(this.eol)}printMaxMessageSize(L){return L===void 0?"":"a=max-message-size:".concat(L).concat(this.eol)}printMid(L){return L===void 0?"":"a=mid:".concat(L).concat(this.eol)}printSSRCGroups(L){return L.map(X=>"a=ssrc-group:".concat(X.semantic).concat(X.ssrcIds.map(tt=>"".concat(R).concat(tt.toString(10))).join("")).concat(this.eol)).join("")}}function we(Ft){return new Ye().parse(Ft)}function Sn(Ft,L){return new _u().print(Ft,L)}}},a={};function d(l){if(a[l])return a[l].exports;var p=a[l]={exports:{}};return r[l](p,p.exports,d),p.exports}return d.d=(l,p)=>{for(var E in p)d.o(p,E)&&!d.o(l,E)&&Object.defineProperty(l,E,{enumerable:!0,get:p[E]})},d.o=(l,p)=>Object.prototype.hasOwnProperty.call(l,p),d.r=l=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(l,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(l,"__esModule",{value:!0})},d(8)})()})(Ww);var Qr=Ww.exports;function uC(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:J("SVC_MODE");if(J("ENABLE_SVC"))return function(n){return n in ke}(t)?t:ke.L1T3}const t1={[Kt.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[Kt.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function lC(t,n,r){n.forEach(a=>{var d;const l=t1[t].find(E=>{var f;let{key:T}=E;return Mt(f=a.extensionName).call(f,T)});if(!l)return;const p=r.find(E=>{let{extensionName:f}=E;return Mt(f).call(f,l.key)});p&&Mt(d=p.extensionName).call(d,"gdpr_forbidden")&&(a.extensionName=p.extensionName)})}function Mp(t,n){n.forEach(r=>{var a;const d=t1[t].find(l=>{var p;let{key:E}=l;return Mt(p=r.extensionName).call(p,E)});Mt(a=r.extensionName).call(a,"gdpr_forbidden")&&d&&(r.extensionName=d.extensionName)})}function ci(t){return t==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||Mt(t).call(t,"abs-send-time")}function Ho(t){return t==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||Mt(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function Hw(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function hC(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Hw(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Hw(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}function ya(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0;const{filterRTX:d,filterVideoFec:l,filterAudioFec:p,filterAudioCodec:E,filterVideoCodec:f}=n,{useXR:T}=r;let R=[],v=[],y=[],w=[],B=!1,k=!1;if(Qr.parse(t).mediaDescriptions.forEach(G=>{a&&a!==G.attributes.direction||(G.media.mediaType!=="video"||B||(v=G.attributes.payloads,w=G.attributes.extmaps,B=!0),G.media.mediaType!=="audio"||k||(R=G.attributes.payloads,y=G.attributes.extmaps,k=!0))}),!w||v.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!y||R.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(v.forEach(G=>{var W;(W=G.rtpMap)!==null&&W!==void 0&&W.clockRate&&(G.rtpMap.clockRate=parseInt(G.rtpMap.clockRate)),T&&G.rtcpFeedbacks.push({type:"rrtr"})}),R.forEach(G=>{var W;(W=G.rtpMap)!==null&&W!==void 0&&W.clockRate&&(G.rtpMap.clockRate=parseInt(G.rtpMap.clockRate)),T&&G.rtcpFeedbacks.push({type:"rrtr"})}),d&&(R=R.filter(G=>{var W;return((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName.toLowerCase())!=="rtx"}),v=v.filter(G=>{var W;return((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName.toLowerCase())!=="rtx"})),l&&(v=v.filter(G=>{var W;return!/(red)|(ulpfec)|(flexfec)/i.test(((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName)||"")})),p&&(R=R.filter(G=>{var W;return!/(red)|(ulpfec)|(flexfec)/i.test(((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName)||"")})),E&&(E==null?void 0:E.length)>0&&(R=R.filter(G=>{var W;return Mt(E).call(E,((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName.toLowerCase())||"")})),f&&(f==null?void 0:f.length)>0){const G=v.filter(W=>{var $;return Mt(f).call(f,(($=W.rtpMap)===null||$===void 0?void 0:$.encodingName.toLowerCase())||"")});v=G.concat(d?[]:mC(G,v))}const U=J("UNSUPPORTED_VIDEO_CODEC");return U&&U.length>0&&(v=v.filter(G=>!(G.rtpMap&&Mt(U).call(U,G.rtpMap.encodingName.toLowerCase())))),{audioCodecs:R,videoCodecs:v,audioExtensions:y,videoExtensions:w}}function xc(t){const n=Qr.parse(t);let r,a;for(const d of n.mediaDescriptions){if(!r){const l=d.attributes.iceUfrag,p=d.attributes.icePwd;if(!l||!p)throw new Error("Cannot get iceUfrag or icePwd from SDP.");r={iceUfrag:l,icePwd:p}}if(!a){const l=d.attributes.fingerprints;l.length>0&&(a={fingerprints:l})}}if(!a&&n.attributes.fingerprints.length>0&&(a={fingerprints:n.attributes.fingerprints}),!a||!r)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:r,dtlsParameters:a}}function Kw(t,n){const r=[],a=t.attributes.ssrcGroups.filter(p=>p.semantic==="FID"),d=t.attributes.ssrcGroups.find(p=>p.semantic==="SIM"),l=t.attributes.ssrcs;if(d)d.ssrcIds.forEach(p=>{var E;const f=(E=a.find(T=>T.ssrcIds[0]===p))===null||E===void 0?void 0:E.ssrcIds[1];r.push({ssrcId:p,rtx:n?f:void 0})});else if(a.length>0){const p=a[0].ssrcIds[0],E=a[0].ssrcIds[1];r.push({ssrcId:p,rtx:n?E:void 0})}else{if(l.length===0)throw new Error("No ssrcs found on local media description.");r.push({ssrcId:l[0].ssrcId})}return r}function Yw(t,n,r){const{cname:a}=t;let d=[];n&&(d=qw(n)),d.length===0&&(d=t.iceParameters.candidates.map(R=>({foundation:R.foundation,componentId:"1",transport:R.protocol,priority:R.priority.toString(),connectionAddress:R.ip,port:R.port.toString(),type:R.type,extension:{}})),N.debug("Using candidates from gateway."));const l={fingerprints:t.dtlsParameters.fingerprints.map(R=>({hashFunction:R.algorithm,fingerprint:R.fingerprint}))},p={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let E;switch(t.dtlsParameters.role){case"server":E="passive";break;case"client":E="active";break;case"auto":E="actpass"}const f=EC(t.rtpCapabilities),T=[];return Array.isArray(r)&&r.length>0&&r.forEach(R=>{T.push({kind:Kt.VIDEO,ssrcId:R.v,rtx:R.v_rtx,mslabel:"".concat(R.v,"_").concat(R.a)},{kind:Kt.AUDIO,ssrcId:R.a,mslabel:"".concat(R.v,"_").concat(R.a)})}),{dtlsParameters:l,iceParameters:p,candidates:d,rtpCapabilities:f,setup:E,cname:a,preSSRCs:T}}function qw(t){let n=[];return t.ip&&typeof t.port=="number"&&(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],N.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),N.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))),n}function Jl(t,n,r){const a=[],d=[];return t.forEach(l=>{let{ssrcId:p,rtx:E}=l;const f=Vn(8,"track-"),T={ssrcId:p,attributes:hC({label:f,mslabel:r=r||Vn(10,""),msid:"".concat(r," ").concat(f)},n&&{cname:n})};if(a.push(T),E!==void 0){const R={ssrcId:E,attributes:hC({label:f,mslabel:r,msid:"".concat(r," ").concat(f)},n&&{cname:n})};a.push(R),d.push({semantic:"FID",ssrcIds:[p,E]})}}),t.length>1&&d.push({semantic:"SIM",ssrcIds:t.map(l=>{let{ssrcId:p}=l;return p})}),{ssrcs:a,ssrcGroups:d}}function Up(t,n){n instanceof Ai&&t.attributes.payloads.forEach(r=>{var a;const d=(a=r.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase();if(!d||["opus","pcmu","pcma","g722"].indexOf(d)===-1)return;r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters.minptime="10",r.fmtp.parameters.useinbandfec="1";const l=n._encoderConfig;l&&d!=="pcmu"&&d!=="pcma"&&d!=="g722"&&(l.bitrate&&!Ii()&&(r.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*l.bitrate))),l.sampleRate&&(r.fmtp.parameters.maxplaybackrate="".concat(l.sampleRate),r.fmtp.parameters["sprop-maxcapturerate"]="".concat(l.sampleRate)),l.stereo&&(r.fmtp.parameters.stereo="1",r.fmtp.parameters["sprop-stereo"]="1"))})}function pC(t){const n=t.attributes.unrecognized.findIndex(r=>r.attField==="x-google-flag"&&r.attValue==="conference");n!==-1&&t.attributes.unrecognized.splice(n,1)}function Ig(t,n){var r;if(!(n instanceof qn&&n._encoderConfig&&n._hints.indexOf(vn.SCREEN_TRACK)===-1))return;const a=n._encoderConfig;nn().supportMinBitrate&&a.bitrateMin&&t.attributes.payloads.forEach(d=>{var l,p;Mt(l=["h264","h265","vp8","vp9","av1"]).call(l,((p=d.rtpMap)===null||p===void 0?void 0:p.encodingName.toLowerCase())||"")&&(d.fmtp||(d.fmtp={parameters:{}}),d.fmtp.parameters["x-google-min-bitrate"]="".concat(a.bitrateMin))}),nn().supportMinBitrate&&!Mt(r=n._hints).call(r,vn.LOW_STREAM)&&a.bitrateMax&&t.attributes.payloads.forEach(d=>{var l,p;Mt(l=["h264","h265","vp8","vp9","av1"]).call(l,((p=d.rtpMap)===null||p===void 0?void 0:p.encodingName.toLowerCase())||"")&&(d.fmtp||(d.fmtp={parameters:{}}),d.fmtp.parameters["x-google-start-bitrate"]="".concat(J("X_GOOGLE_START_BITRATE")||Math.floor(a.bitrateMax)))})}function zw(t){if(t.media.mediaType!=="video")return;const n=en();if(n.name!==mn.SAFARI&&n.os!==Cr.IOS)return;const r=t.attributes.extmaps.findIndex(a=>/video-orientation/g.test(a.extensionName));r!==-1&&t.attributes.extmaps.splice(r,1)}function _C(t,n,r){if(!n)return;let a,d;if(t.media.mediaType==="video"?(a=r.videoExtensions,d=r.videoCodecs):(a=r.audioExtensions,d=r.audioCodecs),n.twcc===!0){const l=a.find(p=>Ho(p.extensionName));if(l){const p=l.extensionName;t.attributes.extmaps.find(f=>Ho(f.extensionName))||t.attributes.extmaps.push({entry:l.entry,extensionName:p}),function(f,T){return T.filter(R=>!!f.find(v=>v.payloadType===R.payloadType&&!!v.rtcpFeedbacks.find(y=>y.type==="transport-cc")))}(d,t.attributes.payloads).forEach(f=>{f.rtcpFeedbacks.find(T=>T.type==="transport-cc")||f.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(n.twcc===!1){const l=t.attributes.extmaps.findIndex(p=>Ho(p.extensionName));l!==-1&&t.attributes.extmaps.splice(l,1),t.attributes.payloads.forEach(p=>{const E=p.rtcpFeedbacks.findIndex(f=>f.type==="transport-cc");E!==-1&&p.rtcpFeedbacks.splice(E,1)})}if(n.remb===!0){const l=a.find(p=>ci(p.extensionName));if(l){const p=l.extensionName;t.attributes.extmaps.find(f=>f.extensionName===p)||t.attributes.extmaps.push({entry:l.entry,extensionName:p}),function(f,T){return T.filter(R=>!!f.find(v=>v.payloadType===R.payloadType&&!!v.rtcpFeedbacks.find(y=>y.type==="goog-remb")))}(d,t.attributes.payloads).forEach(f=>{f.rtcpFeedbacks.find(T=>T.type==="goog-remb")||f.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(n.remb===!1){const l=t.attributes.extmaps.findIndex(p=>ci(p.extensionName));l!==-1&&t.attributes.extmaps.splice(l,1),t.attributes.payloads.forEach(p=>{const E=p.rtcpFeedbacks.findIndex(f=>f.type==="goog-remb");E!==-1&&p.rtcpFeedbacks.splice(E,1)})}}function e1(t,n,r){if(Ii()||t.media.mediaType!=="video"||!(n instanceof qn)||r!=="vp9"&&r!=="vp8"||r==="vp8"&&!J("SIMULCAST")||r==="vp9"&&J("ENABLE_SVC")||n._scalabilityMode===void 0||n._scalabilityMode.numSpatialLayers<=1)return;const a=r==="vp8"?2:n._scalabilityMode.numSpatialLayers,d=t.attributes.ssrcs[0],l=t.attributes.ssrcGroups.find(E=>E.semantic==="FID"&&E.ssrcIds[0]===d.ssrcId),p={semantic:"SIM",ssrcIds:[d.ssrcId]};for(let E=1;E<a;E++)t.attributes.ssrcs.push({ssrcId:d.ssrcId+E,attributes:xi(d.attributes)}),p.ssrcIds.push(d.ssrcId+E),l&&(t.attributes.ssrcs.push({ssrcId:l.ssrcIds[1]+E,attributes:xi(d.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[d.ssrcId+E,l.ssrcIds[1]+E]}));t.attributes.ssrcGroups.unshift(p)}async function Jw(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=new RTCPeerConnection;r.addTransceiver("video",{direction:"sendonly"}),r.addTransceiver("audio",{direction:"sendonly"}),r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"});const a=(await r.createOffer()).sdp,{send:d,recv:l,sendrecv:p}=function(){let E=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},f=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},T=arguments.length>2?arguments[2]:void 0;const R=ya(T,E,f,"sendonly"),v=ya(T,E,f,"recvonly"),y={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},w={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},B={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(cc(R,v,"videoExtensions",y,w,B),cc(R,v,"videoCodecs",y,w,B),cc(R,v,"audioExtensions",y,w,B),cc(R,v,"audioCodecs",y,w,B),J("RAISE_H264_BASELINE_PRIORITY")){const k=[],U=[];B.videoCodecs.forEach((G,W)=>{var $;if((($=G.rtpMap)===null||$===void 0?void 0:$.encodingName.toLocaleLowerCase())==="h264"){var rt,ot;const Et=B.videoCodecs[W+1],vt=Et&&ro(G,Et),Lt=(rt=G.fmtp)===null||rt===void 0?void 0:rt.parameters["profile-level-id"],wt=(ot=G.fmtp)===null||ot===void 0?void 0:ot.parameters["packetization-mode"];!Lt||Lt!==J("FIRST_H264_PROFILE_LEVEL_ID")||J("FIRST_PACKETIZATION_MODE")&&wt!==J("FIRST_PACKETIZATION_MODE")?vt?U.push([G,Et]):U.push([G]):vt?k.push([G,Et]):k.push([G])}}),k.length>0&&U.length>0&&(N.debug("raising H264 baseline profile priority"),B.videoCodecs.forEach((G,W)=>{var $;if((($=G.rtpMap)===null||$===void 0?void 0:$.encodingName.toLocaleLowerCase())==="h264"){const rt=ro(G,B.videoCodecs[W+1]),ot=k.shift()||U.shift()||[];ot.length>0&&(rt?B.videoCodecs.splice(W,2,...ot):B.videoCodecs.splice(W,1,...ot))}}),w.videoCodecs=w.videoCodecs.filter(G=>{var W,$;return!(((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName.toLocaleLowerCase())==="h264"&&(($=G.fmtp)===null||$===void 0?void 0:$.parameters["profile-level-id"])!==J("FIRST_H264_PROFILE_LEVEL_ID"))}),J("FILTER_SEND_H264_BASELINE")&&(y.videoCodecs=y.videoCodecs.filter(G=>{var W,$;return!(((W=G.rtpMap)===null||W===void 0?void 0:W.encodingName.toLocaleLowerCase())==="h264"&&(($=G.fmtp)===null||$===void 0?void 0:$.parameters["profile-level-id"])!==J("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:y,recv:w,sendrecv:B}}(t,n,a);try{r.close()}catch{}return{send:d,recv:l,sendrecv:p}}function Xl(){const t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},n=ya(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},d={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(cc(t,n,"videoExtensions",r,a,d),cc(t,n,"videoCodecs",r,a,d),cc(t,n,"audioExtensions",r,a,d),cc(t,n,"audioCodecs",r,a,d),J("RAISE_H264_BASELINE_PRIORITY")){const l=d.videoCodecs.findIndex(p=>p.rtpMap&&p.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&p.fmtp&&p.fmtp.parameters["profile-level-id"]==="42001f");if(l!==-1){const p=d.videoCodecs.findIndex(E=>E.rtpMap&&E.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(p<l){N.debug("raising H264 baseline profile priority");const E=d.videoCodecs[l];d.videoCodecs.splice(l,1),d.videoCodecs.splice(p,0,E)}p!==-1&&(a.videoCodecs=a.videoCodecs.filter(E=>!(E.rtpMap&&E.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&E.fmtp&&E.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:r,recv:a,sendrecv:d}}function cc(t,n,r,a,d,l){if(r==="videoExtensions"||r==="audioExtensions"){const p=[];return t[r].forEach(E=>{n[r].some((f,T)=>{if(E.entry===f.entry&&E.extensionName===f.extensionName)return p.push(T),!0})?l[r].push(E):a[r].push(E)}),void n[r].forEach((E,f)=>{p.indexOf(f)===-1&&d[r].push(E)})}if(r==="videoCodecs"||r==="audioCodecs"){const p=[];return t[r].forEach(E=>{n[r].some((f,T)=>{if(E.payloadType===f.payloadType&&JSON.stringify(E)===JSON.stringify(f))return p.push(T),!0})?l[r].push(E):a[r].push(E)}),void n[r].forEach((E,f)=>{p.indexOf(f)===-1&&d[r].push(E)})}}function EC(t){const{send:n,recv:r,sendrecv:a}=t;if(!a){if(!n||!r)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:n,recv:r}}let d,l;return n?(d={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},d.audioCodecs=[...n.audioCodecs,...a.audioCodecs],d.videoCodecs=[...n.videoCodecs,...a.videoCodecs],d.audioExtensions=[...n.audioExtensions,...a.audioExtensions],d.videoExtensions=[...n.videoExtensions,...a.videoExtensions]):d=a,r?(l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},l.audioCodecs=[...r.audioCodecs,...a.audioCodecs],l.videoCodecs=[...r.videoCodecs,...a.videoCodecs],l.audioExtensions=[...r.audioExtensions,...a.audioExtensions],l.videoExtensions=[...r.videoExtensions,...a.videoExtensions]):l=a,{send:d,recv:l}}function Ju(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(n=>{var r;return((r=n.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase())==="opus"}).forEach(n=>{n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"})}function vE(t,n,r,a){let d=[];if(t===Kt.VIDEO){if(J("H264_PROFILE_LEVEL_ID")&&a==="h264"&&(d=n.videoCodecs.filter(l=>{var p;return Mt(p=l.rtpMap&&l.rtpMap.encodingName.toLowerCase()||"").call(p,a)&&l&&l.fmtp&&l.fmtp.parameters["profile-level-id"]===J("H264_PROFILE_LEVEL_ID")})),!Array.isArray(d)||d.length===0){let l=[];const p=[],E=[],f=[];if(r.videoCodecs.forEach(T=>{const R=T.rtpMap&&T.rtpMap.encodingName.toLowerCase()||"";Mt(R).call(R,a)?l.push(T):Mt(R).call(R,"vp9")?p.push(T):Mt(R).call(R,"vp8")?E.push(T):Mt(R).call(R,"h264")&&f.push(T)}),l.length===0){let T="";p.length!==0?(l=p,T="vp9"):E.length!==0?(l=E,T="vp8"):f.length!==0&&(l=f,T="h264"),N.warning("codec ".concat(a," not included in rtpCapabilities, fallback to default payloads: ").concat(T))}l.length!==0&&(d=n.videoCodecs.filter(T=>l.some(R=>R.payloadType===T.payloadType)))}if(d.length===0&&(N.warning("codec ".concat(a," not included in rtpCapabilities, fallback to default payloads: ").concat(n.videoCodecs[0].rtpMap&&n.videoCodecs[0].rtpMap.encodingName)),d=n.videoCodecs),J("USE_PUB_RTX")||J("USE_SUB_RTX")){const l=mC(d,n.videoCodecs);d=[...d,...l]}}else d=n.audioCodecs.filter(l=>{var p;return Mt(p=l.rtpMap&&l.rtpMap.encodingName.toLowerCase()||"").call(p,a)}),d.length===0&&(N.warning("codec ".concat(a," not included in rtpCapabilities, fallback to opus")),d=n.audioCodecs.filter(l=>{var p;return Mt(p=l.rtpMap&&l.rtpMap.encodingName.toLowerCase()||"").call(p,"opus")}));return d}function mC(t,n){const r=t.map(a=>a.payloadType.toString());return n.filter(a=>a.rtpMap&&a.rtpMap.encodingName==="rtx"&&a.fmtp&&a.fmtp.parameters.apt&&Mt(r).call(r,a.fmtp&&a.fmtp.parameters.apt))}async function Ql(t,n,r){const a=n.toString(),d=fC(a,"offer","remote","exchangeSDP");await t.setRemoteDescription({type:"offer",sdp:a});const l=await t.createAnswer();if(!l.sdp)throw new Error("cannot get answer sdp");let p=l.sdp;p=Vc(p,r||{}),d==null||d(p||""),await t.setLocalDescription({type:"answer",sdp:p})}function Vc(t,n,r){const a=Qr.parse(t),{useXR:d}=n;return a.mediaDescriptions.forEach(l=>{var p;l.attributes.mid&&(Array.isArray(r)&&!Mt(r).call(r,l.attributes.mid)||(l.media.mediaType==="audio"&&Ju(l),d&&Mt(p=["audio","video"]).call(p,l.media.mediaType)&&l.attributes.payloads.forEach(E=>{E.rtcpFeedbacks.findIndex(f=>f.type==="rrtr")===-1&&E.rtcpFeedbacks.push({type:"rrtr"})})))}),Qr.print(a)}function fC(t,n,r,a){if(J("SDP_LOGGING"))return N.upload("exchanging ".concat(r," ").concat(n," SDP during P2PConnection.").concat(a,`
`),t),n==="offer"?d=>{fC(d,"answer",r==="local"?"remote":"local",a)}:void 0}function Xw(t){const n=J("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(n)&&n.length>0)&&n.some(r=>Mt(t).call(t,r))}function ro(t,n){try{var r;return((r=t.fmtp)===null||r===void 0?void 0:r.parameters.apt)===n.payloadType.toString()}catch{return!1}}function so(t,n){return typeof J(t)===n?J(t):void 0}function yg(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Sd(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?yg(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):yg(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const Ag=new Map;class IE extends An{get state(){return this._state}set state(n){if(n===this._state)return;const r=this._state;this._state=n,n==="DISCONNECTED"&&this._disconnectedReason?this.emit(Fr.CONNECTION_STATE_CHANGE,n,r,this._disconnectedReason):this.emit(Fr.CONNECTION_STATE_CHANGE,n,r)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(n){N.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(n)),this._joinGatewayStartTime=n}constructor(n,r){super(),F(this,"store",void 0),F(this,"joinInfo",void 0),F(this,"key",void 0),F(this,"ntpOffset",0),F(this,"signal",void 0),F(this,"role",void 0),F(this,"inChannelInfo",{joinAt:null,duration:0}),F(this,"spec",void 0),F(this,"_state","DISCONNECTED"),F(this,"_statsCollector",void 0),F(this,"_disconnectedReason",void 0),F(this,"isSignalRecover",!1),F(this,"hasChangeBGPAddress",!1),F(this,"trafficStatsInterval",void 0),F(this,"networkQualityInterval",void 0),F(this,"_joinGatewayStartTime",0),F(this,"_signalTimeout",!1),F(this,"_clientRoleOptions",void 0),F(this,"_isProactiveJoin",!1),this.store=n,this.spec=r,this.signal=this.store.useP2P?new dC(Sd(Sd({},r),{},{retryConfig:r.websocketRetryConfig}),n):new yj(Sd(Sd({},r),{},{retryConfig:r.websocketRetryConfig}),n),this._statsCollector=r.statsCollector,this.role=r.role||"audience",this._clientRoleOptions=r.clientRoleOptions,this.handleSignalEvents()}async join(n,r,a){this.store.joinGatewayStart(),n.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const d=Date.now();let l=Ag.get(n.cname);if(l||(l=new Map,Ag.set(n.cname,l)),this._isProactiveJoin=!0,l.has(n.uid)){const T=new lt(H.UID_CONFLICT);throw ee.joinGateway(n.sid,{lts:d,succ:!1,ec:T.code,addr:null,uid:n.uid,cid:n.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!n.proxyServer,signalChannel:"0",preload:n.preload}),this._isProactiveJoin=!1,T}l.set(n.uid,!0),this.joinInfo=n,this.key=r;let p=0;this.joinGatewayStartTime=d;const E=n.proxyServer;try{N.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(p));const T=n.gatewayAddrs.map(R=>{let{address:v}=R;const[y,w]=v.split(":"),B={host:y,port:w};return n.proxyServer&&(B.proxy=n.proxyServer),B});p=(await this.signal.init(T,a)).uid,N.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(p," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(T){var f;throw N.error("[".concat(this.store.clientId,"] User join failed"),T.toString()),ee.joinGateway(n.sid,{lts:d,succ:!1,ec:((f=T.data)===null||f===void 0?void 0:f.desc)||T.code,errorMsg:T.message,addr:this.signal.url,uid:n.uid,cid:n.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!E,signalChannel:"0",preload:n.preload}),this._isProactiveJoin=!1,l.delete(n.uid),this.signal.close(),T}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),N.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(T=>{N.warning("[".concat(this.store.clientId,"] get traffic stats error"),T.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Fr.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Fr.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Fr.NETWORK_QUALITY,{uplinkNetworkQuality:Ll(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Ll(this._statsCollector.trafficStats.B_dnq)}):this.emit(Fr.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),p}async leave(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0],r=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){r!==Cn.FALLBACK&&(this.state="DISCONNECTING");try{n||this.signal.connectionState!==Yn.CONNECTED||await function(a,d){return d===1/0?a:Bt.race([a,Ej(d)])}(this.signal.request(ue.LEAVE,void 0,!0),3e3)}catch(a){N.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),a)}this.signal.close(r),r!==Cn.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(n,r,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const d={state:"offer",p2p_id:this.store.p2pId,ortc:r,mode:this.spec.mode,extend:J("PUB_EXTEND"),twcc:!!J("PUBLISH_TWCC"),rtx:!!J("USE_PUB_RTX")};try{return(await this.signal.request(ue.PUBLISH,d,!0))._message}catch(l){if(a&&l.data&&l.data.code===de.ERR_PUBLISH_REQUEST_INVALID)return N.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),l.toString()),await this.tryUnpubBeforeRepub(n,r),this.publish(n,r,!1);throw l}}async publishDataChannel(n,r,a){var d;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const l={stream_id:r.streamId,ordered:r.ordered?1:0,max_retrans_times:(d=r.maxRetransmits)!==null&&d!==void 0?d:10,channel_id:r.channelId,metadata:r.metadata};try{await this.signal.request(ue.PUBLISH_DATASTREAM,l,!0)}catch(p){if(a&&p.data&&p.data.code===de.ERR_PUBLISH_REQUEST_INVALID)return N.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),p.toString()),await this.tryUnpubDataChannelBeforeRepub(n,r),this.publishDataChannel(n,r,!1);throw p}}async unpublish(n,r){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ue.UNPUBLISH,{stream_id:r,ortc:n},!0)}catch(a){N.warning("[".concat(this.store.clientId,"] unpublish warning: "),a)}}async unpublishDataChannel(n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Bt.all(n.map(r=>this.signal.request(ue.UNPUBLISH_DATASTREAM,{channel_id:r},!0)))}catch(r){N.warning("unpublish datachannels warning: ",r)}}async presubscribe(n,r,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const d={stream_id:n,stream_type:r,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!J("SUBSCRIBE_TWCC"),rtx:!!J("USE_SUB_RTX")||void 0,extend:J("SUB_EXTEND"),svc:Array.isArray(J("SVC"))&&J("SVC").length!==0?J("SVC"):void 0};try{return await this.signal.request(ue.PRE_SUBSCRIBE,d,!0)}catch(l){if(a&&l.data&&l.data.code===de.ERR_SUBSCRIBE_REQUEST_INVALID)return N.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),l.toString()),this.presubscribe(n,r,!1);throw l}}async subscribe(n,r,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const d={stream_id:n,stream_type:r.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!J("SUBSCRIBE_TWCC"),rtx:!!J("USE_SUB_RTX"),extend:J("SUB_EXTEND"),ssrcId:r.ssrcId,svc:Array.isArray(J("SVC"))&&J("SVC").length!==0?J("SVC"):void 0};try{return(await this.signal.request(ue.SUBSCRIBE,d,!0))._message}catch(l){if(a&&l.data&&l.data.code===de.ERR_SUBSCRIBE_REQUEST_INVALID)return N.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),l.toString()),await this.tryUnsubBeforeResub(n,r),await this.subscribe(n,r,!1);throw l}}async subscribeDataChannel(n,r,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const d={uid:n,stream_id:r.id,channel_id:r.datachannelId};try{return void await this.signal.request(ue.SUBSCRIBE_DATASTREAM,d,!0)}catch(l){if(a&&l.data&&l.data.code===de.ERR_SUBSCRIBE_REQUEST_INVALID)return N.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),l.toString()),await this.tryUnsubDataChannelBeforeResub(n,r),await this.subscribeDataChannel(n,r,!1);throw l}}async subscribeAll(n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const a={p2p_id:this.store.p2pId,users:n,dtx:!1,rtx:!!J("USE_SUB_RTX"),twcc:!!J("SUBSCRIBE_TWCC"),svc:Array.isArray(J("SVC"))&&J("SVC").length!==0?J("SVC"):void 0};try{return await this.signal.request(ue.SUBSCRIBE_STREAMS,a,!0)}catch(d){if(r&&d.data&&d.data.code===de.ERR_SUBSCRIBE_REQUEST_INVALID)return N.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),d.toString()),await this.tryMassUnsubBeforeResub(n),await this.subscribeAll(n,!1);throw d}}async setVideoProfile(n){const r=function(a){if(!(a.bitrateMax&&a.bitrateMin&&a.frameRate&&a.height&&a.width))return;let d=a.frameRate,l=a.width,p=a.height,E=!0;return typeof d!="number"&&(d=d.exact||d.ideal||d.max||d.min||0,d||(E=!1)),typeof l!="number"&&(l=l.exact||l.ideal||l.max||l.min||0,l||(E=!1)),typeof p!="number"&&(p=p.exact||p.ideal||p.max||p.min||0,d||(E=!1)),E?{stream_type:0,width:l,height:p,fps:d,start_bps:1e3*a.bitrateMax,min_bps:1e3*a.bitrateMin,target_bps:1e3*a.bitrateMax}:void 0}(n);if(r)return this.signal.request(ue.SET_VIDEO_PROFILE,r);N.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(n,r){try{await this.signal.request(ue.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:n,stream_id:r},!0)}catch(a){N.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),a)}}async unsubscribeDataChannel(n,r){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Bt.all(n.map(a=>this.signal.request(ue.UNSUBSCRIBE_DATASTREAM,{stream_id:a,uid:r},!0)))}catch(a){N.warning("unsubscribeDataChannel warning: ",a)}}async massUnsubscribe(n){try{await this.signal.request(ue.UNSUBSCRIBE_STREAMS,n,!0)}catch(r){N.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),r)}}async reconnectPC(n){const{iceParameters:r,dtlsParameters:a,rtpCapabilities:d}=n;return{gatewayEstablishParams:await this.signal.request(ue.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:r,dtlsParameters:a,rtpCapabilities:d}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ue.GATEWAY_INFO)}async renewToken(n){await this.signal.request(ue.RENEW_TOKEN,n),this.key=n.token}async setClientRole(n,r){if(r&&(this._clientRoleOptions=Object.assign({},r)),this.state!=="CONNECTED")return void(this.role=n);let a,d=0;n==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(a=this._clientRoleOptions.delay,d=1):d=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:d=0,await this.signal.request(ue.SET_CLIENT_ROLE,{role:n,level:d,delay:a,client_ts:Date.now()}),this.role=n}async setRemoteVideoStreamType(n,r){await this.signal.request(ue.SWITCH_VIDEO_STREAM,{stream_id:n,stream_type:r})}async setDefaultRemoteVideoStreamType(n){await this.signal.request(ue.DEFAULT_VIDEO_STREAM,{stream_type:n})}async setStreamFallbackOption(n,r){await this.signal.request(ue.SET_FALLBACK_OPTION,{stream_id:n,fallback_type:r})}async pickSVCLayer(n,r){await this.signal.request(ue.PICK_SVC_LAYER,{stream_id:n,spatial_layer:r.spatialLayer,temporal_layer:r.temporalLayer})}async setRTM2Flag(n){await this.signal.request(ue.SET_RTM2_FLAG,{rtm2_flag:n})}async sendExtensionMessage(n,r,a){if(this.signal instanceof dC)return this.signal.sendExtensionMessage(n,r,a)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Sd({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(ue.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const n=Ag.get(this.joinInfo.cname);n&&n.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const n=function(r){let a;return a=r.startsWith("dc")?r.match(/(dc\:\/\/)?([^:]+):(\d+)/):r.match(/(wss\:\/\/)?([^:]+):(\d+)/),a?{username:Vr.username,password:Vr.password,turnServerURL:a[2],tcpport:parseInt(a[3])+30,udpport:parseInt(a[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],n&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Sd(Sd({},Vr),{},{turnServerURL:n.turnServerURL,tcpport:n.tcpport,udpport:n.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const n=await this.signal.request(ue.TRAFFIC_STATS,void 0,!0);n.timestamp=Date.now(),n.ntp_offset!=null&&(this.ntpOffset=n.ntp_offset),n.peer_delay.forEach(r=>{const a=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(d=>d.peer_uid===r.peer_uid);a&&a.B_st!==r.B_st&&If(()=>{this.emit(Fr.STREAM_TYPE_CHANGE,r.peer_uid,r.B_st)})}),this._statsCollector.updateTrafficStats(n)}getJoinMessage(n){if(!this.joinInfo||!this.key)throw new lt(H.UNEXPECTED_ERROR,"can not generate join message, no join info");const r=Object.assign({},this.joinInfo.apResponse);let a=J("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}a&&a.length>128&&(a=void 0);const d=!(Ii()||_R(87)||BR())&&typeof J("ENABLE_PRE_SUB")=="boolean"&&J("ENABLE_PRE_SUB"),l=!BR()&&so("ENABLE_PREALLOC_PC","boolean"),p=Sd({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Vt,browser:navigator.userAgent,process_id:J("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:r,extend:J("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:{enablePublishedUserList:J("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:J("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof J("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?J("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof J("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?J("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof J("ENABLE_USER_LICENSE_CHECK")=="boolean"?J("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:J("USE_PUB_RTX")===!0||J("USE_SUB_RTX")===!0||void 0,disableFEC:J("DISABLE_FEC"),enableNTPReport:!!J("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!J("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!J("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:so("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!J("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!J("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:so("USE_XR","boolean"),enableLossbasedBwe:so("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!J("ENABLE_AUT_CC")||void 0,enableCCFallback:so("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:l,preSubNum:d?so("PRE_SUB_NUM","number"):void 0,enablePubTWCC:so("PUBLISH_TWCC","boolean"),enableSubTWCC:so("SUBSCRIBE_TWCC","boolean"),enablePubRTX:so("USE_PUB_RTX","boolean"),enableSubRTX:so("USE_SUB_RTX","boolean"),enableSubSVC:J("ENABLE_SVC")?J("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(J("SVC"))&&J("SVC").length!==0?J("SVC"):void 0}},join_ts:this.joinGatewayStartTime},n);return this.joinInfo.stringUid&&(p.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(p.aes_mode=this.joinInfo.aesmode,J("ENCRYPT_AES")?(p.aes_secret=this.joinInfo.aespassword,p.aes_encrypt=!0):p.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(p.aes_salt=this.joinInfo.aessalt)),r.addresses[this.signal.websocket.currentURLIndex]&&(p.ap_response.ticket=r.addresses[this.signal.websocket.currentURLIndex].ticket,delete r.addresses),this.joinInfo.defaultVideoStream!==void 0&&(p.default_video_stream=this.joinInfo.defaultVideoStream),p}getRejoinMessage(){if(!this.joinInfo)throw new lt(H.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(fe.WS_RECONNECT_CREATE_CONNECTION,n=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(fe.WS_RECONNECTING,n=>{this.joinInfo&&ee.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n||rs.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",ee.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(fe.WS_CLOSED,n=>{let r;switch(n){case Cn.LEAVE:r=rs.LEAVE;break;case Cn.UID_BANNED:case Cn.IP_BANNED:case Cn.CHANNEL_BANNED:case Cn.SERVER_ERROR:r=rs.SERVER_ERROR;break;case Cn.FALLBACK:r=rs.FALLBACK;break;case Cn.LICENSE_MISSING:case Cn.LICENSE_EXPIRED:case Cn.LICENSE_MINUTES_EXCEEDED:case Cn.LICENSE_PERIOD_INVALID:case Cn.LICENSE_MULTIPLE_SDK_SERVICE:case Cn.LICENSE_ILLEGAL:case Cn.TOKEN_EXPIRE:r=n;break;default:r=rs.NETWORK_ERROR}N.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(r||"undefined -> "+rs.NETWORK_ERROR)),this.joinInfo&&ee.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:n===Cn.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:r}),this._disconnectedReason=n,n!==Cn.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(fe.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(N.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),ee.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const n=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!n)return void N.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(n));on("EVENT_REPORT_DOMAIN",n[1]),on("EVENT_REPORT_BACKUP_DOMAIN",n[1]),on("LOG_UPLOAD_SERVER","".concat(n[1],":6444"))}}),this.signal.on(Ue.ON_UPLINK_STATS,n=>{this._statsCollector.updateUplinkStats(n)}),this.signal.on(fe.REQUEST_RECOVER,(n,r,a)=>{if(!this.joinInfo)return a(new lt(H.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));n&&(this.joinInfo.multiIP=n,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Kr(this,Fr.REQUEST_NEW_GATEWAY_LIST).then(r).catch(a)}),this.signal.on(fe.REQUEST_JOIN_INFO,async n=>{var r;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void n(this.getJoinMessage({ortc:{}}));const{iceParameters:a,dtlsParameters:d,rtpCapabilities:l}=await Kr(this,Fr.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(r=this.joinInfo)===null||r===void 0?void 0:r.turnServer});n(this.getJoinMessage({ortc:{iceParameters:a,dtlsParameters:d,rtpCapabilities:l,version:"2"}}))}),this.signal.on(fe.REQUEST_REJOIN_INFO,n=>{n(this.getRejoinMessage())}),this.signal.on(fe.REPORT_JOIN_GATEWAY,(n,r)=>{if(!this.joinInfo)return;let a,d="";var l;n instanceof lt?(a=((l=n.data)===null||l===void 0?void 0:l.desc)||n.code,d=n.message):a=n,ee.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:a,errorMsg:d,addr:r,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1}),this.signal.on(fe.IS_P2P_DISCONNECTED,n=>{n(Cf(this,Fr.IS_P2P_DISCONNECTED))}),this.signal.on(fe.DISCONNECT_P2P,()=>{this.emit(Fr.DISCONNECT_P2P)}),this.signal.on(fe.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(fe.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(fe.JOIN_RESPONSE,n=>{const r=this.getCurrentGatewayAddress();this.emit(Fr.JOIN_RESPONSE,n,r)}),this.signal.on(fe.PRE_CONNECT_PC,async()=>{if(this.joinInfo){this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress(),r=J("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(n&&r){const a=qw(n);this.emit(Fr.PRE_CONNECT_PC,{candidates:a,fingerprint:r})}}}),this.signal.on(fe.RECOVER_NOTIFICATION,n=>{this.joinInfo&&typeof J("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(J("AP_REQUEST_DETAIL"),";").concat(n))})}async tryUnsubBeforeResub(n,r){try{await this.signal.request(ue.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:n,ortc:[r]},!0)}catch(a){throw N.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),a),a}}async tryUnsubDataChannelBeforeResub(n,r){try{await this.signal.request(ue.UNSUBSCRIBE,{stream_id:r.id},!0)}catch(a){throw N.warning("unsubscribe datachannel warning",a),a}}async tryUnpubBeforeRepub(n,r){try{await this.signal.request(ue.UNPUBLISH,{stream_id:n,ortc:r},!0)}catch(a){throw N.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),a),a}}async tryUnpubDataChannelBeforeRepub(n,r){try{await this.signal.request(ue.UNPUBLISH_DATASTREAM,{channnel_id:r.channelId},!0)}catch(a){throw N.warning("unpublish datastream warning: ",a),a}}async tryMassUnsubBeforeResub(n){const r={users:n.map(a=>({stream_id:a.stream_id,stream_type:a.stream_type}))};try{await this.signal.request(ue.UNSUBSCRIBE_STREAMS,r,!0)}catch(a){throw N.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),a),a}}async muteLocal(n,r){const a={action:n.find(d=>d.stream_type===fn.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:n,stream_id:r};try{await this.signal.request(ue.CONTROL,a,!0,!0)}catch(d){throw N.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),d),d}}async unmuteLocal(n,r){const a={action:n.find(d=>d.stream_type===fn.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:n,stream_id:r};try{await this.signal.request(ue.CONTROL,a,!0,!0)}catch(d){throw N.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),d),d}}async muteRemote(n,r){const a={action:n===Kt.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:r};try{await this.signal.request(ue.CONTROL,a,!0,!0)}catch(d){throw N.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),d),d}}async unmuteRemote(n,r){const a={action:n===Kt.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:r};try{await this.signal.request(ue.CONTROL,a,!0,!0)}catch(d){throw N.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),d),d}}uploadWRTCStats(n){this.signal.uploadWRTCStats(n)}upload(n,r){this.signal.upload(n,r)}getSignalRTT(){return this.signal.rtt}async restartICE(n){const r={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:n};try{return await this.signal.request(ue.RESTART_ICE,r,!0)}catch(a){throw N.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),a),a}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,rs.P2P_FAILED)}getCurrentGatewayAddress(){var n,r;if(!J("GATEWAY_WSS_ADDRESS"))return J("USE_CANDIDATE_FROM_AP_DETAIL")&&(n=this.joinInfo)!==null&&n!==void 0&&n.apGatewayAddress?(N.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(r=this.joinInfo)!==null&&r!==void 0&&r.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(n){await this.signal.request(ue.SET_PARAMETER,{enablePublishAudioFilter:n})}}let yE=0,bg=0;function Fc(t,n,r,a){return new Bt((d,l)=>{n.timeout=n.timeout||J("HTTP_CONNECT_TIMEOUT"),n.responseType=n.responseType||"json",n.data&&!r?(n.data=JSON.stringify(n.data),yE+=ad(n.data)):r&&(n.data.size?yE+=n.data.size:n.data instanceof FormData?yE+=mb(n.data):yE+=ad(JSON.stringify(n.data))),n.headers=n.headers||{},n.headers["Content-Type"]=n.headers["Content-Type"]||"application/json",n.method="POST",n.url=t,Xs.request(n).then(p=>{typeof p.data=="string"?bg+=ad(p.data):p.data instanceof ArrayBuffer||p.data instanceof Uint8Array?bg+=p.data.byteLength:bg+=ad(JSON.stringify(p.data)),a&&d({data:p.data,headers:p.headers}),d(p.data)}).catch(p=>{Xs.isCancel(p)?l(new lt(H.OPERATION_ABORTED,"cancel token canceled")):p.code==="ECONNABORTED"?l(new lt(H.NETWORK_TIMEOUT,p.message)):p.response?l(new lt(H.NETWORK_RESPONSE_ERROR,p.response.status)):l(new lt(H.NETWORK_ERROR,p.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var t;function n(Ct){var Pt=0;return function(){return Pt<Ct.length?{done:!1,value:Ct[Pt++]}:{done:!0}}}var r=typeof Object.defineProperties=="function"?Object.defineProperty:function(Ct,Pt,Zt){return Ct==Array.prototype||Ct==Object.prototype||(Ct[Pt]=Zt.value),Ct},a,d=function(Ct){Ct=[typeof globalThis=="object"&&globalThis,Ct,typeof window=="object"&&window,typeof self=="object"&&self,typeof mt=="object"&&mt];for(var Pt=0;Pt<Ct.length;++Pt){var Zt=Ct[Pt];if(Zt&&Zt.Math==Math)return Zt}throw Error("Cannot find global object")}(this);function l(Ct,Pt){if(Pt)t:{var Zt=d;Ct=Ct.split(".");for(var we=0;we<Ct.length-1;we++){var Sn=Ct[we];if(!(Sn in Zt))break t;Zt=Zt[Sn]}(Pt=Pt(we=Zt[Ct=Ct[Ct.length-1]]))!=we&&Pt!=null&&r(Zt,Ct,{configurable:!0,writable:!0,value:Pt})}}function p(Ct){return(Ct={next:Ct})[Symbol.iterator]=function(){return this},Ct}function E(Ct){var Pt=typeof Symbol<"u"&&Symbol.iterator&&Ct[Symbol.iterator];return Pt?Pt.call(Ct):{next:n(Ct)}}if(l("Symbol",function(Ct){function Pt(Sn,Ft){this.A=Sn,r(this,"description",{configurable:!0,writable:!0,value:Ft})}if(Ct)return Ct;Pt.prototype.toString=function(){return this.A};var Zt="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",we=0;return function Sn(Ft){if(this instanceof Sn)throw new TypeError("Symbol is not a constructor");return new Pt(Zt+(Ft||"")+"_"+we++,Ft)}}),l("Symbol.iterator",function(Ct){if(Ct)return Ct;Ct=Symbol("Symbol.iterator");for(var Pt="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),Zt=0;Zt<Pt.length;Zt++){var we=d[Pt[Zt]];typeof we=="function"&&typeof we.prototype[Ct]!="function"&&r(we.prototype,Ct,{configurable:!0,writable:!0,value:function(){return p(n(this))}})}return Ct}),typeof Object.setPrototypeOf=="function")a=Object.setPrototypeOf;else{var f;t:{var T={};try{T.__proto__={a:!0},f=T.a;break t}catch{}f=!1}a=f?function(Ct,Pt){if(Ct.__proto__=Pt,Ct.__proto__!==Pt)throw new TypeError(Ct+" is not extensible");return Ct}:null}var R=a;function v(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function y(Ct){if(Ct.m)throw new TypeError("Generator is already running");Ct.m=!0}function w(Ct,Pt){return Ct.h=3,{value:Pt}}function B(Ct){this.g=new v,this.G=Ct}function k(Ct,Pt,Zt,we){try{var Sn=Pt.call(Ct.g.j,Zt);if(!(Sn instanceof Object))throw new TypeError("Iterator result "+Sn+" is not an object");if(!Sn.done)return Ct.g.m=!1,Sn;var Ft=Sn.value}catch(L){return Ct.g.j=null,Ct.g.s(L),U(Ct)}return Ct.g.j=null,we.call(Ct.g,Ft),U(Ct)}function U(Ct){for(;Ct.g.h;)try{var Pt=Ct.G(Ct.g);if(Pt)return Ct.g.m=!1,{value:Pt.value,done:!1}}catch(Zt){Ct.g.v=void 0,Ct.g.s(Zt)}if(Ct.g.m=!1,Ct.g.l){if(Pt=Ct.g.l,Ct.g.l=null,Pt.F)throw Pt.D;return{value:Pt.return,done:!0}}return{value:void 0,done:!0}}function G(Ct){this.next=function(Pt){return Ct.o(Pt)},this.throw=function(Pt){return Ct.s(Pt)},this.return=function(Pt){return function(Zt,we){y(Zt.g);var Sn=Zt.g.j;return Sn?k(Zt,"return"in Sn?Sn.return:function(Ft){return{value:Ft,done:!0}},we,Zt.g.return):(Zt.g.return(we),U(Zt))}(Ct,Pt)},this[Symbol.iterator]=function(){return this}}function W(Ct,Pt){return Pt=new G(new B(Pt)),R&&Ct.prototype&&R(Pt,Ct.prototype),Pt}if(v.prototype.o=function(Ct){this.v=Ct},v.prototype.s=function(Ct){this.l={D:Ct,F:!0},this.h=this.C||this.u},v.prototype.return=function(Ct){this.l={return:Ct},this.h=this.u},B.prototype.o=function(Ct){return y(this.g),this.g.j?k(this,this.g.j.next,Ct,this.g.o):(this.g.o(Ct),U(this))},B.prototype.s=function(Ct){return y(this.g),this.g.j?k(this,this.g.j.throw,Ct,this.g.o):(this.g.s(Ct),U(this))},l("Array.prototype.entries",function(Ct){return Ct||function(){return function(Pt,Zt){Pt instanceof String&&(Pt+="");var we=0,Sn=!1,Ft={next:function(){if(!Sn&&we<Pt.length){var L=we++;return{value:Zt(L,Pt[L]),done:!1}}return Sn=!0,{done:!0,value:void 0}}};return Ft[Symbol.iterator]=function(){return Ft},Ft}(this,function(Pt,Zt){return[Pt,Zt]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var $=function(Ct,Pt){for(var Zt=0;Zt<Ct.length;Zt++)Pt(Ct[Zt])},rt=function(Ct){return Ct.replace(/\r?\n|\r/g,`\r
`)},ot=function(Ct,Pt,Zt){return Pt instanceof Blob?(Zt=Zt!==void 0?Zt+"":typeof Pt.name=="string"?Pt.name:"blob",Pt.name===Zt&&Object.prototype.toString.call(Pt)!=="[object Blob]"||(Pt=new File([Pt],Zt)),[String(Ct),Pt]):[String(Ct),String(Pt)]},Et=function(Ct,Pt){if(Ct.length<Pt)throw new TypeError(Pt+" argument required, but only "+Ct.length+" present.")},vt=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,Lt=vt.FormData,wt=vt.XMLHttpRequest&&vt.XMLHttpRequest.prototype.send,$t=vt.Request&&vt.fetch,Ye=vt.navigator&&vt.navigator.sendBeacon,bn=vt.Element&&vt.Element.prototype,ri=vt.Symbol&&Symbol.toStringTag;ri&&(Blob.prototype[ri]||(Blob.prototype[ri]="Blob"),"File"in vt&&!File.prototype[ri]&&(File.prototype[ri]="File"));try{new File([],"")}catch{vt.File=function(Pt,Zt,we){return Pt=new Blob(Pt,we||{}),Object.defineProperties(Pt,{name:{value:Zt},lastModified:{value:+(we&&we.lastModified!==void 0?new Date(we.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),ri&&Object.defineProperty(Pt,ri,{value:"File"}),Pt}}var mr=function(Ct){return Ct.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Li=function(Ct){this.i=[];var Pt=this;Ct&&$(Ct.elements,function(Zt){if(Zt.name&&!Zt.disabled&&Zt.type!=="submit"&&Zt.type!=="button"&&!Zt.matches("form fieldset[disabled] *"))if(Zt.type==="file"){var we=Zt.files&&Zt.files.length?Zt.files:[new File([],"",{type:"application/octet-stream"})];$(we,function(Sn){Pt.append(Zt.name,Sn)})}else Zt.type==="select-multiple"||Zt.type==="select-one"?$(Zt.options,function(Sn){!Sn.disabled&&Sn.selected&&Pt.append(Zt.name,Sn.value)}):Zt.type==="checkbox"||Zt.type==="radio"?Zt.checked&&Pt.append(Zt.name,Zt.value):(we=Zt.type==="textarea"?rt(Zt.value):Zt.value,Pt.append(Zt.name,we))})};if((t=Li.prototype).append=function(Ct,Pt,Zt){Et(arguments,2),this.i.push(ot(Ct,Pt,Zt))},t.delete=function(Ct){Et(arguments,1);var Pt=[];Ct=String(Ct),$(this.i,function(Zt){Zt[0]!==Ct&&Pt.push(Zt)}),this.i=Pt},t.entries=function Ct(){var Pt,Zt=this;return W(Ct,function(we){if(we.h==1&&(Pt=0),we.h!=3)return Pt<Zt.i.length?we=w(we,Zt.i[Pt]):(we.h=0,we=void 0),we;Pt++,we.h=2})},t.forEach=function(Ct,Pt){Et(arguments,1);for(var Zt=E(this),we=Zt.next();!we.done;we=Zt.next()){var Sn=E(we.value);we=Sn.next().value,Sn=Sn.next().value,Ct.call(Pt,Sn,we,this)}},t.get=function(Ct){Et(arguments,1);var Pt=this.i;Ct=String(Ct);for(var Zt=0;Zt<Pt.length;Zt++)if(Pt[Zt][0]===Ct)return Pt[Zt][1];return null},t.getAll=function(Ct){Et(arguments,1);var Pt=[];return Ct=String(Ct),$(this.i,function(Zt){Zt[0]===Ct&&Pt.push(Zt[1])}),Pt},t.has=function(Ct){Et(arguments,1),Ct=String(Ct);for(var Pt=0;Pt<this.i.length;Pt++)if(this.i[Pt][0]===Ct)return!0;return!1},t.keys=function Ct(){var Pt,Zt,we,Sn,Ft=this;return W(Ct,function(L){if(L.h==1&&(Pt=E(Ft),Zt=Pt.next()),L.h!=3)return Zt.done?void(L.h=0):(we=Zt.value,Sn=E(we),w(L,Sn.next().value));Zt=Pt.next(),L.h=2})},t.set=function(Ct,Pt,Zt){Et(arguments,2),Ct=String(Ct);var we=[],Sn=ot(Ct,Pt,Zt),Ft=!0;$(this.i,function(L){L[0]===Ct?Ft&&(Ft=!we.push(Sn)):we.push(L)}),Ft&&we.push(Sn),this.i=we},t.values=function Ct(){var Pt,Zt,we,Sn,Ft=this;return W(Ct,function(L){if(L.h==1&&(Pt=E(Ft),Zt=Pt.next()),L.h!=3)return Zt.done?void(L.h=0):(we=Zt.value,(Sn=E(we)).next(),w(L,Sn.next().value));Zt=Pt.next(),L.h=2})},Li.prototype._asNative=function(){for(var Ct=new Lt,Pt=E(this),Zt=Pt.next();!Zt.done;Zt=Pt.next()){var we=E(Zt.value);Zt=we.next().value,we=we.next().value,Ct.append(Zt,we)}return Ct},Li.prototype._blob=function(){var Ct="----formdata-polyfill-"+Math.random(),Pt=[],Zt="--"+Ct+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(we,Sn){return typeof we=="string"?Pt.push(Zt+mr(rt(Sn))+`"\r
\r
`+rt(we)+`\r
`):Pt.push(Zt+mr(rt(Sn))+'"; filename="'+mr(we.name)+`"\r
Content-Type: `+(we.type||"application/octet-stream")+`\r
\r
`,we,`\r
`)}),Pt.push("--"+Ct+"--"),new Blob(Pt,{type:"multipart/form-data; boundary="+Ct})},Li.prototype[Symbol.iterator]=function(){return this.entries()},Li.prototype.toString=function(){return"[object FormData]"},bn&&!bn.matches&&(bn.matches=bn.matchesSelector||bn.mozMatchesSelector||bn.msMatchesSelector||bn.oMatchesSelector||bn.webkitMatchesSelector||function(Ct){for(var Pt=(Ct=(this.document||this.ownerDocument).querySelectorAll(Ct)).length;0<=--Pt&&Ct.item(Pt)!==this;);return-1<Pt}),ri&&(Li.prototype[ri]="FormData"),wt){var _u=vt.XMLHttpRequest.prototype.setRequestHeader;vt.XMLHttpRequest.prototype.setRequestHeader=function(Ct,Pt){_u.call(this,Ct,Pt),Ct.toLowerCase()==="content-type"&&(this.B=!0)},vt.XMLHttpRequest.prototype.send=function(Ct){Ct instanceof Li?(Ct=Ct._blob(),this.B||this.setRequestHeader("Content-Type",Ct.type),wt.call(this,Ct)):wt.call(this,Ct)}}$t&&(vt.fetch=function(Ct,Pt){return Pt&&Pt.body&&Pt.body instanceof Li&&(Pt.body=Pt.body._blob()),$t.call(this,Ct,Pt)}),Ye&&(vt.navigator.sendBeacon=function(Ct,Pt){return Pt instanceof Li&&(Pt=Pt._asNative()),Ye.call(this,Ct,Pt)}),vt.FormData=Li}})();const So=()=>{const t=J("AREAS");return t.length===0&&t.push(xe.GLOBAL),ka(t).call(t,(n,r,a)=>{const d=xp(r);return d?a===0?d:"".concat(n,",").concat(d):n},"")},xp=t=>t===xe.OVERSEA?"".concat(as.ASIA,",").concat(as.EUROPE,",").concat(as.AFRICA,",").concat(as.NORTH_AMERICA,",").concat(as.SOUTH_AMERICA,",").concat(as.OCEANIA):as[t],Rd=t=>{const n={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(r=>{const a=Lf[r],d=Object.keys(a);d&&d.map(l=>{l!=="CODE"&&(n[l]=n[l].concat(a[l]))})}),n},Zl={GLOBAL:{ASIA:[xe.CHINA,xe.JAPAN,xe.INDIA,xe.KOREA,xe.HKMC],EUROPE:[],NORTH_AMERICA:[xe.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},su=Object.keys(Zl[xe.GLOBAL]),gC=[xe.CHINA,xe.NORTH_AMERICA,xe.EUROPE,xe.ASIA,xe.JAPAN,xe.INDIA,xe.OCEANIA,xe.SOUTH_AMERICA,xe.AFRICA,xe.KOREA,xe.HKMC,xe.US],aG=function(t,n){let r=[];if(Mt(t).call(t,xe.GLOBAL)){const l=[xe.GLOBAL,xe.OVERSEA],p=Object.keys(Lf);if(n===xe.GLOBAL)throw new lt(H.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(n===xe.CHINA)r=[xe.OVERSEA];else if(d=n,Mt(su).call(su,d)){const E=(a=n,Zl[xe.GLOBAL][a]||[]),f=[...l,n,...E];r=p.filter(T=>!Mt(f).call(f,T))}else if(function(E){let f=!1;return su.forEach(T=>{var R;Mt(R=Zl[xe.GLOBAL][T]).call(R,E)&&(f=!0)}),f}(n)){const E=function(T){let R;return su.forEach(v=>{var y;Mt(y=Zl[xe.GLOBAL][v]).call(y,T)&&(R=v)}),R}(n),f=[...l,E,n];r=p.filter(T=>!Mt(f).call(f,T))}else r=t;r=function(E){const f=[];return gC.forEach(T=>{Mt(E).call(E,T)&&f.push(T)}),f.concat(E.filter(T=>!Mt(gC).call(gC,T)))}(r)}else r=t;var a,d;return r};function Qw(t){var n,r;if(!t&&Mt(n=J("AREAS")).call(n,xe.EXTENSIONS))return N.debug("update area from ap : reset"),void ou(mj,!0);if(!Mt(r=J("AREAS")).call(r,xe.GLOBAL)||!t)return;let a=Lf.EXTENSIONS;a&&(a={CODE:xp(xe.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},N.debug("update area from ap success: ".concat(t,",config is "),a),on("AREAS",[xe.EXTENSIONS],!0),Object.keys(a).map(d=>{d==="LOG_UPLOAD_SERVER"||d==="EVENT_REPORT_DOMAIN"||d==="EVENT_REPORT_BACKUP_DOMAIN"||d==="PROXY_SERVER_TYPE3"?on(d,a[d][0]):on(d,a[d])}))}function ou(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const r=ee.reportApiInvoke(null,{name:Gi.SET_AREA,options:t,tag:Si.TRACER});try{let a=[];if(typeof t=="string"&&(a=[t]),Array.isArray(t)&&(t.forEach(l=>{if(!Mt(hd).call(hd,l))throw new lt(H.INVALID_PARAMS,"invalid area code")}),a=t),Object.prototype.toString.call(t)==="[object Object]"){const{areaCode:l,excludedArea:p}=t;if(!l)throw new lt(H.INVALID_PARAMS,"area code is needed");let E=l;typeof l=="string"&&(E=[l]),a=p?aG(E,p):E}if(!n){if(Fu.AREAS){const l=new lt(H.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return r.onError(l),void N.warning("setArea is prohibited because of config-distribute")}if(Mt(a).call(a,xe.GLOBAL)&&J("AREAS")===xe.EXTENSIONS){const l=new lt(H.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return r.onError(l),void N.warning("setArea is prohibited because of ap extensions")}}on("AREAS",a,n);const d=Rd(a);Object.keys(d).map(l=>{l==="LOG_UPLOAD_SERVER"||l==="EVENT_REPORT_DOMAIN"||l==="EVENT_REPORT_BACKUP_DOMAIN"||l==="PROXY_SERVER_TYPE3"?on(l,d[l][0]):on(l,d[l])}),N.debug("set area success:",a.join(","))}catch(a){throw r.onError(a),a}r.onSuccess()}function Ko(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Yo(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Ko(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Ko(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let wg=1;function Og(t,n,r,a,d){wg+=1;const l={sid:r.sid,command:"convergeAllocateEdge",uid:"666",appId:r.appId,ts:Math.floor(Date.now()/1e3),seq:wg,requestId:wg,version:Vt,cname:r.cname},p={service_name:n,json_body:JSON.stringify(l)};let E,f,T=t[0];return cd(async()=>{E=Date.now();const R=await Fc(T,{data:p,cancelToken:a,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(f=Date.now()-E,R.code!==0){const w=new lt(H.UNEXPECTED_RESPONSE,"live streaming ap error, code"+R.code,{retry:!0,responseTime:f});throw N.error(w.toString()),w}const v=JSON.parse(R.json_body);if(v.code!==200){const w=new lt(H.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(v.code,", reason: ").concat(v.reason),{code:v.code,responseTime:f});throw N.error(w.toString()),w}if(!v.servers||v.servers.length===0){const w=new lt(H.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:v.code,responseTime:f});throw N.error(w.toString()),w}const y=function(w,B){return{addressList:w.servers.map(k=>"wss://".concat(k.address.replace(/\./g,"-"),".").concat(J("WORKER_DOMAIN"),":").concat(k.wss,"?serviceName=").concat(encodeURIComponent(B))),workerToken:w.workerToken,vid:w.vid}}(v,n);return J("LIVE_STREAMING_ADDRESS")&&(y.addressList=J("LIVE_STREAMING_ADDRESS")instanceof Array?J("LIVE_STREAMING_ADDRESS"):[J("LIVE_STREAMING_ADDRESS")]),Yo(Yo({},y),{},{responseTime:f})},(R,v)=>(ee.apworkerEvent(r.sid,{success:!0,sc:200,serviceName:n,responseDetail:JSON.stringify(R.addressList),firstSuccess:v===0,responseTime:f,serverIp:t[v%t.length]}),!1),(R,v)=>(ee.apworkerEvent(r.sid,{success:!1,sc:R.data&&R.data.code||200,serviceName:n,responseTime:f,serverIp:t[v%t.length]}),!!(R.code!==H.OPERATION_ABORTED&&R.code!==H.UNEXPECTED_RESPONSE||R.data&&R.data.retry)&&(T=t[(v+1)%t.length],!0)),d)}let TC=1;function Ir(t,n,r,a){let{url:d,areaCode:l}=t;const{clientId:p,sid:E}=n,f=Date.now();let T;const[R,v]=Cd(n,l,[Xi.CHOOSE_SERVER]);let y=Ui.networkState;return cd(async()=>{y&&Ui.networkState===fo.OFFLINE&&Ui.onlineWaiter&&await Bt.race([Ui.onlineWaiter,xr(a&&a.maxRetryTimeout||Vi.maxRetryTimeout)]),y=Ui.networkState;const{data:w,headers:B}=await Fc(d,{data:R,cancelToken:r,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);T=B.http3==="1"?1:-1,ee.reportResourceTiming(d,E),ds(w,d,n,f,[Xi.CHOOSE_SERVER],T);const k=fa(w,Xi.CHOOSE_SERVER);return $l(k),Bb(k,d)},w=>(w&&ee.joinChooseServer(E,{lts:f,succ:!0,csAddr:d,opid:v,serverList:w.gatewayAddrs.map(B=>B.address),ec:null,cid:w.cid.toString(),uid:w.uid.toString(),csIp:w.csIp,unilbsServerIds:[Xi.CHOOSE_SERVER].toString(),isHttp3:T,corssRegionTagReq:n.apRequestDetail,corssRegionTagRes:w.res.detail&&w.res.detail[38]}),!1),w=>w.code!==H.OPERATION_ABORTED&&(w.code===H.CAN_NOT_GET_GATEWAY_SERVER?w.data.retry:(ee.joinChooseServer(E,{lts:f,succ:!1,csAddr:d,serverList:null,opid:v,ec:w.code,csIp:w.data&&w.data.csIp,unilbsServerIds:[Xi.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:y}),isHttp3:T,corssRegionTagReq:n.apRequestDetail}),N.warning("[".concat(p||"sid-".concat(E.slice(0,6)),"] Choose server network error, retry"),w),!0)),a)}function Xu(t,n,r,a){let d,{url:l,areaCode:p,serviceIds:E}=t;const f=Date.now(),[T,R]=Cd(n,p,E);let v;return cd(async()=>{v&&Ui.networkState===fo.OFFLINE&&Ui.onlineWaiter&&await Bt.race([Ui.onlineWaiter,xr(a&&a.maxRetryTimeout||Vi.maxRetryTimeout)]),v=Ui.networkState;const{data:y,headers:w}=await Fc(l,{data:T,cancelToken:r,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=w.http3==="1"?1:-1,ee.reportResourceTiming(l,n.sid),ds(y,l,n,f,E,d);const B=fa(y,Xi.CHOOSE_SERVER),k=fa(y,n.cloudProxyServer==="proxy5"?Xi.CLOUD_PROXY_5:n.cloudProxyServer==="proxy3"||n.cloudProxyServer==="proxy4"?Xi.CLOUD_PROXY:Xi.CLOUD_PROXY_FALLBACK);return $l(B),{gatewayInfo:Bb(B,l),proxyInfo:k,url:l}},y=>(y.gatewayInfo&&ee.joinChooseServer(n.sid,{lts:f,succ:!0,csAddr:l,serverList:y.gatewayInfo.gatewayAddrs.map(w=>w.address),ec:null,opid:R,cid:y.gatewayInfo.cid.toString(),uid:y.gatewayInfo.uid.toString(),csIp:y.gatewayInfo.csIp,unilbsServerIds:E.toString(),isHttp3:d,corssRegionTagReq:n.apRequestDetail,corssRegionTagRes:y.gatewayInfo.res.detail&&y.gatewayInfo.res.detail[38]}),y.proxyInfo&&ee.joinWebProxyAP(n.sid,{lts:f,sucess:1,apServerAddr:l,turnServerAddrList:y.proxyInfo.addresses.map(w=>w.ip).join(","),errorCode:null,eventType:n.cloudProxyServer,unilbsServerIds:E.toString()}),!1),y=>y.code!==H.OPERATION_ABORTED&&(y.code===H.CAN_NOT_GET_GATEWAY_SERVER?y.data.retry:(ee.joinWebProxyAP(n.sid,{lts:f,sucess:0,apServerAddr:l,turnServerAddrList:null,errorCode:y.code,eventType:n.cloudProxyServer,unilbsServerIds:E.toString(),extend:JSON.stringify({networkState:v})}),N.warning("[".concat(n.clientId,"] multi unilbs network error, retry"),y),!0)),a)}const ds=(t,n,r,a,d,l)=>{const{sid:p,clientId:E,cloudProxyServer:f}=r,T=[],R=v=>{v.flag===4096?ee.joinChooseServer(p,{lts:a,succ:!1,csAddr:n,opid:t.opid,serverList:null,ec:v.error.message,csIp:v.error.data&&v.error.data.csIp,unilbsServerIds:d.toString(),isHttp3:l,corssRegionTagReq:r.apRequestDetail}):v.flag!==1048576&&v.flag!==4194304&&v.flag!==4194310||ee.joinWebProxyAP(p,{lts:a,sucess:0,apServerAddr:n,turnServerAddrList:null,errorCode:v.error.code,eventType:f,unilbsServerIds:d.toString()})};if(t.response_body.forEach(v=>{const y=v.buffer.code;if(v.uri===23&&y===0&&!v.buffer.edges_services)if(v.buffer.flag===4194310)N.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),v.buffer.edges_services=[];else{const w={error:new lt(H.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:v.buffer.flag};T.push(w),R(w)}if(y!==0){const w=Ja(y),B={error:new lt(H.CAN_NOT_GET_GATEWAY_SERVER,w.desc,{desc:w.desc,retry:w.retry,csIp:t.detail[502]}),flag:v.buffer.flag};v.buffer.flag===4194310?N.warning(B.error.toString()):T.push(B),R(B)}}),T.length)throw N.warning("[".concat(E||"sid-".concat(p.slice(0,6)),"] multi unilbs ").concat(n," failed, ").concat(T.map(v=>"flag: ".concat(v.flag,", message: ").concat(v.error.message,", retry: ").concat(v.error.data.retry)).join(" | "))),new lt(H.CAN_NOT_GET_GATEWAY_SERVER,T.map(v=>"flag: ".concat(v.flag,", message: ").concat(v.error.message)).join(" | "),{retry:!!T.find(v=>v.error.data.retry),csIp:t.detail[502],desc:[...new Set(T.map(v=>{var y;return v==null||(y=v.error)===null||y===void 0||(y=y.data)===null||y===void 0?void 0:y.desc}).filter(v=>!!v))]})},$l=t=>{var n,r,a,d;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new lt(H.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(J("AP_AREA")&&((a=t.detail)!==null&&a!==void 0&&a[23]&&typeof((d=t.detail)===null||d===void 0?void 0:d[23])=="string"?Qw(t.detail[23].toLowerCase()):Qw()),(n=t.detail)!==null&&n!==void 0&&n[19]&&typeof((r=t.detail)===null||r===void 0?void 0:r[19])=="string"){const p=t.detail[19],E=p==null?void 0:p.split(";");for(let f=0;f<E.length;f++){var l;const T=ms(l=E[f]).call(l);t.addresses[f]&&E&&(t.addresses[f].fingerprint=T)}}if(J("GATEWAY_ADDRESS")&&J("GATEWAY_ADDRESS").length>0){N.debug("assign gateway address to",J("GATEWAY_ADDRESS"));const p=J("GATEWAY_ADDRESS").map(E=>{var f,T;const R=(f=(T=t.addresses.find(v=>v.ip===E.ip&&v.port===E.port))===null||T===void 0?void 0:T.fingerprint)!==null&&f!==void 0?f:"";return{ip:E.ip,port:E.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:R}});t.addresses=p}},Zw=(t,n)=>{if(t.response_body&&t.response_body.length){const r=t.response_body[0];if(r.buffer.code!==0){const a=Ja(r.buffer.code);throw new lt(H.UPDATE_TICKET_FAILED,"[".concat(r.buffer.code,"]: ").concat(a.desc),{retry:a.retry})}return r.buffer.ticket}throw N.debug("update ticket request received ap response without response body:",n),new lt(H.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Cd=(t,n,r)=>{const a=Math.floor(Math.random()*1e12),d={appid:t.appId,client_ts:Date.now(),opid:a,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:Yo(Yo({6:t.stringUid,11:n,12:J("USE_NEW_TOKEN")?"1":void 0,22:n},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:r,uid:t.uid||0}}]};d.request_bodies.forEach(p=>{t.multiIP&&t.multiIP.gateway_ip&&(p.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});const l=new FormData;return l.append("request",JSON.stringify(d)),[l,a]},dc=(t,n)=>{const r=Math.floor(Math.random()*1e12),a={appid:t.appId,client_ts:Date.now(),opid:r,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:n,uid:t.uid||0,edges_services:t.apResponse.addresses.map(l=>({ip:l.ip,port:l.port}))}}]},d=new FormData;return d.append("request",JSON.stringify(a)),[d,r]};let th=0;function Vs(t){return Bt.all(t.map(n=>n.then(r=>{throw r},r=>r))).then(n=>{throw n},n=>n)}const uc=async t=>{let{fragementLength:n,referenceList:r,asyncMapHandler:a,allFailedhandler:d,promisesCollector:l}=t,p=0;const E=n;let f,T=0;const R=async()=>{const v=(()=>{const y=p*E,w=y+E;return r.slice(y,w).map(a)})();l&&l.push(...v);try{f=await Vs(v)}catch(y){if(T+=E,p++,!(T>=r.length))return void await R();d(y)}v.forEach(y=>y.cancel())};return await R(),f},eh=async t=>{let{referenceList:n,asyncMapHandler:r,closeFn:a}=t;const d=n.length;let l=0;const p=async()=>{const E=r(n.shift());try{return await E}catch(f){if(l++,l>=d||a!=null&&a(f))throw f;return p()}};return p()};async function Ve(t,n,r,a){return{gatewayInfo:await async function(l,p,E,f){let T=null;const R=[],v=async()=>{const w=J("WEBCS_DOMAIN").slice(0,J("AJAX_REQUEST_CONCURRENT")).map(U=>({url:l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(U+"/api/v2/transpond/webrtc?v=2"):"https://".concat(U,"/api/v2/transpond/webrtc?v=2"),areaCode:So()})),B=f.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:w.map(U=>U.url)}),k=await uc({fragementLength:J("FRAGEMENT_LENGTH"),referenceList:w,asyncMapHandler:U=>(N.debug("[".concat(l.clientId,"] Connect to choose_server:"),U.url),Ir(U,l,p,E)),allFailedhandler:U=>{throw f.recordJoinChannelService({endTs:Date.now(),status:"error",errors:U},B),U[0]},promisesCollector:R});return f.recordJoinChannelService({endTs:Date.now(),status:"success"},B),k},y=async()=>{if(await xr(1e3),T!==null)return T;const w=J("WEBCS_DOMAIN_BACKUP_LIST").map(U=>({url:l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(U+"/api/v2/transpond/webrtc?v=2"):"https://".concat(U,"/api/v2/transpond/webrtc?v=2"),areaCode:So()})),B=f.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:w.map(U=>U.url)}),k=await uc({fragementLength:J("FRAGEMENT_LENGTH"),referenceList:w,asyncMapHandler:U=>(N.debug("[".concat(l.clientId,"] Connect to backup choose_server:"),U.url),Ir(U,l,p,E)),allFailedhandler:U=>{throw f.recordJoinChannelService({endTs:Date.now(),status:"error",errors:U},B),U[0]},promisesCollector:R});return f.recordJoinChannelService({endTs:Date.now(),status:"success"},B),k};try{return T=await Vs([v(),y()]),R.length&&R.forEach(w=>w.cancel&&typeof w.cancel=="function"&&w.cancel()),T}catch(w){throw w[0]}}(t,n,r,a)}}async function $w(t,n,r,a,d){const l=t.cloudProxyServer;if(l==="disabled"){if(t.useLocalAccessPoint)return await Ve(t,n,r,d);if(J("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:y,proxyInfo:w}=await SC(t,n,r,d);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:y};const B=w.map(k=>({turnServerURL:k.address,tcpport:k.tcpport||Vr.tcpport,udpport:k.udpport||Vr.udpport,username:k.username||Vr.username,password:k.password||Vr.password,forceturn:!1,security:!0}));if(d.useP2P){var p;const k=(p=t.uid)!==null&&p!==void 0?p:y.uid,U="glb:".concat(k.toString()),G=await fR(U),W=w.map($=>({turnServerURL:$.address,tcpport:$.tcpport||Vr.tcpport,udpport:$.udpport||Vr.udpport,username:U,password:G,forceturn:!1,security:!0}));B.push(...W)}return t.turnServer={mode:"manual",servers:B},{gatewayInfo:y}}return await Ve(t,n,r,d)}const{proxyInfo:E,gatewayInfo:f}=await SC(t,n,r,d),T={gatewayInfo:f},R=E.map(y=>({turnServerURL:y.address,tcpport:l==="proxy3"?void 0:y.tcpport?y.tcpport:Vr.tcpport,udpport:l==="proxy4"?void 0:y.udpport?y.udpport:Vr.udpport,username:y.username||Vr.username,password:y.password||Vr.password,forceturn:l!=="proxy4",security:l==="proxy5"}));if(d.useP2P){var v;const y=(v=t.uid)!==null&&v!==void 0?v:f.uid,w="glb:".concat(y.toString()),B=await fR(w),k=E.map(U=>({turnServerURL:U.address,tcpport:l==="proxy3"?void 0:U.tcpport||Vr.tcpport,udpport:l==="proxy4"?void 0:U.udpport||Vr.udpport,username:w,password:B,forceturn:l!=="proxy4",security:l==="proxy5"}));R.push(...k)}return t.turnServer={mode:"manual",servers:R},N.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(l)),T}async function tO(t,n,r,a,d){const l=J("ACCOUNT_REGISTER").slice(0,J("AJAX_REQUEST_CONCURRENT"));let p=[];p=n.proxyServer?l.map(f=>"https://".concat(n.proxyServer,"/ap/?url=").concat(f+"/api/v1")):l.map(f=>"https://".concat(f,"/api/v1"));const E=d==null?void 0:d.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:p});try{const f=await async function(T,R,v,y,w){const B=Date.now(),k={sid:v.sid,opid:10,appid:v.appId,string_uid:R};let U=T[0];const G=await cd(()=>Fc(U+"".concat(U.indexOf("?")===-1?"?":"&","action=stringuid"),{data:k,cancelToken:y,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(W,$)=>{if(W.code===0){if(W.uid<=0||W.uid>=Math.pow(2,32))throw N.error("Invalid Uint Uid ".concat(R," => ").concat(W.uid),W),ee.reqUserAccount(k.sid,{lts:B,success:!1,serverAddr:U,stringUid:k.string_uid,uid:W.uid,errorCode:H.INVALID_UINT_UID_FROM_STRING_UID,extend:k}),new lt(H.INVALID_UINT_UID_FROM_STRING_UID);return ee.reqUserAccount(k.sid,{lts:B,success:!0,serverAddr:U,stringUid:k.string_uid,uid:W.uid,errorCode:null,extend:k}),!1}const rt=Ja(W.code);return rt.retry&&(U=T[($+1)%T.length]),ee.reqUserAccount(k.sid,{lts:B,success:!1,serverAddr:U,stringUid:k.string_uid,uid:W.uid,errorCode:rt.desc,extend:k}),rt.retry},(W,$)=>W.code!==H.OPERATION_ABORTED&&(ee.reqUserAccount(k.sid,{lts:B,success:!1,serverAddr:U,stringUid:k.string_uid,uid:null,errorCode:W.code,extend:k}),U=T[($+1)%T.length],!0),w);if(G.code!==0){const W=Ja(G.code);throw new lt(H.UNEXPECTED_RESPONSE,W.desc)}return G}(p,t,n,r,a);return d==null||d.recordJoinChannelService({status:"success",endTs:Date.now()},E),f.uid}catch(f){throw d==null||d.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[f]},E),f}}async function Zr(t,n,r){const a=J("ACCOUNT_REGISTER");let d=[];d=n.proxyServer?a.map(l=>"https://".concat(n.proxyServer,"/ap/?url=").concat(l+"/api/v1")):a.map(l=>"https://".concat(l,"/api/v1"));try{return await eh({referenceList:d,asyncMapHandler:p=>async function(E,f,T,R){const v=Date.now(),y={sid:T.sid,opid:10,appid:T.appId,string_uid:f};try{const w=await Fc(E+"".concat(E.indexOf("?")===-1?"?":"&","action=stringuid"),{data:y,cancelToken:R,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(w.code!==0){const B=Ja(w.code);throw new lt(H.UNEXPECTED_RESPONSE,"preload sua error:".concat(B.desc),B)}if(w.uid<=0||w.uid>=Math.pow(2,32))throw new lt(H.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:v,url:E,req:y,uid:w.uid,elapse:Date.now()-v}}catch(w){throw w}}(p,t,n,r),closeFn:p=>p.code===H.OPERATION_ABORTED||p.code===H.UNEXPECTED_RESPONSE&&!p.data.retry})}catch(l){throw l}}async function lc(t,n,r){const a=J("CDS_AP").slice(0,J("AJAX_REQUEST_CONCURRENT")).map(f=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(f+"/api/v1"):"https://".concat(f,"/api/v1?action=config")),d=a.map(f=>function(T,R,v,y){const w=en(),B={flag:64,cipher_method:0,features:{device:w.name,system:w.os,system_general:navigator.userAgent,vendor:R.appId,version:Vt,cname:R.cname,sid:R.sid,session_id:R.sid,detail:"",proxyServer:R.proxyServer}};return cd(()=>Fc(T,{data:B,timeout:1e3,cancelToken:v,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,k=>k.code!==H.OPERATION_ABORTED,y)}(f,t,n,r));let l=null,p=null,E={};try{l=await Vs(d)}catch(f){if(f.code===H.OPERATION_ABORTED)throw f;p=f}if(d.forEach(f=>f.cancel()),ee.reportApiInvoke(t.sid,{name:Gi.REQUEST_CONFIG_DISTRIBUTE,options:{error:p,res:l}}).onSuccess(),l&&l.test_tags)try{E=function(f){if(!f.test_tags)return{};const T=f.test_tags,R=Object.keys(T),v={};return R.forEach(y=>{var w;const B=ms(w=y.slice(4)).call(w),k=JSON.parse(T[y])[1];v[B]=k}),v}(l)}catch{}return E}async function n1(t,n){const r=J("WEBCS_DOMAIN").concat(J("WEBCS_DOMAIN_BACKUP_LIST")).map(a=>({url:"https://".concat(a,"/api/v2/transpond/webrtc?v=2"),areaCode:So(),serviceIds:[Xi.CHOOSE_SERVER,Xi.CLOUD_PROXY_FALLBACK]}));try{return await eh({referenceList:r,asyncMapHandler:d=>async function(l,p,E){let f,{url:T,areaCode:R,serviceIds:v}=l;const y=Date.now(),[w,B]=Cd(p,R,v);let k=Ui.networkState;try{k&&Ui.networkState===fo.OFFLINE&&Ui.onlineWaiter&&await Bt.race([Ui.onlineWaiter,xr(Vi.maxRetryTimeout)]),k=Ui.networkState;const{data:U,headers:G}=await Fc(T,{data:w,cancelToken:E,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);f=G.http3==="1"?1:-1,(ot=>{const Et=[];if(ot.response_body.forEach(vt=>{const Lt=vt.buffer.code;if(vt.uri===23&&Lt===0&&!vt.buffer.edges_services)if(vt.buffer.flag===4194310)vt.buffer.edges_services=[];else{const wt={error:new lt(H.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:ot.detail[502]}),flag:vt.buffer.flag};Et.push(wt)}if(Lt!==0){const wt=Ja(Lt),$t={error:new lt(H.CAN_NOT_GET_GATEWAY_SERVER,wt.desc,{desc:wt.desc,retry:wt.retry,csIp:ot.detail[502]}),flag:vt.buffer.flag};vt.buffer.flag===4194310?N.warning($t.error.toString()):Et.push($t)}}),Et.length)throw new lt(H.CAN_NOT_GET_GATEWAY_SERVER,Et.map(vt=>"flag: ".concat(vt.flag,", message: ").concat(vt.error.message)).join(" | "),{retry:!!Et.find(vt=>vt.error.data.retry),csIp:ot.detail[502],desc:[...new Set(Et.map(vt=>{var Lt;return vt==null||(Lt=vt.error)===null||Lt===void 0||(Lt=Lt.data)===null||Lt===void 0?void 0:Lt.desc}).filter(vt=>!!vt))]})})(U);const $=fa(U,Xi.CHOOSE_SERVER),rt=fa(U,Xi.CLOUD_PROXY_FALLBACK);return $l($),{gatewayInfo:Bb($,T),proxyInfo:rt,opid:B,requestTime:y,url:T,isHttp3:f,elapse:Date.now()-y}}catch(U){throw U}}(d,t,n),closeFn:d=>d.code===H.OPERATION_ABORTED||d.code===H.CAN_NOT_GET_GATEWAY_SERVER&&!d.data.retry})}catch(a){throw a}}async function SC(t,n,r,a){const d=J("PROXY_SERVER_TYPE3"),l=(w,B,k)=>{let U=k||d;return Array.isArray(U)&&(U=B%2==0?d[1]:d[0]),"https://".concat(U,"/ap/?url=").concat(w)};let p=null;const E=[],f=async()=>{const w=J("WEBCS_DOMAIN").slice(0,J("AJAX_REQUEST_CONCURRENT")).map((U,G)=>{let W;return W=t.cloudProxyServer==="disabled"&&t.proxyServer?l("".concat(U,"/api/v2/transpond/webrtc?v=2"),G,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(U,"/api/v2/transpond/webrtc?v=2"):l("".concat(U,"/api/v2/transpond/webrtc?v=2"),G),{url:W,areaCode:So(),serviceIds:[Xi.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Xi.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Xi.CLOUD_PROXY:Xi.CLOUD_PROXY_FALLBACK]}}),B=a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:w.map(U=>U.url)}),k=await uc({fragementLength:J("FRAGEMENT_LENGTH"),referenceList:w,asyncMapHandler:U=>(N.debug("[".concat(t.clientId,"] Connect to choose_server:"),U.url),Xu(U,t,n,r)),allFailedhandler:U=>{throw a.recordJoinChannelService({endTs:Date.now(),status:"error",errors:U},B),U[0]},promisesCollector:E});return a.recordJoinChannelService({endTs:Date.now(),status:"success"},B),k},T=async()=>{if(await xr(1e3),p!==null)return p;const w=J("WEBCS_DOMAIN_BACKUP_LIST").map((U,G)=>{let W;return W=t.cloudProxyServer==="disabled"&&t.proxyServer?l("".concat(U,"/api/v2/transpond/webrtc?v=2"),G,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(U,"/api/v2/transpond/webrtc?v=2"):l("".concat(U,"/api/v2/transpond/webrtc?v=2"),G),{url:W,areaCode:So(),serviceIds:[Xi.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Xi.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Xi.CLOUD_PROXY:Xi.CLOUD_PROXY_FALLBACK]}}),B=a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:w.map(U=>U.url)}),k=await uc({fragementLength:J("FRAGEMENT_LENGTH"),referenceList:w,asyncMapHandler:U=>(N.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),U.url),Xu(U,t,n,r)),allFailedhandler:U=>{throw a.recordJoinChannelService({endTs:Date.now(),status:"error",errors:U},B),U[0]},promisesCollector:E});return a.recordJoinChannelService({endTs:Date.now(),status:"success"},B),k};let R,v,y;try{({gatewayInfo:R,proxyInfo:v,url:y}=await Vs([f(),T()]))}catch(w){throw w[0]}if(E.length&&E.forEach(w=>w.cancel&&typeof w.cancel=="function"&&w.cancel()),!R||!v)throw new lt(H.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=y,t.cloudProxyServer!=="disabled"&&Array.isArray(d)&&y){const w=/^https?:\/\/(.+?)(\/.*)?$/.exec(y)[1];Mt(d).call(d,w)&&(t.proxyServer=w,N.setProxyServer(w),ee.setProxyServer(w))}return p={gatewayInfo:R,proxyInfo:await fp(v,R.uid)},p}async function eO(t,n,r){const a=J("UAP_AP").slice(0,J("AJAX_REQUEST_CONCURRENT")).map(l=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(l+"/api/v1?action=uap"):"https://".concat(l,"/api/v1?action=uap")),d=a.map(l=>function(p,E,f,T){const R={command:"convergeAllocateEdge",sid:E.sid,appId:E.appId,token:E.token,ts:Date.now(),version:Vt,cname:E.cname,uid:E.uid.toString(),requestId:TC,seq:TC};TC+=1;const v={service_name:"tele_channel",json_body:JSON.stringify(R)};return cd(async()=>{const y=await Fc(p,{data:v,cancelToken:f,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(y.code!==0){const B=new lt(H.UNEXPECTED_RESPONSE,"cross channel ap error, code"+y.code,{retry:!0});throw N.error(B.toString()),B}const w=JSON.parse(y.json_body);if(w.code!==200){const B=new lt(H.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(w.code,", reason: ").concat(w.reason));throw N.error(B.toString()),B}if(!w.servers||w.servers.length===0){const B=new lt(H.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw N.error(B.toString()),B}return{vid:w.vid,workerToken:w.workerToken,addressList:(J("CHANNEL_MEDIA_RELAY_SERVERS")||w.servers).map(B=>"wss://".concat(B.address.replace(/\./g,"-"),".").concat(J("WORKER_DOMAIN"),":").concat(B.wss))}},void 0,y=>!!(y.code!==H.OPERATION_ABORTED&&y.code!==H.UNEXPECTED_RESPONSE||y.data&&y.data.retry),T)}(l,t,n,r));try{const l=await Vs(d);return d.forEach(p=>p.cancel()),l}catch(l){throw l[0]}}async function i1(t,n,r){let a=null;const d=[],l=async p=>{const E=J(p?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(f=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"));return p&&(await xr(1e3),a!==null)?a:await uc({fragementLength:J("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:f=>(N.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(p?"backup":""," choose_server:"),f),function(T,R,v,y){const[w]=dc(R,[Xi.CHOOSE_SERVER]);let B=Ui.networkState;return cd(async()=>{B&&Ui.networkState===fo.OFFLINE&&Ui.onlineWaiter&&await Bt.race([Ui.onlineWaiter,xr(y&&y.maxRetryTimeout||Vi.maxRetryTimeout)]),B=Ui.networkState;const k=await Fc(T,{data:w,cancelToken:v,headers:{"Content-Type":"multipart/form-data;"}},!0);return Zw(k,T)},()=>!1,k=>k.code!==H.OPERATION_ABORTED&&(k.code===H.UPDATE_TICKET_FAILED?k.data.retry:(N.warning("[".concat(R.clientId,"] update ticket network error, retry"),k),!0)),y)}(f,t,n,r)),allFailedhandler:f=>{throw f[0]},promisesCollector:d})};try{return a=await Vs([l(!1),l(!0)]),d.length&&d.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),a}catch(p){throw p[0]}}function Ng(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function _r(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Ng(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Ng(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class vd extends An{get isSuccess(){return!!this.configs}constructor(n){super(),F(this,"configs",void 0),F(this,"joinInfo",void 0),F(this,"cancelToken",void 0),F(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),F(this,"interval",void 0),F(this,"mutex",void 0),F(this,"mutableParamsRead",!1),this.mutex=new Yr("config-distribute",n)}startGetConfigDistribute(n,r){this.joinInfo=n,this.cancelToken=r,this.interval&&this.stopGetConfigDistribute(),J("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},J("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,ee.reportApiInvoke(null,{options:void 0,name:Gi.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Si.TRACER}).onSuccess(JSON.stringify(Fu))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void N.debug("[config-distribute] get config distribute interrupted have no joininfo");let n;const r=await this.mutex.lock();try{n=await lc(this.joinInfo,this.cancelToken,this.retryConfig),N.debug("[config-distribute] get config distribute",JSON.stringify(n)),n.limit_bitrate&&this.handleBitrateLimit(n.limit_bitrate),this.cacheGlobalParameterConfig(n),this.configs=n}catch(a){const d=new lt(H.NETWORK_RESPONSE_ERROR,a);N.warning("[config-distribute] ".concat(d.toString()))}finally{r()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(n){var r;(r=n)&&r.uplink&&r.id&&r.uplink.max_bitrate!==void 0&&r.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==n.id&&this.emit(NR.UPDATE_BITRATE_LIMIT,n):this.emit(NR.UPDATE_BITRATE_LIMIT,n))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&_r({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(n){var r;const a=Vh(r=Object.keys(n).filter(l=>/^webrtc_ng_global_parameter/.test(l))).call(r);for(let l=0;l<a.length;l++)for(let p=a.length-1;p>l;p--){const E=a[p];if(typeof n[E].__priority=="number"){const f=n[E].__priority,T=a[p-1];if(typeof n[T].__priority=="number"){if(!(f>n[T].__priority))continue;{const R=E;a[p]=a[p-1],a[p-1]=R}}else{const R=E;a[p]=a[p-1],a[p-1]=R}}}const d={};a.forEach(l=>{const p=n[l],E=p.__expires;Object.keys(p).forEach(f=>{f==="__priority"||f==="__expires"||Object.prototype.hasOwnProperty.call(d,f)||(d[f]=_r({value:p[f]},E&&{expires:E}))})});try{(function(E){try{const f=Date.now();Object.keys(E).forEach(T=>{switch(T){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(ni,T)){const{value:R,expires:v}=E[T];if(v&&v<=f)return;Fu[T]=R,ni[T]=R,N.debug("Update global parameters from config distribute",T,R)}}})}catch(f){N.error("Error update config immediately: ".concat(E),f.message)}})(d);const l=JSON.stringify(d),p=window.btoa(l);window.localStorage.setItem("websdk_ng_global_parameter",p),N.debug("Caching global parameters ".concat(l))}catch(l){N.error("Error caching global parameters:",l.message)}}}class r1 extends An{constructor(){super(...arguments),F(this,"resultStorage",new Map)}setLocalAudioStats(n,r,a){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",n,this.checkAudioInputLevel(a,r)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",n,this.checkSendAudioBitrate(a,r))}setLocalVideoStats(n,r,a){this.record("SEND_VIDEO_BITRATE_TOO_LOW",n,this.checkSendVideoBitrate(a,r)),this.record("FRAMERATE_INPUT_TOO_LOW",n,this.checkFramerateInput(a,r)),this.record("FRAMERATE_SENT_TOO_LOW",n,this.checkFramerateSent(a))}setRemoteAudioStats(n,r){const a=n.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",a,this.checkAudioOutputLevel(r))}setRemoteVideoStats(n,r){const a=n.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",a,this.checkVideoDecode(r))}record(n,r,a){if(J("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(n)||this.resultStorage.set(n,{result:[],isPrevNormal:!0});const d=this.resultStorage.get(n);if(d&&(d.result.push(a),d.result.length>=5)){var l;const p=Mt(l=d.result).call(l,!0);d.isPrevNormal&&!p&&this.emit("exception",nh[n],n,r),!d.isPrevNormal&&p&&this.emit("exception",nh[n]+2e3,n+"_RECOVER",r),d.isPrevNormal=p,d.result=[]}}checkAudioOutputLevel(n){return!(n.receiveBitrate>0&&n.receiveLevel===0)}checkAudioInputLevel(n,r){return r instanceof Hi&&!r.isActive||!!r.muted||n.sendVolumeLevel!==0}checkFramerateInput(n,r){let a=null;r._encoderConfig&&r._encoderConfig.frameRate&&(a=Fo(r._encoderConfig.frameRate));const d=n.captureFrameRate;return!a||!d||!(a>10&&d<5||a<10&&a>=5&&d<=1)}checkFramerateSent(n){return!(n.captureFrameRate&&n.sendFrameRate&&n.captureFrameRate>5&&n.sendFrameRate<=1)}checkSendVideoBitrate(n,r){return!!r.muted||n.sendBitrate!==0}checkSendAudioBitrate(n,r){return r instanceof Hi&&!r.isActive||!!r.muted||n.sendBitrate!==0}checkVideoDecode(n){return n.receiveBitrate===0||n.decodeFrameRate!==0}}const nh={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Pr=new class{markSubscribeStart(t,n){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(n))}markPublishStart(t,n){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(n))}measureFromSubscribeStart(t,n){const r=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(n));if(r.length>0){const a=r[r.length-1];return Math.round(performance.now()-a.startTime)}return 0}measureFromPublishStart(t,n){const r=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(n));if(r.length>0){const a=r[r.length-1];return Math.round(performance.now()-a.startTime)}return 0}};var nO=Rt($r.Object.getOwnPropertySymbols),Dg=Ce,cG=Ov.indexOf,s1=om,Fs=fi([].indexOf),o1=!!Fs&&1/Fs([1],1,-0)<0;Dg({target:"Array",proto:!0,forced:o1||!s1("indexOf")},{indexOf:function(t){var n=arguments.length>1?arguments[1]:void 0;return o1?Fs(this,t,n)||0:cG(this,t,n)}});var RC=fc("Array").indexOf,a1=le,dG=RC,iO=Array.prototype,CC=function(t){var n=t.indexOf;return t===iO||a1(iO,t)&&n===iO.indexOf?dG:n},rO=Rt(CC);function c1(t,n){if(t==null)return{};var r,a,d=function(p,E){if(p==null)return{};var f,T,R={},v=vk(p);for(T=0;T<v.length;T++)f=v[T],rO(E).call(E,f)>=0||(R[f]=p[f]);return R}(t,n);if(nO){var l=nO(t);for(a=0;a<l.length;a++)r=l[a],rO(n).call(n,r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(d[r]=t[r])}return d}function hc(t){if(Array.isArray(t))return t.map(r=>r);if(!sO(t))return t;const n={};for(const r in t){const a=t[r];sO(a)||Array.isArray(a)?n[r]=hc(a):n[r]=a}return n}function sO(t){return!(typeof t!="object"||Array.isArray(t)||!t)}class vC{constructor(n){F(this,"input",[]),F(this,"size",void 0),this.size=n}add(n){this.input.push(n),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const bi={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},oo={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:bi,remoteCandidate:bi},updateInterval:0},oO={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},Qu={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},AE={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},aO={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function cO(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Vp(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?cO(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):cO(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class wi{constructor(n,r){F(this,"onFirstVideoReceived",void 0),F(this,"onFirstVideoDecoded",void 0),F(this,"onFirstAudioReceived",void 0),F(this,"onFirstVideoDecodedTimeout",void 0),F(this,"onFirstAudioDecoded",void 0),F(this,"onSelectedLocalCandidateChanged",void 0),F(this,"onSelectedRemoteCandidateChanged",void 0),F(this,"videoIsReady",!1),F(this,"videoIsReady2",{}),F(this,"pc",void 0),F(this,"options",void 0),F(this,"intervalTimer",void 0),F(this,"stats",hc(oo)),F(this,"isFirstVideoReceived",{}),F(this,"isFirstVideoDecoded",{}),F(this,"isFirstAudioReceived",{}),F(this,"isFirstAudioDecoded",{}),F(this,"isFirstVideoDecodedTimeout",{}),F(this,"lossRateWindowStats",[]),this.pc=n,this.options=r,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Bt(n=>{n({local:Vp({},bi),remote:Vp({},bi)})})}setVideoIsReady(n){this.videoIsReady=n}setVideoIsReady2(n,r){this.videoIsReady2[n]=r}getVideoIsReady(n){return this.videoIsReady2[n]||!1}setIsFirstAudioDecoded(n){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(n){this.lossRateWindowStats.push(n),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const r=this.lossRateWindowStats.length,a=["videoSend","audioSend","videoRecv","audioRecv"];let d=0,l=0,p=0,E=0;for(const f of a)n[f].forEach((T,R)=>{if(!this.lossRateWindowStats[r-1][f][R]||!this.lossRateWindowStats[0][f][R])return;const v=this.lossRateWindowStats[r-1][f][R].packets-this.lossRateWindowStats[0][f][R].packets,y=this.lossRateWindowStats[r-1][f][R].packetsLost-this.lossRateWindowStats[0][f][R].packetsLost;f==="videoSend"||f==="audioSend"?(d+=v,p+=y):(l+=v,E+=y),Number.isNaN(v)||Number.isNaN(v)?T.packetLostRate=0:T.packetLostRate=v<=0||y<=0?0:y/(v+y)});n.sendPacketLossRate=d<=0||p<=0?0:p/(d+p),n.recvPacketLossRate=l<=0||E<=0?0:E/(l+E)}}function Ro(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function d1(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Ro(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Ro(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class u1 extends wi{constructor(){super(...arguments),F(this,"_stats",oo),F(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const n=await this._getStats(),r=this.statsResponsesToObjects(n);this._stats=hc(oo);const a=r.filter(l=>l.type==="ssrc");this.processSSRCStats(a);const d=r.find(l=>l.type==="VideoBwe");d&&this.processBandwidthStats(d),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(n){this._stats.bitrate={actualEncoded:Number(n.googActualEncBitrate),targetEncoded:Number(n.googTargetEncBitrate),retransmit:Number(n.googRetransmitBitrate),transmit:Number(n.googTransmitBitrate)},this._stats.sendBandwidth=Number(n.googAvailableSendBandwidth)}processSSRCStats(n){n.forEach(r=>{var a;const d=Mt(a=r.id).call(a,"send");switch("".concat(r.mediaType,"_").concat(d?"send":"recv")){case"video_send":{const l=hc(Qu);l.codec=r.googCodecName,l.adaptionChangeReason="none",r.googCpuLimitedResolution&&(l.adaptionChangeReason="cpu"),r.googBandwidthLimitedResolution&&(l.adaptionChangeReason="bandwidth"),l.avgEncodeMs=Number(r.googAvgEncodeMs),l.inputFrame={width:Number(r.googFrameWidthInput)||Number(r.googFrameWidthSent),height:Number(r.googFrameHeightInput)||Number(r.googFrameHeightSent),frameRate:Number(r.googFrameRateInput)},l.sentFrame={width:Number(r.googFrameWidthSent),height:Number(r.googFrameHeightSent),frameRate:Number(r.googFrameRateInput)},l.firsCount=Number(r.googFirReceived),l.nacksCount=Number(r.googNacksReceived),l.plisCount=Number(r.googPlisReceived),l.frameCount=Number(r.framesEncoded),l.bytes=Number(r.bytesSent),l.packets=Number(r.packetsSent),l.packetsLost=Number(r.packetsLost),l.ssrc=Number(r.ssrc),l.rttMs=Number(r.googRtt||0),this._stats.videoSend.push(l),this._stats.rtt=l.rttMs;break}case"video_recv":{const l=hc(oO),p=this.lastDecodeVideoReceiverStats.get(Number(r.ssrc));if(l.codec=r.googCodecName,l.targetDelayMs=Number(r.googTargetDelayMs),l.renderDelayMs=Number(r.googRenderDelayMs),l.currentDelayMs=Number(r.googCurrentDelayMs),l.minPlayoutDelayMs=Number(r.googMinPlayoutDelayMs),l.decodeMs=Number(r.googDecodeMs),l.maxDecodeMs=Number(r.googMaxDecodeMs),l.receivedFrame={width:Number(r.googFrameWidthReceived),height:Number(r.googFrameHeightReceived),frameRate:Number(r.googFrameRateReceived)},l.decodedFrame={width:Number(r.googFrameWidthReceived),height:Number(r.googFrameHeightReceived),frameRate:Number(r.googFrameRateDecoded)},l.decodeFrameRate=Number(r.googFrameRateDecoded),l.outputFrame={width:Number(r.googFrameWidthReceived),height:Number(r.googFrameHeightReceived),frameRate:Number(r.googFrameRateOutput)},l.jitterBufferMs=Number(r.googJitterBufferMs),l.firsCount=Number(r.googFirsSent),l.nacksCount=Number(r.googNacksSent),l.plisCount=Number(r.googPlisSent),l.framesDecodeCount=Number(r.framesDecoded),l.bytes=Number(r.bytesReceived),l.packets=Number(r.packetsReceived),l.packetsLost=Number(r.packetsLost),l.ssrc=Number(r.ssrc),l.packets>0&&!this.isFirstVideoReceived[l.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(l.ssrc),this.isFirstVideoReceived[l.ssrc]=!0),l.framesDecodeCount>0&&!this.isFirstVideoDecoded[l.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(l.ssrc,l.decodedFrame.width,l.decodedFrame.height),this.isFirstVideoDecoded[l.ssrc]=!0),p){const E=p.stats,f=Date.now()-p.lts;l.framesDecodeFreezeTime=E.framesDecodeFreezeTime,l.framesDecodeInterval=E.framesDecodeInterval,l.framesDecodeCount>E.framesDecodeCount&&this.isFirstVideoDecoded[l.ssrc]?(p.lts=Date.now(),l.framesDecodeInterval=f,l.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(r.ssrc,10))?l.framesDecodeFreezeTime+=l.framesDecodeInterval:this.setVideoIsReady2(parseInt(r.ssrc,10),!0))):l.framesDecodeCount<p.stats.framesDecodeCount&&(l.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(l.ssrc,{stats:d1({},l),lts:Date.now()}),this._stats.videoRecv.push(l);break}case"audio_recv":{const l=hc(aO);l.codec=r.googCodecName,l.outputLevel=Math.abs(Number(r.audioOutputLevel))/32767,l.decodingCNG=Number(r.googDecodingCNG),l.decodingCTN=Number(r.googDecodingCTN),l.decodingCTSG=Number(r.googDecodingCTSG),l.decodingNormal=Number(r.googDecodingNormal),l.decodingPLC=Number(r.googDecodingPLC),l.decodingPLCCNG=Number(r.googDecodingPLCCNG),l.expandRate=Number(r.googExpandRate),l.accelerateRate=Number(r.googAccelerateRate),l.preemptiveExpandRate=Number(r.googPreemptiveExpandRate),l.secondaryDecodedRate=Number(r.googSecondaryDecodedRate),l.speechExpandRate=Number(r.googSpeechExpandRate),l.preferredJitterBufferMs=Number(r.googPreferredJitterBufferMs),l.jitterBufferMs=Number(r.googJitterBufferMs),l.jitterMs=Number(r.googJitterReceived),l.bytes=Number(r.bytesReceived),l.packets=Number(r.packetsReceived),l.packetsLost=Number(r.packetsLost),l.ssrc=Number(r.ssrc),l.receivedFrames=Number(r.googDecodingCTN)||Number(r.packetsReceived),l.droppedFrames=Number(r.googDecodingPLC)+Number(r.googDecodingPLCCNG)||Number(r.packetsLost),l.receivedFrames>0&&!this.isFirstAudioReceived[l.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(l.ssrc),this.isFirstAudioReceived[l.ssrc]=!0),l.decodingNormal>0&&!this.isFirstAudioDecoded[l.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(l.ssrc),this.isFirstAudioDecoded[l.ssrc]=!0),this._stats.audioRecv.push(l);break}case"audio_send":{const l=hc(AE);l.codec=r.googCodecName,l.inputLevel=Math.abs(Number(r.audioInputLevel))/32767,l.aecReturnLoss=Number(r.googEchoCancellationReturnLoss||0),l.aecReturnLossEnhancement=Number(r.googEchoCancellationReturnLossEnhancement||0),l.residualEchoLikelihood=Number(r.googResidualEchoLikelihood||0),l.residualEchoLikelihoodRecentMax=Number(r.googResidualEchoLikelihoodRecentMax||0),l.bytes=Number(r.bytesSent),l.packets=Number(r.packetsSent),l.packetsLost=Number(r.packetsLost),l.ssrc=Number(r.ssrc),l.rttMs=Number(r.googRtt||0),this._stats.rtt=l.rttMs,this._stats.audioSend.push(l);break}}})}_getStats(){return new Bt((n,r)=>{this.pc.getStats(n,r)})}statsResponsesToObjects(n){const r=[];return n.result().forEach(a=>{const d={id:a.id,timestamp:a.timestamp.valueOf().toString(),type:a.type};a.names().forEach(l=>{d[l]=a.stat(l)}),r.push(d)}),r}}var Fp=function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t}(Fp||{});function ih(t,n,r,a){let d=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Fp.kNone;if(!n)return;const l=Number(n[r]);if(typeof l!="number")return;const p=Number(n[a]);if(typeof p!="number")return;if(!t)return p?l/p*d:void 0;const E=Number(t[r]);if(typeof E!="number")return;const f=Number(t[a]);if(typeof f!="number")return;const T=p-f;return T?(l-E)/T*d:void 0}function IC(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function au(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?IC(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):IC(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class l1 extends wi{constructor(){super(...arguments),F(this,"_stats",oo),F(this,"report",void 0),F(this,"lastDecodeVideoReceiverStats",new Map),F(this,"lastVideoFramesRecv",new Map),F(this,"lastVideoFramesSent",new Map),F(this,"lastVideoFramesDecode",new Map),F(this,"lastVideoFramesOutput",new Map),F(this,"lastVideoJBDelay",new Map),F(this,"lastAudioJBDelay",new Map),F(this,"mediaBytesSent",new Map),F(this,"mediaBytesRetransmit",new Map),F(this,"mediaBytesTargetEncode",new Map),F(this,"lastDecodeAudioReceiverStats",new Map),F(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=hc(oo),this.report.forEach(n=>{switch(n.type){case Rs.OUTBOUND:case Rs.INBOUND:{const r=n.mediaType||n.kind,a=!r&&"frameWidth"in n,d=!r&&!("frameWidth"in n);n.type===Rs.OUTBOUND?r==="audio"||d?this.processAudioOutboundStats(n):(r==="video"||a)&&this.processVideoOutboundStats(n):n.type===Rs.INBOUND&&(r==="audio"||d?this.processAudioInboundStats(n):(r==="video"||a)&&this.processVideoInboundStats(n));break}case Rs.TRANSPORT:{const r=this.report.get(n.selectedCandidatePairId);r&&this.processCandidatePairStats(r);break}case Rs.CANDIDATE_PAIR:n.selected&&this.processCandidatePairStats(n)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const n=await this.pc.getStats(),r={local:au({},bi),remote:au({},bi)};return n.forEach(a=>{let d;if(a.type===Rs.TRANSPORT&&(d=n.get(a.selectedCandidatePairId)),a.type===Rs.CANDIDATE_PAIR&&a.selected&&(d=a),d){const l=(p,E)=>{p.type=E.type,p.id=E.id,E.address&&(p.address=E.address),E.candidateType&&(p.candidateType=E.candidateType),E.port&&(p.port=E.port),E.priority&&(p.priority=E.priority),E.protocol&&(p.protocol=E.protocol),E.relayProtocol&&(p.relayProtocol=E.relayProtocol)};if(d.localCandidateId){const p=n.get(d.localCandidateId);p&&l(r.local,p)}if(d.remoteCandidateId){const p=n.get(d.remoteCandidateId);p&&l(r.remote,p)}}}),r}processCandidatePairStats(n){if(this._stats.sendBandwidth=n.availableOutgoingBitrate||0,n.currentRoundTripTime&&(this._stats.rtt=1e3*n.currentRoundTripTime),this._stats.videoSend.forEach(r=>{n.currentRoundTripTime&&(r.rttMs=1e3*n.currentRoundTripTime)}),this._stats.audioSend.forEach(r=>{n.currentRoundTripTime&&(r.rttMs=1e3*n.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=n.id,n.localCandidateId){const r=this.report.get(n.localCandidateId);r&&this.processCandidateStats(r)}if(n.remoteCandidateId){const r=this.report.get(n.remoteCandidateId);r&&this.processCandidateStats(r)}}processCandidateStats(n){let r;n.type===Rs.LOCAL_CANDIDATE&&(r=this._stats.selectedCandidatePair.localCandidate),n.type===Rs.REMOTE_CANDIDATE&&(r=this._stats.selectedCandidatePair.remoteCandidate),r&&(r.type=n.type,r.id=n.id,n.address&&(r.address=n.address),n.candidateType&&(r.candidateType=n.candidateType),n.port&&(r.port=n.port),n.priority&&(r.priority=n.priority),n.protocol&&(r.protocol=n.protocol),n.relayProtocol&&(r.relayProtocol=n.relayProtocol),n.type===Rs.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==r.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(au({},r),au({},this.stats.selectedCandidatePair.localCandidate)),n.type===Rs.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==r.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(au({},r),au({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(n){let r=this._stats.audioRecv.find(d=>d.ssrc===n.ssrc);r||(r=hc(aO),this._stats.audioRecv.push(r)),r.ssrc=n.ssrc,r.packets=n.packetsReceived,r.packetsLost=n.packetsLost,r.packetsDiscarded=n.packetsDiscarded,r.bytes=n.bytesReceived,r.jitterMs=1e3*n.jitter,r.retransmittedBytesReceived=n.retransmittedBytesReceived,r.retransmittedPacketsReceived=n.retransmittedPacketsReceived,r.totalProcessingDelay=n.totalProcessingDelay,r.jitterBufferEmittedCount=n.jitterBufferEmittedCount;const a=this.lastDecodeAudioReceiverStats.get(r.ssrc);r.avgProcessingDelayMs=ih(a,r,"totalProcessingDelay","jitterBufferEmittedCount",Fp.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(n,n.trackId,r),n.codecId&&(r.codec=this.getCodecFromCodecStats(n.codecId)),r.receivedFrames||(r.receivedFrames=n.packetsReceived),r.droppedFrames||(r.droppedFrames=n.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.outputLevel&&r.outputLevel>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),typeof n.concealedSamples=="number"&&(r.concealedSamples=n.concealedSamples),this.lastDecodeAudioReceiverStats.set(r.ssrc,au({},r))}processVideoInboundStats(n){let r=this._stats.videoRecv.find(E=>E.ssrc===n.ssrc);r||(r=hc(oO),this._stats.videoRecv.push(r)),r.ssrc=n.ssrc,r.packets=n.packetsReceived,r.packetsLost=n.packetsLost,r.bytes=n.bytesReceived,r.firsCount=n.firCount,r.nacksCount=n.nackCount,r.plisCount=n.pliCount,r.framesDecodeCount=n.framesDecoded,r.framesDroppedCount=n.framesDropped,r.totalInterFrameDelay=n.totalInterFrameDelay,r.totalSquaredInterFrameDelay=n.totalSquaredInterFrameDelay,r.totalFreezesDuration=n.totalFreezesDuration,r.totalProcessingDelay=n.totalProcessingDelay,r.packetsDiscarded=n.packetsDiscarded,r.framesAssembledFromMultiplePackets=n.framesAssembledFromMultiplePackets,r.totalAssemblyTime=n.totalAssemblyTime,r.keyFramesDecoded=n.keyFramesDecoded,r.retransmittedBytesReceived=n.retransmittedBytesReceived,r.retransmittedPacketsReceived=n.retransmittedPacketsReceived;const a=this.lastDecodeVideoReceiverStats.get(r.ssrc),d=this.lastVideoFramesDecode.get(r.ssrc),l=this.lastVideoFramesOutput.get(r.ssrc),p=Date.now();if(r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]){const E=r.decodedFrame?r.decodedFrame.width:0,f=r.decodedFrame?r.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,E,f),this.isFirstVideoDecoded[r.ssrc]=!0}if(a){const E=a.stats,f=p-a.lts;r.framesDecodeFreezeTime=E.framesDecodeFreezeTime,r.framesDecodeInterval=E.framesDecodeInterval,!this.isFirstVideoDecoded[r.ssrc]&&f>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[r.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(r.ssrc),this.isFirstVideoDecodedTimeout[r.ssrc]=!0),r.framesDecodeCount>E.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(a.lts=Date.now(),r.framesDecodeInterval=f,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):r.framesDecodeCount<E.framesDecodeCount&&(r.framesDecodeInterval=0),n.framesDecoded&&n.qpSum&&(a.stats.framesDecodeCount>n.framesDecoded?r.qpSumPerFrame=n.qpSum/n.framesDecoded:r.qpSumPerFrame=(n.qpSum-a.qpSum)/(n.framesDecoded-a.stats.framesDecodeCount))}n.totalDecodeTime&&(r.decodeMs=1e3*n.totalDecodeTime,r.avgDecodeMs=ih(a==null?void 0:a.stats,r,"decodeMs","framesDecodeCount")),r.avgProcessingDelayMs=ih(a==null?void 0:a.stats,r,"totalProcessingDelay","framesDecodeCount",Fp.kMillisecondsFromSeconds),r.avgFramesAssembledFromMultiplePacketsMs=ih(a==null?void 0:a.stats,r,"totalAssemblyTime","framesAssembledFromMultiplePackets",Fp.kMillisecondsFromSeconds),r.avgInterFrameDelayMs=ih(a==null?void 0:a.stats,r,"totalInterFrameDelay","framesDecodeCount",Fp.kMillisecondsFromSeconds),d&&p-d.lts>=800?(r.decodeFrameRate=Math.round((r.framesDecodeCount-d.count)/((p-d.lts)/1e3)),this.lastVideoFramesDecode.set(r.ssrc,{count:r.framesDecodeCount,lts:p,rate:r.decodeFrameRate})):d?r.decodeFrameRate=d.rate:this.lastVideoFramesDecode.set(r.ssrc,{count:r.framesDecodeCount,lts:p,rate:0}),r.framesDroppedCount&&n.framesReceived&&(l&&p-l.lts>=800?(r.outputFrameRate=Math.round((n.framesReceived-r.framesDroppedCount-l.count)/((p-l.lts)/1e3)),this.lastVideoFramesOutput.set(r.ssrc,{count:n.framesReceived-r.framesDroppedCount,lts:p,rate:Math.max(r.outputFrameRate,0)})):l?r.outputFrameRate=l.rate:this.lastVideoFramesOutput.set(r.ssrc,{count:n.framesReceived-r.framesDroppedCount,lts:p,rate:0})),this.processVideoTrackReceiverStats(n,n.trackId,r),n.codecId&&(r.codec=this.getCodecFromCodecStats(n.codecId)),n.framerateMean&&(r.framesRateFirefox=n.framerateMean),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:au({},r),lts:a?a.lts:Date.now(),qpSum:n.qpSum})}processVideoOutboundStats(n){let r=this._stats.videoSend.find(d=>d.ssrc===n.ssrc);r||(r=hc(Qu),this._stats.videoSend.push(r));const a=this.mediaBytesSent.get(n.ssrc);if(a)a.add(n.bytesSent);else{const d=new vC(10);d.add(n.bytesSent),this.mediaBytesSent.set(n.ssrc,d)}if(n.retransmittedBytesSent!==void 0){const d=this.mediaBytesRetransmit.get(n.ssrc);if(d)d.add(n.retransmittedBytesSent);else{const l=new vC(10);l.add(n.retransmittedBytesSent),this.mediaBytesRetransmit.set(n.ssrc,l)}}if(n.totalEncodedBytesTarget){const d=this.mediaBytesTargetEncode.get(n.ssrc);if(d)d.add(n.totalEncodedBytesTarget);else{const l=new vC(10);l.add(n.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(n.ssrc,l)}}if(r.ssrc=n.ssrc,r.bytes=n.bytesSent,r.packets=n.packetsSent,r.firsCount=n.firCount,r.nacksCount=n.nackCount,r.plisCount=n.pliCount,r.frameCount=n.framesEncoded,r.adaptionChangeReason=n.qualityLimitationReason,r.scalabilityMode=n.scalabilityMode,r.retransmittedBytesSent=n.retransmittedBytesSent,r.retransmittedPacketsSent=n.retransmittedPacketsSent,r.hugeFramesSent=n.hugeFramesSent,r.keyFramesEncoded=n.keyFramesEncoded,n.totalEncodeTime&&n.framesEncoded){const d=this.lastEncoderMs.get(n.ssrc);if(!d||d.lastFrameCount>n.framesEncoded)r.avgEncodeMs=1e3*n.totalEncodeTime/n.framesEncoded;else{const l=n.framesEncoded-d.lastFrameCount,p=n.totalEncodeTime-d.lastEncoderTime;r.avgEncodeMs=1e3*p/l}}if(n.framesEncoded&&n.qpSum){const d=this.lastEncoderMs.get(n.ssrc);!d||d.lastFrameCount>n.framesEncoded?r.qpSumPerFrame=n.qpSum/n.framesEncoded:r.qpSumPerFrame=(n.qpSum-d.lastQpSum)/(n.framesEncoded-d.lastFrameCount)}if(this.lastEncoderMs.set(n.ssrc,{lastFrameCount:n.framesEncoded,lastEncoderTime:n.totalEncodeTime,lastQpSum:n.qpSum,lts:Date.now()}),n.codecId&&(r.codec=this.getCodecFromCodecStats(n.codecId)),n.mediaSourceId&&this.processVideoMediaSource(n.mediaSourceId,r),this.processVideoTrackSenderStats(n,n.trackId,r),n.remoteId)this.processRemoteInboundStats(n.remoteId,r);else{const d=this.findRemoteStatsId(n.ssrc,Rs.REMOTE_INBOUND);d&&this.processRemoteInboundStats(d,r)}}processAudioOutboundStats(n){let r=this._stats.audioSend.find(a=>a.ssrc===n.ssrc);if(r||(r=hc(AE),this._stats.audioSend.push(r)),r.ssrc=n.ssrc,r.packets=n.packetsSent,r.bytes=n.bytesSent,r.retransmittedBytesSent=n.retransmittedBytesSent,r.retransmittedPacketsSent=n.retransmittedPacketsSent,n.mediaSourceId&&this.processAudioMediaSource(n.mediaSourceId,r),n.codecId&&(r.codec=this.getCodecFromCodecStats(n.codecId)),this.processAudioTrackSenderStats(n,n.trackId,r),n.remoteId)this.processRemoteInboundStats(n.remoteId,r);else{const a=this.findRemoteStatsId(n.ssrc,Rs.REMOTE_INBOUND);a&&this.processRemoteInboundStats(a,r)}}findRemoteStatsId(n,r){var a;const d=Array.from($d(a=this.report).call(a)).find(l=>l.type===r&&l.ssrc===n);return d?d.id:null}processVideoMediaSource(n,r){const a=this.report.get(n);a&&a.width&&a.height&&a.framesPerSecond&&(r.inputFrame={width:a.width,height:a.height,frameRate:a.framesPerSecond})}processAudioMediaSource(n,r){const a=this.report.get(n);a&&(r.inputLevel=a.audioLevel)}processVideoTrackSenderStats(n,r,a){var d,l,p,E;const f=r?this.report.get(r):void 0,T=(d=f==null?void 0:f.framesSent)!==null&&d!==void 0?d:n.framesSent;if(typeof T!="number")return;let R=(l=f==null?void 0:f.frameWidth)!==null&&l!==void 0?l:n.frameWidth,v=(p=f==null?void 0:f.frameHeight)!==null&&p!==void 0?p:n.frameHeight,y=(E=f==null?void 0:f.framesPerSecond)!==null&&E!==void 0?E:n.framesPerSecond;if(typeof R=="number"&&typeof v=="number"||(R=0,v=0),y==null){const w=Date.now(),B=this.lastVideoFramesSent.get(a.ssrc);B&&w-B.lts>=800?(y=Math.round((T-B.count)/((w-B.lts)/1e3)),this.lastVideoFramesSent.set(a.ssrc,{count:T,lts:w,rate:y})):B?y=B.rate:this.lastVideoFramesSent.set(a.ssrc,{count:T,lts:w,rate:0})}a.sentFrame={width:R,height:v,frameRate:Math.max(0,y)}}processVideoTrackReceiverStats(n,r,a){var d,l,p,E,f;const T=r?this.report.get(r):void 0,R=(d=T==null?void 0:T.framesReceived)!==null&&d!==void 0?d:n.framesReceived,v=(l=T==null?void 0:T.frameWidth)!==null&&l!==void 0?l:n.frameWidth,y=(p=T==null?void 0:T.frameHeight)!==null&&p!==void 0?p:n.frameHeight,w=(E=T==null?void 0:T.jitterBufferDelay)!==null&&E!==void 0?E:n.jitterBufferDelay,B=(f=T==null?void 0:T.jitterBufferEmittedCount)!==null&&f!==void 0?f:n.jitterBufferEmittedCount;if(typeof R=="number"){const k=this.lastVideoFramesRecv.get(a.ssrc),U=Date.now();a.framesReceivedCount=R;let G=0;k&&U-k.lts>=800?(G=Math.round((R-k.count)/((U-k.lts)/1e3)),this.lastVideoFramesRecv.set(a.ssrc,{count:R,lts:U,rate:G})):k?G=k.rate:this.lastVideoFramesRecv.set(a.ssrc,{count:R,lts:U,rate:0}),a.receivedFrame={width:v||0,height:y||0,frameRate:G||0},a.decodedFrame={width:v||0,height:y||0,frameRate:a.decodeFrameRate||0},a.outputFrame={width:v||0,height:y||0,frameRate:a.outputFrameRate||a.decodeFrameRate||0}}if(w&&B){const k=this.lastVideoJBDelay.get(a.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let U=k.jitterBufferMs;const G=B-k.jitterBufferEmittedCount;G>0&&(U=1e3*(w-k.jitterBufferDelay)/G),a.jitterBufferMs=U,a.currentDelayMs=Math.round(U),this.lastVideoJBDelay.set(a.ssrc,{jitterBufferDelay:w,jitterBufferEmittedCount:B,jitterBufferMs:a.currentDelayMs})}}processAudioTrackSenderStats(n,r,a){var d,l,p,E;const f=r?this.report.get(r):void 0,T=(d=(l=f==null?void 0:f.echoReturnLoss)!==null&&l!==void 0?l:n.echoReturnLoss)!==null&&d!==void 0?d:0,R=(p=(E=f==null?void 0:f.echoReturnLossEnhancement)!==null&&E!==void 0?E:n.echoReturnLossEnhancement)!==null&&p!==void 0?p:0;a.aecReturnLoss=T,a.aecReturnLossEnhancement=R}processAudioTrackReceiverStats(n,r,a){var d,l,p,E,f,T,R;const v=r?this.report.get(r):void 0,y=(d=v==null?void 0:v.removedSamplesForAcceleration)!==null&&d!==void 0?d:n.removedSamplesForAcceleration,w=(l=v==null?void 0:v.totalSamplesReceived)!==null&&l!==void 0?l:n.totalSamplesReceived,B=(p=v==null?void 0:v.jitterBufferDelay)!==null&&p!==void 0?p:n.jitterBufferDelay,k=(E=v==null?void 0:v.jitterBufferEmittedCount)!==null&&E!==void 0?E:n.jitterBufferEmittedCount,U=(f=v==null?void 0:v.audioLevel)!==null&&f!==void 0?f:n==null?void 0:n.audioLevel,G=(T=v==null?void 0:v.totalSamplesDuration)!==null&&T!==void 0?T:n==null?void 0:n.totalSamplesDuration,W=(R=v==null?void 0:v.concealedSamples)!==null&&R!==void 0?R:n.concealedSamples;if(y&&w&&(a.accelerateRate=y/w),B&&k){const rt=this.lastAudioJBDelay.get(a.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let ot=rt.jitterBufferMs;const Et=k-rt.jitterBufferEmittedCount;Et>0&&(ot=1e3*(B-rt.jitterBufferDelay)/Et),a.jitterBufferMs=Math.round(ot),this.lastAudioJBDelay.set(a.ssrc,{jitterBufferDelay:B,jitterBufferEmittedCount:k,jitterBufferMs:a.jitterBufferMs})}a.outputLevel=U;let $=1920;G&&w&&($=w/G/50,a.receivedFrames=Math.round(w/$)),W&&(a.droppedFrames=Math.round(W/$))}processRemoteInboundStats(n,r){const a=this.report.get(n);a&&(r.packetsLost=a.packetsLost,a.roundTripTime&&(r.rttMs=1e3*a.roundTripTime),a.jitter&&(r.jitterMs=1e3*a.jitter),a.timestamp&&(r.timestamp=a.timestamp))}getCodecFromCodecStats(n){const r=this.report.get(n);if(!r)return"";const a=r.mimeType.match(/\/(.*)$/);return a&&a[1]?a[1]:""}updateSendBitrate(){let n=0,r=null,a=null;this.mediaBytesSent.forEach(l=>{n+=l.diffMean()}),this.mediaBytesRetransmit.forEach(l=>{r=r===null?l.diffMean():r+l.diffMean()}),this.mediaBytesTargetEncode.forEach(l=>{a=a===null?l.diffMean():a+l.diffMean()});const d=r!==null?n-r:n;this._stats.bitrate={actualEncoded:8*d/(this.options.updateInterval/1e3),transmit:8*n/(this.options.updateInterval/1e3)},r!==null&&(this._stats.bitrate.retransmit=8*r/(this.options.updateInterval/1e3)),a!==null&&(this._stats.bitrate.targetEncoded=8*a/(this.options.updateInterval/1e3))}}class h1 extends wi{updateStats(){return Bt.resolve()}}function bE(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,d=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const l=function(){const p=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return p&&p[0]?Number(p[0].split("/")[1]):null}();return l?l<76?new u1(t,{updateInterval:n,lossRateInterval:r,freezeRateLimit:a,firstVideoDecodedTimeout:d}):new l1(t,{updateInterval:n,lossRateInterval:r,freezeRateLimit:a,firstVideoDecodedTimeout:d}):function(p){if(!window.RTCStatsReport)return!1;const E=p.getStats();return!!(E instanceof Bt||function(f){return!!f&&(typeof f=="object"||typeof f=="function")&&typeof f.then=="function"}(E))}(t)?new l1(t,{updateInterval:n,lossRateInterval:r,freezeRateLimit:a,firstVideoDecodedTimeout:d}):new h1(t,{updateInterval:n,lossRateInterval:r,freezeRateLimit:a,firstVideoDecodedTimeout:d})}let us=class{get localCapabilities(){return xi(this._localCapabilities)}get rtpCapabilities(){return xi(this._rtpCapabilities)}get candidates(){return xi(this._candidates)}get iceParameters(){return xi(this._iceParameters)}get dtlsParameters(){return xi(this._dtlsParameters)}constructor(t){F(this,"sessionDesc",void 0),F(this,"_localCapabilities",void 0),F(this,"_rtpCapabilities",void 0),F(this,"_candidates",void 0),F(this,"_iceParameters",void 0),F(this,"_dtlsParameters",void 0),F(this,"setup",void 0),F(this,"currentMidIndex",void 0),F(this,"cname","o/i14u9pJrxRKAsu"),F(this,"firefoxSsrcMidMap",new Map),t=xi(t);const{remoteIceParameters:n,remoteDtlsParameters:r,candidates:a,remoteRTPCapabilities:d,localCapabilities:l,direction:p,setup:E,videoCodec:f,audioCodec:T}=t;let R;this.setup=E,R=p===Os.RECEIVE_ONLY?Qr.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Qr.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=d,this._candidates=a,this._iceParameters=n,this._dtlsParameters=r,this._localCapabilities=l;const v=p===Os.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,y=p===Os.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,w=p===Os.RECEIVE_ONLY?d.send.videoCodecs:vE(Kt.VIDEO,v,y,f),B=p===Os.RECEIVE_ONLY?d.send.audioCodecs:vE(Kt.AUDIO,v,y,T);for(const k of R.mediaDescriptions)k.attributes.iceUfrag=n.iceUfrag,k.attributes.icePwd=n.icePwd,k.attributes.fingerprints=r.fingerprints,k.attributes.candidates=a,k.attributes.setup=this.setup,k.media.mediaType==="application"&&(k.attributes.sctpPort="5000"),k.media.mediaType==="video"&&(k.media.fmts=w.map(U=>U.payloadType.toString(10)),k.attributes.payloads=w,k.attributes.extmaps=v.videoExtensions),k.media.mediaType==="audio"&&(k.media.fmts=B.map(U=>U.payloadType.toString(10)),k.attributes.payloads=B,k.attributes.extmaps=v.audioExtensions,Ju(k));this.sessionDesc=R,this.currentMidIndex=R.mediaDescriptions.length-1}toString(){return Qr.print(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(n=>this.hasMid(n)):this.sessionDesc.mediaDescriptions.some(n=>n.attributes.mid===t)}send(t,n,r,a,d){r=r.replace(/ /g,"-");const{ssrcs:l,ssrcGroups:p}=Jl(n,this.cname,J("SYNC_GROUP")?r:void 0),E=this.findPreloadMediaDesc(l);if(E){if(Ii()&&this.firefoxSsrcMidMap.set(l[0].ssrcId,E.attributes.mid),d&&(d.twcc||d.remb)){const f=this.sessionDesc.mediaDescriptions.indexOf(E);return this.sessionDesc.mediaDescriptions[f]=this.mungSendMediaDesc(E,d),{mid:E.attributes.mid,needExchangeSDP:!0}}return{mid:E.attributes.mid,needExchangeSDP:!1}}{const f=this.findAvailableMediaIndex(t,l,a);let T;return f===-1?(T=this.createOrRecycleSendMedia(t,l,p,"sendonly",a,d),this.updateBundleMids()):(T=xi(this.sessionDesc.mediaDescriptions[f]),T.attributes.direction="sendonly",T.attributes.ssrcs=l,T.attributes.ssrcGroups=p,this.sessionDesc.mediaDescriptions[f]=this.mungSendMediaDesc(T,d)),Ii()&&this.firefoxSsrcMidMap.set(l[0].ssrcId,T.attributes.mid),{needExchangeSDP:!0,mid:T.attributes.mid}}}stopSending(t){const n=this.sessionDesc.mediaDescriptions.filter(r=>r.attributes.mid&&t.indexOf(r.attributes.mid)!==-1);if(n.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");n.forEach(r=>{r.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,n,r){const a=[];return t.forEach(d=>{const l=d._mediaStreamTrack.kind,p=this.findAvailableRecvMediaIndex(l);let E,f=!1;p===-1?(f=!0,E=this.createOrRecycleRecvMedia(d,[],"recvonly",n,r),this.updateBundleMids()):(E=xi(this.sessionDesc.mediaDescriptions[p]),E.attributes.direction="recvonly"),a.push({mid:E.attributes.mid,needCreateTransceiver:f})}),a}stopReceiving(t){const n=this.sessionDesc.mediaDescriptions.filter(r=>t.indexOf(r.attributes.mid)!==-1);if(n.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");n.forEach(r=>{r.media.port="0",r.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){const{foundation:n,protocol:r,address:a,port:d,type:l,relatedAddress:p,relatedPort:E,priority:f}=new RTCIceCandidate(t),T={foundation:n??"",componentId:"1",transport:r??"",priority:f?f+"":"",connectionAddress:a??"",port:d?d+"":"",type:l?l+"":"",relAddr:p??"",relPort:E?E+"":"",extension:{}};this.candidates.some(R=>R.priority===T.priority&&R.connectionAddress===T.connectionAddress&&R.port===T.port)||(this._candidates.push(T),this.sessionDesc.mediaDescriptions.forEach(R=>{R.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,n,r,a,d){const l=t._mediaStreamTrack.kind,p=this.rtpCapabilities.recv,E=vE(l,p,this.localCapabilities.send,l===Kt.AUDIO?d:a),f=l===Kt.VIDEO?p.videoExtensions:p.audioExtensions,T="".concat(++this.currentMidIndex);let R={media:{mediaType:l,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:E.map(y=>y.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:f,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:E,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(T)}};R=this.mungRecvMediaDsec(R,t);const v=this.findFirstClosedMedia(l);if(v){const y=this.sessionDesc.mediaDescriptions.indexOf(v);this.sessionDesc.mediaDescriptions[y]=R}else this.sessionDesc.mediaDescriptions.push(R);return R}muteRemote(t){const n=this.sessionDesc.mediaDescriptions.filter(r=>Mt(t).call(t,r.attributes.mid||""));if(n.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(r=>{r.attributes.direction="inactive"})}unmuteRemote(t){const n=this.sessionDesc.mediaDescriptions.filter(r=>Mt(t).call(t,r.attributes.mid||""));if(n.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(r=>{r.attributes.direction="recvonly"})}findAvailableMediaIndex(t,n,r){return this.sessionDesc.mediaDescriptions.findIndex(a=>{const d=a.media.mediaType===t&&a.media.port!=="0"&&(a.attributes.direction==="sendonly"||a.attributes.direction==="sendrecv")&&a.attributes.ssrcs.length===0;if(Ii()){if(d){const l=this.firefoxSsrcMidMap.get(n[0].ssrcId);return!(l||a.attributes.mid!=="0"&&a.attributes.mid!=="1")||!(!l||l!==a.attributes.mid)}return!1}return d&&a.attributes.mid===r})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const r=n.media.mediaType===t&&n.media.port!=="0"&&(n.attributes.direction==="recvonly"||n.attributes.direction==="sendrecv");return n.attributes.mid!=="0"&&n.attributes.mid!=="1"&&r})}predictReceivingMids(t){const n=[];for(let r=0;r<t;r++)n.push((this.currentMidIndex+r+1).toString(10));return n}restartICE(t){t=xi(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=t.iceUfrag,n.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,n,r,a,d,l){const p=this.rtpCapabilities.send,E=t===Kt.VIDEO?p.videoCodecs:p.audioCodecs,f=t===Kt.VIDEO?p.videoExtensions:p.audioExtensions;Ii()&&(d="".concat(++this.currentMidIndex));let T={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:E.map(v=>v.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:f,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:r,rtcpFeedbackWildcards:[],payloads:E,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:a,rtcpMux:!0,rtcpRsize:!0,mid:d}};T=this.mungSendMediaDesc(T,l);const R=this.findFirstClosedMedia(t);if(R){const v=this.sessionDesc.mediaDescriptions.indexOf(R);this.sessionDesc.mediaDescriptions[v]=T}else this.sessionDesc.mediaDescriptions.push(T);return T}mungRecvMediaDsec(t,n,r){const a=xi(t);return pC(a),Up(a,n),Ig(a,n),zw(a),_C(a,r,this.localCapabilities.send),a}mungSendMediaDesc(t,n){const r=xi(t);return _C(r,n,this.localCapabilities.recv),Ju(r),r}updateRecvMedia(t,n){const r=this.sessionDesc.mediaDescriptions.findIndex(a=>a.attributes.mid===t);if(r!==-1){const a=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],n);this.sessionDesc.mediaDescriptions[r]=a}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(n=>{var r;return((r=n.attributes)===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(n=>Ii()?n.media.port==="0"&&n.media.mediaType===t:n.media.port==="0")}};const Co=["sdp"];var Xn;function Pg(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Oi(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Pg(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Pg(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let qo=(Xn=class HC extends Lb{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var n,r;return(n=(r=this.peerConnection.getReceivers()[0])===null||r===void 0||(r=r.transport)===null||r===void 0?void 0:r.state)!==null&&n!==void 0?n:null}get localCodecs(){return[]}set isInRestartIce(n){this._isInRestartIce=n}get isInRestartIce(){return this._isInRestartIce}constructor(n,r,a){super(n,r),F(this,"direction",void 0),F(this,"name",void 0),F(this,"store",void 0),F(this,"spec",void 0),F(this,"peerConnection",void 0),F(this,"initialOffer",void 0),F(this,"transport",void 0),F(this,"statsFilter",void 0),F(this,"localCandidateCount",0),F(this,"_isInRestartIce",!1),F(this,"mutex",void 0),F(this,"onLocalCandidate",void 0),F(this,"remoteSDP",void 0),F(this,"pendingCandidates",[]),F(this,"localCapabilities",void 0),F(this,"isReady",!1),F(this,"restartCnt",0),F(this,"curTurnServerIndex",0),this.store=r,this.spec=n,this.mutex=new Yr("P2PConnection-mutex",r.clientId),this.peerConnection=new RTCPeerConnection(HC.resolvePCConfiguration(n,r.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=a??Os.SEND_ONLY,this.name=this.direction===Os.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=bE(this.peerConnection,J("STATS_UPDATE_INTERVAL"),void 0,Ii()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(n){try{const r=await Jw();if(this.localCapabilities=EC(r),n){const{sdp:a}=n,d=c1(n,Co),l=function(){const R={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},v=ya(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),y={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},w={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},B={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(cc(v,R,"videoExtensions",y,w,B),cc(v,R,"videoCodecs",y,w,B),cc(v,R,"audioExtensions",y,w,B),cc(v,R,"audioCodecs",y,w,B),J("RAISE_H264_BASELINE_PRIORITY")){const k=B.videoCodecs.findIndex(U=>U.rtpMap&&U.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&U.fmtp&&U.fmtp.parameters["profile-level-id"]==="42001f");if(k!==-1){const U=B.videoCodecs.findIndex(G=>G.rtpMap&&G.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(U<k){N.debug("raising H264 baseline profile priority");const G=B.videoCodecs[k];B.videoCodecs.splice(k,1),B.videoCodecs.splice(U,0,G)}U!==-1&&J("FILTER_SEND_H264_BASELINE")&&(y.videoCodecs=y.videoCodecs.filter(G=>!(G.rtpMap&&G.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&G.fmtp&&G.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:y,recv:w,sendrecv:B}}({},{},a);this.remoteSDP=new us({remoteIceParameters:d.iceParameters,remoteDtlsParameters:d.dtlsParameters,candidates:[],remoteRTPCapabilities:l,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const p=await this.peerConnection.createAnswer();if(!p.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const E=xc(p.sdp);await this.peerConnection.setLocalDescription(p);const f=await Xl({},{},p.sdp);this.localCapabilities=EC(f);const T=this.peerConnection.getTransceivers()[0];return T!=null&&T.receiver&&T.receiver.transport&&this.tryBindTransportEvents(T.receiver.transport),Oi(Oi({},E),{},{sdp:p.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const a=await this.peerConnection.createOffer();if(!a.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const d=xc(a.sdp);return this.initialOffer=a,Oi(Oi({},d),{},{sdp:a.sdp})}}catch(r){throw new _t(H.GET_LOCAL_CONNECTION_PARAMS_FAILED,r.toString())}}async connect(n){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:r,iceParameters:a,dtlsParameters:d}=n,l=await Xl({},{},r);this.remoteSDP=new us({remoteIceParameters:a,remoteDtlsParameters:d,candidates:[],remoteRTPCapabilities:l,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const p=this.peerConnection.getTransceivers()[0];p!=null&&p.sender&&p.sender.transport&&this.tryBindTransportEvents(p.sender.transport)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(r.toString()))}}async addRemoteCandidate(n){try{n&&this.pendingCandidates.push(n),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(r=>{this.peerConnection.addIceCandidate(r)}),this.pendingCandidates=[])}catch(r){throw new _t(H.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(r.toString()))}}send(n,r,a){var d=this;return oa(function*(){const l=yield Ae(d.mutex.lock("From P2PConnection.send"));try{if(!d.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const p=[],E=d.remoteSDP.receive(n,r,a);n.forEach((U,G)=>{if(E[G].needCreateTransceiver){const W=d.peerConnection.addTransceiver(U._mediaStreamTrack,{direction:"sendonly"});p.push(W),U._updateRtpTransceiver(W)}else{const W=d.peerConnection.getTransceivers().find($=>$.mid===E[G].mid);if(!W)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(E[G].mid));p.push(W),U._updateRtpTransceiver(W)}}),Ii()&&J("SIMULCAST")===!0&&(yield Ae(d.applySimulcastForFirefox(p,n)));const f=E.map(U=>U.mid),T=yield Ae(d.peerConnection.createOffer()),R=d.mungSendOfferSDP(T.sdp,n,f),v=Qr.parse(R),y=f.map(U=>{const G=v.mediaDescriptions.find(W=>W.attributes.mid===U);if(!G)throw new Error("Cannot extract ssrc from mediaDescription.");return Kw(G,J("USE_PUB_RTX"))}),w=p.map((U,G)=>{const W=f[G];return{localSSRC:y[G],id:W}});yield Ae(d.peerConnection.setLocalDescription({type:"offer",sdp:R}));try{yield w}catch(U){const G=d.remoteSDP.toString();throw yield Ae(d.peerConnection.setLocalDescription({type:"offer",sdp:R})),yield Ae(d.peerConnection.setRemoteDescription({type:"answer",sdp:G})),yield Ae(d.stopSending(f,!0)),U}yield Ae(d.applySimulcastEncodings(p,n)),yield Ae(d.applySendEncodings(p,n));const B=d.remoteSDP.toString(),k=d.logSDPExchange(R,"offer","local","send");return k==null||k(B),yield Ae(d.setRemoteDescription({type:"answer",sdp:B})),p.map((U,G)=>{const W=f[G];return{localSSRC:y[G],id:W}})}catch(p){throw p instanceof _t?p:new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(p.toString()))}finally{l()}})()}async stopSending(n,r){const a=r?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const d=this.peerConnection.getTransceivers().filter(f=>n.indexOf(f.mid)!==-1);if(d.length!==n.length)throw new Error("Transceivers' length (".concat(d.length,") doesn't match mids' length (").concat(n.length,") when trying to call P2PConnection.stopSending."));d.map(f=>{var T;f.direction="inactive",(T=f.stop)===null||T===void 0||T.call(f)});const l=await this.peerConnection.createOffer(),p=this.logSDPExchange(l.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(l),this.remoteSDP.stopReceiving(n);const E=this.remoteSDP.toString();p==null||p(E),await this.setRemoteDescription({type:"answer",sdp:E})}catch(d){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(d.toString()))}finally{a&&a()}}async receive(n,r,a,d){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(n," before remoteSDP created."));const{mid:l,needExchangeSDP:p}=this.remoteSDP.send(n,r,a,d);if(p){const f=this.remoteSDP.toString(),T=this.logSDPExchange(f,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:f});const R=await this.peerConnection.createAnswer(),v=this.mungReceiveAnswerSDP(R.sdp,l,n);T==null||T(v||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:v}),N.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(n," by exchanging SDP."))}else N.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(n," no need to exchange SDP."));const E=this.peerConnection.getTransceivers().find(f=>f.mid===l);if(!E||E.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:E.receiver.track,mid:E.mid,transceiver:E}}catch(l){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(l.toString()))}}async mockReceive(n,r,a,d){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(n," before remoteSDP created."));const{mid:l,needExchangeSDP:p}=this.remoteSDP.send(n,r,a,d);if(p){const E=this.remoteSDP.toString(),f=this.logSDPExchange(E,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:E});const T=await this.peerConnection.createAnswer(),R=this.mungReceiveAnswerSDP(T.sdp,l,n);f==null||f(R||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:R}),N.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(n," by exchanging SDP."))}else N.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(n," no need to exchange SDP."))}catch(l){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(l.toString()))}}async stopReceiving(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(n);const r=this.remoteSDP.toString(),a=this.logSDPExchange(r,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:r});const d=await this.peerConnection.createAnswer();a==null||a(d.sdp||""),await this.peerConnection.setLocalDescription(d)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}}async restartICE(n){try{if(this.store.p2pTransport===la.Auto&&(this.store.p2pTransport=la.SdRtn,nn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(HC.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,nn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(HC.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!n){this.restartCnt++,this.isReady=!1;const r=await this.peerConnection.createOffer({iceRestart:!0});if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:a}=xc(r.sdp);return this.store.descriptionStart(),this.direction===Os.SEND_ONLY&&await this.peerConnection.setLocalDescription(r),a}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(n),this.store.descriptionStart(),this.direction===Os.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const r=await this.peerConnection.createAnswer();if(!r.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:a}=xc(r.sdp);return await this.peerConnection.setLocalDescription(r),a}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}}close(){var n;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(n){return this.statsFilter.getVideoIsReady(n)}async updateEncoderConfig(n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const a=await this.peerConnection.createOffer(),d=this.mungSendOfferSDP(a.sdp,[r],[n]);this.remoteSDP.updateRecvMedia(n,r);const l=this.remoteSDP.toString(),p=this.logSDPExchange(d,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),p==null||p(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(a){throw new _t(H.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(n,r){const a=this.peerConnection.getTransceivers().filter(d=>d.mid===n);a.length===1&&(this.isVP8Simulcast(r)?Ii()||await this.applySimulcastEncodings(a,[r]):await this.applySendEncodings(a,[r]))}setStatsRemoteVideoIsReady(n,r){this.statsFilter.setVideoIsReady2(n,r)}async replaceTrack(n,r){const a=this.peerConnection.getTransceivers().find(d=>d.mid===r);a&&await a.sender.replaceTrack(n._mediaStreamTrack)}async getSelectedCandidatePair(){const n=this.peerConnection.getReceivers();if(n.length>0&&n[0].transport&&n[0].transport.iceTransport&&n[0].transport.iceTransport.getSelectedCandidatePair&&n[0].transport.iceTransport.getSelectedCandidatePair()){const r=n[0].transport.iceTransport,{local:a,remote:d}=r.getSelectedCandidatePair();return{local:Oi(Oi({},bi),{},{candidateType:a.type,protocol:a.protocol,address:a.address,port:a.port}),remote:Oi(Oi({},bi),{},{candidateType:d.type,protocol:d.protocol,address:d.address,port:d.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var n,r;Mt(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(r=this.onICEConnectionStateChange)===null||r===void 0||r.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var n;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=n=>{if(n.candidate){var r;n.candidate.candidate&&((r=this.onLocalCandidate)===null||r===void 0||r.call(this,n.candidate.toJSON())),this.localCandidateCount+=1}else N.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(n,r){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const d={iceServers:[]};var l;return n.iceServers?d.iceServers=n.iceServers:n.turnServer&&n.turnServer.mode!=="off"&&(TR(n.turnServer.servers)?d.iceServers=n.turnServer.servers:(d.iceServers&&d.iceServers.push(...HC.turnServerConfigToIceServers(n.turnServer.servers,r,a)),J("USE_TURN_SERVER_OF_GATEWAY")&&d.iceServers&&n.turnServer.serversFromGateway&&d.iceServers.push(...HC.turnServerConfigToIceServers(n.turnServer.serversFromGateway,r,a)),Mt(l=[la.Relay,la.SdRtn]).call(l,r)&&(d.iceTransportPolicy="relay"),J("FORCE_TURN_TCP")?d.iceTransportPolicy="relay":n.turnServer.servers.concat(n.turnServer.serversFromGateway||[]).forEach(p=>{p.forceturn&&(d.iceTransportPolicy="relay")}))),J("ENABLE_ENCODED_TRANSFORM")&&nn().supportWebRTCEncodedTransform&&(d.encodedInsertableStreams=!0),N.debug("P2PConnection p2pTransport is ".concat(r)),d}static turnServerConfigToIceServers(n,r){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const d=[],l=n.filter(E=>E.tcpport);N.debug("P2PConnection turnServers is ".concat(l,", current index is ").concat(a));const p=l.length>a?l[a]:l[0];switch(r){case la.SdRtn:const E=n.filter(T=>{var R;return Mt(R=T.username).call(R,"glb:")&&T.turnServerURL==T.turnServerURL}),f=E.length>a?E[a]:E[0];f&&(d.push({username:f.username,credential:f.password,credentialType:"password",urls:"turn:".concat(eE(f.turnServerURL),":").concat(f.tcpport,"?transport=udp")}),d.push({username:f.username,credential:f.password,credentialType:"password",urls:"turns:".concat(eE(f.turnServerURL),":").concat(f.tcpport,"?transport=tcp")}));break;case la.Relay:p&&(d.push({username:p.username,credential:p.password,credentialType:"password",urls:"turn:".concat(p.turnServerURL,":").concat(p.tcpport,"?transport=udp")}),d.push({username:p.username,credential:p.password,credentialType:"password",urls:"turns:".concat(eE(p.turnServerURL),":").concat(p.tcpport,"?transport=tcp")}));break;default:p&&(d.push({username:p.username,credential:p.password,credentialType:"password",urls:"turn:".concat(p.turnServerURL,":").concat(p.tcpport,"?transport=udp")}),d.push({username:p.username,credential:p.password,credentialType:"password",urls:"turns:".concat(eE(p.turnServerURL),":").concat(p.tcpport,"?transport=tcp")}),d.push({username:p.username,credential:p.password,credentialType:"password",urls:"stun:".concat(p.turnServerURL,":").concat(p.tcpport)}))}return d}tryBindTransportEvents(n){if(n){this.transport=n,n.onstatechange=()=>{var a;n!=null&&n.state&&((a=this.onDTLSTransportStateChange)===null||a===void 0||a.call(this,n.state))},n.onerror=a=>{var d;(d=this.onDTLSTransportError)===null||d===void 0||d.call(this,"error"in a?a.error:a)};const r=n.iceTransport;r&&(r.onstatechange=()=>{const a=n==null?void 0:n.iceTransport.state;var d;a&&((d=this.onICETransportStateChange)===null||d===void 0||d.call(this,a))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:a,remote:d}=r.getSelectedCandidatePair();N.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:a.type,protocol:a.protocol}),", remote ").concat(JSON.stringify({candidateType:d.type,protocol:d.protocol,address:d.address,port:d.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(n,r){var a;if(r||(r=this.peerConnection.getSenders().find(R=>R.track===n._mediaStreamTrack)),!r)return N.warn("[".concat(n.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(n))return N.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!nn().supportSetRtpSenderParameters)return N.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const d={},l={};switch(n._optimizationMode){case"motion":d.degradationPreference="maintain-framerate";break;case"detail":d.degradationPreference="maintain-resolution";break;default:d.degradationPreference="balanced"}if(n._encoderConfig){var p;const{bitrateMax:R,frameRate:v,scaleResolutionDownBy:y}=n._encoderConfig;R&&(l.maxBitrate=1e3*R),Mt(p=n._hints).call(p,vn.LOW_STREAM)&&(v&&(l.maxFramerate=Fo(v)),y&&y>=1&&(l.scaleResolutionDownBy=y))}if(J("DSCP_TYPE")&&Il()){var E;const R=J("DSCP_TYPE");Mt(E=["very-low","low","medium","high"]).call(E,R)&&(l.networkPriority=R)}const f=r.getParameters(),T=(a=f.encodings)===null||a===void 0?void 0:a[0];Ii()&&!T&&(d.encodings=[l]),T&&Object.assign(T,l),Object.assign(f,d),N.debug("[".concat(n.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(f.encodings))),await r.setParameters(f)}async applySendEncodings(n,r){try{if(!nn().supportSetRtpSenderParameters||n.length!==r.length)return;for(let a=0;a<n.length;a++){const d=n[a],l=r[a];l instanceof qn&&!this.isVP8Simulcast(l)&&await this.updateRtpSenderEncodings(l,d.sender)}}catch{N.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(n,r,a){const d=Qr.parse(n);return r.forEach((l,p)=>{const E=a[p],f=d.mediaDescriptions.find(T=>T.attributes.mid===E);f&&(Up(f,l),e1(f,l,this.store.codec))}),Qr.print(d)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=n=>{var r;(r=this.onFirstAudioReceived)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstVideoReceived=n=>{var r;(r=this.onFirstVideoReceived)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstAudioDecoded=n=>{var r;(r=this.onFirstAudioDecoded)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstVideoDecoded=(n,r,a)=>{var d;(d=this.onFirstVideoDecoded)===null||d===void 0||d.call(this,n,r,a)},this.statsFilter.onSelectedLocalCandidateChanged=(n,r)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,n,r)},this.statsFilter.onSelectedRemoteCandidateChanged=(n,r)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,n,r)},this.statsFilter.onFirstVideoDecodedTimeout=n=>{var r;(r=this.onFirstVideoDecodedTimeout)===null||r===void 0||r.call(this,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(n,r){if(n.length===r.length)for(let f=0;f<n.length;f++){var a,d,l,p,E;const T=n[f],R=r[f];if(R instanceof qn&&!Mt(a=R._hints).call(a,vn.LOW_STREAM)&&(d=R._encoderConfig)!==null&&d!==void 0&&d.bitrateMax&&((l=R._encoderConfig)===null||l===void 0?void 0:l.bitrateMax)>200&&(p=R._scalabilityMode)!==null&&p!==void 0&&p.numSpatialLayers&&((E=R._scalabilityMode)===null||E===void 0?void 0:E.numSpatialLayers)>1&&this.store.codec==="vp8"){const v={},y={high:1e3*(R._encoderConfig.bitrateMax-50),medium:5e4};v.encodings=[{rid:"m",active:!0,maxBitrate:y.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:y.high}];const w=T.sender.getParameters();await T.sender.setParameters(Object.assign(w,v))}}}async applySimulcastEncodings(n,r){if(!Ii()&&n.length===r.length)for(let a=0;a<n.length;a++){const d=r[a];if(d instanceof qn&&this.isVP8Simulcast(d)){const l=n[a],p={},E={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:E.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:E.medium,scaleResolutionDownBy:4}];const f=l.sender.getParameters();await l.sender.setParameters(Object.assign(f,p))}}}isVP8Simulcast(n){var r,a,d,l,p;return!!(n instanceof qn&&J("SIMULCAST")&&this.store.codec==="vp8"&&!Mt(r=n._hints).call(r,vn.LOW_STREAM)&&(a=n._encoderConfig)!==null&&a!==void 0&&a.bitrateMax&&((d=n._encoderConfig)===null||d===void 0?void 0:d.bitrateMax)>200&&(l=n._scalabilityMode)!==null&&l!==void 0&&l.numSpatialLayers&&((p=n._scalabilityMode)===null||p===void 0?void 0:p.numSpatialLayers)>1)}logSDPExchange(n,r,a,d){if(J("SDP_LOGGING"))return N.upload("[".concat(this.store.clientId,"] exchanging ").concat(a," ").concat(r," SDP during P2PConnection.").concat(d,`
`),n),r==="offer"?l=>{this.logSDPExchange(l,"answer",a==="local"?"remote":"local",d)}:void 0}async muteLocal(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const r=this.peerConnection.getTransceivers().filter(p=>p.mid&&n.indexOf(p.mid)!==-1);if(r.length!==n.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(p=>{p.direction="inactive"});const a=await this.peerConnection.createOffer(),d=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.muteRemote(n);const l=this.remoteSDP.toString();d==null||d(l),await this.setRemoteDescription({type:"answer",sdp:l})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(r.toString()))}}async unmuteLocal(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const r=this.peerConnection.getTransceivers().filter(p=>p.mid&&n.indexOf(p.mid)!==-1);if(r.length!==n.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(async p=>{p.direction="sendonly"});const a=await this.peerConnection.createOffer(),d=this.logSDPExchange(a.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.unmuteRemote(n);const l=this.remoteSDP.toString();d==null||d(l),await this.setRemoteDescription({type:"answer",sdp:l})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(r.toString()))}}async getRemoteSSRC(n,r){var a,d;if(r=(a=r)!==null&&a!==void 0?a:(d=this.currentRemoteDescription)===null||d===void 0?void 0:d.sdp){var l;const p=(l=Qr.parse(r).mediaDescriptions.find(E=>E.attributes.mid===n))===null||l===void 0?void 0:l.attributes.ssrcs;return p==null?void 0:p[0].ssrcId}}async setRemoteDescription(n){var r;await this.peerConnection.setRemoteDescription(n),Mt(r=["connected","completed"]).call(r,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(n,r,a){const d=Qr.parse(n),l=d.mediaDescriptions.find(p=>p.attributes.mid===r);return l&&a===Kt.AUDIO&&l.media.mediaType==="audio"&&Ju(l),Qr.print(d)}},jt(Xn.prototype,"establish",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"establish"),Xn.prototype),jt(Xn.prototype,"connect",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"connect"),Xn.prototype),jt(Xn.prototype,"receive",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"receive"),Xn.prototype),jt(Xn.prototype,"mockReceive",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"mockReceive"),Xn.prototype),jt(Xn.prototype,"stopReceiving",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"stopReceiving"),Xn.prototype),jt(Xn.prototype,"restartICE",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"restartICE"),Xn.prototype),jt(Xn.prototype,"close",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"close"),Xn.prototype),jt(Xn.prototype,"updateEncoderConfig",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"updateEncoderConfig"),Xn.prototype),jt(Xn.prototype,"updateSendParameters",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"updateSendParameters"),Xn.prototype),jt(Xn.prototype,"replaceTrack",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"replaceTrack"),Xn.prototype),jt(Xn.prototype,"muteLocal",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"muteLocal"),Xn.prototype),jt(Xn.prototype,"unmuteLocal",[pc],Object.getOwnPropertyDescriptor(Xn.prototype,"unmuteLocal"),Xn.prototype),Xn);function pc(t,n,r){const a=t[n];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const d=this.mutex,l=await d.lock("From P2PConnection.".concat(n));try{for(var p=arguments.length,E=new Array(p),f=0;f<p;f++)E[f]=arguments[f];return await a.apply(this,E)}finally{l()}},r}function cu(t,n){let r=document.createElement("video"),a=document.createElement("canvas");r.setAttribute("style","display:none"),a.setAttribute("style","display:none"),r.setAttribute("muted",""),r.muted=!0,r.setAttribute("autoplay",""),r.autoplay=!0,r.setAttribute("playsinline",""),a.width=Fo(n.width),a.height=Fo(n.height);const d=Fo(n.framerate||15);document.body.append(r),document.body.append(a);let l=t._mediaStreamTrack;r.srcObject=new MediaStream([l]),r.play();const p=a.getContext("2d");if(!p)throw new lt(H.UNEXPECTED_ERROR,"can not get canvas context");const E=nn(),f=a.captureStream(E.supportRequestFrame?0:d).getVideoTracks()[0];f.canvas||(f.canvas=a),a.startCapture=()=>{if(!r)return a.stopCapture&&a.stopCapture();if(r.paused&&r.play(),r.videoHeight>2&&r.videoWidth>2){const R=r.videoWidth,v=r.videoHeight/R,y=a.width*v;Math.abs(y-a.height)>=2&&(N.debug("adjust low stream resolution","".concat(a.width,"x").concat(a.height," -> ").concat(a.width,"x").concat(y)),a.height=y)}p.drawImage(r,0,0,a.width,a.height),f.requestFrame&&f.requestFrame(),l!==t._mediaStreamTrack&&(l=t._mediaStreamTrack,r.srcObject=new MediaStream([l]))},a.stopCapture=dg(()=>a.startCapture&&a.startCapture(),d);const T=f.stop;return f.stop=()=>{T.call(f),r&&(r.remove(),r.srcObject=null,r=null),a&&(a.width=0,a.remove(),a.stopCapture&&a.stopCapture(),a.startCapture=void 0,a.stopCapture=void 0,a=null),N.debug("clean low stream renderer")},f}var Lg=function(t){return t[t.HEIGHT=2033]="HEIGHT",t[t.FRAME_RATE=2034]="FRAME_RATE",t[t.WIDTH=2035]="WIDTH",t}(Lg||{}),Di=function(t){return t[t.FRAME_RATE=2002]="FRAME_RATE",t[t.WIDTH=2003]="WIDTH",t[t.HEIGHT=2004]="HEIGHT",t[t.PACKAGE_LOST=2005]="PACKAGE_LOST",t[t.AVG_ENCODE=2007]="AVG_ENCODE",t[t.NACKS=2009]="NACKS",t[t.PLIS=2010]="PLIS",t[t.FIRS=2011]="FIRS",t[t.BITRATE=2012]="BITRATE",t[t.PACKAGE_RATE=2031]="PACKAGE_RATE",t[t.ADAPTATION=2032]="ADAPTATION",t[t.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",t[t.BANDWIDTH=2061]="BANDWIDTH",t[t.RETRANSMIT=2062]="RETRANSMIT",t[t.TARGET_ENCODED=2064]="TARGET_ENCODED",t[t.TRANSMIT=2066]="TRANSMIT",t[t.FREEZE=2082]="FREEZE",t[t.DISABLED=2095]="DISABLED",t[t.PLAYER_STATUS=2128]="PLAYER_STATUS",t[t.QP_SUM=2143]="QP_SUM",t[t.BYTES_RETRANSMIT=2173]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2172]="PACKAGES_RETRANSMIT",t[t.HUGE_FRAME_SENT=2174]="HUGE_FRAME_SENT",t[t.KEY_FRAMES_ENCODED=2207]="KEY_FRAMES_ENCODED",t}(Di||{}),Ki=function(t){return t[t.BITRATE=2069]="BITRATE",t[t.PACKAGE_LOST=2070]="PACKAGE_LOST",t[t.PACKAGE_RATE=2071]="PACKAGE_RATE",t[t.HEIGHT=2073]="HEIGHT",t[t.FRAME_RATE=2075]="FRAME_RATE",t[t.WIDTH=2077]="WIDTH",t}(Ki||{}),pn=function(t){return t[t.JITTER=-1]="JITTER",t[t.PACKAGE_LOST=2014]="PACKAGE_LOST",t[t.WIDTH=2018]="WIDTH",t[t.HEIGHT=2019]="HEIGHT",t[t.FRAME_RATE=2020]="FRAME_RATE",t[t.JITTER_BUFFER=2023]="JITTER_BUFFER",t[t.CURRENT_DELAY=2024]="CURRENT_DELAY",t[t.NACKS=2026]="NACKS",t[t.PLIS=2027]="PLIS",t[t.FIRS=2028]="FIRS",t[t.BITRATE=2029]="BITRATE",t[t.PACKAGE_RATE=2078]="PACKAGE_RATE",t[t.FREEZE=2084]="FREEZE",t[t.DISABLED=2101]="DISABLED",t[t.PLAYER_STATUS=2129]="PLAYER_STATUS",t[t.QP_SUM=2144]="QP_SUM",t[t.I_FRAME_DELAY=2149]="I_FRAME_DELAY",t[t.FRAMES_DROPPED=2181]="FRAMES_DROPPED",t[t.BYTES_RETRANSMIT=2175]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2176]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2198]="PACKAGES_DISCARDED",t[t.AVG_DECODE=2200]="AVG_DECODE",t[t.AVG_PROCESSING_DELAY=2202]="AVG_PROCESSING_DELAY",t[t.AVG_ASSEMBLY_TIME=2203]="AVG_ASSEMBLY_TIME",t[t.AVG_INTER_FRAME_DELAY=2204]="AVG_INTER_FRAME_DELAY",t[t.KEY_FRAMES_DECODED=2206]="KEY_FRAMES_DECODED",t}(pn||{}),Bp=function(t){return t[t.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",t[t.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",t[t.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",t[t.FREEZE_TIME=2109]="FREEZE_TIME",t[t.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",t[t.FREEZE_DURATION=2156]="FREEZE_DURATION",t}(Bp||{}),p1=function(t){return t[t.PCM_LEVEL=2104]="PCM_LEVEL",t}(p1||{}),Id=function(t){return t[t.PACKAGE_LOST=-1]="PACKAGE_LOST",t[t.LEVEL=2038]="LEVEL",t[t.BITRATE=2039]="BITRATE",t[t.PACKAGE_RATE=2040]="PACKAGE_RATE",t[t.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",t[t.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",t[t.FREEZE=2081]="FREEZE",t[t.DISABLED=2096]="DISABLED",t[t.BYTES_RETRANSMIT=2179]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2180]="PACKAGES_RETRANSMIT",t}(Id||{}),vo=function(t){return t[t.BITRATE=2044]="BITRATE",t[t.PACKAGE_LOST=2045]="PACKAGE_LOST",t[t.PACKAGE_RATE=2046]="PACKAGE_RATE",t[t.CURRENT_DELAY=2047]="CURRENT_DELAY",t[t.JITTER_BUFFER=2054]="JITTER_BUFFER",t[t.JITTER=2055]="JITTER",t[t.FREEZE=2083]="FREEZE",t[t.DISABLED=2102]="DISABLED",t[t.PCM_LEVEL=2105]="PCM_LEVEL",t[t.PLAYER_STATUS=2130]="PLAYER_STATUS",t[t.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",t[t.BYTES_RETRANSMIT=2178]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2177]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2199]="PACKAGES_DISCARDED",t[t.AVG_PROCESSING_DELAY=2201]="AVG_PROCESSING_DELAY",t}(vo||{}),_1=function(t){return t[t.FREEZE_TIME=-1]="FREEZE_TIME",t[t.LEVEL=2043]="LEVEL",t}(_1||{}),Io=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t}(Io||{});const yd=1e3,ls=3;function Ee(t,n,r){r!=null&&Number.isFinite(r)&&(t[n]=Math.round(Math.max(0,r)))}function dO(t){const n={[Io.CONN_TYPE]:0,[Io.RTT]:t.rtt,[Io.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const r=t.selectedCandidatePair.localCandidate.relayProtocol;r==="udp"&&(n[Io.CONN_TYPE]=1),r==="tcp"&&(n[Io.CONN_TYPE]=3),r==="tls"&&(n[Io.CONN_TYPE]=4);break}case"srflx":n[Io.CONN_TYPE]=2}return n}function uO(t){let n=0;switch(t){case"none":n=0;break;case"cpu":n=1;break;case"bandwidth":n=2;break;case"other":n=3}return n}class E1 extends An{constructor(n){super(),F(this,"store",void 0),F(this,"uploadWRTCStatsTimer",void 0),F(this,"uploadOutboundDenoiserStatsTimer",void 0),F(this,"uploadExtStatsTimer",void 0),F(this,"uploadExtUsageStatsTimer",void 0),F(this,"uploadInboundExtStatsTimer",void 0),F(this,"requestStats",void 0),F(this,"requestTransportStats",void 0),F(this,"requestLocalMedia",void 0),F(this,"requestRemoteMedia",void 0),F(this,"requestAllTracks",void 0),F(this,"requestVideoIsReady",void 0),F(this,"requestUploadStats",void 0),F(this,"requestUpload",void 0),F(this,"uploadOutboundStarted",!1),F(this,"uploadInboundStarted",!1),F(this,"uploadTransportStarted",!1),F(this,"uploadExtensionUsageStarted",!1),F(this,"lastRecvStats",void 0),F(this,"lastSendStats",void 0),F(this,"lastFullRecvStats",void 0),F(this,"lastFullSendStats",void 0),F(this,"needUploadRenderFreezeTime",!0),this.store=n}uploadWRTCStats(n){if(!this.requestStats||!this.requestUploadStats)return;let r,a;if(this.uploadTransportStarted&&(r=this.requestStats(),this.store.useP2P&&(a=this.requestStats(!0))),!r&&this.uploadOutboundStarted&&(r=this.requestStats()),!a&&this.uploadInboundStarted&&(a=this.requestStats(!0)),r||a){const d={};if(this.uploadTransportStarted&&r){const l=this.getTransportStats(r,a,n);l&&(d.misc=[l])}if(this.uploadOutboundStarted&&r){const l=this.getOutboundStats(r,n?this.lastSendStats:this.lastFullSendStats,n);l&&(d.outbound=[l])}if(this.uploadInboundStarted&&a){const l=this.getInboundStats(a,n?this.lastRecvStats:this.lastFullRecvStats,n);l&&(d.inbound=l)}this.requestUploadStats(d)}this.lastRecvStats=a,this.lastSendStats=r,n||(this.lastFullRecvStats=a,this.lastFullSendStats=r)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let n=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(n!==ls),++n===ls+1&&(n=1)},yd)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(n,r,a){if(!this.requestStats)return;if(a)return n.rtt==null?void 0:{addition:{[Io.RTT]:n.rtt,[Io.CONN_TYPE]:void 0,[Io.STATS_UPDATE_INTERVAL]:n.updateInterval||void 0}};const d=dO(n);if(this.store.useP2P){if(r){const l=dO(r);d[Io.CONN_TYPE]+=l[Io.CONN_TYPE]<<3}d[Io.CONN_TYPE]+=110}else d[Io.CONN_TYPE]+=100;return{addition:d}}getOutboundStats(n,r,a){if(!this.requestUploadStats||!this.requestLocalMedia)return;const d=this.requestLocalMedia();if(!d||d.length===0)return;let l,p,E;return d.forEach(f=>{let[T,{track:R,ssrcs:v}]=f;switch(T){case At.LocalVideoLowTrack:case At.LocalVideoTrack:if(T===At.LocalVideoTrack){const y=function(k,U,G,W,$){const rt=U.videoSend.find($t=>$t.ssrc===k);if(!rt)return;const ot={},{sentFrame:Et,inputFrame:vt}=rt;if(vt&&Et){const $t=vt.frameRate,Ye=Et.frameRate;ot[Di.FREEZE]=function(bn,ri){let mr=!0;return mr=!(bn<=5)&&(bn<=10?ri<3:bn<=20?ri<4:ri<5),mr}($t,Ye)?1:0}if(Ee(ot,Di.QP_SUM,rt.qpSumPerFrame),$)return ot;switch(Et&&(Ee(ot,Di.HEIGHT,Et.height),Ee(ot,Di.WIDTH,Et.width),Ee(ot,Di.FRAME_RATE,Et.frameRate)),ot[Di.DISABLED]=W._originMediaStreamTrack&&!W._originMediaStreamTrack.enabled||W._mediaStreamTrack&&!W._mediaStreamTrack.enabled?1:0,rt.adaptionChangeReason){case"none":ot[Di.ADAPTATION]=0;break;case"cpu":ot[Di.ADAPTATION]=1;break;case"bandwidth":ot[Di.ADAPTATION]=2;break;case"other":ot[Di.ADAPTATION]=3}let Lt=0;rt.adaptionChangeReason&&(Lt+=uO(rt.adaptionChangeReason)),U.qualityLimitationReason&&(Lt+=uO(U.qualityLimitationReason)<<3),ot[Di.ADAPTATION]=Lt,ot[Di.PLAYER_STATUS]=hw[W._player?W._player.videoElementStatus:"uninit"],Ee(ot,Di.NACKS,rt.nacksCount),Ee(ot,Di.PLIS,rt.plisCount),Ee(ot,Di.FIRS,rt.firsCount),Ee(ot,Di.AVG_ENCODE,rt.avgEncodeMs),Ee(ot,Di.HUGE_FRAME_SENT,rt.hugeFramesSent),Ee(ot,Di.BYTES_RETRANSMIT,rt.retransmittedBytesSent),Ee(ot,Di.PACKAGES_RETRANSMIT,rt.retransmittedPacketsSent),Ee(ot,Di.KEY_FRAMES_ENCODED,rt.keyFramesEncoded);const wt=G&&G.videoSend.find($t=>$t.ssrc===k);if(wt){let $t=$?yd:yd*ls;wt.timestamp&&rt.timestamp&&($t=rt.timestamp-wt.timestamp),wt.packets!=null&&rt.packets!=null&&Ee(ot,Di.PACKAGE_RATE,1e3*(rt.packets-wt.packets)/$t),rt.packetsLost!=null&&wt.packetsLost!=null&&Ee(ot,Di.PACKAGE_LOST,rt.packetsLost-wt.packetsLost),wt.bytes!=null&&rt.bytes!=null&&Ee(ot,Di.BITRATE,8*(rt.bytes-wt.bytes)/$t)}return ot}(v[0].ssrcId,n,r,R,a),w=a?null:function(k,U,G){const W=U.videoSend.find(Lt=>Lt.ssrc===k);if(!W)return null;const $={},rt=W.inputFrame,ot=rt&&rt.height||G&&G.videoHeight||0,Et=rt&&rt.width||G&&G.videoWidth||0,vt=rt&&rt.frameRate||0;return Ee($,Lg.HEIGHT,ot),Ee($,Lg.WIDTH,Et),Ee($,Lg.FRAME_RATE,vt),$}(v[0].ssrcId,n,R),B=a?null:function(k){const U={};return Ee(U,Di.RETRANSMIT,k.bitrate.retransmit),Ee(U,Di.TARGET_ENCODED,k.bitrate.targetEncoded),Ee(U,Di.ACTUAL_ENCODED,k.bitrate.actualEncoded),Ee(U,Di.TRANSMIT,k.bitrate.transmit),Ee(U,Di.BANDWIDTH,k.sendBandwidth),U}(n);p=Object.assign({},y,w,B)}else E=a?void 0:function(y,w,B){const k=w.videoSend.find(W=>W.ssrc===y);if(!k)return;const U={},G=k.sentFrame;if(G&&(Ee(U,Ki.HEIGHT,G.height),Ee(U,Ki.WIDTH,G.width),Ee(U,Ki.FRAME_RATE,G.frameRate)),B){const W=B.videoSend.find($=>$.ssrc===y);if(W){let $=yd*ls;W.timestamp&&k.timestamp&&($=k.timestamp-W.timestamp),W.packets!=null&&k.packets!=null&&Ee(U,Ki.PACKAGE_RATE,1e3*(k.packets-W.packets)/$),k.packetsLost!=null&&W.packetsLost!=null&&Ee(U,Ki.PACKAGE_LOST,k.packetsLost-W.packetsLost),W.bytes!=null&&k.bytes!=null&&Ee(U,Ki.BITRATE,8*(k.bytes-W.bytes)/$)}}return U}(v[0].ssrcId,n,r);break;case At.LocalAudioTrack:l=a?void 0:function(y,w,B,k){const U=w.audioSend.find(ot=>ot.ssrc===y);if(!U)return;const G={};G[Id.DISABLED]=k._originMediaStreamTrack&&!k._originMediaStreamTrack.enabled||k._mediaStreamTrack&&!k._mediaStreamTrack.enabled?1:0;const W=100*k._source.getAccurateVolumeLevel(),$=U.inputLevel;if($!=null){const ot=Math.ceil(50*Math.log10(100*$+1));Ee(G,Id.LEVEL,ot)}else Ee(G,Id.LEVEL,W);Ee(G,p1.PCM_LEVEL,W),Ee(G,Id.AEC_RETURN_LOSS,U.aecReturnLoss),Ee(G,Id.AEC_RETURN_LOSS_ENH,U.aecReturnLossEnhancement),Ee(G,Id.BYTES_RETRANSMIT,U.retransmittedBytesSent),Ee(G,Id.PACKAGES_RETRANSMIT,U.retransmittedPacketsSent),G[Id.FREEZE]=0;const rt=B&&B.audioSend.find(ot=>ot.ssrc===y);if(rt){let ot=yd*ls;rt.timestamp&&U.timestamp&&(ot=U.timestamp-rt.timestamp),rt.bytes!=null&&U.bytes!=null&&Ee(G,Id.BITRATE,8*(U.bytes-rt.bytes)/ot),rt.packets!=null&&U.packets!=null&&Ee(G,Id.PACKAGE_RATE,1e3*(U.packets-rt.packets)/ot)}return G}(v[0].ssrcId,n,r,R)}}),{high:p,low:E,audio:l}}getInboundStats(n,r,a){if(!this.requestRemoteMedia)return;const d=this.requestRemoteMedia()||[],l=[];return d.forEach(p=>{let[E,f]=p;const T={peer:E.uid};if(f.has(Kt.VIDEO)&&E.videoTrack){const R=E._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(E._videoSSRC)||!1,v=E.videoTrack?function(y,w,B,k,U,G,W){var $;const rt=w.videoRecv.find(Ye=>Ye.ssrc===y);if(!rt)return;const ot={},{receivedFrame:Et,outputFrame:vt,decodeFrameRate:Lt}=rt,wt=B&&B.videoRecv.find(Ye=>Ye.ssrc===y);if(ot[pn.FREEZE]=U&&Mg.isRemoteVideoFreeze(k,rt,wt)?1:0,Ee(ot,Bp.FRAME_RATE_DECODE,Lt),Ee(ot,pn.QP_SUM,rt.qpSumPerFrame),rt.framesRateFirefox&&Ee(ot,pn.FRAME_RATE,rt.framesRateFirefox),Et&&Ee(ot,pn.FRAME_RATE,Et.frameRate),Ee(ot,pn.FRAMES_DROPPED,rt.framesDroppedCount),Ee(ot,pn.BYTES_RETRANSMIT,rt.retransmittedBytesReceived),Ee(ot,pn.PACKAGES_RETRANSMIT,rt.retransmittedPacketsReceived),Ee(ot,pn.PACKAGES_DISCARDED,rt.packetsDiscarded),Ee(ot,pn.AVG_DECODE,rt.avgDecodeMs),Ee(ot,pn.AVG_PROCESSING_DELAY,rt.avgProcessingDelayMs),Ee(ot,pn.AVG_ASSEMBLY_TIME,rt.avgFramesAssembledFromMultiplePacketsMs),Ee(ot,pn.AVG_INTER_FRAME_DELAY,rt.avgInterFrameDelayMs),Ee(ot,pn.KEY_FRAMES_DECODED,rt.keyFramesDecoded),wt){const Ye=w.timestamp-B.timestamp||(W?yd:ls*yd);rt.packetsLost!=null&&wt.packetsLost!=null&&Ee(ot,pn.PACKAGE_LOST,rt.packetsLost-wt.packetsLost),wt.bytes!=null&&rt.bytes!=null&&Ee(ot,pn.BITRATE,8*(rt.bytes-wt.bytes)/Ye),wt.packets!=null&&rt.packets!=null&&Ee(ot,pn.PACKAGE_RATE,1e3*(rt.packets-wt.packets)/Ye)}if(W)return ot;Et?(Ee(ot,pn.HEIGHT,Et.height),Ee(ot,pn.WIDTH,Et.width)):k&&(Ee(ot,pn.HEIGHT,k._videoHeight||0),Ee(ot,pn.WIDTH,k._videoWidth||0)),vt&&Ee(ot,Bp.FRAME_RATE_OUTPUT,vt.frameRate);const $t=($=k._player)===null||$===void 0?void 0:$.rendFrameRate.toFixed(0);if($t&&Ee(ot,Bp.FRAME_RATE_RENDER,+$t),Ee(ot,pn.JITTER_BUFFER,rt.jitterBufferMs),Ee(ot,pn.CURRENT_DELAY,rt.currentDelayMs),Ee(ot,pn.FIRS,rt.firsCount),Ee(ot,pn.NACKS,rt.nacksCount),Ee(ot,pn.PLIS,rt.plisCount),k){ot[pn.DISABLED]=k._originMediaStreamTrack.enabled&&k._mediaStreamTrack.enabled?0:1;const Ye=k._player;if(Ye){const{freezeTimeCounterList:bn,renderFreezeAccTime:ri,videoElementStatus:mr}=Ye;if(bn&&bn.length>0&&Ee(ot,Bp.FREEZE_TIME,bn.splice(0,1)[0]),G&&zu.visibility==="visible"&&mr===Ms.PLAYING&&nn().supportRequestVideoFrameCallback){const Li=Math.min(6e3,ri);Ye.renderFreezeAccTime=Math.max(0,ri-Li),Ee(ot,Bp.FREEZE_TIME_RENDER,Li)}if(typeof rt.totalFreezesDuration=="number"){const Li=wt&&wt.totalFreezesDuration?rt.totalFreezesDuration-wt.totalFreezesDuration:rt.totalFreezesDuration;Ee(ot,Bp.FREEZE_DURATION,1e3*Li)}}}if(ot[pn.PLAYER_STATUS]=hw[k._player?k._player.videoElementStatus:"uninit"],wt&&rt.totalInterFrameDelay!==void 0&&rt.totalSquaredInterFrameDelay!==void 0&&wt.totalInterFrameDelay!==void 0&&wt.totalSquaredInterFrameDelay!==void 0){const Ye=rt.totalInterFrameDelay-wt.totalInterFrameDelay,bn=rt.totalSquaredInterFrameDelay-wt.totalSquaredInterFrameDelay,ri=rt.framesDecodeCount-wt.framesDecodeCount,mr=Ye/ri*1e3,Li=Math.round(1e3*Math.sqrt((bn-Math.pow(Ye,2)/ri)/ri));!isNaN(Li)&&mr+Li>Math.max(3*mr,mr+150)&&(ot[pn.I_FRAME_DELAY]=Li)}return ot}(E._videoSSRC,n,r,E.videoTrack,R===!0,this.needUploadRenderFreezeTime,a):void 0;v&&(T.video=v)}if(f.has(Kt.AUDIO)&&E.audioTrack){const R=E.audioTrack?function(v,y,w,B,k){const U=y.audioRecv.find(wt=>wt.ssrc===v);if(!U)return;const G={},W=w&&w.audioRecv.find(wt=>wt.ssrc===v),{receivedFrames:$,droppedFrames:rt}=U;var ot,Et;if(Ee(G,vo.JITTER,U.jitterMs),Ee(G,vo.BYTES_RETRANSMIT,U.retransmittedBytesReceived),Ee(G,vo.PACKAGES_RETRANSMIT,U.retransmittedPacketsReceived),Ee(G,vo.PACKAGES_DISCARDED,U.packetsDiscarded),Ee(G,vo.AVG_PROCESSING_DELAY,U.avgProcessingDelayMs),$!=null&&rt!=null&&(G[vo.FREEZE]=(Et=rt,(ot=$)===0||100*Et/ot>20?1:0)),W){const wt=y.timestamp-w.timestamp||(k?yd:yd*ls);U.packets!=null&&W.packets!=null&&Ee(G,vo.PACKAGE_RATE,1e3*(U.packets-W.packets)/wt),W.bytes!=null&&U.bytes!=null&&Ee(G,vo.BITRATE,8*(U.bytes-W.bytes)/wt),U.packetsLost!=null&&W.packetsLost!=null&&Ee(G,vo.PACKAGE_LOST,U.packetsLost-W.packetsLost)}if(k)return G;const vt=100*B._source.getAccurateVolumeLevel(),Lt=U.outputLevel;if(Lt!=null){const wt=Math.ceil(50*Math.log10(100*Lt+1));Ee(G,_1.LEVEL,wt)}if(Ee(G,vo.PCM_LEVEL,vt),B&&(G[vo.DISABLED]=B._originMediaStreamTrack.enabled&&B._mediaStreamTrack.enabled?0:1),Ee(G,vo.JITTER_BUFFER,U.jitterBufferMs),Ee(G,vo.CURRENT_DELAY,U.jitterBufferMs),G[vo.PLAYER_STATUS]=hw[Us.getPlayerState(B.getTrackId())],W){const wt=U.concealedSamples-W.concealedSamples;wt>0&&Ee(G,vo.CONCEALED_SAMPLES,wt)}return G}(E._audioSSRC,n,r,E.audioTrack,a):void 0;R&&(T.audio=R)}(T.video||T.audio)&&l.push(T)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,l}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const n=(this.requestAllTracks()||[]).find(r=>r instanceof SE);if(n&&n._external.getDenoiserStats){const r=n._external.getDenoiserStats();r&&this.requestUpload(qa.DENOISER_STATS,r)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(n=>{n.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(n=>{let[r,a]=n;a.has(Kt.VIDEO)&&r.videoTrack&&r.videoTrack.getProcessorStats().forEach(d=>{this.requestUpload&&this.requestUpload(d.type,d.stats)}),a.has(Kt.AUDIO)&&r.audioTrack&&r.audioTrack.getProcessorStats().forEach(d=>{this.requestUpload&&this.requestUpload(d.type,d.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const n=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const r=Date.now(),a={connectionInterval:J("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:r};let d=[];const l=this.requestAllTracks&&this.requestAllTracks()||[];for(const T of l)!T.muted&&T.enabled&&(d=d.concat(await T.getProcessorUsage()));const p=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[T,R]of p)R.has(Kt.VIDEO)&&T.videoTrack&&(d=d.concat(await T.videoTrack.getProcessorUsage())),R.has(Kt.AUDIO)&&T.audioTrack&&(d=d.concat(await T.audioTrack.getProcessorUsage()));if(d.length===0)return;a.details=function(T,R){const v={};for(const{id:k,value:U,level:G,direction:W}of T){var y;const $=(y=R.get(k))!==null&&y!==void 0?y:0,rt=U===2?$+J("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:$;var w,B;R.set(k,rt),v[k]?(U===2&&(v[k].value=U),G>v[k].level&&(v[k].level=G),W==="remote"&&(v[k].remoteUidCount+=1),v[k].totalTs=(w=R.get(k))!==null&&w!==void 0?w:0):v[k]={value:U,level:G,remoteUidCount:W==="local"?0:1,totalTs:(B=R.get(k))!==null&&B!==void 0?B:0}}return Object.keys(v).map(k=>{const{level:U,value:G,totalTs:W}=v[k];return{id:k,level:U,value:G,totalTs:W}})}(d,n);const E=Date.now(),f=E>r?E:r+1;this.requestUpload&&this.requestUpload(qa.EXTENSION_USAGE_STATS,{usageStats:a,sendTs:f})},J("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class du{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(n,r){F(this,"uid",void 0),F(this,"_uintid",void 0),F(this,"_trust_in_room_",!0),F(this,"_trust_audio_enabled_state_",!0),F(this,"_trust_video_enabled_state_",!0),F(this,"_trust_audio_mute_state_",!0),F(this,"_trust_video_mute_state_",!0),F(this,"_audio_muted_",!1),F(this,"_video_muted_",!1),F(this,"_audio_enabled_",!0),F(this,"_video_enabled_",!0),F(this,"_audio_added_",!1),F(this,"_video_added_",!1),F(this,"_is_pre_created",!1),F(this,"_video_pre_subscribed",!1),F(this,"_audio_pre_subscribed",!1),F(this,"_trust_video_stream_added_state_",!0),F(this,"_trust_audio_stream_added_state_",!0),F(this,"_audioTrack",void 0),F(this,"_videoTrack",void 0),F(this,"_dataChannels",[]),F(this,"_audioSSRC",void 0),F(this,"_videoSSRC",void 0),F(this,"_audioOrtc",void 0),F(this,"_videoOrtc",void 0),F(this,"_cname",void 0),F(this,"_rtxSsrcId",void 0),F(this,"_videoMid",void 0),F(this,"_audioMid",void 0),this.uid=n,this._uintid=r}}let Bc=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});function wE(t,n){var r;let a;switch(n){case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoTrack:a=Mt(r=t._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalVideoLowTrack:a=fn.Low}return a}function kg(t){const n=nn();if(t.some(r=>r._bypassWebAudio))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!n.webAudioMediaStreamDest)throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function yC(t,n){kg(t);const r=new Hi;return t.forEach(a=>r.addAudioTrack(a)),r}var Ad,m1,lO,hO,AC,bC,bd,In,Zu,pO,f1,ti;function g1(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function wC(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?g1(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):g1(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let zo=(Ad=yo(Bc.SEND_ONLY),m1=yo(Bc.SEND_ONLY),lO=yo(),hO=yo(Bc.RECEIVE_ONLY),AC=yo(Bc.RECEIVE_ONLY),bC=yo(Bc.RECEIVE_ONLY),bd=yo(Bc.RECEIVE_ONLY),In=yo(Bc.RECEIVE_ONLY),Zu=yo(Bc.RECEIVE_ONLY),pO=yo(),f1=yo(Bc.RECEIVE_ONLY),ti=class extends An{get state(){return this._state}set state(t){const n=this._state;this._state=t,this.emit(ge.StateChange,n,this._state)}constructor(t,n){super(),F(this,"isPlanB",!1),F(this,"store",void 0),F(this,"statsUploader",void 0),F(this,"sendConnection",void 0),F(this,"recvConnection",void 0),F(this,"localTrackMap",new Map),F(this,"remoteUserMap",new Map),F(this,"localDataChannels",[]),F(this,"pendingLocalTracks",[]),F(this,"pendingRemoteTracks",[]),F(this,"statsCollector",void 0),F(this,"dtlsFailedCount",0),F(this,"sendMutex",void 0),F(this,"recvMutex",void 0),F(this,"_state",gn.Disconnected),F(this,"_restartStates",["disconnected","failed"]),F(this,"reconnectInterval",void 0),F(this,"uploadUnplinkStarted",!1),F(this,"uploadDownlinkStarted",!1),F(this,"uplinkStateUploadInterval",void 0),F(this,"downlinkStatsUploadInterval",void 0),F(this,"handleMuteLocalTrack",async(r,a,d)=>{const l=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==gn.Connected)return void d(new _t(H.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const f=this.filterTobeMutedTracks(r);if(f.length===0)return void a();const T=f.find(w=>w[0]==="videoLowTrack");T&&T[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(f.map(w=>{let[,{id:B}]=w;return B}));let R=!1;var p,E;r.trackMediaType==="video"?R=!((p=this.localTrackMap.get(At.LocalAudioTrack))===null||p===void 0||!p.track._muted):R=((E=this.localTrackMap.get(At.LocalVideoTrack))===null||E===void 0?void 0:E.id)===void 0;const v=this.createMuteMessage(f);await On(this,ge.RequestMuteLocal,v);const y=r.trackMediaType==="video"?Pl.MUTE_LOCAL_VIDEO:Pl.MUTE_LOCAL_AUDIO;await On(this,ge.RequestP2PMuteLocal,{action:y,message:v,isMuteAll:R}),a()}catch(f){d(f)}finally{l()}}),F(this,"handleUnmuteLocalTrack",async(r,a,d)=>{const l=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==gn.Connected)return void d(new _t(H.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const p=this.filterTobeUnmutedTracks(r);if(p.length===0)return void a();await this.sendConnection.unmuteLocal(p.map(T=>{let[,{id:R}]=T;return R}));const E=this.createUnmuteMessage(p),f=r.trackMediaType==="video"?Pl.UNMUTE_LOCAL_VIDEO:Pl.UNMUTE_LOCAL_AUDIO;await On(this,ge.RequestP2PMuteLocal,{action:f,message:E}),a()}catch(p){d(p)}finally{l()}}),F(this,"handleUpdateVideoEncoder",async(r,a,d)=>{const l=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const p=this.localTrackMap.get(At.LocalVideoTrack);if(!this.sendConnection||!p||p.track!==r||this.state!==gn.Connected)return void a();const{id:E,track:f}=p;E&&(await this.sendConnection.updateSendParameters(E,f),await this.sendConnection.updateEncoderConfig(E,f),this.emit(ge.UpdateVideoEncoder,f)),a()}catch(p){d(p)}finally{l()}}),F(this,"handleUpdateVideoSendParameters",async(r,a,d)=>{const l=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const p=this.localTrackMap.get(At.LocalVideoTrack);if(!this.sendConnection||!p||p.track!==r||this.state!==gn.Connected)return void a();const{id:E,track:f}=p;E&&await this.sendConnection.updateSendParameters(E,f),a()}catch(p){d(p)}finally{l()}}),F(this,"handleReplaceTrack",async(r,a,d,l)=>{let p;N.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(r.getTrackId(),"]")),typeof l=="boolean"&&l||(p=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var E;const T=Array.from(this.localTrackMap.entries()).find(R=>{let[,{track:v}]=R;return r===v});if(!this.sendConnection||!T||T[1].id===void 0||this.state!==gn.Connected)return void a();if(await((E=this.sendConnection)===null||E===void 0?void 0:E.replaceTrack(r,T[1].id)),T[0]===At.LocalVideoTrack&&nn().supportDualStreamEncoding){const R=this.localTrackMap.get(At.LocalVideoLowTrack);if(R){const v=r._mediaStreamTrack.clone();R.track._originMediaStreamTrack.stop(),R.track._mediaStreamTrack=v,R.track._originMediaStreamTrack=v,await new Bt((y,w)=>{this.handleReplaceTrack(R.track,y,w,!0)})}}a()}catch(T){d(T)}finally{var f;(f=p)===null||f===void 0||f()}}),F(this,"handleGetLocalVideoStats",r=>{r(this.statsCollector.getLocalVideoTrackStats())}),F(this,"handleGetLocalAudioStats",r=>{r(this.statsCollector.getLocalAudioTrackStats())}),F(this,"handleGetRemoteVideoStats",r=>this.statsCollector.getRemoteVideoTrackStats(r.uid)[r.uid]),F(this,"handleGetRemoteAudioStats",r=>this.statsCollector.getRemoteAudioTrackStats(r.uid)[r.uid]),this.store=t,this.statsCollector=n,this.statsCollector.addP2PChannel(this),this.statsUploader=new E1(t),this.bindStatsUploaderEvents(),this.sendMutex=new Yr("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new Yr("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(r=>{r&&(r.iceConnectionState!=="disconnected"&&r.iceConnectionState!=="failed"||this.handleDisconnect(r.direction))})},J("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,n){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,n){let r;try{if(n){this.recvConnection&&(N.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),r=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new qo(t,this.store,Os.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const a=await this.recvConnection.establish(n);return{iceParameters:a.iceParameters,dtlsParameters:a.dtlsParameters,sdp:a.sdp}}{this.state=gn.New,this.sendConnection&&(N.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),r=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new qo(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const a=await this.sendConnection.establish();return{iceParameters:a.iceParameters,dtlsParameters:a.dtlsParameters,sdp:a.sdp}}}finally{r&&r()}}async p2pConnect(t){if(!this.sendConnection)throw new _t(H.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=gn.Connected}async addRemoteCandidate(t,n){if(n===Os.RECEIVE_ONLY){if(!this.sendConnection)throw new _t(H.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new _t(H.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,n,r){var a=this;return oa(function*(){const d=yield Ae(a.sendMutex.lock("From P2PChannel.publish"));try{if(!a.sendConnection||a.state!==gn.Connected){a.throwIfTrackTypeNotMatch(t);const T=t.filter(R=>a.pendingLocalTracks.indexOf(R)===-1);return void(a.pendingLocalTracks=a.pendingLocalTracks.concat(T))}a.store.pubId=a.store.pubId+1,Pr.markPublishStart(a.store.clientId,a.store.pubId);const l=a.filterTobePublishedTracks(t,n,r);if(l.length===0)return void(yield Ae(a.tryToUnmuteAudio(t)));l.forEach(T=>{let{track:R,type:v}=T;const y=Date.now();a.store.publish(R.getTrackId(),v===At.LocalAudioTrack?"audio":"video",y)}),a.bindLocalTrackEvents(l);const p=yield Ae(a.sendConnection.send(l.map(T=>{let{track:R}=T;return R}),a.store.codec,a.store.audioCodec)),E=(yield Ae(p.next())).value,f=a.createGatewayPublishMessage(l,E);try{yield f}catch(T){throw p.throw(T),(T==null?void 0:T.code)===H.WS_ABORT&&l.forEach(R=>{let{track:v}=R;a.pendingLocalTracks.indexOf(v)===-1&&a.pendingLocalTracks.push(v)}),a.unbindLocalTrackEvents(l),T}yield Ae(p.next()),l.forEach(T=>{let{type:R}=T;a.statsCollector.addLocalStats(R)}),a.statsUploader.startUploadOutboundStats(),a.assignLocalTracks(l,E),l.forEach(T=>{let{track:R,type:v}=T;const y=Date.now();a.store.publish(R.getTrackId(),v===At.LocalAudioTrack?"audio":"video",void 0,y)}),a.startUploadUplinkState()}finally{d()}})()}async unpublish(t){if(!this.sendConnection||this.state!==gn.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(d=>!Mt(t).call(t,d)));const n=this.filterTobeUnpublishedTracks(t);if(n.length===0)return;const r=n.find(d=>d[0]==="videoLowTrack");r&&r[1].track.close();const a=this.createGatewayUnpublishMessage(n);if(await this.sendConnection.stopSending(n.map(d=>{let[,{id:l}]=d;return l})),this.withdrawLocalTracks(n),this.unbindLocalTrackEvents(n.map(d=>{let[l,{track:p}]=d;return{type:l,track:p}})),n.forEach(d=>{let[l]=d;this.statsCollector.removeLocalStats(l)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===gn.Connected)return r&&r[1].track.close(),a;t.forEach(d=>{const l=this.pendingLocalTracks.indexOf(d);l!==-1&&this.pendingLocalTracks.splice(l,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const n=[],r=[];Array.from(this.localTrackMap.entries()).forEach(a=>{let[d,{track:l,ssrcs:p}]=a;const E={stream_type:wE(l,d),ssrcs:p};l._muted||!l._enabled?n.push(E):r.push(E)}),n.length>0&&n.forEach(a=>{On(this,ge.RequestMuteLocal,[a])}),r.length>0&&r.forEach(a=>{On(this,ge.RequestUnmuteLocal,[a])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return oa(function*(){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(N.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Kr(this,ge.RequestRePublish,this.pendingLocalTracks),this.emit(ge.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,n,r,a){var d;if(!this.recvConnection)throw new _t(H.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((d=this.remoteUserMap.get(t))!==null&&d!==void 0&&d.has(n))return;const{track:l,mid:p,transceiver:E}=await this.recvConnection.receive(n,[{ssrcId:r}],String(t.uid),a);n===Kt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(l):(t._audioTrack=new Lp(l,t.uid,t._uintid,this.store),N.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),E&&t._audioTrack._updateRtpTransceiver(E),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=r,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(l):(t._videoTrack=new zl(l,t.uid,t._uintid,this.store),N.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),E&&t._videoTrack._updateRtpTransceiver(E),this.bindRemoteTrackEvents(t,t._videoTrack));const f=this.remoteUserMap.get(t);f?f.set(n,p):this.remoteUserMap.set(t,new Map([[n,p]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const T=this.pendingRemoteTracks.findIndex(R=>{let{user:v,kind:y}=R;return v.uid===t.uid&&n===y});T!==-1&&(this.pendingRemoteTracks.splice(T,1),this.emit(ge.MediaReconnectEnd,t.uid))}async mockSubscribe(t,n,r,a){if(!this.recvConnection)throw new _t(H.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(n,[{ssrcId:r}],String(t.uid),a)}async unsubscribe(t,n,r){const a=this.pendingRemoteTracks.filter(l=>{let{user:p,kind:E}=l;return n!==void 0?p.uid===t.uid&&n===E:p.uid===t.uid});if(a.forEach(l=>{const p=this.pendingRemoteTracks.indexOf(l);this.pendingRemoteTracks.splice(p,1)}),this.recvConnection||r||a.forEach(l=>{let{kind:p}=l;var E;if(p===Kt.AUDIO)(E=t._audioTrack)===null||E===void 0||E._destroy(),t._audioTrack=void 0;else if(p===Kt.VIDEO){var f;(f=t._videoTrack)===null||f===void 0||f._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;const d=this.filterTobeUnSubscribedTracks(t,n);d.length!==0&&(await this.recvConnection.stopReceiving(d.map(l=>{let[,{id:p}]=l;return p})),this.withdrawRemoteTracks(d),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),d.forEach(l=>{let[p,{kind:E}]=l;var f,T;if(E===Kt.VIDEO&&p._videoSSRC&&((f=this.recvConnection)===null||f===void 0||f.setStatsRemoteVideoIsReady(p._videoSSRC,!1)),E===Kt.VIDEO)this.unbindRemoteTrackEvents(p._videoTrack),r||((T=p._videoTrack)===null||T===void 0||T._destroy(),p._videoTrack=void 0);else if(E===Kt.AUDIO){var R;this.unbindRemoteTrackEvents(p._audioTrack),!r&&((R=p._audioTrack)===null||R===void 0||R._destroy(),p._audioTrack=void 0)}}),d.forEach(l=>{let[,{kind:p}]=l;On(this,ge.RequestP2PMuteRemote,p)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(n=>{let[,r]=n;[Kt.VIDEO,Kt.AUDIO].forEach(a=>{r.has(a)?On(this,ge.RequestP2PUnmuteRemote,a):On(this,ge.RequestP2PMuteRemote,a)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new _t(H.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,n){if(!this.recvConnection)return;const r=this.remoteUserMap.get(t);if(!r)return void N.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!r.get(n))return void N.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(n,"."));const a=n===Kt.VIDEO?t._videoSSRC:t._audioSSRC;a!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(a,!1)}async unmuteRemote(t,n){return this.unmuteRemoteNoLock(t,n)}async unmuteRemoteNoLock(t,n){if(!this.recvConnection)return;const r=this.remoteUserMap.get(t);if(!r)return void N.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));r.get(n)||N.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(n,"."))}getAllTracks(t){const n=this.localTrackMap.get(At.LocalAudioTrack);if((n==null?void 0:n.track)instanceof Hi){const r=n.track;return Array.from(this.localTrackMap.entries()).filter(a=>{let[d]=a;return d!==At.LocalAudioTrack}).filter(a=>{let[d]=a;return!(t&&d===At.LocalVideoLowTrack)}).map(a=>{let[,{track:d}]=a;return d}).concat(r.trackList)}return Array.from(this.localTrackMap.entries()).filter(r=>{let[a]=r;return!(t&&a===At.LocalVideoLowTrack)}).map(r=>{let[,{track:a}]=r;return a})}reportPublishEvent(t,n,r,a,d){if(t){const p=this.localTrackMap.get(At.LocalAudioTrack),E=a?this.localTrackMap.get(At.LocalVideoLowTrack):this.localTrackMap.get(At.LocalVideoTrack);ee.publish(this.store.sessionId,{eventElapse:Pr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:n,audioName:p==null?void 0:p.track.getTrackLabel(),videoName:E==null?void 0:E.track.getTrackLabel(),screenshare:(E==null?void 0:E.track._hints.indexOf(vn.SCREEN_TRACK))!==-1,audio:!!p,video:!!E,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:d})}else{var l;r||(r=[]);const p=r.find(f=>f instanceof Ai),E=a?(l=this.localTrackMap.get(At.LocalVideoTrack))===null||l===void 0?void 0:l.track:r.find(f=>f instanceof qn);ee.publish(this.store.sessionId,{eventElapse:Pr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:n,audioName:p==null?void 0:p.getTrackLabel(),videoName:E==null?void 0:E.getTrackLabel(),screenshare:(E==null?void 0:E._hints.indexOf(vn.SCREEN_TRACK))!==-1,audio:!!p,video:!!E,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:d})}}reportSubscribeEvent(t,n,r,a){const d=a===Kt.VIDEO?r._videoSSRC:r._audioSSRC;d&&ee.subscribe(this.store.sessionId,{succ:t,ec:n,video:a===Kt.VIDEO,audio:a===Kt.AUDIO,peerid:r.uid,subscribeRequestid:a===Kt.VIDEO?r._videoSSRC:r._audioSSRC,p2pid:this.store.p2pId,eventElapse:Pr.measureFromSubscribeStart(this.store.clientId,d)})}reset(){N.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Yr("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Yr("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(At.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Hi){if(t.track.trackList.length>0){const n=t.track;t.track.trackList.forEach(r=>{n.removeAudioTrack(r)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=gn.Disconnected}getStats(t){var n,r;return t?(r=this.recvConnection)===null||r===void 0?void 0:r.getStats():(n=this.sendConnection)===null||n===void 0?void 0:n.getStats()}getRemoteVideoIsReady(t){var n;return((n=this.recvConnection)===null||n===void 0?void 0:n.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(At.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(At.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const n=this.localTrackMap.get(t);return n&&n.track instanceof qn||n&&n.track instanceof Ai?n.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,n){if(!t)return this.remoteUserMap.size>0;const r=this.remoteUserMap.get(t);return!!r&&(!n||r.has(n))}async hasRemoteMediaWithLock(t,n){if(!t)return this.remoteUserMap.size>0;const r=this.remoteUserMap.get(t);return!!r&&(!n||r.has(n))}getRemoteMedia(t){var n;const r=Array.from(na(n=this.remoteUserMap).call(n)).find(a=>a.uid===t);return r?{audioTrack:r.audioTrack,audioSSRC:r._audioSSRC,videoTrack:r.videoTrack,videoSSRC:r._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(r=>{let[a]=r;return{uid:a.uid,level:a.audioTrack?100*a.audioTrack._source.getAccurateVolumeLevel():0}});const n=this.localTrackMap.get(At.LocalAudioTrack);return n&&t.push({level:100*n.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Vh(t).call(t,(r,a)=>r.level-a.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(N.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=gn.Reconnecting,J("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[n]=t;var r;n._videoTrack&&n._videoTrack._player&&((r=n._videoTrack._player.getVideoElement())===null||r===void 0||r.pause(),n._videoTrack._player.isKeepLastFrame=!0,n._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var n;let[r,{track:a}]=t;switch(r){case At.LocalVideoTrack:Mt(n=a._hints).call(n,vn.LOW_STREAM)?a.close():this.pendingLocalTracks.push(a);break;case At.LocalAudioTrack:a instanceof Hi?this.pendingLocalTracks=this.pendingLocalTracks.concat(a.trackList):this.pendingLocalTracks.push(a)}}),this.emit(ge.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[n,r]=t;Array.from(na(r).call(r)).forEach(a=>{this.setPendingRemoteMedia(n,a)}),this.emit(ge.MediaReconnectStart,n.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),N.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,n){for(const r of this.pendingRemoteTracks){const{user:a,kind:d}=r;if((t instanceof du?t.uid:t)===a.uid&&n===d)return!0}return!1}setPendingRemoteMedia(t,n){this.hasPendingRemoteMedia(t,n)||this.pendingRemoteTracks.push({user:t,kind:n})}async restartICE(t,n){let r,a;if(t===Os.SEND_ONLY){if(!this.sendConnection)throw new _t(H.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");r=await this.sendMutex.lock("From P2PChannel.restartICE"),a=this.sendConnection}else{if(!this.recvConnection)throw new _t(H.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");r=await this.recvMutex.lock("From P2PChannel.restartICE"),a=this.recvConnection}try{if(n){const d=await a.restartICE(n);return a.isInRestartIce=!1,d}{const d=await a.restartICE();if(d){const l=await Kr(this,ge.RequestP2PRestartICE,{direction:Os.RECEIVE_ONLY,iceParameter:d});await a.restartICE(l),a.isInRestartIce=!1}}}finally{r()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),n=this.localTrackMap.get(At.LocalVideoTrack),r=this.localTrackMap.get(At.LocalAudioTrack),a=t.videoSend.find(w=>{var B;return w.ssrc===(n==null||(B=n.ssrcs)===null||B===void 0?void 0:B[0].ssrcId)}),d=t.audioSend.find(w=>{var B;return w.ssrc===(r==null||(B=r.ssrcs)===null||B===void 0?void 0:B[0].ssrcId)});if(!a||!d)return 1;const l=Vo(this,ge.NeedSignalRTT),p=a?a.rttMs:void 0,E=d?d.rttMs:void 0,f=p&&E?(p+E)/2:p||E,T=(f&&l?(f+l)/2:f||l)||0,R=100*t.sendPacketLossRate*.7/50+.3*T/1500,v=R<.17?1:R<.36?2:R<.59?3:R<.1?4:5,y=n==null?void 0:n.track;if(y&&y._encoderConfig&&y._hints.indexOf(vn.SCREEN_TRACK)===-1){const w=y._encoderConfig.bitrateMax,B=t.bitrate.actualEncoded;if(w&&B){const k=(1e3*w-B)/(1e3*w);return vb[k<.15?0:k<.3?1:k<.45?2:k<.6?3:4][v]}}return v}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let n=0;return Array.from(this.remoteUserMap.entries()).forEach(r=>{let[a]=r;const d=a._audioSSRC,l=a._videoSSRC,p=t.audioRecv.find(B=>B.ssrc===d),E=t.videoRecv.find(B=>B.ssrc===l);if(!p&&!E)return void(n+=1);const f=Vo(this,ge.NeedSignalRTT),T=t.rtt,R=(T&&f?(T+f)/2:T||f)||0,v=p?p.jitterMs:void 0,y=t.recvPacketLossRate;let w=.7*y*100/50+.3*R/1500;v&&(w=.6*y*100/50+.2*R/1500+.2*v/400),n+=w<.1?1:w<.17?2:w<.36?3:w<.59?4:5}),this.remoteUserMap.size>0?Math.round(n/this.remoteUserMap.size):n}async muteLocalTrack(t){return new Bt((n,r)=>{this.handleMuteLocalTrack(t,n,r)})}filterTobePublishedTracks(t,n,r){const a=[],d=nn(),l=this.getAllTracks();t=dp(t=t.filter(f=>l.indexOf(f)===-1));let p=!1,E=!1;for(const f of t){if(f instanceof qn&&(this.localTrackMap.has(At.LocalVideoTrack)||p?new _t(H.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(a.push({track:f,type:At.LocalVideoTrack}),p=!0),n)){const T=this.getLowVideoTrack(f,r);a.push({track:T,type:At.LocalVideoLowTrack})}if(f instanceof Ai){const T=this.localTrackMap.get(At.LocalAudioTrack);if(T){if(!(T.track instanceof Hi))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(f._bypassWebAudio)throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");T.track.addAudioTrack(f),this.bindLocalAudioTrackEvents(f,!0)}else if(E){const R=a.find(v=>{let{type:y}=v;return y===At.LocalAudioTrack});if(!(R.track instanceof Hi))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(f._bypassWebAudio)throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");R.track.addAudioTrack(f)}else{if(!d.webAudioMediaStreamDest||f instanceof Hi||f._bypassWebAudio)a.push({track:f,type:At.LocalAudioTrack});else{const R=new Hi;R.addAudioTrack(f),a.push({track:R,type:At.LocalAudioTrack})}E=!0}}}return a}filterTobeUnpublishedTracks(t){const n=[],r=this.getAllTracks();t=dp(t=t.filter(a=>r.indexOf(a)!==-1));for(const a of t){if(a instanceof Ai){const d=this.localTrackMap.get(At.LocalAudioTrack);if(!d)continue;d.track instanceof Hi?(d.track.removeAudioTrack(a),this.unbindLocalAudioTrackEvents(a),d.track.trackList.length===0&&(n.push([At.LocalAudioTrack,d]),d.track.close())):n.push([At.LocalAudioTrack,d])}if(a instanceof qn){const d=this.localTrackMap.get(At.LocalVideoTrack);if(!d)continue;n.push([At.LocalVideoTrack,d]);const l=this.localTrackMap.get(At.LocalVideoLowTrack);l&&n.push([At.LocalVideoLowTrack,l])}}return n}bindLocalTrackEvents(t){t.forEach(n=>{let{track:r,type:a}=n;switch(a){case At.LocalVideoTrack:r.addListener(Wt.GET_STATS,this.handleGetLocalVideoStats),r.addListener(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(Wt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.addListener(Wt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),r.addListener(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.addListener(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case At.LocalAudioTrack:this.bindLocalAudioTrackEvents(r)}})}bindLocalAudioTrackEvents(t,n){t instanceof Hi?t.trackList.forEach(r=>{r.addListener(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(Wt.GET_STATS,this.handleGetLocalAudioStats),r.addListener(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(Wt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),n||t.addListener(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(n=>{let[r,{track:a}]=n;return{track:a,type:r}})),t.forEach(n=>{let{track:r,type:a}=n;switch(a){case At.LocalVideoTrack:r.off(Wt.GET_STATS,this.handleGetLocalVideoStats),r.off(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.off(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.off(Wt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.off(Wt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),r.off(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.off(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.off(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case At.LocalAudioTrack:this.unbindLocalAudioTrackEvents(r)}})}unbindLocalAudioTrackEvents(t){t instanceof Hi?t.trackList.forEach(n=>{n.off(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Wt.GET_STATS,this.handleGetLocalAudioStats),n.off(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(Wt.GET_STATS,this.handleGetLocalAudioStats),t.off(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,n){n instanceof zl&&n.addListener(Wt.GET_STATS,r=>{r(this.handleGetRemoteVideoStats(t))}),n instanceof Lp&&n.addListener(Wt.GET_STATS,r=>{r(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Wt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[n,r]=t;r.has(Kt.AUDIO)&&this.unbindRemoteTrackEvents(n._audioTrack),r.has(Kt.VIDEO)&&this.unbindRemoteTrackEvents(n._videoTrack)})}createGatewayPublishMessage(t,n){return t.map((r,a)=>{var d;let l,{track:p,type:E}=r;switch(E){case At.LocalAudioTrack:l=fn.Audio;break;case At.LocalVideoTrack:l=Mt(d=p._hints).call(d,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalVideoLowTrack:l=fn.Low}return{kind:E===At.LocalAudioTrack?Kt.AUDIO:Kt.VIDEO,stream_type:l,mid:n[a].id,ssrcs:n[a].localSSRC,isMuted:p.muted||!p.enabled}})}createGatewayUnpublishMessage(t){return t.map(n=>{var r;let a,[d,{track:l,ssrcs:p,id:E}]=n;switch(d){case At.LocalVideoTrack:a=Mt(r=l._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoLowTrack:a=fn.Low}return{stream_type:a,ssrcs:p,mid:E}})}assignLocalTracks(t,n){t.forEach((r,a)=>{let{track:d,type:l}=r;this.localTrackMap.set(l,{track:d,id:n[a].id,ssrcs:n[a].localSSRC})})}withdrawLocalTracks(t){t.forEach(n=>{let[r]=n;this.localTrackMap.delete(r)})}bindConnectionEvents(t){t.onConnectionStateChange=async n=>{var r;N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(n,")")),this.emit(ge.PeerConnectionStateChange,n),n!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),n==="connected"&&(t.isInRestartIce=!1),Mt(r=this._restartStates).call(r,n)&&!t.isInRestartIce&&(n==="disconnected"&&await xr(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=n=>{n!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(n,")")),ee.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:n,tag:Si.TRACER}).onSuccess(),this.emit(ge.IceConnectionStateChange,n)},t.onICETransportStateChange=n=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(n,")"))},t.onDTLSTransportStateChange=n=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(n,")"))},t.onDTLSTransportError=n=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(n,")"))},t.onFirstAudioDecoded=n=>{var r;const a=Array.from(na(r=this.remoteUserMap).call(r)).find(l=>l._audioSSRC===n);var d;a&&(this.store.subscribe(a.uid,"audio",void 0,void 0,void 0,Date.now()),(d=a.audioTrack)===null||d===void 0||d.emit(hE.FIRST_FRAME_DECODED),ee.firstRemoteFrame(this.store.sessionId,Dr.FIRST_AUDIO_DECODE,pi.FIRST_AUDIO_DECODE,{peer:a._uintid,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=n=>{var r;const a=Array.from(na(r=this.remoteUserMap).call(r)).find(d=>d._audioSSRC===n);a&&ee.firstRemoteFrame(this.store.sessionId,Dr.FIRST_AUDIO_RECEIVED,pi.FIRST_AUDIO_RECEIVED,{peer:a._uintid,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(n,r,a)=>{this.reportVideoFirstFrameDecoded(n,r,a)},t.onFirstVideoReceived=n=>{var r;const a=Array.from(na(r=this.remoteUserMap).call(r)).find(d=>d._videoSSRC===n);a&&ee.firstRemoteFrame(this.store.sessionId,Dr.FIRST_VIDEO_RECEIVED,pi.FIRST_VIDEO_RECEIVED,{peer:a._uintid,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(n,r)=>{const a=n.candidateType==="relay",d=r.candidateType==="relay";r.candidateType!=="unknown"&&a===d||this.emit(ge.ConnectionTypeChange,a),N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Dc(r))," -> ").concat(JSON.stringify(Dc(n)),")"))},t.onSelectedRemoteCandidateChanged=(n,r)=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Dc(r))," -> ").concat(JSON.stringify(Dc(n)),")"))},t.onFirstVideoDecodedTimeout=n=>{this.reportVideoFirstFrameDecoded(n,void 0,void 0,!0)},t.onLocalCandidate=n=>{this.emit(ge.LocalCandidate,{candidate:n,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const n=t===Os.SEND_ONLY?this.sendConnection:this.recvConnection;n&&!n.isInRestartIce&&(n.isInRestartIce=!0,N.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(n.name,"] start use restartICE")),t===Os.SEND_ONLY?this.restartICE(t):Kr(this,ge.RequestP2PRestartICE,{direction:Os.SEND_ONLY}))}filterTobeMutedTracks(t){const n=[];if(this.getAllTracks().indexOf(t)===-1)return n;const r=this.localTrackMap.get(At.LocalAudioTrack);if(t instanceof Ai&&(r==null?void 0:r.track)instanceof Hi)return r.track.isActive||n.push([At.LocalAudioTrack,r]),n;const a=Array.from(this.localTrackMap.entries()).find(d=>{let[,{track:l}]=d;return t===l});if(a&&(n.push(a),a[0]===At.LocalVideoTrack)){const d=this.localTrackMap.get(At.LocalVideoLowTrack);d&&n.push([At.LocalVideoLowTrack,d])}return n}filterTobeUnmutedTracks(t){const n=[],r=this.localTrackMap.get(At.LocalAudioTrack);if(t instanceof Ai&&(r==null?void 0:r.track)instanceof Hi)return r.track.isActive&&n.push([At.LocalAudioTrack,r]),n;const a=Array.from(this.localTrackMap.entries()).find(d=>{let[,{track:l}]=d;return t===l});if(a)if(a[0]===At.LocalVideoTrack){n.push(a);const d=this.localTrackMap.get(At.LocalVideoLowTrack);d&&n.push([At.LocalVideoLowTrack,d])}else n.push(a);return n}createMuteMessage(t){return t.map(n=>{var r;let a,[d,{track:l,ssrcs:p,id:E}]=n;switch(d){case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoTrack:a=Mt(r=l._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalVideoLowTrack:a=fn.Low}return{stream_type:a,ssrcs:p,mid:E}})}createUnmuteMessage(t){return t.map(n=>{var r;let a,[d,{track:l,ssrcs:p,id:E}]=n;switch(d){case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoTrack:a=Mt(r=l._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalVideoLowTrack:a=fn.Low}return{stream_type:a,ssrcs:p,mid:E}})}filterTobeUnSubscribedTracks(t,n){const r=[],a=this.remoteUserMap.get(t);if(!a)return r;if(n){const d=a.get(n);if(!d)return r;r.push([t,{kind:n,id:d}])}else Array.from(a.entries()).forEach(d=>{let[l,p]=d;r.push([t,{kind:l,id:p}])});return r}createUnsubscribeMessage(t){const n=[];return t.forEach(r=>{let[a,{kind:d,id:l}]=r;switch(d){case Kt.VIDEO:return void(a._videoSSRC&&n.push({stream_type:Kt.VIDEO,ssrcId:a._videoSSRC}));case Kt.AUDIO:return void(a._audioSSRC&&n.push({stream_type:Kt.AUDIO,ssrcId:a._audioSSRC}))}}),n}withdrawRemoteTracks(t){t.forEach(n=>{let[r,{kind:a}]=n;const d=this.remoteUserMap.get(r);d&&(d.delete(a),Array.from(d.entries()).length===0&&this.remoteUserMap.delete(r))})}async updateBitrateLimit(t){const n=this.localTrackMap.get(At.LocalVideoTrack),r=this.localTrackMap.get(At.LocalVideoLowTrack);n&&await n.track.setBitrateLimit(t.uplink),r&&t.low_stream_uplink&&await r.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,n=this.recvConnection.peerConnectionState;return t!=="connected"&&n!=="connected"}return!0}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof Ai){const r=this.filterTobeUnmutedTracks(t[n]);if(r.length===0)continue;const a=this.createUnmuteMessage(r);return void await On(this,ge.RequestUnmuteLocal,a)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:n}]=t;return!!n}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var n;return!((n=this.recvConnection)===null||n===void 0||!n.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,n)=>this.emit(ge.RequestUpload,t,n),this.statsUploader.requestUploadStats=t=>this.emit(ge.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await xr(Tb(this.dtlsFailedCount,Vi)),this.emit(ge.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(At.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof qn)}throwIfTrackTypeNotMatch(t){if(t.filter(n=>n instanceof qn).length>1)throw new _t(H.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(n=>n instanceof Ai).length>1&&(t.some(n=>n instanceof Ai&&n._bypassWebAudio)||!nn().webAudioMediaStreamDest))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const n of t){if(n instanceof qn&&this.pendingLocalTracks.some(r=>r instanceof qn))throw new _t(H.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n instanceof Ai&&this.pendingLocalTracks.some(r=>r instanceof Ai)&&(!nn().webAudioMediaStreamDest||n._bypassWebAudio||this.pendingLocalTracks.some(r=>r instanceof Ai&&r._bypassWebAudio)))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,n){const r=!J("DISABLE_DUAL_STREAM_USE_ENCODING")&&nn().supportDualStreamEncoding,a=wC(wC({},{width:160,height:120,framerate:15,bitrate:50}),n);let d;d=r?t._mediaStreamTrack.clone():cu(t,a);const l=Vn(8,"track-low-"),p=new qn(d,wC(wC({},r&&{scaleResolutionDownBy:Wu(a,t)}),{},{frameRate:a.framerate,bitrateMax:a.bitrate,bitrateMin:a.bitrate}),void 0,void 0,l);return p.on(Ku.TRANSCEIVER_UPDATED,E=>{t._updateRtpTransceiver(E,lE.LOW_STREAM)}),p._hints.push(vn.LOW_STREAM),t.addListener(Wt.NEED_CLOSE,()=>{p.close()}),p}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,n,r,a){var d;const l=Array.from(na(d=this.remoteUserMap).call(d)).find(p=>p._videoSSRC===t);if(l){a||this.store.subscribe(l.uid,"video",void 0,void 0,void 0,void 0,Date.now());const p=this.store.keyMetrics,E=p.subscribe.find(f=>f.userId===l.uid&&f.type==="video");ee.firstRemoteVideoDecode(this.store.sessionId,Dr.FIRST_VIDEO_DECODE,pi.FIRST_VIDEO_DECODE,{peer:l._uintid,videowidth:n,videoheight:r,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:p.requestAPEnd||0,apStart:p.requestAPStart||0,joinGwEnd:p.joinGatewayEnd||0,joinGwStart:p.joinGatewayStart||0,pcEnd:p.peerConnectionEnd||0,pcStart:p.peerConnectionStart||0,subscriberEnd:(E==null?void 0:E.subscribeEnd)||0,subscriberStart:(E==null?void 0:E.subscribeStart)||0,videoAddNotify:(E==null?void 0:E.streamAdded)||0,state:a?1:0})}}async remoteMediaSsrcChanged(t,n,r){if(!this.recvConnection)return!1;const a=this.remoteUserMap.get(t);if(!a)return!1;const d=a.get(n);if(!d)return!1;const l=await this.recvConnection.getRemoteSSRC(d);return l!==void 0&&l!==r}isPreSubScribe(t){return!1}async publishDataChannel(t){throw new _t(H.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new _t(H.NOT_SUPPORTED)}async subscribeDataChannel(t,n){throw new _t(H.NOT_SUPPORTED)}async unsubscribeDataChannel(t,n){throw new _t(H.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,n){throw new _t(H.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,n){throw new _t(H.NOT_SUPPORTED)}async preConnect(t){throw new _t(H.NOT_SUPPORTED)}getEstablishParams(){throw new _t(H.NOT_SUPPORTED)}async reSubscribe(t){throw new _t(H.NOT_SUPPORTED)}async updateVideoStreamParameter(t,n){throw new _t(H.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[n,{track:r}]=t;n===At.LocalVideoLowTrack?r._updateRtpTransceiver(void 0,lE.LOW_STREAM):r._updateRtpTransceiver(void 0)})}},jt(ti.prototype,"p2pConnect",[Ad],Object.getOwnPropertyDescriptor(ti.prototype,"p2pConnect"),ti.prototype),jt(ti.prototype,"unpublish",[m1],Object.getOwnPropertyDescriptor(ti.prototype,"unpublish"),ti.prototype),jt(ti.prototype,"unpublishLowStream",[lO],Object.getOwnPropertyDescriptor(ti.prototype,"unpublishLowStream"),ti.prototype),jt(ti.prototype,"subscribe",[hO],Object.getOwnPropertyDescriptor(ti.prototype,"subscribe"),ti.prototype),jt(ti.prototype,"mockSubscribe",[AC],Object.getOwnPropertyDescriptor(ti.prototype,"mockSubscribe"),ti.prototype),jt(ti.prototype,"unsubscribe",[bC],Object.getOwnPropertyDescriptor(ti.prototype,"unsubscribe"),ti.prototype),jt(ti.prototype,"muteRemote",[bd],Object.getOwnPropertyDescriptor(ti.prototype,"muteRemote"),ti.prototype),jt(ti.prototype,"unmuteRemote",[In],Object.getOwnPropertyDescriptor(ti.prototype,"unmuteRemote"),ti.prototype),jt(ti.prototype,"hasRemoteMediaWithLock",[Zu],Object.getOwnPropertyDescriptor(ti.prototype,"hasRemoteMediaWithLock"),ti.prototype),jt(ti.prototype,"disconnectForReconnect",[pO],Object.getOwnPropertyDescriptor(ti.prototype,"disconnectForReconnect"),ti.prototype),jt(ti.prototype,"remoteMediaSsrcChanged",[f1],Object.getOwnPropertyDescriptor(ti.prototype,"remoteMediaSsrcChanged"),ti.prototype),ti);function yo(t){return function(n,r,a){const d=n[r];if(typeof d!="function")throw new Error("Cannot use mutex on object property.");return a.value=async function(){for(var l=arguments.length,p=new Array(l),E=0;E<l;E++)p[E]=arguments[E];switch(t){case Bc.SEND_ONLY:{const f=await this.sendMutex.lock("From P2PChannel2.".concat(r));try{return await d.apply(this,p)}finally{f()}}case Bc.RECEIVE_ONLY:{const f=await this.recvMutex.lock("From P2PChannel2.".concat(r));try{return await d.apply(this,p)}finally{f()}}default:{const f=await this.sendMutex.lock("From P2PChannel2.".concat(r)),T=await this.recvMutex.lock("From P2PChannel2.".concat(r));try{return await d.apply(this,p)}finally{f(),T()}}}},a}}function T1(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function $u(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?T1(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):T1(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class Mg{constructor(n){F(this,"store",void 0),F(this,"onStatsException",void 0),F(this,"onUploadPublishDuration",void 0),F(this,"onStatsChanged",void 0),F(this,"localStats",new Map),F(this,"remoteStats",new Map),F(this,"updateStatsInterval",void 0),F(this,"trafficStats",void 0),F(this,"trafficStatsPeerList",[]),F(this,"uplinkStats",void 0),F(this,"exceptionMonitor",void 0),F(this,"p2pChannel",void 0),F(this,"scalabilityMode",ke.L1T1),F(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=n,this.exceptionMonitor=new r1,this.exceptionMonitor.on("exception",(r,a,d)=>{this.onStatsException&&this.onStatsException(r,a,d)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(At.LocalAudioTrack)||$u({},uw)}getLocalVideoTrackStats(){return this.localStats.get(At.LocalVideoTrack)||$u({},lw)}getRemoteAudioTrackStats(n){const r=(l,p)=>{if(!this.trafficStats)return p;const E=this.trafficStats.peer_delay.find(f=>f.peer_uid===l);return E&&(p.publishDuration=E.B_ppad+(Date.now()-this.trafficStats.timestamp)),p},a={};if(n){var d;const l=(d=this.remoteStats.get(n))===null||d===void 0?void 0:d.audioStats;l&&(a[n]=r(n,l))}else Array.from(this.remoteStats.entries()).forEach(l=>{let[p,{audioStats:E}]=l;E&&(a[p]=r(p,E))});return a}getRemoteNetworkQualityStats(n){const r={};if(n){var a;const d=(a=this.remoteStats.get(n))===null||a===void 0?void 0:a.networkStats;d&&(r[n]=d)}else Array.from(this.remoteStats.entries()).forEach(d=>{let[l,{networkStats:p}]=d;p&&(r[l]=p)});return r}getRemoteVideoTrackStats(n){const r=(l,p)=>{if(!this.trafficStats)return p;const E=this.trafficStats.peer_delay.find(f=>f.peer_uid===l);return E&&(p.publishDuration=E.B_ppvd+(Date.now()-this.trafficStats.timestamp)),p},a={};if(n){var d;const l=(d=this.remoteStats.get(n))===null||d===void 0?void 0:d.videoStats;l&&(a[n]=r(n,l))}else Array.from(this.remoteStats.entries()).forEach(l=>{let[p,{videoStats:E}]=l;E&&(a[p]=r(p,E))});return a}getRTCStats(){let n=0,r=0,a=0,d=0;const l=this.localStats.get(At.LocalAudioTrack);l&&(n+=l.sendBytes,r+=l.sendBitrate);const p=this.localStats.get(At.LocalVideoTrack);p&&(n+=p.sendBytes,r+=p.sendBitrate);const E=this.localStats.get(At.LocalVideoLowTrack);E&&(n+=E.sendBytes,r+=E.sendBitrate),this.remoteStats.forEach(T=>{let{audioStats:R,videoStats:v}=T;R&&(a+=R.receiveBytes,d+=R.receiveBitrate),v&&(a+=v.receiveBytes,d+=v.receiveBitrate)});let f=1;return this.trafficStats&&(f+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:f,SendBitrate:r,SendBytes:n,RecvBytes:a,RecvBitrate:d,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(n){this.localStats.set(n,void 0)}removeLocalStats(n){n?this.localStats.delete(n):this.localStats.clear()}addRemoteStats(n){this.remoteStats.set(n,{})}removeRemoteStats(n){n?this.remoteStats.delete(n):this.remoteStats.clear()}addP2PChannel(n){this.p2pChannel=n}updateTrafficStats(n){n.peer_delay=n.peer_delay.filter(r=>r.B_ppad!==void 0||r.B_ppvd!==void 0),n.peer_delay.filter(r=>this.trafficStatsPeerList.indexOf(r.peer_uid)===-1).forEach(r=>{var a;const d=(a=this.p2pChannel)===null||a===void 0?void 0:a.getRemoteMedia(r.peer_uid),l=d!=null&&d.videoSSRC?Pr.measureFromSubscribeStart(this.store.clientId,d.videoSSRC):0,p=d!=null&&d.audioSSRC?Pr.measureFromSubscribeStart(this.store.clientId,d.audioSSRC):0;r.B_ppad!==void 0&&r.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(r.peer_uid,r.B_ppad,r.B_ppvd,l>p?l:p),this.trafficStatsPeerList.push(r.peer_uid))}),this.trafficStats=n}updateUplinkStats(n){this.uplinkStats&&this.uplinkStats.B_fir!==n.B_fir&&N.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(n.B_fir)),this.uplinkStats=n}static isRemoteVideoFreeze(n,r,a){if(!n)return!1;const d=!!a&&r.framesDecodeFreezeTime>a.framesDecodeFreezeTime,l=!a||r.framesDecodeCount>a.framesDecodeCount;return d||!l}static isRemoteAudioFreeze(n){return!!n&&n._isFreeze()}isLocalVideoFreeze(n){return!(!n.inputFrame||!n.sentFrame)&&n.inputFrame.frameRate>5&&n.sentFrame.frameRate<3}updateLocalStats(n){Array.from(this.localStats.entries()).forEach(r=>{let[a,d]=r;switch(a){case At.LocalVideoTrack:case At.LocalVideoLowTrack:{const p=d,E=$u({},lw),f=n.getStats(),T=n.getLocalMedia(a);if(f){const R=f.videoSend.find(v=>v.ssrc===(T==null?void 0:T.ssrcs[0].ssrcId));if(R){const v=n.getLocalVideoSize(),y=n.getEncoderConfig(At.LocalVideoTrack);R.codec!=="H264"&&R.codec!=="H265"&&R.codec!=="VP8"&&R.codec!=="VP9"&&R.codec!=="AV1X"&&R.codec!=="AV1"||(E.codecType=R.codec),E.sendBytes=R.bytes,E.sendBitrate=p?8*Math.max(0,E.sendBytes-p.sendBytes):0,R.inputFrame?(E.captureFrameRate=R.inputFrame.frameRate,E.captureResolutionHeight=R.inputFrame.height,E.captureResolutionWidth=R.inputFrame.width):v&&(E.captureResolutionWidth=v.width,E.captureResolutionHeight=v.height),R.sentFrame?(E.sendFrameRate=R.sentFrame.frameRate,E.sendResolutionHeight=R.sentFrame.height,E.sendResolutionWidth=R.sentFrame.width):v&&(E.sendResolutionWidth=v.width,E.sendResolutionHeight=v.height),R.avgEncodeMs&&(E.encodeDelay=R.avgEncodeMs),y&&y.bitrateMax&&(E.targetSendBitrate=1e3*y.bitrateMax),E.sendPackets=R.packets,E.sendPacketsLost=R.packetsLost,E.sendJitterMs=R.jitterMs,E.sendRttMs=R.rttMs,E.totalDuration=p?p.totalDuration+1:1,E.totalFreezeTime=p?p.totalFreezeTime:0,this.isLocalVideoFreeze(R)&&(E.totalFreezeTime+=1),R.scalabilityMode&&this.scalabilityMode!==R.scalabilityMode&&(N.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(R.scalabilityMode)),this.scalabilityMode=R.scalabilityMode)}this.trafficStats&&(E.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var l;this.localStats.set(a,E),((p==null?void 0:p.sendResolutionWidth)!==E.sendResolutionWidth||(p==null?void 0:p.sendResolutionHeight)!==E.sendResolutionHeight)&&((l=this.onStatsChanged)===null||l===void 0||l.call(this,"resolution",{width:E.sendResolutionWidth,height:E.sendResolutionHeight})),E&&T&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,T.track,E);break}case At.LocalAudioTrack:{const p=d,E=$u({},uw),f=n.getStats(),T=n.getLocalMedia(a);if(f){const R=f.audioSend.find(v=>v.ssrc===(T==null?void 0:T.ssrcs[0].ssrcId));if(R){if(R.codec!=="opus"&&R.codec!=="aac"&&R.codec!=="PCMU"&&R.codec!=="PCMA"&&R.codec!=="G722"||(E.codecType=R.codec),R.inputLevel)E.sendVolumeLevel=Math.round(32767*R.inputLevel);else{const v=n.getLocalAudioVolume();v&&(E.sendVolumeLevel=Math.round(32767*v))}E.sendBytes=R.bytes,E.sendPackets=R.packets,E.sendPacketsLost=R.packetsLost,E.sendJitterMs=R.jitterMs,E.sendRttMs=R.rttMs,E.sendBitrate=p?8*Math.max(0,E.sendBytes-p.sendBytes):0}}this.trafficStats&&(E.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(At.LocalAudioTrack,E),E&&T&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,T.track,E);break}}})}updateRemoteStats(n){Array.from(this.remoteStats.entries()).forEach(r=>{var a,d;let[l,{videoStats:p,audioStats:E,videoPcStats:f}]=r;const T=E,R=p,v=f,y=$u({},GR),w=$u({},fM),B=$u({},nG),{audioTrack:k,videoTrack:U,audioSSRC:G,videoSSRC:W}=n.getRemoteMedia(l);let $;$=n instanceof zo?n.getStats(!0):n.getStats();const rt=(a=$)===null||a===void 0?void 0:a.audioRecv.find(vt=>vt.ssrc===G),ot=(d=$)===null||d===void 0?void 0:d.videoRecv.find(vt=>vt.ssrc===W),Et=this.trafficStats&&this.trafficStats.peer_delay.find(vt=>vt.peer_uid===l);if(rt&&(rt.codec!=="opus"&&rt.codec!=="aac"&&rt.codec!=="PCMU"&&rt.codec!=="PCMA"&&rt.codec!=="G722"||(y.codecType=rt.codec),rt.outputLevel?y.receiveLevel=Math.round(32767*rt.outputLevel):k&&(y.receiveLevel=Math.round(32767*k.getVolumeLevel())),y.receiveBytes=rt.bytes,y.receivePackets=rt.packets,y.receivePacketsLost=rt.packetsLost,y.receivePacketsDiscarded=rt.packetsDiscarded,y.packetLossRate=y.receivePacketsLost/(y.receivePackets+y.receivePacketsLost),y.receiveBitrate=T?8*Math.max(0,y.receiveBytes-T.receiveBytes):0,y.totalDuration=T?T.totalDuration+1:1,y.totalFreezeTime=T?T.totalFreezeTime:0,y.freezeRate=y.totalFreezeTime/y.totalDuration,y.receiveDelay=rt.jitterBufferMs,y.totalDuration>10&&Mg.isRemoteAudioFreeze(k)&&(y.totalFreezeTime+=1)),ot){ot.codec!=="H264"&&ot.codec!=="H265"&&ot.codec!=="VP8"&&ot.codec!=="VP9"&&ot.codec!=="AV1X"&&ot.codec!=="AV1"||(w.codecType=ot.codec),w.receiveBytes=ot.bytes,w.receiveBitrate=R?8*Math.max(0,w.receiveBytes-R.receiveBytes):0,w.decodeFrameRate=ot.decodeFrameRate<0?0:ot.decodeFrameRate,w.renderFrameRate=ot.decodeFrameRate<0?0:ot.decodeFrameRate,ot.outputFrame&&(w.renderFrameRate=ot.outputFrame.frameRate),ot.receivedFrame?(w.receiveFrameRate=ot.receivedFrame.frameRate,w.receiveResolutionHeight=ot.receivedFrame.height,w.receiveResolutionWidth=ot.receivedFrame.width):U&&(w.receiveResolutionHeight=U._videoHeight||0,w.receiveResolutionWidth=U._videoWidth||0),ot.framesRateFirefox!==void 0&&(w.receiveFrameRate=Math.round(ot.framesRateFirefox)),w.receivePackets=ot.packets,w.receivePacketsLost=ot.packetsLost,w.packetLossRate=w.receivePacketsLost/(w.receivePackets+w.receivePacketsLost),w.totalDuration=R?R.totalDuration+1:1,w.totalFreezeTime=R?R.totalFreezeTime:0,w.receiveDelay=ot.jitterBufferMs||0;const vt=!!W&&n.getRemoteVideoIsReady(W);U&&vt&&Mg.isRemoteVideoFreeze(U,ot,v)&&(w.totalFreezeTime+=1),w.freezeRate=w.totalFreezeTime/w.totalDuration}Et&&(y.end2EndDelay=Et.B_ad,w.end2EndDelay=Et.B_vd,y.transportDelay=Et.B_ed,w.transportDelay=Et.B_ed,y.currentPacketLossRate=Et.B_ealr4/100,w.currentPacketLossRate=Et.B_evlr4/100,B.uplinkNetworkQuality=Et.B_punq?Et.B_punq:0,B.downlinkNetworkQuality=Et.B_pdnq?Et.B_pdnq:0),this.remoteStats.set(l,{audioStats:y,videoStats:w,videoPcStats:ot,networkStats:B}),k&&this.exceptionMonitor.setRemoteAudioStats(k,y),U&&this.exceptionMonitor.setRemoteVideoStats(U,w)})}}class Ug{constructor(){F(this,"destChannelMediaInfos",new Map),F(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(n){OR(n),this.srcChannelMediaInfo=n}addDestChannelInfo(n){OR(n),this.destChannelMediaInfos.set(n.channelName,n)}removeDestChannelInfo(n){Nl(n),this.destChannelMediaInfos.delete(n)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function _O(t){if(!(t instanceof Ug))return new lt(H.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const n=t.getSrcChannelMediaInfo(),r=t.getDestChannelMediaInfo();if(!n)return new lt(H.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(r.size===0)return new lt(H.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}function EO(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function mO(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?EO(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):EO(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}var _n;function _c(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function xg(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?_c(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):_c(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let tl=(_n=class jO extends kb{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>{var r;return Mt(r=Object.keys(Af)).call(r,n)}))]}constructor(n,r){super(n,r),F(this,"store",void 0),F(this,"peerConnection",void 0),F(this,"remoteSDP",void 0),F(this,"initialOffer",void 0),F(this,"statsFilter",void 0),F(this,"useRTX",!1),F(this,"localCapabilities",void 0),F(this,"localCandidateCount",0),F(this,"allCandidatesReceived",!1),F(this,"establishPromise",void 0),F(this,"mutex",void 0),this.store=r,this.mutex=new Yr("P2PConnection-mutex",r.clientId),this.peerConnection=new RTCPeerConnection(jO.resolvePCConfiguration(n),{optional:[{googDscp:!0}]}),this.statsFilter=bE(this.peerConnection,J("STATS_UPDATE_INTERVAL"),void 0,Ii()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const n=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=xc(n.sdp),a=ya(n.sdp,{filterRTX:!this.useRTX,filterVideoFec:J("FILTER_VIDEO_FEC"),filterAudioFec:J("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=a,this.initialOffer=n,xg(xg({},r),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:a},offerSDP:n.sdp})}catch(n){throw new _t(H.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async updateRemoteConnect(){}async connect(n){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(a){F(this,"sessionDesc",void 0),F(this,"localCapabilities",void 0),F(this,"rtpCapabilities",void 0),F(this,"candidates",void 0),F(this,"iceParameters",void 0),F(this,"dtlsParameters",void 0),F(this,"setup",void 0),F(this,"currentMidIndex",void 0),F(this,"cname",void 0),a=xi(a);const{iceParameters:d,dtlsParameters:l,candidates:p,rtpCapabilities:E,setup:f,localCapabilities:T,sdkCodec:R,cname:v}=a,y=Qr.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=E,this.candidates=p,this.iceParameters=d,this.dtlsParameters=l,this.setup=f,this.localCapabilities=T,this.cname=v;for(let w=0;w<y.mediaDescriptions.length;w++){const B=y.mediaDescriptions[w];if(B.attributes.iceUfrag=d.iceUfrag,B.attributes.icePwd=d.icePwd,B.attributes.fingerprints=l.fingerprints,B.attributes.candidates=p,B.attributes.setup=f,B.media.mediaType==="video"){B.media.fmts=E.videoCodecs.map(U=>U.payloadType.toString(10));let k=E.videoCodecs.filter(U=>{var G,W;return(G=U.rtpMap)===null||G===void 0?void 0:Mt(W=G.encodingName.toLowerCase()).call(W,R)});k.length===0&&(k=E.videoCodecs),B.attributes.payloads=k,B.attributes.extmaps=E.videoExtensions}B.media.mediaType==="audio"&&(B.media.fmts=E.audioCodecs.map(k=>k.payloadType.toString(10)),B.attributes.payloads=E.audioCodecs,B.attributes.extmaps=E.audioExtensions),y.mediaDescriptions[w]=this.mungMediaDesc(B)}this.sessionDesc=y,this.currentMidIndex=y.mediaDescriptions.length-1}toString(){return Qr.print(this.sessionDesc)}send(a,d,l){const{ssrcs:p,ssrcGroups:E}=Jl(d,this.cname),f=this.sessionDesc.mediaDescriptions.find(v=>a===Kt.VIDEO?v.media.mediaType==="video":v.media.mediaType==="audio"),T=p[0].attributes.label,R=p[0].attributes.mslabel;return f.attributes.ssrcs=f.attributes.ssrcs.concat(p),f.attributes.ssrcGroups=f.attributes.ssrcGroups.concat(E),{id:T,mslabel:R}}batchSend(a){return a.map(d=>{let{kind:l,ssrcMsg:p}=d;return this.send(l,p,void 0)})}stopSending(a){this.sessionDesc.mediaDescriptions.forEach(d=>{const l=[],p=[],E=[];d.attributes.ssrcs.forEach(f=>{Mt(a).call(a,f.attributes.label||"")?E.push(f):l.push(f)}),d.attributes.ssrcGroups.forEach(f=>{var T;Mt(T=E.map(R=>R.ssrcId)).call(T,f.ssrcIds[0])||p.push(f)}),d.attributes.ssrcs=l,d.attributes.ssrcGroups=p})}mute(a){const d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===a);if(!d)throw new Error("mediaDescription not found with ".concat(a," in remote SDP when calling RemoteSDP.mute."));d.attributes.direction="inactive"}unmute(a){const d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===a);if(!d)throw new Error("mediaDescription not found with ".concat(a," in remote SDP when calling RemoteSDP.unmute."));d.attributes.direction="sendonly"}receive(a,d,l){a.forEach((p,E)=>{const f=p._mediaStreamTrack,T=this.sessionDesc.mediaDescriptions.findIndex(v=>v.attributes.mid===f.kind),R=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[T],p);this.sessionDesc.mediaDescriptions[T]=R})}stopReceiving(a){}updateCandidates(a){a===go.TCP?this.candidates.forEach(d=>{this.candidates.findIndex(l=>l.transport==="tcp"&&l.connectionAddress===d.connectionAddress&&l.port===d.port)===-1&&this.candidates.push(mO(mO({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}):this.candidates=this.candidates.filter(d=>d.transport!=="tcp");for(const d of this.sessionDesc.mediaDescriptions)d.attributes.candidates=this.candidates}restartICE(a){a=xi(a),this.iceParameters=a,this.sessionDesc.mediaDescriptions.forEach(d=>{d.attributes.iceUfrag=a.iceUfrag,d.attributes.icePwd=a.icePwd})}predictReceivingMids(a){const d=[];for(let l=0;l<a;l++)d.push((this.currentMidIndex+l+1).toString(10));return d}mungRecvMediaDsec(a,d){const l=xi(a);return Up(l,d),Ig(l,d),l}updateRecvMedia(a,d){const l=this.sessionDesc.mediaDescriptions.findIndex(p=>p.attributes.mid===a);if(l!==-1){const p=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[l],d);this.sessionDesc.mediaDescriptions[l]=p}}bumpMid(a){this.currentMidIndex+=a}updateTrackLabel(a,d,l){const p=this.sessionDesc.mediaDescriptions.find(f=>a===Kt.VIDEO?f.attributes.mid==="video":f.attributes.mid==="audio");if(p){const f=p.attributes.ssrcs.find(T=>T.attributes.label===d);var E;f&&(f.attributes.label=l,(E=f.attributes.msid)===null||E===void 0||E.replace(d,l))}}mungMediaDesc(a){const d=xi(a);return pC(d),function(l){const p=l.attributes.extmaps.find(E=>Ho(E.extensionName));p&&l.attributes.extmaps.splice(l.attributes.extmaps.indexOf(p),1),l.attributes.payloads.forEach(E=>{const f=E.rtcpFeedbacks.findIndex(T=>T.type==="transport-cc");f!==-1&&E.rtcpFeedbacks.splice(f,1)})}(d),d}getSSRC(a){for(const d of this.sessionDesc.mediaDescriptions)for(const l of d.attributes.ssrcs)if(l.attributes.label===a)return[l]}}(xg(xg({},n),{},{rtpCapabilities:n.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(r.toString()))}}async updateRemoteRTPCapabilities(n,r){throw new _t(H.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(n){}send(n,r){var a=this;return oa(function*(){const d=yield Ae(a.mutex.lock());try{if(!a.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const l=n.map(y=>a.peerConnection.addTrack(y._mediaStreamTrack)),p=yield Ae(a.peerConnection.createOffer()),E=Qr.parse(p.sdp),f=n.map(y=>{const w=y._mediaStreamTrack,B=E.mediaDescriptions.find(k=>k.attributes.mid===w.kind);if(!B)throw new Error("Cannot extract ssrc from mediaDescription.");return function(k,U,G){const W=k.attributes.ssrcs.filter(rt=>rt.attributes.label===U),$=k.attributes.ssrcGroups;if(W.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if($&&W.length>1){const rt=$.find(ot=>ot.ssrcIds.indexOf(W[0].ssrcId)!==-1);return rt?[{ssrcId:rt.ssrcIds[0],rtx:G?rt.ssrcIds[1]:void 0}]:[{ssrcId:W[0].ssrcId}]}return[{ssrcId:W[0].ssrcId}]}(B,w.id,a.useRTX)});let T;try{T=yield f}catch(y){throw l.forEach(w=>{vr()&&w.replaceTrack(null),a.peerConnection.removeTrack(w)}),y}const R=a.mungSendOfferSDP(p.sdp,n);a.remoteSDP.receive(n,r,T);const v=a.remoteSDP.toString();return yield Ae(a.peerConnection.setLocalDescription({type:"offer",sdp:R})),yield Ae(a.applySendEncodings(l,n)),yield Ae(a.peerConnection.setRemoteDescription({type:"answer",sdp:v})),n.map((y,w)=>{const B=y._mediaStreamTrack.id;return{localSSRC:f[w],id:B}})}catch(l){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(l.toString()))}finally{d()}})()}async stopSending(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getSenders().filter(l=>{var p;return n.indexOf(((p=l.track)===null||p===void 0?void 0:p.id)||"")!==-1});if(r.length!==n.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(l=>{vr()&&l.replaceTrack(null),this.peerConnection.removeTrack(l)});const a=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(a),this.remoteSDP.stopReceiving(n);const d=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:d})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}}async receive(n,r,a,d){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(n," before remoteSDP created."));const{id:l,mslabel:p}=this.remoteSDP.send(n,r,d),E=new Bt((R,v)=>{const y=setTimeout(()=>{v(new Error("Cannot receive track, id: ".concat(l)))},1e4),w=B=>{const k=en();if((k.name==="Safari"&&Number(k.version)===11||Ys())&&B.track.id!==l&&B.streams[0].id===p){var U;const G=B.streams[0].getTracks()[0];return(U=this.remoteSDP)===null||U===void 0||U.updateTrackLabel(n,l,B.track.id),this.peerConnection.removeEventListener("track",w),clearTimeout(y),void R(G)}if(B.track.id===l)return this.peerConnection.removeEventListener("track",w),clearTimeout(y),void R(B.track)};this.peerConnection.addEventListener("track",w)}),f=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:f});const T=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(T),{track:await E,id:l}}catch(l){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(l.toString()))}}async stopReceiving(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(n);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}}async muteRemote(n){}async unmuteRemote(n){}async muteLocal(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const r=this.peerConnection.getSenders().filter(a=>{var d;return n.indexOf(((d=a.track)===null||d===void 0?void 0:d.id)||"")!==-1});if(r.length!==n.length)throw new Error("sender' length doesn't match mids' length.");r.map(a=>{if(vr()&&a.track)a.track.enabled=!1;else{const d=a.getParameters();d.encodings.forEach(l=>l.active=!1),a.setParameters(d)}})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(r.toString()))}}async unmuteLocal(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const r=this.peerConnection.getSenders().filter(l=>{var p;return n.indexOf(((p=l.track)===null||p===void 0?void 0:p.id)||"")!==-1});if(r.length!==n.length)throw new Error("Senders' length doesn't match mids' length.");r.map(async l=>{if(vr()&&l.track)l.track.enabled=!0;else{const p=l.getParameters();p.encodings.forEach(E=>E.active=!0),await l.setParameters(p)}});const a=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(a);const d=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:d})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(r.toString()))}}restartICE(n){var r=this;return oa(function*(){const a=yield Ae(r.mutex.lock("From P2PConnection.restartICE"));try{if(!r.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(nn().supportPCSetConfiguration){const f=r.peerConnection.getConfiguration(),T=n===go.RELAY?"relay":"all";f.iceTransportPolicy!==T&&(N.debug("[".concat(r.store.clientId,"] restartICE change iceTransportPolicy from [").concat(f.iceTransportPolicy,"] to [").concat(T,"]")),f.iceTransportPolicy=T,r.peerConnection.setConfiguration(f))}else if(n===go.RELAY)return;n!==go.RELAY&&r.remoteSDP.updateCandidates(n);const d=yield Ae(r.peerConnection.createOffer({iceRestart:!0}));if(!d.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const l=xc(d.sdp),{remoteIceParameters:p}=yield l.iceParameters;r.remoteSDP.restartICE(p);const E=r.remoteSDP.toString();yield Ae(r.peerConnection.setLocalDescription(d)),yield Ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:E}))}catch(d){N.warning("[".concat(r.store.clientId,"] restart ICE failed, abort operation"),d)}finally{a()}})()}close(){var n;this.peerConnection.close(),(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(n){return this.statsFilter.getVideoIsReady(n)}async updateEncoderConfig(n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const a=await this.peerConnection.createOffer(),d=this.mungSendOfferSDP(a.sdp,[r]);this.remoteSDP.updateRecvMedia(r._mediaStreamTrack.kind,r);const l=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(a){throw new _t(H.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(n,r){const a=this.peerConnection.getSenders().filter(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===n});a.length===1&&await this.applySendEncodings(a,[r])}setStatsRemoteVideoIsReady(n,r){this.statsFilter.setVideoIsReady2(n,r)}async replaceTrack(n,r){const a=this.peerConnection.getSenders().find(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===r});a&&await a.replaceTrack(n._mediaStreamTrack)}createDataChannels(n,r){throw new _t(H.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(n){throw new _t(H.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var n;(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var n;(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=n=>{n.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,N.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,N.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},J("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(n){const r={iceServers:[],sdpSemantics:"plan-b"};return n.iceServers?r.iceServers=n.iceServers:n.turnServer&&n.turnServer.mode!=="off"&&(TR(n.turnServer.servers)?r.iceServers=n.turnServer.servers:(r.iceServers&&r.iceServers.push(...jO.turnServerConfigToIceServers(n.turnServer.servers)),J("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&n.turnServer.serversFromGateway&&r.iceServers.push(...jO.turnServerConfigToIceServers(n.turnServer.serversFromGateway)),n.turnServer.servers.concat(n.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(r.iceTransportPolicy="relay")}))),r}static turnServerConfigToIceServers(n){const r=[];return n.forEach(a=>{a.security?a.tcpport&&r.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}):(a.udpport&&r.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.udpport,"?transport=udp")}),a.tcpport&&r.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}))}),r}async updateRtpSenderEncodings(n,r){var a;if(r||(r=this.peerConnection.getSenders().find(T=>{var R;return((R=T.track)===null||R===void 0?void 0:R.id)===n._mediaStreamTrack.id})),!r)return N.warn("[".concat(n.getTrackId(),"] no rtpSender found}"));if(!nn().supportSetRtpSenderParameters)return N.warn("Browser not support set rtp-sender parameters");const d={},l={};if(n instanceof qn)switch(n._optimizationMode){case"motion":d.degradationPreference="maintain-framerate";break;case"detail":d.degradationPreference="maintain-resolution";break;default:d.degradationPreference="balanced"}if(J("DSCP_TYPE")&&Il()){var p;const T=J("DSCP_TYPE");Mt(p=["very-low","low","medium","high"]).call(p,T)&&(l.networkPriority=T)}const E=r.getParameters(),f=(a=E.encodings)===null||a===void 0?void 0:a[0];f&&Object.assign(f,l),Object.assign(E,d),N.debug("[".concat(n.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(E.encodings))),await r.setParameters(E)}async applySendEncodings(n,r){try{if(!nn().supportSetRtpSenderParameters||n.length!==r.length)return;for(let a=0;a<n.length;a++){const d=n[a],l=r[a];d&&l&&await this.updateRtpSenderEncodings(l,d)}}catch{N.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(n,r){const a=Qr.parse(n);return r.forEach((d,l)=>{const p=d._mediaStreamTrack,E=a.mediaDescriptions.find(f=>f.attributes.mid===p.kind);E&&Up(E,d)}),Qr.print(a)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=n=>{var r;(r=this.onFirstAudioReceived)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstVideoReceived=n=>{var r;(r=this.onFirstVideoReceived)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstAudioDecoded=n=>{var r;(r=this.onFirstAudioDecoded)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstVideoDecoded=(n,r,a)=>{var d;(d=this.onFirstVideoDecoded)===null||d===void 0||d.call(this,n,r,a)},this.statsFilter.onSelectedLocalCandidateChanged=(n,r)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,n,r)},this.statsFilter.onSelectedRemoteCandidateChanged=(n,r)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,n,r)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const r=this.remoteSDP.batchSend(n).map((l,p)=>{let{id:E,mslabel:f}=l;const{kind:T}=n[p];return new Bt((R,v)=>{const y=setTimeout(()=>{v(new Error("Cannot receive track, id: ".concat(E)))},1e4),w=B=>{const k=en();if(k.name==="Safari"&&Number(k.version)===11&&B.track.id!==E&&B.streams[0].id===f){var U;const G=B.streams[0].getTracks()[0];return(U=this.remoteSDP)===null||U===void 0||U.updateTrackLabel(T,E,B.track.id),this.peerConnection.removeEventListener("track",w),clearTimeout(y),void R({track:G,id:E})}if(B.track.id===E)return this.peerConnection.removeEventListener("track",w),clearTimeout(y),void R({track:B.track,id:E})};this.peerConnection.addEventListener("track",w)})}),a=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),await Bt.all(r)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}}async getRemoteSSRC(n){if(!this.remoteSDP)return;const r=this.remoteSDP.getSSRC(n);return r==null?void 0:r[0].ssrcId}setConfiguration(n){if(nn().supportPCSetConfiguration){const r=jO.resolvePCConfiguration(n);this.peerConnection.setConfiguration(r)}}},jt(_n.prototype,"connect",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"connect"),_n.prototype),jt(_n.prototype,"stopSending",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"stopSending"),_n.prototype),jt(_n.prototype,"receive",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"receive"),_n.prototype),jt(_n.prototype,"stopReceiving",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"stopReceiving"),_n.prototype),jt(_n.prototype,"muteRemote",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"muteRemote"),_n.prototype),jt(_n.prototype,"unmuteRemote",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"unmuteRemote"),_n.prototype),jt(_n.prototype,"muteLocal",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"muteLocal"),_n.prototype),jt(_n.prototype,"unmuteLocal",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"unmuteLocal"),_n.prototype),jt(_n.prototype,"close",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"close"),_n.prototype),jt(_n.prototype,"updateEncoderConfig",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"updateEncoderConfig"),_n.prototype),jt(_n.prototype,"updateSendParameters",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"updateSendParameters"),_n.prototype),jt(_n.prototype,"replaceTrack",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"replaceTrack"),_n.prototype),jt(_n.prototype,"getRemoteSSRC",[Bn],Object.getOwnPropertyDescriptor(_n.prototype,"getRemoteSSRC"),_n.prototype),_n);function Bn(t,n,r){const a=t[n];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const d=this.mutex,l=await d.lock("Locking from P2PConnection.".concat(n));try{for(var p=arguments.length,E=new Array(p),f=0;f<p;f++)E[f]=arguments[f];return await a.apply(this,E)}finally{l()}},r}function S1(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Jo(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?S1(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):S1(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const OE="9",fO=4e4;class OC{get localCapabilities(){return xi(this._localCapabilities)}get rtpCapabilities(){return xi(this._rtpCapabilities)}get candidates(){return xi(this._candidates)}get iceParameters(){return xi(this._iceParameters)}get dtlsParameters(){return xi(this._dtlsParameters)}constructor(n){F(this,"sessionDesc",void 0),F(this,"_localCapabilities",void 0),F(this,"_rtpCapabilities",void 0),F(this,"_candidates",void 0),F(this,"_iceParameters",void 0),F(this,"_dtlsParameters",void 0),F(this,"setup",void 0),F(this,"currentMidIndex",void 0),F(this,"cname",void 0),F(this,"firefoxSsrcMidMap",new Map),n=xi(n);const{iceParameters:r,dtlsParameters:a,candidates:d,rtpCapabilities:l,setup:p,localCapabilities:E,cname:f}=n;this._rtpCapabilities=l,this._candidates=d,this._iceParameters=r,this._dtlsParameters=a,this._localCapabilities=E,this.setup=p,this.cname=f,this.sessionDesc=this.updateRemoteRTPCapabilities(l),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(n){const r=this.candidates,a=this.dtlsParameters,d=this.iceParameters,l=this.rtpCapabilities.send;let p=this.sessionDesc.mediaDescriptions.length-1;for(let E=1;E<n;E++){const f=2*E+2e4,T=2*E+fO,{ssrcs:R,ssrcGroups:v}=Jl([{ssrcId:f}],this.cname),{ssrcs:y,ssrcGroups:w}=Jl([{ssrcId:T,rtx:J("USE_SUB_RTX")?T+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:OE,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.videoCodecs.map(B=>B.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:d.iceUfrag,icePwd:d.icePwd,unrecognized:[],candidates:r,extmaps:l.videoExtensions,fingerprints:a.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:y,ssrcGroups:w,rtcpFeedbackWildcards:[],payloads:l.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++p)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:OE,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.audioCodecs.map(B=>B.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:d.iceUfrag,icePwd:d.icePwd,unrecognized:[],candidates:r,extmaps:l.audioExtensions,fingerprints:a.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:R,ssrcGroups:v,rtcpFeedbackWildcards:[],payloads:l.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++p)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Qr.print(this.sessionDesc)}send(n,r,a,d){const{ssrcs:l,ssrcGroups:p}=Jl(r,this.cname,J("SYNC_GROUP")?a:void 0),E=this.findPreloadMediaDesc(l);if(E){if(Ii()&&this.firefoxSsrcMidMap.set(l[0].ssrcId,E.attributes.mid),d&&(d.twcc||d.remb)){const f=this.sessionDesc.mediaDescriptions.indexOf(E);return this.sessionDesc.mediaDescriptions[f]=this.mungSendMediaDesc(E,d),{mid:E.attributes.mid,needExchangeSDP:!0}}return{mid:E.attributes.mid,needExchangeSDP:!1}}{const f=this.findAvailableMediaIndex(n,l);let T;return f===-1||f===1&&(vr()||function(){const R=en();return!(R.name!==mn.CHROME||!R.osVersion)&&Number(R.version)<=90}())||f===0&&J("USE_SUB_RTX")||dk()?(T=this.createOrRecycleSendMedia(n,l,p,"sendonly",d),this.updateBundleMids()):(T=xi(this.sessionDesc.mediaDescriptions[f]),T.attributes.direction="sendonly",T.attributes.ssrcs=l,T.attributes.ssrcGroups=p,this.sessionDesc.mediaDescriptions[f]=this.mungSendMediaDesc(T,d)),Ii()&&this.firefoxSsrcMidMap.set(l[0].ssrcId,T.attributes.mid),{mid:T.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:n,needExchangeSDP:r}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:n.attributes.mid,needExchangeSDP:r}}batchSend(n){const r=n.map(l=>{let{kind:p,ssrcMsg:E,mslabel:f}=l;return this.send(p,E,f)}),a=[];let d=!1;return r.forEach(l=>{let{mid:p,needExchangeSDP:E}=l;E&&(d=!0),a.push(p)}),{mids:a,needExchangeSDP:d}}stopSending(n){const r=this.sessionDesc.mediaDescriptions.filter(a=>a.attributes.mid&&n.indexOf(a.attributes.mid)!==-1);if(r.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");r.forEach(a=>{a.attributes.mid==="0"||Ii()||dk()?a.attributes.ssrcs=[]:(a.attributes.ssrcs=[],a.attributes.direction="inactive",a.media.port="0")}),this.updateBundleMids()}mute(n){const r=this.sessionDesc.mediaDescriptions.find(a=>a.attributes.mid===n);if(!r)throw new Error("mediaDescription not found with ".concat(n," in remote SDP when calling RemoteSDP.mute."));r.attributes.direction="inactive"}unmute(n){const r=this.sessionDesc.mediaDescriptions.find(a=>a.attributes.mid===n);if(!r)throw new Error("mediaDescription not found with ".concat(n," in remote SDP when calling RemoteSDP.unmute."));r.attributes.direction="sendonly"}muteRemote(n){const r=this.sessionDesc.mediaDescriptions.filter(a=>Mt(n).call(n,a.attributes.mid||""));if(r.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");r.forEach(a=>{a.attributes.direction="inactive"})}unmuteRemote(n){const r=this.sessionDesc.mediaDescriptions.filter(a=>Mt(n).call(n,a.attributes.mid||""));if(r.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");r.forEach(a=>{a.attributes.direction="recvonly"})}receive(n,r,a,d){n.forEach((l,p)=>{this.createOrRecycleRecvMedia(l,[],"recvonly",r,a,d[p])}),this.updateBundleMids()}stopReceiving(n){const r=this.sessionDesc.mediaDescriptions.filter(a=>n.indexOf(a.attributes.mid)!==-1);if(r.length!==n.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");r.forEach(a=>{a.media.port="0",a.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(n){const r=this.sessionDesc||Qr.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=n;const a=this.rtpCapabilities.send,d=this.localCapabilities.send;for(const l of r.mediaDescriptions){if(l.attributes.iceUfrag=this._iceParameters.iceUfrag,l.attributes.icePwd=this._iceParameters.icePwd,l.attributes.fingerprints=this._dtlsParameters.fingerprints,l.attributes.candidates=this._candidates,l.attributes.setup=this.setup,l.media.mediaType==="application"&&(l.attributes.sctpPort="5000"),l.media.mediaType==="video"){if(a.videoCodecs.length===0){const p=d.videoCodecs.filter(E=>{var f,T;return(f=E.rtpMap)===null||f===void 0?void 0:Mt(T=f.encodingName.toLowerCase()).call(T,"vp8")})||[d.videoCodecs[0]];l.media.fmts=p.map(E=>E.payloadType.toString(10)),l.attributes.payloads=p,l.attributes.extmaps=[]}else if(l.media.fmts=a.videoCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=a.videoCodecs,l.attributes.extmaps=a.videoExtensions,J("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:p,ssrcGroups:E}=Jl([{ssrcId:fO,rtx:J("USE_SUB_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=E}}if(l.media.mediaType==="audio"){if(a.audioCodecs.length===0){const p=d.audioCodecs.filter(E=>{var f,T;return(f=E.rtpMap)===null||f===void 0?void 0:Mt(T=f.encodingName.toLowerCase()).call(T,"opus")})||[d.audioCodecs[0]];l.media.fmts=p.map(E=>E.payloadType.toString(10)),l.attributes.payloads=p,l.attributes.extmaps=[]}else if(l.media.fmts=a.audioCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=a.audioCodecs,l.attributes.extmaps=a.audioExtensions,Ju(l),J("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:p,ssrcGroups:E}=Jl([{ssrcId:2e4}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=E}}}return this.sessionDesc=r,this.currentMidIndex=r.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(n){const r=this._candidates.filter(a=>a.transport==="udp");if(n===go.TCP){if(r.length===0)return;if(J("TCP_CANDIDATE_ONLY")){const a=this._candidates.filter(d=>d.transport==="tcp");r.forEach(d=>{a.findIndex(l=>l.connectionAddress===d.connectionAddress)===-1&&a.push(Jo(Jo({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}),this._candidates=a}else{const a=[];r.forEach(d=>{a.push(Jo(Jo({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}),this._candidates=[...r,...a]}}else if(n===go.RELAY){if(r.length!==0)return;{const a=this._candidates.filter(d=>d.transport==="tcp");a.forEach(d=>{r.push(Jo(Jo({},d),{},{foundation:"udpcandidate",priority:Number(d.priority)+1+"",transport:"udp",port:Number(d.port)-90+""}))}),this._candidates=[...r,...a]}}else r.length===0?(this._candidates.filter(a=>a.transport==="tcp").forEach(a=>{r.push(Jo(Jo({},a),{},{foundation:"udpcandidate",priority:Number(a.priority)+1+"",transport:"udp",port:Number(a.port)-90+""}))}),this._candidates=r):this._candidates=this._candidates.filter(a=>a.transport!=="tcp");for(const a of this.sessionDesc.mediaDescriptions)a.attributes.candidates=this.candidates}restartICE(n){n=xi(n),this._iceParameters=n,this.sessionDesc.mediaDescriptions.forEach(r=>{r.attributes.iceUfrag=n.iceUfrag,r.attributes.icePwd=n.icePwd})}predictReceivingMids(n){const r=[];for(let a=0;a<n;a++)r.push((this.currentMidIndex+a+1).toString(10));return r}findAvailableMediaIndex(n,r){return this.sessionDesc.mediaDescriptions.findIndex(a=>{const d=a.media.mediaType===n&&a.media.port!=="0"&&(a.attributes.direction==="sendonly"||a.attributes.direction==="sendrecv")&&a.attributes.ssrcs.length===0;if(Ii()){if(d){const l=this.firefoxSsrcMidMap.get(r[0].ssrcId);return!(l||a.attributes.mid!=="0"&&a.attributes.mid!=="1")||!(!l||l!==a.attributes.mid)}return!1}return d})}createOrRecycleDataChannel(){for(const a of this.sessionDesc.mediaDescriptions)if(a.media.mediaType==="application")return{mediaDesc:a,needExchangeSDP:!1};this.currentMidIndex+=1;const n="".concat(this.currentMidIndex),r={media:{mediaType:"application",port:OE,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(n),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(r),{mediaDesc:r,needExchangeSDP:!0}}createOrRecycleRecvMedia(n,r,a,d,l,p){const E=n._mediaStreamTrack.kind,f=this.rtpCapabilities.recv,T=vE(E,f,this.localCapabilities.send,E===Kt.VIDEO?d:l),R=E===Kt.VIDEO?f.videoExtensions:f.audioExtensions;this.currentMidIndex+=1;const v="".concat(this.currentMidIndex);let y={media:{mediaType:E,port:OE,protos:["UDP","TLS","RTP","SAVPF"],fmts:T.map(B=>B.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:R,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:r,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:T,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:a,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(v)}};y=this.mungRecvMediaDsec(y,n,p);const w=this.findFirstClosedMedia(E);if(w){const B=this.sessionDesc.mediaDescriptions.indexOf(w);this.sessionDesc.mediaDescriptions[B]=y}else this.sessionDesc.mediaDescriptions.push(y);return y}updateRemoteCodec(n,r,a){const d=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(y=>y.rtpMap&&y.rtpMap.encodingName.toLowerCase()||"").filter(y=>{var w;return Mt(w=Object.keys(Af)).call(w,y)}))],l=new Set(r);if(d.every(y=>l.has(y)))return N.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(r)),!1;const p=this._rtpCapabilities.recv.videoCodecs.filter(y=>r.some(w=>{var B;return Mt(B=y.rtpMap&&y.rtpMap.encodingName.toLowerCase()||"").call(B,w)}));if(p.length===0)return N.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(d," codecs: ").concat(r)),!1;const E=[...new Set(p.map(y=>y.rtpMap&&y.rtpMap.encodingName.toLowerCase()||""))];let f;if(N.debug("updateRemoteCodec, from ".concat(d," to ").concat(E)),n.length===0)f=this.sessionDesc.mediaDescriptions.filter(y=>y.media.mediaType==="video"&&y.attributes.direction==="recvonly");else if(f=this.sessionDesc.mediaDescriptions.filter(y=>y.attributes.mid&&Mt(n).call(n,y.attributes.mid)&&y.attributes.direction==="recvonly"),f.length!==n.length)return N.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(n,", codecs: ").concat(r)),!1;if(J("USE_PUB_RTX")||J("USE_SUB_RTX")){const y=mC(p,this.rtpCapabilities.recv.videoCodecs);p.push(...y)}this._rtpCapabilities.recv.videoCodecs=p;const T=this.localCapabilities.send,R=this.rtpCapabilities.recv,v=vE(Kt.VIDEO,R,T,a);return f.forEach(y=>{const w=v.map(B=>B.payloadType.toString(10));N.debug("updateRemoteCodec mid: ".concat(y.attributes.mid,", from"),y.attributes.payloads,"to",v),y.attributes.payloads=v,y.media.fmts=w}),!0}createOrRecycleSendMedia(n,r,a,d,l){const p=this.rtpCapabilities.send,E=n===Kt.VIDEO?p.videoCodecs:p.audioCodecs,f=n===Kt.VIDEO?p.videoExtensions:p.audioExtensions;this.currentMidIndex+=1;const T="".concat(this.currentMidIndex);let R={media:{mediaType:n,port:OE,protos:["UDP","TLS","RTP","SAVPF"],fmts:E.map(y=>y.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:f,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:r,ssrcGroups:a,rtcpFeedbackWildcards:[],payloads:E,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:d,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(T)}};R=this.mungSendMediaDesc(R,l);const v=this.findFirstClosedMedia(n);if(v){const y=this.sessionDesc.mediaDescriptions.indexOf(v);this.sessionDesc.mediaDescriptions[y]=R}else this.sessionDesc.mediaDescriptions.push(R);return R}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(n=>n.media.port!=="0").map(n=>n.attributes.mid)}mungRecvMediaDsec(n,r,a){const d=xi(n);return pC(d),Up(d,r),Ig(d,r),zw(d),_C(d,a,this.localCapabilities.send),d}mungSendMediaDesc(n,r){const a=xi(n);return _C(a,r,this.localCapabilities.recv),Ju(a),a}updateRecvMedia(n,r){const a=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===n);if(a!==-1){const d=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=d}}bumpMid(n){this.currentMidIndex+=n}findFirstClosedMedia(n){return this.sessionDesc.mediaDescriptions.find(r=>Ii()?r.media.port==="0"&&r.media.mediaType===n:r.media.port==="0")}findPreloadMediaDesc(n){return this.sessionDesc.mediaDescriptions.find(r=>{var a;return((a=r.attributes)===null||a===void 0||(a=a.ssrcs[0])===null||a===void 0?void 0:a.ssrcId)===n[0].ssrcId})}getSSRC(n){var r;return(r=this.sessionDesc.mediaDescriptions.find(a=>a.attributes.mid===n))===null||r===void 0?void 0:r.attributes.ssrcs}}function R1(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function el(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?R1(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):R1(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let NE=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({});var DE=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(DE||{});const NC=new Map;function gO(t,n,r,a){let{scale:d}=t;if(d===0&&a===DE.UP||d>=n.length-1&&a===DE.DOWN)return t;let l=el(el({},t),{},{scale:a===DE.DOWN?++d:--d});switch(r){case"maintain-framerate":l=el(el({},l),n[d].motion);break;case"maintain-resolution":l=el(el({},l),n[d].detail);break;case"balanced":l=el(el({},l),n[d].balanced)}return l}function PE(t,n){if(n){const r={overUse:0,underUse:0,adaptationList:C1(n)};NC.set(t,r)}else NC.delete(t)}function C1(t){const n=el({},t),{bitrateMax:r,frameRate:a,scaleResolutionDownBy:d,bitrateMin:l}=n,{MIN_FRAME_RATE:p,MAX_THRESHOLD_FRAMERATE:E,MAX_SCALE:f,BITRATE_MIN_THRESHOLD:T,BITRATE_MAX_THRESHOLD:R,BWE_SCALE_UP_THRESHOLD:v,BWE_SCALE_DOWN_THRESHOLD:y,PERF_SCALE_DOWN_THRESHOLD:w,PERF_SCALE_UP_THRESHOLD:B,BALANCE_BITRATE_FACTOR:k,BALANCE_FRAMERATE_FACTOR:U,BALANCE_RESOLUTION_FACTOR:G,MOTION_RESOLUTION_FACTOR:W,MOTION_BITRATE_FACTOR:$,DETAIL_FRAMERATE_FACTOR:rt,DETAIL_BITRATE_FACTOR:ot}=yf,Et=Math.min(n.frameRate,E),vt=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(y,1)*r),bwe_up:r,fps_down:Math.round(Math.pow(w,1)*Et),fps_up:a},balanced:{scaleResolutionDownBy:1,frameRate:a,bitrateMax:r,bitrateMin:l},motion:{scaleResolutionDownBy:1,frameRate:a,bitrateMax:r,bitrateMin:l},detail:{scaleResolutionDownBy:1,frameRate:a,bitrateMax:r,bitrateMin:l}}];for(let Lt=1;Lt<=f;Lt++){const wt={bwe_up:Math.round(Math.pow(v,Lt)*r),bwe_down:Math.round(Math.pow(y,Lt+1)*r),fps_up:Math.round(Math.pow(B,Lt)*Et),fps_down:Math.round(Math.pow(w,Lt+1)*Et)},$t={scaleResolutionDownBy:d/Math.pow(G,Lt),frameRate:Math.max(Math.round(Math.pow(U,Lt)*a),p),bitrateMax:Math.max(Math.round(Math.pow(k,Lt)*r),R),bitrateMin:Math.max(Math.round(Math.pow(k,Lt)*l),T)},Ye={scaleResolutionDownBy:d/Math.pow(W,Lt),frameRate:a,bitrateMax:Math.max(Math.round(Math.pow($,Lt)*r),R),bitrateMin:Math.max(Math.round(Math.pow($,Lt)*l),T)},bn={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(rt,Lt)*a),p),bitrateMax:Math.max(Math.round(Math.pow(ot,Lt)*r),R),bitrateMin:Math.max(Math.round(Math.pow(ot,Lt)*l),T)};vt.push({scale:Lt,threshold:wt,balanced:$t,motion:Ye,detail:bn})}return vt}function v1(t,n,r,a,d,l){const p=NC.get(t)||{overUse:0,underUse:0,adaptationList:C1(d)},{adaptationList:E}=p;NC.set(t,p);const{OVERUSE_TIMES_THRESHOLD:f,UNDERUSE_TIMES_THRESHOLD:T}=yf,{scale:R}=a;let v,y;return typeof n=="number"&&n>0&&function(w,B,k,U){if(B>=k.length)return!1;let{threshold:{fps_down:G}}=k[B];return J("FORCE_AG_HIGH_FRAMERATE")&&U==="maintain-framerate"&&(G=k[0].threshold.fps_down),w<G}(n,R,E,l)&&(p.overUse++,y=NE.CPU,p.overUse>f)||typeof r=="number"&&r>0&&function(w,B,k){if(B>=k.length)return!1;const{threshold:{bwe_down:U}}=k[B];return w<U}(r,R,E)&&(p.overUse++,y=NE.BANDWIDTH,p.overUse>f)?(p.overUse=0,p.underUse=0,v=gO(a,E,l,DE.DOWN),[v,y]):(typeof n=="number"&&n>0&&typeof r=="number"&&r>0&&function(w,B,k,U){if(B===0)return;let{threshold:{fps_up:G}}=k[B];return J("FORCE_AG_HIGH_FRAMERATE")&&U==="maintain-framerate"&&(G=k[1].threshold.fps_up),w>G}(n,R,E,l)&&function(w,B,k){if(B===0)return;const{threshold:{bwe_up:U}}=k[B];return w>U}(r,R,E)&&(p.underUse++,p.underUse>T&&(p.overUse=0,p.underUse=0,v=gO(a,E,l,DE.UP),v.scale===0&&(y=NE.NONE))),[v,y])}function DC(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function PC(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?DC(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):DC(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}function I1(t){var n;return!!J("ENABLE_AG_ADAPTATION")&&!!(t instanceof Fw||Mt(n=t._hints).call(n,vn.CUSTOM_TRACK))&&(!!J("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(r){const a=en();if(a.os!==Cr.IOS||!a.osVersion)return!1;const d=a.osVersion.split(".");return Number(d[0])>=r}(14)&&ok(17,4)||sk(14)&&ak(17,4,!0)))}const LC=new Map;function kC(t,n){const r=LC.get(t);if(r){const{timer:a}=r;window.clearTimeout(a),LC.delete(t)}n.qualityLimitationReason=NE.NONE,PE(t)}var qe;function Vg(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function wd(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?Vg(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Vg(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}let jc=(qe=class GO extends kb{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var n,r;return(n=(r=this.peerConnection.getReceivers()[0])===null||r===void 0||(r=r.transport)===null||r===void 0?void 0:r.state)!==null&&n!==void 0?n:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>{var r;return Mt(r=Object.keys(Af)).call(r,n)}))]}constructor(n,r){super(n,r),F(this,"store",void 0),F(this,"peerConnection",void 0),F(this,"id",Vn(5,"connection-")),F(this,"remoteSDP",void 0),F(this,"initialOffer",void 0),F(this,"transportEventReceiver",void 0),F(this,"statsFilter",void 0),F(this,"extension",{useXR:J("USE_XR")}),F(this,"localCapabilities",void 0),F(this,"remoteCodecs",void 0),F(this,"localCandidateCount",0),F(this,"allCandidatesReceived",!1),F(this,"isPreallocation",!1),F(this,"preSSRCMap",new Map),F(this,"dataStreamChannelMap",new Map),F(this,"establishPromise",void 0),F(this,"recoveredDataChannelIds",[]),F(this,"currentDataChannelId",1),F(this,"mutex",void 0),F(this,"qualityLimitationReason",NE.NONE),this.store=r,this.mutex=new Yr("P2PConnection-mutex",r.clientId),this.peerConnection=new RTCPeerConnection(GO.resolvePCConfiguration(n),{optional:[{googDscp:!0}]}),this.statsFilter=bE(this.peerConnection,J("STATS_UPDATE_INTERVAL"),void 0,Ii()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(n){const r=this.preSSRCMap.get(n);if(r!==void 0){const a=this.peerConnection.getTransceivers().find(d=>d.mid===r);if(a)return{transceiver:a,track:a.receiver.track,id:r}}}async updateRemoteRTPCapabilities(n,r){if(this.remoteCodecs=r,!this.remoteSDP)return void N.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(r));if(this.remoteSDP.updateRemoteCodec(n,r,this.store.codec)){const a=await this.peerConnection.createOffer(),d=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a);const l=this.remoteSDP.toString();d==null||d(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}else N.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const r=await this.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const a=xc(r.sdp),d=await Jw({filterRTX:!J("USE_PUB_RTX")&&!J("USE_SUB_RTX"),filterVideoFec:J("FILTER_VIDEO_FEC"),filterAudioFec:J("FILTER_AUDIO_FEC"),filterVideoCodec:J("FILTER_VIDEO_CODEC")},this.extension);let l;return this.localCapabilities=EC(d),this.initialOffer=r,r.sdp&&Xw(r.sdp)&&(l=xi(d),(n=l).send&&(Mp(Kt.VIDEO,n.send.videoExtensions),Mp(Kt.AUDIO,n.send.audioExtensions)),n.recv&&(Mp(Kt.VIDEO,n.recv.videoExtensions),Mp(Kt.AUDIO,n.recv.audioExtensions)),n.sendrecv&&(Mp(Kt.VIDEO,n.sendrecv.videoExtensions),Mp(Kt.AUDIO,n.sendrecv.audioExtensions))),wd(wd({},a),{},{rtpCapabilities:l||d,offerSDP:r.sdp})}catch(r){throw new _t(H.GET_LOCAL_CONNECTION_PARAMS_FAILED,r.toString())}var n}async connect(n){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&Xw(this.initialOffer.sdp)&&(r=n.rtpCapabilities,a=this.localCapabilities,r.send&&(lC(Kt.VIDEO,r.send.videoExtensions,a.send.videoExtensions),lC(Kt.AUDIO,r.send.audioExtensions,a.send.audioExtensions)),r.recv&&(lC(Kt.VIDEO,r.recv.videoExtensions,a.recv.videoExtensions),lC(Kt.AUDIO,r.recv.audioExtensions,a.recv.audioExtensions))),this.remoteSDP=new OC(wd(wd({},n),{},{localCapabilities:this.localCapabilities})),n.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const d=this.remoteSDP.toString(),l=Vc(this.initialOffer.sdp,this.extension),p=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),p==null||p(d),await this.peerConnection.setRemoteDescription({type:"answer",sdp:d});const E=this.peerConnection.getTransceivers()[0];if(E!=null&&E.receiver&&this.tryBindTransportEvents(E.receiver),J("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(J("PRELOAD_MEDIA_COUNT"));const T=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:T});const R=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(R)}const{preSSRCs:f}=n;if(Array.isArray(f)&&f.length>0){const{mids:T}=this.remoteSDP.batchSend(f.map(R=>({kind:R.kind,ssrcMsg:[{ssrcId:R.ssrcId,rtx:R.rtx}],mslabel:R.mslabel})));T.forEach((R,v)=>{this.preSSRCMap.set(f[v].ssrcId,R)}),await Ql(this.peerConnection,this.remoteSDP,this.extension),N.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(d){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(d.toString()))}var r,a}async updateRemoteConnect(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:r}=n;this.remoteSDP.updateRemoteRTPCapabilities(r),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const{preSSRCs:a}=n;if(Array.isArray(a)&&a.length>0){const{mids:d}=this.remoteSDP.batchSend(a.map(l=>Object.assign({},{kind:l.kind,ssrcMsg:[{ssrcId:l.ssrcId,rtx:l.rtx}],mslabel:l.mslabel})));d.forEach((l,p)=>{this.preSSRCMap.set(a[p].ssrcId,l)})}await Ql(this.peerConnection,this.remoteSDP,this.extension),N.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(r.toString()))}}send(n,r,a){var d=this;return oa(function*(){const l=yield Ae(d.mutex.lock("From P2PConnection.send"));try{if(!d.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const p=[];n.forEach(k=>{const U=d.peerConnection.addTransceiver(k._mediaStreamTrack,{direction:"sendonly"});p.push(U),k._updateRtpTransceiver(U)}),Ii()&&J("SIMULCAST")===!0&&(yield Ae(d.applySimulcastForFirefox(p,n)));const E=yield Ae(d.peerConnection.createOffer()),f=d.remoteSDP.predictReceivingMids(n.length),T=d.mungSendOfferSDP(E.sdp,n,f),R=Qr.parse(T),v=f.map(k=>{const U=R.mediaDescriptions.find(G=>G.attributes.mid===k);if(!U)throw new Error("Cannot extract ssrc from mediaDescription.");return Kw(U,J("USE_PUB_RTX"))});let y;try{y=yield v}catch(k){y=[],d.remoteSDP.receive(n,r,a,y);const U=d.remoteSDP.toString();throw yield Ae(d.peerConnection.setLocalDescription({type:"offer",sdp:T})),yield Ae(d.peerConnection.setRemoteDescription({type:"answer",sdp:U})),yield Ae(d.stopSending(f,!0)),k}d.remoteSDP.receive(n,r,a,y);const w=d.remoteSDP.toString(),B=d.logSDPExchange(T,"offer","local","send");return yield Ae(d.peerConnection.setLocalDescription({type:"offer",sdp:T})),yield Ae(d.applySimulcastEncodings(p,n)),yield Ae(d.applySendEncodings(p,n)),B==null||B(w),yield Ae(d.peerConnection.setRemoteDescription({type:"answer",sdp:w})),p.map((k,U)=>{const G=f[U];return{localSSRC:v[U],id:G,transceiver:k}})}catch(p){throw p instanceof _t?p:new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(p.toString()))}finally{l()}})()}async createDataChannels(n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let a=this.dataStreamChannelMap.get(n);if(a&&a.readyState==="open")N.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const l=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof l!="number")throw new Error("create DataChannel error, because cannot get dc id");a=this.peerConnection.createDataChannel("datastream-channel",{id:l,negotiated:!0,ordered:!1,maxRetransmits:J("DATASTREAM_MAX_RETRANSMITS")}),a.binaryType="arraybuffer",this.dataStreamChannelMap.set(n,a)}r.forEach(l=>{l._updateOriginDataChannel(a)});const{needExchangeSDP:d}=this.remoteSDP.sendDataChannel();if(d){const l=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:l});const p=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(p),N.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else N.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(a){throw a instanceof _t?a:new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(a.toString()))}}async stopDataChannels(n){try{const r=this.dataStreamChannelMap.get(n);return r&&(r.id&&this.recoveredDataChannelIds.push(r.id),r.close()),void this.dataStreamChannelMap.delete(n)}catch(r){throw r instanceof _t?r:new _t(H.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(r.toString()))}}async stopSending(n,r){const a=r?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const d=this.peerConnection.getTransceivers().filter(f=>n.indexOf(f.mid)!==-1);if(d.length!==n.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");d.map(f=>{var T;kC(this.id+f.mid,this),f.direction="inactive",(T=f.stop)===null||T===void 0||T.call(f)});const l=await this.peerConnection.createOffer(),p=this.logSDPExchange(l.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(l),this.remoteSDP.stopReceiving(n);const E=this.remoteSDP.toString();p==null||p(E),await this.peerConnection.setRemoteDescription({type:"answer",sdp:E})}catch(d){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(d.toString()))}finally{a&&a()}}async receive(n,r,a,d){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(n," before remoteSDP created."));const{mid:l,needExchangeSDP:p}=this.remoteSDP.send(n,r,a,d);p&&(await Ql(this.peerConnection,this.remoteSDP,this.extension),N.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(n," by exchanging SDP.")));const E=this.peerConnection.getTransceivers().find(f=>f.mid===l);if(!E)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:E.receiver.track,id:l,transceiver:E}}catch(l){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(l.toString()))}}async batchReceive(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:r,needExchangeSDP:a}=this.remoteSDP.batchSend(n);return a&&(await Ql(this.peerConnection,this.remoteSDP,this.extension),N.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),r.map(d=>{const l=this.peerConnection.getTransceivers().find(p=>p.mid===d);if(!l)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:l.receiver.track,id:d,transceiver:l}})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}}async stopReceiving(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");n.forEach(l=>{Array.from(this.preSSRCMap.entries()).some(p=>{let[E,f]=p;if(f===l)return this.preSSRCMap.delete(E),!0})}),this.remoteSDP.stopSending(n);const r=this.remoteSDP.toString(),a=this.logSDPExchange(r,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const d=await this.peerConnection.createAnswer();a==null||a(d.sdp||""),await this.peerConnection.setLocalDescription(d)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}}async muteRemote(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(n," before remote SDP created."));this.remoteSDP.mute(n);const r=this.remoteSDP.toString(),a=this.logSDPExchange(r,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const d=await this.peerConnection.createAnswer();a==null||a(d.sdp||""),await this.peerConnection.setLocalDescription(d)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(r.toString()))}}async unmuteRemote(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(n," before remote SDP created."));this.remoteSDP.unmute(n);const r=this.remoteSDP.toString(),a=this.logSDPExchange(r,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const d=await this.peerConnection.createAnswer();a==null||a(d.sdp||""),await this.peerConnection.setLocalDescription(d)}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(r.toString()))}}async muteLocal(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const r=this.peerConnection.getTransceivers().filter(p=>p.mid&&n.indexOf(p.mid)!==-1);if(r.length!==n.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(p=>{p.direction="inactive"});const a=await this.peerConnection.createOffer(),d=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.muteRemote(n);const l=this.remoteSDP.toString();d==null||d(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(r.toString()))}}async unmuteLocal(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const r=this.peerConnection.getTransceivers().filter(p=>p.mid&&n.indexOf(p.mid)!==-1);if(r.length!==n.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(async(p,E)=>{p.direction="sendonly"});const a=await this.peerConnection.createOffer(),d=this.logSDPExchange(a.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.unmuteRemote(n);const l=this.remoteSDP.toString();d==null||d(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(r){throw new _t(H.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(r.toString()))}}restartICE(n){var r=this;return oa(function*(){const a=yield Ae(r.mutex.lock("From P2PConnection.restartICE"));try{if(!r.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(nn().supportPCSetConfiguration){const T=r.peerConnection.getConfiguration(),R=n===go.RELAY?"relay":"all";T.iceTransportPolicy!==R&&(N.debug("[".concat(r.store.clientId,"] restartICE change iceTransportPolicy from [").concat(T.iceTransportPolicy,"] to [").concat(R,"]")),T.iceTransportPolicy=R,r.peerConnection.setConfiguration(T))}else if(n===go.RELAY)return;r.remoteSDP.updateCandidates(n);const d=yield Ae(r.peerConnection.createOffer({iceRestart:!0}));if(!d.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const l=xc(d.sdp),{remoteIceParameters:p}=yield l.iceParameters;r.remoteSDP.restartICE(p);const E=r.remoteSDP.toString(),f=r.logSDPExchange(d.sdp||"","offer","local","restartICE");r.store.descriptionStart(),yield Ae(r.peerConnection.setLocalDescription(d)),f==null||f(E),yield Ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:E}))}catch(d){N.warning("[".concat(r.store.clientId,"] restart ICE failed, abort operation"),d)}finally{a()}})()}close(){var n;this.peerConnection.getTransceivers().forEach(r=>{kC(this.id+r.mid,this)}),this.preSSRCMap.clear(),this.peerConnection.close(),(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return wd(wd({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(n){return this.statsFilter.getVideoIsReady(n)}async updateEncoderConfig(n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const a=await this.peerConnection.createOffer(),d=this.mungSendOfferSDP(a.sdp,[r],[n]);this.remoteSDP.updateRecvMedia(n,r);const l=this.remoteSDP.toString(),p=this.logSDPExchange(d,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),p==null||p(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(a){throw new _t(H.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(n,r){const a=this.peerConnection.getTransceivers().filter(d=>d.mid===n);a.length===1&&(this.isVP8Simulcast(r)?Ii()||await this.applySimulcastEncodings(a,[r]):await this.applySendEncodings(a,[r]))}setStatsRemoteVideoIsReady(n,r){this.statsFilter.setVideoIsReady2(n,r)}async replaceTrack(n,r){const a=this.peerConnection.getTransceivers().find(d=>d.mid===r);a&&await a.sender.replaceTrack(n._mediaStreamTrack)}async getSelectedCandidatePair(){const n=this.peerConnection.getReceivers();if(n.length>0&&n[0].transport&&n[0].transport.iceTransport&&n[0].transport.iceTransport.getSelectedCandidatePair&&n[0].transport.iceTransport.getSelectedCandidatePair()){const r=n[0].transport.iceTransport,{local:a,remote:d}=r.getSelectedCandidatePair();return{local:wd(wd({},bi),{},{candidateType:a.type,protocol:a.protocol,address:a.address,port:a.port}),remote:wd(wd({},bi),{},{candidateType:d.type,protocol:d.protocol,address:d.address,port:d.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var n;(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var n;(n=this.onConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=n=>{n.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,N.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,N.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},J("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(n){const r={iceServers:[]};return n.iceServers?r.iceServers=n.iceServers:n.turnServer&&n.turnServer.mode!=="off"&&(TR(n.turnServer.servers)?r.iceServers=n.turnServer.servers:(r.iceServers&&r.iceServers.push(...GO.turnServerConfigToIceServers(n.turnServer.servers)),J("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&n.turnServer.serversFromGateway&&r.iceServers.push(...GO.turnServerConfigToIceServers(n.turnServer.serversFromGateway)),J("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":n.turnServer.servers.concat(n.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(r.iceTransportPolicy="relay")}))),J("ENABLE_ENCODED_TRANSFORM")&&nn().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),r}static turnServerConfigToIceServers(n){const r=[];return n.forEach(a=>{a.security?a.tcpport&&r.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(eE(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}):(a.udpport&&!J("FORCE_TURN_TCP")&&r.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.udpport,"?transport=udp")}),a.tcpport&&r.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}))}),r}tryBindTransportEvents(n){const r=n.transport;if(r){this.transportEventReceiver=n,r.onstatechange=()=>{var d;r!=null&&r.state&&((d=this.onDTLSTransportStateChange)===null||d===void 0||d.call(this,r.state))},r.onerror=d=>{var l;(l=this.onDTLSTransportError)===null||l===void 0||l.call(this,"error"in d?d.error:d)};const a=r.iceTransport;a&&(a.onstatechange=()=>{const d=r==null?void 0:r.iceTransport.state;var l;d&&((l=this.onICETransportStateChange)===null||l===void 0||l.call(this,d))},a.getSelectedCandidatePair&&(a.onselectedcandidatepairchange=()=>{if(a.getSelectedCandidatePair()){const{local:d,remote:l}=a.getSelectedCandidatePair();N.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:d.type,protocol:d.protocol}),", remote ").concat(JSON.stringify({candidateType:l.type,protocol:l.protocol,address:l.address,port:l.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(n,r){var a,d;if(r||(r=this.peerConnection.getSenders().find(U=>U.track===n._mediaStreamTrack)),!r)return N.warn("[".concat(n.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(n))return N.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!nn().supportSetRtpSenderParameters)return N.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const l={},p={};switch(n._optimizationMode){case"motion":l.degradationPreference="maintain-framerate";break;case"detail":l.degradationPreference="maintain-resolution";break;case"balanced":l.degradationPreference="balanced"}const E=function(k,U){return k.getTransceivers().find(G=>G.sender.track===U||G.receiver.track===U)}(this.peerConnection,n._mediaStreamTrack),f=qu(n);if(I1(n)&&E&&r&&f&&this.getLocalVideoStats&&Mt(a=["vp8","vp9"]).call(a,this.store.codec)){var T;const k=l.degradationPreference||(Mt(T=n._hints).call(T,vn.CUSTOM_TRACK)?J("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(U,G,W,$,rt,ot){if(kC(U,W),rt(G),$!=="balanced"&&$!=="maintain-framerate"&&$!=="maintain-resolution")return;let Et=-1;PE(U,G);const vt=window.setInterval(()=>{const wt=LC.get(U);if(!J("ENABLE_AG_ADAPTATION")||!wt)return kC(U,W),void rt(G);const $t=ot();if($t.sendPackets>0&&$t.OutgoingAvailableBandwidth>0){if(Et===-1)return void(Et=Date.now());if(Date.now()-Et<1e3)return;const Ye=$t.sendFrameRate,bn=$t.OutgoingAvailableBandwidth,[ri,mr]=v1(U,Ye,bn,wt.adaptationConfig,G,$);mr&&(W.qualityLimitationReason=mr),ri&&wt.adaptationConfig.scale!==ri.scale&&(N.debug("[".concat(U,"] applyAdaptation: ").concat(W.qualityLimitationReason,`
           sendFps `).concat(Ye,", bwe ").concat(bn,", switch from ").concat(wt.adaptationConfig.scale," to ").concat(ri.scale," ")),wt.adaptationConfig=PC(PC({},wt.adaptationConfig),ri),rt(ri))}},J("CHECK_LOCAL_STATS_INTERVAL")),Lt=PC({},G);LC.set(U,{timer:vt,adaptationConfig:Lt,originConfig:G,adaptationFunc:rt}),N.debug("[".concat(U,"] start adaptation, originConfig: ").concat(JSON.stringify(G),", degradationPreference: ").concat($))})(this.id+E.mid,f,this,k,U=>{r&&this.updateAdaptation(r,U)},this.getLocalVideoStats.bind(this))}if(n._encoderConfig){var R;const{bitrateMax:k,frameRate:U,scaleResolutionDownBy:G}=n._encoderConfig;k&&(p.maxBitrate=1e3*k),(Mt(R=n._hints).call(R,vn.LOW_STREAM)||n.isUseScaleResolutionDownBy)&&(U&&(p.maxFramerate=Fo(U)),G&&G>=1&&(p.scaleResolutionDownBy=G))}const{maxFramerate:v}=J("ENCODER_CONFIG_LIMIT");if(v&&typeof v=="number"&&(p.maxFramerate=p.maxFramerate?Math.min(p.maxFramerate,v):v),J("DSCP_TYPE")&&Il()){var y;const k=J("DSCP_TYPE");Mt(y=["very-low","low","medium","high"]).call(y,k)&&(p.networkPriority=k)}const w=r.getParameters(),B=(d=w.encodings)===null||d===void 0?void 0:d[0];Ii()&&!B&&(l.encodings=[p]),B&&Object.assign(B,p),Object.assign(w,l),N.debug("[".concat(n.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(w.encodings))),await r.setParameters(w),await async function(k,U,G){try{var W;if(!nn().supportSetRtpSenderParameters||!function(vt){return vt==="vp9"}(k)||!J("ENABLE_SVC"))return;const $={},rt={},ot=U.getParameters(),Et=(W=ot.encodings)===null||W===void 0?void 0:W[0];rt.scalabilityMode=uC(G),Et&&Object.assign(Et,rt),Object.assign(ot,$),await U.setParameters(ot),N.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(ot.encodings)))}catch($){N.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",$)}}(this.store.codec,r,J("SVC_MODE"))}async updateAdaptation(n,r){var a,d;if(!n)return N.debug("[updateAdaptation] no rtpSender found");if(!nn().supportSetRtpSenderParameters)return N.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const l={},{bitrateMax:p,frameRate:E,scaleResolutionDownBy:f}=r;p&&(l.maxBitrate=1e3*p),E&&(l.maxFramerate=Fo(E)),f&&f>=1&&Mt(a=["vp8","vp9"]).call(a,this.store.codec)&&(l.scaleResolutionDownBy=f);const T=n.getParameters(),R=(d=T.encodings)===null||d===void 0?void 0:d[0];R&&Object.assign(R,l),Object.assign(T,{});try{await n.setParameters(T),N.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(T.encodings)))}catch(v){!("transport"in n)||n.transport&&n.transport.state==="connected"?this.peerConnectionState!=="connected"?N.debug("[updateAdaptation] peerConnection not connected}"):N.debug("[updateAdaptation] updateRtpSenderEncodings failed",v):N.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(n,r){try{if(!nn().supportSetRtpSenderParameters||n.length!==r.length)return;for(let a=0;a<n.length;a++){const d=n[a],l=r[a];l instanceof qn&&!this.isVP8Simulcast(l)&&await this.updateRtpSenderEncodings(l,d.sender)}}catch{N.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(n,r,a){const d=Qr.parse(n);return r.forEach((l,p)=>{const E=a[p],f=d.mediaDescriptions.find(T=>T.attributes.mid===E);f&&(Up(f,l),e1(f,l,this.store.codec))}),Qr.print(d)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=n=>{var r;(r=this.onFirstAudioReceived)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstVideoReceived=n=>{var r;(r=this.onFirstVideoReceived)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstAudioDecoded=n=>{var r;(r=this.onFirstAudioDecoded)===null||r===void 0||r.call(this,n)},this.statsFilter.onFirstVideoDecoded=(n,r,a)=>{var d;(d=this.onFirstVideoDecoded)===null||d===void 0||d.call(this,n,r,a)},this.statsFilter.onSelectedLocalCandidateChanged=(n,r)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,n,r)},this.statsFilter.onSelectedRemoteCandidateChanged=(n,r)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,n,r)},this.statsFilter.onFirstVideoDecodedTimeout=n=>{var r;(r=this.onFirstVideoDecodedTimeout)===null||r===void 0||r.call(this,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(n,r){if(n.length===r.length)for(let f=0;f<n.length;f++){var a,d,l,p,E;const T=n[f],R=r[f];if(R instanceof qn&&!Mt(a=R._hints).call(a,vn.LOW_STREAM)&&(d=R._encoderConfig)!==null&&d!==void 0&&d.bitrateMax&&((l=R._encoderConfig)===null||l===void 0?void 0:l.bitrateMax)>200&&(p=R._scalabilityMode)!==null&&p!==void 0&&p.numSpatialLayers&&((E=R._scalabilityMode)===null||E===void 0?void 0:E.numSpatialLayers)>1&&this.store.codec==="vp8"){const v={},y={high:1e3*(R._encoderConfig.bitrateMax-50),medium:5e4};v.encodings=[{rid:"m",active:!0,maxBitrate:y.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:y.high}];const w=T.sender.getParameters();await T.sender.setParameters(Object.assign(w,v))}}}async applySimulcastEncodings(n,r){if(!Ii()&&n.length===r.length)for(let a=0;a<n.length;a++){const d=r[a];if(d instanceof qn&&this.isVP8Simulcast(d)){const l=n[a],p={},E={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:E.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:E.medium,scaleResolutionDownBy:4}];const f=l.sender.getParameters();await l.sender.setParameters(Object.assign(f,p))}}}isVP8Simulcast(n){var r,a,d,l,p;return!!(n instanceof qn&&J("SIMULCAST")&&this.store.codec==="vp8"&&!Mt(r=n._hints).call(r,vn.LOW_STREAM)&&(a=n._encoderConfig)!==null&&a!==void 0&&a.bitrateMax&&((d=n._encoderConfig)===null||d===void 0?void 0:d.bitrateMax)>200&&(l=n._scalabilityMode)!==null&&l!==void 0&&l.numSpatialLayers&&((p=n._scalabilityMode)===null||p===void 0?void 0:p.numSpatialLayers)>1)}logSDPExchange(n,r,a,d){if(J("SDP_LOGGING"))return N.upload("[".concat(this.store.clientId,"] exchanging ").concat(a," ").concat(r," SDP during P2PConnection.").concat(d,`
`),n),r==="offer"?l=>{this.logSDPExchange(l,"answer",a==="local"?"remote":"local",d)}:void 0}async getRemoteSSRC(n){if(!this.remoteSDP)return;const r=this.remoteSDP.getSSRC(n);return r&&r.length!==0?r[0].ssrcId:void 0}setConfiguration(n){if(nn().supportPCSetConfiguration){const r=GO.resolvePCConfiguration(n);this.peerConnection.setConfiguration(r)}}},jt(qe.prototype,"updateRemoteRTPCapabilities",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"updateRemoteRTPCapabilities"),qe.prototype),jt(qe.prototype,"connect",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"connect"),qe.prototype),jt(qe.prototype,"updateRemoteConnect",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"updateRemoteConnect"),qe.prototype),jt(qe.prototype,"createDataChannels",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"createDataChannels"),qe.prototype),jt(qe.prototype,"receive",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"receive"),qe.prototype),jt(qe.prototype,"batchReceive",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"batchReceive"),qe.prototype),jt(qe.prototype,"stopReceiving",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"stopReceiving"),qe.prototype),jt(qe.prototype,"muteRemote",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"muteRemote"),qe.prototype),jt(qe.prototype,"unmuteRemote",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"unmuteRemote"),qe.prototype),jt(qe.prototype,"muteLocal",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"muteLocal"),qe.prototype),jt(qe.prototype,"unmuteLocal",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"unmuteLocal"),qe.prototype),jt(qe.prototype,"close",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"close"),qe.prototype),jt(qe.prototype,"updateEncoderConfig",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"updateEncoderConfig"),qe.prototype),jt(qe.prototype,"updateSendParameters",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"updateSendParameters"),qe.prototype),jt(qe.prototype,"replaceTrack",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"replaceTrack"),qe.prototype),jt(qe.prototype,"updateAdaptation",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"updateAdaptation"),qe.prototype),jt(qe.prototype,"getRemoteSSRC",[ao],Object.getOwnPropertyDescriptor(qe.prototype,"getRemoteSSRC"),qe.prototype),qe);function ao(t,n,r){const a=t[n];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const d=this.mutex,l=await d.lock("From P2PConnection.".concat(n));try{for(var p=arguments.length,E=new Array(p),f=0;f<p;f++)E[f]=arguments[f];return await a.apply(this,E)}finally{l()}},r}var je;function y1(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Od(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?y1(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):y1(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}function Gc(t){var n,r,a,d=2;for(typeof Symbol<"u"&&(r=ws,a=Symbol.iterator);d--;){if(r&&(n=t[r])!=null)return n.call(t);if(a&&(n=t[a])!=null)return new Tn(n.call(t));r="@@asyncIterator",a="@@iterator"}throw new TypeError("Object is not async iterable")}function Tn(t){function n(r){if(Object(r)!==r)return Bt.reject(new TypeError(r+" is not an object."));var a=r.done;return Bt.resolve(r.value).then(function(d){return{value:d,done:a}})}return Tn=function(r){this.s=r,this.n=r.next},Tn.prototype={s:null,n:null,next:function(){return n(this.n.apply(this.s,arguments))},return:function(r){var a=this.s.return;return a===void 0?Bt.resolve({value:r,done:!0}):n(a.apply(this.s,arguments))},throw:function(r){var a=this.s.return;return a===void 0?Bt.reject(r):n(a.apply(this.s,arguments))}},new Tn(t)}let rh=(je=class extends An{get state(){return this._state}set state(t){const n=this._state;this._state=t,this.emit(ge.StateChange,n,this._state)}constructor(t,n){super(),F(this,"isPlanB",void 0),F(this,"store",void 0),F(this,"statsUploader",void 0),F(this,"connection",void 0),F(this,"localTrackMap",new Map),F(this,"remoteUserMap",new Map),F(this,"localDataChannels",[]),F(this,"remoteDataChannelMap",new Map),F(this,"pendingLocalTracks",[]),F(this,"pendingRemoteTracks",[]),F(this,"pendingLocalDataChannels",[]),F(this,"pendingRemoteDataChannels",[]),F(this,"statsCollector",void 0),F(this,"shouldForwardP2PCreation",void 0),F(this,"iceFailedCount",0),F(this,"dtlsFailedCount",0),F(this,"mutex",void 0),F(this,"_state",gn.Disconnected),F(this,"_pcStatsUploadType",J("NEW_ICE_RESTART")?pd.FIRST_CONNECTION:pd.OLD_FIRST_CONNECTION),F(this,"_isInRestartIce",!1),F(this,"_isStartRestartIce",!1),F(this,"_restartStates",["disconnected","failed"]),F(this,"_restartTimer",void 0),F(this,"_isFirstConnected",!0),F(this,"handleMuteLocalTrack",async(r,a,d)=>{const l=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==gn.Connected)return void d(new _t(H.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const p=this.filterTobeMutedTracks(r);if(p.length===0)return void a();const E=p.find(T=>T[0]==="videoLowTrack");E&&E[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(p.map(T=>{let[,{id:R}]=T;return R}));const f=this.createMuteMessage(p);await On(this,ge.RequestMuteLocal,f),a()}catch(p){d(p)}finally{l()}}),F(this,"handleUnmuteLocalTrack",async(r,a,d)=>{const l=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==gn.Connected)return void d(new _t(H.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const p=this.filterTobeUnmutedTracks(r);if(p.length===0)return void a();const E=p.find(T=>T[0]==="videoLowTrack");if(E){const T=E[1];if(T.track._originMediaStreamTrack.stop(),!J("DISABLE_DUAL_STREAM_USE_ENCODING")&&nn().supportDualStreamEncoding){const R=r._mediaStreamTrack.clone();T.track._mediaStreamTrack=R,T.track._originMediaStreamTrack=R}else{const R=cu(r,Cf(this,ge.RequestLowStreamParameter));T.track._mediaStreamTrack=R,T.track._originMediaStreamTrack=R}await new Bt((R,v)=>{this.handleReplaceTrack(T.track,R,v,!0)})}await this.connection.unmuteLocal(p.map(T=>{let[,{id:R}]=T;return R}));const f=this.createUnmuteMessage(p);await On(this,ge.RequestUnmuteLocal,f),a()}catch(p){d(p)}finally{l()}}),F(this,"handleUpdateVideoEncoder",async(r,a,d)=>{const l=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const p=this.localTrackMap.get(At.LocalVideoTrack);if(!this.connection||!p||p.track!==r||this.state!==gn.Connected)return void a();const{id:E,track:f}=p;await this.connection.updateSendParameters(E,f),await this.connection.updateEncoderConfig(E,f),this.emit(ge.UpdateVideoEncoder,f),a()}catch(p){d(p)}finally{l()}}),F(this,"handleUpdateVideoSendParameters",async(r,a,d)=>{const l=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const p=this.localTrackMap.get(At.LocalVideoTrack);if(!this.connection||!p||p.track!==r||this.state!==gn.Connected)return void a();const{id:E,track:f}=p;await this.connection.updateSendParameters(E,f),a()}catch(p){d(p)}finally{l()}}),F(this,"handleReplaceMixingTrack",async(r,a,d,l)=>{if(!this.connection||this.state!==gn.Connected)return void a();const p=yC([r]);let E;N.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(p.getTrackId(),"]")),typeof l=="boolean"&&l||(E=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(r,p),a()}catch(T){d(T)}finally{var f;(f=E)===null||f===void 0||f()}}),F(this,"handleReplaceTrack",async(r,a,d,l)=>{let p;N.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(r.getTrackId(),"]")),typeof l=="boolean"&&l||(p=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var E;const T=Array.from(this.localTrackMap.entries()).find(R=>{let[,{track:v}]=R;return r===v});if(!this.connection||!T||this.state!==gn.Connected)return void a();if(await((E=this.connection)===null||E===void 0?void 0:E.replaceTrack(r,T[1].id)),this.isPlanB){const R=T[1];R.id=r._mediaStreamTrack.id,this.localTrackMap.set(T[0],R)}if(T[0]===At.LocalVideoTrack&&!J("DISABLE_DUAL_STREAM_USE_ENCODING")&&nn().supportDualStreamEncoding){const R=this.localTrackMap.get(At.LocalVideoLowTrack);if(R){const v=r._mediaStreamTrack.clone();R.track._originMediaStreamTrack.stop(),R.track._mediaStreamTrack=v,R.track._originMediaStreamTrack=v,await new Bt((y,w)=>{this.handleReplaceTrack(R.track,y,w,!0)})}}a()}catch(T){d(T)}finally{var f;(f=p)===null||f===void 0||f()}}),F(this,"handleGetRTCStats",r=>{r(this.statsCollector.getRTCStats())}),F(this,"handleGetLocalVideoStats",r=>{r(this.statsCollector.getLocalVideoTrackStats())}),F(this,"handleGetLocalAudioStats",r=>{r(this.statsCollector.getLocalAudioTrackStats())}),F(this,"handleGetRemoteVideoStats",r=>this.statsCollector.getRemoteVideoTrackStats(r.uid)[r.uid]),F(this,"handleGetRemoteAudioStats",r=>this.statsCollector.getRemoteAudioTrackStats(r.uid)[r.uid]),this.store=t,this.statsCollector=n,this.statsCollector.addP2PChannel(this),this.statsUploader=new E1(this.store),this.bindStatsUploaderEvents(),this.mutex=new Yr("P2PChannel-mutex",this.store.clientId),this.isPlanB=!nn().supportUnifiedPlan||J("CHROME_FORCE_PLAN_B")&&Il(),this.shouldForwardP2PCreation=J("FORWARD_P2P_CREATION")&&nn().supportPCSetConfiguration&&hb(),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new tl({},this.store):new jc({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t){var n;this.state=gn.New;const r=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!r||(r&&this.connection&&(N.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.isPlanB?new tl(t,this.store):new jc(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new _t(H.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=J("NEW_ICE_RESTART")?pd.FIRST_CONNECTION:pd.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t){if(!this.connection)throw new _t(H.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");J("ENABLE_PREALLOC_PC")&&this.state===gn.Connected?await this.connection.updateRemoteConnect(t):(this.store.peerConnectionStart(),await this.connection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=gn.Connected)}updateRemoteRTPCapabilities(t){const n=Array.from(this.localTrackMap.entries()).filter(d=>{var l;let[p]=d;return Mt(l=[At.LocalVideoLowTrack,At.LocalVideoTrack]).call(l,p)}),r=n.map(d=>{let[,{id:l}]=d;return l}),a=n.map(d=>{let[l]=d;return l});if(this.connection instanceof jc){if(ee.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(a),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!Mt(t).call(t,this.store.codec)){const d=["vp9","vp8","h264"].find(l=>Mt(t).call(t,l));d&&(this.store.codec=d,N.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(d,".")))}this.connection.updateRemoteRTPCapabilities(r,t)}}async getEstablishParams(){var t;if(this.connection instanceof jc&&this.connection.peerConnectionState!=="closed"&&Mt(t=[gn.New,gn.Connected]).call(t,this.state))return this.connection.establishPromise}async publishDataChannel(t){if(!this.connection||this.state!==gn.Connected){if(this.state===gn.Disconnected)throw new _t(H.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach(r=>{var a;Mt(a=this.pendingLocalDataChannels).call(a,r)||this.pendingLocalDataChannels.push(r)}),[]}const n=this.filterTobePublishedDataChannels(t);return n.length===0?[]:(n.forEach(r=>{const a=Date.now();this.store.publish(r.id.toString(),"datachannel",a)}),await this.connection.createDataChannels(this.store.uid,n),n.forEach(r=>{this.localDataChannels.push(r);const a=Date.now();this.store.publish(r.id+"","datachannel",void 0,a)}),t.map(r=>({streamId:r.id,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:r.metadata,channelId:r._originDataChannelId})))}publish(t,n,r){var a=this;return oa(function*(){const d=yield Ae(a.mutex.lock("From P2PChannel.publish"));try{if(!a.connection||a.state!==gn.Connected){if(a.state===gn.Disconnected)throw new _t(H.UNEXPECTED_ERROR,"PeerConnection already disconnected.");a.throwIfTrackTypeNotMatch(t);const p=t.filter(E=>a.pendingLocalTracks.indexOf(E)===-1);return void(a.pendingLocalTracks=a.pendingLocalTracks.concat(p))}a.store.pubId=a.store.pubId+1,Pr.markPublishStart(a.store.clientId,a.store.pubId);const l=a.filterTobePublishedTracks(t,n,r);if(l.length===0)return void(yield Ae(a.tryToUnmuteAudio(t)));yield*aa(Gc(a.doPublish(a.connection,l)))}finally{d()}})()}doPublish(t,n){var r=this;return oa(function*(){n.forEach(v=>{let{track:y,type:w}=v;const B=Date.now();r.store.publish(y.getTrackId(),w===At.LocalAudioTrack?"audio":"video",B)}),r.bindLocalTrackEvents(n);const a=n.map(v=>{let{track:y}=v;return y}),d=yield Ae(t.send(a,r.store.codec,r.store.audioCodec)),l=(yield Ae(d.next())).value,p=r.createGatewayPublishMessage(n,l);let E;try{E=yield p}catch(v){throw d.throw(v),(v==null?void 0:v.code)===H.WS_ABORT&&n.forEach(y=>{let{track:w}=y;r.pendingLocalTracks.indexOf(w)===-1&&r.pendingLocalTracks.push(w)}),r.unbindLocalTrackEvents(n),v}const f=r.mapPubResToRemoteConfig(p,E,a),T=(yield Ae(d.next(f))).value,R=J("ENABLE_VIDEO_SEI");a.forEach(async v=>{const y=v.getRTCRtpTransceiver();y&&R&&(v.trackMediaType===Kt.VIDEO?await oG(y.sender,v):v.trackMediaType===Kt.AUDIO&&await async function(w){if(!nn().supportWebRTCEncodedTransform)return void N.warning("browser not support audio encoded transform");if(aC.has(w)||!w.track)return;const B={track:w.track};if(Ac()){if(!w.createEncodedStreams)return void N.warning("browser not support createEncodedStreams() API");let U=null;try{U=w.createEncodedStreams()}catch(W){return void N.error("create audio-encoded-streams error",W&&W.message)}const G=new TransformStream({transform(W,$){B.controller||(B.controller=$),w.track&&w.track.id!==B.track.id&&(N.debug("audio track changed: ".concat(B.track.id," => ").concat(w.track.id)),B.track.removeEventListener("ended",k),B.track=w.track,B.track.addEventListener("ended",k)),$.enqueue(W)}});U.readable.pipeThrough(G).pipeTo(U.writable)}else if(vr()){if(typeof RTCRtpScriptTransform>"u")return void N.warning("browser not support RTCRtpScriptTransform");const U=oC(),G=new MessageChannel;await new Bt($=>U.onmessage=rt=>{rt.data==="registered"&&$(void 0)});const W=new RTCRtpScriptTransform(U,{name:"tx",port:G.port2},[G.port2]);w.transform=W,await new Bt($=>U.onmessage=rt=>{rt.data==="started"&&$(void 0)}),G.port1.onmessage=$=>{var rt;$.data.transformed&&w.track&&((rt=w.track)===null||rt===void 0?void 0:rt.id)!==B.track.id&&(N.debug("audio track changed: ".concat(B.track.id," => ").concat(w.track.id)),B.track.removeEventListener("ended",k),B.track=w.track,B.track.addEventListener("ended",k))},B.worker=U}function k(){if(w.track){if(this.id!==w.track.id)return;w.track.removeEventListener("ended",k)}const U=aC.get(w);if(U){aC.delete(w);try{var G,W;(G=U.controller)===null||G===void 0||G.terminate(),(W=U.worker)===null||W===void 0||W.terminate()}catch($){N.warning($&&$.message)}}}aC.set(w,B),w.track.addEventListener("ended",k)}(y.sender))}),n.forEach(v=>{let{type:y}=v;r.statsCollector.addLocalStats(y)}),r.assignLocalTracks(n,T),r.statsUploader.startUploadOutboundStats(),n.forEach(v=>{let{track:y,type:w}=v;const B=Date.now();r.store.publish(y.getTrackId(),w===At.LocalAudioTrack?"audio":"video",void 0,B)})})()}async updateVideoStreamParameter(t,n){const r=this.localTrackMap.get(n);if(!r)return;if(!(r.track instanceof qn))return N.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof jc||this.connection instanceof tl))return N.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:a}=r,d=function(l,p){const E={};return l.height&&l.width&&(E.scaleResolutionDownBy=Wu(l,p)),E.maxFramerate=l.framerate?Fo(l.framerate):void 0,E.maxBitrate=l.bitrate?1e3*l.bitrate:void 0,E}(t,a);if(a._encoderConfig||(a._encoderConfig={}),n!==At.LocalVideoLowTrack||!J("DISABLE_DUAL_STREAM_USE_ENCODING")&&nn().supportDualStreamEncoding)d.scaleResolutionDownBy!=null&&(a._encoderConfig.scaleResolutionDownBy=d.scaleResolutionDownBy);else{const l=a._originMediaStreamTrack;if(!l.canvas)return N.warn("[".concat(a.getTrackId(),"] no canvas on track"));(function(p,E){const f=p.canvas;E.width&&(f.width=Fo(E.width)),E.height&&(f.height=Fo(E.height)),E.framerate&&(f.stopCapture&&f.stopCapture(),f.stopCapture=dg(()=>{!f.startCapture&&f.stopCapture&&f.stopCapture(),f.startCapture&&f.startCapture()},Fo(E.framerate)))})(l,t)}d.maxBitrate!=null&&(a._encoderConfig.bitrateMax=d.maxBitrate/1e3),d.maxFramerate!=null&&(a._encoderConfig.frameRate&&typeof a._encoderConfig.frameRate=="object"?a._encoderConfig.frameRate.max=d.maxFramerate:a._encoderConfig.frameRate={max:d.maxFramerate}),N.debug("[".concat(a.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(a._encoderConfig))),await this.connection.updateRtpSenderEncodings(a)}publishLowStream(t){var n=this;return oa(function*(){if(!n.connection||n.state!==gn.Connected)return;const r=yield Ae(n.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const d=n.localTrackMap.get(At.LocalVideoTrack);if(!d)throw new _t(H.UNEXPECTED_ERROR,"Could not find high stream");if(n.localTrackMap.has(At.LocalVideoLowTrack))throw new _t(H.UNEXPECTED_ERROR,"[".concat(n.store.clientId,"] Can't publish low stream when stream already publish"));const l=[{track:n.getLowVideoTrack(d.track,t),type:At.LocalVideoLowTrack}];if(yield*aa(Gc(n.doPublish(n.connection,l))),d.track.muted||!d.track.enabled){var a;const p=(a=n.localTrackMap.get(At.LocalVideoLowTrack))===null||a===void 0?void 0:a.id;p!==void 0&&(yield Ae(n.connection.muteLocal([p])))}}finally{r()}})()}async republish(){this.pendingLocalTracks.length>0&&(N.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Kr(this,ge.RequestRePublish,this.pendingLocalTracks),this.emit(ge.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(N.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Kr(this,ge.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(t){for(let n=this.pendingRemoteTracks.length-1;n>=0;n--){const{user:r,kind:a}=this.pendingRemoteTracks[n];(a!==Kt.AUDIO||r._audio_added_&&r._audioSSRC)&&(a!==Kt.VIDEO||r._video_added_&&r._videoSSRC)||this.pendingRemoteTracks.splice(n,1)}if(t)await Kr(this,ge.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:n,kind:r}of this.pendingRemoteTracks)await this.subscribe(n,r,r===Kt.VIDEO?n._videoSSRC:n._audioSSRC);this.pendingRemoteTracks.forEach(n=>{let{user:r}=n;this.emit(ge.MediaReconnectEnd,r.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==gn.Connected)return void t.forEach(a=>{const d=this.pendingLocalTracks.indexOf(a);d!==-1&&this.pendingLocalTracks.splice(d,1)});const n=this.filterTobeUnpublishedTracks(t);if(n.length===0)return;const r=n.find(a=>a[0]==="videoLowTrack");return r&&r[1].track.close(),this.doUnpublish(this.connection,n)}async unpublishDataChannel(t){if(!this.connection||this.state!==gn.Connected)return void t.forEach(r=>{const a=this.pendingLocalDataChannels.indexOf(r);a!==-1&&this.pendingLocalDataChannels.splice(a,1)});const n=this.filterTobeUnpublishedDataChannels(t);return n.length!==0?(n.forEach(r=>{const a=this.localDataChannels.indexOf(r);a!==-1&&this.localDataChannels.splice(a,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),n.map(r=>r.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==gn.Connected)return;const t=this.localTrackMap.get(At.LocalVideoLowTrack);if(!t)return;t.track.close();const n=[[At.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,n)}async doUnpublish(t,n){const r=this.createGatewayUnpublishMessage(n);return await t.stopSending(n.map(a=>{let[,{id:d}]=a;return d})),this.withdrawLocalTracks(n),this.unbindLocalTrackEvents(n.map(a=>{let[d,{track:l}]=a;return{type:d,track:l}})),n.forEach(a=>{let[d]=a;this.statsCollector.removeLocalStats(d)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),r}async subscribeDataChannel(t,n){if(!this.connection||this.state!==gn.Connected)throw new _t(H.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const r=n.filter(a=>{var d;return!((d=this.remoteDataChannelMap.get(t))!==null&&d!==void 0&&d.get(a.id))});if(r.length!==0)return await this.connection.createDataChannels(t.uid,r),r.forEach(a=>{var d;this.remoteDataChannelMap.has(t)?(d=this.remoteDataChannelMap.get(t))===null||d===void 0||d.set(a.id,a):this.remoteDataChannelMap.set(t,new Map([[a.id,a]]));const l=this.pendingRemoteDataChannels.findIndex(p=>{let{user:E,id:f}=p;return E.uid===t.uid&&f===a.id});l!==-1&&this.pendingRemoteDataChannels.splice(l,1)}),r.map(a=>a.id)}async subscribe(t,n,r,a,d){var l;if(!this.connection||this.state!==gn.Connected)throw new _t(H.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((l=this.remoteUserMap.get(t))!==null&&l!==void 0&&l.has(n))return;let p,E,f;const T=this.connection.getPreMedia(r);if(T)N.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(r,", no need to send sub to gateway.")),f=T.transceiver,p=T.track,E=T.id;else if(d){const y=d.find(B=>{let{stream_type:k}=B;return k===n});if(!y)throw new _t(H.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(n," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(n,"."));const w=await this.connection.receive(n,y.ssrcs,String(t._uintid),y.attributes);this.connection instanceof jc&&(f=w.transceiver),p=w.track,E=w.id}else{const y=await this.connection.receive(n,[{ssrcId:r,rtx:a}],String(t._uintid),void 0);this.connection instanceof jc&&(f=y.transceiver),p=y.track,E=y.id}n===Kt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(p):(t._audioTrack=new Lp(p,t.uid,t._uintid,this.store),N.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),f&&t._audioTrack._updateRtpTransceiver(f),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(p):(t._videoTrack=new zl(p,t.uid,t._uintid,this.store),N.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),f&&t._videoTrack._updateRtpTransceiver(f),this.bindRemoteTrackEvents(t,t._videoTrack)),J("ENABLE_VIDEO_SEI")&&f&&(n==Kt.VIDEO?await async function(y){let w=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!nn().supportWebRTCEncodedTransform)return void N.warning("browser not support video encoded transform");if(!y.track)return;if(vg.has(y)){const U=vg.get(y);return void(U&&(U.onSei=w.onSei))}const B={track:y.track,onSei:w.onSei};if(Ac()){if(!y.createEncodedStreams)return void N.warning("browser not support createEncodedStreams() API");let U=null;try{U=y.createEncodedStreams()}catch(W){return void N.error("create video-encoded-streams error",W&&W.message)}const G=new TransformStream({transform(W,$){B.controller||(B.controller=$),y.track&&y.track.id!==B.track.id&&(N.debug("video track changed: ".concat(B.track.id," => ").concat(y.track.id)),B.track.removeEventListener("ended",k),B.track=y.track,B.track.addEventListener("ended",k));const rt=function(ot){const Et=new DataView(ot.data);let vt=0;for(;vt+4<ot.data.byteLength;){if(Et.getUint8(vt+0)===0&&Et.getUint8(vt+1)===0&&Et.getUint8(vt+2)===0&&Et.getUint8(vt+3)===1&&Et.getUint8(vt+4)===6){let Lt=vt+6,wt=0,$t=0;for(;($t=Et.getUint8(Lt++))===255;)wt+=255;wt+=$t;const Ye=Gw(ot.data,Lt,wt);return new Uint8Array(Ye)}vt++}return null}(W);rt&&B.onSei&&B.onSei(rt),$.enqueue(W)}});U.readable.pipeThrough(G).pipeTo(U.writable)}else if(vr()){if(typeof RTCRtpScriptTransform>"u")return void N.warning("browser not support RTCRtpScriptTransform");const U=oC(),G=new MessageChannel;await new Bt($=>U.onmessage=rt=>{rt.data==="registered"&&$(void 0)});const W=new RTCRtpScriptTransform(U,{name:"rx",port:G.port2},[G.port2]);y.transform=W,await new Bt($=>U.onmessage=rt=>{rt.data==="started"&&$(void 0)}),G.port1.onmessage=$=>{var rt;$.data.transformed&&y.track&&((rt=y.track)===null||rt===void 0?void 0:rt.id)!==B.track.id?(N.debug("video track changed: ".concat(B.track.id," => ").concat(y.track.id)),B.track.removeEventListener("ended",k),B.track=y.track,B.track.addEventListener("ended",k)):$.data.sei&&B.onSei&&B.onSei($.data.sei)},B.worker=U}function k(){if(y.track){if(this.id!==y.track.id)return;y.track.removeEventListener("ended",k)}(function(U){const G=vg.get(U);if(G){vg.delete(U);try{var W,$;(W=G.controller)===null||W===void 0||W.terminate(),($=G.worker)===null||$===void 0||$.terminate()}catch(rt){N.warning(rt&&rt.message)}}})(y)}vg.set(y,B),y.track.addEventListener("ended",k)}(f.receiver,{onSei:y=>{var w;(w=t._videoTrack)===null||w===void 0||w._onSei(y)}}):n==Kt.AUDIO&&await async function(y){if(!nn().supportWebRTCEncodedTransform)return void N.warning("browser not support audio encoded transform");if(cC.has(y))return;const w={track:y.track};if(Ac()){if(!y.createEncodedStreams)return void N.warning("browser not support createEncodedStreams() API");let k=null;try{k=y.createEncodedStreams()}catch(G){return void N.error("create audio-encoded-streams error",G&&G.message)}const U=new TransformStream({transform(G,W){w.controller||(w.controller=W),y.track&&y.track.id!==w.track.id&&(N.debug("audio track changed: ".concat(w.track.id," => ").concat(y.track.id)),w.track.removeEventListener("ended",B),w.track=y.track,w.track.addEventListener("ended",B)),W.enqueue(G)}});k.readable.pipeThrough(U).pipeTo(k.writable)}else if(vr()){if(typeof RTCRtpScriptTransform>"u")return void N.warning("browser not support RTCRtpScriptTransform");const k=oC(),U=new MessageChannel;await new Bt(W=>k.onmessage=$=>{$.data==="registered"&&W(void 0)});const G=new RTCRtpScriptTransform(k,{name:"rx",port:U.port2},[U.port2]);y.transform=G,await new Bt(W=>k.onmessage=$=>{$.data==="started"&&W(void 0)}),U.port1.onmessage=W=>{var $;W.data.transformed&&y.track&&(($=y.track)===null||$===void 0?void 0:$.id)!==w.track.id&&(N.debug("audio track changed: ".concat(w.track.id," => ").concat(y.track.id)),w.track.removeEventListener("ended",B),w.track=y.track,w.track.addEventListener("ended",B))},w.worker=k}function B(){y.track.removeEventListener("ended",B),function(k){const U=cC.get(k);if(U){cC.delete(k);try{var G,W;(G=U.controller)===null||G===void 0||G.terminate(),(W=U.worker)===null||W===void 0||W.terminate()}catch($){N.warning($&&$.message)}}}(y)}cC.set(y,w),y.track.addEventListener("ended",B)}(f.receiver));const R=this.remoteUserMap.get(t);R?R.set(n,E):this.remoteUserMap.set(t,new Map([[n,E]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const v=this.pendingRemoteTracks.findIndex(y=>{let{user:w,kind:B}=y;return w.uid===t.uid&&n===B});v!==-1&&(this.pendingRemoteTracks.splice(v,1),this.emit(ge.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==gn.Connected)throw new _t(H.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(d=>{var l;let{user:p,mediaType:E}=d;return!((l=this.remoteUserMap.get(p))!==null&&l!==void 0&&l.has(E))});const n=[],r=new Map;t.forEach(d=>{if(!this.connection)return;const l=this.connection.getPreMedia(d.ssrcId);l?r.set(d.ssrcId,l):n.push(d)});const a=await this.connection.batchReceive(n.map(d=>{let{user:l,mediaType:p,ssrcId:E,rtxSsrcId:f}=d;return{kind:p,ssrcMsg:[{ssrcId:E,rtx:f}],mslabel:String(l._uintid)}}));n.forEach((d,l)=>{r.set(d.ssrcId,a[l])}),t.forEach(d=>{let{user:l,mediaType:p,ssrcId:E}=d;const f=r.get(E);if(!f)return void N.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(l.uid," subscribe data,").concat(p,", ").concat(E));const{track:T,id:R,transceiver:v}=f;p===Kt.AUDIO?(l._audioTrack?l._audioTrack._updateOriginMediaStreamTrack(T):(l._audioTrack=new Lp(T,l.uid,l._uintid,this.store),N.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(l._audioTrack.getTrackId()))),v&&l._audioTrack._updateRtpTransceiver(v),this.bindRemoteTrackEvents(l,l._audioTrack)):(l._videoTrack?l._videoTrack._updateOriginMediaStreamTrack(T):(l._videoTrack=new zl(T,l.uid,l._uintid,this.store),N.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(l._videoTrack.getTrackId()))),v&&l._videoTrack._updateRtpTransceiver(v),this.bindRemoteTrackEvents(l,l._videoTrack));const y=this.remoteUserMap.get(l);y?y.set(p,R):this.remoteUserMap.set(l,new Map([[p,R]])),this.statsCollector.addRemoteStats(l.uid),this.statsUploader.startUploadInboundStats();const w=this.pendingRemoteTracks.findIndex(B=>{let{user:k,kind:U}=B;return k.uid===l.uid&&p===U});w!==-1&&(this.pendingRemoteTracks.splice(w,1),this.emit(ge.MediaReconnectEnd,l.uid))})}async unsubscribe(t,n,r){const a=this.pendingRemoteTracks.filter(p=>{let{user:E,kind:f}=p;return n!==void 0?E.uid===t.uid&&n===f:E.uid===t.uid});if(a.forEach(p=>{const E=this.pendingRemoteTracks.indexOf(p);this.pendingRemoteTracks.splice(E,1)}),this.connection&&this.state===gn.Connected||r||a.forEach(p=>{let{kind:E}=p;var f;if(E===Kt.AUDIO)(f=t._audioTrack)===null||f===void 0||f._destroy(),t._audioTrack=void 0;else if(E===Kt.VIDEO){var T;(T=t._videoTrack)===null||T===void 0||T._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==gn.Connected)return;const d=this.filterTobeUnSubscribedTracks(t,n);if(d.length===0)return;await this.connection.stopReceiving(d.map(p=>{let[,{id:E}]=p;return E}));const l=this.createUnsubscribeMessage(d);return this.withdrawRemoteTracks(d),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),d.forEach(p=>{let[E,{kind:f}]=p;var T,R;if(f===Kt.VIDEO&&E._videoSSRC&&((T=this.connection)===null||T===void 0||T.setStatsRemoteVideoIsReady(E._videoSSRC,!1)),f===Kt.VIDEO)this.unbindRemoteTrackEvents(E._videoTrack),r||((R=E._videoTrack)===null||R===void 0||R._destroy(),E._videoTrack=void 0);else if(f===Kt.AUDIO){var v;this.unbindRemoteTrackEvents(E._audioTrack),!r&&((v=E._audioTrack)===null||v===void 0||v._destroy(),E._audioTrack=void 0)}}),l}async unsubscribeDataChannel(t,n){if(n.forEach(d=>{const l=this.pendingRemoteDataChannels.findIndex(p=>p.id===d.id);l!==-1&&this.pendingRemoteDataChannels.splice(l,1)}),!this.connection)return;const r=this.filterTobeUnSubscribedDataChannels(t,n);if(r.length===0)return;n.forEach(d=>{d._close()});const a=this.remoteDataChannelMap.get(t);return r.forEach(d=>{a&&a.delete(d.id)}),a&&a.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),r.map(d=>d.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let n=[];for(const{user:d,mediaType:l}of t){const p=this.pendingRemoteTracks.filter(E=>{let{user:f,kind:T}=E;return l!==void 0?f.uid===d.uid&&l===T:f.uid===d.uid});p.forEach(E=>{const f=this.pendingRemoteTracks.indexOf(E);this.pendingRemoteTracks.splice(f,1)}),n=n.concat(p)}if(!this.connection||this.state!==gn.Connected)return void n.forEach(d=>{let{user:l,kind:p}=d;var E;if(p===Kt.AUDIO)(E=l._audioTrack)===null||E===void 0||E._destroy(),l._audioTrack=void 0;else if(p===Kt.VIDEO){var f;(f=l._videoTrack)===null||f===void 0||f._destroy(),l._videoTrack=void 0}});const r=ka(t).call(t,(d,l)=>{let{user:p,mediaType:E}=l;const f=this.filterTobeUnSubscribedTracks(p,E);return d.concat(f)},[]);if(r.length===0)return;await this.connection.stopReceiving(r.map(d=>{let[,{id:l}]=d;return l}));const a=this.createUnsubscribeAllMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(d=>{let[l,{kind:p}]=d;var E,f;if(p===Kt.VIDEO&&l._videoSSRC&&((E=this.connection)===null||E===void 0||E.setStatsRemoteVideoIsReady(l._videoSSRC,!1)),p===Kt.VIDEO)this.unbindRemoteTrackEvents(l._videoTrack),(f=l._videoTrack)===null||f===void 0||f._destroy(),l._videoTrack=void 0;else if(p===Kt.AUDIO){var T;this.unbindRemoteTrackEvents(l._audioTrack),(T=l._audioTrack)===null||T===void 0||T._destroy(),l._audioTrack=void 0}}),a}isPreSubScribe(t){return!this.connection||this.state!==gn.Connected?!1:!!this.connection.getPreMedia(t)}async muteRemote(t,n){if(!this.connection)return;const r=this.remoteUserMap.get(t);if(!r)return void N.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!r.get(n))return void N.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(n,"."));const a=n===Kt.VIDEO?t._videoSSRC:t._audioSSRC;a!==void 0&&this.connection.setStatsRemoteVideoIsReady(a,!1)}async unmuteRemote(t,n){return this.unmuteRemoteNoLock(t,n)}async unmuteRemoteNoLock(t,n){if(!this.connection)return;const r=this.remoteUserMap.get(t);if(!r)return void N.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));r.get(n)||N.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(n,"."))}getAllTracks(t){const n=this.localTrackMap.get(At.LocalAudioTrack);if((n==null?void 0:n.track)instanceof Hi){const r=n.track;return Array.from(this.localTrackMap.entries()).filter(a=>{let[d]=a;return d!==At.LocalAudioTrack}).filter(a=>{let[d]=a;return!(t&&d===At.LocalVideoLowTrack)}).map(a=>{let[,{track:d}]=a;return d}).concat(r.trackList)}return Array.from(this.localTrackMap.entries()).filter(r=>{let[a]=r;return!(t&&a===At.LocalVideoLowTrack)}).map(r=>{let[,{track:a}]=r;return a})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,n,r,a,d){if(t){const p=this.localTrackMap.get(At.LocalAudioTrack),E=a?this.localTrackMap.get(At.LocalVideoLowTrack):this.localTrackMap.get(At.LocalVideoTrack);ee.publish(this.store.sessionId,{eventElapse:Pr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:n,audioName:p==null?void 0:p.track.getTrackLabel(),videoName:E==null?void 0:E.track.getTrackLabel(),screenshare:(E==null?void 0:E.track._hints.indexOf(vn.SCREEN_TRACK))!==-1,audio:!!p,video:!!E,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:d})}else{var l;r||(r=[]);const p=r.find(f=>f instanceof Ai),E=a?(l=this.localTrackMap.get(At.LocalVideoTrack))===null||l===void 0?void 0:l.track:r.find(f=>f instanceof qn);ee.publish(this.store.sessionId,{eventElapse:Pr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:n,audioName:p==null?void 0:p.getTrackLabel(),videoName:E==null?void 0:E.getTrackLabel(),screenshare:(E==null?void 0:E._hints.indexOf(vn.SCREEN_TRACK))!==-1,audio:!!p,video:!!E,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:d})}}reportSubscribeEvent(t,n,r,a){const d=a===Kt.VIDEO?r._videoSSRC:r._audioSSRC;d&&ee.subscribe(this.store.sessionId,{succ:t,ec:n,video:a===Kt.VIDEO,audio:a===Kt.AUDIO,peerid:r.uid,subscribeRequestid:d,p2pid:this.store.p2pId,eventElapse:Pr.measureFromSubscribeStart(this.store.clientId,d),preSsrc:this.isPreSubScribe(d)})}reset(){N.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Yr("P2PChannel-mutex",this.store.clientId),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new tl({},this.store):new jc({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(At.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Hi){if(t.track.trackList.length>0){const n=t.track;t.track.trackList.forEach(r=>{n.removeAudioTrack(r)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=gn.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var n;return((n=this.connection)===null||n===void 0?void 0:n.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(At.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(At.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const n=this.localTrackMap.get(t);return n&&n.track instanceof qn||n&&n.track instanceof Ai?n.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,n){if(!t)return this.remoteUserMap.size>0;const r=this.remoteUserMap.get(t);return!!r&&(!n||r.has(n))}async hasRemoteMediaWithLock(t,n){if(!t)return this.remoteUserMap.size>0;const r=this.remoteUserMap.get(t);return!!r&&(!n||r.has(n))}getRemoteMedia(t){var n;const r=Array.from(na(n=this.remoteUserMap).call(n)).find(a=>a.uid===t);return r?{audioTrack:r.audioTrack,audioSSRC:r._audioSSRC,videoTrack:r.videoTrack,videoSSRC:r._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(r=>{let[a]=r;return{uid:a.uid,level:a.audioTrack?100*a.audioTrack._source.getAccurateVolumeLevel():0}});const n=this.localTrackMap.get(At.LocalAudioTrack);return n&&t.push({level:100*n.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Vh(t).call(t,(r,a)=>r.level-a.level),t}async disconnectForReconnect(){this.connection&&(N.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=gn.Reconnecting,J("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[n]=t;var r;n._videoTrack&&n._videoTrack._player&&((r=n._videoTrack._player.getVideoElement())===null||r===void 0||r.pause(),n._videoTrack._player.isKeepLastFrame=!0,n._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new tl({},this.store):new jc({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var n;let[r,{track:a}]=t;switch(r){case At.LocalVideoTrack:Mt(n=a._hints).call(n,vn.LOW_STREAM)?a.close():this.pendingLocalTracks.push(a);break;case At.LocalAudioTrack:a instanceof Hi?this.pendingLocalTracks=this.pendingLocalTracks.concat(a.trackList):this.pendingLocalTracks.push(a)}}),this.emit(ge.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[n,r]=t;Array.from(na(r).call(r)).forEach(a=>{this.setPendingRemoteMedia(n,a)}),this.emit(ge.MediaReconnectStart,n.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[n,r]=t;Array.from(na(r).call(r)).forEach(a=>{this.setPendingRemoteDataChannel(n,a)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),N.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,n){for(const r of this.pendingRemoteDataChannels){const{user:a,id:d}=r;if((t instanceof du?t.uid:t)===a.uid&&d===n)return!0}return!1}setPendingRemoteDataChannel(t,n){this.hasPendingRemoteDataChannel(t,n)||this.pendingRemoteDataChannels.push({user:t,id:n})}hasPendingRemoteMedia(t,n){for(const r of this.pendingRemoteTracks){const{user:a,kind:d}=r;if((t instanceof du?t.uid:t)===a.uid&&n===d)return!0}return!1}setPendingRemoteMedia(t,n){this.hasPendingRemoteMedia(t,n)||this.pendingRemoteTracks.push({user:t,kind:n})}restartICE(t){var n=this;return oa(function*(){if(!n.connection||n.state!==gn.Connected)return;const r=yield Ae(n.mutex.lock("From P2PChannel.restartICE"));let a;try{a=yield Ae(n.connection.restartICE(t));const l=yield Ae(a.next());if(l.done)return;const p=l.value,E=yield p;switch(n.reportPCDisconnectedOrFailed(t),t){case go.TCP:n._pcStatsUploadType=pd.TCP_RESTART;break;case go.RELAY:n._pcStatsUploadType=pd.RELAY_RESTART;break;default:n._pcStatsUploadType=pd.OLD_RESTART}n._isInRestartIce=!0,a.next(E)}catch(l){var d;(d=a)===null||d===void 0||d.throw(l)}finally{r()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),n=this.localTrackMap.get(At.LocalVideoTrack),r=this.localTrackMap.get(At.LocalAudioTrack),a=t.videoSend.find(w=>w.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId)),d=t.audioSend.find(w=>w.ssrc===(r==null?void 0:r.ssrcs[0].ssrcId));if(!a||!d)return 1;const l=Vo(this,ge.NeedSignalRTT),p=a?a.rttMs:void 0,E=d?d.rttMs:void 0,f=p&&E?(p+E)/2:p||E,T=(f&&l?(f+l)/2:f||l)||0,R=100*t.sendPacketLossRate*.7/50+.3*T/1500,v=R<.17?1:R<.36?2:R<.59?3:R<.1?4:5,y=n==null?void 0:n.track;if(y&&y._encoderConfig&&y._hints.indexOf(vn.SCREEN_TRACK)===-1){const w=y._encoderConfig.bitrateMax,B=t.bitrate.actualEncoded;if(w&&B){const k=(1e3*w-B)/(1e3*w);return vb[k<.15?0:k<.3?1:k<.45?2:k<.6?3:4][v]}}return v}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let n=0;return Array.from(this.remoteUserMap.entries()).forEach(r=>{let[a]=r;const d=a._audioSSRC,l=a._videoSSRC,p=t.audioRecv.find(B=>B.ssrc===d),E=t.videoRecv.find(B=>B.ssrc===l);if(!p&&!E)return void(n+=1);const f=Vo(this,ge.NeedSignalRTT),T=t.rtt,R=(T&&f?(T+f)/2:T||f)||0,v=p?p.jitterMs:void 0,y=t.recvPacketLossRate;let w=.7*y*100/50+.3*R/1500;v&&(w=.6*y*100/50+.2*R/1500+.2*v/400),n+=w<.1?1:w<.17?2:w<.36?3:w<.59?4:5}),this.remoteUserMap.size>0?Math.round(n/this.remoteUserMap.size):n}async muteLocalTrack(t){return new Bt((n,r)=>{this.handleMuteLocalTrack(t,n,r)})}async replaceTrack(t,n){var r;if(N.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(n.getTrackId(),"]")),!this.connection||this.state!==gn.Connected)return;const a=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:p}]=l;return t===p});if(!a)return;const d=a[0];if(t!==n&&(this.unbindLocalTrackEvents([{track:t,type:d}]),this.bindLocalTrackEvents([{track:n,type:d}]),a[1].track=n),await((r=this.connection)===null||r===void 0?void 0:r.replaceTrack(n,a[1].id)),this.isPlanB){const l=a[1];l.id=n._mediaStreamTrack.id,this.localTrackMap.set(d,l)}if(d===At.LocalVideoTrack&&!J("DISABLE_DUAL_STREAM_USE_ENCODING")&&nn().supportDualStreamEncoding){const l=this.localTrackMap.get(At.LocalVideoLowTrack);if(l){const p=t._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=p,l.track._originMediaStreamTrack=p,await new Bt((E,f)=>{this.handleReplaceTrack(l.track,E,f,!0)})}}}filterTobePublishedTracks(t,n,r){const a=[],d=this.getAllTracks();t=dp(t=t.filter(f=>d.indexOf(f)===-1));let l,p=!1;const E=this.localTrackMap.get(At.LocalAudioTrack);for(const f of t){if(f instanceof qn&&(this.localTrackMap.has(At.LocalVideoTrack)||p?new _t(H.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(a.push({track:f,type:At.LocalVideoTrack}),p=!0),n)){const T=this.getLowVideoTrack(f,r);a.push({track:T,type:At.LocalVideoLowTrack})}if(f instanceof Ai)if(E){const T=E.track;if(T instanceof Hi)kg([f]),T.addAudioTrack(f),this.bindLocalAudioTrackEvents(f,!0);else{const R=yC([T,f]);N.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(R.getTrackId(),"]")),this.replaceTrack(T,R)}}else l instanceof Hi?(kg([f]),l.addAudioTrack(f)):l||!f._useAudioElement&&nn().webAudioMediaStreamDest&&!f._bypassWebAudio?l=yC(l?[f,l]:[f]):l=f}return l&&(N.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(l.getTrackId(),"]")),a.push({track:l,type:At.LocalAudioTrack})),a}filterTobeUnpublishedTracks(t){const n=[],r=this.getAllTracks();t=dp(t=t.filter(a=>r.indexOf(a)!==-1));for(const a of t){if(a instanceof Ai){const d=this.localTrackMap.get(At.LocalAudioTrack);if(!d)continue;d.track instanceof Hi?(d.track.removeAudioTrack(a),this.unbindLocalAudioTrackEvents(a),d.track.trackList.length===0&&(n.push([At.LocalAudioTrack,d]),d.track.close())):n.push([At.LocalAudioTrack,d])}if(a instanceof qn){const d=this.localTrackMap.get(At.LocalVideoTrack);if(!d)continue;n.push([At.LocalVideoTrack,d]);const l=this.localTrackMap.get(At.LocalVideoLowTrack);l&&n.push([At.LocalVideoLowTrack,l])}}return n}filterTobePublishedDataChannels(t){return t=(t=dp(t)).filter(n=>this.localDataChannels.findIndex(r=>r.id===n.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=dp(t)).filter(n=>this.localDataChannels.indexOf(n)!==-1)).filter(n=>n._originDataChannel)}bindLocalTrackEvents(t){t.forEach(n=>{let{track:r,type:a}=n;switch(a){case At.LocalVideoTrack:r.addListener(Wt.GET_STATS,this.handleGetLocalVideoStats),r.addListener(Wt.GET_RTC_STATS,this.handleGetRTCStats),r.addListener(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(Wt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.addListener(Wt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),r.addListener(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.addListener(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case At.LocalAudioTrack:this.bindLocalAudioTrackEvents(r)}})}bindLocalAudioTrackEvents(t,n){t instanceof Hi?t.trackList.forEach(r=>{r.addListener(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(Wt.GET_STATS,this.handleGetLocalAudioStats),r.addListener(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(Wt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),n||(t.addListener(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Wt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(n=>{let[r,{track:a}]=n;return{track:a,type:r}})),t.forEach(n=>{let{track:r,type:a}=n;switch(a){case At.LocalVideoTrack:r.off(Wt.GET_STATS,this.handleGetLocalVideoStats),r.off(Wt.GET_RTC_STATS,this.handleGetRTCStats),r.off(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.off(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.off(Wt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.off(Wt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),r.off(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.off(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.off(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case At.LocalAudioTrack:this.unbindLocalAudioTrackEvents(r)}})}unbindLocalAudioTrackEvents(t){t instanceof Hi?t.trackList.forEach(n=>{n.off(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Wt.GET_STATS,this.handleGetLocalAudioStats),n.off(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(Wt.GET_STATS,this.handleGetLocalAudioStats),t.off(Wt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Wt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Wt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Wt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(Wt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Wt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,n){n instanceof zl&&n.addListener(Wt.GET_STATS,r=>{r(this.handleGetRemoteVideoStats(t))}),n instanceof Lp&&n.addListener(Wt.GET_STATS,r=>{r(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Wt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[n,r]=t;r.has(Kt.AUDIO)&&this.unbindRemoteTrackEvents(n._audioTrack),r.has(Kt.VIDEO)&&this.unbindRemoteTrackEvents(n._videoTrack)})}createGatewayPublishMessage(t,n){return t.map((r,a)=>{var d;let l,p,{track:E,type:f}=r;switch(f){case At.LocalAudioTrack:l=fn.Audio,p={dtx:E instanceof SE&&E._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case At.LocalVideoTrack:l=Mt(d=E._hints).call(d,vn.SCREEN_TRACK)?fn.Screen:fn.High,p=Od(Od({},jk(E)),{},{codec:this.store.codec,svc_mode:uC()});break;case At.LocalVideoLowTrack:l=fn.Low,p=Od(Od({},jk(E)),{},{codec:this.store.codec,svc_mode:uC()})}return{stream_type:l,attributes:p,ssrcs:n[a]}})}createGatewayUnpublishMessage(t){return t.map(n=>{var r;let a,[d,{track:l,ssrcs:p,id:E}]=n;switch(d){case At.LocalVideoTrack:a=Mt(r=l._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoLowTrack:a=fn.Low}return{stream_type:a,ssrcs:p,mid:E}})}assignLocalTracks(t,n){t.forEach((r,a)=>{let{track:d,type:l}=r;this.localTrackMap.set(l,{track:d,id:n[a].id,ssrcs:n[a].localSSRC})})}withdrawLocalTracks(t){t.forEach(n=>{let[r]=n;this.localTrackMap.delete(r)})}bindConnectionEvents(t){t.onConnectionStateChange=async n=>{if(N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(n,")")),this.emit(ge.PeerConnectionStateChange,n),n!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),n==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),J("NEW_ICE_RESTART")){var r;if(Mt(r=this._restartStates).call(r,n)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const a=p=>{(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")&&(N.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(p)),Vo(this,ge.QueryClientConnectionState)==="CONNECTED"&&this.emit(ge.RequestRestartICE,p))},d=()=>{t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="checking"&&t.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),N.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(ge.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},l=J("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(J("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&nn().supportPCSetConfiguration)a(go.RELAY),this._restartTimer=window.setTimeout(d,l);else if(Ii())a(go.UDP),this._restartTimer=window.setTimeout(d,4e3);else{if(a(go.TCP),nn().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{a(go.RELAY),this._restartTimer=window.setTimeout(d,l)},l));this._restartTimer=window.setTimeout(d,l)}},800))}}else{if(n==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&J("ICE_RESTART")&&Vo(this,ge.QueryClientConnectionState)==="CONNECTED"&&this.emit(ge.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(N.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(ge.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);n==="failed"&&(N.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(ge.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=n=>{n!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(n,")")),ee.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:n,tag:Si.TRACER}).onSuccess(),this.emit(ge.IceConnectionStateChange,n)},t.onICETransportStateChange=n=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(n,")"))},t.onDTLSTransportStateChange=n=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(n,")"))},t.onDTLSTransportError=n=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(n,")"))},t.onFirstAudioDecoded=n=>{var r;const a=Array.from(na(r=this.remoteUserMap).call(r)).find(l=>l._audioSSRC===n);var d;a&&(this.store.subscribe(a.uid,"audio",void 0,void 0,void 0,Date.now()),(d=a.audioTrack)===null||d===void 0||d.emit(hE.FIRST_FRAME_DECODED),ee.firstRemoteFrame(this.store.sessionId,Dr.FIRST_AUDIO_DECODE,pi.FIRST_AUDIO_DECODE,{peer:a._uintid,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=n=>{var r;const a=Array.from(na(r=this.remoteUserMap).call(r)).find(d=>d._audioSSRC===n);a&&ee.firstRemoteFrame(this.store.sessionId,Dr.FIRST_AUDIO_RECEIVED,pi.FIRST_AUDIO_RECEIVED,{peer:a._uintid,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(n,r,a)=>{this.reportVideoFirstFrameDecoded(n,r,a)},t.onFirstVideoReceived=n=>{var r;const a=Array.from(na(r=this.remoteUserMap).call(r)).find(d=>d._videoSSRC===n);a&&ee.firstRemoteFrame(this.store.sessionId,Dr.FIRST_VIDEO_RECEIVED,pi.FIRST_VIDEO_RECEIVED,{peer:a._uintid,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(n,r)=>{const a=n.candidateType==="relay",d=r.candidateType==="relay";r.candidateType!=="unknown"&&a===d||this.emit(ge.ConnectionTypeChange,a),N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Dc(r))," -> ").concat(JSON.stringify(Dc(n)),")"))},t.onSelectedRemoteCandidateChanged=(n,r)=>{N.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Dc(r))," -> ").concat(JSON.stringify(Dc(n)),")"))},t.onFirstVideoDecodedTimeout=n=>{this.reportVideoFirstFrameDecoded(n,void 0,void 0,!0)},t.getLocalVideoStats=()=>{const n=this.statsCollector.getLocalVideoTrackStats(),r=this.statsCollector.getRTCStats();return Od(Od({},n),r)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0}filterTobeMutedTracks(t){const n=[];if(this.getAllTracks().indexOf(t)===-1)return n;const r=this.localTrackMap.get(At.LocalAudioTrack);if(t instanceof Ai&&(r==null?void 0:r.track)instanceof Hi)return r.track.isActive||n.push([At.LocalAudioTrack,r]),n;const a=Array.from(this.localTrackMap.entries()).find(d=>{let[,{track:l}]=d;return t===l});if(a&&(n.push(a),a[0]===At.LocalVideoTrack)){const d=this.localTrackMap.get(At.LocalVideoLowTrack);d&&n.push([At.LocalVideoLowTrack,d])}return n}filterTobeUnmutedTracks(t){const n=[],r=this.localTrackMap.get(At.LocalAudioTrack);if(t instanceof Ai&&(r==null?void 0:r.track)instanceof Hi)return r.track.isActive&&n.push([At.LocalAudioTrack,r]),n;const a=Array.from(this.localTrackMap.entries()).find(d=>{let[,{track:l}]=d;return t===l});if(a)if(a[0]===At.LocalVideoTrack){n.push(a);const d=this.localTrackMap.get(At.LocalVideoLowTrack);d&&n.push([At.LocalVideoLowTrack,d])}else n.push(a);return n}createMuteMessage(t){return t.map(n=>{var r;let a,[d,{track:l,ssrcs:p,id:E}]=n;switch(d){case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoTrack:a=Mt(r=l._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalVideoLowTrack:a=fn.Low}return{stream_type:a,ssrcs:p,mid:E}})}createUnmuteMessage(t){return t.map(n=>{var r;let a,[d,{track:l,ssrcs:p,id:E}]=n;switch(d){case At.LocalAudioTrack:a=fn.Audio;break;case At.LocalVideoTrack:a=Mt(r=l._hints).call(r,vn.SCREEN_TRACK)?fn.Screen:fn.High;break;case At.LocalVideoLowTrack:a=fn.Low}return{stream_type:a,ssrcs:p,mid:E}})}filterTobeUnSubscribedTracks(t,n){const r=[],a=this.remoteUserMap.get(t);if(!a)return r;if(n){const d=a.get(n);if(!d)return r;r.push([t,{kind:n,id:d}])}else Array.from(a.entries()).forEach(d=>{let[l,p]=d;r.push([t,{kind:l,id:p}])});return r}filterTobeUnSubscribedDataChannels(t,n){const r=[];return n.forEach(a=>{var d;(d=this.remoteDataChannelMap.get(t))!==null&&d!==void 0&&d.has(a.id)&&r.push(a)}),r}createUnsubscribeMessage(t){const n=[];return t.forEach(r=>{let[a,{kind:d,id:l}]=r;switch(d){case Kt.VIDEO:return void(a._videoSSRC&&n.push({stream_type:Kt.VIDEO,ssrcId:a._videoSSRC}));case Kt.AUDIO:return void(a._audioSSRC&&n.push({stream_type:Kt.AUDIO,ssrcId:a._audioSSRC}))}}),n}createUnsubscribeAllMessage(t){const n=new Map;return t.forEach(r=>{let[a,{kind:d}]=r;if(n.has(a)){let l=n.get(a);d===Kt.VIDEO?l|=Ji.Video:l|=Ji.Audio,n.set(a,l)}else d===Kt.VIDEO?n.set(a,Ji.Video):n.set(a,Ji.Audio)}),{users:Array.from(n.entries()).map(r=>{let[a,d]=r;return{stream_id:a.uid,stream_type:d}})}}withdrawRemoteTracks(t){t.forEach(n=>{let[r,{kind:a}]=n;const d=this.remoteUserMap.get(r);d&&(d.delete(a),Array.from(d.entries()).length===0&&this.remoteUserMap.delete(r))})}async updateBitrateLimit(t){const n=this.localTrackMap.get(At.LocalVideoTrack),r=this.localTrackMap.get(At.LocalVideoLowTrack);n&&await n.track.setBitrateLimit(t.uplink),r&&t.low_stream_uplink&&await r.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,n,r){return t.map((a,d)=>{var l;let{stream_type:p}=a;const E=(l=n.find(f=>{let{stream_type:T}=f;return p===T}))===null||l===void 0?void 0:l.attributes;if(E&&J("DISABLE_SCREEN_SHARE_REMB")){const f=r[d]._hints;(Mt(f).call(f,vn.SCREEN_TRACK)||Mt(f).call(f,vn.SCREEN_LOW_TRACK))&&(E.remb=!1,N.debug("disable remb for screen share, hints:",f))}return E})}async tryToUnmuteAudio(t){for(let r=0;r<t.length;r++)if(t[r]instanceof Ai){var n;const a=this.filterTobeUnmutedTracks(t[r]);if(a.length===0)continue;await((n=this.connection)===null||n===void 0?void 0:n.unmuteLocal(a.map(l=>{let[,{id:p}]=l;return p})));const d=this.createUnmuteMessage(a);return void await On(this,ge.RequestUnmuteLocal,d)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var n;return!((n=this.connection)===null||n===void 0||!n.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,n)=>this.emit(ge.RequestUpload,t,n),this.statsUploader.requestUploadStats=t=>this.emit(ge.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await xr(Tb(this.dtlsFailedCount,Vi)),this.emit(ge.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),n=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),n.length>0&&await Kr(this,ge.RequestUnpublishForReconnectPC,n),this.disconnectForReconnect(),this.emit(ge.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(At.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof qn)}throwIfTrackTypeNotMatch(t){if(t.filter(n=>n instanceof qn).length>1)throw new _t(H.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(n=>n instanceof Ai).length>1&&(t.some(n=>n instanceof Ai&&n._bypassWebAudio)||!nn().webAudioMediaStreamDest))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const n of t){if(n instanceof qn&&this.pendingLocalTracks.some(r=>r instanceof qn))throw new _t(H.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n instanceof Ai&&this.pendingLocalTracks.some(r=>r instanceof Ai)&&(!nn().webAudioMediaStreamDest||n._bypassWebAudio||this.pendingLocalTracks.some(r=>r instanceof Ai&&r._bypassWebAudio)))throw new _t(H.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,n){var r;const a=!J("DISABLE_DUAL_STREAM_USE_ENCODING")&&nn().supportDualStreamEncoding,d=Od(Od({},{width:160,height:120,framerate:15,bitrate:50}),n);let l;l=a?t._mediaStreamTrack.clone():cu(t,d);const p=Vn(8,"track-low-"),E=new qn(l,Od(Od({},a&&{scaleResolutionDownBy:Wu(d,t)}),{},{frameRate:d.framerate,bitrateMax:d.bitrate,bitrateMin:d.bitrate}),void 0,void 0,p);return E.on(Ku.TRANSCEIVER_UPDATED,f=>{t._updateRtpTransceiver(f,lE.LOW_STREAM)}),E._hints.push(vn.LOW_STREAM),Mt(r=t._hints).call(r,vn.SCREEN_TRACK)&&E._hints.push(vn.SCREEN_LOW_TRACK),t.on("sei-to-send",f=>{E.emit("sei-to-send",f)}),t.addListener(Wt.NEED_CLOSE,()=>{E.close()}),E}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,n,r){let a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof jc){var d,l,p,E;const f=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:T,dtlsTransportState:R,peerConnectionState:v}=this.connection,{local:y,remote:w}=await this.connection.getSelectedCandidatePair();ee.pcStats(this.store.sessionId,{startTime:f,eventElapse:t-f||0,iceconnectionsate:T,dtlsstate:R,connectionstate:v,intSucc:n?1:2,error:a,selectedLocalCandidateProtocol:(d=y==null?void 0:y.protocol)!==null&&d!==void 0?d:"",selectedLocalCandidateType:(l=y.candidateType)!==null&&l!==void 0?l:"",selectedLocalCandidateAddress:"".concat(y.address,":").concat(y.port),selectedRemoteCandidateProtocol:(p=w.protocol)!==null&&p!==void 0?p:"",selectedRemoteCandidateType:(E=w.candidateType)!==null&&E!==void 0?E:"",selectedRemoteCandidateAddress:"".concat(w.address,":").concat(w.port),restartCnt:r,preallocation:this.connection.isPreallocation})}}reportVideoFirstFrameDecoded(t,n,r,a){var d;const l=Array.from(na(d=this.remoteUserMap).call(d)).find(p=>p._videoSSRC===t);if(l){a||this.store.subscribe(l.uid,"video",void 0,void 0,void 0,void 0,Date.now());const p=this.store.keyMetrics,E=p.subscribe.find(f=>f.userId===l.uid&&f.type==="video");ee.firstRemoteVideoDecode(this.store.sessionId,Dr.FIRST_VIDEO_DECODE,pi.FIRST_VIDEO_DECODE,{peer:l._uintid,videowidth:n,videoheight:r,subscribeElapse:Pr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:p.requestAPEnd||0,apStart:p.requestAPStart||0,joinGwEnd:p.joinGatewayEnd||0,joinGwStart:p.joinGatewayStart||0,pcEnd:p.peerConnectionEnd||0,pcStart:p.peerConnectionStart||0,subscriberEnd:(E==null?void 0:E.subscribeEnd)||0,subscriberStart:(E==null?void 0:E.subscribeStart)||0,videoAddNotify:(E==null?void 0:E.streamAdded)||0,state:a?1:0,firstFrame:(E==null?void 0:E.firstFrame)||0})}}async remoteMediaSsrcChanged(t,n,r){if(!this.connection)return!1;const a=this.remoteUserMap.get(t);if(!a)return!1;const d=a.get(n);if(!d)return!1;const l=await this.connection.getRemoteSSRC(d);return l!==void 0&&l!==r}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[n,{track:r}]=t;n===At.LocalVideoLowTrack?r._updateRtpTransceiver(void 0,lE.LOW_STREAM):r._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof jc&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===pd.TCP_RESTART&&t===go.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,pd.DISCONNECTED_OR_FAILED)))}},jt(je.prototype,"startP2PConnection",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"startP2PConnection"),je.prototype),jt(je.prototype,"connect",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"connect"),je.prototype),jt(je.prototype,"updateRemoteRTPCapabilities",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"updateRemoteRTPCapabilities"),je.prototype),jt(je.prototype,"publishDataChannel",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"publishDataChannel"),je.prototype),jt(je.prototype,"unpublish",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"unpublish"),je.prototype),jt(je.prototype,"unpublishDataChannel",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"unpublishDataChannel"),je.prototype),jt(je.prototype,"unpublishLowStream",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"unpublishLowStream"),je.prototype),jt(je.prototype,"subscribeDataChannel",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"subscribeDataChannel"),je.prototype),jt(je.prototype,"subscribe",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"subscribe"),je.prototype),jt(je.prototype,"massSubscribe",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"massSubscribe"),je.prototype),jt(je.prototype,"unsubscribe",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"unsubscribe"),je.prototype),jt(je.prototype,"unsubscribeDataChannel",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"unsubscribeDataChannel"),je.prototype),jt(je.prototype,"massUnsubscribe",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"massUnsubscribe"),je.prototype),jt(je.prototype,"muteRemote",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"muteRemote"),je.prototype),jt(je.prototype,"unmuteRemote",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"unmuteRemote"),je.prototype),jt(je.prototype,"hasRemoteMediaWithLock",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"hasRemoteMediaWithLock"),je.prototype),jt(je.prototype,"disconnectForReconnect",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"disconnectForReconnect"),je.prototype),jt(je.prototype,"updateBitrateLimit",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"updateBitrateLimit"),je.prototype),jt(je.prototype,"remoteMediaSsrcChanged",[Bs],Object.getOwnPropertyDescriptor(je.prototype,"remoteMediaSsrcChanged"),je.prototype),je);function Bs(t,n,r){const a=t[n];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const d=this.mutex,l=await d.lock("From P2PChannel.".concat(n));try{for(var p=arguments.length,E=new Array(p),f=0;f<p;f++)E[f]=arguments[f];return await a.apply(this,E)}finally{l()}},r}const TO={};function Fg(t){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&N.debug("install service ".concat(t.name)),TO[t.name]=t}function LE(t){const n=TO[t];if(!n)throw new _t(H.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return n}function SO(t,n){return LE("DataStream").create(t,n)}function MC(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function RO(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?MC(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):MC(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const A1=Date.now(),ir=20,s=new Map,e=new Map;async function i(t){const n=s.get(t),r=Array.isArray(n)&&n[n.length-1],a=e.get(t);if(!r)return void(a.isSyncing=!1);const d={uid:r.uid,payload:r.payload};a.firstRecvTs===0&&(a.firstRecvTs=r.recvTs,a.firstSendTs=r.sendTs);const l=r.sendTs-a.firstSendTs,p=l-(Date.now()-a.firstRecvTs);p>0&&(a.firstRecvTs=Date.now()-l);let E=r.mediaDelay+p;E<=0?(n.pop(),o(r.context,d),E=0):E=Math.min(E,ir),setTimeout(()=>n.length&&i(t),E)}function o(t,n){t.safeEmit(Ke.STREAM_MESSAGE,n.uid,n.payload),t.onStreamMessage&&t.onStreamMessage(n)}function c(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return o(r,{uid:t.uid,payload:t.payload});const a="".concat(r.id,"-").concat(t.uid),d=s.get(a)||[],l=d.findIndex(T=>t.sendTs>=T.sendTs),p=RO(RO({},t),{},{context:r,mediaDelay:n,recvTs:Date.now()});l===-1?d.push(p):d.splice(l,0,p),s.set(a,d);let E=!1;var f;e.has(a)?E=!((f=e.get(a))===null||f===void 0||!f.isSyncing):e.set(a,{isSyncing:E,firstRecvTs:0,firstSendTs:0}),E||i(a)}const u=en().name;function h(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function _(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?h(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const m="websdk_ng_cache_parameter",g=J("MAX_PRELOAD_ASYNC_LENGTH"),S=1e4,C=new Map,I=[];let b=null,x=0,D=0;const M=new Map,K=function(t,n){const r=[];let a=0;const d=async()=>{const l=r.shift();l&&await l(),r.length>0&&a<n?d():a--};return async function(){for(var l=arguments.length,p=new Array(l),E=0;E<l;E++)p[E]=arguments[E];return new Bt(async(f,T)=>{r.push(async()=>{try{const R=await t(...p);f(R)}catch(R){T(R)}}),a<n&&(a++,d())})}}(nt,g),z=Xs.CancelToken.source();async function nt(t,n,r,a,d,l){try{if(!J("ENABLE_PRELOAD"))return;if(!nn().supportWebCrypto)return void Al(()=>{N.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!r&&r!==null)throw new _t(H.INVALID_PARAMS,"Invalid token: ".concat(r,". If you don not use token, set it to null"));r&&Nr(r,"token",1,2047),Nr(t,"appid",1,2047),Nl(n),a&&Dl(a);const p=K_();N.debug("preload channel ".concat(n,", uid is ").concat(a));const E={appId:t,cname:n,token:r||t,uid:typeof a!="string"?a:null,sid:p,proxyServer:d};let f,T;typeof a=="string"?(E.stringUid=a,[T,f]=await Bt.all([Zr(a,{sid:p,appId:t},z.token),n1(_(_({},E),{},{token:r||t,uid:0}),z.token)]),E.uid=T.uid,f.gatewayInfo.uid=E.uid,f.gatewayInfo.res.uid=E.uid):(l&&(E.stringUid=l),f=await n1(E,z.token));const R={sid:p,appId:t,cname:n,token:r||t,uid:E.stringUid||a,intUid:E.uid||f.gatewayInfo.uid,stringUid:E.stringUid,ts:Date.now(),sua:T,ap:f};await async function(v){let y;try{v.uid&&it({appId:v.appId,cname:v.cname,token:v.token,uid:v.uid,stringUid:v.stringUid});const w=Ne(v),B=await async function(U,G){try{const W=await window.crypto.subtle.importKey("raw",H_(G),"AES-GCM",!1,["encrypt"]),$=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},W,bc(window.btoa(JSON.stringify(U))));return Ka(new Uint8Array($))}catch{return}}(v,v.token||v.appId);if(!B)return;y=bt(m);const k=y?JSON.parse(y):[];k.push({[w]:B}),k.length>J("AP_CACHE_NUM")&&k.shift(),kt(m,JSON.stringify(k))}catch(w){N.warn("Error caching server parameters:",w.message),kt(m,"")}}(R),x++}catch(p){throw D++,function(E){b||(b=window.setTimeout(()=>{let T="";M.forEach((R,v)=>{T+="".concat(v,": ").concat(R," ;")}),ee.reportApiInvoke(null,{name:Gi.PRELOAD,options:{success:x,failed:D,err:T}}).onError(E),x=0,D=0,M.clear(),b=null},S));const f=M.get(E.code)||0;M.set(E.code,f+1)}(p),p}}async function dt(t){try{if(J("AP_REQUEST_DETAIL"))return;const n=it(t);if(!n||t.cloudProxyServer!=="disabled")return;const r=await async function(a,d){try{const l=await window.crypto.subtle.importKey("raw",H_(d),"AES-GCM",!1,["decrypt"]),p=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},l,bc(a));return JSON.parse(window.atob(Ka(new Uint8Array(p))))}catch{return}}(n,t.token||t.appId);if(!r||!function(a,d){return a.cname===d.cname&&a.appId===d.appId&&a.token===d.token?d.stringUid?a.stringUid===d.stringUid:typeof d.uid=="number"?a.uid===d.uid:a.uid==d.uid:!1}(r,t))return;if(r&&Date.now()-r.ts<J("AP_CACHE_LIFETIME"))return r}catch(n){N.warn("Error get preloadInfo",n.message)}}function it(t){let n;try{if(n=bt(m),!n)return;const r=JSON.parse(n),a=Ne(t),d=function(p,E){for(let f=p.length-1;f>=0;f--)if(E(p[f]))return f;return-1}(r,p=>a in p);if(d===-1)return;const l=r.splice(d,1)[0];return kt(m,JSON.stringify(r)),l[a]}catch(r){N.warn("Error delete preload info: ".concat(n),r.message),kt(m,"")}}function at(t){if(t){let n=C.get(t);n&&(window.clearTimeout(n),n=null,C.delete(t)),Mt(I).call(I,t)||t.cloudProxyServer!=="disabled"||I.push(t)}if(C.size<J("AP_CACHE_NUM")&&I.length>0){const n=I.shift();C.set(n,window.setTimeout(async()=>{const{appId:r,cname:a,token:d,stringUid:l,uid:p,proxyServer:E}=n;try{await K(r,a,d,p,E,l),C.has(n)&&at(n)}catch(f){N.warn("update preload failed",f.message),ht(n)}},J("AP_UPDATE_INTERVAL")))}}function ht(t){const n=I.indexOf(t);n!==-1&&I.splice(n,1);let r=C.get(t);r&&(window.clearTimeout(r),r=null,C.delete(t),at())}function pt(t,n){const r=t.sua,a=t.ap;n&&r&&ee.reqUserAccount(t.sid,{lts:r.requestTime,elapse:r.elapse,success:!0,serverAddr:r.url,stringUid:n,uid:t.intUid,errorCode:null,extend:r.req}),ee.reportResourceTiming(t.ap.url,t.sid),ee.joinWebProxyAP(t.sid,{lts:a.requestTime,elapse:a.elapse,sucess:1,apServerAddr:a.url,turnServerAddrList:a.proxyInfo.addresses.map(d=>d.ip).join(","),eventType:"disabled",unilbsServerIds:[Xi.CHOOSE_SERVER,Xi.CLOUD_PROXY_FALLBACK].toString()}),ee.joinChooseServer(t.sid,{lts:a.requestTime,elapse:a.elapse,succ:!0,csAddr:a.url,opid:a.opid,serverList:a.gatewayInfo.gatewayAddrs.map(d=>d.address),ec:null,cid:a.gatewayInfo.cid.toString(),uid:a.gatewayInfo.uid.toString(),csIp:a.gatewayInfo.csIp,unilbsServerIds:[Xi.CHOOSE_SERVER].toString(),isHttp3:a.isHttp3})}function bt(t){return window.atob(window.localStorage.getItem(t)||"")}function kt(t,n){window.localStorage.setItem(t,window.btoa(n))}function Ne(t){let n="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(n+="_s_".concat(t.uid)),typeof t.uid=="number"&&(n+="_".concat(t.uid)),t.token&&(n+="_".concat(t.token)),lp(n)}function Ge(t){let n=function(){const r=Xo.pop();return r?(r.offset=r.limit=0,r):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(r,a){let d=r.appId;d!==void 0&&(oe(a,10),P(a,d));let l=r.cid;l!==void 0&&(oe(a,16),oe(a,l));let p=r.cname;p!==void 0&&(oe(a,26),P(a,p));let E=r.deviceId;E!==void 0&&(oe(a,34),P(a,E));let f=r.elapse;f!==void 0&&(oe(a,40),rr(a,f));let T=r.fileSize;T!==void 0&&(oe(a,48),rr(a,jn(T)));let R=r.height;R!==void 0&&(oe(a,56),rr(a,jn(R)));let v=r.jpg;v!==void 0&&(oe(a,66),oe(a,v.length),an(a,v));let y=r.networkType;y!==void 0&&(oe(a,72),rr(a,jn(y)));let w=r.osType;w!==void 0&&(oe(a,80),rr(a,jn(w)));let B=r.requestId;B!==void 0&&(oe(a,90),P(a,B));let k=r.sdkVersion;k!==void 0&&(oe(a,98),P(a,k));let U=r.sequence;U!==void 0&&(oe(a,104),rr(a,jn(U)));let G=r.sid;G!==void 0&&(oe(a,114),P(a,G));let W=r.timestamp;W!==void 0&&(oe(a,120),rr(a,W));let $=r.uid;$!==void 0&&(oe(a,128),oe(a,$));let rt=r.vid;rt!==void 0&&(oe(a,136),oe(a,rt));let ot=r.width;ot!==void 0&&(oe(a,144),rr(a,jn(ot)));let Et=r.service;Et!==void 0&&(oe(a,152),oe(a,Et));let vt=r.callbackData;vt!==void 0&&(oe(a,162),oe(a,vt.length),an(a,vt));let Lt=r.ticket;Lt!==void 0&&(oe(a,170),P(a,Lt));let wt=r.vendorConfigs;wt!==void 0&&(oe(a,178),P(a,wt))}(t,n),function(r){let a=r.bytes,d=r.limit;return a.length===d?a:a.subarray(0,d)}(n)}function Qn(t){return function(r){let a={};t:for(;!Dt(r);){let d=It(r);switch(d>>>3){case 0:break t;case 1:a.code=It(r);break;case 2:a.msg=xt(r,It(r));break;case 3:a.requestId=xt(r,It(r));break;case 4:a.timestamp=ii(r,!1);break;default:Er(r,7&d)}}return a}({bytes:n=t,offset:0,limit:n.length});var n}function Er(t,n){switch(n){case 0:for(;128&q(t););break;case 2:St(t,It(t));break;case 5:St(t,4);break;case 1:St(t,8);break;default:throw new Error("Unimplemented type: "+n)}}function jn(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let Xo=[];function St(t,n){if(t.offset+n>t.limit)throw new Error("Skip past limit");t.offset+=n}function Dt(t){return t.offset>=t.limit}function zt(t,n){let r=t.bytes,a=t.offset,d=t.limit,l=a+n;if(l>r.length){let p=new Uint8Array(2*l);p.set(r),t.bytes=p}return t.offset=l,l>d&&(t.limit=l),a}function ye(t,n){let r=t.offset;if(r+n>t.limit)throw new Error("Read past limit");return t.offset+=n,r}function an(t,n){let r=zt(t,n.length);t.bytes.set(n,r)}function xt(t,n){let r=ye(t,n),a=String.fromCharCode,d=t.bytes,l="�",p="";for(let E=0;E<n;E++){let f,T,R,v,y=d[E+r];(128&y)==0?p+=a(y):(224&y)==192?E+1>=n?p+=l:(f=d[E+r+1],(192&f)!=128?p+=l:(v=(31&y)<<6|63&f,v<128?p+=l:(p+=a(v),E++))):(240&y)==224?E+2>=n?p+=l:(f=d[E+r+1],T=d[E+r+2],(49344&(f|T<<8))!=32896?p+=l:(v=(15&y)<<12|(63&f)<<6|63&T,v<2048||v>=55296&&v<=57343?p+=l:(p+=a(v),E+=2))):(248&y)==240?E+3>=n?p+=l:(f=d[E+r+1],T=d[E+r+2],R=d[E+r+3],(12632256&(f|T<<8|R<<16))!=8421504?p+=l:(v=(7&y)<<18|(63&f)<<12|(63&T)<<6|63&R,v<65536||v>1114111?p+=l:(v-=65536,p+=a(55296+(v>>10),56320+(1023&v)),E+=3))):p+=l}return p}function P(t,n){let r=n.length,a=0;for(let p=0;p<r;p++){let E=n.charCodeAt(p);E>=55296&&E<=56319&&p+1<r&&(E=(E<<10)+n.charCodeAt(++p)-56613888),a+=E<128?1:E<2048?2:E<65536?3:4}oe(t,a);let d=zt(t,a),l=t.bytes;for(let p=0;p<r;p++){let E=n.charCodeAt(p);E>=55296&&E<=56319&&p+1<r&&(E=(E<<10)+n.charCodeAt(++p)-56613888),E<128?l[d++]=E:(E<2048?l[d++]=E>>6&31|192:(E<65536?l[d++]=E>>12&15|224:(l[d++]=E>>18&7|240,l[d++]=E>>12&63|128),l[d++]=E>>6&63|128),l[d++]=63&E|128)}}function q(t){return t.bytes[ye(t,1)]}function et(t,n){let r=zt(t,1);t.bytes[r]=n}function It(t){let n,r=0,a=0;do n=q(t),r<32&&(a|=(127&n)<<r),r+=7;while(128&n);return a}function oe(t,n){for(n>>>=0;n>=128;)et(t,127&n|128),n>>>=7;et(t,n)}function ii(t,n){let r,a=0,d=0,l=0;return r=q(t),a=127&r,128&r&&(r=q(t),a|=(127&r)<<7,128&r&&(r=q(t),a|=(127&r)<<14,128&r&&(r=q(t),a|=(127&r)<<21,128&r&&(r=q(t),d=127&r,128&r&&(r=q(t),d|=(127&r)<<7,128&r&&(r=q(t),d|=(127&r)<<14,128&r&&(r=q(t),d|=(127&r)<<21,128&r&&(r=q(t),l=127&r,128&r&&(r=q(t),l|=(127&r)<<7))))))))),{low:a|d<<28,high:d>>>4|l<<24,unsigned:n}}function rr(t,n){let r=n.low>>>0,a=(n.low>>>28|n.high<<4)>>>0,d=n.high>>>24,l=d===0?a===0?r<16384?r<128?1:2:r<1<<21?3:4:a<16384?a<128?5:6:a<1<<21?7:8:d<128?9:10,p=zt(t,l),E=t.bytes;switch(l){case 10:E[p+9]=d>>>7&1;case 9:E[p+8]=l!==9?128|d:127&d;case 8:E[p+7]=l!==8?a>>>21|128:a>>>21&127;case 7:E[p+6]=l!==7?a>>>14|128:a>>>14&127;case 6:E[p+5]=l!==6?a>>>7|128:a>>>7&127;case 5:E[p+4]=l!==5?128|a:127&a;case 4:E[p+3]=l!==4?r>>>21|128:r>>>21&127;case 3:E[p+2]=l!==3?r>>>14|128:r>>>14&127;case 2:E[p+1]=l!==2?r>>>7|128:r>>>7&127;case 1:E[p]=l!==1?128|r:127&r}}const Ao={},uu={},jp=4294967296,UC=jp*jp,Ec=UC/2;sr(0,!0);const nl=sr(0),kE=zn(0,-2147483648,!1),Yi=zn(-1,2147483647,!1);function sr(t,n){let r,a,d;return n?(d=0<=(t>>>=0)&&t<256)&&(a=uu[t],a)?a:(r=zn(t,0,!0),d&&(uu[t]=r),r):(d=-128<=(t|=0)&&t<128)&&(a=Ao[t],a)?a:(r=zn(t,t<0?-1:0,!1),d&&(Ao[t]=r),r)}function zn(t,n,r){return{low:0|t,high:0|n,unsigned:!!r}}function Qo(t,n){if(isNaN(t))return nl;{if(t<=-9223372036854776e3)return kE;if(t+1>=Ec)return Yi}return t<0?nl:zn(t%jp|0,t/jp|0,n)}function Nd(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}class Pi extends An{get connectionState(){return this._connectionState}set connectionState(n){if(this._connectionState===n)return;const r=this._connectionState;this._connectionState=n,this.emit(_d.CONNECTION_STATE_CHANGE,n,r)}get quality(){return this._quality}set quality(n){this._quality=n>1?1:n<.1?.1:n,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(n){var r;super(),F(this,"name","AgoraRTCImageModeration"),F(this,"_connectionState",$s.CONNECTING),F(this,"_sequence",0),F(this,"_moderationStartTime",void 0),F(this,"_workerConnection",void 0),F(this,"_workerMessageLengthLimit",void 0),F(this,"_qualityRatio",void 0),F(this,"_connectInfo",void 0),F(this,"_cancelTokenSource",Xs.CancelToken.source()),F(this,"_retryConfig",void 0),F(this,"_moderationInterval",void 0),F(this,"_moderationTimer",null),F(this,"_moderationMode",1),F(this,"_quality",1),F(this,"_qualityTimer",null),F(this,"_ticket",void 0),F(this,"_moderationIntervalMinimum",void 0),F(this,"_uploadFailedNum",0),F(this,"_uploadNum",0),F(this,"_uploadTimer",null),F(this,"_extraInfo",void 0),F(this,"_vendor",""),F(this,"_encoder",new TextEncoder),F(this,"_moderationId",void 0),F(this,"inspectImage",()=>{if(this.connectionState!==$s.CONNECTED)throw new lt(H.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===$s.CONNECTED?this.requestToInspectImage():N.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Vn(5,"image-moderation-"),this._workerMessageLengthLimit=J("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=J("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(r=n.interval)!==null&&r!==void 0?r:1e3,n.extraInfo&&(this._extraInfo=this._encoder.encode(n.extraInfo)),n.vendor&&(this._vendor=n.vendor),this._qualityRatio=J("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Mf("worker-"+this._moderationId,Vi),this.on(_d.STATE_CHANGE,(a,d)=>{N.debug("[".concat(this._moderationId,"] Moderation operation :").concat(qr[a]," ").concat(d||""))}),this.handleWorkerEvents()}async init(n,r){this.emit(_d.STATE_CHANGE,qr.CONNECT_AP),this._connectInfo=n;const a=this._cancelTokenSource.token;return this._retryConfig=r,new Bt((d,l)=>{this.on(_d.CONNECTION_STATE_CHANGE,(p,E)=>{p===$s.CONNECTED&&d()}),this.requestAP(n,a,r).then(p=>{this.connectWorker(p)}).catch(p=>{l(p)})})}updateConfig(n){var r;this._moderationInterval=(r=n.interval)!==null&&r!==void 0?r:1e3,n.extraInfo&&(this._extraInfo=this._encoder.encode(n.extraInfo)),n.vendor&&(this._vendor=n.vendor),N.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(n))),this.connectionState===$s.CONNECTED&&this.inspectImage()}async requestAP(n,r,a){const d=J("WEBCS_DOMAIN").map(f=>"https://".concat(f,"/api/v1")),l=await function(f,T,R,v){let{appId:y,areaCode:w,cname:B,sid:k,token:U,uid:G}=T;th++;const W="moderation_plugin",$={service_name:W,json_body:JSON.stringify({appId:y,areaCode:w,cname:B,command:"allocateEdge",requestId:th,seq:th,sid:k,appToken:U,ts:Date.now(),uid:G+""})};let rt,ot,Et=f[0];return cd(async()=>{rt=Date.now();const vt=await Fc(Et,{data:$,cancelToken:R,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(ot=Date.now()-rt,vt.code!==0){const $t=new lt(H.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+vt.code,{retry:!0,responseTime:ot});throw N.error($t.toString()),$t}const Lt=JSON.parse(vt.json_body);if(Lt.code!==200){const $t=new lt(H.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(Lt.code,", reason: ").concat(Lt.reason),{code:Lt.code,responseTime:ot});throw N.error($t.toString()),$t}if(!Lt.servers||!Array.isArray(Lt.servers)||Lt.servers.length===0){const $t=new lt(H.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:Lt.code,responseTime:ot});throw N.error($t.toString()),$t}if(!Lt.servers.some($t=>!!$t.wss)){const $t=new lt(H.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:Lt.code,responseTime:ot});throw N.error($t.toString()),$t}const wt=J("IMAGE_MODERATION_WORKER_HOST");return{addressList:Lt.servers.map($t=>{let{address:Ye,wss:bn}=$t;if(Ye&&bn)return"wss://".concat(Ye.replace(/\./g,"-"),".").concat(wt,":").concat(bn,"/moderation")}).filter($t=>!!$t),workerToken:Lt.workerToken,vid:Lt.vid,ticket:Lt.appTicket,responseTime:ot}},(vt,Lt)=>(ee.apworkerEvent(k,{success:!0,sc:200,serviceName:W,responseDetail:JSON.stringify(vt.addressList),firstSuccess:Lt===0,responseTime:ot,serverIp:f[Lt%f.length]}),!1),(vt,Lt)=>(ee.apworkerEvent(k,{success:!1,sc:vt.data&&vt.data.code||200,serviceName:W,responseTime:ot,serverIp:f[Lt%f.length]}),!!(vt.code!==H.OPERATION_ABORTED&&vt.code!==H.UNEXPECTED_RESPONSE||vt.data&&vt.data.retry)&&(Et=f[(Lt+1)%f.length],!0)),v)}(d,n,r,a);this.emit(_d.STATE_CHANGE,qr.AP_CONNECTED);const{addressList:p,ticket:E}=l;return this._ticket=E,p}async connectWorker(n){this.emit(_d.STATE_CHANGE,qr.CONNECT_WORKER),await this._workerConnection.init(n,1e4)}handleWorkerEvents(){this._workerConnection.on(be.CONNECTED,async()=>{this.emit(_d.STATE_CHANGE,qr.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=$s.CONNECTED}),this._workerConnection.on(be.CLOSED,()=>{this.connectionState=$s.CLOSED}),this._workerConnection.on(be.FAILED,()=>{this.connectionState=$s.CLOSED}),this._workerConnection.on(be.RECONNECTING,()=>{this.connectionState=this.connectionState===$s.CONNECTED?$s.RECONNECTING:$s.CONNECTING}),this._workerConnection.on(be.ON_MESSAGE,async n=>{if(n.data instanceof ArrayBuffer){const r=Qn(new Uint8Array(n.data));J("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&N.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(r)),this._uploadNum++,r.code===void 0||r.code===0||(this._uploadFailedNum++,N.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(r.code,", msg is ").concat(r.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{ee.reportApiInvoke(this._connectInfo.sid||null,{name:Gi.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,r.code],tag:Si.TRACER}).onError(new lt(H.IMAGE_MODERATION_UPLOAD_FAILED,r.msg)),this._uploadTimer=null},J("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else N.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(be.WILL_RECONNECT,(n,r,a)=>{n==="recover"&&a(n),a("tryNext")}),this._workerConnection.on(be.REQUEST_NEW_URLS,(n,r)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n).catch(r)})}static intToLong(n){return{low:n|=0,high:n>>31,unsigned:n>=0}}async requestToInspectImage(){const n=Vo(this,_d.CLIENT_LOCAL_VIDEO_TRACK),r={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(n){if(!n.isPlaying)return void(J("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&N.debug("Only the track being played can be inspected"));this._sequence++;const a=await this.generateRequestData(n,r);this._workerConnection.sendMessage(a,!0,!0)}else J("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&N.debug("Only the track being published can be inspected")}async generateRequestData(n,r){let{appId:a,cname:d,cid:l,vid:p,sid:E,uid:f}=r;const T=Date.now(),R=await n.getCurrentFrameImage("image/jpeg",this.quality),v=await AM(R,a,d),y=this._sequence+"-"+l+"-"+f+"-"+T+"-"+Vn(12,""),w={appId:a,cid:l,cname:d,deviceId:"",elapse:Pi.intToLong(Number(T-this._moderationStartTime)),fileSize:R.buffer.byteLength,height:R.height,width:R.width,jpg:v,networkType:6,osType:7,requestId:y,sdkVersion:"4.22.2",sequence:this._sequence,sid:E,timestamp:Qo(T),uid:f,vid:p,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete w.callbackData;const B=Ge(w);if(B.byteLength<this._workerMessageLengthLimit){if(J("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const k=function(U){for(var G=1;G<arguments.length;G++){var W=arguments[G]!=null?arguments[G]:{};G%2?Nd(Object(W),!0).forEach(function($){F(U,$,W[$])}):Object.getOwnPropertyDescriptors?Object.defineProperties(U,Object.getOwnPropertyDescriptors(W)):Nd(Object(W)).forEach(function($){Object.defineProperty(U,$,Object.getOwnPropertyDescriptor(W,$))})}return U}({},w);delete k.jpg,N.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(k))}return B}{const k=this.quality*this._qualityRatio;return this.quality=k,await this.generateRequestData(n,{appId:a,cname:d,cid:l,vid:p,sid:E,uid:f})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Xs.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=$s.CLOSED,this.emit(_d.STATE_CHANGE,qr.CLOSED)}}function cn(t){if(yn(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new lt(H.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new lt(H.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const bo={name:"ImageModeration",create:function(t){let{config:n}=t;return cn(n),new Pi(n)}};var il,Wc,CO,ZG,$G,t3,e3,n3,i3,r3,s3,o3,a3,c3,d3,u3,l3,h3,p3,_3,E3,m3,f3,g3,T3,S3,R3,C3,v3,I3,y3,A3,b3,w3,O3,N3,D3,P3,L3,k3,Ht;function M3(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function lu(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?M3(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):M3(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}Yr.setLogger(N);let S5=(il=me(),Wc=me({argsMap:(t,n)=>{if(!Array.isArray(n)){if(!(n instanceof pE))return[n];n=[n]}return n.map(r=>r?Object(r).toString():"null")}}),CO=me({argsMap:(t,n)=>(n||(n=[]),Array.isArray(n)||n.trackMediaType!==bp.DATA?(Array.isArray(n)||(n=[n]),n.map(r=>r.getTrackId())):[n.getChannelId()])}),ZG=me({argsMap:(t,n,r,a)=>[typeof n=="object"?n.uid:n,r,a]}),$G=me({argsMap:(t,n,r)=>[n,r]}),t3=me({argsMap:(t,n)=>n.map(r=>{let{user:a,mediaType:d}=r;return[a==null?void 0:a.uid,d]})}),e3=me({argsMap:(t,n,r,a)=>[typeof n=="object"?n.uid:n,r,a]}),n3=me({argsMap:(t,n)=>n.map(r=>{let{user:a,mediaType:d}=r;return{uid:a==null?void 0:a.uid,mediaType:d}})}),i3=me(),r3=me(),s3=me(),o3=me(),a3=me(),c3=me(),d3=me(),u3=me(),l3=me(),h3=me(),p3=me(),_3=me(),E3=me(),m3=me(),f3=me({argsMap:(t,n)=>[n]}),g3=me(),T3=me(),S3=me(),R3=me(),C3=me(),v3=me(),I3=me(),y3=me(),A3=me({argsMap:(t,n)=>(Array.isArray(n)||(n=[n]),[JSON.stringify(n)])}),b3=me(),w3=me(),O3=me(),N3=me(),D3=me(),P3=me(),L3=me({reportResult:!0}),k3=me(),Ht=class extends An{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,n){let r;if(super(),F(this,"store",void 0),F(this,"_uid",void 0),F(this,"_channelName",void 0),F(this,"_uintUid",void 0),F(this,"_users",[]),F(this,"_config",void 0),F(this,"_clientId",void 0),F(this,"_appId",void 0),F(this,"_sessionId",null),F(this,"_key",void 0),F(this,"_rtmConfig",{}),F(this,"_joinInfo",void 0),F(this,"_gateway",void 0),F(this,"_statsCollector",void 0),F(this,"_configDistribute",void 0),F(this,"_leaveMutex",void 0),F(this,"_publishMutex",void 0),F(this,"_renewTokenMutex",void 0),F(this,"_subscribeMutex",void 0),F(this,"_encryptionMode","none"),F(this,"_encryptionSecret",null),F(this,"_encryptionSalt",null),F(this,"_encryptDataStream",!1),F(this,"_encryptDataStreamKey",null),F(this,"_encryptDataStreamIv",null),F(this,"_proxyServer",void 0),F(this,"_turnServer",{servers:[],mode:"auto"}),F(this,"_cloudProxyServerMode","disabled"),F(this,"_isDualStreamEnabled",!1),F(this,"_defaultStreamFallbackType",void 0),F(this,"_lowStreamParameter",void 0),F(this,"_streamFallbackTypeCacheMap",new Map),F(this,"_remoteStreamTypeCacheMap",new Map),F(this,"_axiosCancelSource",Xs.CancelToken.source()),F(this,"_audioVolumeIndicationInterval",void 0),F(this,"_networkQualityInterval",void 0),F(this,"_userOfflineTimeout",void 0),F(this,"_streamRemovedTimeout",void 0),F(this,"_liveTranscodeStreamingClient",void 0),F(this,"_liveRawStreamingClient",void 0),F(this,"_channelMediaRelayClient",void 0),F(this,"_networkQualitySensitivity","normal"),F(this,"_p2pChannel",void 0),F(this,"_useLocalAccessPoint",!1),F(this,"_setLocalAPVersion",void 0),F(this,"_joinAndNotLeaveYet",!1),F(this,"_numberOfJoinCount",0),F(this,"_remoteDefaultVideoStreamType",void 0),F(this,"_inspect",void 0),F(this,"_moderation",void 0),F(this,"_license",void 0),F(this,"_pendingPublishedUsers",[]),F(this,"ntpAlignErrorCount",0),F(this,"remoteInboundOffset",0),F(this,"_handleLocalTrackEnable",(a,d,l)=>{this.publish(a,!1).then(d).catch(l)}),F(this,"_handleLocalTrackDisable",(a,d,l)=>{this.unpublish(a).then(d).catch(l)}),F(this,"_handleUserOnline",a=>{if(J("BLOCK_LOCAL_CLIENT")&&Bu(a.uid,this.channelName))return void N.debug("[".concat(a.uid,"] will be ignored in local"));this.isStringUID&&typeof a.uid!="string"&&N.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const d=this._users.find(l=>l.uid===a.uid);if(d)d._trust_in_room_=!0,d._is_pre_created&&(d._is_pre_created=!1,this.safeEmit(Ke.USER_JOINED,d));else{const l=new du(a.uid,a.uint_id||a.uid);this._users.push(l),N.debug("[".concat(this._clientId,"] user online"),a.uid),this.safeEmit(Ke.USER_JOINED,l)}}),F(this,"_handleUserOffline",a=>{if(J("BLOCK_LOCAL_CLIENT")&&Bu(a.uid,this.channelName))return;const d=this._users.find(l=>l.uid===a.uid);d&&(this._handleRemoveStream(a),this._handleRemoveDataChannels(a),d._audio_pre_subscribed||d._video_pre_subscribed?d._is_pre_created=!0:vf(this._users,d),this._remoteStreamTypeCacheMap.delete(d.uid),this._streamFallbackTypeCacheMap.delete(d.uid),N.debug("[".concat(this._clientId,"] user offline"),a.uid,"reason:",a.reason),this.safeEmit(Ke.USER_LEAVED,d,a.reason))}),F(this,"_handleAddAudioOrVideoStream",(a,d,l,p,E,f,T)=>{if(J("BLOCK_LOCAL_CLIENT")&&Bu(d,this.channelName))return;const R=this._users.find(y=>y.uid===d);if(!R)return void N.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));N.debug("[".concat(this._clientId,"] stream added with uid ").concat(d,", type ").concat(a)),this.store.subscribe(R.uid,a,void 0,void 0,void 0,Date.now());const v=a==="audio"?R.hasAudio:R.hasVideo;R._uintid||(R._uintid=E||d),a==="audio"?R._trust_audio_stream_added_state_=!0:R._trust_video_stream_added_state_=!0,a==="audio"?(R._audio_added_=!0,l!==void 0&&(R._audioSSRC=l),p!==void 0&&(R._cname=p),f&&(R._audioOrtc=f)):(R._video_added_=!0,l!==void 0&&(R._videoSSRC=l),p!==void 0&&(R._cname=p),T!==void 0&&(R._rtxSsrcId=T),f&&(R._videoOrtc=f)),(a==="audio"?R.hasAudio:R.hasVideo)&&!v&&(N.info("[".concat(this._clientId,"] remote user ").concat(R.uid," published ").concat(a)),this.safeEmit(Ke.USER_PUBLISHED,R,a)),a==="video"?ee.onGatewayStream(this._sessionId,Dr.ON_ADD_VIDEO_STREAM,pi.ON_ADD_VIDEO_STREAM,{peer:E||d,ssrc:R._videoSSRC}):ee.onGatewayStream(this._sessionId,Dr.ON_ADD_AUDIO_STREAM,pi.ON_ADD_AUDIO_STREAM,{peer:E||d,ssrc:R._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(R,a,l).then(y=>{if(y&&(N.debug("[".concat(this._clientId,"] resubscribe ").concat(a," for user ").concat(R.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof rh))return this._p2pChannel.unsubscribe(R,a,!0).then(()=>this._subscribe(R,a,!0).catch(w=>{N.error("[".concat(this._clientId,"] resubscribe error"),w.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(R,a)&&(N.debug("[".concat(this._clientId,"] resubscribe ").concat(a," for user ").concat(R.uid," after reconnect.")),this._subscribe(R,a,!0).catch(y=>{N.error("[".concat(this._clientId,"] resubscribe error"),y.toString())}))}),F(this,"_handleRemoveStream",a=>{if(J("BLOCK_LOCAL_CLIENT")&&Bu(a.uid,this.channelName))return;const d=this._users.find(p=>p.uid===a.uid);if(!d)return void N.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));N.debug("[".concat(this._clientId,"] stream removed with uid ").concat(a.uid));let l=()=>{};d.hasAudio&&d.hasVideo?l=()=>{N.info("[".concat(this._clientId,"] remote user ").concat(d.uid," unpublished audio track")),this.safeEmit(Ke.USER_UNPUBLISHED,d,"audio"),N.info("[".concat(this._clientId,"] remote user ").concat(d.uid," unpublished video track")),this.safeEmit(Ke.USER_UNPUBLISHED,d,"video")}:d.hasVideo?l=()=>{N.info("[".concat(this._clientId,"] remote user ").concat(d.uid," unpublished video track")),this.safeEmit(Ke.USER_UNPUBLISHED,d,"video")}:d.hasAudio&&(l=()=>{N.info("[".concat(this._clientId,"] remote user ").concat(d.uid," unpublished audio track")),this.safeEmit(Ke.USER_UNPUBLISHED,d,"audio")}),d._video_pre_subscribed||d._audio_pre_subscribed||(d._trust_audio_stream_added_state_=!0,d._trust_video_stream_added_state_=!0,d._audio_added_=!1,d._video_added_=!1,this._p2pChannel instanceof rh&&this._p2pChannel.unsubscribe(d).then(p=>{if(p)return this._gateway.unsubscribe(p,d.uid)}),d._audioSSRC=void 0,d._videoSSRC=void 0,d._audioOrtc=void 0,d._videoOrtc=void 0,d._rtxSsrcId=void 0),ee.onGatewayStream(this._sessionId,Dr.ON_REMOVE_STREAM,pi.ON_REMOVE_STREAM,{peer:a.uint_id||a.uid}),l()}),F(this,"_handleSetStreamLocalEnable",(a,d,l)=>{if(J("BLOCK_LOCAL_CLIENT")&&Bu(d,this.channelName))return;const p=this._users.find(T=>T.uid===d);if(!p)return void N.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));N.debug("[".concat(this._clientId,"] local ").concat(a," ").concat(l?"enabled":"disabled"," with uid ").concat(d));const E=a==="audio"?p.hasAudio:p.hasVideo;if(a==="audio"){p._trust_audio_enabled_state_=!0;const T=p._audio_enabled_;if(p._audio_enabled_=l,p._audio_enabled_===T)return;{const R=p._audio_enabled_?"enable-local-audio":"disable-local-audio";N.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(d,", msg: ").concat(R)),this.safeEmit(Ke.USER_INFO_UPDATED,d,R)}}else{p._trust_video_enabled_state_=!0;const T=p._video_enabled_;if(p._video_enabled_=l,p._video_enabled_===T)return;{const R=p._video_enabled_?"enable-local-video":"disable-local-video";N.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(d,", msg: ").concat(R)),this.safeEmit(Ke.USER_INFO_UPDATED,d,R)}}const f=a==="audio"?p.hasAudio:p.hasVideo;return E!==f?!E&&f?(N.info("[".concat(this._clientId,"] remote user ").concat(d," published ").concat(a)),void this.safeEmit(Ke.USER_PUBLISHED,p,a)):(a==="video"&&p._videoTrack&&p._videoTrack._destroy(),this._p2pChannel.muteRemote(p,a),N.info("[".concat(this._clientId,"] remote user ").concat(d," unpublished ").concat(a)),void this.safeEmit(Ke.USER_UNPUBLISHED,p,a)):void 0}),F(this,"_handleMuteStream",(a,d,l)=>{if(J("BLOCK_LOCAL_CLIENT")&&Bu(a,this.channelName))return;N.debug("[".concat(this._clientId,"] receive mute message"),a,d,l);const p=this._users.find(T=>T.uid===a);if(!p)return void N.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(a));const E=d==="audio"?p.hasAudio:p.hasVideo;if(d==="audio"){p._trust_audio_mute_state_=!0;const T=p._audio_muted_;if(p._audio_muted_=l,p._audio_muted_===T)return;{const R=p._audio_muted_?"mute-audio":"unmute-audio";N.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(a,", msg: ").concat(R)),this.safeEmit(Ke.USER_INFO_UPDATED,a,R)}}else{p._trust_video_mute_state_=!0;const T=p._video_muted_;if(p._video_muted_=l,p._video_muted_===T)return;{const R=p._video_muted_?"mute-video":"unmute-video";N.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(a,", msg: ").concat(R)),this.safeEmit(Ke.USER_INFO_UPDATED,a,R)}}const f=d==="audio"?p.hasAudio:p.hasVideo;if(E!==f){if(!E&&f)return(d==="audio"?p._audioSSRC:p._videoSSRC)?(N.info("[".concat(this._clientId,"] remote user ").concat(a," published ").concat(d)),void this.safeEmit(Ke.USER_PUBLISHED,p,d)):void N.warning("[".concat(this._clientId,"] remote user ").concat(a," receive ").concat(d," unmute message  before add stream message, ").concat(d," SSRC doesn't exist yet."));d==="video"&&p._videoTrack&&!p._video_pre_subscribed&&p._videoTrack._destroy(),this._p2pChannel.muteRemote(p,d),N.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished ").concat(d)),this.safeEmit(Ke.USER_UNPUBLISHED,p,d)}}),F(this,"_handleP2PLost",async a=>{N.debug("[".concat(this._clientId,"] receive p2p lost"),a),parseInt(a.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():N.warning("[".concat(this._clientId,"] P2PLost stream not found"),a)}),F(this,"_handleTokenWillExpire",()=>{N.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Ke.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),F(this,"_handleBeforeUnload",a=>{a.type==="beforeunload"&&a.returnValue!==void 0&&a.returnValue!==""||(this.leave(),N.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),F(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Ke.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const a={downlinkNetworkQuality:0,uplinkNetworkQuality:0};a.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),a.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Ke.NETWORK_QUALITY,a)}),F(this,"_handleP2PAddAudioOrVideoStream",(a,d,l,p)=>{const E=this._users.find(T=>T.uid===d);if(!E)return void N.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));N.debug("[".concat(this._clientId,"] stream added with uid ").concat(d,", type ").concat(a)),this.store.subscribe(E.uid,a,void 0,void 0,void 0,Date.now());const f=a==="audio"?E.hasAudio:E.hasVideo;a==="audio"?E._trust_audio_stream_added_state_=!0:E._trust_video_stream_added_state_=!0,a==="audio"?(E._audio_added_=!0,l!==void 0&&(E._audioSSRC=l),p!==void 0&&(E._audioMid=p)):(E._video_added_=!0,l!==void 0&&(E._videoSSRC=l),p!==void 0&&(E._videoMid=p)),(a==="audio"?E.hasAudio:E.hasVideo)&&!f&&(N.info("[".concat(this._clientId,"] remote user ").concat(E.uid," published ").concat(a)),this.safeEmit(Ke.USER_PUBLISHED,E,a)),this._p2pChannel.hasPendingRemoteMedia(E,a)&&(N.debug("[".concat(this._clientId,"] resubscribe ").concat(a," for user ").concat(E.uid," after reconnect.")),this._subscribe(E,a,!0).catch(T=>{N.error("[".concat(this._clientId,"] resubscribe error"),T.toString())}))}),this._config=t,this._clientId=n||Vn(5,"client-"),this.store=new Cb(t.codec,t.audioCodec,t.mode,this._clientId),this._leaveMutex=new Yr("client-leave",this._clientId),this._publishMutex=new Yr("client-publish",this._clientId),this._renewTokenMutex=new Yr("client-renewtoken",this._clientId),this._subscribeMutex=new Yr("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),N.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Vt," build: ").concat(Xd,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Rf(t.clientRoleOptions),r=Object.assign({},t.clientRoleOptions)}catch(a){N.warning("[".concat(this._clientId,"] ").concat(a.toString()))}this._statsCollector=new Mg(this.store),this._statsCollector.onStatsException=(a,d,l)=>{N.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(a,", msg: ").concat(d,", uid: ").concat(l)),this.safeEmit(Ke.EXCEPTION,{code:a,msg:d,uid:l})},this._statsCollector.onUploadPublishDuration=(a,d,l,p)=>{const E=this._users.find(f=>f.uid===a);E&&ee.peerPublishStatus(this._sessionId,{subscribeElapse:p,audioPublishDuration:d,videoPublishDuration:l,peer:E._uintid})},this.store.useP2P=t.mode==="p2p",this._gateway=new IE(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Vi,httpRetryConfig:t.httpRetryConfig||Vi,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:r}),this._configDistribute=new vd(this._clientId),this.store.useP2P?(this._p2pChannel=new zo(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new rh(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,n,r,a,d){let l=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],p=arguments.length>6&&arguments[6]!==void 0&&arguments[6];on("JOIN_GATEWAY_USE_443PORT_ONLY",l),on("JOIN_GATEWAY_USE_DUAL_DOMAIN",p);const E=this._gateway.signal.websocket;return E instanceof Fb&&(E.use443PortOnly=l,E.tryDoubleDomain=p),async function(f,T,R){Yd.get(f)||Yd.set(f,[]),mf.get(f)||mf.set(f,T),yc.get(f)||yc.set(f,0);const v=Yd.get(f),y=mf.get(f);if(!v||!y)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(yc.get(f)===y){const G=Ef();v.push(G),await G.promise}yc.set(f,yc.get(f)+1);for(var w=arguments.length,B=new Array(w>3?w-3:0),k=3;k<w;k++)B[k-3]=arguments[k];const U=await R(...B);return yc.set(f,yc.get(f)-1),yc.get(f)===y-1&&v.length>0&&(v[0].resolve(),v.shift()),yc.get(f)===0&&(Yd.set(f,[]),mf.set(f,0),yc.set(f,0)),U}("client.join",J("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,n,r,a,d)}async join(t,n,r,a,d){const l=++this._numberOfJoinCount;this.store.joinStart(),a&&(this.store.uid=a);const p=(q_||q_||(q_=(window.location.protocol.split(":")[0]||"").toUpperCase(),q_))==="HTTPS",E=Rb()?window.isSecureContext:"Browser Not Support";(!Rb()&&!p||!window.isSecureContext)&&N.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),N.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),ee.setAppId(t);try{if(!r&&r!==null)throw new lt(H.INVALID_PARAMS,"Invalid token: ".concat(r,". If you don not use token, set it to null"));r&&Nr(r,"token",1,2047),Nr(t,"appid",1,2047),Nl(n),a&&Dl(a),d&&Nr(d,"optionalInfo",1,2047)}catch(k){throw ee.reportApiInvoke(K_(),{name:Gi.JOIN,options:[t,n,r,a],states:{isHttps:p,isSecureContext:E},tag:Si.TRACER}).onError(k),k}if(this._leaveMutex.isLocked&&(N.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),N.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const k=new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw ee.reportApiInvoke(K_(),{name:Gi.JOIN,options:[t,n,r,a],states:{isHttps:p,isSecureContext:E},tag:Si.TRACER}).onError(k),k}this._gateway.state="CONNECTING";const f=await dt({appId:t,cname:n,uid:a,stringUid:typeof a=="string"?a:void 0,token:r||t,cloudProxyServer:this._cloudProxyServerMode});if(!this._joinAndNotLeaveYet)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const T=(f==null?void 0:f.sid)||K_();N.info("[".concat(this._clientId,"] start join channel ").concat(n,", join number: ").concat(l)),this._sessionId||(this._sessionId=T,this.store.sessionId=this._sessionId);const R=ee.reportApiInvoke(T,{id:this._clientId,name:Gi.JOIN,options:[t,n,r,a],states:{isHttps:p,isSecureContext:E},tag:Si.TRACER}),v=lu(lu(lu({},this._rtmConfig),{},{clientId:this._clientId,appId:t,sid:this._sessionId,cname:n,uid:typeof a!="string"?a:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:r||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:d,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!f},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:J("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(v.setLocalAPVersion=this._setLocalAPVersion),typeof a=="string"&&(v.stringUid=a,this._uintUid?(v.uid=this._uintUid,this._uintUid=void 0):v.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(v.aesmode=this._encryptionMode,v.aespassword=await(async k=>{const U=function(rt){const ot=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),Et=new Uint8Array(new ArrayBuffer(ot.length));for(let vt=0;vt<ot.length;vt+=1)Et[vt]=ot.charCodeAt(vt);return Et}(),G=await window.crypto.subtle.importKey("spki",U,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),W=Vu(k),$=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},G,W);return function(rt){let ot="";for(let Et=0;Et<rt.length;Et+=1)ot+=String.fromCharCode(rt[Et]);return window.btoa(ot)}(new Uint8Array($))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(v.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const k=new TextEncoder,U=J("USE_PURE_ENCRYPTION_MASTER_KEY")?k.encode(v.appId+this._encryptionSecret+this._encryptionSecret):k.encode(v.appId+v.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(G,W,$){const rt=await window.crypto.subtle.importKey("raw",W,"PBKDF2",!1,["deriveBits","deriveKey"]),ot=G==="aes-128-gcm2"?128:256,Et=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:gs,hash:"SHA-256",salt:$},rt,ot+mk);return new Uint8Array(Et).subarray(ot/8)}(this._encryptionMode,U,bc(this._encryptionSalt)),this._encryptDataStreamKey=await async function(G,W,$){const rt=await window.crypto.subtle.importKey("raw",W,"PBKDF2",!1,["deriveBits","deriveKey"]),ot=G==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:gs,hash:"SHA-256",salt:$},rt,{name:"AES-GCM",length:ot},!0,["encrypt","decrypt"])}(this._encryptionMode,U,bc(this._encryptionSalt))}else E?N.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):N.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,N.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:n,appId:t,stringUid:v.stringUid});const y=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&y===this._sessionId&&ee.joinChannelTimeout(this._sessionId,5)},5e3);try{var w;let k;const U=v.cloudProxyServer;if(Mt(w=["proxy3","proxy4","proxy5"]).call(w,U)){const ot=J("PROXY_SERVER_TYPE3");Array.isArray(ot)?v.proxyServer=ot[0]:v.proxyServer=ot}if(ee.setProxyServer(v.proxyServer),N.setProxyServer(v.proxyServer),this.store.requestAPStart(),f){if(N.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(v.stringUid?", ".concat(v.stringUid," => ").concat(f.intUid):""," ")),v.stringUid&&!v.uid&&(v.uid=f.intUid),k={gatewayInfo:f.ap.gatewayInfo},J("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&v.turnServer.mode==="auto")if(f.ap.proxyInfo.addresses.length===0)N.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const ot=(await fp(f.ap.proxyInfo,f.ap.gatewayInfo.uid)).map(Et=>({turnServerURL:Et.address,tcpport:Et.tcpport||Vr.tcpport,udpport:Et.udpport||Vr.udpport,username:Et.username||Vr.username,password:Et.password||Vr.password,forceturn:!1,security:!0}));v.turnServer={mode:"manual",servers:ot}}pt(f,v.stringUid)}else{if(v.stringUid&&!v.uid){let ot;[ot,k]=await Bt.all([tO(v.stringUid,v,this._axiosCancelSource.token,this._config.httpRetryConfig||Vi,this.store),$w(v,this._axiosCancelSource.token,this._config.httpRetryConfig||Vi,!0,this.store)]),N.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(v.stringUid," => ").concat(ot)),v.uid=ot,k.gatewayInfo.uid=ot,k.gatewayInfo.res.uid=ot}else k=await $w(v,this._axiosCancelSource.token,this._config.httpRetryConfig||Vi,!0,this.store);if(!this._joinAndNotLeaveYet)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(v,this._axiosCancelSource.token),this._configDistribute.on(NR.UPDATE_BITRATE_LIMIT,ot=>{this._p2pChannel.updateBitrateLimit(ot)})},0),this._key=r||t;const G=k.gatewayInfo,W=v.uid?v.uid:G.uid;this._joinInfo=lu(lu({},v),{},{cid:G.cid,uid:W,vid:G.vid,apResponse:G.res,apGatewayAddress:G.apGatewayAddress,uni_lbs_ip:G.uni_lbs_ip,gatewayAddrs:G.gatewayAddrs}),this.store.intUid=W;const $=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));R.onSuccess($),this._appId=t,this._channelName=v.cname,this._uid=$,this.store.uid=$,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(vr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const rt=v.stringUid?"string uid: ".concat(v.stringUid,",uid: ").concat(v.uid):"uid: ".concat(this._uid);return N.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(n,",").concat(rt)),setTimeout(()=>{N.startUpload()},5e3),this.store.joinEnd(),B=this,Mt(bl).call(bl,B)||bl.push(B),this._cloudProxyServerMode==="disabled"&&nn().supportWebCrypto&&J("ENABLE_PRELOAD")&&at(this._joinInfo),$}catch(k){const U=Array.isArray(k)?k[0]:k;throw U&&U.code===H.OPERATION_ABORTED?N.warning("[".concat(this._clientId,"] join number: ").concat(l,", Joining channel failed, rollback"),U):N.error("[".concat(this._clientId,"] join number: ").concat(l,", Joining channel failed, rollback"),U),U.code!==H.OPERATION_ABORTED&&this._numberOfJoinCount===l&&(this._gateway.state="DISCONNECTED",this._reset()),R.onError(U),U}var B}_joinGateway(){if(!this._joinInfo||!this._key)throw new lt(H.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!J("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}async leave(){N.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(vr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(n){const r=bl.indexOf(n);r!==-1&&bl.splice(r,1)}(this),this._statsCollector.stopUpdateStats();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return N.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),N.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof pE))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new lt(H.INVALID_PARAMS,"param list is empty");const r=t;if(this._gateway.role==="audience")throw new lt(H.INVALID_OPERATION,"audience can not publish stream");for(const d of r){if(!(d instanceof pE))throw new lt(H.INVALID_PARAMS,"parameter is not local track");if(!d._enabled&&n)throw new lt(H.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(d.getTrackId()))}N.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(r.map(d=>"".concat(d.getTrackId()," "))));const a=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),n&&r.forEach(d=>{const l=this._configDistribute.getBitrateLimit();d instanceof qn&&l&&d.setBitrateLimit(l.uplink)});try{await this._publishHighStream(r),N.info("[".concat(this._clientId,"] Publish success, id ").concat(r.map(d=>"".concat(d.getTrackId()," "))))}catch(d){throw N.error("[".concat(this._clientId,"] publish error"),d.toString()),d}finally{a()}}async _publishDataChannel(t){yn(t.id,"id",0,65535,!0),qd(t.ordered,"ordered"),Nr(t.metadata,"metadata",0,512),N.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const n=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(d=>d.id===t.id)!==-1)throw new lt(H.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new lt(H.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&J("FORCE_TURN")&&!J("TURN_ENABLE_TCP")&&!J("TURN_ENABLE_UDP"))throw new lt(H.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const r=function(d){return SO(d,!1)}(t),a=await this._p2pChannel.publishDataChannel([r]);if(a.length>0){if(typeof r._originDataChannelId!="number")throw N.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new lt(H.CREATE_DATACHANNEL_ERROR);try{await Bt.all(a.map(d=>this._uid&&this._gateway.publishDataChannel(this._uid,d,!0))),await r._waitTillOpen()}catch(d){if(d.code!==H.DISCONNECT_P2P)throw d}}return N.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(r.id)),r}catch(r){throw N.error("[".concat(this._clientId,"] publish datachannels error"),r.toString()),r}finally{n()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new lt(H.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let n=[];if(t)if(Array.isArray(t))n=t;else{if(!(t instanceof pE))return this._unpublishDataChannel([t]);n=[t]}else this.store.useP2P||await this._unpublishDataChannel(),n=this._p2pChannel.getAllTracks(!0);N.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(n.map(a=>"".concat(a.getTrackId()," "))," "));const r=await this._publishMutex.lock();try{if(this._p2pChannel instanceof zo){const a=await this._p2pChannel.unpublish(n);a&&await this._gateway.sendExtensionMessage(ai.UNPUBLISH,{unpubMsg:a},!0)}else{const a=await this._p2pChannel.unpublish(n);a&&await this._gateway.unpublish(a,this._uid),N.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(n.map(d=>"".concat(d.getTrackId()))))}}catch(a){throw N.error("[".concat(this._clientId,"] unpublish error"),a.toString()),a}finally{r&&r()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),N.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(r=>"".concat(r.id," "))," "));const n=await this._publishMutex.lock();try{const r=await this._p2pChannel.unpublishDataChannel(t);r&&await this._gateway.unpublishDataChannel(r),N.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(a=>"".concat(a.id))))}catch(r){throw N.error("[".concat(this._clientId,"] unpublish dataChannel error"),r.toString()),r}finally{n&&n()}}async subscribe(t,n,r){if(!(t instanceof du)){const a=this.remoteUsers.find(d=>d.uid===t);if(!a)throw new lt(H.INVALID_REMOTE_USER,"user is not in the channel");t=a}return n==="datachannel"?this._subscribeDataChannel(t,r):this._subscribe(t,n)}async presubscribe(t,n){if(lr(n,"mediaType",["audio","video"]),this._p2pChannel instanceof zo)throw new lt(H.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new lt(H.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const r=n===Kt.AUDIO,a=n===Kt.VIDEO,d=await this._subscribeMutex.lock();try{const{ssrcId:l,ortc:p,rtxSsrcId:E,cname:f,uint_id:T}=await this._gateway.presubscribe(t,n,!0);if(l==null)throw new lt(H.UNEXPECTED_RESPONSE,"no ssrc id");let R=this._users.find(y=>y.uid===t);R||(R=new du(t,T||t),R._is_pre_created=!0,this._users.push(R)),f&&(R._cname=f),R._uintid||(R._uintid=T||t),r&&(R._audioSSRC=l,R._audio_pre_subscribed=!0,p&&(R._audioOrtc=p)),a&&(R._videoSSRC=l,R._video_pre_subscribed=!0,p&&(R._videoOrtc=p),E!=null&&(R._rtxSsrcId=E)),N.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(l)),await this._p2pChannel.subscribe(R,n,l,E,p);const v=r?R._audioTrack:R._videoTrack;if(!v)throw new lt(H.UNEXPECTED_ERROR,"can not find remote track in user");return r&&(R._trust_audio_stream_added_state_=!0,R._audio_added_=!0),a&&(R._trust_video_stream_added_state_=!0,R._video_added_=!0),v}catch(l){throw N.error("[".concat(this._clientId,"] presub user ").concat(t," error"),l),l}finally{d()}}async _subscribeDataChannel(t,n){var r;if(yn(n,"channelId",0,65535,!0),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(E=>E===t))throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new lt(H.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new lt(H.INVALID_REMOTE_USER,"user is not published");const d=(r=t._dataChannels)===null||r===void 0?void 0:r.find(E=>E.id===n);if(!d)throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new lt(H.REMOTE_USER_IS_NOT_PUBLISHED);const l=await this._subscribeMutex.lock();N.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const E=await this._p2pChannel.subscribeDataChannel(t,[d]);if(E&&Mt(E).call(E,d.id))try{var p;if(typeof d._originDataChannelId!="number")throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new lt(H.CREATE_DATACHANNEL_ERROR);const f={id:d.id,datachannelId:d._originDataChannelId,ordered:d.ordered,maxRetransmits:d.maxRetransmits,metadata:(p=d.metadata)!==null&&p!==void 0?p:""};await this._gateway.subscribeDataChannel(t.uid,f,!0),await d._waitTillOpen()}catch(f){if((f==null?void 0:f.code)!==H.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[d]),f;await this._p2pChannel.unsubscribeDataChannel(t,[d]),this._p2pChannel.setPendingRemoteDataChannel(t,d.id)}return N.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),d}finally{l()}}async _p2pSubscribe(t,n,r){if(lr(n,"mediaType",["audio","video"]),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(l=>l===t)){const l=new lt(H.INVALID_REMOTE_USER,"user is not in the channel");throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),l}if(!t.hasAudio&&!t.hasVideo){const l=new lt(H.INVALID_REMOTE_USER,"user is not published");throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),l}if(!r&&(n==="audio"&&!t.hasAudio||n==="video"&&!t.hasVideo)){const l=new lt(H.REMOTE_USER_IS_NOT_PUBLISHED);throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(n,", remote track is not published")),l}const d=await this._subscribeMutex.lock();N.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(n));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,n))await this._p2pChannel.unmuteRemote(t,n);else try{const p=n==="audio"?t._audioSSRC:t._videoSSRC,E=n==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,n,Date.now()),this._p2pChannel instanceof zo&&await this._p2pChannel.subscribe(t,n,p,E)}catch(p){throw p}N.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(n)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(p=>{N.warning("[".concat(this._clientId,"] auto set fallback failed"),p)});const l=n==="audio"?t._audioTrack:t._videoTrack;if(!l)throw new lt(H.UNEXPECTED_ERROR,"can not find remote track in user object");return l}catch(l){throw N.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),l),l}finally{d()}}async _subscribe(t,n,r){if(this._p2pChannel instanceof zo)return this._p2pSubscribe(t,n);if(lr(n,"mediaType",["audio","video"]),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(T=>T===t)){const T=new lt(H.INVALID_REMOTE_USER,"user is not in the channel");throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),T}if(!t.hasAudio&&!t.hasVideo){const T=new lt(H.INVALID_REMOTE_USER,"user is not published");throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),T}if(!(r||(n!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(n!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const T=new lt(H.REMOTE_USER_IS_NOT_PUBLISHED);throw N.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(n,", remote track is not published")),T}let d=n==="audio"?t._audioSSRC:t._videoSSRC,l=n==="audio"?t._audioOrtc:t._videoOrtc,p=n==="video"?t._rtxSsrcId:void 0,E={stream_type:n==="audio"?Kt.AUDIO:Kt.VIDEO,ssrcId:d};const f=await this._subscribeMutex.lock();N.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(n));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,n))await this._p2pChannel.unmuteRemote(t,n);else try{const R=n==="audio"?t._audioSSRC:t._videoSSRC;R!==void 0&&R!==d&&(d=R,l=n==="audio"?t._audioOrtc:t._videoOrtc,p=n==="video"?t._rtxSsrcId:void 0,E={stream_type:n==="audio"?Kt.AUDIO:Kt.VIDEO,ssrcId:d}),Pr.markSubscribeStart(this.store.clientId,d),this.store.subscribe(t.uid,n,Date.now()),await this._p2pChannel.subscribe(t,n,d,p,l);try{this._p2pChannel.isPreSubScribe(d)||await this._gateway.subscribe(t.uid,E,!0)}catch(v){if((v==null?void 0:v.code)!==H.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,n),v;await this._p2pChannel.unsubscribe(t,n,!0),this._p2pChannel.setPendingRemoteMedia(t,n)}this.store.subscribe(t.uid,n,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,n)}catch(R){throw this._p2pChannel.reportSubscribeEvent(!1,R==null?void 0:R.code,t,n),R}N.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(n)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(R=>{N.warning("[".concat(this._clientId,"] auto set fallback failed"),R)});const T=n==="audio"?t._audioTrack:t._videoTrack;if(!T)throw new lt(H.UNEXPECTED_ERROR,"can not find remote track in user object");return T}catch(T){throw N.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),T),T}finally{f()}}async massSubscribe(t){if(mo(t,"subscribeList"),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const n=Date.now(),r=new Map,a=await this._subscribeMutex.lock();N.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(E=>{let{user:f,mediaType:T}=E;return"user: ".concat(f==null?void 0:f.uid,", mediaType: ").concat(T)}).join("; ")));const d=(t=[...t]).map(E=>{let{user:f,mediaType:T}=E;return{user:f,mediaType:T}}),l=await this._p2pChannel.globalLock();try{var p;for(let f=t.length-1;f>=0;f--){const T=t[f],{user:R,mediaType:v}=T;if(lr(v,"mediaType",["audio","video"]),!R){const k=new lt(H.INVALID_PARAMS,"user property does not exist in subscribeList item");throw N.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),k}if(!this._users.find(k=>k===R)){const k=new lt(H.INVALID_REMOTE_USER,"user is not in the channel");N.error("[".concat(this._clientId,"] can not massSubscribe ").concat(R.uid,", this user is not in the channel")),d[f].error=k,t.splice(f,1);continue}if(v==="audio"&&(!R.hasAudio||R._audioSSRC===void 0)||v==="video"&&(!R.hasVideo||R._videoSSRC===void 0)){const k=new lt(H.REMOTE_USER_IS_NOT_PUBLISHED);N.error("[".concat(this._clientId,"] can not subscribe ").concat(R.uid," with mediaType ").concat(v,", remote user is not published")),d[f].error=k,t.splice(f,1);continue}const w=Ji.Video|Ji.LwoVideo,B=r.get(R);if(B){if(v==="video"?B&w:B&Ji.Audio){t.splice(f,1),N.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(R.uid,", mediaType:").concat(v," twice"));continue}r.set(R,B|(v==="video"?w:Ji.Audio))}else r.set(R,v==="video"?w:Ji.Audio)}for(let f=t.length-1;f>=0;f--){const T=t[f],{user:R,mediaType:v}=T,y=Ji.Video|Ji.LwoVideo;if(this._p2pChannel.hasRemoteMedia(R,v)){await this._p2pChannel.unmuteRemoteNoLock(R,v);const w=r.get(R);r.set(R,v==="video"?w^y:w^Ji.Audio),t.splice(f,1)}}this.store.massSubscribe(t.map(f=>({userId:f.user.uid,type:f.mediaType})),n);let E=ka(p=Array.from(r.entries())).call(p,(f,T)=>{let[R,v]=T;if(v===0)return f;const y={stream_id:R.uid,stream_type:v};return v&Ji.Audio&&(y.audio_ssrc=R._audioSSRC),v&Ji.Video&&(y.video_ssrc=R._videoSSRC),f.push(y),f},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(T=>{let{user:R,mediaType:v}=T;return{user:R,mediaType:v,ssrcId:v===Kt.VIDEO?R._videoSSRC:R._audioSSRC,rtxSsrcId:v===Kt.VIDEO?R._rtxSsrcId:void 0}}));const f=new Map;if(E=E.filter(T=>T.video_ssrc&&!this._p2pChannel.isPreSubScribe(T.video_ssrc)||T.audio_ssrc&&!this._p2pChannel.isPreSubScribe(T.audio_ssrc)||!T.video_ssrc&&!T.audio_ssrc),E.length>0){const T=await this._gateway.subscribeAll(E,!0);((T==null?void 0:T.users)||[]).forEach(R=>{let{stream_id:v,video_error_code:y,audio_error_code:w,error_code:B}=R;(y||w||B)&&f.set(v,{video_error_code:y,audio_error_code:w,error_code:B})})}if(Array.from(f.entries()).length>0){const T=[];Array.from(f.entries()).forEach(R=>{let[v,y]=R;const w=this.remoteUsers.find(B=>B.uid===v);if(w){let B;y.error_code||y.video_error_code&&y.audio_error_code?B=void 0:y.video_error_code?B=Kt.VIDEO:y.audio_error_code&&(B=Kt.AUDIO),T.push({user:w,mediaType:B})}}),T.length>0&&await this._p2pChannel.massUnsubscribeNoLock(T)}for(const T of d){const R=f.get(T.user.uid);if(R){const v=R.error_code||T.mediaType==="audio"&&R.audio_error_code||T.mediaType==="video"&&R.video_error_code;if(v){const y=Nc(v);N.error("user:".concat(T.user.uid," mediaType:").concat(T.mediaType," has massSubscribe error ").concat(y.desc)),T.error=new lt(H.SUBSCRIBE_FAILED,"code ".concat(v,": ").concat(y.desc))}}T.error||(T.mediaType==="video"?T.track=T.user.videoTrack:T.track=T.user.audioTrack)}return this.store.massSubscribe(d.filter(T=>!T.error).map(T=>({userId:T.user.uid,type:T.mediaType})),void 0,Date.now()),d.forEach(T=>{var R;ee.subscribe(this.store.sessionId,{succ:!!T.error,ec:((R=T.error)===null||R===void 0?void 0:R.code)||null,video:T.mediaType===Kt.VIDEO,audio:T.mediaType===Kt.AUDIO,peerid:T.user.uid,subscribeRequestid:T.mediaType===Kt.VIDEO?T.user._videoSSRC:T.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-n),preSsrc:this._p2pChannel.isPreSubScribe(T.user._videoSSRC)},!0)}),N.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(T=>{let{user:R,mediaType:v}=T;return"user: ".concat(R==null?void 0:R.uid,", mediaType: ").concat(v)}).join("; "))),d}catch(f){throw await this._p2pChannel.massUnsubscribeNoLock(t),f}}finally{l(),a()}}async unsubscribe(t,n,r){if(!(t instanceof du)){const l=this.remoteUsers.find(p=>p.uid===t);if(!l)throw new lt(H.INVALID_REMOTE_USER,"user is not in the channel");t=l}if(n||this.store.useP2P){if(n==="datachannel")return this._unsubscribeDataChannel(t,r)}else await this._unsubscribeDataChannel(t,r);if(n&&lr(n,"mediaType",["audio","video"]),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(l=>l===t)){const l=new lt(H.INVALID_REMOTE_USER,"user is not in the channel");throw N.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),l}N.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(n));const d=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof zo)await this._p2pChannel.unsubscribe(t,n);else{const l=await this._p2pChannel.unsubscribe(t,n);l&&await this._gateway.unsubscribe(l,t.uid),n&&n!=="audio"||(t._audio_pre_subscribed=!1),n&&n!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&vf(this._users,t),N.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(n))}}catch(l){if(l.code===H.DISCONNECT_P2P)return void N.warning("disconnecting p2p, abort unsubscribe request.");throw N.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),l.toString()),l}finally{d()}}async _unsubscribeDataChannel(t,n){if(n&&yn(n,"id",0,65535,!0),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(d=>d===t)){const d=new lt(H.INVALID_REMOTE_USER,"user is not in the channel");throw N.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),d}let a;if(typeof n=="number"){const d=t._dataChannels.find(l=>l.id===n);d&&(a=[d])}else a=t._dataChannels;if(a===void 0){const d=new lt(H.REMOTE_USER_IS_NOT_PUBLISHED);throw N.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(n,", remote datachannel is not published")),d}N.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(a.map(d=>d.id)));try{const d=await this._p2pChannel.unsubscribeDataChannel(t,a);d&&await this._gateway.unsubscribeDataChannel(d,t.uid),N.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(d))}catch(d){if(d.code===H.DISCONNECT_P2P)return void N.warning("disconnecting p2p, abort unsubscribe request.");throw N.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),d.toString()),d}}async massUnsubscribe(t){if(mo(t,"unsubscribeList"),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");N.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(r=>{let{user:a,mediaType:d}=r;return"user: ".concat(a==null?void 0:a.uid,", mediaType: ").concat(d,";")}).join())),t=[...t];const n=new Map;for(let r=t.length-1;r>=0;r--){const{user:a,mediaType:d}=t[r];if(!a){const E=new lt(H.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw N.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),E}if(lr(d,"mediaType",["video","audio",void 0]),!this._users.find(E=>E===a)){N.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(a.uid,", user is not in the channel")),t.splice(r,1);continue}const p=Ji.Video|Ji.LwoVideo;if(n.has(a)){const E=n.get(a);let f;switch(d){case"video":f=E&p;break;case"audio":f=E&Ji.Audio;break;default:f=E&(Ji.Audio|p)}if(f){N.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(a.uid,",mediaType:").concat(d," twice.")),t.splice(r,1);continue}d?d==="audio"?n.set(a,E|Ji.Audio):d==="video"&&n.set(a,E|p):n.set(a,E|Ji.Audio|p)}else d?d==="audio"?n.set(a,Ji.Audio):d==="video"&&n.set(a,p):n.set(a,Ji.Audio|p)}try{const r=await this._p2pChannel.massUnsubscribe(t);r&&await this._gateway.massUnsubscribe(r),N.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(a=>{let{user:d,mediaType:l}=a;return"user: ".concat(d==null?void 0:d.uid,", mediaType: ").concat(l,";")}).join()))}catch(r){if(r.code===H.DISCONNECT_P2P)return void N.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw N.error("[".concat(this._clientId,"] massUnsubscribe error"),r.toString()),r}}async setLowStreamParameter(t){(function(r){if(!r)throw new _t(H.INVALID_PARAMS);Ti(r.width)||pb(r.width,"streamParameter.width"),Ti(r.height)||pb(r.height,"streamParameter.height"),Ti(r.framerate)||pb(r.framerate,"streamParameter.framerate"),Ti(r.bitrate)||yn(r.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&N.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),N.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const n=this._configDistribute.getLowStreamConfigDistribute();if(n&&n.bitrate&&t.bitrate&&n.bitrate<t.bitrate&&(t.bitrate=n.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,At.LocalVideoLowTrack)}async enableDualStream(){if(!nn().supportDualStream)throw ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new lt(H.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new lt(H.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),N.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new lt(H.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(At.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),N.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,n){if(function(r){lr(r,"role",["audience","host"])}(t),n&&Rf(n),this.mode==="rtc"||this.mode==="p2p")throw N.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new lt(H.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(n&&n.level&&t==="host")throw new lt(H.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new lt(H.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,n),this._config.role=t,N.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(n&&n.level))}getRemoteInboundOffset(){var t;const n=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!n||!n.timestamp)return 0;const r=n.timestamp-Date.now();return Math.abs(r)>1e3+n.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?r:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,n){if(Nr(t,"proxyServer"),!n){if(this.connectionState!=="DISCONNECTED")throw new lt(H.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new lt(H.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,ee.setProxyServer(this._proxyServer),N.setProxyServer(this._proxyServer),N.info("[".concat(this._clientId,"] Set proxy server ").concat(n?"by initialize call":""," success."))}setTurnServer(t,n){if(Array.isArray(t)||(t=[t]),!n){if(this.connectionState!=="DISCONNECTED")throw new lt(H.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new lt(H.INVALID_OPERATION,"You have already set the proxy")}if(TR(t))return this._turnServer={servers:t,mode:"original-manual"},void N.info("[".concat(this._clientId,"] Set original turnserver ").concat(n?"by initialize call":""," success: ").concat(t.map(r=>r.urls).join(","),"."));t.forEach(r=>Sf(r)),this._turnServer={servers:t,mode:"manual"},N.info("[".concat(this._clientId,"] Set turnserver ").concat(n?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new lt(H.INVALID_OPERATION,"you should set license before join channel");if(Nr(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new lt(H.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,N.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new lt(H.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new lt(H.INVALID_OPERATION,"You have already set the proxy");const n=[3,4,5];let r;switch(t===void 0&&(t=3),t){case 1:case 2:throw new lt(H.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:r="proxy3";break;case 4:r="proxy4";break;case 5:r="proxy5";break;default:throw new lt(H.INVALID_PARAMS,"proxy server mode must be ".concat(n.join("|")))}this._cloudProxyServerMode=r,this.store.cloudProxyServerMode=r,N.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new lt(H.INVALID_OPERATION,"Stop proxy server after leave channel");ee.setProxyServer(),N.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",N.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new lt(H.INVALID_PARAMS,"accessPoints is required.");mo(t.accessPoints.serverList,"accessPoints.serverList"),Nr(t.accessPoints.domain,"accessPoints.domain");const n=(y,w)=>{yn(y,w,0,65535,!0)};let r=443;if(t.accessPoints.port&&(n(t.accessPoints.port,"accessPoints.port"),r=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new lt(H.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");J("CLOSE_AFB_FOR_LOCAL_AP")&&(on("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),on("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const a=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,d=t.accessPoints.domain,l=t.accessPoints.serverList.map(y=>a.test(y)?"".concat(y.replace(/\./g,"-"),".").concat(d):y),p=l.map(y=>"".concat(y,":").concat(r));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,on("WEBCS_DOMAIN",p),on("WEBCS_DOMAIN_BACKUP_LIST",p),on("GATEWAY_DOMAINS",[d]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(mo(t.report.hostname,"report.hostname"),on("EVENT_REPORT_DOMAIN",t.report.hostname[0]),on("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(on("EVENT_REPORT_DOMAIN",l[0]),on("EVENT_REPORT_BACKUP_DOMAIN",l[1]||l[0]));let E=6443;t.report&&t.report.port&&(n(t.report.port,"report.port"),E=t.report.port),on("STATS_COLLECTOR_PORT",E),t.report?on("ENABLE_EVENT_REPORT",!0):on("ENABLE_EVENT_REPORT",!1);let f="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(mo(t.log.hostname,"log.hostname"),f=t.log.hostname[0]):f=l[0];let T=6444;t.log&&t.log.port&&(n(t.log.port,"log.port"),T=t.log.port),on("LOG_UPLOAD_SERVER","".concat(f,":").concat(T));let R=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(mo(t.cds.hostname,"cds.hostname"),R=t.cds.hostname):R=l;let v=443;t.cds&&t.cds.port&&(n(t.cds.port,"cds.port"),v=t.cds.port),on("CDS_AP",R.map(y=>"".concat(y,":").concat(v))),t.cds?on("ENABLE_CONFIG_DISTRIBUTE",!0):on("ENABLE_CONFIG_DISTRIBUTE",!1),N.info("set local access point v2 success")}setLocalAccessPoints(t,n){if(mo(t,"serverList"),Nr(n,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new lt(H.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const r=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(a=>r.test(a)?"".concat(a.replace(/\./g,"-"),".").concat(n):a),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,on("WEBCS_DOMAIN",t),on("WEBCS_DOMAIN_BACKUP_LIST",t),on("GATEWAY_DOMAINS",[n]),on("EVENT_REPORT_DOMAIN",t[0]),on("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),on("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),N.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(lr(t,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(n){throw N.error("[".concat(this._clientId,"] set default remote video stream type error"),n.toString()),n}else N.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,n){lr(n,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(t,n),setTimeout(()=>{const r=this._users.find(a=>a.uid===t);r&&r.videoTrack&&r.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(r){throw N.error("[".concat(this._clientId,"] set remote video stream type error"),r.toString()),r}N.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(n)),this._remoteStreamTypeCacheMap.set(t,n)}async setStreamFallbackOption(t,n){lr(n,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(t,n)}catch(r){throw N.error("[".concat(this._clientId,"] set stream fallback option"),r.toString()),r}N.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(n)),this._streamFallbackTypeCacheMap.set(t,n)}setEncryptionConfig(t,n,r,a){(function(l){lr(l,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),Nr(n,"secret");const d=["aes-128-gcm2","aes-256-gcm2"];if(Mt(d).call(d,t)){if(!r||!(r instanceof Uint8Array&&r.length===32))throw new lt(H.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(r)throw new lt(H.INVALID_PARAMS,"current encrypt mode does not need salt");if(a){if(qd(a,"encryptDataStream"),!Mt(d).call(d,t))throw new lt(H.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(n)||N.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=n,r&&(this._encryptionSalt=Ka(r))}async renewToken(t){if(Nr(t,"token",1,2047),!this._key||!this._joinInfo)throw new lt(H.INVALID_OPERATION,"renewToken should not be called before user join");const n=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const r=await this._renewTokenMutex.lock();try{if(J("USE_NEW_TOKEN")){N.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const a=await i1(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Vi);N.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:a})}else N.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});N.debug("[".concat(this._clientId,"] renewToken success"))}catch(a){throw this._key=n,this._joinInfo.token=n,N.error("[".concat(this._clientId,"] renewToken failed"),a.toString()),a}finally{r()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?N.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(Ke.VOLUME_INDICATOR,t)},J("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),n=this._gateway.getInChannelInfo();return t.Duration=Math.round(n.duration/1e3),t}async startLiveStreaming(t,n){if(!n){if(this.codec!=="h264")throw new lt(H.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new lt(H.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new lt(H.LIVE_STREAMING_TASK_CONFLICT);const r=n?ud.TRANSCODE:ud.RAW;return this._createLiveStreamingClient(r).startLiveStreamingTask(t,r)}setLiveTranscoding(t){return this._createLiveStreamingClient(ud.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const n=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(r=>r&&r.hasUrl(t));if(!n.length)throw new lt(H.INVALID_PARAMS,"can not find live streaming url to stop");await Bt.all(n.map(r=>r&&r.stopLiveStreamingTask(t)))}async startChannelMediaRelay(t){_O(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){_O(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(t){var n;let r=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new lt(H.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const d=new TextEncoder;t.payload=d.encode(t.payload)}let a=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Mt(n=["aes-128-gcm2","aes-256-gcm2"]).call(n,this._encryptionMode)&&(a=!0,t.payload=await async function(d,l,p){var E;const f=ka(E=Array.from(p)).call(E,(k,U)=>k+U,0),T={serverTs:0,seq:pp++,length:p.length,checkSum:f},R=new Uint8Array(sn(f,2)),v=new ArrayBuffer(Ts),y=new DataView(v);y.setUint32(0,T.serverTs),y.setUint16(4,T.seq),y.setUint16(6,T.length),y.setUint16(8,T.checkSum);const w=16-p.length%16;p=SR(p,new Uint8Array(w));const B=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:d,tagLength:Ek,additionalData:R},l,p);return SR(new Uint8Array(v),new Uint8Array(B))}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new lt(H.INVALID_PARAMS,a?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ue.DATA_STREAM,{payload:Ka(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-A1},!r)}sendMetadata(t){if(!this._joinInfo)throw new lt(H.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new lt(H.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ue.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Ka(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(Q_),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"can not send custom report, not joined");await ee.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,n){lr(n.spatialLayer,"spatialLayer",[0,1,2,3]),lr(n.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,n)}catch(r){throw N.error("[".concat(this._clientId,"] pick SVC layer failed"),r.toString()),r}}async setRTMConfig(t){const{apRTM:n=!1,rtmFlag:r}=t;if(qd(n,"apRTM"),yn(r,"rtmFlag",0),this._rtmConfig.apRTM=n,this._rtmConfig.rtmFlag=r,N.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=n,this._joinInfo.rtmFlag=r,this._gateway.setRTM2Flag(r)}_reset(){if(N.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Xs.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&ht(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&ee.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(n=>n._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Yr("client-publish",this._clientId),this._subscribeMutex=new Yr("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,n){var r;const a=t||K_();t?N.debug("[".concat(this._clientId,"] new Session ").concat(a)):N.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(a));const d=t?"":this._sessionId||"";this._sessionId=a,this.store.sessionId=a,ee.addSid(a);const l={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(n==null?void 0:n.stringUid)||((r=this._joinInfo)===null||r===void 0?void 0:r.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:d,clientRole:this.role==="audience"?2:1};ee.sessionInit(this._sessionId,lu({cname:n.channel,appid:n.appId},l)),this._joinInfo&&(this._joinInfo.sid=a),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=a)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new lt(H.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&J("FORCE_TURN")&&!J("TURN_ENABLE_TCP")&&!J("TURN_ENABLE_UDP"))throw new lt(H.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");N.debug("[".concat(this._clientId,"] publish high stream"));try{const r=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof zo){const a=(await r.next()).value;if(a){try{await this._gateway.sendExtensionMessage(ai.PUBLISH,a,!0)}catch(d){throw r.throw(d),d}await r.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const a=(await r.next()).value;if(a){var n;let d;try{d=await this._gateway.publish(this._uid,a,!0)}catch(l){if(l.code!==H.DISCONNECT_P2P)throw r.throw(l),l}await r.next(((n=d)===null||n===void 0?void 0:n.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const d of t)d instanceof qn&&d._encoderConfig&&this._gateway.setVideoProfile(d._encoderConfig),!d.muted&&d.enabled||await this._p2pChannel.muteLocalTrack(d)}}catch(r){if(this._p2pChannel.reportPublishEvent(!1,r==null?void 0:r.code,t),(r==null?void 0:r.code)===H.WS_ABORT)return;throw r}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new lt(H.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new lt(H.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));N.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const r=await this._p2pChannel.publishLowStream(this._lowStreamParameter),a=(await r.next()).value;if(a){var n;let d;try{d=await this._gateway.publish(this._uid,a,!0)}catch(l){if(l.code!==H.DISCONNECT_P2P)throw r.throw(l),l}r.next(((n=d)===null||n===void 0?void 0:n.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(r){if(this._p2pChannel.reportPublishEvent(!1,r==null?void 0:r.code,void 0,!0),(r==null?void 0:r.code)===H.WS_ABORT)return;throw r}}_createLiveStreamingClient(t){const n=()=>{if(!this._joinInfo||!this._appId)return new lt(H.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const r=(a={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},LE("LiveStreaming").create(a));var a;return r.onLiveStreamError=(d,l)=>{ee.reportApiInvoke(this._sessionId,{name:Gi.ON_LIVE_STREAM_ERROR,options:[d,l],tag:Si.TRACER}).onSuccess(),this.safeEmit(Ke.LIVE_STREAMING_ERROR,d,l)},r.onLiveStreamWarning=(d,l)=>{ee.reportApiInvoke(this._sessionId,{name:Gi.ON_LIVE_STREAM_WARNING,options:[d,l],tag:Si.TRACER}).onSuccess(),this.safeEmit(Ke.LIVE_STREAMING_WARNING,d,l)},r.on(Ep.REQUEST_WORKER_MANAGER_LIST,(d,l,p)=>{if(!this._joinInfo)return p(new lt(H.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(E,f,T,R){const v=J("UAP_AP").slice(0,J("AJAX_REQUEST_CONCURRENT")).map(y=>f.proxyServer?"https://".concat(f.proxyServer,"/ap/?url=").concat(y+"/api/v1?action=uap"):"https://".concat(y,"/api/v1?action=uap"));return await Og(v,E,f,T,R)})(d,this._joinInfo,this._axiosCancelSource.token,Vi).then(l).catch(p)}),r};return t===ud.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||n(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||n(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new lt(H.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:n,sendResolutionHeight:r}=this.getLocalVideoStats(),a=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:n,height:r}},LE("ChannelMediaRelay").create(t));a.on("state",d=>{d===Zs.RELAY_STATE_FAILURE&&a&&a.dispose(),this.safeEmit(Ke.CHANNEL_MEDIA_RELAY_STATE,d)}),a.on("event",d=>{this.safeEmit(Ke.CHANNEL_MEDIA_RELAY_EVENT,d)}),this._channelMediaRelayClient=a,this._statsCollector.onStatsChanged=(d,l)=>{var p;d==="resolution"&&((p=this._channelMediaRelayClient)===null||p===void 0||p.setVideoProfile(l))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,n){const{added:r,deleted:a}=t,d=[];if(n){const l=[];this._users.forEach(p=>{p._dataChannels.forEach(E=>{r.every(f=>f.uid!==p._uintid||f.stream_id!==E.id)&&l.push({uid:p._uintid,stream_id:E.id,ordered:E.ordered,max_retrans_times:E.maxRetransmits,metadata:E.metadata})})}),l.length>0&&this._handleUpdateDataChannel({added:[],deleted:l})}Array.isArray(r)&&r.length>0&&r.forEach(l=>{const{uid:p,stream_id:E,ordered:f,max_retrans_times:T,metadata:R}=l,v=this._users.find(y=>y._uintid===p);if(!v)return void N.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(N.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(p)),Mt(d).call(d,v)||d.push(v),v._uintid||(v._uintid=p),v._dataChannels.findIndex(y=>y.id===l.stream_id)===-1){const y={id:E,ordered:!!f,maxRetransmits:T,metadata:R},w=function(B){return SO(B,!0)}(y);v._dataChannels.push(w),N.info("[".concat(this._clientId,"] remote user ").concat(v.uid," published datachannel")),n||this.safeEmit(Ke.USER_PUBLISHED,v,"datachannel",y)}this._p2pChannel.hasPendingRemoteDataChannel(v,l.stream_id)&&(N.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(v.uid," after reconnect.")),this._subscribeDataChannel(v,l.stream_id).catch(y=>{N.error("[".concat(this._clientId,"] resubscribe datachannel error"),y.toString())}))}),n&&(this.safeEmit(Ke.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(a)&&a.length>0&&a.forEach(l=>{const{uid:p,stream_id:E}=l,f=this._users.find(R=>R._uintid===p);if(!f)return void N.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const T=f._dataChannels.find(R=>R.id===l.stream_id);T&&(N.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(p)),this._p2pChannel.unsubscribeDataChannel(f,[T]).then(R=>{if(f._dataChannels=f._dataChannels.filter(v=>v!==T),R)return this._gateway.unsubscribeDataChannel(R,f.uid)}),N.info("[".concat(this._clientId,"] remote user ").concat(p," unpublished datachannel ,id:").concat(T.id)),this.safeEmit(Ke.USER_UNPUBLISHED,f,"datachannel",T._config))})}_handleRemoveDataChannels(t){const n=this._users.find(r=>r.uid===t.uid);if(n){if(n._dataChannels!==void 0&&n._dataChannels.length>0){N.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const r=()=>{N.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished datachannel")),n._dataChannels.forEach(a=>{this.safeEmit(Ke.USER_UNPUBLISHED,n,"datachannel",a._config)})};this._p2pChannel.unsubscribeDataChannel(n,n._dataChannels).then(a=>{if(a)return this._gateway.unsubscribeDataChannel(a,n.uid)}),r()}}else N.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Fr.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Fr.CONNECTION_STATE_CHANGE,(t,n,r)=>{var a;if(r===Cn.FALLBACK)return;const d=()=>{this.safeEmit(Ke.CONNECTION_STATE_CHANGE,t,n,r)};if(ee.reportApiInvoke(this._sessionId||((a=this._gateway.joinInfo)===null||a===void 0?void 0:a.sid)||null,{name:Gi.CONNECTION_STATE_CHANGE,options:[t,n,r],tag:Si.TRACER}).onSuccess(JSON.stringify({cur:t,prev:n,reason:r})),N.info("[".concat(this._clientId,"] signal connection state change: ").concat(n," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void d();if(t==="RECONNECTING")this._users.forEach(p=>{p._trust_in_room_=!1,p._trust_audio_enabled_state_=!1,p._trust_video_enabled_state_=!1,p._trust_audio_mute_state_=!1,p._trust_video_mute_state_=!1,p._trust_audio_stream_added_state_=!1,p._trust_video_stream_added_state_=!1,p._is_pre_created||(p._audio_pre_subscribed||(p._audioSSRC=void 0,p._audioOrtc=void 0),p._video_pre_subscribed||(p._videoSSRC=void 0,p._videoOrtc=void 0,p._rtxSsrcId=void 0),p._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var l;this._streamFallbackTypeCacheMap.forEach((p,E)=>{this._gateway.setStreamFallbackOption(E,p).catch(f=>{N.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),f)})}),this._remoteStreamTypeCacheMap.forEach((p,E)=>{this._gateway.setRemoteVideoStreamType(E,p).catch(f=>{N.warning("[".concat(this._clientId,"] auto set remote stream type failed"),f)})}),this._remoteDefaultVideoStreamType!==void 0&&((l=this._joinInfo)===null||l===void 0?void 0:l.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{N.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(p=>{N.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(p))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(p=>!p._trust_in_room_).forEach(p=>{N.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(p.uid)),this._handleUserOffline({uid:p.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(p=>{p._trust_audio_mute_state_||(N.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(p.uid)),this._handleMuteStream(p.uid,Kt.AUDIO,!1)),p._trust_video_mute_state_||(N.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(p.uid)),this._handleMuteStream(p.uid,Kt.VIDEO,!1)),p._trust_audio_enabled_state_||(N.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(p.uid)),this._handleSetStreamLocalEnable("audio",p.uid,!0)),p._trust_video_enabled_state_||(N.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(p.uid)),this._handleSetStreamLocalEnable("video",p.uid,!0)),p._trust_video_stream_added_state_||(N.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(p.uid)),this._handleResetAddStream(p,"video")),p._trust_audio_stream_added_state_||(N.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(p.uid)),this._handleResetAddStream(p,"audio")),p._video_added_||p._audio_added_||(N.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(p.uid)),this._handleRemoveStream({uid:p.uid,uint_id:p._uintid}))}))},1e3))}d()}),this._gateway.on(Fr.REQUEST_NEW_GATEWAY_LIST,async(t,n)=>{if(!this._joinInfo)return n(new lt(H.UNEXPECTED_ERROR,"can not recover, no join info"));try{let r;const a=await dt(lu(lu({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));a?(r=a.ap,pt(a),this._joinInfo.preload=!0):(r=await Ve(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Vi,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=r.gatewayInfo.res,this._joinInfo.gatewayAddrs=r.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=r.gatewayInfo.uni_lbs_ip);const d=[];r.gatewayInfo.gatewayAddrs.forEach(l=>{let{address:p}=l;const[E,f]=p.split(":");this._joinInfo&&this._joinInfo.proxyServer?d.push({proxy:this._joinInfo.proxyServer,host:E,port:f}):d.push({host:E,port:f})}),t(d)}catch(r){n(r)}}),this._gateway.on(Fr.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Ke.NETWORK_QUALITY,t)}),this._gateway.on(Fr.STREAM_TYPE_CHANGE,(t,n)=>{this.safeEmit(Ke.STREAM_TYPE_CHANGED,t,n),ee.reportApiInvoke(this._sessionId,{name:Gi.STREAM_TYPE_CHANGE,options:[t,n],tag:Si.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:n}))}),this._gateway.on(Fr.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(Fr.REQUEST_P2P_CONNECTION_PARAMS,async(t,n,r)=>{try{let a=await this._p2pChannel.getEstablishParams();J("ENABLE_PREALLOC_PC")&&a||(a=await this._p2pChannel.startP2PConnection(t)),n(a)}catch(a){r(a)}}),this._gateway.on(Fr.JOIN_RESPONSE,(t,n)=>{if(this.store.useP2P)return;let r;t.attributes?r=t.attributes.userAttributes.preSubSsrcs:N.debug("no attributes in joinResponse");const a=Yw(t.ortc,n,r);this._p2pChannel.connect(a)}),this._gateway.on(Fr.PRE_CONNECT_PC,async t=>{const{candidates:n,fingerprint:r}=t;if(this._joinInfo&&n.length>0&&!this._p2pChannel.isPlanB){var a;await this._p2pChannel.startP2PConnection({turnServer:this._joinInfo.turnServer});const{cert:d,cid:l}=this._joinInfo.apResponse;await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(l,"_").concat(d),icePwd:"".concat(l,"_").concat(d)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(a=J("FINGERPRINT"))!==null&&a!==void 0?a:r}]},candidates:n,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}})}_handleGatewaySignalEvents(){this._gateway.signal.on(Ue.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Ue.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Ue.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(Ue.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(Ue.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(Ue.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(Ue.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Ue.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Ue.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,Kt.AUDIO,!0)),this._gateway.signal.on(Ue.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,Kt.AUDIO,!1)),this._gateway.signal.on(Ue.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,Kt.VIDEO,!0)),this._gateway.signal.on(Ue.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,Kt.VIDEO,!1)),this._gateway.signal.on(Ue.RECEIVE_METADATA,t=>{const n=bc(t.metadata);this.safeEmit(Ke.RECEIVE_METADATA,t.uid,n)}),this._gateway.signal.on(Ue.ON_DATA_STREAM,async t=>{var n;if(!t)return;let r=bc(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Mt(n=["aes-128-gcm2","aes-256-gcm2"]).call(n,this._encryptionMode)){if(t.payload.length<Ts)throw new lt(H.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(Ts));r=await async function(l,p,E){const f=E.subarray(0,Ts),T=f.slice(8,Ts),R=(T[0]<<8)+T[1],v=(f[6]<<8)+f[7],y=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:l,tagLength:Ek,additionalData:new Uint8Array(sn(R,2))},p,E.subarray(Ts));return new Uint8Array(y).subarray(0,v)}(this._encryptDataStreamIv,this._encryptDataStreamKey,r)}let a=0;if(t.ordered||t.syncWithAudio){const d=this._p2pChannel.getStats(),l=this.remoteUsers.find(E=>E.uid===t.uid),p=d==null?void 0:d.audioRecv.find(E=>E.ssrc===(l==null?void 0:l._audioSSRC));a=p==null?void 0:p.jitterBufferMs}a==null&&(a=0),c(lu(lu({},t),{},{payload:r}),a,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Ue.ON_CRYPT_ERROR,()=>{Al(()=>{N.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Ke.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Ue.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{N.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Cn.TOKEN_EXPIRE),this.safeEmit(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Ue.ON_STREAM_FALLBACK_UPDATE,t=>{N.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(Ke.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Ue.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),N.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(Ue.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(Ue.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(fe.REQUEST_TIMEOUT,(t,n)=>{if(this._joinInfo)switch(t){case ue.PUBLISH:{if(!n)return;const d=n.ortc;if(d){var r,a;const l=d.some(f=>{let{stream_type:T}=f;return T===fn.Audio}),p=d.some(f=>{let{stream_type:T}=f;return T!==fn.Audio}),E=d.some(f=>{let{stream_type:T}=f;return T===fn.Screen||T===fn.ScreenLow});n.state==="offer"&&ee.publish(this._joinInfo.sid,{eventElapse:Pr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:H.TIMEOUT,audio:l,video:p,p2pid:n.p2p_id,publishRequestid:this.store.pubId,screenshare:E,audioName:l?(r=d.find(f=>{let{stream_type:T}=f;return T===fn.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0,videoName:p?(a=d.find(f=>{let{stream_type:T}=f;return T!==fn.Audio}))===null||a===void 0||(a=a.ssrcs[0])===null||a===void 0?void 0:a.ssrcId.toString():void 0})}break}case ue.SUBSCRIBE:n&&ee.subscribe(this._joinInfo.sid,{succ:!1,ec:H.TIMEOUT,audio:n.stream_type===Kt.AUDIO,video:n.stream_type===Kt.VIDEO,peerid:n.stream_id,subscribeRequestid:n.ssrcId,p2pid:this.store.p2pId,eventElapse:Pr.measureFromSubscribeStart(this.store.clientId,n.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(n.ssrcId)})}}),this._gateway.signal.on(Ue.ON_P2P_OK,t=>{}),this._gateway.signal.on(Ue.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;J("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(a=>!Bu(a.string_id||a.stream_id,this.channelName)));const n=[],r=[];for(const a of t.users){let d=this._users.find(R=>R._uintid===a.stream_id);d?d._trust_in_room_=!0:(d=new du(a.string_id||a.stream_id,a.stream_id),this._users.push(d),this.getListeners(Ke.PUBLISHED_USER_LIST).length===0&&(N.debug("[".concat(this._clientId,"] user online"),a.stream_id),this.safeEmit(Ke.USER_JOINED,d)));const l=Ji.Audio&a.stream_type,p=(Ji.Video|Ji.LwoVideo)&a.stream_type,E=(65280&a.stream_type)!=0,f=l&&d.hasAudio,T=p&&d.hasVideo;p&&(d._trust_video_stream_added_state_=!0,d._video_added_=!0,d._videoSSRC=a.video_ssrc,d._rtxSsrcId=a.video_rtx),l&&(d._trust_audio_stream_added_state_=!0,d._audio_added_=!0,d._audioSSRC=a.audio_ssrc),l&&!f&&this.getListeners(Ke.PUBLISHED_USER_LIST).length===0&&(N.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published audio")),this.safeEmit(Ke.USER_PUBLISHED,d,"audio")),p&&!T&&this.getListeners(Ke.PUBLISHED_USER_LIST).length===0&&(N.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published video")),this.safeEmit(Ke.USER_PUBLISHED,d,"video")),(l&&!f||p&&!T||E)&&n.push(d),p&&this._p2pChannel.hasPendingRemoteMedia(d,"video")&&r.push({user:d,mediaType:"video"}),l&&this._p2pChannel.hasPendingRemoteMedia(d,"audio")&&r.push({user:d,mediaType:"audio"})}r.length>0&&(N.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(r.map(a=>"user: ".concat(a.user.uid,", mediaType: ").concat(a.mediaType)).join("; ")," ")),this.massSubscribe(r).catch(a=>{N.error("[".concat(this._clientId,"] mass resubscribe error"),a.toString())})),this.getListeners(Ke.PUBLISHED_USER_LIST).length>0?J("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=n:(N.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(n.map(a=>a.uid).join(", "))),this.safeEmit(Ke.PUBLISHED_USER_LIST,n)):N.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(n.map(a=>a.uid).join(", ")))}),this._gateway.signal.on(Ue.ON_RTP_CAPABILITY_CHANGE,t=>{const{video_codec:n}=t;this._p2pChannel instanceof rh&&this._p2pChannel.updateRemoteRTPCapabilities(n.map(r=>r.toLowerCase()).filter(r=>{var a;return Mt(a=Object.keys(Af)).call(a,r)}))})}_handleP2PEvents(){this._gateway.signal.on(Ue.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(ai.PUBLISH,(t,n,r)=>{const{uid:a}=t;t.forEach(d=>{const{kind:l,ssrcs:p,mid:E,isMuted:f}=d;this._handleP2PAddAudioOrVideoStream(l,a,p[0].ssrcId,E);const T=this._users.find(R=>R.uid===a);return T&&this._p2pChannel instanceof zo?this._p2pChannel.mockSubscribe(T,l,p[0].ssrcId,E).then(()=>{n()}).catch(r):n(),this._handleMuteStream(a,l,!!f)})}),this._gateway.signal.on(ai.CALL,async(t,n,r)=>{if(this._p2pChannel instanceof zo)try{var a;n(await this._p2pChannel.startP2P({turnServer:(a=this._joinInfo)===null||a===void 0?void 0:a.turnServer},t))}catch(d){r(d)}}),this._gateway.signal.on(fe.P2P_CONNECTION,async t=>{this._p2pChannel instanceof zo&&await this._p2pChannel.p2pConnect(t)}),this._gateway.signal.on(ai.UNPUBLISH,async(t,n,r)=>{if(this._p2pChannel instanceof zo){const{unpubMsg:a,uid:d}=t,l=this._users.find(p=>p.uid===d);if(!l)return N.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(d)),void n();try{a.forEach(async p=>{let{stream_type:E}=p;const f=E===fn.Audio?Kt.AUDIO:Kt.VIDEO;await this._p2pChannel.unsubscribe(l,f),this._handleMuteStream(d,f,!0)}),n()}catch(p){r(p)}}}),this._gateway.signal.on(ai.CONTROL,async(t,n)=>{const{action:r}=t;switch(r){case Pl.MUTE_LOCAL_VIDEO:this._handleMuteStream(n,Kt.VIDEO,!0);break;case Pl.MUTE_LOCAL_AUDIO:this._handleMuteStream(n,Kt.AUDIO,!0);break;case Pl.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",n),this._handleMuteStream(n,Kt.VIDEO,!1);break;case Pl.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",n),this._handleMuteStream(n,Kt.AUDIO,!1)}}),this._gateway.signal.on(ai.RESTART_ICE,async(t,n,r)=>{if(this._p2pChannel instanceof zo)try{const{direction:a,iceParameter:d}=t;a!==Os.SEND_ONLY||d?n(await this._p2pChannel.restartICE(a,d)):(this._p2pChannel.handleDisconnect(a),n())}catch(a){r(a)}}),this._gateway.signal.on(ai.CANDIDATE,t=>{if(this._p2pChannel instanceof zo){const{candidate:n,direction:r}=t;this._p2pChannel.addRemoteCandidate(n,r)}}),this._p2pChannel.on(ge.RequestP2PRestartICE,async(t,n,r)=>{try{const{direction:a}=t;n(await this._gateway.sendExtensionMessage(ai.RESTART_ICE,t,a===Os.SEND_ONLY))}catch(a){r(a)}}),this._p2pChannel.on(ge.LocalCandidate,t=>{this._gateway.sendExtensionMessage(ai.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(ge.RequestP2PMuteLocal,async(t,n,r)=>{try{await this._gateway.sendExtensionMessage(ai.CONTROL,t,!0),n()}catch(a){r(a)}}),this._p2pChannel.on(ge.RequestP2PUnmuteRemote,async(t,n,r)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(a){a.code===H.DISCONNECT_P2P?n():r(a)}else n()}),this._p2pChannel.on(ge.RequestP2PMuteRemote,async(t,n,r)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(a){a.code===H.DISCONNECT_P2P?n():r(a)}else n()}),this._p2pChannel.on(ge.StateChange,(t,n)=>{n===gn.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(ge.RequestMuteLocal,async(t,n,r)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(a){a.code===H.DISCONNECT_P2P?n():r(a)}else n()}),this._p2pChannel.on(ge.RequestUnmuteLocal,async(t,n,r)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(a){a.code===H.DISCONNECT_P2P?n():r(a)}else n()}),this._p2pChannel.on(ge.RequestRePublish,(t,n,r)=>{this.publish(t,!1).then(n).catch(r)}),this._p2pChannel.on(ge.RequestRePublishDataChannel,(t,n,r)=>{Bt.all(t.map(async a=>{const d=await this._p2pChannel.publishDataChannel([a]);try{d.forEach(l=>{this._uid&&this._gateway.publishDataChannel(this._uid,l,!0)})}catch(l){if(l.code!==H.DISCONNECT_P2P)throw l}})).then(n).catch(r)}),this._p2pChannel.on(ge.RequestReSubscribe,async(t,n,r)=>{try{for(const{user:a,kind:d}of t)d===Kt.VIDEO?await this.subscribe(a,"video"):await this.subscribe(a,"audio");n()}catch(a){r(a)}}),this._p2pChannel.on(ge.RequestUpload,(t,n)=>{this._gateway.upload(t,n)}),this._p2pChannel.on(ge.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(ge.MediaReconnectStart,t=>{this.safeEmit(Ke.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(ge.MediaReconnectEnd,t=>{this.safeEmit(Ke.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(ge.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(ge.RequestRestartICE,async t=>{if(this._p2pChannel instanceof zo)return;const n=await this._p2pChannel.restartICE(t),r=await n.next();if(r.done)return;const a=r.value;let d;try{d=await this._gateway.restartICE({iceParameters:a})}catch(p){return void n.throw(p)}const{iceParameters:l}=function(p){const E=p.iceParameters;return{iceParameters:{iceUfrag:E.iceUfrag,icePwd:E.icePwd}}}(d);await n.next({remoteIceParameters:l})}),this._p2pChannel.on(ge.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(ge.RequestReconnectPC,async()=>{var t;const{iceParameters:n,dtlsParameters:r,rtpCapabilities:a}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:d,gatewayAddress:l}=await this._gateway.reconnectPC({iceParameters:n,dtlsParameters:r,rtpCapabilities:a}),p=Yw(d,l);await this._p2pChannel.connect(p),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(ge.RequestUnpublishForReconnectPC,async(t,n,r)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),n()):r()}),this._p2pChannel.on(ge.P2PLost,()=>{this.safeEmit(Ke.P2P_LOST,this.store.uid)}),this._p2pChannel.on(ge.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(ge.ConnectionTypeChange,t=>{this.safeEmit(Ke.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(ge.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(ge.QueryClientConnectionState,t=>{t(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const r=(n={config:t},LE("ContentInspect").create(n));this._inspect=r,this.handleVideoInspectEvents(r);const{appId:a,cname:d,sid:l,token:p,uid:E,cid:f,vid:T}=this._joinInfo;await r.init({appId:a,areaCode:"",cname:d,sid:l,token:p,uid:E,cid:f,vid:T?Number(T):0},Vi)}catch(r){throw Array.isArray(r)?r[0]:r}var n}handleVideoInspectEvents(t){t.on(Br.CONNECTION_STATE_CHANGE,(n,r)=>{if(this.safeEmit(Ke.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,n,r),r===za.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Ke.CONTENT_INSPECT_ERROR,new lt(H.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(Br.INSPECT_RESULT,(n,r)=>{var a;if((r==null?void 0:r.code)===H.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return N.debug("Stop inspect content because that has left channel"),this==null||(a=this._inspect)===null||a===void 0||a.close(),void(this._inspect=void 0);this.safeEmit(Ke.CONTENT_INSPECT_RESULT,n,r)}),t.on(Br.CLIENT_LOCAL_VIDEO_TRACK,n=>{n(this.localTracks.filter(r=>r.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,n){if(qd(t,"enabled"),t){if(!n)throw new lt(H.INVALID_PARAMS,"config is required");if(cn(n),!this._joinInfo)throw new lt(H.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(n);else{const a=(r={config:n},LE("ImageModeration").create(r));this._moderation=a,this.handleImageModerationEvents(a);const{appId:d,cname:l,sid:p,token:E,uid:f,cid:T,vid:R}=this._joinInfo;await a.init({appId:d,areaCode:"",cname:l,sid:p,token:E,uid:f,cid:T,vid:R?Number(R):0},Vi)}}catch(a){throw Array.isArray(a)?a[0]:a}}else{var r;if(!this._moderation)throw new lt(H.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(a){throw Array.isArray(a)?a[0]:a}}}handleImageModerationEvents(t){t.on(_d.CONNECTION_STATE_CHANGE,(n,r)=>{if(this.safeEmit(Ke.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,n,r),n===$s.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new lt(H.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(_d.CLIENT_LOCAL_VIDEO_TRACK,n=>{n(this.localTracks.filter(r=>r.trackMediaType==="video")[0])})}setP2PTransport(t){if(function(n){lr(n,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new lt(H.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,N.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return N.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){qd(t,"enabled"),on("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,n){switch(n){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},jt(Ht.prototype,"leave",[il],Object.getOwnPropertyDescriptor(Ht.prototype,"leave"),Ht.prototype),jt(Ht.prototype,"publish",[Wc],Object.getOwnPropertyDescriptor(Ht.prototype,"publish"),Ht.prototype),jt(Ht.prototype,"unpublish",[CO],Object.getOwnPropertyDescriptor(Ht.prototype,"unpublish"),Ht.prototype),jt(Ht.prototype,"subscribe",[ZG],Object.getOwnPropertyDescriptor(Ht.prototype,"subscribe"),Ht.prototype),jt(Ht.prototype,"presubscribe",[$G],Object.getOwnPropertyDescriptor(Ht.prototype,"presubscribe"),Ht.prototype),jt(Ht.prototype,"massSubscribe",[t3],Object.getOwnPropertyDescriptor(Ht.prototype,"massSubscribe"),Ht.prototype),jt(Ht.prototype,"unsubscribe",[e3],Object.getOwnPropertyDescriptor(Ht.prototype,"unsubscribe"),Ht.prototype),jt(Ht.prototype,"massUnsubscribe",[n3],Object.getOwnPropertyDescriptor(Ht.prototype,"massUnsubscribe"),Ht.prototype),jt(Ht.prototype,"setLowStreamParameter",[i3],Object.getOwnPropertyDescriptor(Ht.prototype,"setLowStreamParameter"),Ht.prototype),jt(Ht.prototype,"enableDualStream",[r3],Object.getOwnPropertyDescriptor(Ht.prototype,"enableDualStream"),Ht.prototype),jt(Ht.prototype,"disableDualStream",[s3],Object.getOwnPropertyDescriptor(Ht.prototype,"disableDualStream"),Ht.prototype),jt(Ht.prototype,"setClientRole",[o3],Object.getOwnPropertyDescriptor(Ht.prototype,"setClientRole"),Ht.prototype),jt(Ht.prototype,"setProxyServer",[a3],Object.getOwnPropertyDescriptor(Ht.prototype,"setProxyServer"),Ht.prototype),jt(Ht.prototype,"setTurnServer",[c3],Object.getOwnPropertyDescriptor(Ht.prototype,"setTurnServer"),Ht.prototype),jt(Ht.prototype,"setLicense",[d3],Object.getOwnPropertyDescriptor(Ht.prototype,"setLicense"),Ht.prototype),jt(Ht.prototype,"startProxyServer",[u3],Object.getOwnPropertyDescriptor(Ht.prototype,"startProxyServer"),Ht.prototype),jt(Ht.prototype,"stopProxyServer",[l3],Object.getOwnPropertyDescriptor(Ht.prototype,"stopProxyServer"),Ht.prototype),jt(Ht.prototype,"setLocalAccessPointsV2",[h3],Object.getOwnPropertyDescriptor(Ht.prototype,"setLocalAccessPointsV2"),Ht.prototype),jt(Ht.prototype,"setLocalAccessPoints",[p3],Object.getOwnPropertyDescriptor(Ht.prototype,"setLocalAccessPoints"),Ht.prototype),jt(Ht.prototype,"setRemoteDefaultVideoStreamType",[_3],Object.getOwnPropertyDescriptor(Ht.prototype,"setRemoteDefaultVideoStreamType"),Ht.prototype),jt(Ht.prototype,"setRemoteVideoStreamType",[E3],Object.getOwnPropertyDescriptor(Ht.prototype,"setRemoteVideoStreamType"),Ht.prototype),jt(Ht.prototype,"setStreamFallbackOption",[m3],Object.getOwnPropertyDescriptor(Ht.prototype,"setStreamFallbackOption"),Ht.prototype),jt(Ht.prototype,"setEncryptionConfig",[f3],Object.getOwnPropertyDescriptor(Ht.prototype,"setEncryptionConfig"),Ht.prototype),jt(Ht.prototype,"renewToken",[g3],Object.getOwnPropertyDescriptor(Ht.prototype,"renewToken"),Ht.prototype),jt(Ht.prototype,"enableAudioVolumeIndicator",[T3],Object.getOwnPropertyDescriptor(Ht.prototype,"enableAudioVolumeIndicator"),Ht.prototype),jt(Ht.prototype,"startLiveStreaming",[S3],Object.getOwnPropertyDescriptor(Ht.prototype,"startLiveStreaming"),Ht.prototype),jt(Ht.prototype,"setLiveTranscoding",[R3],Object.getOwnPropertyDescriptor(Ht.prototype,"setLiveTranscoding"),Ht.prototype),jt(Ht.prototype,"stopLiveStreaming",[C3],Object.getOwnPropertyDescriptor(Ht.prototype,"stopLiveStreaming"),Ht.prototype),jt(Ht.prototype,"startChannelMediaRelay",[v3],Object.getOwnPropertyDescriptor(Ht.prototype,"startChannelMediaRelay"),Ht.prototype),jt(Ht.prototype,"updateChannelMediaRelay",[I3],Object.getOwnPropertyDescriptor(Ht.prototype,"updateChannelMediaRelay"),Ht.prototype),jt(Ht.prototype,"stopChannelMediaRelay",[y3],Object.getOwnPropertyDescriptor(Ht.prototype,"stopChannelMediaRelay"),Ht.prototype),jt(Ht.prototype,"sendCustomReportMessage",[A3],Object.getOwnPropertyDescriptor(Ht.prototype,"sendCustomReportMessage"),Ht.prototype),jt(Ht.prototype,"pickSVCLayer",[b3],Object.getOwnPropertyDescriptor(Ht.prototype,"pickSVCLayer"),Ht.prototype),jt(Ht.prototype,"setRTMConfig",[w3],Object.getOwnPropertyDescriptor(Ht.prototype,"setRTMConfig"),Ht.prototype),jt(Ht.prototype,"enableContentInspect",[O3],Object.getOwnPropertyDescriptor(Ht.prototype,"enableContentInspect"),Ht.prototype),jt(Ht.prototype,"disableContentInspect",[N3],Object.getOwnPropertyDescriptor(Ht.prototype,"disableContentInspect"),Ht.prototype),jt(Ht.prototype,"setImageModeration",[D3],Object.getOwnPropertyDescriptor(Ht.prototype,"setImageModeration"),Ht.prototype),jt(Ht.prototype,"setP2PTransport",[P3],Object.getOwnPropertyDescriptor(Ht.prototype,"setP2PTransport"),Ht.prototype),jt(Ht.prototype,"getJoinChannelServiceRecords",[L3],Object.getOwnPropertyDescriptor(Ht.prototype,"getJoinChannelServiceRecords"),Ht.prototype),jt(Ht.prototype,"setPublishAudioFilterEnabled",[k3],Object.getOwnPropertyDescriptor(Ht.prototype,"setPublishAudioFilterEnabled"),Ht.prototype),Ht);class vO{constructor(n,r){F(this,"id",0),F(this,"element",void 0),F(this,"peerPair",void 0),F(this,"context",void 0),F(this,"audioPlayerElement",void 0),F(this,"audioTrack",void 0),vO.count+=1,this.id=vO.count,this.element=n,this.context=r}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=n=>{const r=document.createElement("audio");r.srcObject=new MediaStream([n.track]),r.play(),this.audioPlayerElement=r}}async switchSdp(){if(!this.peerPair)return;const n=async(a,d)=>{const l=d==="offer"?await a.createOffer():await a.createAnswer();return await a.setLocalDescription(l),a.iceGatheringState==="complete"?a.localDescription:new Bt(p=>{a.onicegatheringstatechange=()=>{a.iceGatheringState==="complete"&&p(a.localDescription)}})},r=async(a,d)=>await a.setRemoteDescription(d);try{const a=await n(this.peerPair[0],"offer");await r(this.peerPair[1],a);const d=await n(this.peerPair[1],"answer");await r(this.peerPair[0],d)}catch(a){throw new lt(H.LOCAL_AEC_ERROR,a.toString()).print()}}async getTracksFromMediaElement(n){if(this.audioTrack)return this.audioTrack;let r;try{n instanceof HTMLVideoElement&&(n.captureStream?n.captureStream():n.mozCaptureStream()),r=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(n).connect(r)}catch(d){throw new lt(H.LOCAL_AEC_ERROR,d.toString()).print()}if(!r)throw new lt(H.LOCAL_AEC_ERROR,"no dest node when local aec").print();const a=r.stream.getAudioTracks()[0];return this.audioTrack=a,a}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const n=this.element,r=await this.getTracksFromMediaElement(n);this.peerPair&&this.peerPair[0].addTrack(r),await this.switchSdp()}close(){N.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(n=>{n.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var U3,b1;F(vO,"count",0);const R5=window.AudioContext||window.webkitAudioContext,C5=new(U3=me({report:ee}),jt((b1=class{constructor(){F(this,"units",[]),F(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return N.debug("the system does not need to process local aec"),-1;this.context||(this.context=new R5);let n=this.units.find(r=>r&&r.getElement()===t);return n||(n=new vO(t,this.context),this.units.push(n)),n.startEchoCancellation(),N.debug("start processing local audio echo cancellation, id is",n.id),n.id}_doesEnvironmentNeedAEC(){return en().name!==mn.SAFARI}}).prototype,"processExternalMediaAEC",[U3],Object.getOwnPropertyDescriptor(b1.prototype,"processExternalMediaAEC"),b1.prototype),b1);function x3(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function V3(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?x3(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):x3(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}const uG=window||document;function F3(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!uG)return;const r=yr._cspEventHandlerPointer;if(r&&n)return void console.error(r,n);const a=d=>{if(!(d&&d.blockedURI&&(yr.onSecurityPolicyViolation||yr.getListeners(Qd.SECURITY_POLICY_VIOLATION).length>0)))return;const l=d.blockedURI;J("CSP_DETECTED_HOSTNAME_LIST").some(p=>Mt(l).call(l,p))&&(yr.onSecurityPolicyViolation&&typeof yr.onSecurityPolicyViolation=="function"&&yr.onSecurityPolicyViolation(d),yr.getListeners(Qd.SECURITY_POLICY_VIOLATION).length>0&&yr.safeEmit(Qd.SECURITY_POLICY_VIOLATION,d))};r&&uG.removeEventListener("securitypolicyviolation",r),(n||t&&typeof t=="function"||yr.getListeners(Qd.SECURITY_POLICY_VIOLATION).length>0)&&uG.addEventListener("securitypolicyviolation",a),yr._cspEventHandlerPointer=a}var v5=le,I5=bs,B3=RegExp.prototype,y5=function(t){return t===B3||v5(B3,t)?I5(t):t.flags},co=Rt(y5);function xC(t){let n=t.length;for(;--n>=0;)t[n]=0}const lG=256,j3=286,IO=30,yO=15,hG=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),w1=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),A5=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),G3=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Gp=new Array(576);xC(Gp);const AO=new Array(60);xC(AO);const bO=new Array(512);xC(bO);const wO=new Array(256);xC(wO);const pG=new Array(29);xC(pG);const O1=new Array(IO);function _G(t,n,r,a,d){this.static_tree=t,this.extra_bits=n,this.extra_base=r,this.elems=a,this.max_length=d,this.has_stree=t&&t.length}let W3,H3,K3;function EG(t,n){this.dyn_tree=t,this.max_code=0,this.stat_desc=n}xC(O1);const Y3=t=>t<256?bO[t]:bO[256+(t>>>7)],OO=(t,n)=>{t.pending_buf[t.pending++]=255&n,t.pending_buf[t.pending++]=n>>>8&255},Hc=(t,n,r)=>{t.bi_valid>16-r?(t.bi_buf|=n<<t.bi_valid&65535,OO(t,t.bi_buf),t.bi_buf=n>>16-t.bi_valid,t.bi_valid+=r-16):(t.bi_buf|=n<<t.bi_valid&65535,t.bi_valid+=r)},sh=(t,n,r)=>{Hc(t,r[2*n],r[2*n+1])},q3=(t,n)=>{let r=0;do r|=1&t,t>>>=1,r<<=1;while(--n>0);return r>>>1},z3=(t,n,r)=>{const a=new Array(16);let d,l,p=0;for(d=1;d<=yO;d++)p=p+r[d-1]<<1,a[d]=p;for(l=0;l<=n;l++){let E=t[2*l+1];E!==0&&(t[2*l]=q3(a[E]++,E))}},J3=t=>{let n;for(n=0;n<j3;n++)t.dyn_ltree[2*n]=0;for(n=0;n<IO;n++)t.dyn_dtree[2*n]=0;for(n=0;n<19;n++)t.bl_tree[2*n]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},X3=t=>{t.bi_valid>8?OO(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},Q3=(t,n,r,a)=>{const d=2*n,l=2*r;return t[d]<t[l]||t[d]===t[l]&&a[n]<=a[r]},mG=(t,n,r)=>{const a=t.heap[r];let d=r<<1;for(;d<=t.heap_len&&(d<t.heap_len&&Q3(n,t.heap[d+1],t.heap[d],t.depth)&&d++,!Q3(n,a,t.heap[d],t.depth));)t.heap[r]=t.heap[d],r=d,d<<=1;t.heap[r]=a},Z3=(t,n,r)=>{let a,d,l,p,E=0;if(t.sym_next!==0)do a=255&t.pending_buf[t.sym_buf+E++],a+=(255&t.pending_buf[t.sym_buf+E++])<<8,d=t.pending_buf[t.sym_buf+E++],a===0?sh(t,d,n):(l=wO[d],sh(t,l+lG+1,n),p=hG[l],p!==0&&(d-=pG[l],Hc(t,d,p)),a--,l=Y3(a),sh(t,l,r),p=w1[l],p!==0&&(a-=O1[l],Hc(t,a,p)));while(E<t.sym_next);sh(t,256,n)},fG=(t,n)=>{const r=n.dyn_tree,a=n.stat_desc.static_tree,d=n.stat_desc.has_stree,l=n.stat_desc.elems;let p,E,f,T=-1;for(t.heap_len=0,t.heap_max=573,p=0;p<l;p++)r[2*p]!==0?(t.heap[++t.heap_len]=T=p,t.depth[p]=0):r[2*p+1]=0;for(;t.heap_len<2;)f=t.heap[++t.heap_len]=T<2?++T:0,r[2*f]=1,t.depth[f]=0,t.opt_len--,d&&(t.static_len-=a[2*f+1]);for(n.max_code=T,p=t.heap_len>>1;p>=1;p--)mG(t,r,p);f=l;do p=t.heap[1],t.heap[1]=t.heap[t.heap_len--],mG(t,r,1),E=t.heap[1],t.heap[--t.heap_max]=p,t.heap[--t.heap_max]=E,r[2*f]=r[2*p]+r[2*E],t.depth[f]=(t.depth[p]>=t.depth[E]?t.depth[p]:t.depth[E])+1,r[2*p+1]=r[2*E+1]=f,t.heap[1]=f++,mG(t,r,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((R,v)=>{const y=v.dyn_tree,w=v.max_code,B=v.stat_desc.static_tree,k=v.stat_desc.has_stree,U=v.stat_desc.extra_bits,G=v.stat_desc.extra_base,W=v.stat_desc.max_length;let $,rt,ot,Et,vt,Lt,wt=0;for(Et=0;Et<=yO;Et++)R.bl_count[Et]=0;for(y[2*R.heap[R.heap_max]+1]=0,$=R.heap_max+1;$<573;$++)rt=R.heap[$],Et=y[2*y[2*rt+1]+1]+1,Et>W&&(Et=W,wt++),y[2*rt+1]=Et,rt>w||(R.bl_count[Et]++,vt=0,rt>=G&&(vt=U[rt-G]),Lt=y[2*rt],R.opt_len+=Lt*(Et+vt),k&&(R.static_len+=Lt*(B[2*rt+1]+vt)));if(wt!==0){do{for(Et=W-1;R.bl_count[Et]===0;)Et--;R.bl_count[Et]--,R.bl_count[Et+1]+=2,R.bl_count[W]--,wt-=2}while(wt>0);for(Et=W;Et!==0;Et--)for(rt=R.bl_count[Et];rt!==0;)ot=R.heap[--$],ot>w||(y[2*ot+1]!==Et&&(R.opt_len+=(Et-y[2*ot+1])*y[2*ot],y[2*ot+1]=Et),rt--)}})(t,n),z3(r,T,t.bl_count)},$3=(t,n,r)=>{let a,d,l=-1,p=n[1],E=0,f=7,T=4;for(p===0&&(f=138,T=3),n[2*(r+1)+1]=65535,a=0;a<=r;a++)d=p,p=n[2*(a+1)+1],++E<f&&d===p||(E<T?t.bl_tree[2*d]+=E:d!==0?(d!==l&&t.bl_tree[2*d]++,t.bl_tree[32]++):E<=10?t.bl_tree[34]++:t.bl_tree[36]++,E=0,l=d,p===0?(f=138,T=3):d===p?(f=6,T=3):(f=7,T=4))},tW=(t,n,r)=>{let a,d,l=-1,p=n[1],E=0,f=7,T=4;for(p===0&&(f=138,T=3),a=0;a<=r;a++)if(d=p,p=n[2*(a+1)+1],!(++E<f&&d===p)){if(E<T)do sh(t,d,t.bl_tree);while(--E!=0);else d!==0?(d!==l&&(sh(t,d,t.bl_tree),E--),sh(t,16,t.bl_tree),Hc(t,E-3,2)):E<=10?(sh(t,17,t.bl_tree),Hc(t,E-3,3)):(sh(t,18,t.bl_tree),Hc(t,E-11,7));E=0,l=d,p===0?(f=138,T=3):d===p?(f=6,T=3):(f=7,T=4)}};let eW=!1;const nW=(t,n,r,a)=>{Hc(t,0+(a?1:0),3),X3(t),OO(t,r),OO(t,~r),r&&t.pending_buf.set(t.window.subarray(n,n+r),t.pending),t.pending+=r};var b5=t=>{eW||((()=>{let n,r,a,d,l;const p=new Array(16);for(a=0,d=0;d<28;d++)for(pG[d]=a,n=0;n<1<<hG[d];n++)wO[a++]=d;for(wO[a-1]=d,l=0,d=0;d<16;d++)for(O1[d]=l,n=0;n<1<<w1[d];n++)bO[l++]=d;for(l>>=7;d<IO;d++)for(O1[d]=l<<7,n=0;n<1<<w1[d]-7;n++)bO[256+l++]=d;for(r=0;r<=yO;r++)p[r]=0;for(n=0;n<=143;)Gp[2*n+1]=8,n++,p[8]++;for(;n<=255;)Gp[2*n+1]=9,n++,p[9]++;for(;n<=279;)Gp[2*n+1]=7,n++,p[7]++;for(;n<=287;)Gp[2*n+1]=8,n++,p[8]++;for(z3(Gp,287,p),n=0;n<IO;n++)AO[2*n+1]=5,AO[2*n]=q3(n,5);W3=new _G(Gp,hG,257,j3,yO),H3=new _G(AO,w1,0,IO,yO),K3=new _G(new Array(0),A5,0,19,7)})(),eW=!0),t.l_desc=new EG(t.dyn_ltree,W3),t.d_desc=new EG(t.dyn_dtree,H3),t.bl_desc=new EG(t.bl_tree,K3),t.bi_buf=0,t.bi_valid=0,J3(t)},w5=(t,n,r,a)=>{let d,l,p=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(E=>{let f,T=4093624447;for(f=0;f<=31;f++,T>>>=1)if(1&T&&E.dyn_ltree[2*f]!==0)return 0;if(E.dyn_ltree[18]!==0||E.dyn_ltree[20]!==0||E.dyn_ltree[26]!==0)return 1;for(f=32;f<lG;f++)if(E.dyn_ltree[2*f]!==0)return 1;return 0})(t)),fG(t,t.l_desc),fG(t,t.d_desc),p=(E=>{let f;for($3(E,E.dyn_ltree,E.l_desc.max_code),$3(E,E.dyn_dtree,E.d_desc.max_code),fG(E,E.bl_desc),f=18;f>=3&&E.bl_tree[2*G3[f]+1]===0;f--);return E.opt_len+=3*(f+1)+5+5+4,f})(t),d=t.opt_len+3+7>>>3,l=t.static_len+3+7>>>3,l<=d&&(d=l)):d=l=r+5,r+4<=d&&n!==-1?nW(t,n,r,a):t.strategy===4||l===d?(Hc(t,2+(a?1:0),3),Z3(t,Gp,AO)):(Hc(t,4+(a?1:0),3),((E,f,T,R)=>{let v;for(Hc(E,f-257,5),Hc(E,T-1,5),Hc(E,R-4,4),v=0;v<R;v++)Hc(E,E.bl_tree[2*G3[v]+1],3);tW(E,E.dyn_ltree,f-1),tW(E,E.dyn_dtree,T-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,p+1),Z3(t,t.dyn_ltree,t.dyn_dtree)),J3(t),a&&X3(t)},O5=(t,n,r)=>(t.pending_buf[t.sym_buf+t.sym_next++]=n,t.pending_buf[t.sym_buf+t.sym_next++]=n>>8,t.pending_buf[t.sym_buf+t.sym_next++]=r,n===0?t.dyn_ltree[2*r]++:(t.matches++,n--,t.dyn_ltree[2*(wO[r]+lG+1)]++,t.dyn_dtree[2*Y3(n)]++),t.sym_next===t.sym_end),N5=t=>{Hc(t,2,3),sh(t,256,Gp),(n=>{n.bi_valid===16?(OO(n,n.bi_buf),n.bi_buf=0,n.bi_valid=0):n.bi_valid>=8&&(n.pending_buf[n.pending++]=255&n.bi_buf,n.bi_buf>>=8,n.bi_valid-=8)})(t)},D5={_tr_init:b5,_tr_stored_block:nW,_tr_flush_block:w5,_tr_tally:O5,_tr_align:N5},NO=(t,n,r,a)=>{let d=65535&t|0,l=t>>>16&65535|0,p=0;for(;r!==0;){p=r>2e3?2e3:r,r-=p;do d=d+n[a++]|0,l=l+d|0;while(--p);d%=65521,l%=65521}return d|l<<16|0};const P5=new Uint32Array((()=>{let t,n=[];for(var r=0;r<256;r++){t=r;for(var a=0;a<8;a++)t=1&t?3988292384^t>>>1:t>>>1;n[r]=t}return n})());var wo=(t,n,r,a)=>{const d=P5,l=a+r;t^=-1;for(let p=a;p<l;p++)t=t>>>8^d[255&(t^n[p])];return-1^t},Bg={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},N1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:L5,_tr_stored_block:gG,_tr_flush_block:k5,_tr_tally:ME,_tr_align:M5}=D5,{Z_NO_FLUSH:UE,Z_PARTIAL_FLUSH:U5,Z_FULL_FLUSH:x5,Z_FINISH:hu,Z_BLOCK:iW,Z_OK:Zo,Z_STREAM_END:rW,Z_STREAM_ERROR:oh,Z_DATA_ERROR:V5,Z_BUF_ERROR:TG,Z_DEFAULT_COMPRESSION:F5,Z_FILTERED:B5,Z_HUFFMAN_ONLY:D1,Z_RLE:j5,Z_FIXED:G5,Z_DEFAULT_STRATEGY:W5,Z_UNKNOWN:H5,Z_DEFLATED:P1}=N1,SG=286,K5=30,Y5=19,q5=2*SG+1,z5=15,jg=258,ah=262,VC=42,Gg=113,DO=666,Wg=(t,n)=>(t.msg=Bg[n],n),sW=t=>2*t-(t>4?9:0),xE=t=>{let n=t.length;for(;--n>=0;)t[n]=0},J5=t=>{let n,r,a,d=t.w_size;n=t.hash_size,a=n;do r=t.head[--a],t.head[a]=r>=d?r-d:0;while(--n);n=d,a=n;do r=t.prev[--a],t.prev[a]=r>=d?r-d:0;while(--n)};let VE=(t,n,r)=>(n<<t.hash_shift^r)&t.hash_mask;const Dd=t=>{const n=t.state;let r=n.pending;r>t.avail_out&&(r=t.avail_out),r!==0&&(t.output.set(n.pending_buf.subarray(n.pending_out,n.pending_out+r),t.next_out),t.next_out+=r,n.pending_out+=r,t.total_out+=r,t.avail_out-=r,n.pending-=r,n.pending===0&&(n.pending_out=0))},Pd=(t,n)=>{k5(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,n),t.block_start=t.strstart,Dd(t.strm)},Qi=(t,n)=>{t.pending_buf[t.pending++]=n},PO=(t,n)=>{t.pending_buf[t.pending++]=n>>>8&255,t.pending_buf[t.pending++]=255&n},RG=(t,n,r,a)=>{let d=t.avail_in;return d>a&&(d=a),d===0?0:(t.avail_in-=d,n.set(t.input.subarray(t.next_in,t.next_in+d),r),t.state.wrap===1?t.adler=NO(t.adler,n,d,r):t.state.wrap===2&&(t.adler=wo(t.adler,n,d,r)),t.next_in+=d,t.total_in+=d,d)},oW=(t,n)=>{let r,a,d=t.max_chain_length,l=t.strstart,p=t.prev_length,E=t.nice_match;const f=t.strstart>t.w_size-ah?t.strstart-(t.w_size-ah):0,T=t.window,R=t.w_mask,v=t.prev,y=t.strstart+jg;let w=T[l+p-1],B=T[l+p];t.prev_length>=t.good_match&&(d>>=2),E>t.lookahead&&(E=t.lookahead);do if(r=n,T[r+p]===B&&T[r+p-1]===w&&T[r]===T[l]&&T[++r]===T[l+1]){l+=2,r++;do;while(T[++l]===T[++r]&&T[++l]===T[++r]&&T[++l]===T[++r]&&T[++l]===T[++r]&&T[++l]===T[++r]&&T[++l]===T[++r]&&T[++l]===T[++r]&&T[++l]===T[++r]&&l<y);if(a=jg-(y-l),l=y-jg,a>p){if(t.match_start=n,p=a,a>=E)break;w=T[l+p-1],B=T[l+p]}}while((n=v[n&R])>f&&--d!=0);return p<=t.lookahead?p:t.lookahead},FC=t=>{const n=t.w_size;let r,a,d;do{if(a=t.window_size-t.lookahead-t.strstart,t.strstart>=n+(n-ah)&&(t.window.set(t.window.subarray(n,n+n-a),0),t.match_start-=n,t.strstart-=n,t.block_start-=n,t.insert>t.strstart&&(t.insert=t.strstart),J5(t),a+=n),t.strm.avail_in===0)break;if(r=RG(t.strm,t.window,t.strstart+t.lookahead,a),t.lookahead+=r,t.lookahead+t.insert>=3)for(d=t.strstart-t.insert,t.ins_h=t.window[d],t.ins_h=VE(t,t.ins_h,t.window[d+1]);t.insert&&(t.ins_h=VE(t,t.ins_h,t.window[d+3-1]),t.prev[d&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=d,d++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<ah&&t.strm.avail_in!==0)},aW=(t,n)=>{let r,a,d,l=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,p=0,E=t.strm.avail_in;do{if(r=65535,d=t.bi_valid+42>>3,t.strm.avail_out<d||(d=t.strm.avail_out-d,a=t.strstart-t.block_start,r>a+t.strm.avail_in&&(r=a+t.strm.avail_in),r>d&&(r=d),r<l&&(r===0&&n!==hu||n===UE||r!==a+t.strm.avail_in)))break;p=n===hu&&r===a+t.strm.avail_in?1:0,gG(t,0,0,p),t.pending_buf[t.pending-4]=r,t.pending_buf[t.pending-3]=r>>8,t.pending_buf[t.pending-2]=~r,t.pending_buf[t.pending-1]=~r>>8,Dd(t.strm),a&&(a>r&&(a=r),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+a),t.strm.next_out),t.strm.next_out+=a,t.strm.avail_out-=a,t.strm.total_out+=a,t.block_start+=a,r-=a),r&&(RG(t.strm,t.strm.output,t.strm.next_out,r),t.strm.next_out+=r,t.strm.avail_out-=r,t.strm.total_out+=r)}while(p===0);return E-=t.strm.avail_in,E&&(E>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=E&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-E,t.strm.next_in),t.strstart),t.strstart+=E,t.insert+=E>t.w_size-t.insert?t.w_size-t.insert:E),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),p?4:n!==UE&&n!==hu&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(d=t.window_size-t.strstart,t.strm.avail_in>d&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,d+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),d>t.strm.avail_in&&(d=t.strm.avail_in),d&&(RG(t.strm,t.window,t.strstart,d),t.strstart+=d,t.insert+=d>t.w_size-t.insert?t.w_size-t.insert:d),t.high_water<t.strstart&&(t.high_water=t.strstart),d=t.bi_valid+42>>3,d=t.pending_buf_size-d>65535?65535:t.pending_buf_size-d,l=d>t.w_size?t.w_size:d,a=t.strstart-t.block_start,(a>=l||(a||n===hu)&&n!==UE&&t.strm.avail_in===0&&a<=d)&&(r=a>d?d:a,p=n===hu&&t.strm.avail_in===0&&r===a?1:0,gG(t,t.block_start,r,p),t.block_start+=r,Dd(t.strm)),p?3:1)},CG=(t,n)=>{let r,a;for(;;){if(t.lookahead<ah){if(FC(t),t.lookahead<ah&&n===UE)return 1;if(t.lookahead===0)break}if(r=0,t.lookahead>=3&&(t.ins_h=VE(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),r!==0&&t.strstart-r<=t.w_size-ah&&(t.match_length=oW(t,r)),t.match_length>=3)if(a=ME(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=VE(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=VE(t,t.ins_h,t.window[t.strstart+1]);else a=ME(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(a&&(Pd(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,n===hu?(Pd(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(Pd(t,!1),t.strm.avail_out===0)?1:2},BC=(t,n)=>{let r,a,d;for(;;){if(t.lookahead<ah){if(FC(t),t.lookahead<ah&&n===UE)return 1;if(t.lookahead===0)break}if(r=0,t.lookahead>=3&&(t.ins_h=VE(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,r!==0&&t.prev_length<t.max_lazy_match&&t.strstart-r<=t.w_size-ah&&(t.match_length=oW(t,r),t.match_length<=5&&(t.strategy===B5||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){d=t.strstart+t.lookahead-3,a=ME(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=d&&(t.ins_h=VE(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,a&&(Pd(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(a=ME(t,0,t.window[t.strstart-1]),a&&Pd(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(a=ME(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,n===hu?(Pd(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(Pd(t,!1),t.strm.avail_out===0)?1:2};function ch(t,n,r,a,d){this.good_length=t,this.max_lazy=n,this.nice_length=r,this.max_chain=a,this.func=d}const LO=[new ch(0,0,0,0,aW),new ch(4,4,8,4,CG),new ch(4,5,16,8,CG),new ch(4,6,32,32,CG),new ch(4,4,16,16,BC),new ch(8,16,32,32,BC),new ch(8,16,128,128,BC),new ch(8,32,128,256,BC),new ch(32,128,258,1024,BC),new ch(32,258,258,4096,BC)];function X5(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=P1,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*q5),this.dyn_dtree=new Uint16Array(2*(2*K5+1)),this.bl_tree=new Uint16Array(2*(2*Y5+1)),xE(this.dyn_ltree),xE(this.dyn_dtree),xE(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(z5+1),this.heap=new Uint16Array(2*SG+1),xE(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*SG+1),xE(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const kO=t=>{if(!t)return 1;const n=t.state;return!n||n.strm!==t||n.status!==VC&&n.status!==57&&n.status!==69&&n.status!==73&&n.status!==91&&n.status!==103&&n.status!==Gg&&n.status!==DO?1:0},cW=t=>{if(kO(t))return Wg(t,oh);t.total_in=t.total_out=0,t.data_type=H5;const n=t.state;return n.pending=0,n.pending_out=0,n.wrap<0&&(n.wrap=-n.wrap),n.status=n.wrap===2?57:n.wrap?VC:Gg,t.adler=n.wrap===2?0:1,n.last_flush=-2,L5(n),Zo},dW=t=>{const n=cW(t);return n===Zo&&(r=>{r.window_size=2*r.w_size,xE(r.head),r.max_lazy_match=LO[r.level].max_lazy,r.good_match=LO[r.level].good_length,r.nice_match=LO[r.level].nice_length,r.max_chain_length=LO[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=2,r.match_available=0,r.ins_h=0})(t.state),n},uW=(t,n,r,a,d,l)=>{if(!t)return oh;let p=1;if(n===F5&&(n=6),a<0?(p=0,a=-a):a>15&&(p=2,a-=16),d<1||d>9||r!==P1||a<8||a>15||n<0||n>9||l<0||l>G5||a===8&&p!==1)return Wg(t,oh);a===8&&(a=9);const E=new X5;return t.state=E,E.strm=t,E.status=VC,E.wrap=p,E.gzhead=null,E.w_bits=a,E.w_size=1<<E.w_bits,E.w_mask=E.w_size-1,E.hash_bits=d+7,E.hash_size=1<<E.hash_bits,E.hash_mask=E.hash_size-1,E.hash_shift=~~((E.hash_bits+3-1)/3),E.window=new Uint8Array(2*E.w_size),E.head=new Uint16Array(E.hash_size),E.prev=new Uint16Array(E.w_size),E.lit_bufsize=1<<d+6,E.pending_buf_size=4*E.lit_bufsize,E.pending_buf=new Uint8Array(E.pending_buf_size),E.sym_buf=E.lit_bufsize,E.sym_end=3*(E.lit_bufsize-1),E.level=n,E.strategy=l,E.method=r,dW(t)};var Q5=(t,n)=>{if(kO(t)||n>iW||n<0)return t?Wg(t,oh):oh;const r=t.state;if(!t.output||t.avail_in!==0&&!t.input||r.status===DO&&n!==hu)return Wg(t,t.avail_out===0?TG:oh);const a=r.last_flush;if(r.last_flush=n,r.pending!==0){if(Dd(t),t.avail_out===0)return r.last_flush=-1,Zo}else if(t.avail_in===0&&sW(n)<=sW(a)&&n!==hu)return Wg(t,TG);if(r.status===DO&&t.avail_in!==0)return Wg(t,TG);if(r.status===VC&&r.wrap===0&&(r.status=Gg),r.status===VC){let d=P1+(r.w_bits-8<<4)<<8,l=-1;if(l=r.strategy>=D1||r.level<2?0:r.level<6?1:r.level===6?2:3,d|=l<<6,r.strstart!==0&&(d|=32),d+=31-d%31,PO(r,d),r.strstart!==0&&(PO(r,t.adler>>>16),PO(r,65535&t.adler)),t.adler=1,r.status=Gg,Dd(t),r.pending!==0)return r.last_flush=-1,Zo}if(r.status===57){if(t.adler=0,Qi(r,31),Qi(r,139),Qi(r,8),r.gzhead)Qi(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),Qi(r,255&r.gzhead.time),Qi(r,r.gzhead.time>>8&255),Qi(r,r.gzhead.time>>16&255),Qi(r,r.gzhead.time>>24&255),Qi(r,r.level===9?2:r.strategy>=D1||r.level<2?4:0),Qi(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(Qi(r,255&r.gzhead.extra.length),Qi(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(t.adler=wo(t.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69;else if(Qi(r,0),Qi(r,0),Qi(r,0),Qi(r,0),Qi(r,0),Qi(r,r.level===9?2:r.strategy>=D1||r.level<2?4:0),Qi(r,3),r.status=Gg,Dd(t),r.pending!==0)return r.last_flush=-1,Zo}if(r.status===69){if(r.gzhead.extra){let d=r.pending,l=(65535&r.gzhead.extra.length)-r.gzindex;for(;r.pending+l>r.pending_buf_size;){let E=r.pending_buf_size-r.pending;if(r.pending_buf.set(r.gzhead.extra.subarray(r.gzindex,r.gzindex+E),r.pending),r.pending=r.pending_buf_size,r.gzhead.hcrc&&r.pending>d&&(t.adler=wo(t.adler,r.pending_buf,r.pending-d,d)),r.gzindex+=E,Dd(t),r.pending!==0)return r.last_flush=-1,Zo;d=0,l-=E}let p=new Uint8Array(r.gzhead.extra);r.pending_buf.set(p.subarray(r.gzindex,r.gzindex+l),r.pending),r.pending+=l,r.gzhead.hcrc&&r.pending>d&&(t.adler=wo(t.adler,r.pending_buf,r.pending-d,d)),r.gzindex=0}r.status=73}if(r.status===73){if(r.gzhead.name){let d,l=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>l&&(t.adler=wo(t.adler,r.pending_buf,r.pending-l,l)),Dd(t),r.pending!==0)return r.last_flush=-1,Zo;l=0}d=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,Qi(r,d)}while(d!==0);r.gzhead.hcrc&&r.pending>l&&(t.adler=wo(t.adler,r.pending_buf,r.pending-l,l)),r.gzindex=0}r.status=91}if(r.status===91){if(r.gzhead.comment){let d,l=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>l&&(t.adler=wo(t.adler,r.pending_buf,r.pending-l,l)),Dd(t),r.pending!==0)return r.last_flush=-1,Zo;l=0}d=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,Qi(r,d)}while(d!==0);r.gzhead.hcrc&&r.pending>l&&(t.adler=wo(t.adler,r.pending_buf,r.pending-l,l))}r.status=103}if(r.status===103){if(r.gzhead.hcrc){if(r.pending+2>r.pending_buf_size&&(Dd(t),r.pending!==0))return r.last_flush=-1,Zo;Qi(r,255&t.adler),Qi(r,t.adler>>8&255),t.adler=0}if(r.status=Gg,Dd(t),r.pending!==0)return r.last_flush=-1,Zo}if(t.avail_in!==0||r.lookahead!==0||n!==UE&&r.status!==DO){let d=r.level===0?aW(r,n):r.strategy===D1?((l,p)=>{let E;for(;;){if(l.lookahead===0&&(FC(l),l.lookahead===0)){if(p===UE)return 1;break}if(l.match_length=0,E=ME(l,0,l.window[l.strstart]),l.lookahead--,l.strstart++,E&&(Pd(l,!1),l.strm.avail_out===0))return 1}return l.insert=0,p===hu?(Pd(l,!0),l.strm.avail_out===0?3:4):l.sym_next&&(Pd(l,!1),l.strm.avail_out===0)?1:2})(r,n):r.strategy===j5?((l,p)=>{let E,f,T,R;const v=l.window;for(;;){if(l.lookahead<=jg){if(FC(l),l.lookahead<=jg&&p===UE)return 1;if(l.lookahead===0)break}if(l.match_length=0,l.lookahead>=3&&l.strstart>0&&(T=l.strstart-1,f=v[T],f===v[++T]&&f===v[++T]&&f===v[++T])){R=l.strstart+jg;do;while(f===v[++T]&&f===v[++T]&&f===v[++T]&&f===v[++T]&&f===v[++T]&&f===v[++T]&&f===v[++T]&&f===v[++T]&&T<R);l.match_length=jg-(R-T),l.match_length>l.lookahead&&(l.match_length=l.lookahead)}if(l.match_length>=3?(E=ME(l,1,l.match_length-3),l.lookahead-=l.match_length,l.strstart+=l.match_length,l.match_length=0):(E=ME(l,0,l.window[l.strstart]),l.lookahead--,l.strstart++),E&&(Pd(l,!1),l.strm.avail_out===0))return 1}return l.insert=0,p===hu?(Pd(l,!0),l.strm.avail_out===0?3:4):l.sym_next&&(Pd(l,!1),l.strm.avail_out===0)?1:2})(r,n):LO[r.level].func(r,n);if(d!==3&&d!==4||(r.status=DO),d===1||d===3)return t.avail_out===0&&(r.last_flush=-1),Zo;if(d===2&&(n===U5?M5(r):n!==iW&&(gG(r,0,0,!1),n===x5&&(xE(r.head),r.lookahead===0&&(r.strstart=0,r.block_start=0,r.insert=0))),Dd(t),t.avail_out===0))return r.last_flush=-1,Zo}return n!==hu?Zo:r.wrap<=0?rW:(r.wrap===2?(Qi(r,255&t.adler),Qi(r,t.adler>>8&255),Qi(r,t.adler>>16&255),Qi(r,t.adler>>24&255),Qi(r,255&t.total_in),Qi(r,t.total_in>>8&255),Qi(r,t.total_in>>16&255),Qi(r,t.total_in>>24&255)):(PO(r,t.adler>>>16),PO(r,65535&t.adler)),Dd(t),r.wrap>0&&(r.wrap=-r.wrap),r.pending!==0?Zo:rW)},Z5=(t,n)=>{let r=n.length;if(kO(t))return oh;const a=t.state,d=a.wrap;if(d===2||d===1&&a.status!==VC||a.lookahead)return oh;if(d===1&&(t.adler=NO(t.adler,n,r,0)),a.wrap=0,r>=a.w_size){d===0&&(xE(a.head),a.strstart=0,a.block_start=0,a.insert=0);let f=new Uint8Array(a.w_size);f.set(n.subarray(r-a.w_size,r),0),n=f,r=a.w_size}const l=t.avail_in,p=t.next_in,E=t.input;for(t.avail_in=r,t.next_in=0,t.input=n,FC(a);a.lookahead>=3;){let f=a.strstart,T=a.lookahead-2;do a.ins_h=VE(a,a.ins_h,a.window[f+3-1]),a.prev[f&a.w_mask]=a.head[a.ins_h],a.head[a.ins_h]=f,f++;while(--T);a.strstart=f,a.lookahead=2,FC(a)}return a.strstart+=a.lookahead,a.block_start=a.strstart,a.insert=a.lookahead,a.lookahead=0,a.match_length=a.prev_length=2,a.match_available=0,t.next_in=p,t.input=E,t.avail_in=l,a.wrap=d,Zo},MO={deflateInit:(t,n)=>uW(t,n,P1,15,8,W5),deflateInit2:uW,deflateReset:dW,deflateResetKeep:cW,deflateSetHeader:(t,n)=>kO(t)||t.state.wrap!==2?oh:(t.state.gzhead=n,Zo),deflate:Q5,deflateEnd:t=>{if(kO(t))return oh;const n=t.state.status;return t.state=null,n===Gg?Wg(t,V5):Zo},deflateSetDictionary:Z5,deflateInfo:"pako deflate (from Nodeca project)"};const $5=(t,n)=>Object.prototype.hasOwnProperty.call(t,n);var L1={assign:function(t){const n=Array.prototype.slice.call(arguments,1);for(;n.length;){const r=n.shift();if(r){if(typeof r!="object")throw new TypeError(r+"must be non-object");for(const a in r)$5(r,a)&&(t[a]=r[a])}}return t},flattenChunks:t=>{let n=0;for(let a=0,d=t.length;a<d;a++)n+=t[a].length;const r=new Uint8Array(n);for(let a=0,d=0,l=t.length;a<l;a++){let p=t[a];r.set(p,d),d+=p.length}return r}};let lW=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{lW=!1}const UO=new Uint8Array(256);for(let t=0;t<256;t++)UO[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;UO[254]=UO[254]=1;var xO={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let n,r,a,d,l,p=t.length,E=0;for(d=0;d<p;d++)r=t.charCodeAt(d),(64512&r)==55296&&d+1<p&&(a=t.charCodeAt(d+1),(64512&a)==56320&&(r=65536+(r-55296<<10)+(a-56320),d++)),E+=r<128?1:r<2048?2:r<65536?3:4;for(n=new Uint8Array(E),l=0,d=0;l<E;d++)r=t.charCodeAt(d),(64512&r)==55296&&d+1<p&&(a=t.charCodeAt(d+1),(64512&a)==56320&&(r=65536+(r-55296<<10)+(a-56320),d++)),r<128?n[l++]=r:r<2048?(n[l++]=192|r>>>6,n[l++]=128|63&r):r<65536?(n[l++]=224|r>>>12,n[l++]=128|r>>>6&63,n[l++]=128|63&r):(n[l++]=240|r>>>18,n[l++]=128|r>>>12&63,n[l++]=128|r>>>6&63,n[l++]=128|63&r);return n},buf2string:(t,n)=>{const r=n||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,n));let a,d;const l=new Array(2*r);for(d=0,a=0;a<r;){let p=t[a++];if(p<128){l[d++]=p;continue}let E=UO[p];if(E>4)l[d++]=65533,a+=E-1;else{for(p&=E===2?31:E===3?15:7;E>1&&a<r;)p=p<<6|63&t[a++],E--;E>1?l[d++]=65533:p<65536?l[d++]=p:(p-=65536,l[d++]=55296|p>>10&1023,l[d++]=56320|1023&p)}}return((p,E)=>{if(E<65534&&p.subarray&&lW)return String.fromCharCode.apply(null,p.length===E?p:p.subarray(0,E));let f="";for(let T=0;T<E;T++)f+=String.fromCharCode(p[T]);return f})(l,d)},utf8border:(t,n)=>{(n=n||t.length)>t.length&&(n=t.length);let r=n-1;for(;r>=0&&(192&t[r])==128;)r--;return r<0||r===0?n:r+UO[t[r]]>n?r:n}},hW=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const pW=Object.prototype.toString,{Z_NO_FLUSH:t4,Z_SYNC_FLUSH:e4,Z_FULL_FLUSH:n4,Z_FINISH:i4,Z_OK:k1,Z_STREAM_END:r4,Z_DEFAULT_COMPRESSION:s4,Z_DEFAULT_STRATEGY:o4,Z_DEFLATED:a4}=N1;function M1(t){this.options=L1.assign({level:s4,method:a4,chunkSize:16384,windowBits:15,memLevel:8,strategy:o4},t||{});let n=this.options;n.raw&&n.windowBits>0?n.windowBits=-n.windowBits:n.gzip&&n.windowBits>0&&n.windowBits<16&&(n.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new hW,this.strm.avail_out=0;let r=MO.deflateInit2(this.strm,n.level,n.method,n.windowBits,n.memLevel,n.strategy);if(r!==k1)throw new Error(Bg[r]);if(n.header&&MO.deflateSetHeader(this.strm,n.header),n.dictionary){let a;if(a=typeof n.dictionary=="string"?xO.string2buf(n.dictionary):pW.call(n.dictionary)==="[object ArrayBuffer]"?new Uint8Array(n.dictionary):n.dictionary,r=MO.deflateSetDictionary(this.strm,a),r!==k1)throw new Error(Bg[r]);this._dict_set=!0}}function c4(t,n){const r=new M1(n);if(r.push(t,!0),r.err)throw r.msg||Bg[r.err];return r.result}M1.prototype.push=function(t,n){const r=this.strm,a=this.options.chunkSize;let d,l;if(this.ended)return!1;for(l=n===~~n?n:n===!0?i4:t4,typeof t=="string"?r.input=xO.string2buf(t):pW.call(t)==="[object ArrayBuffer]"?r.input=new Uint8Array(t):r.input=t,r.next_in=0,r.avail_in=r.input.length;;)if(r.avail_out===0&&(r.output=new Uint8Array(a),r.next_out=0,r.avail_out=a),(l===e4||l===n4)&&r.avail_out<=6)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else{if(d=MO.deflate(r,l),d===r4)return r.next_out>0&&this.onData(r.output.subarray(0,r.next_out)),d=MO.deflateEnd(this.strm),this.onEnd(d),this.ended=!0,d===k1;if(r.avail_out!==0){if(l>0&&r.next_out>0)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else if(r.avail_in===0)break}else this.onData(r.output)}return!0},M1.prototype.onData=function(t){this.chunks.push(t)},M1.prototype.onEnd=function(t){t===k1&&(this.result=L1.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var d4={deflate:c4};const U1=16209;var u4=function(t,n){let r,a,d,l,p,E,f,T,R,v,y,w,B,k,U,G,W,$,rt,ot,Et,vt,Lt,wt;const $t=t.state;r=t.next_in,Lt=t.input,a=r+(t.avail_in-5),d=t.next_out,wt=t.output,l=d-(n-t.avail_out),p=d+(t.avail_out-257),E=$t.dmax,f=$t.wsize,T=$t.whave,R=$t.wnext,v=$t.window,y=$t.hold,w=$t.bits,B=$t.lencode,k=$t.distcode,U=(1<<$t.lenbits)-1,G=(1<<$t.distbits)-1;t:do{w<15&&(y+=Lt[r++]<<w,w+=8,y+=Lt[r++]<<w,w+=8),W=B[y&U];e:for(;;){if($=W>>>24,y>>>=$,w-=$,$=W>>>16&255,$===0)wt[d++]=65535&W;else{if(!(16&$)){if((64&$)==0){W=B[(65535&W)+(y&(1<<$)-1)];continue e}if(32&$){$t.mode=16191;break t}t.msg="invalid literal/length code",$t.mode=U1;break t}rt=65535&W,$&=15,$&&(w<$&&(y+=Lt[r++]<<w,w+=8),rt+=y&(1<<$)-1,y>>>=$,w-=$),w<15&&(y+=Lt[r++]<<w,w+=8,y+=Lt[r++]<<w,w+=8),W=k[y&G];n:for(;;){if($=W>>>24,y>>>=$,w-=$,$=W>>>16&255,!(16&$)){if((64&$)==0){W=k[(65535&W)+(y&(1<<$)-1)];continue n}t.msg="invalid distance code",$t.mode=U1;break t}if(ot=65535&W,$&=15,w<$&&(y+=Lt[r++]<<w,w+=8,w<$&&(y+=Lt[r++]<<w,w+=8)),ot+=y&(1<<$)-1,ot>E){t.msg="invalid distance too far back",$t.mode=U1;break t}if(y>>>=$,w-=$,$=d-l,ot>$){if($=ot-$,$>T&&$t.sane){t.msg="invalid distance too far back",$t.mode=U1;break t}if(Et=0,vt=v,R===0){if(Et+=f-$,$<rt){rt-=$;do wt[d++]=v[Et++];while(--$);Et=d-ot,vt=wt}}else if(R<$){if(Et+=f+R-$,$-=R,$<rt){rt-=$;do wt[d++]=v[Et++];while(--$);if(Et=0,R<rt){$=R,rt-=$;do wt[d++]=v[Et++];while(--$);Et=d-ot,vt=wt}}}else if(Et+=R-$,$<rt){rt-=$;do wt[d++]=v[Et++];while(--$);Et=d-ot,vt=wt}for(;rt>2;)wt[d++]=vt[Et++],wt[d++]=vt[Et++],wt[d++]=vt[Et++],rt-=3;rt&&(wt[d++]=vt[Et++],rt>1&&(wt[d++]=vt[Et++]))}else{Et=d-ot;do wt[d++]=wt[Et++],wt[d++]=wt[Et++],wt[d++]=wt[Et++],rt-=3;while(rt>2);rt&&(wt[d++]=wt[Et++],rt>1&&(wt[d++]=wt[Et++]))}break}}break}}while(r<a&&d<p);rt=w>>3,r-=rt,w-=rt<<3,y&=(1<<w)-1,t.next_in=r,t.next_out=d,t.avail_in=r<a?a-r+5:5-(r-a),t.avail_out=d<p?p-d+257:257-(d-p),$t.hold=y,$t.bits=w};const x1=15,l4=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),h4=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),p4=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),_4=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var VO=(t,n,r,a,d,l,p,E)=>{const f=E.bits;let T,R,v,y,w,B,k=0,U=0,G=0,W=0,$=0,rt=0,ot=0,Et=0,vt=0,Lt=0,wt=null;const $t=new Uint16Array(16),Ye=new Uint16Array(16);let bn,ri,mr,Li=null;for(k=0;k<=x1;k++)$t[k]=0;for(U=0;U<a;U++)$t[n[r+U]]++;for($=f,W=x1;W>=1&&$t[W]===0;W--);if($>W&&($=W),W===0)return d[l++]=20971520,d[l++]=20971520,E.bits=1,0;for(G=1;G<W&&$t[G]===0;G++);for($<G&&($=G),Et=1,k=1;k<=x1;k++)if(Et<<=1,Et-=$t[k],Et<0)return-1;if(Et>0&&(t===0||W!==1))return-1;for(Ye[1]=0,k=1;k<x1;k++)Ye[k+1]=Ye[k]+$t[k];for(U=0;U<a;U++)n[r+U]!==0&&(p[Ye[n[r+U]]++]=U);if(t===0?(wt=Li=p,B=20):t===1?(wt=l4,Li=h4,B=257):(wt=p4,Li=_4,B=0),Lt=0,U=0,k=G,w=l,rt=$,ot=0,v=-1,vt=1<<$,y=vt-1,t===1&&vt>852||t===2&&vt>592)return 1;for(;;){bn=k-ot,p[U]+1<B?(ri=0,mr=p[U]):p[U]>=B?(ri=Li[p[U]-B],mr=wt[p[U]-B]):(ri=96,mr=0),T=1<<k-ot,R=1<<rt,G=R;do R-=T,d[w+(Lt>>ot)+R]=bn<<24|ri<<16|mr|0;while(R!==0);for(T=1<<k-1;Lt&T;)T>>=1;if(T!==0?(Lt&=T-1,Lt+=T):Lt=0,U++,--$t[k]==0){if(k===W)break;k=n[r+p[U]]}if(k>$&&(Lt&y)!==v){for(ot===0&&(ot=$),w+=G,rt=k-ot,Et=1<<rt;rt+ot<W&&(Et-=$t[rt+ot],!(Et<=0));)rt++,Et<<=1;if(vt+=1<<rt,t===1&&vt>852||t===2&&vt>592)return 1;v=Lt&y,d[v]=$<<24|rt<<16|w-l|0}}return Lt!==0&&(d[w+Lt]=k-ot<<24|64<<16|0),E.bits=$,0};const{Z_FINISH:_W,Z_BLOCK:E4,Z_TREES:V1,Z_OK:Hg,Z_STREAM_END:m4,Z_NEED_DICT:f4,Z_STREAM_ERROR:pu,Z_DATA_ERROR:EW,Z_MEM_ERROR:mW,Z_BUF_ERROR:g4,Z_DEFLATED:fW}=N1,F1=16180,B1=16190,Wp=16191,vG=16192,IG=16194,j1=16199,G1=16200,yG=16206,hs=16209,gW=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function T4(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Kg=t=>{if(!t)return 1;const n=t.state;return!n||n.strm!==t||n.mode<F1||n.mode>16211?1:0},TW=t=>{if(Kg(t))return pu;const n=t.state;return t.total_in=t.total_out=n.total=0,t.msg="",n.wrap&&(t.adler=1&n.wrap),n.mode=F1,n.last=0,n.havedict=0,n.flags=-1,n.dmax=32768,n.head=null,n.hold=0,n.bits=0,n.lencode=n.lendyn=new Int32Array(852),n.distcode=n.distdyn=new Int32Array(592),n.sane=1,n.back=-1,Hg},SW=t=>{if(Kg(t))return pu;const n=t.state;return n.wsize=0,n.whave=0,n.wnext=0,TW(t)},RW=(t,n)=>{let r;if(Kg(t))return pu;const a=t.state;return n<0?(r=0,n=-n):(r=5+(n>>4),n<48&&(n&=15)),n&&(n<8||n>15)?pu:(a.window!==null&&a.wbits!==n&&(a.window=null),a.wrap=r,a.wbits=n,SW(t))},CW=(t,n)=>{if(!t)return pu;const r=new T4;t.state=r,r.strm=t,r.window=null,r.mode=F1;const a=RW(t,n);return a!==Hg&&(t.state=null),a};let AG,bG,vW=!0;const S4=t=>{if(vW){AG=new Int32Array(512),bG=new Int32Array(32);let n=0;for(;n<144;)t.lens[n++]=8;for(;n<256;)t.lens[n++]=9;for(;n<280;)t.lens[n++]=7;for(;n<288;)t.lens[n++]=8;for(VO(1,t.lens,0,288,AG,0,t.work,{bits:9}),n=0;n<32;)t.lens[n++]=5;VO(2,t.lens,0,32,bG,0,t.work,{bits:5}),vW=!1}t.lencode=AG,t.lenbits=9,t.distcode=bG,t.distbits=5},IW=(t,n,r,a)=>{let d;const l=t.state;return l.window===null&&(l.wsize=1<<l.wbits,l.wnext=0,l.whave=0,l.window=new Uint8Array(l.wsize)),a>=l.wsize?(l.window.set(n.subarray(r-l.wsize,r),0),l.wnext=0,l.whave=l.wsize):(d=l.wsize-l.wnext,d>a&&(d=a),l.window.set(n.subarray(r-a,r-a+d),l.wnext),(a-=d)?(l.window.set(n.subarray(r-a,r),0),l.wnext=a,l.whave=l.wsize):(l.wnext+=d,l.wnext===l.wsize&&(l.wnext=0),l.whave<l.wsize&&(l.whave+=d))),0};var R4=(t,n)=>{let r,a,d,l,p,E,f,T,R,v,y,w,B,k,U,G,W,$,rt,ot,Et,vt,Lt=0;const wt=new Uint8Array(4);let $t,Ye;const bn=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Kg(t)||!t.output||!t.input&&t.avail_in!==0)return pu;r=t.state,r.mode===Wp&&(r.mode=vG),p=t.next_out,d=t.output,f=t.avail_out,l=t.next_in,a=t.input,E=t.avail_in,T=r.hold,R=r.bits,v=E,y=f,vt=Hg;t:for(;;)switch(r.mode){case F1:if(r.wrap===0){r.mode=vG;break}for(;R<16;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(2&r.wrap&&T===35615){r.wbits===0&&(r.wbits=15),r.check=0,wt[0]=255&T,wt[1]=T>>>8&255,r.check=wo(r.check,wt,2,0),T=0,R=0,r.mode=16181;break}if(r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&T)<<8)+(T>>8))%31){t.msg="incorrect header check",r.mode=hs;break}if((15&T)!==fW){t.msg="unknown compression method",r.mode=hs;break}if(T>>>=4,R-=4,Et=8+(15&T),r.wbits===0&&(r.wbits=Et),Et>15||Et>r.wbits){t.msg="invalid window size",r.mode=hs;break}r.dmax=1<<r.wbits,r.flags=0,t.adler=r.check=1,r.mode=512&T?16189:Wp,T=0,R=0;break;case 16181:for(;R<16;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(r.flags=T,(255&co(r))!==fW){t.msg="unknown compression method",r.mode=hs;break}if(57344&co(r)){t.msg="unknown header flags set",r.mode=hs;break}r.head&&(r.head.text=T>>8&1),512&co(r)&&4&r.wrap&&(wt[0]=255&T,wt[1]=T>>>8&255,r.check=wo(r.check,wt,2,0)),T=0,R=0,r.mode=16182;case 16182:for(;R<32;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}r.head&&(r.head.time=T),512&co(r)&&4&r.wrap&&(wt[0]=255&T,wt[1]=T>>>8&255,wt[2]=T>>>16&255,wt[3]=T>>>24&255,r.check=wo(r.check,wt,4,0)),T=0,R=0,r.mode=16183;case 16183:for(;R<16;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}r.head&&(r.head.xflags=255&T,r.head.os=T>>8),512&co(r)&&4&r.wrap&&(wt[0]=255&T,wt[1]=T>>>8&255,r.check=wo(r.check,wt,2,0)),T=0,R=0,r.mode=16184;case 16184:if(1024&co(r)){for(;R<16;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}r.length=T,r.head&&(r.head.extra_len=T),512&co(r)&&4&r.wrap&&(wt[0]=255&T,wt[1]=T>>>8&255,r.check=wo(r.check,wt,2,0)),T=0,R=0}else r.head&&(r.head.extra=null);r.mode=16185;case 16185:if(1024&co(r)&&(w=r.length,w>E&&(w=E),w&&(r.head&&(Et=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Uint8Array(r.head.extra_len)),r.head.extra.set(a.subarray(l,l+w),Et)),512&co(r)&&4&r.wrap&&(r.check=wo(r.check,a,w,l)),E-=w,l+=w,r.length-=w),r.length))break t;r.length=0,r.mode=16186;case 16186:if(2048&co(r)){if(E===0)break t;w=0;do Et=a[l+w++],r.head&&Et&&r.length<65536&&(r.head.name+=String.fromCharCode(Et));while(Et&&w<E);if(512&co(r)&&4&r.wrap&&(r.check=wo(r.check,a,w,l)),E-=w,l+=w,Et)break t}else r.head&&(r.head.name=null);r.length=0,r.mode=16187;case 16187:if(4096&co(r)){if(E===0)break t;w=0;do Et=a[l+w++],r.head&&Et&&r.length<65536&&(r.head.comment+=String.fromCharCode(Et));while(Et&&w<E);if(512&co(r)&&4&r.wrap&&(r.check=wo(r.check,a,w,l)),E-=w,l+=w,Et)break t}else r.head&&(r.head.comment=null);r.mode=16188;case 16188:if(512&co(r)){for(;R<16;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(4&r.wrap&&T!==(65535&r.check)){t.msg="header crc mismatch",r.mode=hs;break}T=0,R=0}r.head&&(r.head.hcrc=co(r)>>9&1,r.head.done=!0),t.adler=r.check=0,r.mode=Wp;break;case 16189:for(;R<32;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}t.adler=r.check=gW(T),T=0,R=0,r.mode=B1;case B1:if(r.havedict===0)return t.next_out=p,t.avail_out=f,t.next_in=l,t.avail_in=E,r.hold=T,r.bits=R,f4;t.adler=r.check=1,r.mode=Wp;case Wp:if(n===E4||n===V1)break t;case vG:if(r.last){T>>>=7&R,R-=7&R,r.mode=yG;break}for(;R<3;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}switch(r.last=1&T,T>>>=1,R-=1,3&T){case 0:r.mode=16193;break;case 1:if(S4(r),r.mode=j1,n===V1){T>>>=2,R-=2;break t}break;case 2:r.mode=16196;break;case 3:t.msg="invalid block type",r.mode=hs}T>>>=2,R-=2;break;case 16193:for(T>>>=7&R,R-=7&R;R<32;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if((65535&T)!=(T>>>16^65535)){t.msg="invalid stored block lengths",r.mode=hs;break}if(r.length=65535&T,T=0,R=0,r.mode=IG,n===V1)break t;case IG:r.mode=16195;case 16195:if(w=r.length,w){if(w>E&&(w=E),w>f&&(w=f),w===0)break t;d.set(a.subarray(l,l+w),p),E-=w,l+=w,f-=w,p+=w,r.length-=w;break}r.mode=Wp;break;case 16196:for(;R<14;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(r.nlen=257+(31&T),T>>>=5,R-=5,r.ndist=1+(31&T),T>>>=5,R-=5,r.ncode=4+(15&T),T>>>=4,R-=4,r.nlen>286||r.ndist>30){t.msg="too many length or distance symbols",r.mode=hs;break}r.have=0,r.mode=16197;case 16197:for(;r.have<r.ncode;){for(;R<3;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}r.lens[bn[r.have++]]=7&T,T>>>=3,R-=3}for(;r.have<19;)r.lens[bn[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,$t={bits:r.lenbits},vt=VO(0,r.lens,0,19,r.lencode,0,r.work,$t),r.lenbits=$t.bits,vt){t.msg="invalid code lengths set",r.mode=hs;break}r.have=0,r.mode=16198;case 16198:for(;r.have<r.nlen+r.ndist;){for(;Lt=r.lencode[T&(1<<r.lenbits)-1],U=Lt>>>24,G=Lt>>>16&255,W=65535&Lt,!(U<=R);){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(W<16)T>>>=U,R-=U,r.lens[r.have++]=W;else{if(W===16){for(Ye=U+2;R<Ye;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(T>>>=U,R-=U,r.have===0){t.msg="invalid bit length repeat",r.mode=hs;break}Et=r.lens[r.have-1],w=3+(3&T),T>>>=2,R-=2}else if(W===17){for(Ye=U+3;R<Ye;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}T>>>=U,R-=U,Et=0,w=3+(7&T),T>>>=3,R-=3}else{for(Ye=U+7;R<Ye;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}T>>>=U,R-=U,Et=0,w=11+(127&T),T>>>=7,R-=7}if(r.have+w>r.nlen+r.ndist){t.msg="invalid bit length repeat",r.mode=hs;break}for(;w--;)r.lens[r.have++]=Et}}if(r.mode===hs)break;if(r.lens[256]===0){t.msg="invalid code -- missing end-of-block",r.mode=hs;break}if(r.lenbits=9,$t={bits:r.lenbits},vt=VO(1,r.lens,0,r.nlen,r.lencode,0,r.work,$t),r.lenbits=$t.bits,vt){t.msg="invalid literal/lengths set",r.mode=hs;break}if(r.distbits=6,r.distcode=r.distdyn,$t={bits:r.distbits},vt=VO(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,$t),r.distbits=$t.bits,vt){t.msg="invalid distances set",r.mode=hs;break}if(r.mode=j1,n===V1)break t;case j1:r.mode=G1;case G1:if(E>=6&&f>=258){t.next_out=p,t.avail_out=f,t.next_in=l,t.avail_in=E,r.hold=T,r.bits=R,u4(t,y),p=t.next_out,d=t.output,f=t.avail_out,l=t.next_in,a=t.input,E=t.avail_in,T=r.hold,R=r.bits,r.mode===Wp&&(r.back=-1);break}for(r.back=0;Lt=r.lencode[T&(1<<r.lenbits)-1],U=Lt>>>24,G=Lt>>>16&255,W=65535&Lt,!(U<=R);){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(G&&(240&G)==0){for($=U,rt=G,ot=W;Lt=r.lencode[ot+((T&(1<<$+rt)-1)>>$)],U=Lt>>>24,G=Lt>>>16&255,W=65535&Lt,!($+U<=R);){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}T>>>=$,R-=$,r.back+=$}if(T>>>=U,R-=U,r.back+=U,r.length=W,G===0){r.mode=16205;break}if(32&G){r.back=-1,r.mode=Wp;break}if(64&G){t.msg="invalid literal/length code",r.mode=hs;break}r.extra=15&G,r.mode=16201;case 16201:if(r.extra){for(Ye=r.extra;R<Ye;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}r.length+=T&(1<<r.extra)-1,T>>>=r.extra,R-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=16202;case 16202:for(;Lt=r.distcode[T&(1<<r.distbits)-1],U=Lt>>>24,G=Lt>>>16&255,W=65535&Lt,!(U<=R);){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if((240&G)==0){for($=U,rt=G,ot=W;Lt=r.distcode[ot+((T&(1<<$+rt)-1)>>$)],U=Lt>>>24,G=Lt>>>16&255,W=65535&Lt,!($+U<=R);){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}T>>>=$,R-=$,r.back+=$}if(T>>>=U,R-=U,r.back+=U,64&G){t.msg="invalid distance code",r.mode=hs;break}r.offset=W,r.extra=15&G,r.mode=16203;case 16203:if(r.extra){for(Ye=r.extra;R<Ye;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}r.offset+=T&(1<<r.extra)-1,T>>>=r.extra,R-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){t.msg="invalid distance too far back",r.mode=hs;break}r.mode=16204;case 16204:if(f===0)break t;if(w=y-f,r.offset>w){if(w=r.offset-w,w>r.whave&&r.sane){t.msg="invalid distance too far back",r.mode=hs;break}w>r.wnext?(w-=r.wnext,B=r.wsize-w):B=r.wnext-w,w>r.length&&(w=r.length),k=r.window}else k=d,B=p-r.offset,w=r.length;w>f&&(w=f),f-=w,r.length-=w;do d[p++]=k[B++];while(--w);r.length===0&&(r.mode=G1);break;case 16205:if(f===0)break t;d[p++]=r.length,f--,r.mode=G1;break;case yG:if(r.wrap){for(;R<32;){if(E===0)break t;E--,T|=a[l++]<<R,R+=8}if(y-=f,t.total_out+=y,r.total+=y,4&r.wrap&&y&&(t.adler=r.check=co(r)?wo(r.check,d,y,p-y):NO(r.check,d,y,p-y)),y=f,4&r.wrap&&(co(r)?T:gW(T))!==r.check){t.msg="incorrect data check",r.mode=hs;break}T=0,R=0}r.mode=16207;case 16207:if(r.wrap&&co(r)){for(;R<32;){if(E===0)break t;E--,T+=a[l++]<<R,R+=8}if(4&r.wrap&&T!==(4294967295&r.total)){t.msg="incorrect length check",r.mode=hs;break}T=0,R=0}r.mode=16208;case 16208:vt=m4;break t;case hs:vt=EW;break t;case 16210:return mW;default:return pu}return t.next_out=p,t.avail_out=f,t.next_in=l,t.avail_in=E,r.hold=T,r.bits=R,(r.wsize||y!==t.avail_out&&r.mode<hs&&(r.mode<yG||n!==_W))&&IW(t,t.output,t.next_out,y-t.avail_out),v-=t.avail_in,y-=t.avail_out,t.total_in+=v,t.total_out+=y,r.total+=y,4&r.wrap&&y&&(t.adler=r.check=co(r)?wo(r.check,d,y,t.next_out-y):NO(r.check,d,y,t.next_out-y)),t.data_type=r.bits+(r.last?64:0)+(r.mode===Wp?128:0)+(r.mode===j1||r.mode===IG?256:0),(v===0&&y===0||n===_W)&&vt===Hg&&(vt=g4),vt},Hp={inflateReset:SW,inflateReset2:RW,inflateResetKeep:TW,inflateInit:t=>CW(t,15),inflateInit2:CW,inflate:R4,inflateEnd:t=>{if(Kg(t))return pu;let n=t.state;return n.window&&(n.window=null),t.state=null,Hg},inflateGetHeader:(t,n)=>{if(Kg(t))return pu;const r=t.state;return(2&r.wrap)==0?pu:(r.head=n,n.done=!1,Hg)},inflateSetDictionary:(t,n)=>{const r=n.length;let a,d,l;return Kg(t)?pu:(a=t.state,a.wrap!==0&&a.mode!==B1?pu:a.mode===B1&&(d=1,d=NO(d,n,r,0),d!==a.check)?EW:(l=IW(t,n,r,r),l?(a.mode=16210,mW):(a.havedict=1,Hg)))},inflateInfo:"pako inflate (from Nodeca project)"},C4=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const yW=Object.prototype.toString,{Z_NO_FLUSH:v4,Z_FINISH:I4,Z_OK:FO,Z_STREAM_END:wG,Z_NEED_DICT:OG,Z_STREAM_ERROR:y4,Z_DATA_ERROR:AW,Z_MEM_ERROR:A4}=N1;function W1(t){this.options=L1.assign({chunkSize:65536,windowBits:15,to:""},t||{});const n=this.options;n.raw&&n.windowBits>=0&&n.windowBits<16&&(n.windowBits=-n.windowBits,n.windowBits===0&&(n.windowBits=-15)),!(n.windowBits>=0&&n.windowBits<16)||t&&t.windowBits||(n.windowBits+=32),n.windowBits>15&&n.windowBits<48&&(15&n.windowBits)==0&&(n.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new hW,this.strm.avail_out=0;let r=Hp.inflateInit2(this.strm,n.windowBits);if(r!==FO)throw new Error(Bg[r]);if(this.header=new C4,Hp.inflateGetHeader(this.strm,this.header),n.dictionary&&(typeof n.dictionary=="string"?n.dictionary=xO.string2buf(n.dictionary):yW.call(n.dictionary)==="[object ArrayBuffer]"&&(n.dictionary=new Uint8Array(n.dictionary)),n.raw&&(r=Hp.inflateSetDictionary(this.strm,n.dictionary),r!==FO)))throw new Error(Bg[r])}function b4(t,n){const r=new W1(n);if(r.push(t),r.err)throw r.msg||Bg[r.err];return r.result}W1.prototype.push=function(t,n){const r=this.strm,a=this.options.chunkSize,d=this.options.dictionary;let l,p,E;if(this.ended)return!1;for(p=n===~~n?n:n===!0?I4:v4,yW.call(t)==="[object ArrayBuffer]"?r.input=new Uint8Array(t):r.input=t,r.next_in=0,r.avail_in=r.input.length;;){for(r.avail_out===0&&(r.output=new Uint8Array(a),r.next_out=0,r.avail_out=a),l=Hp.inflate(r,p),l===OG&&d&&(l=Hp.inflateSetDictionary(r,d),l===FO?l=Hp.inflate(r,p):l===AW&&(l=OG));r.avail_in>0&&l===wG&&r.state.wrap>0&&t[r.next_in]!==0;)Hp.inflateReset(r),l=Hp.inflate(r,p);switch(l){case y4:case AW:case OG:case A4:return this.onEnd(l),this.ended=!0,!1}if(E=r.avail_out,r.next_out&&(r.avail_out===0||l===wG))if(this.options.to==="string"){let f=xO.utf8border(r.output,r.next_out),T=r.next_out-f,R=xO.buf2string(r.output,f);r.next_out=T,r.avail_out=a-T,T&&r.output.set(r.output.subarray(f,f+T),0),this.onData(R)}else this.onData(r.output.length===r.next_out?r.output:r.output.subarray(0,r.next_out));if(l!==FO||E!==0){if(l===wG)return l=Hp.inflateEnd(this.strm),this.onEnd(l),this.ended=!0,!0;if(r.avail_in===0)break}}return!0},W1.prototype.onData=function(t){this.chunks.push(t)},W1.prototype.onEnd=function(t){t===FO&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=L1.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var w4={inflate:b4};const{deflate:O4}=d4,{inflate:N4}=w4;var D4=O4,P4=N4,bW=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(bW||{});class L4{constructor(){F(this,"_sequence",0),F(this,"_startTime",Date.now()),F(this,"isUseOneByte",!0)}get startTime(){const n=Date.now()-this._startTime;return n<Math.pow(2,16)?n:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(n){const r={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:n};if(n.byteLength>128){const E=new Uint8Array(4);E.set([1,0,0,0]);const f={id:0,length:4,data:E.buffer},T={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[f]};r.commonPacketHeader.extension=1,r.extension=T,r.payload=this.compress(n),r.commonPacketHeader.length=8+(r.extension.length+2)+r.payload.byteLength}else r.commonPacketHeader.length=8+r.payload.byteLength;J("SHOW_DATASTREAM2_LOG")&&N.debug("send data header: ".concat(JSON.stringify(r.commonPacketHeader)));const a=new ArrayBuffer(r.commonPacketHeader.length),d=new Uint8Array(a),l=new DataView(a);let p=0;if(l.setUint16(p,r.commonPacketHeader.extension<<15|r.commonPacketHeader.reserved<<14|r.commonPacketHeader.length,!0),p+=2,l.setUint32(p,r.commonPacketHeader.sequence,!0),p+=4,l.setUint16(p,r.commonStreamHeader,!0),p+=2,r.extension){const E=this.serializeExtension(r.extension);d.set(new Uint8Array(E),p),p+=E.byteLength}if(d.set(new Uint8Array(r.payload),p),p+=r.payload.byteLength,p!==r.commonPacketHeader.length)throw Error("serialize error!");return a}deserialize(n){if(n.byteLength<4)return new ArrayBuffer(0);const r=new DataView(n);let a=0;const d=r.getUint16(a,!0);a+=2;const l={length:16383&d,reserved:(16384&d)>>14,extension:(32768&d)>>15,sequence:r.getUint16(a+2,!0)<<16|r.getUint16(a,!0)};let p,E;if(a+=4,J("SHOW_DATASTREAM2_LOG")&&N.debug("receive data header: ".concat(JSON.stringify(l))),r.getUint16(a,!0),a+=2,l.extension){E=this.deserializeExtension(n.slice(a)),a+=2+E.length,p=n.slice(a);let f=!1;if(E.datas.length>0){const T=E.datas.find(R=>R.id===0);T&&(f=(1&new DataView(T.data).getUint32(0,!0))==1)}p=f?this.decompress(p):p}else p=n.slice(8);return p}serializeExtension(n){const{profile:r,length:a,datas:d}=n,l=new ArrayBuffer(a+2),p=new Uint8Array(l),E=new DataView(l);let f=0;if(E.setUint8(f++,r),E.setUint8(f++,a),d.forEach(T=>{r?(E.setUint8(f++,T.id),E.setUint8(f++,T.length),p.set(new Uint8Array(T.data),f),f+=T.data.byteLength):(E.setUint8(f++,T.id|T.length<<4),p.set(new Uint8Array(T.data),f),f+=T.data.byteLength)}),f!==a+2)throw Error("serialize extension error, is ".concat(f,"!==").concat(a+2));return l}deserializeExtension(n){const r=new DataView(n);let a=0;const d=r.getUint8(a);a++;const l=r.getUint8(a);a++;const p=d===bW.TWO_BYTE,E=[],f=new DataView(n,2);let T=0;for(;T<l;){let R=0,v=0,y=new ArrayBuffer(0);p?(R=f.getUint8(T),T++,v=f.getUint8(T),T++):(R=15&f.getUint8(T),v=f.getUint8(T)>>4,T++),v>0&&(y=f.buffer.slice(T+2,T+2+v),T+=y.byteLength),E.push({id:R,length:v,data:y})}if(T!==l)throw Error("parse error");return{profile:d,length:l,datas:E}}decompress(n){return P4(new Uint8Array(n))}compress(n){return D4(new Uint8Array(n))}}const k4={name:"DataStream",create:(t,n)=>{const r=n?new Wo(t):new $M(t);return r.useDataStream(new L4),r}};class M4 extends An{constructor(n,r,a){super(),F(this,"ws",void 0),F(this,"requestId",1),F(this,"heartBeatTimer",void 0),F(this,"joinInfo",void 0),F(this,"clientId",void 0),F(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),F(this,"onClose",d=>{this.emit("close"),this.dispose()}),F(this,"onMessage",d=>{const l=JSON.parse(d.data);if(!l||l.command!=="serverResponse"||!l.requestId)return l&&l.command==="serverStatus"&&l.serverStatus&&l.serverStatus.command?(this.emit("status",l.serverStatus),void this.emit(l.serverStatus.command,l.serverStatus)):void 0;this.emit("req_".concat(l.requestId),l)}),this.joinInfo=n,this.clientId=r,this.ws=new Mf("cross-channel-".concat(this.clientId),a),this.ws.on(be.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(be.CONNECTED,this.onOpen),this.ws.on(be.ON_MESSAGE,this.onMessage),this.ws.on(be.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(n){const r=this.requestId++;return n.requestId=r,n.seq=r,this.ws.sendMessage(n),r}waitStatus(n){return new Bt((r,a)=>{const d=window.setTimeout(()=>{a(new lt(H.TIMEOUT,"wait status timeout, status: ".concat(n)))},5e3);this.once(n,l=>{window.clearTimeout(d),l.state&&l.state!==0?a(new lt(H.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(n))):r(void 0)}),this.once("dispose",()=>{window.clearTimeout(d),a(new lt(H.WS_ABORT))})})}async request(n){if(this.ws.state==="closed")throw new lt(H.WS_DISCONNECT);const r=()=>new Bt((p,E)=>{this.ws.once(be.CLOSED,()=>E(new lt(H.WS_ABORT))),this.ws.once(be.CONNECTED,p)});this.ws.state!=="connected"&&await r();const a=this.sendMessage(n),d=new Bt((p,E)=>{const f=()=>{E(new lt(H.WS_ABORT))};this.ws.once(be.RECONNECTING,f),this.ws.once(be.CLOSED,f),this.once("req_".concat(a),p),xr(3e3).then(()=>{this.removeAllListeners("req_".concat(a)),this.ws.off(be.RECONNECTING,f),this.ws.off(be.CLOSED,f),E(new lt(H.TIMEOUT,"cross channel ws request timeout"))})}),l=await d;if(!l||l.code!==200)throw new lt(H.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(l)));return l}async connect(n){this.ws.removeAllListeners(be.REQUEST_NEW_URLS),this.ws.on(be.REQUEST_NEW_URLS,r=>{r(n)}),await this.ws.init(n)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(n){const r=this.requestId++;return n.requestId=r,this.ws.sendMessage(n),r}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class U4 extends An{set state(n){n!==this._state&&(n!==Zs.RELAY_STATE_FAILURE&&(this.errorCode=mp.RELAY_OK),this.emit("state",n,this.errorCode),this._state=n)}get state(){return this._state}constructor(n,r,a,d,l){super(),F(this,"joinInfo",void 0),F(this,"sid",void 0),F(this,"clientId",void 0),F(this,"cancelToken",Xs.CancelToken.source()),F(this,"workerToken",void 0),F(this,"requestId",0),F(this,"signal",void 0),F(this,"prevChannelMediaConfig",void 0),F(this,"httpRetryConfig",void 0),F(this,"_resolution",void 0),F(this,"_state",Zs.RELAY_STATE_IDLE),F(this,"errorCode",mp.RELAY_OK),F(this,"onStatus",p=>{N.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(p))),p&&p.command&&(p.command==="onAudioPacketReceived"&&this.emit("event",ld.PACKET_RECEIVED_AUDIO_FROM_SRC),p.command==="onVideoPacketReceived"&&this.emit("event",ld.PACKET_RECEIVED_VIDEO_FROM_SRC),p.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=mp.SRC_TOKEN_EXPIRED,this.state=Zs.RELAY_STATE_FAILURE),p.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=mp.DEST_TOKEN_EXPIRED,this.state=Zs.RELAY_STATE_FAILURE))}),F(this,"onReconnect",async()=>{N.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",ld.NETWORK_DISCONNECTED),this.state=Zs.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(p=>{this.state!==Zs.RELAY_STATE_IDLE&&(N.error("auto restart channel media relay failed",p.toString()),this.errorCode=mp.SERVER_CONNECTION_LOST,this.state=Zs.RELAY_STATE_FAILURE)})}),this.joinInfo=n,this.clientId=r,this.sid=K_(),this.signal=new M4(this.joinInfo,this.clientId,a),this.httpRetryConfig=d,this._resolution=l}async startChannelMediaRelay(n){if(this.state!==Zs.RELAY_STATE_IDLE)throw new lt(H.INVALID_OPERATION);this.state=Zs.RELAY_STATE_CONNECTING,await this.connect(),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(n)}catch(r){throw r.data&&r.data.serverResponse&&r.data.serverResponse.command==="SetSourceChannel"?new lt(H.CROSS_CHANNEL_FAILED_JOIN_SRC):r.data&&r.data.serverResponse&&r.serverResponse.command==="SetDestChannelStatus"?new lt(H.CROSS_CHANNEL_FAILED_JOIN_DEST):r.data&&r.data.serverResponse&&r.serverResponse.command==="StartPacketTransfer"?new lt(H.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):r}this.prevChannelMediaConfig=n}async updateChannelMediaRelay(n){if(this.state!==Zs.RELAY_STATE_RUNNING)throw new lt(H.INVALID_OPERATION);await this.sendUpdateMessage(n),this.prevChannelMediaConfig=n}async setVideoProfile(n){if(this._resolution=n,this.state!==Zs.RELAY_STATE_RUNNING)throw new lt(H.INVALID_OPERATION);const r=this.genMessage(Cs.SetVideoProfile);await this.signal.request(r),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),N.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Zs.RELAY_STATE_IDLE,this.dispose()}dispose(){N.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Xs.CancelToken.source(),this.state=Zs.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const n=await eO(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=n.workerToken,await this.signal.connect(n.addressList),this.emit("event",ld.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(n){const r=this.genMessage(Cs.StopPacketTransfer);await this.signal.request(r),await this.signal.waitStatus("Normal Quit"),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const a=this.genMessage(Cs.SetSdkProfile,n);await this.signal.request(a),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const d=this.genMessage(Cs.SetSourceChannel,n);await this.signal.request(d),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",ld.PACKET_JOINED_SRC_CHANNEL),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const l=this.genMessage(Cs.SetSourceUserId,n);await this.signal.request(l),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const p=this.genMessage(Cs.SetDestChannel,n);await this.signal.request(p),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",ld.PACKET_JOINED_DEST_CHANNEL),N.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const E=this.genMessage(Cs.StartPacketTransfer,n);await this.signal.request(E),this.emit("event",ld.PACKET_SENT_TO_DEST_CHANNEL),this.state=Zs.RELAY_STATE_RUNNING,N.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(n){const r=this.genMessage(Cs.UpdateDestChannel,n);await this.signal.request(r),this.emit("event",ld.PACKET_UPDATE_DEST_CHANNEL),N.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const n=this.genMessage(Cs.StopPacketTransfer);await this.signal.request(n),N.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(n,r){const a=[],d=[],l=[];this.requestId+=1;const p={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Vt,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};p.sdkVersion==="4.22.2"&&(p.sdkVersion="0.0.1");let E=null,f=null;switch(n){case Cs.SetSdkProfile:return p.clientRequest={command:"SetSdkProfile",type:"multi_channel"},p;case Cs.SetSourceChannel:if(f=r&&r.getSrcChannelMediaInfo(),!f)throw new lt(H.UNEXPECTED_ERROR,"can not find source config");return p.clientRequest={command:"SetSourceChannel",uid:"0",channelName:f.channelName,token:f.token||this.joinInfo.appId},p;case Cs.SetSourceUserId:if(f=r&&r.getSrcChannelMediaInfo(),!f)throw new lt(H.UNEXPECTED_ERROR,"can not find source config");return p.clientRequest={command:"SetSourceUserId",uid:f.uid+""},p;case Cs.SetDestChannel:if(E=r&&r.getDestChannelMediaInfo(),!E)throw new lt(H.UNEXPECTED_ERROR,"can not find dest config");return E.forEach(T=>{a.push(T.channelName),d.push(T.uid+""),l.push(T.token||this.joinInfo.appId)}),p.clientRequest={command:"SetDestChannel",channelName:a,uid:d,token:l},p;case Cs.StartPacketTransfer:return p.clientRequest={command:"StartPacketTransfer"},p;case Cs.Reconnect:return p.clientRequest={command:"Reconnect"},p;case Cs.StopPacketTransfer:return p.clientRequest={command:"StopPacketTransfer"},p;case Cs.UpdateDestChannel:if(E=r&&r.getDestChannelMediaInfo(),!E)throw new lt(H.UNEXPECTED_ERROR,"can not find dest config");return E.forEach(T=>{a.push(T.channelName),d.push(T.uid+""),l.push(T.token||this.joinInfo.appId)}),p.clientRequest={command:"UpdateDestChannel",channelName:a,uid:d,token:l},p;case Cs.SetVideoProfile:p.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return p}}const x4={name:"ChannelMediaRelay",create:function(t){return new U4(t.joinInfo,t.clientId,t.websocketRetryConfig||Vi,t.httpRetryConfig||Vi,t.resolution)}};function wW(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function BO(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?wW(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):wW(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class V4 extends An{constructor(n,r,a,d){super(),F(this,"spec",void 0),F(this,"token",void 0),F(this,"websocket",void 0),F(this,"pingpongTimer",void 0),F(this,"reconnectMode","retry"),F(this,"serviceMode",void 0),F(this,"reqId",0),F(this,"commandReqId",0),F(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),F(this,"handleWebSocketMessage",l=>{if(!l.data)return;const p=JSON.parse(l.data);p.requestId?this.emit("@".concat(p.requestId,"-").concat(p.sid),p):(ee.workerEvent(this.spec.sid,{actionType:"status",serverCode:p.code,workerType:this.serviceMode===ud.TRANSCODE?1:2}),this.emit(wc.PUBLISH_STREAM_STATUS,p))}),this.spec=r,this.token=n,this.serviceMode=d,this.websocket=new Mf("live-streaming",a),this.websocket.on(be.CONNECTED,this.handleWebSocketOpen),this.websocket.on(be.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(be.REQUEST_NEW_URLS,(l,p)=>{Kr(this,wc.REQUEST_NEW_ADDRESS).then(l).catch(p)}),this.websocket.on(be.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(n){return this.websocket.init(n)}async request(n,r,a,d){this.reqId+=1,n==="request"&&(this.commandReqId+=1);const l=this.commandReqId,p=this.reqId;if(!p||!this.websocket)throw new lt(H.UNEXPECTED_ERROR);const E=BO({command:n,sdkVersion:Vt==="4.22.2"?"0.0.1":Vt,seq:p,requestId:p,allocate:a,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},r);if(this.websocket.state==="closed")throw new lt(H.WS_DISCONNECT);const f=()=>new Bt((y,w)=>{this.websocket.once(be.CLOSED,()=>w(new lt(H.WS_ABORT))),this.websocket.once(be.CONNECTED,y)});this.websocket.state!=="connected"&&await f(),E.clientRequest&&(E.clientRequest.workerToken=this.token);const T=new Bt((y,w)=>{const B=()=>{w(new lt(H.WS_ABORT))};this.websocket.once(be.RECONNECTING,B),this.websocket.once(be.CLOSED,B),this.once("@".concat(p,"-").concat(this.spec.sid),k=>{y(k)})});d&&ee.workerEvent(this.spec.sid,BO(BO({},d),{},{requestId:l,actionType:"request",payload:JSON.stringify(r.clientRequest),serverCode:0,code:0}));const R=Date.now();this.websocket.sendMessage(E);let v=null;try{v=await T}catch(y){if(this.websocket.state==="closed")throw y;return await f(),await this.request(n,r,a)}return d&&ee.workerEvent(this.spec.sid,BO(BO({},d),{},{requestId:l,actionType:"response",payload:JSON.stringify(v.serverResponse),serverCode:v.code,success:v.code===200,responseTime:Date.now()-R})),v.code!==200&&this.handleResponseError(v),v}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const n=Vt==="4.22.2"?"0.0.1":Vt;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:n,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(n){switch(n.code){case Fi.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void N.warning("live stream response already exists stream");case Fi.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Fi.LIVE_STREAM_RESPONSE_BAD_STREAM:case Fi.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new lt(H.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:n.code}).throw();case Fi.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(n.serverResponse.command==="UnpublishStream")return;throw new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Fi.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new lt(H.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:n.code}).throw();case Fi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const r=new lt(H.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(wc.WARNING,r,n.serverResponse.url)}case Fi.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const r=new lt(H.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(wc.WARNING,r,n.serverResponse.url)}case Fi.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Fi.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new lt(H.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:n.code}).throw();case Fi.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const r=new lt(H.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(wc.WARNING,r,n.serverResponse.url)}case Fi.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:n.code}).throw();case Fi.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Fi.LIVE_STREAM_RESPONSE_WORKER_LOST:case Fi.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(n.serverResponse.command==="UnpublishStream")return;throw new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Fi.ERROR_FAIL_SEND_MESSAGE:if(n.serverResponse.command==="UnpublishStream")return;if(n.serverResponse.command==="UpdateTranscoding"||n.serverResponse.command==="ControlStream")return new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:n.code}).throw();throw new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Fi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Fi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Fi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Fi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new lt(H.LIVE_STREAMING_CDN_ERROR,"",{code:n.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(RR)},6e3)}}function OW(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}function Aa(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?OW(Object(r),!0).forEach(function(a){F(t,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):OW(Object(r)).forEach(function(a){Object.defineProperty(t,a,Object.getOwnPropertyDescriptor(r,a))})}return t}class F4 extends An{constructor(n){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Vi,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Vi;super(),F(this,"onLiveStreamWarning",void 0),F(this,"onLiveStreamError",void 0),F(this,"spec",void 0),F(this,"retryTimeout",1e4),F(this,"connection",void 0),F(this,"httpRetryConfig",void 0),F(this,"wsRetryConfig",void 0),F(this,"streamingTasks",new Map),F(this,"isStartingStreamingTask",!1),F(this,"taskMutex",new Yr("live-streaming")),F(this,"cancelToken",Xs.CancelToken.source()),F(this,"transcodingConfig",void 0),F(this,"uapResponse",void 0),F(this,"lastTaskId",1),F(this,"statusError",new Map),this.spec=n,this.httpRetryConfig=a,this.wsRetryConfig=r}async setTranscodingConfig(n){const r=Aa(Aa({},ju),n);r.videoCodecProfile!==66&&r.videoCodecProfile!==77&&r.videoCodecProfile!==100&&(N.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(r.videoCodecProfile," -> 100")),r.videoCodecProfile=100),r.transcodingUsers||(r.transcodingUsers=r.userConfigs),r.transcodingUsers&&(r.transcodingUsers=r.transcodingUsers.map(p=>Aa(Aa(Aa({},bR),p),{},{zOrder:p.zOrder?p.zOrder+1:1}))),function(p){Ti(p.width)||yn(p.width,"config.width",0,1e4),Ti(p.height)||yn(p.height,"config.height",0,1e4),Ti(p.videoBitrate)||yn(p.videoBitrate,"config.videoBitrate",1,1e6),Ti(p.videoFrameRate)||yn(p.videoFrameRate,"config.videoFrameRate"),Ti(p.lowLatency)||qd(p.lowLatency,"config.lowLatency"),Ti(p.audioSampleRate)||lr(p.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Ti(p.audioBitrate)||yn(p.audioBitrate,"config.audioBitrate",1,128),Ti(p.audioChannels)||lr(p.audioChannels,"config.audioChannels",[1,2,3,4,5]),Ti(p.videoGop)||yn(p.videoGop,"config.videoGop"),Ti(p.videoCodecProfile)||lr(p.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Ti(p.userCount)||yn(p.userCount,"config.userCount",0,17),Ti(p.backgroundColor)||yn(p.backgroundColor,"config.backgroundColor",0,16777215),Ti(p.userConfigExtraInfo)||Nr(p.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),p.transcodingUsers&&!Ti(p.transcodingUsers)&&(mo(p.transcodingUsers,"config.transcodingUsers"),p.transcodingUsers.forEach((E,f)=>{Dl(E.uid),Ti(E.x)||yn(E.x,"transcodingUser[".concat(f,"].x"),0,1e4),Ti(E.y)||yn(E.y,"transcodingUser[".concat(f,"].y"),0,1e4),Ti(E.width)||yn(E.width,"transcodingUser[".concat(f,"].width"),0,1e4),Ti(E.height)||yn(E.height,"transcodingUser[".concat(f,"].height"),0,1e4),Ti(E.zOrder)||yn(E.zOrder-1,"transcodingUser[".concat(f,"].zOrder"),0,100),Ti(E.alpha)||yn(E.alpha,"transcodingUser[".concat(f,"].alpha"),0,1,!1)})),Ti(p.watermark)||wR(p.watermark,"watermark"),Ti(p.backgroundImage)||wR(p.backgroundImage,"backgroundImage"),p.images&&!Ti(p.images)&&(mo(p.images,"config.images"),p.images.forEach((E,f)=>{wR(E,"images[".concat(f,"]"))}))}(r);const a=[];r.images&&a.push(...r.images.map(p=>Aa(Aa(Aa({},Pb),p),{},{zOrder:255}))),r.backgroundImage&&(a.push(Aa(Aa(Aa({},Pb),r.backgroundImage),{},{zOrder:0})),delete r.backgroundImage),r.watermark&&(a.push(Aa(Aa(Aa({},Pb),r.watermark),{},{zOrder:255})),delete r.watermark),r.images=a,r.transcodingUsers&&(r.userConfigs=r.transcodingUsers.map(p=>Aa({},p)),r.userCount=r.transcodingUsers.length,delete r.transcodingUsers);const d=(r.userConfigs||[]).map(p=>typeof p.uid=="number"?Bt.resolve(p.uid):tO(p.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Bt.all(d)).forEach((p,E)=>{r.userConfigs&&r.userConfigs[E]&&(r.userConfigs[E].uid=p)}),this.transcodingConfig=r,this.connection)try{var l;const p=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from($d(l=this.streamingTasks).call(l)).map(E=>E.taskId).join("#")});N.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(p.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(p){if(!p.data||!p.data.retry)throw p;p.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(E=>{N.warning("[".concat(this.spec.clientId,"] live streaming receive error"),p.toString(),"try to republish",E.url),this.startLiveStreamingTask(E.url,E.mode,p).then(()=>{N.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(E.url," success"))}).catch(f=>{N.error("[".concat(this.spec.clientId,"] live streaming republish failed"),E.url,f.toString()),this.onLiveStreamError&&this.onLiveStreamError(E.url,f)})})}}async startLiveStreamingTask(n,r,a){if(!this.transcodingConfig&&r===ud.TRANSCODE)throw new lt(H.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const d={command:"PublishStream",ts:Date.now(),url:n,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};N.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(n,", mode: ").concat(r));const l=await this.taskMutex.lock();if(!this.connection&&a)return void l();if(this.streamingTasks.get(n)&&!a)return l(),new lt(H.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(r))}catch(E){throw l(),E}switch(r){case ud.TRANSCODE:d.transcodingConfig=Aa({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(d.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const p=this.lastTaskId++;try{const E=new Bt((T,R)=>{xr(this.retryTimeout).then(()=>{if(a)return R(a);const v=this.statusError.get(n);return v?(this.statusError.delete(n),R(v)):void 0})}),f=await Bt.race([this.connection.request("request",{clientRequest:d},!0,{url:n,command:"PublishStream",workerType:r===ud.TRANSCODE?1:2,requestByUser:!a,tid:p.toString()}),E]);this.isStartingStreamingTask=!1,N.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(f.code)),this.streamingTasks.set(n,{clientRequest:d,mode:r,url:n,taskId:p}),l()}catch(E){if(l(),this.isStartingStreamingTask=!1,!E.data||!E.data.retry||a)throw E;return E.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(n,r,E)):await this.startLiveStreamingTask(n,r,E)}}stopLiveStreamingTask(n){return new Bt((r,a)=>{const d=this.streamingTasks.get(n);if(!d||!this.connection)return new lt(H.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const l=d.mode;d.abortTask=()=>{N.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(n),r()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:d.url}},!1,{url:n,command:"UnPublishStream",workerType:l===ud.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(p=>{N.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(p.code)),this.streamingTasks.delete(n),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),r()}).catch(a)})}resetAllTask(){var n;const r=Array.from($d(n=this.streamingTasks).call(n));this.terminate();for(const a of r)this.startLiveStreamingTask(a.url,a.mode).catch(d=>{this.onLiveStreamError&&this.onLiveStreamError(a.url,d)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Xs.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(n){if(this.connection)throw new lt(H.UNEXPECTED_ERROR,"live streaming connection has already connected");const r=await Kr(this,Ep.REQUEST_WORKER_MANAGER_LIST,n);return this.uapResponse=r,this.connection=new V4(r.workerToken,this.spec,this.wsRetryConfig,n),this.connection.on(wc.WARNING,(a,d)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(d,a)),this.connection.on(wc.PUBLISH_STREAM_STATUS,a=>this.handlePublishStreamServer(a)),this.connection.on(wc.REQUEST_NEW_ADDRESS,(a,d)=>{if(!this.connection)return d(new lt(H.UNEXPECTED_ERROR,"can not get new live streaming address list"));Kr(this,Ep.REQUEST_WORKER_MANAGER_LIST,n).then(l=>{this.uapResponse=l,a(l.addressList)}).catch(d)}),await this.connection.init(r.addressList),this.connection}handlePublishStreamServer(n){const r=n.serverStatus&&n.serverStatus.url||"empty_url",a=this.streamingTasks.get(r),d=n.reason;switch(n.code){case Fi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Fi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Fi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Fi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const p=new lt(H.LIVE_STREAMING_CDN_ERROR,"",{code:n.code});if(a)return N.error(p.toString()),this.onLiveStreamError&&this.onLiveStreamError(r,p);if(!this.isStartingStreamingTask)return;this.statusError.set(r,p)}case Fi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const p=new lt(H.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,d);return this.onLiveStreamWarning&&this.onLiveStreamWarning(r,p)}case Fi.LIVE_STREAM_RESPONSE_WORKER_LOST:case Fi.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var l;if(!this.connection)return;this.connection.tryNextAddress();const p=Array.from($d(l=this.streamingTasks).call(l));for(const E of p)E.abortTask?E.abortTask():(N.warning("[".concat(this.spec.clientId,"] publish stream status code"),n.code,"try to republish",E.url),this.startLiveStreamingTask(E.url,E.mode,new lt(H.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:n.code})).then(()=>{N.debug("[".concat(this.spec.clientId,"] republish live stream success"),E.url)}).catch(f=>{N.error(f.toString()),this.onLiveStreamError&&this.onLiveStreamError(E.url,f)}));return}}}hasUrl(n){return this.streamingTasks.has(n)}}const B4={name:"LiveStreaming",create:function(t){return new F4(t.joinInfo,t.websocketRetryConfig||Vi,t.httpRetryConfig||Vi)}};function j4(t){let n=PW();return function(r,a){let d=r.appId;d!==void 0&&(Un(a,10),dh(a,d));let l=r.cid;l!==void 0&&(Un(a,16),Un(a,l));let p=r.cname;p!==void 0&&(Un(a,26),dh(a,p));let E=r.deviceId;E!==void 0&&(Un(a,34),dh(a,E));let f=r.elapse;f!==void 0&&(Un(a,40),FE(a,f));let T=r.fileSize;T!==void 0&&(Un(a,48),FE(a,jC(T)));let R=r.height;R!==void 0&&(Un(a,56),FE(a,jC(R)));let v=r.jpg;v!==void 0&&(Un(a,66),Un(a,v.length),function(_u,Ct){let Pt=GC(_u,Ct.length);_u.bytes.set(Ct,Pt)}(a,v));let y=r.networkType;y!==void 0&&(Un(a,72),FE(a,jC(y)));let w=r.osType;w!==void 0&&(Un(a,80),FE(a,jC(w)));let B=r.requestId;B!==void 0&&(Un(a,90),dh(a,B));let k=r.sdkVersion;k!==void 0&&(Un(a,98),dh(a,k));let U=r.sequence;U!==void 0&&(Un(a,104),FE(a,jC(U)));let G=r.sid;G!==void 0&&(Un(a,114),dh(a,G));let W=r.timestamp;W!==void 0&&(Un(a,120),FE(a,W));let $=r.uid;$!==void 0&&(Un(a,128),Un(a,$));let rt=r.vid;rt!==void 0&&(Un(a,136),Un(a,rt));let ot=r.width;ot!==void 0&&(Un(a,144),FE(a,jC(ot)));let Et=r.service;Et!==void 0&&(Un(a,152),Un(a,Et));let vt=r.callbackData;vt!==void 0&&(Un(a,162),dh(a,vt));let Lt=r.jpgEncryption;Lt!==void 0&&(Un(a,168),Un(a,Lt));let wt=r.requestType;wt!==void 0&&(Un(a,176),Un(a,wt));let $t=r.scorePorn;$t!==void 0&&(Un(a,185),kG(a,$t));let Ye=r.scoreSexy;Ye!==void 0&&(Un(a,193),kG(a,Ye));let bn=r.scoreNeutral;bn!==void 0&&(Un(a,201),kG(a,bn));let ri=r.scene;ri!==void 0&&(Un(a,208),Un(a,ri));let mr=r.ossFilePrefix;mr!==void 0&&(Un(a,218),dh(a,mr));let Li=r.serviceVendor;if(Li!==void 0)for(let _u of Li){Un(a,226);let Ct=PW();H4(_u,Ct),Un(a,Ct.limit),q4(a,Ct),Y4(Ct)}}(t,n),function(r){let a=r.bytes,d=r.limit;return a.length===d?a:a.subarray(0,d)}(n)}function G4(t){return function(r){let a={};t:for(;!LW(r);){let d=uh(r);switch(d>>>3){case 0:break t;case 1:a.code=uh(r);break;case 2:a.msg=kW(r,uh(r));break;case 3:{let l=K4(r);a.data=W4(r),r.limit=l;break}default:NW(r,7&d)}}return a}({bytes:n=t,offset:0,limit:n.length});var n}function W4(t){let n={};t:for(;!LW(t);){let r=uh(t);switch(r>>>3){case 0:break t;case 1:n.requestId=kW(t,uh(t));break;case 2:n.requestType=uh(t)>>>0;break;case 3:n.scorePorn=LG(t);break;case 4:n.scoreSexy=LG(t);break;case 5:n.scoreNeutral=LG(t);break;case 6:n.requestScene=uh(t)>>>0;break;case 7:n.scene=uh(t)>>>0;break;default:NW(t,7&r)}}return n}function H4(t,n){let r=t.service;r!==void 0&&(Un(n,8),Un(n,r));let a=t.vendor;a!==void 0&&(Un(n,16),Un(n,a));let d=t.token;d!==void 0&&(Un(n,26),dh(n,d));let l=t.callbackUrl;l!==void 0&&(Un(n,34),dh(n,l))}function K4(t){let n=uh(t),r=t.limit;return t.limit=t.offset+n,r}function NW(t,n){switch(n){case 0:for(;128&MW(t););break;case 2:DG(t,uh(t));break;case 5:DG(t,4);break;case 1:DG(t,8);break;default:throw new Error("Unimplemented type: "+n)}}let NG=new Float64Array(1),ba=new Uint8Array(NG.buffer);function jC(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let DW=[];function PW(){const t=DW.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function Y4(t){DW.push(t)}function DG(t,n){if(t.offset+n>t.limit)throw new Error("Skip past limit");t.offset+=n}function LW(t){return t.offset>=t.limit}function GC(t,n){let r=t.bytes,a=t.offset,d=t.limit,l=a+n;if(l>r.length){let p=new Uint8Array(2*l);p.set(r),t.bytes=p}return t.offset=l,l>d&&(t.limit=l),a}function PG(t,n){let r=t.offset;if(r+n>t.limit)throw new Error("Read past limit");return t.offset+=n,r}function kW(t,n){let r=PG(t,n),a=String.fromCharCode,d=t.bytes,l="�",p="";for(let E=0;E<n;E++){let f,T,R,v,y=d[E+r];(128&y)==0?p+=a(y):(224&y)==192?E+1>=n?p+=l:(f=d[E+r+1],(192&f)!=128?p+=l:(v=(31&y)<<6|63&f,v<128?p+=l:(p+=a(v),E++))):(240&y)==224?E+2>=n?p+=l:(f=d[E+r+1],T=d[E+r+2],(49344&(f|T<<8))!=32896?p+=l:(v=(15&y)<<12|(63&f)<<6|63&T,v<2048||v>=55296&&v<=57343?p+=l:(p+=a(v),E+=2))):(248&y)==240?E+3>=n?p+=l:(f=d[E+r+1],T=d[E+r+2],R=d[E+r+3],(12632256&(f|T<<8|R<<16))!=8421504?p+=l:(v=(7&y)<<18|(63&f)<<12|(63&T)<<6|63&R,v<65536||v>1114111?p+=l:(v-=65536,p+=a(55296+(v>>10),56320+(1023&v)),E+=3))):p+=l}return p}function dh(t,n){let r=n.length,a=0;for(let p=0;p<r;p++){let E=n.charCodeAt(p);E>=55296&&E<=56319&&p+1<r&&(E=(E<<10)+n.charCodeAt(++p)-56613888),a+=E<128?1:E<2048?2:E<65536?3:4}Un(t,a);let d=GC(t,a),l=t.bytes;for(let p=0;p<r;p++){let E=n.charCodeAt(p);E>=55296&&E<=56319&&p+1<r&&(E=(E<<10)+n.charCodeAt(++p)-56613888),E<128?l[d++]=E:(E<2048?l[d++]=E>>6&31|192:(E<65536?l[d++]=E>>12&15|224:(l[d++]=E>>18&7|240,l[d++]=E>>12&63|128),l[d++]=E>>6&63|128),l[d++]=63&E|128)}}function q4(t,n){let r=GC(t,n.limit),a=t.bytes,d=n.bytes;for(let l=0,p=n.limit;l<p;l++)a[l+r]=d[l]}function MW(t){return t.bytes[PG(t,1)]}function UW(t,n){let r=GC(t,1);t.bytes[r]=n}function LG(t){let n=PG(t,8),r=t.bytes;return ba[0]=r[n++],ba[1]=r[n++],ba[2]=r[n++],ba[3]=r[n++],ba[4]=r[n++],ba[5]=r[n++],ba[6]=r[n++],ba[7]=r[n++],NG[0]}function kG(t,n){let r=GC(t,8),a=t.bytes;NG[0]=n,a[r++]=ba[0],a[r++]=ba[1],a[r++]=ba[2],a[r++]=ba[3],a[r++]=ba[4],a[r++]=ba[5],a[r++]=ba[6],a[r++]=ba[7]}function uh(t){let n,r=0,a=0;do n=MW(t),r<32&&(a|=(127&n)<<r),r+=7;while(128&n);return a}function Un(t,n){for(n>>>=0;n>=128;)UW(t,127&n|128),n>>>=7;UW(t,n)}function FE(t,n){let r=n.low>>>0,a=(n.low>>>28|n.high<<4)>>>0,d=n.high>>>24,l=d===0?a===0?r<16384?r<128?1:2:r<1<<21?3:4:a<16384?a<128?5:6:a<1<<21?7:8:d<128?9:10,p=GC(t,l),E=t.bytes;switch(l){case 10:E[p+9]=d>>>7&1;case 9:E[p+8]=l!==9?128|d:127&d;case 8:E[p+7]=l!==8?a>>>21|128:a>>>21&127;case 7:E[p+6]=l!==7?a>>>14|128:a>>>14&127;case 6:E[p+5]=l!==6?a>>>7|128:a>>>7&127;case 5:E[p+4]=l!==5?128|a:127&a;case 4:E[p+3]=l!==4?r>>>21|128:r>>>21&127;case 3:E[p+2]=l!==3?r>>>14|128:r>>>14&127;case 2:E[p+1]=l!==2?r>>>7|128:r>>>7&127;case 1:E[p]=l!==1?128|r:127&r}}function xW(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);n&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),r.push.apply(r,a)}return r}const z4=new Map([["moderation",1],["supervise",2]]);function VW(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}class J4 extends An{get connectionState(){return this._connectionState}set connectionState(n){if(this._connectionState===n)return;const r=this._connectionState;this._connectionState=n,this.emit(Br.CONNECTION_STATE_CHANGE,r,n)}get inspectType(){return this._inspectType}set inspectType(n){var r;this._inspectMode=ka(r=n.map(a=>z4.get(a)||0)).call(r,(a,d)=>a+d),this._inspectType=n}get quality(){return this._quality}set quality(n){this._quality=n>1?1:n<.1?.1:n,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(n){super(),F(this,"name","AgoraRTCVideoContentInspect"),F(this,"_connectionState",za.CONNECTING),F(this,"_innerConnectionState",void 0),F(this,"sequence",0),F(this,"inspectStartTime",void 0),F(this,"workerManagerConnection",void 0),F(this,"workerConnection",void 0),F(this,"workerMessageLengthLimit",void 0),F(this,"inspectIntervalMinimum",void 0),F(this,"qualityRatio",void 0),F(this,"_connectInfo",void 0),F(this,"_cancelTokenSource",Xs.CancelToken.source()),F(this,"_retryConfig",void 0),F(this,"wmSequence",0),F(this,"inspectInterval",void 0),F(this,"inspectTimer",null),F(this,"ossFilePrefix",void 0),F(this,"extraInfo",void 0),F(this,"_inspectType",void 0),F(this,"_inspectMode",void 0),F(this,"_quality",1),F(this,"qualityTimer",null),F(this,"_inspectId",void 0),F(this,"_needWorkUrlOnly",!1),F(this,"inspectImage",()=>{if(this.connectionState!==za.CONNECTED)throw new lt(H.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===za.CONNECTED?this.requestToInspectImage():N.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Vn(5,"inspect-"),this.workerMessageLengthLimit=J("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=J("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=J("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=n.interval,this.ossFilePrefix=n.ossFilePrefix,this.extraInfo=n.extraInfo,this.inspectType=n.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Mf("worker-manager-"+this._inspectId,Vi),this.on(Br.STATE_CHANGE,(r,a)=>{this._innerConnectionState=r,N.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Oc[r]," ").concat(a||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Mf("worker-"+this._inspectId,Vi),this.handleWorkerEvents()}async init(n,r){this.emit(Br.STATE_CHANGE,Oc.CONNECT_AP),this._connectInfo=n;const a=this._cancelTokenSource.token;return this._retryConfig=r,new Bt((d,l)=>{this.on(Br.CONNECTION_STATE_CHANGE,(p,E)=>{E===za.CONNECTED&&d()}),this.requestAP(n,a,r).then(p=>{this.connectWorkerManager(p)}).catch(p=>{l(p)})})}async requestAP(n,r,a){const d=J("WEBCS_DOMAIN").map(E=>"https://".concat(E,"/api/v1")),l=await function(E,f,T,R){let{appId:v,areaCode:y,cname:w,sid:B,token:k,uid:U}=f;th++;const G="image_moderation_api",W={service_name:G,json_body:JSON.stringify({appId:v,areaCode:y,cname:w,command:"allocateEdge",requestId:th,seq:th,sid:B,token:k,ts:Date.now(),uid:U+""})};let $,rt,ot=E[0];return cd(async()=>{$=Date.now();const Et=await Fc(ot,{data:W,cancelToken:T,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(rt=Date.now()-$,Et.code!==0){const $t=new lt(H.UNEXPECTED_RESPONSE,"image inspect ap error, code"+Et.code,{retry:!0,responseTime:rt});throw N.error($t.toString()),$t}const vt=JSON.parse(Et.json_body);if(vt.code!==200){const $t=new lt(H.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(vt.code,", reason: ").concat(vt.reason),{code:vt.code,responseTime:rt});throw N.error($t.toString()),$t}if(!vt.servers||!Array.isArray(vt.servers)||vt.servers.length===0){const $t=new lt(H.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:vt.code,responseTime:rt});throw N.error($t.toString()),$t}const Lt=J("VIDEO_INSPECT_WORKER_MANAGER_HOST"),wt=J("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:vt.servers.map($t=>{let{address:Ye,wss:bn}=$t;if(Ye&&bn)return"wss://".concat(Ye.replace(/\./g,"-"),".").concat(Lt,":").concat(wt||bn)}).filter($t=>!!$t),workerToken:vt.workerToken,vid:vt.vid,responseTime:rt}},(Et,vt)=>(ee.apworkerEvent(B,{success:!0,sc:200,serviceName:G,responseDetail:JSON.stringify(Et.addressList),firstSuccess:vt===0,responseTime:rt,serverIp:E[vt%E.length]}),!1),(Et,vt)=>(ee.apworkerEvent(B,{success:!1,sc:Et.data&&Et.data.code||200,serviceName:G,responseTime:rt,serverIp:E[vt%E.length]}),!!(Et.code!==H.OPERATION_ABORTED&&Et.code!==H.UNEXPECTED_RESPONSE||Et.data&&Et.data.retry)&&(ot=E[(vt+1)%E.length],!0)),R)}(d,n,r,a);this.emit(Br.STATE_CHANGE,Oc.AP_CONNECTED);const{addressList:p}=l;return this.wmSequence++,p}async connectWorkerManager(n){let r=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=r,this.emit(Br.STATE_CHANGE,Oc.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(n,1e4)}async connectWorker(n){await this.workerConnection.init([n])}handleWorkerManagerEvents(){this.workerManagerConnection.on(be.CONNECTED,async()=>{this.emit(Br.STATE_CHANGE,Oc.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.22.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(be.CLOSED,()=>{this._innerConnectionState<Oc.GET_WORKER_MANAGER_RESPONSE&&N.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(be.FAILED,()=>{this._innerConnectionState<Oc.GET_WORKER_MANAGER_RESPONSE&&N.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(be.RECONNECTING,()=>{this._innerConnectionState<Oc.GET_WORKER_MANAGER_RESPONSE&&N.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(be.ON_MESSAGE,async n=>{this.emit(Br.STATE_CHANGE,Oc.GET_WORKER_MANAGER_RESPONSE);const r=this.workerManagerConnection.url;this.workerManagerConnection.close();const a=JSON.parse(n.data);if(a.code!==200)throw N.error("[".concat(this._inspectId,"] Unexpected code ").concat(a.code," from worker manager")),new lt(H.UNEXPECTED_RESPONSE,"response code of worker is unexpected",a);if(!(a.serverResponse&&a.serverResponse.portWss&&r))throw N.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(a))),new lt(H.UNEXPECTED_RESPONSE,"response content of worker is unexpected",a);{const d=J("VIDEO_INSPECT_WORKER_PORT")||a.serverResponse.portWss,l=r.replace(/:\d+\/?$/,":".concat(d));this.emit(Br.STATE_CHANGE,Oc.CONNECT_WORKER,l),this._needWorkUrlOnly?this.emit(Br.REQUEST_NEW_WORKER_URL,l):await this.connectWorker(l)}}),this.workerManagerConnection.on(be.WILL_RECONNECT,(n,r,a)=>{a(n)}),this.workerManagerConnection.on(be.REQUEST_NEW_URLS,(n,r)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n).catch(r)})}handleWorkerEvents(){this.workerConnection.on(be.CONNECTED,async()=>{this.emit(Br.STATE_CHANGE,Oc.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=za.CONNECTED}),this.workerConnection.on(be.ON_MESSAGE,async n=>{if(n.data instanceof ArrayBuffer){const a=G4(new Uint8Array(n.data));if(J("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&N.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(a)),a.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Br.INSPECT_RESULT,void 0,void 0);if(a.data&&a.data.scorePorn&&a.data.scoreSexy&&a.data.scoreNeutral){var r;const d={porn:a.data.scorePorn,sexy:a.data.scoreSexy,neutral:a.data.scoreNeutral},l=ka(r=Object.keys(d)).call(r,(E,f)=>d[E]>d[f]?E:f,"porn"),p=Object.keys(d).find(E=>E===l);this.emit(Br.INSPECT_RESULT,p)}else this.emit(Br.INSPECT_RESULT,void 0,new lt(H.UNEXPECTED_RESPONSE,a.code+"","There is an unexpected data on message"))}else this.emit(Br.INSPECT_RESULT,void 0,new lt(H.UNEXPECTED_RESPONSE,a.code+"",a.msg))}else N.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Br.INSPECT_RESULT,void 0,new lt(H.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(be.CLOSED,()=>{this.connectionState=za.CLOSED}),this.workerConnection.on(be.FAILED,()=>{this.connectionState=za.CLOSED}),this.workerConnection.on(be.RECONNECTING,()=>{this.connectionState=this.connectionState===za.CONNECTED?za.RECONNECTING:za.CONNECTING}),this.workerConnection.on(be.WILL_RECONNECT,(n,r,a)=>{n==="recover"&&a(n),a("tryNext")}),this.workerConnection.on(be.REQUEST_NEW_URLS,(n,r)=>{this.workerManagerConnection.close(),this.once(Br.REQUEST_NEW_WORKER_URL,a=>{n([a])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(a=>{this.connectWorkerManager(a,!0)}).catch(a=>{r(a)})})}async requestToInspectImage(){this.sequence++;const n=Vo(this,Br.CLIENT_LOCAL_VIDEO_TRACK),r={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(n){if(!n.isPlaying)return void this.emit(Br.INSPECT_RESULT,void 0,new lt(H.INVALID_OPERATION,"Only the track being played can be inspected"));const a=await this.generateRequestData(n,r);this.workerConnection.sendMessage(a,!0,!0)}else this.emit(Br.INSPECT_RESULT,void 0,new lt(H.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(n,r){let{appId:a,cname:d,cid:l,vid:p,sid:E,uid:f}=r;const T=Date.now(),R=await n.getCurrentFrameImage("image/jpeg",this.quality),v=await AM(R,a,d),y=this.sequence+"-"+l+"-"+f+"-"+T+"-"+Vn(12,""),w={appId:a,cid:l,cname:d,deviceId:"",elapse:VW(Number(T-this.inspectStartTime)),fileSize:v.byteLength,jpgEncryption:2,height:R.height,width:R.width,jpg:v,networkType:6,osType:7,requestId:y,sdkVersion:"4.22.2",sequence:this.sequence,sid:E,timestamp:VW(T),uid:f,vid:p,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete w.callbackData,this.ossFilePrefix===void 0&&delete w.ossFilePrefix;const B=j4(w);if(B.byteLength<this.workerMessageLengthLimit){if(J("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const k=function(U){for(var G=1;G<arguments.length;G++){var W=arguments[G]!=null?arguments[G]:{};G%2?xW(Object(W),!0).forEach(function($){F(U,$,W[$])}):Object.getOwnPropertyDescriptors?Object.defineProperties(U,Object.getOwnPropertyDescriptors(W)):xW(Object(W)).forEach(function($){Object.defineProperty(U,$,Object.getOwnPropertyDescriptor(W,$))})}return U}({},w);delete k.jpg,N.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(k))}return B}{const k=this.quality*this.qualityRatio;return this.quality=k,await this.generateRequestData(n,{appId:a,cname:d,cid:l,vid:p,sid:E,uid:f})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Xs.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=za.CLOSED,this.emit(Br.STATE_CHANGE,Oc.CLOSED)}}const X4={name:"ContentInspect",create:function(t){let{config:n}=t;return function(r){if(!r)throw new lt(H.INVALID_PARAMS,"inspectConfig is necessary.");if(!r.inspectType||!Array.isArray(r.inspectType))throw new lt(H.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const a=[...new Set(r.inspectType)];a.forEach(d=>{var l;if(!Mt(l=["supervise","moderation"]).call(l,d))throw new lt(H.INVALID_PARAMS,"".concat(d," is not a valid inspect type."))}),r.inspectType=a}if(r&&r.extraInfo&&r.extraInfo.length>1024)throw new lt(H.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(n),new J4(n)}};on("PROCESS_ID","process-".concat(Vn(8,""),"-").concat(Vn(4,""),"-").concat(Vn(4,""),"-").concat(Vn(4,""),"-").concat(Vn(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(n){return void N.error("Error loading sdk config",n.message)}if(t)try{const n=JSON.parse(window.atob(t)),r=Date.now();N.debug("Loading global parameters from cache",n),Object.keys(n).forEach(a=>{if(Object.prototype.hasOwnProperty.call(ni,a)){const{value:d,expires:l}=n[a];if(l&&l<=r)return;Fu[a]=d,ni[a]=d}})}catch(n){N.error("Error loading mutableParamsCache: ".concat(t),n.message)}}(),Array.isArray(Fu.AREAS)&&Fu.AREAS.length>0&&ou(Fu.AREAS,!0);const FW=(t,n,r)=>{N.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(n))),on(t,n,r)};Fg(x4,!1),Fg(B4,!1),Fg(bo,!1),Fg(X4,!1),Fg(k4,!1);const yr=function(t){const n=new An,r=t,a={getListeners:n.getListeners.bind(n),on:(d,l)=>(function(p,E){p===Qd.SECURITY_POLICY_VIOLATION&&F3(E,!0)}(d,l),n.on.bind(n)(d,l)),addListener:n.addListener.bind(n),once:n.once.bind(n),off:n.off.bind(n),removeAllListeners:n.removeAllListeners.bind(n),emit:n.emit.bind(n),safeEmit:n.safeEmit.bind(n)};return V3(V3({},r),a)}({__TRACK_LIST__:Gl,VERSION:Vt,BUILD:Xd,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:FW,getParameter:J,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let n=new RTCPeerConnection;const r=await async function(a){let d;return nn().supportUnifiedPlan?(a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"}),d=(await a.createOffer()).sdp):d=(await a.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,d}(n);if(!r)return t;n.close(),n=null,t=function(a){const d={video:[],audio:[]};return a.match(/ VP8/i)&&d.video.push("VP8"),a.match(/ VP9/i)&&d.video.push("VP9"),a.match(/ AV1/i)&&d.video.push("AV1"),a.match(/ H264/i)&&d.video.push("H264"),a.match(/ H265/i)&&d.video.push("H265"),a.match(/ opus/i)&&d.audio.push("OPUS"),a.match(/ PCMU/i)&&d.audio.push("PCMU"),a.match(/ PCMA/i)&&d.audio.push("PCMA"),a.match(/ G722/i)&&d.audio.push("G722"),d}(r)}catch(n){throw new lt(H.CREATE_OFFER_FAILED,n.toString&&n.toString()).print()}return t},checkSystemRequirements:function(){const t=ee.reportApiInvoke(null,{name:Gi.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Si.TRACER});let n=!1;try{const l=window.RTCPeerConnection,p=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,E=window.WebSocket;n=!!(l&&p&&E),n&&hb()&&_R(75)&&new l().close()}catch(l){return N.error("check system requirement failed: ",l),!1}let r=!1;const a=en();a.name===mn.CHROME&&Number(a.version)>=58&&(od.engine.name!=="WebKit"||function(){const l=en();if(ff()){if(l.os===Cr.MAC_OS)return!0;if(l.os===Cr.IOS){const p=od.os.version&&od.os.version.split(".");if(p&&Number(p[0])===14&&p[1]&&Number(p[1])>=3||p&&Number(p[0])>14)return!0}}return!1}())&&(r=!0),(a.name===mn.FIREFOX&&Number(a.version)>=56||a.name===mn.OPERA&&Number(a.version)>=45||a.name===mn.SAFARI&&Number(a.version)>=11||a.name==="WebKit"&&(Ys()||hi())&&a.osVersion&&Number(a.osVersion.split(".")[0])>=11||ua()||en().name===mn.QQ)&&(r=!0),N.debug("checkSystemRequirements, api:",n,"browser",r);const d=n&&r;return t.onSuccess(d),d},getDevices:function(t){return Go.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return Go.getRecordingDevices(t)},getCameras:function(t){return Go.getCamerasDevices(t)},getElectronScreenSources:wp,getPlaybackDevices:function(t){return Go.getSpeakers(t)},createClient:function(){var t;let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const r=Vn(5,"client-"),a=ee.reportApiInvoke(null,{id:r,name:Gi.CREATE_CLIENT,options:[n],tag:Si.TRACER});try{(function(d){lr(d.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),lr(d.mode,"config.mode",["rtc","live","p2p"]),d.audioCodec!==void 0&&lr(d.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),d.proxyServer!==void 0&&Nr(d.proxyServer,"config.proxyServer",1,1e4),d.turnServer!==void 0&&Sf(d.turnServer),d.httpRetryConfig!==void 0&&Jd(d.httpRetryConfig),d.websocketRetryConfig!==void 0&&Jd(d.websocketRetryConfig)})(n)}catch(d){throw a.onError(d),d}return(ok(16,0)||ak(16,0,!0))&&(n.codec==="vp9"&&(n.codec="vp8",N.debug("browser not support vp9, force use vp8")),on("UNSUPPORTED_VIDEO_CODEC",["vp9"])),n.audioCodec===void 0&&(n.audioCodec="opus"),a.onSuccess(),new S5(lu(lu({forceWaitGatewayResponse:!0},n),{},{role:Mt(t=["rtc","p2p"]).call(t,n.mode)?"host":n.role||"audience"}),r)},createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const n=J("CAMERA_CAPTURE_CONFIG"),r=Vn(8,"track-cam-"),a=ee.reportApiInvoke(null,{id:r,tag:Si.TRACER,name:Gi.CREATE_CAM_VIDEO_TRACK,options:[_i({},t),n]});n&&(t.encoderConfig=n);const d=Ia(t);let l=null;N.info("start create camera video track with config",JSON.stringify(t),"trackId",r);try{l=(await vs({video:d},r)).getVideoTracks()[0]||null}catch(E){throw a.onError(E),E}if(!l){const E=new _t(H.UNEXPECTED_ERROR,"can not find track in media stream");return a.onError(E),E.throw(N)}t.optimizationMode&&Bw(r,l,t,fd(t.encoderConfig));const p=new Fw(l,t,d,t.scalabiltyMode?jR(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r);return a.onSuccess(p.getTrackId()),N.info("create camera video success, trackId:",r),p},createCustomVideoTrack:function(t){const n=Vn(8,"track-cus-"),r=ee.reportApiInvoke(null,{id:n,tag:Si.TRACER,name:Gi.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),a=new qn(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?jR(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n,[vn.CUSTOM_TRACK]);return r.onSuccess(a.getTrackId()),N.info("create custom video track success with config",t,"trackId",a.getTrackId()),a},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const r=typeof n=="object"?function(y){return IM(y)}(n):void 0;r&&(n="auto");const a=Vn(8,"track-scr-v-"),d=ee.reportApiInvoke(null,{id:a,tag:Si.TRACER,name:Gi.CREATE_SCREEN_VIDEO_TRACK,options:[_i({},t),n]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const l=function(y){const w={};y.screenSourceType&&(w.mediaSource=y.screenSourceType),y.extensionId&&Ac()&&(w.extensionId=y.extensionId);const{displaySurface:B,selfBrowserSurface:k,surfaceSwitching:U,systemAudio:G}=y;(ub(107)||lb(107)||ck(93))&&(B&&(lr(B,"displaySurface",["browser","window","monitor"]),w.displaySurface=B),k?(lr(k,"selfBrowserSurface",["exclude","include"]),w.selfBrowserSurface=k):w.selfBrowserSurface="include",U&&(lr(U,"surfaceSwitching",["exclude","include"]),w.surfaceSwitching=U)),(ub(105)||lb(105)||ck(91))&&G&&(lr(G,"systemAudio",["exclude","include"]),w.systemAudio=G),y.electronScreenSourceId&&(w.sourceId=y.electronScreenSourceId);const W=y.encoderConfig?cw(y.encoderConfig):null;return w.mandatory={chromeMediaSource:"desktop",maxWidth:W?W.width:void 0,maxHeight:W?W.height:void 0},W&&(W.frameRate&&(typeof W.frameRate=="number"?(w.mandatory.maxFrameRate=W.frameRate,w.mandatory.minFrameRate=W.frameRate):(w.mandatory.maxFrameRate=W.frameRate.max||W.frameRate.ideal||W.frameRate.exact||void 0,w.mandatory.minFrameRate=W.frameRate.min||W.frameRate.ideal||W.frameRate.exact||void 0),w.frameRate=W.frameRate),W.width&&(w.width=W.width),W.height&&(w.height=W.height)),w}(t);let p=null,E=null;const f=nn();if(!f.supportShareAudio&&n==="enable"){const y=new _t(H.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return d.onError(y),y.throw(N)}N.info("start create screen video track with config",t,"withAudio",n,"trackId",a);const T=f.supportShareAudio&&n!=="disable";try{const y=await vs({screen:l,screenAudio:T?r||!0:void 0},a);p=y.getVideoTracks()[0]||null,E=y.getAudioTracks()[0]||null}catch(y){throw d.onError(y),y}if(!p){const y=new _t(H.UNEXPECTED_ERROR,"can not find track in media stream");return d.onError(y),y.throw(N)}if(!E&&n==="enable"){p&&p.stop();const y=new _t(H.SHARE_AUDIO_NOT_ALLOWED);return d.onError(y),y.throw(N)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(Bw(a,p,t,t.encoderConfig&&cw(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const R=new qn(p,t.encoderConfig?cw(t.encoderConfig):{},t.scalabiltyMode?jR(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,a,[vn.SCREEN_TRACK]);if(!E)return d.onSuccess(R.getTrackId()),N.info("create screen video track success","video:",R.getTrackId()),R;const v=new Ai(E,void 0,Vn(8,"track-scr-a-"),!1);return d.onSuccess([R.getTrackId(),v.getTrackId()]),N.info("create screen video track success","video:",R.getTrackId(),"audio:",v.getTrackId()),[R,v]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=J("CAMERA_CAPTURE_CONFIG"),a=Vn(8,"track-mic-"),d=Vn(8,"track-cam-"),l=ee.reportApiInvoke(null,{id:"".concat(a,"-").concat(d),tag:Si.TRACER,name:Gi.CREATE_MIC_AND_CAM_TRACKS,options:[t,n,r]});r&&(n.encoderConfig=r);const p=Ia(n),E=yM(t);let f=null,T=null;N.info("start create camera video track(".concat(d,") and microphone audio track(").concat(a,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(n)));try{const y=await vs({audio:E,video:p},"".concat(a,"-").concat(d));f=y.getAudioTracks()[0],T=y.getVideoTracks()[0]}catch(y){throw l.onError(y),y}if(!f||!T){const y=new _t(H.UNEXPECTED_ERROR,"can not find tracks in media stream");return l.onError(y),y.throw(N)}n.optimizationMode&&Bw(d,T,n,fd(n.encoderConfig));const R=new SE(f,t,E,a),v=new Fw(T,n,p,n.scalabiltyMode?jR(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,d);return l.onSuccess([R.getTrackId(),v.getTrackId()]),N.info("create camera video track(".concat(d,") and microphone audio track(").concat(a,") success")),[R,v]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const n=Vn(8,"track-mic-"),r=ee.reportApiInvoke(null,{id:n,tag:Si.TRACER,name:Gi.CREATE_MIC_AUDIO_TRACK,options:[t]}),a=yM(t);let d=null;N.info("start create microphone audio track with config",JSON.stringify(t),"trackId",n);try{d=(await vs({audio:a},n)).getAudioTracks()[0]||null}catch(p){throw r.onError(p),p}if(!d){const p=new _t(H.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(p),p.throw(N)}const l=new SE(d,t,a,n);return r.onSuccess(l.getTrackId()),N.info("create microphone audio track success, trackId:",n),l},createCustomAudioTrack:function(t){const n=Vn(8,"track-cus-"),r=ee.reportApiInvoke(null,{id:n,tag:Si.TRACER,name:Gi.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),a=new Ai(t.mediaStreamTrack,t.encoderConfig?cg(t.encoderConfig):{},n,!1);return N.info("create custom audio track success with config",t,"trackId",a.getTrackId()),r.onSuccess(a.getTrackId()),a},createBufferSourceAudioTrack:async function(t){var n;const{cacheOnlineFile:r,encoderConfig:a}=t;let{source:d}=t;const l={source:d instanceof AudioBuffer?"AudioBuffer":d instanceof File?(n=File.name)!==null&&n!==void 0?n:"File":d,cacheOnlineFile:r,encoderConfig:a},p=Vn(8,"track-buf-"),E=ee.reportApiInvoke(null,{id:p,tag:Si.TRACER,name:Gi.CREATE_BUFFER_AUDIO_TRACK,options:[l]});if(J("DISABLE_WEBAUDIO"))throw new _t(H.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");N.info("start create buffer source audio track with config",JSON.stringify(l),"trackId",p);const f=d;if(!(d instanceof AudioBuffer))try{d=await async function(v,y){let w=null;if(typeof v=="string"){const k=Aw.get(v);if(k)return N.debug("use cached audio resource: ",v),k;try{w=(await cd(()=>Xs.get(v,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(U){throw new _t(H.FETCH_AUDIO_FILE_FAILED,U.toString())}}else w=await new Bt((U,G)=>{const W=new FileReader;W.onload=$=>{$.target?U($.target.result):G(new _t(H.READ_LOCAL_AUDIO_FILE_ERROR))},W.onerror=()=>{G(new _t(H.READ_LOCAL_AUDIO_FILE_ERROR))},W.readAsArrayBuffer(v)});const B=await function(k){const U=_E();return new Bt((G,W)=>{U.decodeAudioData(k,$=>{G($)},$=>{W(new _t(H.DECODE_AUDIO_FILE_FAILED,$.toString()))})})}(w);return typeof v=="string"&&y&&Aw.set(v,B),B}(d,r)}catch(v){return E.onError(v),v.throw(N)}const T=new fg(d),R=new Yl(f,T,a?cg(a):{},p);return N.info("create buffer source audio track success, trackId:",p),E.onSuccess(R.getTrackId()),R},setAppType:function(t){if(N.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw N.debug("Invalid appType"),new lt(H.INVALID_PARAMS,"invalid app type",t);on("APP_TYPE",Math.floor(t))},setLogLevel:function(t){N.setLogLevel(t)},enableLogUpload:function(){J("USE_NEW_LOG")?on("UPLOAD_LOG",!0):N.enableLogUpload()},disableLogUpload:function(){J("USE_NEW_LOG")?on("UPLOAD_LOG",!1):N.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Ug},checkAudioTrackIsActive:async function(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const r=ee.reportApiInvoke(null,{tag:Si.TRACER,name:Gi.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[n]});if(!(t instanceof Ai||t instanceof Lp)){const f=new lt(H.INVALID_TRACK,"the parameter is not a audio track");return r.onError(f),f.throw()}n&&n<1e3&&(n=1e3);const a=t instanceof Ai?t.getTrackLabel():"remote_track",d=t.getVolumeLevel();let l=d,p=d;const E=Date.now();return new Bt(f=>{const T=setInterval(()=>{const R=t.getVolumeLevel();l=R>l?R:l,p=R<p?R:p;const v=l-p>1e-4,y=Date.now()-E;if(v||y>n){clearInterval(T);const w=v,B={duration:y,deviceLabel:a,maxVolumeLevel:l,result:w};N.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(B))),r.onSuccess(B),f(w)}},200)})},checkVideoTrackIsActive:async function(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const r=ee.reportApiInvoke(null,{tag:Si.TRACER,name:Gi.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[n]});if(!(t instanceof qn||t instanceof zl)){const v=new lt(H.INVALID_TRACK,"the parameter is not a video track");return r.onError(v),v.throw()}n&&n<1e3&&(n=1e3);const a=t instanceof qn?t.getTrackLabel():"remote_track",d=t.getMediaStreamTrack(!0),l=document.createElement("video");l.style.width="1px",l.style.height="1px",l.setAttribute("muted",""),l.muted=!0,l.setAttribute("playsinline",""),l.controls=!1,(vr()||ff())&&(l.style.opacity="0.01",l.style.position="fixed",l.style.left="0",l.style.top="0",document.body.appendChild(l)),l.srcObject=new MediaStream([d]),l.play();const p=document.createElement("canvas");p.width=160,p.height=120;let E=0,f=0;try{const v=Date.now();E=await function(y,w,B,k){let U,G=0,W=null;return new Bt(($,rt)=>{function ot(){G>k&&U&&(U(),$(G));const Et=B.getContext("2d");if(!Et){const wt=new lt(H.UNEXPECTED_ERROR,"can not get canvas 2d context.");return N.error(wt.toString()),void rt(wt)}Et.drawImage(y,0,0,160,120);const vt=Et.getImageData(0,0,B.width,B.height),Lt=Math.floor(vt.data.length/3);if(W){for(let wt=0;wt<Lt;wt+=3)if(vt.data[wt]!==W[wt])return G+=1,void(W=vt.data);W=vt.data}else W=vt.data}setTimeout(()=>{U&&(U(),$(G))},w),U=dg(()=>{ot()},30)})}(l,n,p,4),f=Date.now()-v}catch(v){throw r.onError(v),v}u===mn.SAFARI&&(l.pause(),l.remove()),l.srcObject=null;const T=E>4,R={duration:f,changedPicNum:E,deviceLabel:a,result:T};return N.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(R))),r.onSuccess(R),T},setArea:ou,audioElementPlayCenter:Us,resumeAudioContext:function(){Us.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){C5.processExternalMediaAEC(t)},registerExtensions:function(t){const n=J("PLUGIN_INFO")||[];t.forEach(r=>{"name"in r&&!Mt(n).call(n,r.name)&&n.push(r.name);const a=r;a.__registered__=!0,a.logger.hookLog=N.extLog,a.reporter.hookApiInvoke=ee.extApiInvoke,a.parameters&&Object.keys(a.parameters).forEach(d=>{a.parameters[d]=J(d)})}),FW("PLUGIN_INFO",n)},ChannelMediaRelayError:mp,ChannelMediaRelayEvent:ld,ChannelMediaRelayState:Zs,RemoteStreamFallbackType:mM,RemoteStreamType:eG,ConnectionDisconnectedReason:Cn,AudienceLatencyLevelType:gR,AREAS:xe,preload:async function(t,n,r,a){return nt(t,n,r,a)}});return Object.defineProperties(yr,{onAudioAutoplayFailed:{get:()=>va.onAudioAutoplayFailed,set:t=>{va.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>va.onAutoplayFailed,set:t=>{va.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>yr._onSecurityPolicyViolation,set(t){yr._onSecurityPolicyViolation=t,F3(t)}},__CLIENT_LIST__:{get:()=>J("SHOW_GLOBAL_CLIENT_LIST")?bl:[]}}),Go.on(Wl.CAMERA_DEVICE_CHANGED,t=>{N.info("camera device changed",JSON.stringify(t)),yr.onCameraChanged&&yr.onCameraChanged(t),yr.safeEmit(Qd.CAMERA_CHANGED,t)}),Go.on(Wl.RECORDING_DEVICE_CHANGED,t=>{N.info("microphone device changed",JSON.stringify(t)),yr.onMicrophoneChanged&&yr.onMicrophoneChanged(t),yr.safeEmit(Qd.MICROPHONE_CHANGED,t)}),Go.on(Wl.PLAYOUT_DEVICE_CHANGED,t=>{N.debug("playout device changed",JSON.stringify(t)),yr.onPlaybackDeviceChanged&&yr.onPlaybackDeviceChanged(t),yr.safeEmit(Qd.PLAYBACK_DEVICE_CHANGED,t)}),Us.onAutoplayFailed=()=>{N.info("detect audio element autoplay failed"),va.onAudioAutoplayFailed&&va.onAudioAutoplayFailed()},Dn.on("autoplay-failed",()=>{N.info("detect webaudio autoplay failed"),va.onAudioAutoplayFailed&&va.onAudioAutoplayFailed(),yr.safeEmit(Qd.AUTOPLAY_FAILED)}),Dn.on(Jr.STATE_CHANGE,(t,n)=>{N.info("audio context state changed: ".concat(n," => ").concat(t)),yr.onAudioContextStateChanged&&yr.onAudioContextStateChanged(t,n),yr.safeEmit(Qd.AUDIO_CONTEXT_STATE_CHANGED,t,n)}),Ui.on(yl.NETWORK_STATE_CHANGE,(t,n)=>{N.info("[network-indicator] network state changed, ".concat(n," => ").concat(t))}),window&&(window.__ARTC__=yr),yr})})(c5);const WO=o5(c5.exports);var HE;(function(Y){Y.REQUEST_CALL="REQUEST_CALL",Y.WAITING_CALL="WAITING_CALL",Y.MATCH="MATCH",Y.HANG_UP="HANGUP",Y.ERROR="ERROR"})(HE||(HE={}));const wH=({apiUrl:Y,apiKey:Z,caller:ct,uid:mt,onCallProperties:Rt,onError:Nt,onHangUp:se})=>{let te,pe,ve=!1,De=!1,Qt;const le=()=>{te&&te.close()},Qe=()=>{if(te&&te.readyState===te.OPEN&&Zi(!1),te=null,De){const br=new WebSocket(Y);br.onerror=()=>Te(!0),br.onmessage=ol=>Ei(ol.data),br.onopen=()=>ji(),te=br}},Te=br=>{ve=br,ve&&Zi(),Nt(br)},dn=br=>{te&&te.readyState===te.OPEN&&te.send(JSON.stringify(br))},Ei=br=>{if(br){const ol=JSON.parse(br);switch(ol.type){case HE.WAITING_CALL:si(!1);break;case HE.MATCH:pe=ol,Rt(pe);break;case HE.HANG_UP:se();break;case HE.ERROR:Te(!0);break}}},ji=()=>{dn({type:HE.REQUEST_CALL,apiKey:Z,uid:mt,caller:ct})},si=br=>{Qt&&clearTimeout(Qt),Qt=null,br&&(Qt=setTimeout(()=>{Te(!0)},15e3))},mi=br=>{De!==br&&(De=br,Qe())},Da=()=>{mi(!0),si(!0),Qe()},kd=()=>{dn({type:HE.HANG_UP,channel:pe==null?void 0:pe.channel,uid:pe!=null&&pe.channel?void 0:mt})},fu=()=>{pe=null,Te(!1),si(!1)},Zi=(br=!0)=>{te&&(kd(),le()),fu(),br&&mi(!1)};return{startWS:Da,stopWS:Zi}};WO.setLogLevel(4);var q1;(function(Y){Y.USER_PUBLISHED="user-published",Y.USER_UNPUBLISHED="user-unpublished"})(q1||(q1={}));var YC;(function(Y){Y.VIDEO="video",Y.AUDIO="audio"})(YC||(YC={}));const KW={mode:"rtc",codec:"vp8"},OH=({apiUrl:Y,apiKey:Z,operationId:ct,caller:mt,onStartCall:Rt,onHangUp:Nt,onError:se,setRemoteTrack:te,setRemoteMuted:pe})=>{let ve,De,Qt;const le=WO.createClient(KW),Qe=WO.createClient(KW),Te=async()=>{await br(),Nt()},dn=()=>{le.on(q1.USER_PUBLISHED,async(fi,di)=>{var Lr;fi.uid!==Qt.screenSharing.id&&(await le.subscribe(fi,di),di===YC.VIDEO?te(fi):di===YC.AUDIO&&((Lr=fi.audioTrack)===null||Lr===void 0||Lr.play(),pe(!1)))}),le.on(q1.USER_UNPUBLISHED,async(fi,di)=>{if(fi.uid!==Qt.screenSharing.id){try{await le.unsubscribe(fi,di)}catch{}di===YC.VIDEO?Te():di===YC.AUDIO&&pe(!0)}})},Ei=async fi=>{Qt=fi;try{dn(),await le.join(Qt.appId,Qt.channel,Qt.token,ct);try{const[di,Lr]=await WO.createMicrophoneAndCameraTracks(void 0,{encoderConfig:"720p_2",facingMode:"user"});ve=[di,Lr]}catch{se(Y1.permissions);return}Rt(ve[1]),await le.publish([ve[0],ve[1]])}catch{se(Y1.exception)}},{startWS:ji,stopWS:si}=wH({apiUrl:Y,apiKey:Z,uid:ct,caller:mt,onCallProperties:Ei,onError:fi=>{fi&&se(Y1.exception)},onHangUp:Te}),mi=()=>{ji()},Da=fi=>{ve==null||ve[0].setEnabled(fi)},kd=fi=>{ve==null||ve[1].setEnabled(fi)},fu=async()=>{ve==null||ve.forEach(fi=>{fi==null||fi.stop(),fi==null||fi.close()}),await le.leave(),le.removeAllListeners()},Zi=async()=>{De&&(De.removeAllListeners(),De.close(),De=null),await Qe.leave(),Qe.removeAllListeners()},br=async()=>{await Zi(),await fu(),si()};return{startCall:mi,stopCall:br,setAudio:Da,setCamera:kd,startShareScreen:async()=>{try{await Qe.join(Qt.appId,Qt.channel,Qt.screenSharing.token,Qt.screenSharing.id);try{return De=await WO.createScreenVideoTrack({screenSourceType:"screen"},"disable"),await Qe.publish([De]),!0}catch{}}catch{se(Y1.exception)}return!1},stopShareScreen:Zi}},NH=":host{display:block;box-sizing:border-box;position:relative;min-width:300px}.video-assistance{position:fixed;top:0;width:100%;height:100dvh;overflow:hidden;opacity:1;z-index:9999;transition:z-index 0.5s ease-in-out, opacity 0.5s ease-in-out}.video-assistance.minimize-screen{opacity:0;z-index:-1}screen-sharing{position:fixed;top:0;width:100%;height:100dvh}.video-assistance .body{position:relative;height:calc(100dvh - 160px);max-height:calc(100dvh - 160px)}.video-assistance .body>:first-child{height:100%}.video-assistance .video-client{position:absolute;bottom:0;right:0;height:200px;width:260px}.screen-video-client{position:absolute;bottom:16px;left:16px;height:200px;width:260px}@media only screen and (max-width: 1024px) and (orientation: portrait){.video-assistance .video-client{height:150px;width:200px}.screen-video-client{display:none}}",DH=NH,PH=class{constructor(Y){ph(this,Y),this.finishCall=Eu(this,"finishCall"),this.userCancel=Eu(this,"userCancel"),this.errorException=Eu(this,"errorException"),this.hangUp=async()=>{await this.stopCall(),this.loading=!1,this.finish=!0,this.userCancel.emit()},this.handleCamera=Z=>{this.hasCamera=Z.detail,this.setCamera(this.hasCamera)},this.handleMute=Z=>{this.muted=Z.detail,this.setAudio(!this.muted)},this.handleShareScreen=async Z=>{this.minimizeScreen=Z,Z?await this.startShareScreen()||(this.minimizeScreen=!1):this.stopShareScreen()},this.handleTime=Z=>{this.time=Z},this.initTime=()=>{const{start:Z,stop:ct}=a5({onChange:this.handleTime.bind(this)});Z(),this.stopElapsedTime=ct},this.getUserVideo=Z=>he("video-streaming",{class:Z,text:this.translations.You,hasVideo:this.hasCamera,videoTrack:this.userVideo}),this.handleCloseModal=()=>{this.finish=!0,this.finishCall.emit()},this.apiUrl=void 0,this.apiKey=void 0,this.operationId=void 0,this.caller=void 0,this.language=void 0,this.shareScreen=!0,this.minimizeScreen=!1,this.loading=!0,this.finish=!1,this.muted=!1,this.hasCamera=!0,this.hungUpAssistant=!1,this.userVideo=void 0,this.remoteTrack=void 0,this.remoteMuted=void 0,this.time=""}componentWillLoad(){this.translations=eH(this.language)}handleFinish(Y){var Z;Y&&((Z=this.stopElapsedTime)===null||Z===void 0||Z.call(this))}componentDidLoad(){({startCall:this.startCall,stopCall:this.stopCall,setAudio:this.setAudio,setCamera:this.setCamera,startShareScreen:this.startShareScreen,stopShareScreen:this.stopShareScreen}=OH({apiUrl:this.apiUrl,apiKey:this.apiKey,operationId:this.operationId,caller:this.caller,onHangUp:()=>{this.hungUpAssistant=!0},onStartCall:Y=>{this.loading=!1,this.initTime(),this.userVideo=Y},onError:async Y=>{await this.stopCall(),this.finish=!0,this.errorException.emit(Y)},setRemoteTrack:Y=>{this.remoteTrack=Y},setRemoteMuted:Y=>{this.remoteMuted=Y}})),this.startCall()}render(){var Y;return he(JO,{key:"941cfd749773a6cda8c2d1c851d8a64d897fe3fb"},this.finish?null:he(Z4,null,he("div",{class:`video-assistance ${this.minimizeScreen?"minimize-screen":""}`},this.loading&&he("video-connecting",{language:this.language,onCloseConnecting:this.hangUp}),this.hungUpAssistant&&he("modal-finish",{language:this.language,onCloseModal:this.handleCloseModal}),!this.loading&&!this.hungUpAssistant&&he("video-call",{language:this.language,isMuted:this.muted,hasCamera:this.hasCamera,share:this.shareScreen,time:this.time,onTurnCamera:this.handleCamera,onMuted:this.handleMute,onShareScreen:()=>this.handleShareScreen(!0),onHangUp:this.hangUp},he("div",{class:"body"},he("video-streaming",{text:this.translations.Assistant,fullScreen:!0,hasAudio:!this.remoteMuted,videoTrack:(Y=this.remoteTrack)===null||Y===void 0?void 0:Y.videoTrack}),!this.minimizeScreen&&this.getUserVideo("video-client")))),this.minimizeScreen&&he("screen-sharing",{language:this.language,isMuted:this.muted,hasCamera:this.hasCamera,time:this.time,onTurnCamera:this.handleCamera,onMuted:this.handleMute,onShareScreen:()=>this.handleShareScreen(!1),onHangUp:this.hangUp},this.getUserVideo("screen-video-client"))))}static get watchers(){return{finish:["handleFinish"]}}};PH.style=DH;function sl(Y){for(var Z=arguments.length,ct=Array(Z>1?Z-1:0),mt=1;mt<Z;mt++)ct[mt-1]=arguments[mt];throw Error("[Immer] minified error nr: "+Y+(ct.length?" "+ct.map(function(Rt){return"'"+Rt+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function qg(Y){return!!Y&&!!Y[ps]}function zg(Y){var Z;return!!Y&&(function(ct){if(!ct||typeof ct!="object")return!1;var mt=Object.getPrototypeOf(ct);if(mt===null)return!0;var Rt=Object.hasOwnProperty.call(mt,"constructor")&&mt.constructor;return Rt===Object||typeof Rt=="function"&&Function.toString.call(Rt)===jH}(Y)||Array.isArray(Y)||!!Y[ZW]||!!(!((Z=Y.constructor)===null||Z===void 0)&&Z[ZW])||YG(Y)||qG(Y))}function Jg(Y,Z,ct){ct===void 0&&(ct=!1),JC(Y)===0?(ct?Object.keys:zC)(Y).forEach(function(mt){ct&&typeof mt=="symbol"||Z(mt,Y[mt],Y)}):Y.forEach(function(mt,Rt){return Z(Rt,mt,Y)})}function JC(Y){var Z=Y[ps];return Z?Z.i>3?Z.i-4:Z.i:Array.isArray(Y)?1:YG(Y)?2:qG(Y)?3:0}function qC(Y,Z){return JC(Y)===2?Y.has(Z):Object.prototype.hasOwnProperty.call(Y,Z)}function LH(Y,Z){return JC(Y)===2?Y.get(Z):Y[Z]}function l5(Y,Z,ct){var mt=JC(Y);mt===2?Y.set(Z,ct):mt===3?Y.add(ct):Y[Z]=ct}function h5(Y,Z){return Y===Z?Y!==0||1/Y==1/Z:Y!=Y&&Z!=Z}function YG(Y){return FH&&Y instanceof Map}function qG(Y){return BH&&Y instanceof Set}function Yg(Y){return Y.o||Y.t}function zG(Y){if(Array.isArray(Y))return Array.prototype.slice.call(Y);var Z=_5(Y);delete Z[ps];for(var ct=zC(Z),mt=0;mt<ct.length;mt++){var Rt=ct[mt],Nt=Z[Rt];Nt.writable===!1&&(Nt.writable=!0,Nt.configurable=!0),(Nt.get||Nt.set)&&(Z[Rt]={configurable:!0,writable:!0,enumerable:Nt.enumerable,value:Y[Rt]})}return Object.create(Object.getPrototypeOf(Y),Z)}function JG(Y,Z){return Z===void 0&&(Z=!1),XG(Y)||qg(Y)||!zg(Y)||(JC(Y)>1&&(Y.set=Y.add=Y.clear=Y.delete=kH),Object.freeze(Y),Z&&Jg(Y,function(ct,mt){return JG(mt,!0)},!0)),Y}function kH(){sl(2)}function XG(Y){return Y==null||typeof Y!="object"||Object.isFrozen(Y)}function hh(Y){var Z=HG[Y];return Z||sl(18,Y),Z}function MH(Y,Z){HG[Y]||(HG[Y]=Z)}function jG(){return KO}function UG(Y,Z){Z&&(hh("Patches"),Y.u=[],Y.s=[],Y.v=Z)}function z1(Y){GG(Y),Y.p.forEach(UH),Y.p=null}function GG(Y){Y===KO&&(KO=Y.l)}function YW(Y){return KO={p:[],l:KO,h:Y,m:!0,_:0}}function UH(Y){var Z=Y[ps];Z.i===0||Z.i===1?Z.j():Z.g=!0}function xG(Y,Z){Z._=Z.p.length;var ct=Z.p[0],mt=Y!==void 0&&Y!==ct;return Z.h.O||hh("ES5").S(Z,Y,mt),mt?(ct[ps].P&&(z1(Z),sl(4)),zg(Y)&&(Y=J1(Z,Y),Z.l||X1(Z,Y)),Z.u&&hh("Patches").M(ct[ps].t,Y,Z.u,Z.s)):Y=J1(Z,ct,[]),z1(Z),Z.u&&Z.v(Z.u,Z.s),Y!==p5?Y:void 0}function J1(Y,Z,ct){if(XG(Z))return Z;var mt=Z[ps];if(!mt)return Jg(Z,function(te,pe){return qW(Y,mt,Z,te,pe,ct)},!0),Z;if(mt.A!==Y)return Z;if(!mt.P)return X1(Y,mt.t,!0),mt.t;if(!mt.I){mt.I=!0,mt.A._--;var Rt=mt.i===4||mt.i===5?mt.o=zG(mt.k):mt.o,Nt=Rt,se=!1;mt.i===3&&(Nt=new Set(Rt),Rt.clear(),se=!0),Jg(Nt,function(te,pe){return qW(Y,mt,Rt,te,pe,ct,se)}),X1(Y,Rt,!1),ct&&Y.u&&hh("Patches").N(mt,ct,Y.u,Y.s)}return mt.o}function qW(Y,Z,ct,mt,Rt,Nt,se){if(qg(Rt)){var te=J1(Y,Rt,Nt&&Z&&Z.i!==3&&!qC(Z.R,mt)?Nt.concat(mt):void 0);if(l5(ct,mt,te),!qg(te))return;Y.m=!1}else se&&ct.add(Rt);if(zg(Rt)&&!XG(Rt)){if(!Y.h.D&&Y._<1)return;J1(Y,Rt),Z&&Z.A.l||X1(Y,Rt)}}function X1(Y,Z,ct){ct===void 0&&(ct=!1),!Y.l&&Y.h.D&&Y.m&&JG(Z,ct)}function VG(Y,Z){var ct=Y[ps];return(ct?Yg(ct):Y)[Z]}function zW(Y,Z){if(Z in Y)for(var ct=Object.getPrototypeOf(Y);ct;){var mt=Object.getOwnPropertyDescriptor(ct,Z);if(mt)return mt;ct=Object.getPrototypeOf(ct)}}function KE(Y){Y.P||(Y.P=!0,Y.l&&KE(Y.l))}function FG(Y){Y.o||(Y.o=zG(Y.t))}function WG(Y,Z,ct){var mt=YG(Z)?hh("MapSet").F(Z,ct):qG(Z)?hh("MapSet").T(Z,ct):Y.O?function(Rt,Nt){var se=Array.isArray(Rt),te={i:se?1:0,A:Nt?Nt.A:jG(),P:!1,I:!1,R:{},l:Nt,t:Rt,k:null,o:null,j:null,C:!1},pe=te,ve=YO;se&&(pe=[te],ve=HO);var De=Proxy.revocable(pe,ve),Qt=De.revoke,le=De.proxy;return te.k=le,te.j=Qt,le}(Z,ct):hh("ES5").J(Z,ct);return(ct?ct.A:jG()).p.push(mt),mt}function xH(Y){return qg(Y)||sl(22,Y),function Z(ct){if(!zg(ct))return ct;var mt,Rt=ct[ps],Nt=JC(ct);if(Rt){if(!Rt.P&&(Rt.i<4||!hh("ES5").K(Rt)))return Rt.t;Rt.I=!0,mt=JW(ct,Nt),Rt.I=!1}else mt=JW(ct,Nt);return Jg(mt,function(se,te){Rt&&LH(Rt.t,se)===te||l5(mt,se,Z(te))}),Nt===3?new Set(mt):mt}(Y)}function JW(Y,Z){switch(Z){case 2:return new Map(Y);case 3:return Array.from(Y)}return zG(Y)}function VH(){function Y(Nt,se){var te=Rt[Nt];return te?te.enumerable=se:Rt[Nt]=te={configurable:!0,enumerable:se,get:function(){var pe=this[ps];return YO.get(pe,Nt)},set:function(pe){var ve=this[ps];YO.set(ve,Nt,pe)}},te}function Z(Nt){for(var se=Nt.length-1;se>=0;se--){var te=Nt[se][ps];if(!te.P)switch(te.i){case 5:mt(te)&&KE(te);break;case 4:ct(te)&&KE(te)}}}function ct(Nt){for(var se=Nt.t,te=Nt.k,pe=zC(te),ve=pe.length-1;ve>=0;ve--){var De=pe[ve];if(De!==ps){var Qt=se[De];if(Qt===void 0&&!qC(se,De))return!0;var le=te[De],Qe=le&&le[ps];if(Qe?Qe.t!==Qt:!h5(le,Qt))return!0}}var Te=!!se[ps];return pe.length!==zC(se).length+(Te?0:1)}function mt(Nt){var se=Nt.k;if(se.length!==Nt.t.length)return!0;var te=Object.getOwnPropertyDescriptor(se,se.length-1);if(te&&!te.get)return!0;for(var pe=0;pe<se.length;pe++)if(!se.hasOwnProperty(pe))return!0;return!1}var Rt={};MH("ES5",{J:function(Nt,se){var te=Array.isArray(Nt),pe=function(De,Qt){if(De){for(var le=Array(Qt.length),Qe=0;Qe<Qt.length;Qe++)Object.defineProperty(le,""+Qe,Y(Qe,!0));return le}var Te=_5(Qt);delete Te[ps];for(var dn=zC(Te),Ei=0;Ei<dn.length;Ei++){var ji=dn[Ei];Te[ji]=Y(ji,De||!!Te[ji].enumerable)}return Object.create(Object.getPrototypeOf(Qt),Te)}(te,Nt),ve={i:te?5:4,A:se?se.A:jG(),P:!1,I:!1,R:{},l:se,t:Nt,k:pe,o:null,g:!1,C:!1};return Object.defineProperty(pe,ps,{value:ve,writable:!0}),pe},S:function(Nt,se,te){te?qg(se)&&se[ps].A===Nt&&Z(Nt.p):(Nt.u&&function pe(ve){if(ve&&typeof ve=="object"){var De=ve[ps];if(De){var Qt=De.t,le=De.k,Qe=De.R,Te=De.i;if(Te===4)Jg(le,function(mi){mi!==ps&&(Qt[mi]!==void 0||qC(Qt,mi)?Qe[mi]||pe(le[mi]):(Qe[mi]=!0,KE(De)))}),Jg(Qt,function(mi){le[mi]!==void 0||qC(le,mi)||(Qe[mi]=!1,KE(De))});else if(Te===5){if(mt(De)&&(KE(De),Qe.length=!0),le.length<Qt.length)for(var dn=le.length;dn<Qt.length;dn++)Qe[dn]=!1;else for(var Ei=Qt.length;Ei<le.length;Ei++)Qe[Ei]=!0;for(var ji=Math.min(le.length,Qt.length),si=0;si<ji;si++)le.hasOwnProperty(si)||(Qe[si]=!0),Qe[si]===void 0&&pe(le[si])}}}}(Nt.p[0]),Z(Nt.p))},K:function(Nt){return Nt.i===4?ct(Nt):mt(Nt)}})}var XW,KO,QG=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",FH=typeof Map<"u",BH=typeof Set<"u",QW=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",p5=QG?Symbol.for("immer-nothing"):((XW={})["immer-nothing"]=!0,XW),ZW=QG?Symbol.for("immer-draftable"):"__$immer_draftable",ps=QG?Symbol.for("immer-state"):"__$immer_state",jH=""+Object.prototype.constructor,zC=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(Y){return Object.getOwnPropertyNames(Y).concat(Object.getOwnPropertySymbols(Y))}:Object.getOwnPropertyNames,_5=Object.getOwnPropertyDescriptors||function(Y){var Z={};return zC(Y).forEach(function(ct){Z[ct]=Object.getOwnPropertyDescriptor(Y,ct)}),Z},HG={},YO={get:function(Y,Z){if(Z===ps)return Y;var ct=Yg(Y);if(!qC(ct,Z))return function(Rt,Nt,se){var te,pe=zW(Nt,se);return pe?"value"in pe?pe.value:(te=pe.get)===null||te===void 0?void 0:te.call(Rt.k):void 0}(Y,ct,Z);var mt=ct[Z];return Y.I||!zg(mt)?mt:mt===VG(Y.t,Z)?(FG(Y),Y.o[Z]=WG(Y.A.h,mt,Y)):mt},has:function(Y,Z){return Z in Yg(Y)},ownKeys:function(Y){return Reflect.ownKeys(Yg(Y))},set:function(Y,Z,ct){var mt=zW(Yg(Y),Z);if(mt!=null&&mt.set)return mt.set.call(Y.k,ct),!0;if(!Y.P){var Rt=VG(Yg(Y),Z),Nt=Rt==null?void 0:Rt[ps];if(Nt&&Nt.t===ct)return Y.o[Z]=ct,Y.R[Z]=!1,!0;if(h5(ct,Rt)&&(ct!==void 0||qC(Y.t,Z)))return!0;FG(Y),KE(Y)}return Y.o[Z]===ct&&(ct!==void 0||Z in Y.o)||Number.isNaN(ct)&&Number.isNaN(Y.o[Z])||(Y.o[Z]=ct,Y.R[Z]=!0),!0},deleteProperty:function(Y,Z){return VG(Y.t,Z)!==void 0||Z in Y.t?(Y.R[Z]=!1,FG(Y),KE(Y)):delete Y.R[Z],Y.o&&delete Y.o[Z],!0},getOwnPropertyDescriptor:function(Y,Z){var ct=Yg(Y),mt=Reflect.getOwnPropertyDescriptor(ct,Z);return mt&&{writable:!0,configurable:Y.i!==1||Z!=="length",enumerable:mt.enumerable,value:ct[Z]}},defineProperty:function(){sl(11)},getPrototypeOf:function(Y){return Object.getPrototypeOf(Y.t)},setPrototypeOf:function(){sl(12)}},HO={};Jg(YO,function(Y,Z){HO[Y]=function(){return arguments[0]=arguments[0][0],Z.apply(this,arguments)}}),HO.deleteProperty=function(Y,Z){return HO.set.call(this,Y,Z,void 0)},HO.set=function(Y,Z,ct){return YO.set.call(this,Y[0],Z,ct,Y[0])};var GH=function(){function Y(ct){var mt=this;this.O=QW,this.D=!0,this.produce=function(Rt,Nt,se){if(typeof Rt=="function"&&typeof Nt!="function"){var te=Nt;Nt=Rt;var pe=mt;return function(dn){var Ei=this;dn===void 0&&(dn=te);for(var ji=arguments.length,si=Array(ji>1?ji-1:0),mi=1;mi<ji;mi++)si[mi-1]=arguments[mi];return pe.produce(dn,function(Da){var kd;return(kd=Nt).call.apply(kd,[Ei,Da].concat(si))})}}var ve;if(typeof Nt!="function"&&sl(6),se!==void 0&&typeof se!="function"&&sl(7),zg(Rt)){var De=YW(mt),Qt=WG(mt,Rt,void 0),le=!0;try{ve=Nt(Qt),le=!1}finally{le?z1(De):GG(De)}return typeof Promise<"u"&&ve instanceof Promise?ve.then(function(dn){return UG(De,se),xG(dn,De)},function(dn){throw z1(De),dn}):(UG(De,se),xG(ve,De))}if(!Rt||typeof Rt!="object"){if((ve=Nt(Rt))===void 0&&(ve=Rt),ve===p5&&(ve=void 0),mt.D&&JG(ve,!0),se){var Qe=[],Te=[];hh("Patches").M(Rt,ve,Qe,Te),se(Qe,Te)}return ve}sl(21,Rt)},this.produceWithPatches=function(Rt,Nt){if(typeof Rt=="function")return function(ve){for(var De=arguments.length,Qt=Array(De>1?De-1:0),le=1;le<De;le++)Qt[le-1]=arguments[le];return mt.produceWithPatches(ve,function(Qe){return Rt.apply(void 0,[Qe].concat(Qt))})};var se,te,pe=mt.produce(Rt,Nt,function(ve,De){se=ve,te=De});return typeof Promise<"u"&&pe instanceof Promise?pe.then(function(ve){return[ve,se,te]}):[pe,se,te]},typeof(ct==null?void 0:ct.useProxies)=="boolean"&&this.setUseProxies(ct.useProxies),typeof(ct==null?void 0:ct.autoFreeze)=="boolean"&&this.setAutoFreeze(ct.autoFreeze)}var Z=Y.prototype;return Z.createDraft=function(ct){zg(ct)||sl(8),qg(ct)&&(ct=xH(ct));var mt=YW(this),Rt=WG(this,ct,void 0);return Rt[ps].C=!0,GG(mt),Rt},Z.finishDraft=function(ct,mt){var Rt=ct&&ct[ps],Nt=Rt.A;return UG(Nt,mt),xG(void 0,Nt)},Z.setAutoFreeze=function(ct){this.D=ct},Z.setUseProxies=function(ct){ct&&!QW&&sl(20),this.O=ct},Z.applyPatches=function(ct,mt){var Rt;for(Rt=mt.length-1;Rt>=0;Rt--){var Nt=mt[Rt];if(Nt.path.length===0&&Nt.op==="replace"){ct=Nt.value;break}}Rt>-1&&(mt=mt.slice(Rt+1));var se=hh("Patches").$;return qg(ct)?se(ct,mt):this.produce(ct,function(te){return se(te,mt)})},Y}(),mu=new GH;mu.produceWithPatches.bind(mu);mu.setAutoFreeze.bind(mu);mu.setUseProxies.bind(mu);mu.applyPatches.bind(mu);mu.createDraft.bind(mu);mu.finishDraft.bind(mu);function qO(Y){"@babel/helpers - typeof";return qO=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(Z){return typeof Z}:function(Z){return Z&&typeof Symbol=="function"&&Z.constructor===Symbol&&Z!==Symbol.prototype?"symbol":typeof Z},qO(Y)}function WH(Y,Z){if(qO(Y)!="object"||!Y)return Y;var ct=Y[Symbol.toPrimitive];if(ct!==void 0){var mt=ct.call(Y,Z);if(qO(mt)!="object")return mt;throw new TypeError("@@toPrimitive must return a primitive value.")}return(Z==="string"?String:Number)(Y)}function HH(Y){var Z=WH(Y,"string");return qO(Z)=="symbol"?Z:Z+""}function KH(Y,Z,ct){return(Z=HH(Z))in Y?Object.defineProperty(Y,Z,{value:ct,enumerable:!0,configurable:!0,writable:!0}):Y[Z]=ct,Y}function $W(Y,Z){var ct=Object.keys(Y);if(Object.getOwnPropertySymbols){var mt=Object.getOwnPropertySymbols(Y);Z&&(mt=mt.filter(function(Rt){return Object.getOwnPropertyDescriptor(Y,Rt).enumerable})),ct.push.apply(ct,mt)}return ct}function t5(Y){for(var Z=1;Z<arguments.length;Z++){var ct=arguments[Z]!=null?arguments[Z]:{};Z%2?$W(Object(ct),!0).forEach(function(mt){KH(Y,mt,ct[mt])}):Object.getOwnPropertyDescriptors?Object.defineProperties(Y,Object.getOwnPropertyDescriptors(ct)):$W(Object(ct)).forEach(function(mt){Object.defineProperty(Y,mt,Object.getOwnPropertyDescriptor(ct,mt))})}return Y}function Na(Y){return"Minified Redux error #"+Y+"; visit https://redux.js.org/Errors?code="+Y+" for the full message or use the non-minified dev environment for full errors. "}var e5=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),BG=function(){return Math.random().toString(36).substring(7).split("").join(".")},Q1={INIT:"@@redux/INIT"+BG(),REPLACE:"@@redux/REPLACE"+BG(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+BG()}};function YH(Y){if(typeof Y!="object"||Y===null)return!1;for(var Z=Y;Object.getPrototypeOf(Z)!==null;)Z=Object.getPrototypeOf(Z);return Object.getPrototypeOf(Y)===Z}function E5(Y,Z,ct){var mt;if(typeof Z=="function"&&typeof ct=="function"||typeof ct=="function"&&typeof arguments[3]=="function")throw new Error(Na(0));if(typeof Z=="function"&&typeof ct>"u"&&(ct=Z,Z=void 0),typeof ct<"u"){if(typeof ct!="function")throw new Error(Na(1));return ct(E5)(Y,Z)}if(typeof Y!="function")throw new Error(Na(2));var Rt=Y,Nt=Z,se=[],te=se,pe=!1;function ve(){te===se&&(te=se.slice())}function De(){if(pe)throw new Error(Na(3));return Nt}function Qt(dn){if(typeof dn!="function")throw new Error(Na(4));if(pe)throw new Error(Na(5));var Ei=!0;return ve(),te.push(dn),function(){if(Ei){if(pe)throw new Error(Na(6));Ei=!1,ve();var si=te.indexOf(dn);te.splice(si,1),se=null}}}function le(dn){if(!YH(dn))throw new Error(Na(7));if(typeof dn.type>"u")throw new Error(Na(8));if(pe)throw new Error(Na(9));try{pe=!0,Nt=Rt(Nt,dn)}finally{pe=!1}for(var Ei=se=te,ji=0;ji<Ei.length;ji++){var si=Ei[ji];si()}return dn}function Qe(dn){if(typeof dn!="function")throw new Error(Na(10));Rt=dn,le({type:Q1.REPLACE})}function Te(){var dn,Ei=Qt;return dn={subscribe:function(si){if(typeof si!="object"||si===null)throw new Error(Na(11));function mi(){si.next&&si.next(De())}mi();var Da=Ei(mi);return{unsubscribe:Da}}},dn[e5]=function(){return this},dn}return le({type:Q1.INIT}),mt={dispatch:le,subscribe:Qt,getState:De,replaceReducer:Qe},mt[e5]=Te,mt}function qH(Y){Object.keys(Y).forEach(function(Z){var ct=Y[Z],mt=ct(void 0,{type:Q1.INIT});if(typeof mt>"u")throw new Error(Na(12));if(typeof ct(void 0,{type:Q1.PROBE_UNKNOWN_ACTION()})>"u")throw new Error(Na(13))})}function zH(Y){for(var Z=Object.keys(Y),ct={},mt=0;mt<Z.length;mt++){var Rt=Z[mt];typeof Y[Rt]=="function"&&(ct[Rt]=Y[Rt])}var Nt=Object.keys(ct),se;try{qH(ct)}catch(te){se=te}return function(pe,ve){if(pe===void 0&&(pe={}),se)throw se;for(var De=!1,Qt={},le=0;le<Nt.length;le++){var Qe=Nt[le],Te=ct[Qe],dn=pe[Qe],Ei=Te(dn,ve);if(typeof Ei>"u")throw new Error(Na(14));Qt[Qe]=Ei,De=De||Ei!==dn}return De=De||Nt.length!==Object.keys(pe).length,De?Qt:pe}}function Z1(){for(var Y=arguments.length,Z=new Array(Y),ct=0;ct<Y;ct++)Z[ct]=arguments[ct];return Z.length===0?function(mt){return mt}:Z.length===1?Z[0]:Z.reduce(function(mt,Rt){return function(){return mt(Rt.apply(void 0,arguments))}})}function JH(){for(var Y=arguments.length,Z=new Array(Y),ct=0;ct<Y;ct++)Z[ct]=arguments[ct];return function(mt){return function(){var Rt=mt.apply(void 0,arguments),Nt=function(){throw new Error(Na(15))},se={getState:Rt.getState,dispatch:function(){return Nt.apply(void 0,arguments)}},te=Z.map(function(pe){return pe(se)});return Nt=Z1.apply(void 0,te)(Rt.dispatch),t5(t5({},Rt),{},{dispatch:Nt})}}}function m5(Y){var Z=function(mt){var Rt=mt.dispatch,Nt=mt.getState;return function(se){return function(te){return typeof te=="function"?te(Rt,Nt,Y):se(te)}}};return Z}var f5=m5();f5.withExtraArgument=m5;const n5=f5;var g5=function(){var Y=function(Z,ct){return Y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(mt,Rt){mt.__proto__=Rt}||function(mt,Rt){for(var Nt in Rt)Object.prototype.hasOwnProperty.call(Rt,Nt)&&(mt[Nt]=Rt[Nt])},Y(Z,ct)};return function(Z,ct){if(typeof ct!="function"&&ct!==null)throw new TypeError("Class extends value "+String(ct)+" is not a constructor or null");Y(Z,ct);function mt(){this.constructor=Z}Z.prototype=ct===null?Object.create(ct):(mt.prototype=ct.prototype,new mt)}}(),zO=function(Y,Z){for(var ct=0,mt=Z.length,Rt=Y.length;ct<mt;ct++,Rt++)Y[Rt]=Z[ct];return Y},XH=Object.defineProperty,i5=Object.getOwnPropertySymbols,QH=Object.prototype.hasOwnProperty,ZH=Object.prototype.propertyIsEnumerable,r5=function(Y,Z,ct){return Z in Y?XH(Y,Z,{enumerable:!0,configurable:!0,writable:!0,value:ct}):Y[Z]=ct},$H=function(Y,Z){for(var ct in Z||(Z={}))QH.call(Z,ct)&&r5(Y,ct,Z[ct]);if(i5)for(var mt=0,Rt=i5(Z);mt<Rt.length;mt++){var ct=Rt[mt];ZH.call(Z,ct)&&r5(Y,ct,Z[ct])}return Y},tK=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(arguments.length!==0)return typeof arguments[0]=="object"?Z1:Z1.apply(null,arguments)};function eK(Y){if(typeof Y!="object"||Y===null)return!1;var Z=Object.getPrototypeOf(Y);if(Z===null)return!0;for(var ct=Z;Object.getPrototypeOf(ct)!==null;)ct=Object.getPrototypeOf(ct);return Z===ct}var nK=function(Y){g5(Z,Y);function Z(){for(var ct=[],mt=0;mt<arguments.length;mt++)ct[mt]=arguments[mt];var Rt=Y.apply(this,ct)||this;return Object.setPrototypeOf(Rt,Z.prototype),Rt}return Object.defineProperty(Z,Symbol.species,{get:function(){return Z},enumerable:!1,configurable:!0}),Z.prototype.concat=function(){for(var ct=[],mt=0;mt<arguments.length;mt++)ct[mt]=arguments[mt];return Y.prototype.concat.apply(this,ct)},Z.prototype.prepend=function(){for(var ct=[],mt=0;mt<arguments.length;mt++)ct[mt]=arguments[mt];return ct.length===1&&Array.isArray(ct[0])?new(Z.bind.apply(Z,zO([void 0],ct[0].concat(this)))):new(Z.bind.apply(Z,zO([void 0],ct.concat(this))))},Z}(Array),iK=function(Y){g5(Z,Y);function Z(){for(var ct=[],mt=0;mt<arguments.length;mt++)ct[mt]=arguments[mt];var Rt=Y.apply(this,ct)||this;return Object.setPrototypeOf(Rt,Z.prototype),Rt}return Object.defineProperty(Z,Symbol.species,{get:function(){return Z},enumerable:!1,configurable:!0}),Z.prototype.concat=function(){for(var ct=[],mt=0;mt<arguments.length;mt++)ct[mt]=arguments[mt];return Y.prototype.concat.apply(this,ct)},Z.prototype.prepend=function(){for(var ct=[],mt=0;mt<arguments.length;mt++)ct[mt]=arguments[mt];return ct.length===1&&Array.isArray(ct[0])?new(Z.bind.apply(Z,zO([void 0],ct[0].concat(this)))):new(Z.bind.apply(Z,zO([void 0],ct.concat(this))))},Z}(Array);function rK(Y){return typeof Y=="boolean"}function sK(){return function(Z){return oK(Z)}}function oK(Y){Y===void 0&&(Y={});var Z=Y.thunk,ct=Z===void 0?!0:Z,mt=new nK;return ct&&(rK(ct)?mt.push(n5):mt.push(n5.withExtraArgument(ct.extraArgument))),mt}function aK(Y){var Z=sK(),ct=Y||{},mt=ct.reducer,Rt=mt===void 0?void 0:mt,Nt=ct.middleware,se=Nt===void 0?Z():Nt,te=ct.devTools,pe=te===void 0?!0:te,ve=ct.preloadedState,De=ve===void 0?void 0:ve,Qt=ct.enhancers,le=Qt===void 0?void 0:Qt,Qe;if(typeof Rt=="function")Qe=Rt;else if(eK(Rt))Qe=zH(Rt);else throw new Error('"reducer" is a required argument, and must be a function or an object of functions that can be passed to combineReducers');var Te=se;typeof Te=="function"&&(Te=Te(Z));var dn=JH.apply(void 0,Te),Ei=Z1;pe&&(Ei=tK($H({trace:!1},typeof pe=="object"&&pe)));var ji=new iK(dn),si=ji;Array.isArray(le)?si=zO([dn],le):typeof le=="function"&&(si=le(ji));var mi=Ei.apply(void 0,si);return E5(Qe,De,mi)}var s5;typeof queueMicrotask=="function"&&queueMicrotask.bind(typeof window<"u"?window:typeof global<"u"?global:globalThis);VH();const cK=(()=>{let Y;return{getStore:()=>Y,setStore:se=>{Y=se},getState:()=>Y&&Y.getState(),mapDispatchToProps:(se,te)=>{Object.keys(te).forEach(pe=>{const ve=te[pe];Object.defineProperty(se,pe,{get:()=>(...De)=>Y.dispatch(ve(...De)),configurable:!0,enumerable:!0})})},mapStateToProps:(se,te)=>{const pe=(De,Qt)=>{const le=te(Y.getState());Object.keys(le).forEach(Qe=>{const Te=le[Qe];se[Qe]=Te})},ve=Y.subscribe(()=>pe());return pe(),ve}}})();var T5={exports:{}};(function(Y,Z){(function(ct,mt){Y.exports=mt()})(YE,function(){function ct(s,e){return e.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(o){if(o!=="default"&&!(o in s)){var c=Object.getOwnPropertyDescriptor(i,o);Object.defineProperty(s,o,c.get?c:{enumerable:!0,get:function(){return i[o]}})}})}),Object.freeze(s)}var mt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof YE<"u"?YE:typeof self<"u"?self:{};function Rt(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Nt=function(s){try{return!!s()}catch{return!0}},se=!Nt(function(){var s=(function(){}).bind();return typeof s!="function"||s.hasOwnProperty("prototype")}),te=se,pe=Function.prototype,ve=pe.call,De=te&&pe.bind.bind(ve,ve),Qt=te?De:function(s){return function(){return ve.apply(s,arguments)}},le=Qt({}.isPrototypeOf),Qe=function(s){return s&&s.Math==Math&&s},Te=Qe(typeof globalThis=="object"&&globalThis)||Qe(typeof window=="object"&&window)||Qe(typeof self=="object"&&self)||Qe(typeof mt=="object"&&mt)||function(){return this}()||mt||Function("return this")(),dn=se,Ei=Function.prototype,ji=Ei.apply,si=Ei.call,mi=typeof Reflect=="object"&&Reflect.apply||(dn?si.bind(ji):function(){return si.apply(ji,arguments)}),Da=Qt,kd=Da({}.toString),fu=Da("".slice),Zi=function(s){return fu(kd(s),8,-1)},br=Zi,ol=Qt,fi=function(s){if(br(s)==="Function")return ol(s)},di=typeof document=="object"&&document.all,Lr={all:di,IS_HTMLDDA:di===void 0&&di!==void 0},XC=Lr.all,wn=Lr.IS_HTMLDDA?function(s){return typeof s=="function"||s===XC}:function(s){return typeof s=="function"},gu={},wr=!Nt(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),$1=se,_h=Function.prototype.call,Wn=$1?_h.bind(_h):function(){return _h.apply(_h,arguments)},Eh={},QC={}.propertyIsEnumerable,ZC=Object.getOwnPropertyDescriptor,tU=ZC&&!QC.call({1:2},1);Eh.f=tU?function(s){var e=ZC(this,s);return!!e&&e.enumerable}:QC;var Oo,mh,No=function(s,e){return{enumerable:!(1&s),configurable:!(2&s),writable:!(4&s),value:e}},eU=Nt,nU=Zi,qE=Object,iU=Qt("".split),fh=eU(function(){return!qE("z").propertyIsEnumerable(0)})?function(s){return nU(s)=="String"?iU(s,""):qE(s)}:qE,Tu=function(s){return s==null},rU=Tu,sU=TypeError,Md=function(s){if(rU(s))throw sU("Can't call method on "+s);return s},oU=fh,aU=Md,$o=function(s){return oU(aU(s))},$C=wn,cU=Lr.all,fr=Lr.IS_HTMLDDA?function(s){return typeof s=="object"?s!==null:$C(s)||s===cU}:function(s){return typeof s=="object"?s!==null:$C(s)},$r={},zE=$r,JE=Te,dU=wn,tv=function(s){return dU(s)?s:void 0},qi=function(s,e){return arguments.length<2?tv(zE[s])||tv(JE[s]):zE[s]&&zE[s][e]||JE[s]&&JE[s][e]},ta=typeof navigator<"u"&&String(navigator.userAgent)||"",ev=Te,XE=ta,nv=ev.process,iv=ev.Deno,rv=nv&&nv.versions||iv&&iv.version,sv=rv&&rv.v8;sv&&(mh=(Oo=sv.split("."))[0]>0&&Oo[0]<4?1:+(Oo[0]+Oo[1])),!mh&&XE&&(!(Oo=XE.match(/Edge\/(\d+)/))||Oo[1]>=74)&&(Oo=XE.match(/Chrome\/(\d+)/))&&(mh=+Oo[1]);var Pa=mh,ov=Pa,uU=Nt,lU=Te.String,Kc=!!Object.getOwnPropertySymbols&&!uU(function(){var s=Symbol();return!lU(s)||!(Object(s)instanceof Symbol)||!Symbol.sham&&ov&&ov<41}),av=Kc&&!Symbol.sham&&typeof Symbol.iterator=="symbol",hU=qi,pU=wn,_U=le,EU=Object,Su=av?function(s){return typeof s=="symbol"}:function(s){var e=hU("Symbol");return pU(e)&&_U(e.prototype,EU(s))},mU=String,Yc=function(s){try{return mU(s)}catch{return"Object"}},fU=wn,gU=Yc,TU=TypeError,kr=function(s){if(fU(s))return s;throw TU(gU(s)+" is not a function")},SU=kr,RU=Tu,Yp=function(s,e){var i=s[e];return RU(i)?void 0:SU(i)},cv=Wn,dv=wn,uv=fr,CU=TypeError,lv={exports:{}},hv=Te,vU=Object.defineProperty,IU=function(s,e){try{vU(hv,s,{value:e,configurable:!0,writable:!0})}catch{hv[s]=e}return e},pv="__core-js_shared__",QE=Te[pv]||IU(pv,{}),_v=QE;(lv.exports=function(s,e){return _v[s]||(_v[s]=e!==void 0?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var qc=lv.exports,yU=Md,AU=Object,Ns=function(s){return AU(yU(s))},bU=Ns,wU=Qt({}.hasOwnProperty),Zn=Object.hasOwn||function(s,e){return wU(bU(s),e)},OU=Qt,NU=0,DU=Math.random(),PU=OU(1 .toString),ZE=function(s){return"Symbol("+(s===void 0?"":s)+")_"+PU(++NU+DU,36)},LU=qc,Ev=Zn,kU=ZE,MU=Kc,UU=av,zc=Te.Symbol,$E=LU("wks"),xU=UU?zc.for||zc:zc&&zc.withoutSetter||kU,ze=function(s){return Ev($E,s)||($E[s]=MU&&Ev(zc,s)?zc[s]:xU("Symbol."+s)),$E[s]},VU=Wn,mv=fr,fv=Su,FU=Yp,BU=function(s,e){var i,o;if(dv(i=s.toString)&&!uv(o=cv(i,s))||dv(i=s.valueOf)&&!uv(o=cv(i,s)))return o;throw CU("Can't convert object to primitive value")},jU=TypeError,GU=ze("toPrimitive"),WU=function(s,e){if(!mv(s)||fv(s))return s;var i,o=FU(s,GU);if(o){if(i=VU(o,s,e),!mv(i)||fv(i))return i;throw jU("Can't convert object to primitive value")}return BU(s)},HU=Su,gh=function(s){var e=WU(s,"string");return HU(e)?e:e+""},gv=fr,tm=Te.document,KU=gv(tm)&&gv(tm.createElement),em=function(s){return KU?tm.createElement(s):{}},YU=em,Tv=!wr&&!Nt(function(){return Object.defineProperty(YU("div"),"a",{get:function(){return 7}}).a!=7}),qU=wr,zU=Wn,JU=Eh,XU=No,QU=$o,ZU=gh,$U=Zn,t2=Tv,Sv=Object.getOwnPropertyDescriptor;gu.f=qU?Sv:function(s,e){if(s=QU(s),e=ZU(e),t2)try{return Sv(s,e)}catch{}if($U(s,e))return XU(!zU(JU.f,s,e),s[e])};var e2=Nt,n2=wn,i2=/#|\.prototype\./,Ru=function(s,e){var i=s2[r2(s)];return i==a2||i!=o2&&(n2(e)?e2(e):!!e)},r2=Ru.normalize=function(s){return String(s).replace(i2,".").toLowerCase()},s2=Ru.data={},o2=Ru.NATIVE="N",a2=Ru.POLYFILL="P",Rv=Ru,c2=kr,d2=se,u2=fi(fi.bind),Do=function(s,e){return c2(s),e===void 0?s:d2?u2(s,e):function(){return s.apply(e,arguments)}},_s={},Cv=wr&&Nt(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),l2=fr,h2=String,p2=TypeError,$i=function(s){if(l2(s))return s;throw p2(h2(s)+" is not an object")},_2=wr,E2=Tv,m2=Cv,Th=$i,vv=gh,f2=TypeError,nm=Object.defineProperty,g2=Object.getOwnPropertyDescriptor,im="enumerable",rm="configurable",sm="writable";_s.f=_2?m2?function(s,e,i){if(Th(s),e=vv(e),Th(i),typeof s=="function"&&e==="prototype"&&"value"in i&&sm in i&&!i[sm]){var o=g2(s,e);o&&o[sm]&&(s[e]=i.value,i={configurable:rm in i?i[rm]:o[rm],enumerable:im in i?i[im]:o[im],writable:!1})}return nm(s,e,i)}:nm:function(s,e,i){if(Th(s),e=vv(e),Th(i),E2)try{return nm(s,e,i)}catch{}if("get"in i||"set"in i)throw f2("Accessors not supported");return"value"in i&&(s[e]=i.value),s};var T2=_s,S2=No,Po=wr?function(s,e,i){return T2.f(s,e,S2(1,i))}:function(s,e,i){return s[e]=i,s},Sh=Te,R2=mi,C2=fi,v2=wn,I2=gu.f,y2=Rv,Jc=$r,A2=Do,Xc=Po,Iv=Zn,b2=function(s){var e=function(i,o,c){if(this instanceof e){switch(arguments.length){case 0:return new s;case 1:return new s(i);case 2:return new s(i,o)}return new s(i,o,c)}return R2(s,this,arguments)};return e.prototype=s.prototype,e},Ce=function(s,e){var i,o,c,u,h,_,m,g,S,C=s.target,I=s.global,b=s.stat,x=s.proto,D=I?Sh:b?Sh[C]:(Sh[C]||{}).prototype,M=I?Jc:Jc[C]||Xc(Jc,C,{})[C],K=M.prototype;for(u in e)o=!(i=y2(I?u:C+(b?".":"#")+u,s.forced))&&D&&Iv(D,u),_=M[u],o&&(m=s.dontCallGetSet?(S=I2(D,u))&&S.value:D[u]),h=o&&m?m:e[u],o&&typeof _==typeof h||(g=s.bind&&o?A2(h,Sh):s.wrap&&o?b2(h):x&&v2(h)?C2(h):h,(s.sham||h&&h.sham||_&&_.sham)&&Xc(g,"sham",!0),Xc(M,u,g),x&&(Iv(Jc,c=C+"Prototype")||Xc(Jc,c,{}),Xc(Jc[c],u,h),s.real&&K&&(i||!K[u])&&Xc(K,u,h)))},w2=Math.ceil,O2=Math.floor,N2=Math.trunc||function(s){var e=+s;return(e>0?O2:w2)(e)},yv=function(s){var e=+s;return e!=e||e===0?0:N2(e)},Av=yv,D2=Math.max,P2=Math.min,XO=function(s,e){var i=Av(s);return i<0?D2(i+e,0):P2(i,e)},bv=yv,L2=Math.min,k2=function(s){return s>0?L2(bv(s),9007199254740991):0},Cu=function(s){return k2(s.length)},M2=$o,vu=XO,U2=Cu,QO=function(s){return function(e,i,o){var c,u=M2(e),h=U2(u),_=vu(o,h);if(s&&i!=i){for(;h>_;)if((c=u[_++])!=c)return!0}else for(;h>_;_++)if((s||_ in u)&&u[_]===i)return s||_||0;return!s&&-1}},wv={includes:QO(!0),indexOf:QO(!1)},ZO=wv.includes;Ce({target:"Array",proto:!0,forced:Nt(function(){return!Array(1).includes()})},{includes:function(s){return ZO(this,s,arguments.length>1?arguments[1]:void 0)}});var Ov=$r,al=function(s){return Ov[s+"Prototype"]},x2=al("Array").includes,fc=fr,V2=Zi,F2=ze("match"),B2=function(s){var e;return fc(s)&&((e=s[F2])!==void 0?!!e:V2(s)=="RegExp")},j2=TypeError,Nv={};Nv[ze("toStringTag")]="z";var Dv=String(Nv)==="[object z]",G2=Dv,$O=wn,qp=Zi,W2=ze("toStringTag"),H2=Object,Xg=qp(function(){return arguments}())=="Arguments",cl=G2?qp:function(s){var e,i,o;return s===void 0?"Undefined":s===null?"Null":typeof(i=function(c,u){try{return c[u]}catch{}}(e=H2(s),W2))=="string"?i:Xg?qp(e):(o=qp(e))=="Object"&&$O(e.callee)?"Arguments":o},K2=cl,Y2=String,Es=function(s){if(K2(s)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return Y2(s)},q2=ze("match"),z2=Ce,La=function(s){if(B2(s))throw j2("The method doesn't accept regular expressions");return s},J2=Md,tN=Es,X2=function(s){var e=/./;try{"/./"[s](e)}catch{try{return e[q2]=!1,"/./"[s](e)}catch{}}return!1},Q2=Qt("".indexOf);z2({target:"String",proto:!0,forced:!X2("includes")},{includes:function(s){return!!~Q2(tN(J2(this)),tN(La(s)),arguments.length>1?arguments[1]:void 0)}});var eN=al("String").includes,nN=le,Z2=x2,$2=eN,Qg=Array.prototype,Pv=String.prototype,Jt=Rt(function(s){var e=s.includes;return s===Qg||nN(Qg,s)&&e===Qg.includes?Z2:typeof s=="string"||s===Pv||nN(Pv,s)&&e===Pv.includes?$2:e});let Zg=!0,$g=!0;function tT(s,e,i){const o=s.match(e);return o&&o.length>=i&&parseInt(o[i],10)}function Mt(s,e,i){if(!s.RTCPeerConnection)return;const o=s.RTCPeerConnection.prototype,c=o.addEventListener;o.addEventListener=function(h,_){if(h!==e)return c.apply(this,arguments);const m=g=>{const S=i(g);S&&(_.handleEvent?_.handleEvent(S):_(S))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(_,m),c.apply(this,[h,m])};const u=o.removeEventListener;o.removeEventListener=function(h,_){if(h!==e||!this._eventMap||!this._eventMap[e])return u.apply(this,arguments);if(!this._eventMap[e].has(_))return u.apply(this,arguments);const m=this._eventMap[e].get(_);return this._eventMap[e].delete(_),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,u.apply(this,[h,m])},Object.defineProperty(o,"on"+e,{get(){return this["_on"+e]},set(h){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),h&&this.addEventListener(e,this["_on"+e]=h)},enumerable:!0,configurable:!0})}function tx(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(Zg=s,s?"adapter.js logging disabled":"adapter.js logging enabled")}function ex(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):($g=!s,"adapter.js deprecation warnings "+(s?"disabled":"enabled"))}function iN(){if(typeof window=="object"){if(Zg)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Lv(s,e){$g&&console.warn(s+" is deprecated, please use "+e+" instead.")}function rN(s){return Object.prototype.toString.call(s)==="[object Object]"}function sN(s){return rN(s)?Object.keys(s).reduce(function(e,i){const o=rN(s[i]),c=o?sN(s[i]):s[i],u=o&&!Object.keys(c).length;return c===void 0||u?e:Object.assign(e,{[i]:c})},{}):s}function kv(s,e,i){e&&!i.has(e.id)&&(i.set(e.id,e),Object.keys(e).forEach(o=>{o.endsWith("Id")?kv(s,s.get(e[o]),i):o.endsWith("Ids")&&e[o].forEach(c=>{kv(s,s.get(c),i)})}))}function oN(s,e,i){const o=i?"outbound-rtp":"inbound-rtp",c=new Map;if(e===null)return c;const u=[];return s.forEach(h=>{h.type==="track"&&h.trackIdentifier===e.id&&u.push(h)}),u.forEach(h=>{s.forEach(_=>{_.type===o&&_.trackId===h.id&&kv(s,_,c)})}),c}const om=iN;function Rh(s,e){const i=s&&s.navigator;if(!i.mediaDevices)return;const o=function(h){if(typeof h!="object"||h.mandatory||h.optional)return h;const _={};return Object.keys(h).forEach(m=>{if(m==="require"||m==="advanced"||m==="mediaSource")return;const g=typeof h[m]=="object"?h[m]:{ideal:h[m]};g.exact!==void 0&&typeof g.exact=="number"&&(g.min=g.max=g.exact);const S=function(C,I){return C?C+I.charAt(0).toUpperCase()+I.slice(1):I==="deviceId"?"sourceId":I};if(g.ideal!==void 0){_.optional=_.optional||[];let C={};typeof g.ideal=="number"?(C[S("min",m)]=g.ideal,_.optional.push(C),C={},C[S("max",m)]=g.ideal,_.optional.push(C)):(C[S("",m)]=g.ideal,_.optional.push(C))}g.exact!==void 0&&typeof g.exact!="number"?(_.mandatory=_.mandatory||{},_.mandatory[S("",m)]=g.exact):["min","max"].forEach(C=>{g[C]!==void 0&&(_.mandatory=_.mandatory||{},_.mandatory[S(C,m)]=g[C])})}),h.advanced&&(_.optional=(_.optional||[]).concat(h.advanced)),_},c=function(h,_){if(e.version>=61)return _(h);if((h=JSON.parse(JSON.stringify(h)))&&typeof h.audio=="object"){const m=function(g,S,C){S in g&&!(C in g)&&(g[C]=g[S],delete g[S])};m((h=JSON.parse(JSON.stringify(h))).audio,"autoGainControl","googAutoGainControl"),m(h.audio,"noiseSuppression","googNoiseSuppression"),h.audio=o(h.audio)}if(h&&typeof h.video=="object"){let m=h.video.facingMode;m=m&&(typeof m=="object"?m:{ideal:m});const g=e.version<66;if(m&&(m.exact==="user"||m.exact==="environment"||m.ideal==="user"||m.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||g)){let S;if(delete h.video.facingMode,m.exact==="environment"||m.ideal==="environment"?S=["back","rear"]:m.exact!=="user"&&m.ideal!=="user"||(S=["front"]),S)return i.mediaDevices.enumerateDevices().then(C=>{let I=(C=C.filter(b=>b.kind==="videoinput")).find(b=>S.some(x=>b.label.toLowerCase().includes(x)));return!I&&C.length&&S.includes("back")&&(I=C[C.length-1]),I&&(h.video.deviceId=m.exact?{exact:I.deviceId}:{ideal:I.deviceId}),h.video=o(h.video),om("chrome: "+JSON.stringify(h)),_(h)})}h.video=o(h.video)}return om("chrome: "+JSON.stringify(h)),_(h)},u=function(h){return e.version>=64?h:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[h.name]||h.name,message:h.message,constraint:h.constraint||h.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(h,_,m){c(h,g=>{i.webkitGetUserMedia(g,_,S=>{m&&m(u(S))})})}).bind(i),i.mediaDevices.getUserMedia){const h=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(_){return c(_,m=>h(m).then(g=>{if(m.audio&&!g.getAudioTracks().length||m.video&&!g.getVideoTracks().length)throw g.getTracks().forEach(S=>{S.stop()}),new DOMException("","NotFoundError");return g},g=>Promise.reject(u(g))))}}}function aN(s){s.MediaStream=s.MediaStream||s.webkitMediaStream}function cN(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("ontrack"in s.RTCPeerConnection.prototype)){Object.defineProperty(s.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});const e=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",o=>{let c;c=s.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(h=>h.track&&h.track.id===o.track.id):{track:o.track};const u=new Event("track");u.track=o.track,u.receiver=c,u.transceiver={receiver:c},u.streams=[i.stream],this.dispatchEvent(u)}),i.stream.getTracks().forEach(o=>{let c;c=s.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(h=>h.track&&h.track.id===o.id):{track:o};const u=new Event("track");u.track=o,u.receiver=c,u.transceiver={receiver:c},u.streams=[i.stream],this.dispatchEvent(u)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Mt(s,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function dN(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("getSenders"in s.RTCPeerConnection.prototype)&&"createDTMFSender"in s.RTCPeerConnection.prototype){const e=function(c,u){return{track:u,get dtmf(){return this._dtmf===void 0&&(u.kind==="audio"?this._dtmf=c.createDTMFSender(u):this._dtmf=null),this._dtmf},_pc:c}};if(!s.RTCPeerConnection.prototype.getSenders){s.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const c=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(h,_){let m=c.apply(this,arguments);return m||(m=e(this,h),this._senders.push(m)),m};const u=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(h){u.apply(this,arguments);const _=this._senders.indexOf(h);_!==-1&&this._senders.splice(_,1)}}const i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(c){this._senders=this._senders||[],i.apply(this,[c]),c.getTracks().forEach(u=>{this._senders.push(e(this,u))})};const o=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(c){this._senders=this._senders||[],o.apply(this,[c]),c.getTracks().forEach(u=>{const h=this._senders.find(_=>_.track===u);h&&this._senders.splice(this._senders.indexOf(h),1)})}}else if(typeof s=="object"&&s.RTCPeerConnection&&"getSenders"in s.RTCPeerConnection.prototype&&"createDTMFSender"in s.RTCPeerConnection.prototype&&s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)){const e=s.RTCPeerConnection.prototype.getSenders;s.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(o=>o._pc=this),i},Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function uN(s){if(!s.RTCPeerConnection)return;const e=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[i,o,c]=arguments;if(arguments.length>0&&typeof i=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof i!="function"))return e.apply(this,[]);const u=function(_){const m={};return _.result().forEach(g=>{const S={id:g.id,timestamp:g.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[g.type]||g.type};g.names().forEach(C=>{S[C]=g.stat(C)}),m[S.id]=S}),m},h=function(_){return new Map(Object.keys(_).map(m=>[m,_[m]]))};if(arguments.length>=2){const _=function(m){o(h(u(m)))};return e.apply(this,[_,i])}return new Promise((_,m)=>{e.apply(this,[function(g){_(h(u(g)))},m])}).then(o,c)}}function eT(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender&&s.RTCRtpReceiver))return;if(!("getStats"in s.RTCRtpSender.prototype)){const i=s.RTCPeerConnection.prototype.getSenders;i&&(s.RTCPeerConnection.prototype.getSenders=function(){const c=i.apply(this,[]);return c.forEach(u=>u._pc=this),c});const o=s.RTCPeerConnection.prototype.addTrack;o&&(s.RTCPeerConnection.prototype.addTrack=function(){const c=o.apply(this,arguments);return c._pc=this,c}),s.RTCRtpSender.prototype.getStats=function(){const c=this;return this._pc.getStats().then(u=>oN(u,c.track,!0))}}if(!("getStats"in s.RTCRtpReceiver.prototype)){const i=s.RTCPeerConnection.prototype.getReceivers;i&&(s.RTCPeerConnection.prototype.getReceivers=function(){const o=i.apply(this,[]);return o.forEach(c=>c._pc=this),o}),Mt(s,"track",o=>(o.receiver._pc=o.srcElement,o)),s.RTCRtpReceiver.prototype.getStats=function(){const o=this;return this._pc.getStats().then(c=>oN(c,o.track,!1))}}if(!("getStats"in s.RTCRtpSender.prototype)||!("getStats"in s.RTCRtpReceiver.prototype))return;const e=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof s.MediaStreamTrack){const i=arguments[0];let o,c,u;return this.getSenders().forEach(h=>{h.track===i&&(o?u=!0:o=h)}),this.getReceivers().forEach(h=>(h.track===i&&(c?u=!0:c=h),h.track===i)),u||o&&c?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):o?o.getStats():c?c.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function lN(s){s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(u=>this._shimmedLocalStreams[u][0])};const e=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(u,h){if(!h)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const _=e.apply(this,arguments);return this._shimmedLocalStreams[h.id]?this._shimmedLocalStreams[h.id].indexOf(_)===-1&&this._shimmedLocalStreams[h.id].push(_):this._shimmedLocalStreams[h.id]=[h,_],_};const i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(u){this._shimmedLocalStreams=this._shimmedLocalStreams||{},u.getTracks().forEach(m=>{if(this.getSenders().find(g=>g.track===m))throw new DOMException("Track already exists.","InvalidAccessError")});const h=this.getSenders();i.apply(this,arguments);const _=this.getSenders().filter(m=>h.indexOf(m)===-1);this._shimmedLocalStreams[u.id]=[u].concat(_)};const o=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(u){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[u.id],o.apply(this,arguments)};const c=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(u){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},u&&Object.keys(this._shimmedLocalStreams).forEach(h=>{const _=this._shimmedLocalStreams[h].indexOf(u);_!==-1&&this._shimmedLocalStreams[h].splice(_,1),this._shimmedLocalStreams[h].length===1&&delete this._shimmedLocalStreams[h]}),c.apply(this,arguments)}}function Mv(s,e){if(!s.RTCPeerConnection)return;if(s.RTCPeerConnection.prototype.addTrack&&e.version>=65)return lN(s);const i=s.RTCPeerConnection.prototype.getLocalStreams;s.RTCPeerConnection.prototype.getLocalStreams=function(){const m=i.apply(this);return this._reverseStreams=this._reverseStreams||{},m.map(g=>this._reverseStreams[g.id])};const o=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(m){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},m.getTracks().forEach(g=>{if(this.getSenders().find(S=>S.track===g))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[m.id]){const g=new s.MediaStream(m.getTracks());this._streams[m.id]=g,this._reverseStreams[g.id]=m,m=g}o.apply(this,[m])};const c=s.RTCPeerConnection.prototype.removeStream;function u(m,g){let S=g.sdp;return Object.keys(m._reverseStreams||[]).forEach(C=>{const I=m._reverseStreams[C],b=m._streams[I.id];S=S.replace(new RegExp(b.id,"g"),I.id)}),new RTCSessionDescription({type:g.type,sdp:S})}s.RTCPeerConnection.prototype.removeStream=function(m){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.apply(this,[this._streams[m.id]||m]),delete this._reverseStreams[this._streams[m.id]?this._streams[m.id].id:m.id],delete this._streams[m.id]},s.RTCPeerConnection.prototype.addTrack=function(m,g){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const S=[].slice.call(arguments,1);if(S.length!==1||!S[0].getTracks().find(I=>I===m))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(I=>I.track===m))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const C=this._streams[g.id];if(C)C.addTrack(m),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const I=new s.MediaStream([m]);this._streams[g.id]=I,this._reverseStreams[I.id]=g,this.addStream(I)}return this.getSenders().find(I=>I.track===m)},["createOffer","createAnswer"].forEach(function(m){const g=s.RTCPeerConnection.prototype[m],S={[m](){const C=arguments;return arguments.length&&typeof arguments[0]=="function"?g.apply(this,[I=>{const b=u(this,I);C[0].apply(null,[b])},I=>{C[1]&&C[1].apply(null,I)},arguments[2]]):g.apply(this,arguments).then(I=>u(this,I))}};s.RTCPeerConnection.prototype[m]=S[m]});const h=s.RTCPeerConnection.prototype.setLocalDescription;s.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(m,g){let S=g.sdp;return Object.keys(m._reverseStreams||[]).forEach(C=>{const I=m._reverseStreams[C],b=m._streams[I.id];S=S.replace(new RegExp(I.id,"g"),b.id)}),new RTCSessionDescription({type:g.type,sdp:S})}(this,arguments[0]),h.apply(this,arguments)):h.apply(this,arguments)};const _=Object.getOwnPropertyDescriptor(s.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(s.RTCPeerConnection.prototype,"localDescription",{get(){const m=_.get.apply(this);return m.type===""?m:u(this,m)}}),s.RTCPeerConnection.prototype.removeTrack=function(m){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!m._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(m._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let g;this._streams=this._streams||{},Object.keys(this._streams).forEach(S=>{this._streams[S].getTracks().find(C=>m.track===C)&&(g=this._streams[S])}),g&&(g.getTracks().length===1?this.removeStream(this._reverseStreams[g.id]):g.removeTrack(m.track),this.dispatchEvent(new Event("negotiationneeded")))}}function ka(s,e){!s.RTCPeerConnection&&s.webkitRTCPeerConnection&&(s.RTCPeerConnection=s.webkitRTCPeerConnection),s.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const o=s.RTCPeerConnection.prototype[i],c={[i](){return arguments[0]=new(i==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};s.RTCPeerConnection.prototype[i]=c[i]})}function Uv(s,e){Mt(s,"negotiationneeded",i=>{const o=i.target;if(!(e.version<72||o.getConfiguration&&o.getConfiguration().sdpSemantics==="plan-b")||o.signalingState==="stable")return i})}var xv=Object.freeze({__proto__:null,fixNegotiationNeeded:Uv,shimAddTrackRemoveTrack:Mv,shimAddTrackRemoveTrackWithNative:lN,shimGetDisplayMedia:function(s,e){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(typeof e=="function"?s.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then(o=>{const c=i.video&&i.video.width,u=i.video&&i.video.height,h=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:o,maxFrameRate:h||3}},c&&(i.video.mandatory.maxWidth=c),u&&(i.video.mandatory.maxHeight=u),s.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:dN,shimGetStats:uN,shimGetUserMedia:Rh,shimMediaStream:aN,shimOnTrack:cN,shimPeerConnection:ka,shimSenderReceiverGetStats:eT});function am(s,e){const i=s&&s.navigator,o=s&&s.MediaStreamTrack;if(i.getUserMedia=function(c,u,h){Lv("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(c).then(u,h)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const c=function(h,_,m){_ in h&&!(m in h)&&(h[m]=h[_],delete h[_])},u=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(h){return typeof h=="object"&&typeof h.audio=="object"&&(h=JSON.parse(JSON.stringify(h)),c(h.audio,"autoGainControl","mozAutoGainControl"),c(h.audio,"noiseSuppression","mozNoiseSuppression")),u(h)},o&&o.prototype.getSettings){const h=o.prototype.getSettings;o.prototype.getSettings=function(){const _=h.apply(this,arguments);return c(_,"mozAutoGainControl","autoGainControl"),c(_,"mozNoiseSuppression","noiseSuppression"),_}}if(o&&o.prototype.applyConstraints){const h=o.prototype.applyConstraints;o.prototype.applyConstraints=function(_){return this.kind==="audio"&&typeof _=="object"&&(_=JSON.parse(JSON.stringify(_)),c(_,"autoGainControl","mozAutoGainControl"),c(_,"noiseSuppression","mozNoiseSuppression")),h.apply(this,[_])}}}}function dl(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Vv(s,e){if(typeof s!="object"||!s.RTCPeerConnection&&!s.mozRTCPeerConnection)return;!s.RTCPeerConnection&&s.mozRTCPeerConnection&&(s.RTCPeerConnection=s.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(c){const u=s.RTCPeerConnection.prototype[c],h={[c](){return arguments[0]=new(c==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),u.apply(this,arguments)}};s.RTCPeerConnection.prototype[c]=h[c]});const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[c,u,h]=arguments;return o.apply(this,[c||null]).then(_=>{if(e.version<53&&!u)try{_.forEach(m=>{m.type=i[m.type]||m.type})}catch(m){if(m.name!=="TypeError")throw m;_.forEach((g,S)=>{_.set(S,Object.assign({},g,{type:i[g.type]||g.type}))})}return _}).then(u,h)}}function hN(s){if(typeof s!="object"||!s.RTCPeerConnection||!s.RTCRtpSender||s.RTCRtpSender&&"getStats"in s.RTCRtpSender.prototype)return;const e=s.RTCPeerConnection.prototype.getSenders;e&&(s.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(c=>c._pc=this),o});const i=s.RTCPeerConnection.prototype.addTrack;i&&(s.RTCPeerConnection.prototype.addTrack=function(){const o=i.apply(this,arguments);return o._pc=this,o}),s.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Fv(s){if(typeof s!="object"||!s.RTCPeerConnection||!s.RTCRtpSender||s.RTCRtpSender&&"getStats"in s.RTCRtpReceiver.prototype)return;const e=s.RTCPeerConnection.prototype.getReceivers;e&&(s.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(o=>o._pc=this),i}),Mt(s,"track",i=>(i.receiver._pc=i.srcElement,i)),s.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function nT(s){s.RTCPeerConnection&&!("removeStream"in s.RTCPeerConnection.prototype)&&(s.RTCPeerConnection.prototype.removeStream=function(e){Lv("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&e.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Bv(s){s.DataChannel&&!s.RTCDataChannel&&(s.RTCDataChannel=s.DataChannel)}function jv(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const e=s.RTCPeerConnection.prototype.addTransceiver;e&&(s.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const o=i.length>0;o&&i.forEach(u=>{if("rid"in u&&!/^[a-z0-9]{0,16}$/i.test(u.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in u&&!(parseFloat(u.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in u&&!(parseFloat(u.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const c=e.apply(this,arguments);if(o){const{sender:u}=c,h=u.getParameters();(!("encodings"in h)||h.encodings.length===1&&Object.keys(h.encodings[0]).length===0)&&(h.encodings=i,u.sendEncodings=i,this.setParametersPromises.push(u.setParameters(h).then(()=>{delete u.sendEncodings}).catch(()=>{delete u.sendEncodings})))}return c})}function iT(s){if(typeof s!="object"||!s.RTCRtpSender)return;const e=s.RTCRtpSender.prototype.getParameters;e&&(s.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Gv(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const e=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function pN(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const e=s.RTCPeerConnection.prototype.createAnswer;s.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var Wv=Object.freeze({__proto__:null,shimAddTransceiver:jv,shimCreateAnswer:pN,shimCreateOffer:Gv,shimGetDisplayMedia:function(s,e){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(s.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const o=new DOMException("getDisplayMedia without video constraints is undefined");return o.name="NotFoundError",o.code=8,Promise.reject(o)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,s.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:iT,shimGetUserMedia:am,shimOnTrack:dl,shimPeerConnection:Vv,shimRTCDataChannel:Bv,shimReceiverGetStats:Fv,shimRemoveStream:nT,shimSenderGetStats:hN});function cm(s){if(typeof s=="object"&&s.RTCPeerConnection){if("getLocalStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in s.RTCPeerConnection.prototype)){const e=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(o=>e.call(this,o,i)),i.getVideoTracks().forEach(o=>e.call(this,o,i))},s.RTCPeerConnection.prototype.addTrack=function(i,...o){return o&&o.forEach(c=>{this._localStreams?this._localStreams.includes(c)||this._localStreams.push(c):this._localStreams=[c]}),e.apply(this,arguments)}}"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);const o=e.getTracks();this.getSenders().forEach(c=>{o.includes(c.track)&&this.removeTrack(c)})})}}function _N(s){if(typeof s=="object"&&s.RTCPeerConnection&&("getRemoteStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in s.RTCPeerConnection.prototype))){Object.defineProperty(s.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=o=>{o.streams.forEach(c=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(c))return;this._remoteStreams.push(c);const u=new Event("addstream");u.stream=c,this.dispatchEvent(u)})})}});const e=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(o){o.streams.forEach(c=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(c)>=0)return;i._remoteStreams.push(c);const u=new Event("addstream");u.stream=c,i.dispatchEvent(u)})}),e.apply(i,arguments)}}}function EN(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const e=s.RTCPeerConnection.prototype,i=e.createOffer,o=e.createAnswer,c=e.setLocalDescription,u=e.setRemoteDescription,h=e.addIceCandidate;e.createOffer=function(m,g){const S=arguments.length>=2?arguments[2]:arguments[0],C=i.apply(this,[S]);return g?(C.then(m,g),Promise.resolve()):C},e.createAnswer=function(m,g){const S=arguments.length>=2?arguments[2]:arguments[0],C=o.apply(this,[S]);return g?(C.then(m,g),Promise.resolve()):C};let _=function(m,g,S){const C=c.apply(this,[m]);return S?(C.then(g,S),Promise.resolve()):C};e.setLocalDescription=_,_=function(m,g,S){const C=u.apply(this,[m]);return S?(C.then(g,S),Promise.resolve()):C},e.setRemoteDescription=_,_=function(m,g,S){const C=h.apply(this,[m]);return S?(C.then(g,S),Promise.resolve()):C},e.addIceCandidate=_}function mN(s){const e=s&&s.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const i=e.mediaDevices,o=i.getUserMedia.bind(i);e.mediaDevices.getUserMedia=c=>o(fN(c))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,o,c){e.mediaDevices.getUserMedia(i).then(o,c)}).bind(e))}function fN(s){return s&&s.video!==void 0?Object.assign({},s,{video:sN(s.video)}):s}function gN(s){if(!s.RTCPeerConnection)return;const e=s.RTCPeerConnection;s.RTCPeerConnection=function(i,o){if(i&&i.iceServers){const c=[];for(let u=0;u<i.iceServers.length;u++){let h=i.iceServers[u];!h.hasOwnProperty("urls")&&h.hasOwnProperty("url")?(Lv("RTCIceServer.url","RTCIceServer.urls"),h=JSON.parse(JSON.stringify(h)),h.urls=h.url,delete h.url,c.push(h)):c.push(i.iceServers[u])}i.iceServers=c}return new e(i,o)},s.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(s.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function Hv(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function rT(s){const e=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const o=this.getTransceivers().find(u=>u.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):i.offerToReceiveAudio!==!0||o||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const c=this.getTransceivers().find(u=>u.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&c?c.direction==="sendrecv"?c.setDirection?c.setDirection("sendonly"):c.direction="sendonly":c.direction==="recvonly"&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive"):i.offerToReceiveVideo!==!0||c||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function TN(s){typeof s!="object"||s.AudioContext||(s.AudioContext=s.webkitAudioContext)}var sT=Object.freeze({__proto__:null,shimAudioContext:TN,shimCallbacksAPI:EN,shimConstraints:fN,shimCreateOfferLegacy:rT,shimGetUserMedia:mN,shimLocalStreamsAPI:cm,shimRTCIceServerUrls:gN,shimRemoteStreamsAPI:_N,shimTrackEventTransceiver:Hv}),SN={exports:{}};(function(s){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(i){return i.trim().split(`
`).map(o=>o.trim())},e.splitSections=function(i){return i.split(`
m=`).map((o,c)=>(c>0?"m="+o:o).trim()+`\r
`)},e.getDescription=function(i){const o=e.splitSections(i);return o&&o[0]},e.getMediaSections=function(i){const o=e.splitSections(i);return o.shift(),o},e.matchPrefix=function(i,o){return e.splitLines(i).filter(c=>c.indexOf(o)===0)},e.parseCandidate=function(i){let o;o=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");const c={foundation:o[0],component:{1:"rtp",2:"rtcp"}[o[1]]||o[1],protocol:o[2].toLowerCase(),priority:parseInt(o[3],10),ip:o[4],address:o[4],port:parseInt(o[5],10),type:o[7]};for(let u=8;u<o.length;u+=2)switch(o[u]){case"raddr":c.relatedAddress=o[u+1];break;case"rport":c.relatedPort=parseInt(o[u+1],10);break;case"tcptype":c.tcpType=o[u+1];break;case"ufrag":c.ufrag=o[u+1],c.usernameFragment=o[u+1];break;default:c[o[u]]===void 0&&(c[o[u]]=o[u+1])}return c},e.writeCandidate=function(i){const o=[];o.push(i.foundation);const c=i.component;c==="rtp"?o.push(1):c==="rtcp"?o.push(2):o.push(c),o.push(i.protocol.toUpperCase()),o.push(i.priority),o.push(i.address||i.ip),o.push(i.port);const u=i.type;return o.push("typ"),o.push(u),u!=="host"&&i.relatedAddress&&i.relatedPort&&(o.push("raddr"),o.push(i.relatedAddress),o.push("rport"),o.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(o.push("tcptype"),o.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(o.push("ufrag"),o.push(i.usernameFragment||i.ufrag)),"candidate:"+o.join(" ")},e.parseIceOptions=function(i){return i.substring(14).split(" ")},e.parseRtpMap=function(i){let o=i.substring(9).split(" ");const c={payloadType:parseInt(o.shift(),10)};return o=o[0].split("/"),c.name=o[0],c.clockRate=parseInt(o[1],10),c.channels=o.length===3?parseInt(o[2],10):1,c.numChannels=c.channels,c},e.writeRtpMap=function(i){let o=i.payloadType;i.preferredPayloadType!==void 0&&(o=i.preferredPayloadType);const c=i.channels||i.numChannels||1;return"a=rtpmap:"+o+" "+i.name+"/"+i.clockRate+(c!==1?"/"+c:"")+`\r
`},e.parseExtmap=function(i){const o=i.substring(9).split(" ");return{id:parseInt(o[0],10),direction:o[0].indexOf("/")>0?o[0].split("/")[1]:"sendrecv",uri:o[1],attributes:o.slice(2).join(" ")}},e.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},e.parseFmtp=function(i){const o={};let c;const u=i.substring(i.indexOf(" ")+1).split(";");for(let h=0;h<u.length;h++)c=u[h].trim().split("="),o[c[0].trim()]=c[1];return o},e.writeFmtp=function(i){let o="",c=i.payloadType;if(i.preferredPayloadType!==void 0&&(c=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){const u=[];Object.keys(i.parameters).forEach(h=>{i.parameters[h]!==void 0?u.push(h+"="+i.parameters[h]):u.push(h)}),o+="a=fmtp:"+c+" "+u.join(";")+`\r
`}return o},e.parseRtcpFb=function(i){const o=i.substring(i.indexOf(" ")+1).split(" ");return{type:o.shift(),parameter:o.join(" ")}},e.writeRtcpFb=function(i){let o="",c=i.payloadType;return i.preferredPayloadType!==void 0&&(c=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(u=>{o+="a=rtcp-fb:"+c+" "+u.type+(u.parameter&&u.parameter.length?" "+u.parameter:"")+`\r
`}),o},e.parseSsrcMedia=function(i){const o=i.indexOf(" "),c={ssrc:parseInt(i.substring(7,o),10)},u=i.indexOf(":",o);return u>-1?(c.attribute=i.substring(o+1,u),c.value=i.substring(u+1)):c.attribute=i.substring(o+1),c},e.parseSsrcGroup=function(i){const o=i.substring(13).split(" ");return{semantics:o.shift(),ssrcs:o.map(c=>parseInt(c,10))}},e.getMid=function(i){const o=e.matchPrefix(i,"a=mid:")[0];if(o)return o.substring(6)},e.parseFingerprint=function(i){const o=i.substring(14).split(" ");return{algorithm:o[0].toLowerCase(),value:o[1].toUpperCase()}},e.getDtlsParameters=function(i,o){return{role:"auto",fingerprints:e.matchPrefix(i+o,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(i,o){let c="a=setup:"+o+`\r
`;return i.fingerprints.forEach(u=>{c+="a=fingerprint:"+u.algorithm+" "+u.value+`\r
`}),c},e.parseCryptoLine=function(i){const o=i.substring(9).split(" ");return{tag:parseInt(o[0],10),cryptoSuite:o[1],keyParams:o[2],sessionParams:o.slice(3)}},e.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?e.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;const o=i.substring(7).split("|");return{keyMethod:"inline",keySalt:o[0],lifeTime:o[1],mkiValue:o[2]?o[2].split(":")[0]:void 0,mkiLength:o[2]?o[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},e.getCryptoParameters=function(i,o){return e.matchPrefix(i+o,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(i,o){const c=e.matchPrefix(i+o,"a=ice-ufrag:")[0],u=e.matchPrefix(i+o,"a=ice-pwd:")[0];return c&&u?{usernameFragment:c.substring(12),password:u.substring(10)}:null},e.writeIceParameters=function(i){let o="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(o+=`a=ice-lite\r
`),o},e.parseRtpParameters=function(i){const o={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=e.splitLines(i)[0].split(" ");o.profile=c[2];for(let h=3;h<c.length;h++){const _=c[h],m=e.matchPrefix(i,"a=rtpmap:"+_+" ")[0];if(m){const g=e.parseRtpMap(m),S=e.matchPrefix(i,"a=fmtp:"+_+" ");switch(g.parameters=S.length?e.parseFmtp(S[0]):{},g.rtcpFeedback=e.matchPrefix(i,"a=rtcp-fb:"+_+" ").map(e.parseRtcpFb),o.codecs.push(g),g.name.toUpperCase()){case"RED":case"ULPFEC":o.fecMechanisms.push(g.name.toUpperCase())}}}e.matchPrefix(i,"a=extmap:").forEach(h=>{o.headerExtensions.push(e.parseExtmap(h))});const u=e.matchPrefix(i,"a=rtcp-fb:* ").map(e.parseRtcpFb);return o.codecs.forEach(h=>{u.forEach(_=>{h.rtcpFeedback.find(m=>m.type===_.type&&m.parameter===_.parameter)||h.rtcpFeedback.push(_)})}),o},e.writeRtpDescription=function(i,o){let c="";c+="m="+i+" ",c+=o.codecs.length>0?"9":"0",c+=" "+(o.profile||"UDP/TLS/RTP/SAVPF")+" ",c+=o.codecs.map(h=>h.preferredPayloadType!==void 0?h.preferredPayloadType:h.payloadType).join(" ")+`\r
`,c+=`c=IN IP4 0.0.0.0\r
`,c+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,o.codecs.forEach(h=>{c+=e.writeRtpMap(h),c+=e.writeFmtp(h),c+=e.writeRtcpFb(h)});let u=0;return o.codecs.forEach(h=>{h.maxptime>u&&(u=h.maxptime)}),u>0&&(c+="a=maxptime:"+u+`\r
`),o.headerExtensions&&o.headerExtensions.forEach(h=>{c+=e.writeExtmap(h)}),c},e.parseRtpEncodingParameters=function(i){const o=[],c=e.parseRtpParameters(i),u=c.fecMechanisms.indexOf("RED")!==-1,h=c.fecMechanisms.indexOf("ULPFEC")!==-1,_=e.matchPrefix(i,"a=ssrc:").map(I=>e.parseSsrcMedia(I)).filter(I=>I.attribute==="cname"),m=_.length>0&&_[0].ssrc;let g;const S=e.matchPrefix(i,"a=ssrc-group:FID").map(I=>I.substring(17).split(" ").map(b=>parseInt(b,10)));S.length>0&&S[0].length>1&&S[0][0]===m&&(g=S[0][1]),c.codecs.forEach(I=>{if(I.name.toUpperCase()==="RTX"&&I.parameters.apt){let b={ssrc:m,codecPayloadType:parseInt(I.parameters.apt,10)};m&&g&&(b.rtx={ssrc:g}),o.push(b),u&&(b=JSON.parse(JSON.stringify(b)),b.fec={ssrc:m,mechanism:h?"red+ulpfec":"red"},o.push(b))}}),o.length===0&&m&&o.push({ssrc:m});let C=e.matchPrefix(i,"b=");return C.length&&(C=C[0].indexOf("b=TIAS:")===0?parseInt(C[0].substring(7),10):C[0].indexOf("b=AS:")===0?1e3*parseInt(C[0].substring(5),10)*.95-16e3:void 0,o.forEach(I=>{I.maxBitrate=C})),o},e.parseRtcpParameters=function(i){const o={},c=e.matchPrefix(i,"a=ssrc:").map(_=>e.parseSsrcMedia(_)).filter(_=>_.attribute==="cname")[0];c&&(o.cname=c.value,o.ssrc=c.ssrc);const u=e.matchPrefix(i,"a=rtcp-rsize");o.reducedSize=u.length>0,o.compound=u.length===0;const h=e.matchPrefix(i,"a=rtcp-mux");return o.mux=h.length>0,o},e.writeRtcpParameters=function(i){let o="";return i.reducedSize&&(o+=`a=rtcp-rsize\r
`),i.mux&&(o+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(o+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),o},e.parseMsid=function(i){let o;const c=e.matchPrefix(i,"a=msid:");if(c.length===1)return o=c[0].substring(7).split(" "),{stream:o[0],track:o[1]};const u=e.matchPrefix(i,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="msid");return u.length>0?(o=u[0].value.split(" "),{stream:o[0],track:o[1]}):void 0},e.parseSctpDescription=function(i){const o=e.parseMLine(i),c=e.matchPrefix(i,"a=max-message-size:");let u;c.length>0&&(u=parseInt(c[0].substring(19),10)),isNaN(u)&&(u=65536);const h=e.matchPrefix(i,"a=sctp-port:");if(h.length>0)return{port:parseInt(h[0].substring(12),10),protocol:o.fmt,maxMessageSize:u};const _=e.matchPrefix(i,"a=sctpmap:");if(_.length>0){const m=_[0].substring(10).split(" ");return{port:parseInt(m[0],10),protocol:m[1],maxMessageSize:u}}},e.writeSctpDescription=function(i,o){let c=[];return c=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+o.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+o.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+o.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+o.port+" "+o.protocol+` 65535\r
`],o.maxMessageSize!==void 0&&c.push("a=max-message-size:"+o.maxMessageSize+`\r
`),c.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(i,o,c){let u;const h=o!==void 0?o:2;return u=i||e.generateSessionId(),`v=0\r
o=`+(c||"thisisadapterortc")+" "+u+" "+h+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(i,o){const c=e.splitLines(i);for(let u=0;u<c.length;u++)switch(c[u]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[u].substring(2)}return o?e.getDirection(o):"sendrecv"},e.getKind=function(i){return e.splitLines(i)[0].split(" ")[0].substring(2)},e.isRejected=function(i){return i.split(" ",2)[1]==="0"},e.parseMLine=function(i){const o=e.splitLines(i)[0].substring(2).split(" ");return{kind:o[0],port:parseInt(o[1],10),protocol:o[2],fmt:o.slice(3).join(" ")}},e.parseOLine=function(i){const o=e.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:o[0],sessionId:o[1],sessionVersion:parseInt(o[2],10),netType:o[3],addressType:o[4],address:o[5]}},e.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;const o=e.splitLines(i);for(let c=0;c<o.length;c++)if(o[c].length<2||o[c].charAt(1)!=="=")return!1;return!0},s.exports=e})(SN);var RN=SN.exports,zp=Rt(RN),nx=ct({__proto__:null,default:zp},[RN]);function oT(s){if(!s.RTCIceCandidate||s.RTCIceCandidate&&"foundation"in s.RTCIceCandidate.prototype)return;const e=s.RTCIceCandidate;s.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const o=new e(i),c=zp.parseCandidate(i.candidate),u=Object.assign(o,c);return u.toJSON=function(){return{candidate:u.candidate,sdpMid:u.sdpMid,sdpMLineIndex:u.sdpMLineIndex,usernameFragment:u.usernameFragment}},u}return new e(i)},s.RTCIceCandidate.prototype=e.prototype,Mt(s,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new s.RTCIceCandidate(i.candidate),writable:"false"}),i))}function Kv(s){!s.RTCIceCandidate||s.RTCIceCandidate&&"relayProtocol"in s.RTCIceCandidate.prototype||Mt(s,"icecandidate",e=>{if(e.candidate){const i=zp.parseCandidate(e.candidate.candidate);i.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return e})}function aT(s,e){if(!s.RTCPeerConnection)return;"sctp"in s.RTCPeerConnection.prototype||Object.defineProperty(s.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const i=function(_){if(!_||!_.sdp)return!1;const m=zp.splitSections(_.sdp);return m.shift(),m.some(g=>{const S=zp.parseMLine(g);return S&&S.kind==="application"&&S.protocol.indexOf("SCTP")!==-1})},o=function(_){const m=_.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(m===null||m.length<2)return-1;const g=parseInt(m[1],10);return g!=g?-1:g},c=function(_){let m=65536;return e.browser==="firefox"&&(m=e.version<57?_===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),m},u=function(_,m){let g=65536;e.browser==="firefox"&&e.version===57&&(g=65535);const S=zp.matchPrefix(_.sdp,"a=max-message-size:");return S.length>0?g=parseInt(S[0].substr(19),10):e.browser==="firefox"&&m!==-1&&(g=2147483637),g},h=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:_}=this.getConfiguration();_==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const _=o(arguments[0]),m=c(_),g=u(arguments[0],_);let S;S=m===0&&g===0?Number.POSITIVE_INFINITY:m===0||g===0?Math.max(m,g):Math.min(m,g);const C={};Object.defineProperty(C,"maxMessageSize",{get:()=>S}),this._sctp=C}return h.apply(this,arguments)}}function cT(s){if(!s.RTCPeerConnection||!("createDataChannel"in s.RTCPeerConnection.prototype))return;function e(o,c){const u=o.send;o.send=function(){const h=arguments[0],_=h.length||h.size||h.byteLength;if(o.readyState==="open"&&c.sctp&&_>c.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+c.sctp.maxMessageSize+" bytes)");return u.apply(o,arguments)}}const i=s.RTCPeerConnection.prototype.createDataChannel;s.RTCPeerConnection.prototype.createDataChannel=function(){const o=i.apply(this,arguments);return e(o,this),o},Mt(s,"datachannel",o=>(e(o.channel,o.target),o))}function Yv(s){if(!s.RTCPeerConnection||"connectionState"in s.RTCPeerConnection.prototype)return;const e=s.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{const o=e[i];e[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=c=>{const u=c.target;if(u._lastConnectionState!==u.connectionState){u._lastConnectionState=u.connectionState;const h=new Event("connectionstatechange",c);u.dispatchEvent(h)}return c},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),o.apply(this,arguments)}})}function Jp(s,e){if(!s.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const i=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(o){if(o&&o.sdp&&o.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const c=o.sdp.split(`
`).filter(u=>u.trim()!=="a=extmap-allow-mixed").join(`
`);s.RTCSessionDescription&&o instanceof s.RTCSessionDescription?arguments[0]=new s.RTCSessionDescription({type:o.type,sdp:c}):o.sdp=c}return i.apply(this,arguments)}}function Ch(s,e){if(!s.RTCPeerConnection||!s.RTCPeerConnection.prototype)return;const i=s.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(s.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Xp(s,e){if(!s.RTCPeerConnection||!s.RTCPeerConnection.prototype)return;const i=s.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(s.RTCPeerConnection.prototype.setLocalDescription=function(){let o=arguments[0]||{};if(typeof o!="object"||o.type&&o.sdp)return i.apply(this,arguments);if(o={type:o.type,sdp:o.sdp},!o.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":o.type="offer";break;default:o.type="answer"}return o.sdp||o.type!=="offer"&&o.type!=="answer"?i.apply(this,[o]):(o.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(c=>i.apply(this,[c]))})}var ix=Object.freeze({__proto__:null,removeExtmapAllowMixed:Jp,shimAddIceCandidateNullOrEmpty:Ch,shimConnectionState:Yv,shimMaxMessageSize:aT,shimParameterlessSetLocalDescription:Xp,shimRTCIceCandidate:oT,shimRTCIceCandidateRelayProtocol:Kv,shimSendThrowTypeError:cT});(function({window:s}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const i=iN,o=function(u){const h={browser:null,version:null};if(u===void 0||!u.navigator)return h.browser="Not a browser.",h;const{navigator:_}=u;if(_.mozGetUserMedia)h.browser="firefox",h.version=tT(_.userAgent,/Firefox\/(\d+)\./,1);else if(_.webkitGetUserMedia||u.isSecureContext===!1&&u.webkitRTCPeerConnection)h.browser="chrome",h.version=tT(_.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!u.RTCPeerConnection||!_.userAgent.match(/AppleWebKit\/(\d+)\./))return h.browser="Not a supported browser.",h;h.browser="safari",h.version=tT(_.userAgent,/AppleWebKit\/(\d+)\./,1),h.supportsUnifiedPlan=u.RTCRtpTransceiver&&"currentDirection"in u.RTCRtpTransceiver.prototype}return h}(s),c={browserDetails:o,commonShim:ix,extractVersion:tT,disableLog:tx,disableWarnings:ex,sdp:nx};switch(o.browser){case"chrome":if(!xv||!ka||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),c;if(o.version===null)return i("Chrome shim can not determine version, not shimming."),c;i("adapter.js shimming chrome."),c.browserShim=xv,Ch(s,o),Xp(s),Rh(s,o),aN(s),ka(s,o),cN(s),Mv(s,o),dN(s),uN(s),eT(s),Uv(s,o),oT(s),Kv(s),Yv(s),aT(s,o),cT(s),Jp(s,o);break;case"firefox":if(!Wv||!Vv||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),c;i("adapter.js shimming firefox."),c.browserShim=Wv,Ch(s,o),Xp(s),am(s,o),Vv(s,o),dl(s),nT(s),hN(s),Fv(s),Bv(s),jv(s),iT(s),Gv(s),pN(s),oT(s),Yv(s),aT(s,o),cT(s);break;case"safari":if(!sT||!e.shimSafari)return i("Safari shim is not included in this adapter release."),c;i("adapter.js shimming safari."),c.browserShim=sT,Ch(s,o),Xp(s),gN(s),rT(s),EN(s),cm(s),_N(s),Hv(s),mN(s),TN(s),oT(s),Kv(s),aT(s,o),cT(s),Jp(s,o);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var CN={exports:{}},rx=Ce,vN=wr,qv=_s.f;rx({target:"Object",stat:!0,forced:Object.defineProperty!==qv,sham:!vN},{defineProperty:qv});var dT=$r.Object,sx=CN.exports=function(s,e,i){return dT.defineProperty(s,e,i)};dT.defineProperty.sham&&(sx.sham=!0);var ox=Rt(CN.exports),dm=Zi,zv=Array.isArray||function(s){return dm(s)=="Array"},ax=TypeError,cx=gh,dx=_s,ux=No,Jv=function(s,e,i){var o=cx(e);o in s?dx.f(s,o,ux(0,i)):s[o]=i},IN=wn,Xv=QE,lx=Qt(Function.toString);IN(Xv.inspectSource)||(Xv.inspectSource=function(s){return lx(s)});var yN=Xv.inspectSource,Qv=Qt,hx=Nt,AN=wn,uT=cl,px=yN,bN=function(){},_x=[],wN=qi("Reflect","construct"),Zv=/^\s*(?:class|function)\b/,Ex=Qv(Zv.exec),lT=!Zv.exec(bN),Qp=function(s){if(!AN(s))return!1;try{return wN(bN,_x,s),!0}catch{return!1}},ON=function(s){if(!AN(s))return!1;switch(uT(s)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return lT||!!Ex(Zv,px(s))}catch{return!0}};ON.sham=!0;var $v=!wN||hx(function(){var s;return Qp(Qp.call)||!Qp(Object)||!Qp(function(){s=!0})||s})?ON:Qp,tI=zv,mx=$v,fx=fr,gx=ze("species"),hT=Array,eI=function(s){var e;return tI(s)&&(e=s.constructor,(mx(e)&&(e===hT||tI(e.prototype))||fx(e)&&(e=e[gx])===null)&&(e=void 0)),e===void 0?hT:e},nI=function(s,e){return new(eI(s))(e===0?0:e)},iI=Nt,NN=Pa,DN=ze("species"),pT=Ce,um=Nt,Tx=zv,Sx=fr,PN=Ns,Rx=Cu,LN=function(s){if(s>9007199254740991)throw ax("Maximum allowed index exceeded");return s},rI=Jv,Cx=nI,vx=function(s){return NN>=51||!iI(function(){var e=[];return(e.constructor={})[DN]=function(){return{foo:1}},e[s](Boolean).foo!==1})},Ix=Pa,kN=ze("isConcatSpreadable"),yx=Ix>=51||!um(function(){var s=[];return s[kN]=!1,s.concat()[0]!==s}),Ax=function(s){if(!Sx(s))return!1;var e=s[kN];return e!==void 0?!!e:Tx(s)};pT({target:"Array",proto:!0,forced:!yx||!vx("concat")},{concat:function(s){var e,i,o,c,u,h=PN(this),_=Cx(h,0),m=0;for(e=-1,o=arguments.length;e<o;e++)if(Ax(u=e===-1?h:arguments[e]))for(c=Rx(u),LN(m+c),i=0;i<c;i++,m++)i in u&&rI(_,m,u[i]);else LN(m+1),rI(_,m++,u);return _.length=m,_}});var _T={},Ud={},sI=Zn,bx=$o,wx=wv.indexOf,MN=Ud,UN=Qt([].push),oI=function(s,e){var i,o=bx(s),c=0,u=[];for(i in o)!sI(MN,i)&&sI(o,i)&&UN(u,i);for(;e.length>c;)sI(o,i=e[c++])&&(~wx(u,i)||UN(u,i));return u},aI=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Ox=oI,Nx=aI,vh=Object.keys||function(s){return Ox(s,Nx)},Dx=wr,Px=Cv,Lx=_s,kx=$i,Mx=$o,Ux=vh;_T.f=Dx&&!Px?Object.defineProperties:function(s,e){kx(s);for(var i,o=Mx(e),c=Ux(e),u=c.length,h=0;u>h;)Lx.f(s,i=c[h++],o[i]);return s};var Zp,xN=qi("document","documentElement"),VN=ZE,FN=qc("keys"),lm=function(s){return FN[s]||(FN[s]=VN(s))},xx=$i,Vx=_T,BN=aI,Fx=Ud,Bx=xN,jx=em,ET="prototype",cI="script",jN=lm("IE_PROTO"),mT=function(){},GN=function(s){return"<"+cI+">"+s+"</"+cI+">"},hm=function(s){s.write(GN("")),s.close();var e=s.parentWindow.Object;return s=null,e},pm=function(){try{Zp=new ActiveXObject("htmlfile")}catch{}var s,e,i;pm=typeof document<"u"?document.domain&&Zp?hm(Zp):(e=jx("iframe"),i="java"+cI+":",e.style.display="none",Bx.appendChild(e),e.src=String(i),(s=e.contentWindow.document).open(),s.write(GN("document.F=Object")),s.close(),s.F):hm(Zp);for(var o=BN.length;o--;)delete pm[ET][BN[o]];return pm()};Fx[jN]=!0;var Iu=Object.create||function(s,e){var i;return s!==null?(mT[ET]=xx(s),i=new mT,mT[ET]=null,i[jN]=s):i=pm(),e===void 0?i:Vx.f(i,e)},fT={},Gx=oI,Wx=aI.concat("length","prototype");fT.f=Object.getOwnPropertyNames||function(s){return Gx(s,Wx)};var WN={},_m=XO,Hx=Cu,HN=Jv,dI=Array,uI=Math.max,lI=function(s,e,i){for(var o=Hx(s),c=_m(e,o),u=_m(i===void 0?o:i,o),h=dI(uI(u-c,0)),_=0;c<u;c++,_++)HN(h,_,s[c]);return h.length=_,h},Kx=Zi,Yx=$o,KN=fT.f,qx=lI,Em=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];WN.f=function(s){return Em&&Kx(s)=="Window"?function(e){try{return KN(e)}catch{return qx(Em)}}(s):KN(Yx(s))};var mm={};mm.f=Object.getOwnPropertySymbols;var $p=Po,xd=function(s,e,i,o){return o&&o.enumerable?s[e]=i:$p(s,e,i),s},gT=_s,ul=function(s,e,i){return gT.f(s,e,i)},yu={},zx=ze;yu.f=zx;var fm,gm,Tm,YN=$r,Jx=Zn,hI=yu,pI=_s.f,ts=function(s){var e=YN.Symbol||(YN.Symbol={});Jx(e,s)||pI(e,s,{value:hI.f(s)})},Xx=Wn,qN=qi,_I=ze,Qx=xd,Qc=function(){var s=qN("Symbol"),e=s&&s.prototype,i=e&&e.valueOf,o=_I("toPrimitive");e&&!e[o]&&Qx(e,o,function(c){return Xx(i,this)},{})},t_=cl,Ih=Dv?{}.toString:function(){return"[object "+t_(this)+"]"},zN=Dv,JN=_s.f,yh=Po,EI=Zn,Zx=Ih,mI=ze("toStringTag"),ll=function(s,e,i,o){if(s){var c=i?s:s.prototype;EI(c,mI)||JN(c,mI,{configurable:!0,value:e}),o&&!zN&&yh(c,"toString",Zx)}},XN=wn,fI=Te.WeakMap,$x=XN(fI)&&/native code/.test(String(fI)),Au=Te,tV=fr,eV=Po,gI=Zn,TI=QE,QN=lm,nV=Ud,TT="Object already initialized",ST=Au.TypeError,iV=Au.WeakMap;if($x||TI.state){var Zc=TI.state||(TI.state=new iV);Zc.get=Zc.get,Zc.has=Zc.has,Zc.set=Zc.set,fm=function(s,e){if(Zc.has(s))throw ST(TT);return e.facade=s,Zc.set(s,e),e},gm=function(s){return Zc.get(s)||{}},Tm=function(s){return Zc.has(s)}}else{var e_=QN("state");nV[e_]=!0,fm=function(s,e){if(gI(s,e_))throw ST(TT);return e.facade=s,eV(s,e_,e),e},gm=function(s){return gI(s,e_)?s[e_]:{}},Tm=function(s){return gI(s,e_)}}var n_={set:fm,get:gm,has:Tm,enforce:function(s){return Tm(s)?gm(s):fm(s,{})},getterFor:function(s){return function(e){var i;if(!tV(e)||(i=gm(e)).type!==s)throw ST("Incompatible receiver, "+s+" required");return i}}},rV=Do,sV=fh,oV=Ns,aV=Cu,cV=nI,SI=Qt([].push),hl=function(s){var e=s==1,i=s==2,o=s==3,c=s==4,u=s==6,h=s==7,_=s==5||u;return function(m,g,S,C){for(var I,b,x=oV(m),D=sV(x),M=rV(g,S),K=aV(D),z=0,nt=C||cV,dt=e?nt(m,K):i||h?nt(m,0):void 0;K>z;z++)if((_||z in D)&&(b=M(I=D[z],z,x),s))if(e)dt[z]=b;else if(b)switch(s){case 3:return!0;case 5:return I;case 6:return z;case 2:SI(dt,I)}else switch(s){case 4:return!1;case 7:SI(dt,I)}return u?-1:o||c?c:dt}},dV={forEach:hl(0)},RT=Ce,RI=Te,CI=Wn,uV=Qt,i_=wr,pl=Kc,lV=Nt,Gs=Zn,hV=le,vI=$i,CT=$o,II=gh,ZN=Es,vT=No,Sm=Iu,$N=vh,IT=fT,yT=WN,t0=mm,Rm=gu,yI=_s,pV=_T,AI=Eh,AT=xd,_V=ul,bT=qc,bI=Ud,e0=ZE,n0=ze,i0=yu,EV=ts,mV=Qc,fV=ll,Cm=n_,wT=dV.forEach,ea=lm("hidden"),OT="Symbol",r_="prototype",gV=Cm.set,r0=Cm.getterFor(OT),Ma=Object[r_],Ah=RI.Symbol,s_=Ah&&Ah[r_],TV=RI.TypeError,NT=RI.QObject,s0=Rm.f,bh=yI.f,wI=yT.f,SV=AI.f,o0=uV([].push),Vd=bT("symbols"),vm=bT("op-symbols"),a0=bT("wks"),Im=!NT||!NT[r_]||!NT[r_].findChild,OI=i_&&lV(function(){return Sm(bh({},"a",{get:function(){return bh(this,"a",{value:7}).a}})).a!=7})?function(s,e,i){var o=s0(Ma,e);o&&delete Ma[e],bh(s,e,i),o&&s!==Ma&&bh(Ma,e,o)}:bh,NI=function(s,e){var i=Vd[s]=Sm(s_);return gV(i,{type:OT,tag:s,description:e}),i_||(i.description=e),i},_l=function(s,e,i){s===Ma&&_l(vm,e,i),vI(s);var o=II(e);return vI(i),Gs(Vd,o)?(i.enumerable?(Gs(s,ea)&&s[ea][o]&&(s[ea][o]=!1),i=Sm(i,{enumerable:vT(0,!1)})):(Gs(s,ea)||bh(s,ea,vT(1,{})),s[ea][o]=!0),OI(s,o,i)):bh(s,o,i)},DT=function(s,e){vI(s);var i=CT(e),o=$N(i).concat(PT(i));return wT(o,function(c){i_&&!CI(o_,i,c)||_l(s,c,i[c])}),s},o_=function(s){var e=II(s),i=CI(SV,this,e);return!(this===Ma&&Gs(Vd,e)&&!Gs(vm,e))&&(!(i||!Gs(this,e)||!Gs(Vd,e)||Gs(this,ea)&&this[ea][e])||i)},wh=function(s,e){var i=CT(s),o=II(e);if(i!==Ma||!Gs(Vd,o)||Gs(vm,o)){var c=s0(i,o);return!c||!Gs(Vd,o)||Gs(i,ea)&&i[ea][o]||(c.enumerable=!0),c}},DI=function(s){var e=wI(CT(s)),i=[];return wT(e,function(o){Gs(Vd,o)||Gs(bI,o)||o0(i,o)}),i},PT=function(s){var e=s===Ma,i=wI(e?vm:CT(s)),o=[];return wT(i,function(c){!Gs(Vd,c)||e&&!Gs(Ma,c)||o0(o,Vd[c])}),o};pl||(Ah=function(){if(hV(s_,this))throw TV("Symbol is not a constructor");var s=arguments.length&&arguments[0]!==void 0?ZN(arguments[0]):void 0,e=e0(s),i=function(o){this===Ma&&CI(i,vm,o),Gs(this,ea)&&Gs(this[ea],e)&&(this[ea][e]=!1),OI(this,e,vT(1,o))};return i_&&Im&&OI(Ma,e,{configurable:!0,set:i}),NI(e,s)},AT(s_=Ah[r_],"toString",function(){return r0(this).tag}),AT(Ah,"withoutSetter",function(s){return NI(e0(s),s)}),AI.f=o_,yI.f=_l,pV.f=DT,Rm.f=wh,IT.f=yT.f=DI,t0.f=PT,i0.f=function(s){return NI(n0(s),s)},i_&&_V(s_,"description",{configurable:!0,get:function(){return r0(this).description}})),RT({global:!0,wrap:!0,forced:!pl,sham:!pl},{Symbol:Ah}),wT($N(a0),function(s){EV(s)}),RT({target:OT,stat:!0,forced:!pl},{useSetter:function(){Im=!0},useSimple:function(){Im=!1}}),RT({target:"Object",stat:!0,forced:!pl,sham:!i_},{create:function(s,e){return e===void 0?Sm(s):DT(Sm(s),e)},defineProperty:_l,defineProperties:DT,getOwnPropertyDescriptor:wh}),RT({target:"Object",stat:!0,forced:!pl},{getOwnPropertyNames:DI}),mV(),fV(Ah,OT),bI[ea]=!0;var ym=Kc&&!!Symbol.for&&!!Symbol.keyFor,RV=Ce,CV=qi,vV=Zn,c0=Es,d0=qc,IV=ym,PI=d0("string-to-symbol-registry"),LI=d0("symbol-to-string-registry");RV({target:"Symbol",stat:!0,forced:!IV},{for:function(s){var e=c0(s);if(vV(PI,e))return PI[e];var i=CV("Symbol")(e);return PI[e]=i,LI[i]=e,i}});var LT=Ce,yV=Zn,a_=Su,u0=Yc,Ua=ym,l0=qc("symbol-to-string-registry");LT({target:"Symbol",stat:!0,forced:!Ua},{keyFor:function(s){if(!a_(s))throw TypeError(u0(s)+" is not a symbol");if(yV(l0,s))return l0[s]}});var h0=Qt([].slice),kI=zv,AV=wn,MI=Zi,p0=Es,_0=Qt([].push),E0=Ce,m0=qi,f0=mi,bV=Wn,Oh=Qt,kT=Nt,g0=wn,MT=Su,T0=h0,S0=function(s){if(AV(s))return s;if(kI(s)){for(var e=s.length,i=[],o=0;o<e;o++){var c=s[o];typeof c=="string"?_0(i,c):typeof c!="number"&&MI(c)!="Number"&&MI(c)!="String"||_0(i,p0(c))}var u=i.length,h=!0;return function(_,m){if(h)return h=!1,m;if(kI(this))return m;for(var g=0;g<u;g++)if(i[g]===_)return m}}},wV=Kc,UI=String,gc=m0("JSON","stringify"),Am=Oh(/./.exec),UT=Oh("".charAt),xI=Oh("".charCodeAt),R0=Oh("".replace),C0=Oh(1 .toString),xT=/[\uD800-\uDFFF]/g,VI=/^[\uD800-\uDBFF]$/,Nh=/^[\uDC00-\uDFFF]$/,VT=!wV||kT(function(){var s=m0("Symbol")();return gc([s])!="[null]"||gc({a:s})!="{}"||gc(Object(s))!="{}"}),FT=kT(function(){return gc("\uDF06\uD834")!=='"\\udf06\\ud834"'||gc("\uDEAD")!=='"\\udead"'}),FI=function(s,e){var i=T0(arguments),o=S0(e);if(g0(o)||s!==void 0&&!MT(s))return i[1]=function(c,u){if(g0(o)&&(u=bV(o,this,UI(c),u)),!MT(u))return u},f0(gc,null,i)},v0=function(s,e,i){var o=UT(i,e-1),c=UT(i,e+1);return Am(VI,s)&&!Am(Nh,c)||Am(Nh,s)&&!Am(VI,o)?"\\u"+C0(xI(s,0),16):s};gc&&E0({target:"JSON",stat:!0,forced:VT||FT},{stringify:function(s,e,i){var o=T0(arguments),c=f0(VT?FI:gc,null,o);return FT&&typeof c=="string"?R0(c,xT,v0):c}});var BI=mm,OV=Ns;Ce({target:"Object",stat:!0,forced:!Kc||Nt(function(){BI.f(1)})},{getOwnPropertySymbols:function(s){var e=BI.f;return e?e(OV(s)):[]}}),ts("asyncIterator"),ts("hasInstance"),ts("isConcatSpreadable"),ts("iterator"),ts("match"),ts("matchAll"),ts("replace"),ts("search"),ts("species"),ts("split");var NV=Qc;ts("toPrimitive"),NV();var Dh=qi,I0=ll;ts("toStringTag"),I0(Dh("Symbol"),"Symbol"),ts("unscopables"),ll(Te.JSON,"JSON",!0);var Ph,BT,y0,DV=$r.Symbol,c_={},jI=wr,GI=Zn,WI=Function.prototype,A0=jI&&Object.getOwnPropertyDescriptor,HI=GI(WI,"name"),bm={PROPER:HI&&(function(){}).name==="something",CONFIGURABLE:HI&&(!jI||jI&&A0(WI,"name").configurable)},b0=!Nt(function(){function s(){}return s.prototype.constructor=null,Object.getPrototypeOf(new s)!==s.prototype}),KI=Zn,jT=wn,GT=Ns,w0=b0,Lh=lm("IE_PROTO"),kh=Object,O0=kh.prototype,YI=w0?kh.getPrototypeOf:function(s){var e=GT(s);if(KI(e,Lh))return e[Lh];var i=e.constructor;return jT(i)&&e instanceof i?i.prototype:e instanceof kh?O0:null},PV=Nt,wm=wn,LV=fr,kV=Iu,N0=YI,MV=xd,qI=ze("iterator"),D0=!1;[].keys&&("next"in(y0=[].keys())?(BT=N0(N0(y0)))!==Object.prototype&&(Ph=BT):D0=!0);var zI=!LV(Ph)||PV(function(){var s={};return Ph[qI].call(s)!==s});wm((Ph=zI?{}:kV(Ph))[qI])||MV(Ph,qI,function(){return this});var JI={IteratorPrototype:Ph,BUGGY_SAFARI_ITERATORS:D0},UV=JI.IteratorPrototype,P0=Iu,xV=No,Om=ll,Fd=c_,L0=function(){return this},k0=function(s,e,i,o){var c=e+" Iterator";return s.prototype=P0(UV,{next:xV(+!o,i)}),Om(s,c,!1,!0),Fd[c]=L0,s},VV=Qt,XI=kr,M0=wn,FV=String,WT=TypeError,El=function(s,e,i){try{return VV(XI(Object.getOwnPropertyDescriptor(s,e)[i]))}catch{}},Nm=$i,BV=function(s){if(typeof s=="object"||M0(s))return s;throw WT("Can't set "+FV(s)+" as a prototype")},jV=Object.setPrototypeOf||("__proto__"in{}?function(){var s,e=!1,i={};try{(s=El(Object.prototype,"__proto__","set"))(i,[]),e=i instanceof Array}catch{}return function(o,c){return Nm(o),BV(c),e?s(o,c):o.__proto__=c,o}}():void 0),GV=Ce,WV=Wn,QI=bm,HV=k0,KV=YI,YV=ll,ZI=xd,HT=c_,qV=JI,zV=QI.PROPER,KT=qV.BUGGY_SAFARI_ITERATORS,YT=ze("iterator"),qT="keys",Dm="values",$I="entries",zT=function(){return this},ty=function(s,e,i,o,c,u,h){HV(i,e,o);var _,m,g,S=function(K){if(K===c&&D)return D;if(!KT&&K in b)return b[K];switch(K){case qT:case Dm:case $I:return function(){return new i(this,K)}}return function(){return new i(this)}},C=e+" Iterator",I=!1,b=s.prototype,x=b[YT]||b["@@iterator"]||c&&b[c],D=!KT&&x||S(c),M=e=="Array"&&b.entries||x;if(M&&(_=KV(M.call(new s)))!==Object.prototype&&_.next&&(YV(_,C,!0,!0),HT[C]=zT),zV&&c==Dm&&x&&x.name!==Dm&&(I=!0,D=function(){return WV(x,this)}),c)if(m={values:S(Dm),keys:u?D:S(qT),entries:S($I)},h)for(g in m)(KT||I||!(g in b))&&ZI(b,g,m[g]);else GV({target:e,proto:!0,forced:KT||I},m);return h&&b[YT]!==D&&ZI(b,YT,D,{}),HT[e]=D,m},U0=function(s,e){return{value:s,done:e}},ey=$o,x0=c_,V0=n_,Pm=ty,JT=U0,ny="Array Iterator",iy=V0.set,ry=V0.getterFor(ny);Pm(Array,"Array",function(s,e){iy(this,{type:ny,target:ey(s),index:0,kind:e})},function(){var s=ry(this),e=s.target,i=s.kind,o=s.index++;return!e||o>=e.length?(s.target=void 0,JT(void 0,!0)):JT(i=="keys"?o:i=="values"?e[o]:[o,e[o]],!1)},"values"),x0.Arguments=x0.Array;var sy={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},JV=Te,XV=cl,F0=Po,oy=c_,ay=ze("toStringTag");for(var XT in sy){var cy=JV[XT],dy=cy&&cy.prototype;dy&&XV(dy)!==ay&&F0(dy,ay,XT),oy[XT]=oy.Array}var B0=DV,QV=ze,d_=_s.f,Mh=QV("metadata"),QT=Function.prototype;QT[Mh]===void 0&&d_(QT,Mh,{value:null}),ts("dispose"),ts("metadata");var j0=B0;ts("asyncDispose");var G0=Qt,uy=qi("Symbol"),W0=uy.keyFor,ZV=G0(uy.prototype.valueOf),H0=uy.isRegisteredSymbol||function(s){try{return W0(ZV(s))!==void 0}catch{return!1}};Ce({target:"Symbol",stat:!0},{isRegisteredSymbol:H0});for(var ZT=qc,K0=qi,$V=Qt,tF=Su,eF=ze,$T=K0("Symbol"),Y0=$T.isWellKnownSymbol,q0=K0("Object","getOwnPropertyNames"),nF=$V($T.prototype.valueOf),z0=ZT("wks"),ly=0,J0=q0($T),iF=J0.length;ly<iF;ly++)try{var X0=J0[ly];tF($T[X0])&&eF(X0)}catch{}var Q0=function(s){if(Y0&&Y0(s))return!0;try{for(var e=nF(s),i=0,o=q0(z0),c=o.length;i<c;i++)if(z0[o[i]]==e)return!0}catch{}return!1};Ce({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Q0}),ts("matcher"),ts("observable"),Ce({target:"Symbol",stat:!0},{isRegistered:H0}),Ce({target:"Symbol",stat:!0,forced:!0},{isWellKnown:Q0}),ts("metadataKey"),ts("patternMatch"),ts("replaceAll");var u_=Rt(j0),hy=Qt,rF=yv,Z0=Es,sF=Md,oF=hy("".charAt),$0=hy("".charCodeAt),aF=hy("".slice),tD=function(s){return function(e,i){var o,c,u=Z0(sF(e)),h=rF(i),_=u.length;return h<0||h>=_?s?"":void 0:(o=$0(u,h))<55296||o>56319||h+1===_||(c=$0(u,h+1))<56320||c>57343?s?oF(u,h):o:s?aF(u,h,h+2):c-56320+(o-55296<<10)+65536}},eD={codeAt:tD(!1),charAt:tD(!0)},cF=eD.charAt,dF=Es,nD=n_,uF=ty,iD=U0,rD="String Iterator",lF=nD.set,hF=nD.getterFor(rD);uF(String,"String",function(s){lF(this,{type:rD,string:dF(s),index:0})},function(){var s,e=hF(this),i=e.string,o=e.index;return o>=i.length?iD(void 0,!0):(s=cF(i,o),e.index+=s.length,iD(s,!1))});var sD=Rt(yu.f("iterator"));function Lm(s){return Lm=typeof u_=="function"&&typeof sD=="symbol"?function(e){return typeof e}:function(e){return e&&typeof u_=="function"&&e.constructor===u_&&e!==u_.prototype?"symbol":typeof e},Lm(s)}var pF=Rt(yu.f("toPrimitive"));function oD(s){var e=function(i,o){if(Lm(i)!=="object"||i===null)return i;var c=i[pF];if(c!==void 0){var u=c.call(i,o);if(Lm(u)!=="object")return u;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(i)}(s,"string");return Lm(e)==="symbol"?e:String(e)}function A(s,e,i){return(e=oD(e))in s?ox(s,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):s[e]=i,s}var py=al("Array").keys,_F=cl,EF=Zn,mF=le,fF=py,tS=Array.prototype,gF={DOMTokenList:!0,NodeList:!0},lo=Rt(function(s){var e=s.keys;return s===tS||mF(tS,s)&&e===tS.keys||EF(gF,_F(s))?fF:e}),aD=Yc,TF=TypeError,cD=lI,SF=Math.floor,eS=function(s,e){var i=s.length,o=SF(i/2);return i<8?RF(s,e):dD(s,eS(cD(s,0,o),e),eS(cD(s,o),e),e)},RF=function(s,e){for(var i,o,c=s.length,u=1;u<c;){for(o=u,i=s[u];o&&e(s[o-1],i)>0;)s[o]=s[--o];o!==u++&&(s[o]=i)}return s},dD=function(s,e,i,o){for(var c=e.length,u=i.length,h=0,_=0;h<c||_<u;)s[h+_]=h<c&&_<u?o(e[h],i[_])<=0?e[h++]:i[_++]:h<c?e[h++]:i[_++];return s},nS=eS,CF=Nt,_y=function(s,e){var i=[][s];return!!i&&CF(function(){i.call(null,e||function(){return 1},1)})},Ey=ta.match(/firefox\/(\d+)/i),vF=!!Ey&&+Ey[1],uD=/MSIE|Trident/.test(ta),my=ta.match(/AppleWebKit\/(\d+)\./),IF=!!my&&+my[1],yF=Ce,lD=Qt,AF=kr,bF=Ns,hD=Cu,wF=function(s,e){if(!delete s[e])throw TF("Cannot delete property "+aD(e)+" of "+aD(s))},fy=Es,iS=Nt,gy=nS,pD=_y,rS=vF,_D=uD,Bt=Pa,Ty=IF,bu=[],Sy=lD(bu.sort),ED=lD(bu.push),mD=iS(function(){bu.sort(void 0)}),fD=iS(function(){bu.sort(null)}),gD=pD("sort"),Ry=!iS(function(){if(Bt)return Bt<70;if(!(rS&&rS>3)){if(_D)return!0;if(Ty)return Ty<603;var s,e,i,o,c="";for(s=65;s<76;s++){switch(e=String.fromCharCode(s),s){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(o=0;o<47;o++)bu.push({k:e+o,v:i})}for(bu.sort(function(u,h){return h.v-u.v}),o=0;o<bu.length;o++)e=bu[o].k.charAt(0),c.charAt(c.length-1)!==e&&(c+=e);return c!=="DGBEFHACIJK"}});yF({target:"Array",proto:!0,forced:mD||!fD||!gD||!Ry},{sort:function(s){s!==void 0&&AF(s);var e=bF(this);if(Ry)return s===void 0?Sy(e):Sy(e,s);var i,o,c=[],u=hD(e);for(o=0;o<u;o++)o in e&&ED(c,e[o]);for(gy(c,function(h){return function(_,m){return m===void 0?-1:_===void 0?1:h!==void 0?+h(_,m)||0:fy(_)>fy(m)?1:-1}}(s)),i=hD(c),o=0;o<i;)e[o]=c[o++];for(;o<u;)wF(e,o++);return e}});var TD=al("Array").sort,Cy=le,SD=TD,sS=Array.prototype,l_=Rt(function(s){var e=s.sort;return s===sS||Cy(sS,s)&&e===sS.sort?SD:e}),RD=qi,vy=fT,CD=mm,vD=$i,ID=Qt([].concat),yD=RD("Reflect","ownKeys")||function(s){var e=vy.f(vD(s)),i=CD.f;return i?ID(e,i(s)):e},Iy=Zn,AD=yD,bD=gu,wD=_s,OD=fr,ND=Po,yy=Error,DD=Qt("".replace),PD=String(yy("zxcasd").stack),Ay=/\n\s*at [^:]*:[^\n]*/,LD=Ay.test(PD),kD=No,MD=!Nt(function(){var s=Error("a");return!("stack"in s)||(Object.defineProperty(s,"stack",kD(1,7)),s.stack!==7)}),UD=Po,xD=function(s,e){if(LD&&typeof s=="string"&&!yy.prepareStackTrace)for(;e--;)s=DD(s,Ay,"");return s},VD=MD,FD=Error.captureStackTrace,OF=c_,by=ze("iterator"),BD=Array.prototype,jD=function(s){return s!==void 0&&(OF.Array===s||BD[by]===s)},NF=cl,GD=Yp,DF=Tu,PF=c_,LF=ze("iterator"),km=function(s){if(!DF(s))return GD(s,LF)||GD(s,"@@iterator")||PF[NF(s)]},kF=Wn,MF=kr,UF=$i,xF=Yc,wy=km,VF=TypeError,ms=function(s,e){var i=arguments.length<2?wy(s):e;if(MF(i))return UF(kF(i,s));throw VF(xF(s)+" is not iterable")},WD=Wn,Oy=$i,h_=Yp,HD=function(s,e,i){var o,c;Oy(s);try{if(!(o=h_(s,"return"))){if(e==="throw")throw i;return i}o=WD(o,s)}catch(u){c=!0,o=u}if(e==="throw")throw i;if(c)throw o;return Oy(o),i},oS=Do,Ny=Wn,aS=$i,cS=Yc,Dy=jD,Py=Cu,Mm=le,dS=ms,FF=km,KD=HD,BF=TypeError,uS=function(s,e){this.stopped=s,this.result=e},YD=uS.prototype,Um=function(s,e,i){var o,c,u,h,_,m,g,S=i&&i.that,C=!(!i||!i.AS_ENTRIES),I=!(!i||!i.IS_RECORD),b=!(!i||!i.IS_ITERATOR),x=!(!i||!i.INTERRUPTED),D=oS(e,S),M=function(z){return o&&KD(o,"normal",z),new uS(!0,z)},K=function(z){return C?(aS(z),x?D(z[0],z[1],M):D(z[0],z[1])):x?D(z,M):D(z)};if(I)o=s.iterator;else if(b)o=s;else{if(!(c=FF(s)))throw BF(cS(s)+" is not iterable");if(Dy(c)){for(u=0,h=Py(s);h>u;u++)if((_=K(s[u]))&&Mm(YD,_))return _;return new uS(!1)}o=dS(s,c)}for(m=I?s.next:o.next;!(g=Ny(m,o)).done;){try{_=K(g.value)}catch(z){KD(o,"throw",z)}if(typeof _=="object"&&_&&Mm(YD,_))return _}return new uS(!1)},Ly=Es,jF=Ce,GF=le,na=YI,xm=jV,WF=function(s,e,i){for(var o=AD(e),c=wD.f,u=bD.f,h=0;h<o.length;h++){var _=o[h];Iy(s,_)||i&&Iy(i,_)||c(s,_,u(e,_))}},qD=Iu,ky=Po,My=No,lS=function(s,e){OD(e)&&"cause"in e&&ND(s,"cause",e.cause)},zD=function(s,e,i,o){VD&&(FD?FD(s,e):UD(s,"stack",xD(i,o)))},HF=Um,KF=function(s,e){return s===void 0?arguments.length<2?"":e:Ly(s)},YF=ze("toStringTag"),hS=Error,Uy=[].push,Uh=function(s,e){var i,o=GF(xy,this);xm?i=xm(hS(),o?na(this):xy):(i=o?this:qD(xy),ky(i,YF,"Error")),e!==void 0&&ky(i,"message",KF(e)),zD(i,Uh,i.stack,1),arguments.length>2&&lS(i,arguments[2]);var c=[];return HF(s,Uy,{that:c}),ky(i,"errors",c),i};xm?xm(Uh,hS):WF(Uh,hS,{name:!0});var xy=Uh.prototype=qD(hS.prototype,{constructor:My(1,Uh),message:My(1,""),name:My(1,"AggregateError")});jF({global:!0},{AggregateError:Uh});var xh,p_,JD,pS,__=typeof process<"u"&&Zi(process)=="process",qF=qi,zF=ul,XD=wr,QD=ze("species"),JF=le,ZD=TypeError,Vy=function(s,e){if(JF(e,s))return s;throw ZD("Incorrect invocation")},XF=$v,$D=Yc,QF=TypeError,Fy=$i,By=function(s){if(XF(s))return s;throw QF($D(s)+" is not a constructor")},ZF=Tu,$F=ze("species"),jy=function(s,e){var i,o=Fy(s).constructor;return o===void 0||ZF(i=Fy(o)[$F])?e:By(i)},tB=TypeError,Vm=function(s,e){if(s<e)throw tB("Not enough arguments");return s},Gy=/(?:ipad|iphone|ipod).*applewebkit/i.test(ta),Is=Te,tP=mi,eB=Do,eP=wn,nB=Zn,nP=Nt,Wy=xN,iB=h0,iP=em,rB=Vm,Hy=Gy,sB=__,Vh=Is.setImmediate,_S=Is.clearImmediate,oB=Is.process,Ky=Is.Dispatch,aB=Is.Function,rP=Is.MessageChannel,cB=Is.String,Yy=0,Fm={},sP="onreadystatechange";nP(function(){xh=Is.location});var qy=function(s){if(nB(Fm,s)){var e=Fm[s];delete Fm[s],e()}},Bm=function(s){return function(){qy(s)}},zy=function(s){qy(s.data)},Jy=function(s){Is.postMessage(cB(s),xh.protocol+"//"+xh.host)};Vh&&_S||(Vh=function(s){rB(arguments.length,1);var e=eP(s)?s:aB(s),i=iB(arguments,1);return Fm[++Yy]=function(){tP(e,void 0,i)},p_(Yy),Yy},_S=function(s){delete Fm[s]},sB?p_=function(s){oB.nextTick(Bm(s))}:Ky&&Ky.now?p_=function(s){Ky.now(Bm(s))}:rP&&!Hy?(pS=(JD=new rP).port2,JD.port1.onmessage=zy,p_=eB(pS.postMessage,pS)):Is.addEventListener&&eP(Is.postMessage)&&!Is.importScripts&&xh&&xh.protocol!=="file:"&&!nP(Jy)?(p_=Jy,Is.addEventListener("message",zy,!1)):p_=sP in iP("script")?function(s){Wy.appendChild(iP("script"))[sP]=function(){Wy.removeChild(this),qy(s)}}:function(s){setTimeout(Bm(s),0)});var oP={set:Vh},Xy=function(){this.head=null,this.tail=null};Xy.prototype={add:function(s){var e={item:s,next:null},i=this.tail;i?i.next=e:this.head=e,this.tail=e},get:function(){var s=this.head;if(s)return(this.head=s.next)===null&&(this.tail=null),s.item}};var E_,Qy,Zy,$y,aP,cP=Xy,dB=/ipad|iphone|ipod/i.test(ta)&&typeof Pebble<"u",uB=/web0s(?!.*chrome)/i.test(ta),Fh=Te,tA=Do,dP=gu.f,eA=oP.set,uP=cP,lP=Gy,lB=dB,hB=uB,nA=__,hP=Fh.MutationObserver||Fh.WebKitMutationObserver,pP=Fh.document,_P=Fh.process,jm=Fh.Promise,iA=dP(Fh,"queueMicrotask"),rA=iA&&iA.value;if(!rA){var m_=new uP,Bh=function(){var s,e;for(nA&&(s=_P.domain)&&s.exit();e=m_.get();)try{e()}catch(i){throw m_.head&&E_(),i}s&&s.enter()};lP||nA||hB||!hP||!pP?!lB&&jm&&jm.resolve?(($y=jm.resolve(void 0)).constructor=jm,aP=tA($y.then,$y),E_=function(){aP(Bh)}):nA?E_=function(){_P.nextTick(Bh)}:(eA=tA(eA,Fh),E_=function(){eA(Bh)}):(Qy=!0,Zy=pP.createTextNode(""),new hP(Bh).observe(Zy,{characterData:!0}),E_=function(){Zy.data=Qy=!Qy}),rA=function(s){m_.head||E_(),m_.add(s)}}var sA=rA,ho=function(s){try{return{error:!1,value:s()}}catch(e){return{error:!0,value:e}}},ml=Te.Promise,jh=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",Gm=!jh&&!__&&typeof window=="object"&&typeof document=="object",EP=Te,Wm=ml,xa=wn,mP=Rv,ES=yN,mS=ze,pB=Gm,_B=jh,oA=Pa,fP=Wm&&Wm.prototype,EB=mS("species"),gP=xa(EP.PromiseRejectionEvent),mB=mP("Promise",function(){var s=ES(Wm),e=s!==String(Wm);if(!e&&oA===66||!fP.catch||!fP.finally)return!0;if(!oA||oA<51||!/native code/.test(s)){var i=new Wm(function(c){c(1)}),o=function(c){c(function(){},function(){})};if((i.constructor={})[EB]=o,!(i.then(function(){})instanceof o))return!0}return!e&&(pB||_B)&&!gP}),Hm={CONSTRUCTOR:mB,REJECTION_EVENT:gP},Bd={},f_=kr,TP=TypeError,Gh=function(s){var e,i;this.promise=new s(function(o,c){if(e!==void 0||i!==void 0)throw TP("Bad Promise constructor");e=o,i=c}),this.resolve=f_(e),this.reject=f_(i)};Bd.f=function(s){return new Gh(s)};var fS,SP,aA=Ce,gS=__,wu=Te,Km=Wn,RP=xd,cA=ll,CP=function(s){var e=qF(s);XD&&e&&!e[QD]&&zF(e,QD,{configurable:!0,get:function(){return this}})},vP=kr,dA=wn,IP=fr,yP=Vy,AP=jy,TS=oP.set,g_=sA,fB=function(s,e){try{arguments.length==1?console.error(s):console.error(s,e)}catch{}},Ut=ho,Pn=cP,uA=n_,SS=ml,RS=Hm,lA=Bd,Ym="Promise",bP=RS.CONSTRUCTOR,CS=RS.REJECTION_EVENT,vS=uA.getterFor(Ym),hA=uA.set,wP=SS&&SS.prototype,qm=SS,IS=wP,pA=wu.TypeError,yS=wu.document,AS=wu.process,_A=lA.f,gB=_A,OP=!!(yS&&yS.createEvent&&wu.dispatchEvent),EA="unhandledrejection",NP=function(s){var e;return!(!IP(s)||!dA(e=s.then))&&e},mA=function(s,e){var i,o,c,u=e.value,h=e.state==1,_=h?s.ok:s.fail,m=s.resolve,g=s.reject,S=s.domain;try{_?(h||(e.rejection===2&&SB(e),e.rejection=1),_===!0?i=u:(S&&S.enter(),i=_(u),S&&(S.exit(),c=!0)),i===s.promise?g(pA("Promise-chain cycle")):(o=NP(i))?Km(o,i,m,g):m(i)):g(u)}catch(C){S&&!c&&S.exit(),g(C)}},DP=function(s,e){s.notified||(s.notified=!0,g_(function(){for(var i,o=s.reactions;i=o.get();)mA(i,s);s.notified=!1,e&&!s.rejection&&TB(s)}))},T_=function(s,e,i){var o,c;OP?((o=yS.createEvent("Event")).promise=e,o.reason=i,o.initEvent(s,!1,!0),wu.dispatchEvent(o)):o={promise:e,reason:i},!CS&&(c=wu["on"+s])?c(o):s===EA&&fB("Unhandled promise rejection",i)},TB=function(s){Km(TS,wu,function(){var e,i=s.facade,o=s.value;if(fA(s)&&(e=Ut(function(){gS?AS.emit("unhandledRejection",o,i):T_(EA,i,o)}),s.rejection=gS||fA(s)?2:1,e.error))throw e.value})},fA=function(s){return s.rejection!==1&&!s.parent},SB=function(s){Km(TS,wu,function(){var e=s.facade;gS?AS.emit("rejectionHandled",e):T_("rejectionhandled",e,s.value)})},S_=function(s,e,i){return function(o){s(e,o,i)}},R_=function(s,e,i){s.done||(s.done=!0,i&&(s=i),s.value=e,s.state=2,DP(s,!0))},bS=function(s,e,i){if(!s.done){s.done=!0,i&&(s=i);try{if(s.facade===e)throw pA("Promise can't be resolved itself");var o=NP(e);o?g_(function(){var c={done:!1};try{Km(o,e,S_(bS,c,s),S_(R_,c,s))}catch(u){R_(c,u,s)}}):(s.value=e,s.state=1,DP(s,!1))}catch(c){R_({done:!1},c,s)}}};bP&&(IS=(qm=function(s){yP(this,IS),vP(s),Km(fS,this);var e=vS(this);try{s(S_(bS,e),S_(R_,e))}catch(i){R_(e,i)}}).prototype,(fS=function(s){hA(this,{type:Ym,done:!1,notified:!1,parent:!1,reactions:new Pn,rejection:!1,state:0,value:void 0})}).prototype=RP(IS,"then",function(s,e){var i=vS(this),o=_A(AP(this,qm));return i.parent=!0,o.ok=!dA(s)||s,o.fail=dA(e)&&e,o.domain=gS?AS.domain:void 0,i.state==0?i.reactions.add(o):g_(function(){mA(o,i)}),o.promise}),SP=function(){var s=new fS,e=vS(s);this.promise=s,this.resolve=S_(bS,e),this.reject=S_(R_,e)},lA.f=_A=function(s){return s===qm||s===void 0?new SP(s):gB(s)}),aA({global:!0,wrap:!0,forced:bP},{Promise:qm}),cA(qm,Ym,!1,!0),CP(Ym);var PP=ze("iterator"),gA=!1;try{var RB=0,LP={next:function(){return{done:!!RB++}},return:function(){gA=!0}};LP[PP]=function(){return this},Array.from(LP,function(){throw 2})}catch{}var CB=ml,kP=function(s,e){if(!gA)return!1;var i=!1;try{var o={};o[PP]=function(){return{next:function(){return{done:i=!0}}}},s(o)}catch{}return i},wS=Hm.CONSTRUCTOR||!kP(function(s){CB.all(s).then(void 0,function(){})}),vB=Wn,IB=kr,yB=Bd,AB=ho,bB=Um;Ce({target:"Promise",stat:!0,forced:wS},{all:function(s){var e=this,i=yB.f(e),o=i.resolve,c=i.reject,u=AB(function(){var h=IB(e.resolve),_=[],m=0,g=1;bB(s,function(S){var C=m++,I=!1;g++,vB(h,e,S).then(function(b){I||(I=!0,_[C]=b,--g||o(_))},c)}),--g||o(_)});return u.error&&c(u.value),i.promise}});var MP=Ce,UP=Hm.CONSTRUCTOR;MP({target:"Promise",proto:!0,forced:UP,real:!0},{catch:function(s){return this.then(void 0,s)}});var wB=Wn,OB=kr,NB=Bd,xP=ho,DB=Um;Ce({target:"Promise",stat:!0,forced:wS},{race:function(s){var e=this,i=NB.f(e),o=i.reject,c=xP(function(){var u=OB(e.resolve);DB(s,function(h){wB(u,e,h).then(i.resolve,o)})});return c.error&&o(c.value),i.promise}});var PB=Wn,VP=Bd;Ce({target:"Promise",stat:!0,forced:Hm.CONSTRUCTOR},{reject:function(s){var e=VP.f(this);return PB(e.reject,void 0,s),e.promise}});var LB=$i,kB=fr,FP=Bd,BP=function(s,e){if(LB(s),kB(e)&&e.constructor===s)return e;var i=FP.f(s);return(0,i.resolve)(e),i.promise},jP=Ce,C_=ml,MB=Hm.CONSTRUCTOR,GP=BP,UB=qi("Promise"),xB=!MB;jP({target:"Promise",stat:!0,forced:!0},{resolve:function(s){return GP(xB&&this===UB?C_:this,s)}});var VB=Wn,es=kr,FB=Bd,BB=ho,jB=Um;Ce({target:"Promise",stat:!0,forced:wS},{allSettled:function(s){var e=this,i=FB.f(e),o=i.resolve,c=i.reject,u=BB(function(){var h=es(e.resolve),_=[],m=0,g=1;jB(s,function(S){var C=m++,I=!1;g++,VB(h,e,S).then(function(b){I||(I=!0,_[C]={status:"fulfilled",value:b},--g||o(_))},function(b){I||(I=!0,_[C]={status:"rejected",reason:b},--g||o(_))})}),--g||o(_)});return u.error&&c(u.value),i.promise}});var GB=Wn,WP=kr,WB=qi,HB=Bd,KB=ho,YB=Um,HP="No one promise resolved";Ce({target:"Promise",stat:!0,forced:wS},{any:function(s){var e=this,i=WB("AggregateError"),o=HB.f(e),c=o.resolve,u=o.reject,h=KB(function(){var _=WP(e.resolve),m=[],g=0,S=1,C=!1;YB(s,function(I){var b=g++,x=!1;S++,GB(_,e,I).then(function(D){x||C||(C=!0,c(D))},function(D){x||C||(x=!0,m[b]=D,--S||u(new i(m,HP)))})}),--S||u(new i(m,HP))});return h.error&&u(h.value),o.promise}});var KP=Ce,TA=ml,YP=Nt,OS=qi,SA=wn,RA=jy,qP=BP,v_=TA&&TA.prototype;KP({target:"Promise",proto:!0,real:!0,forced:!!TA&&YP(function(){v_.finally.call({then:function(){}},function(){})})},{finally:function(s){var e=RA(this,OS("Promise")),i=SA(s);return this.then(i?function(o){return qP(e,s()).then(function(){return o})}:s,i?function(o){return qP(e,s()).then(function(){throw o})}:s)}});var Wh=$r.Promise,ut=Rt(Wh);const Ws=()=>{};function zm(){const s={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:Ws};return s.promise=new ut((e,i)=>{s.resolve=o=>{s.isFinished||(s.isResolved=!0,s.isFinished=!0,e(o),s.value=o)},s.reject=o=>{s.isFinished||(s.isRejected=!0,s.isFinished=!0,i(o))}}),s}const I_=new Map,Hh=new Map,Tc=new Map;var gr,un;(function(s){s.WIN_10="Windows 10",s.WIN_81="Windows 8.1",s.WIN_8="Windows 8",s.WIN_7="Windows 7",s.WIN_VISTA="Windows Vista",s.WIN_SERVER_2003="Windows Server 2003",s.WIN_XP="Windows XP",s.WIN_2000="Windows 2000",s.ANDROID="Android",s.HARMONY_OS="HarmonyOS",s.OPEN_BSD="Open BSD",s.SUN_OS="Sun OS",s.LINUX="Linux",s.IOS="iOS",s.MAC_OS="Mac OS",s.CHROMIUM_OS="Chromium OS",s.QNX="QNX",s.UNIX="UNIX",s.BEOS="BeOS",s.OS_2="OS/2",s.SEARCH_BOT="Search Bot"})(gr||(gr={})),function(s){s.CHROME="Chrome",s.SAFARI="Safari",s.EDGE="Edge",s.FIREFOX="Firefox",s.OPERA="OPR",s.QQ="QQBrowser",s.WECHAT="MicroMessenger"}(un||(un={}));var Kh={exports:{}};(function(s,e){(function(i,o){var c="function",u="undefined",h="object",_="string",m="major",g="model",S="name",C="type",I="vendor",b="version",x="architecture",D="console",M="mobile",K="tablet",z="smarttv",nt="wearable",dt="embedded",it="Amazon",at="Apple",ht="ASUS",pt="BlackBerry",bt="Browser",kt="Chrome",Ne="Firefox",Ge="Google",Qn="Huawei",Er="LG",jn="Microsoft",Xo="Motorola",St="Opera",Dt="Samsung",zt="Sharp",ye="Sony",an="Xiaomi",xt="Zebra",P="Facebook",q="Chromium OS",et="Mac OS",It=function(Yi){for(var sr={},zn=0;zn<Yi.length;zn++)sr[Yi[zn].toUpperCase()]=Yi[zn];return sr},oe=function(Yi,sr){return typeof Yi===_&&ii(sr).indexOf(ii(Yi))!==-1},ii=function(Yi){return Yi.toLowerCase()},rr=function(Yi,sr){if(typeof Yi===_)return Yi=Yi.replace(/^\s\s*/,""),typeof sr===u?Yi:Yi.substring(0,350)},Ao=function(Yi,sr){for(var zn,Qo,Nd,Pi,cn,bo,il=0;il<sr.length&&!cn;){var Wc=sr[il],CO=sr[il+1];for(zn=Qo=0;zn<Wc.length&&!cn&&Wc[zn];)if(cn=Wc[zn++].exec(Yi))for(Nd=0;Nd<CO.length;Nd++)bo=cn[++Qo],typeof(Pi=CO[Nd])===h&&Pi.length>0?Pi.length===2?typeof Pi[1]==c?this[Pi[0]]=Pi[1].call(this,bo):this[Pi[0]]=Pi[1]:Pi.length===3?typeof Pi[1]!==c||Pi[1].exec&&Pi[1].test?this[Pi[0]]=bo?bo.replace(Pi[1],Pi[2]):o:this[Pi[0]]=bo?Pi[1].call(this,bo,Pi[2]):o:Pi.length===4&&(this[Pi[0]]=bo?Pi[3].call(this,bo.replace(Pi[1],Pi[2])):o):this[Pi]=bo||o;il+=2}},uu=function(Yi,sr){for(var zn in sr)if(typeof sr[zn]===h&&sr[zn].length>0){for(var Qo=0;Qo<sr[zn].length;Qo++)if(oe(sr[zn][Qo],Yi))return zn==="?"?o:zn}else if(oe(sr[zn],Yi))return zn==="?"?o:zn;return Yi},jp={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},UC={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[b,[S,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[b,[S,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[S,b],[/opios[\/ ]+([\w\.]+)/i],[b,[S,St+" Mini"]],[/\bopr\/([\w\.]+)/i],[b,[S,St]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[S,b],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[b,[S,"UC"+bt]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[b,[S,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[b,[S,"WeChat"]],[/konqueror\/([\w\.]+)/i],[b,[S,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[b,[S,"IE"]],[/yabrowser\/([\w\.]+)/i],[b,[S,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[S,/(.+)/,"$1 Secure "+bt],b],[/\bfocus\/([\w\.]+)/i],[b,[S,Ne+" Focus"]],[/\bopt\/([\w\.]+)/i],[b,[S,St+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[b,[S,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[b,[S,"Dolphin"]],[/coast\/([\w\.]+)/i],[b,[S,St+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[b,[S,"MIUI "+bt]],[/fxios\/([-\w\.]+)/i],[b,[S,Ne]],[/\bqihu|(qi?ho?o?|360)browser/i],[[S,"360 "+bt]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[S,/(.+)/,"$1 "+bt],b],[/(comodo_dragon)\/([\w\.]+)/i],[[S,/_/g," "],b],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[S,b],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[S],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[S,P],b],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[S,b],[/\bgsa\/([\w\.]+) .*safari\//i],[b,[S,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[b,[S,kt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[S,kt+" WebView"],b],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[b,[S,"Android "+bt]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[S,b],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[b,[S,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[b,S],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[S,[b,uu,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[S,b],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[S,"Netscape"],b],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[b,[S,Ne+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[S,b],[/(cobalt)\/([\w\.]+)/i],[S,[b,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[x,"amd64"]],[/(ia32(?=;))/i],[[x,ii]],[/((?:i[346]|x)86)[;\)]/i],[[x,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[x,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[x,"armhf"]],[/windows (ce|mobile); ppc;/i],[[x,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[x,/ower/,"",ii]],[/(sun4\w)[;\)]/i],[[x,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[x,ii]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[g,[I,Dt],[C,K]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[g,[I,Dt],[C,M]],[/\((ip(?:hone|od)[\w ]*);/i],[g,[I,at],[C,M]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[g,[I,at],[C,K]],[/(macintosh);/i],[g,[I,at]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[g,[I,zt],[C,M]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[g,[I,Qn],[C,K]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[g,[I,Qn],[C,M]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[g,/_/g," "],[I,an],[C,M]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[g,/_/g," "],[I,an],[C,K]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[g,[I,"OPPO"],[C,M]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[g,[I,"Vivo"],[C,M]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[g,[I,"Realme"],[C,M]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[g,[I,Xo],[C,M]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[g,[I,Xo],[C,K]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[g,[I,Er],[C,K]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[g,[I,Er],[C,M]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[g,[I,"Lenovo"],[C,K]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[g,/_/g," "],[I,"Nokia"],[C,M]],[/(pixel c)\b/i],[g,[I,Ge],[C,K]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[g,[I,Ge],[C,M]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[g,[I,ye],[C,M]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[g,"Xperia Tablet"],[I,ye],[C,K]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[g,[I,"OnePlus"],[C,M]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[g,[I,it],[C,K]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[g,/(.+)/g,"Fire Phone $1"],[I,it],[C,M]],[/(playbook);[-\w\),; ]+(rim)/i],[g,I,[C,K]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[g,[I,pt],[C,M]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[g,[I,ht],[C,K]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[g,[I,ht],[C,M]],[/(nexus 9)/i],[g,[I,"HTC"],[C,K]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[I,[g,/_/g," "],[C,M]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[g,[I,"Acer"],[C,K]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[g,[I,"Meizu"],[C,M]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[I,g,[C,M]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[I,g,[C,K]],[/(surface duo)/i],[g,[I,jn],[C,K]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[g,[I,"Fairphone"],[C,M]],[/(u304aa)/i],[g,[I,"AT&T"],[C,M]],[/\bsie-(\w*)/i],[g,[I,"Siemens"],[C,M]],[/\b(rct\w+) b/i],[g,[I,"RCA"],[C,K]],[/\b(venue[\d ]{2,7}) b/i],[g,[I,"Dell"],[C,K]],[/\b(q(?:mv|ta)\w+) b/i],[g,[I,"Verizon"],[C,K]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[g,[I,"Barnes & Noble"],[C,K]],[/\b(tm\d{3}\w+) b/i],[g,[I,"NuVision"],[C,K]],[/\b(k88) b/i],[g,[I,"ZTE"],[C,K]],[/\b(nx\d{3}j) b/i],[g,[I,"ZTE"],[C,M]],[/\b(gen\d{3}) b.+49h/i],[g,[I,"Swiss"],[C,M]],[/\b(zur\d{3}) b/i],[g,[I,"Swiss"],[C,K]],[/\b((zeki)?tb.*\b) b/i],[g,[I,"Zeki"],[C,K]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[I,"Dragon Touch"],g,[C,K]],[/\b(ns-?\w{0,9}) b/i],[g,[I,"Insignia"],[C,K]],[/\b((nxa|next)-?\w{0,9}) b/i],[g,[I,"NextBook"],[C,K]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[I,"Voice"],g,[C,M]],[/\b(lvtel\-)?(v1[12]) b/i],[[I,"LvTel"],g,[C,M]],[/\b(ph-1) /i],[g,[I,"Essential"],[C,M]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[g,[I,"Envizen"],[C,K]],[/\b(trio[-\w\. ]+) b/i],[g,[I,"MachSpeed"],[C,K]],[/\btu_(1491) b/i],[g,[I,"Rotor"],[C,K]],[/(shield[\w ]+) b/i],[g,[I,"Nvidia"],[C,K]],[/(sprint) (\w+)/i],[I,g,[C,M]],[/(kin\.[onetw]{3})/i],[[g,/\./g," "],[I,jn],[C,M]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[g,[I,xt],[C,K]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[g,[I,xt],[C,M]],[/smart-tv.+(samsung)/i],[I,[C,z]],[/hbbtv.+maple;(\d+)/i],[[g,/^/,"SmartTV"],[I,Dt],[C,z]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[I,Er],[C,z]],[/(apple) ?tv/i],[I,[g,at+" TV"],[C,z]],[/crkey/i],[[g,kt+"cast"],[I,Ge],[C,z]],[/droid.+aft(\w)( bui|\))/i],[g,[I,it],[C,z]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[g,[I,zt],[C,z]],[/(bravia[\w ]+)( bui|\))/i],[g,[I,ye],[C,z]],[/(mitv-\w{5}) bui/i],[g,[I,an],[C,z]],[/Hbbtv.*(technisat) (.*);/i],[I,g,[C,z]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[I,rr],[g,rr],[C,z]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[C,z]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[I,g,[C,D]],[/droid.+; (shield) bui/i],[g,[I,"Nvidia"],[C,D]],[/(playstation [345portablevi]+)/i],[g,[I,ye],[C,D]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[g,[I,jn],[C,D]],[/((pebble))app/i],[I,g,[C,nt]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[g,[I,at],[C,nt]],[/droid.+; (glass) \d/i],[g,[I,Ge],[C,nt]],[/droid.+; (wt63?0{2,3})\)/i],[g,[I,xt],[C,nt]],[/(quest( 2| pro)?)/i],[g,[I,P],[C,nt]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[I,[C,dt]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[g,[C,M]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[g,[C,K]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[C,K]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[C,M]],[/(android[-\w\. ]{0,9});.+buil/i],[g,[I,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[b,[S,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[b,[S,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[S,b],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[b,S]],os:[[/microsoft (windows) (vista|xp)/i],[S,b],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[S,[b,uu,jp]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[S,"Windows"],[b,uu,jp]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[b,/_/g,"."],[S,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[S,et],[b,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[b,S],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[S,b],[/\(bb(10);/i],[b,[S,pt]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[b,[S,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[b,[S,Ne+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[b,[S,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[b,[S,"watchOS"]],[/crkey\/([\d\.]+)/i],[b,[S,kt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[S,q],b],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[S,b],[/(sunos) ?([\w\.\d]*)/i],[[S,"Solaris"],b],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[S,b]]},Ec=function(Yi,sr){if(typeof Yi===h&&(sr=Yi,Yi=o),!(this instanceof Ec))return new Ec(Yi,sr).getResult();var zn=typeof i!==u&&i.navigator?i.navigator:o,Qo=Yi||(zn&&zn.userAgent?zn.userAgent:""),Nd=zn&&zn.userAgentData?zn.userAgentData:o,Pi=sr?function(cn,bo){var il={};for(var Wc in cn)bo[Wc]&&bo[Wc].length%2==0?il[Wc]=bo[Wc].concat(cn[Wc]):il[Wc]=cn[Wc];return il}(UC,sr):UC;return this.getBrowser=function(){var cn={};return cn[S]=o,cn[b]=o,Ao.call(cn,Qo,Pi.browser),cn[m]=function(bo){return typeof bo===_?bo.replace(/[^\d\.]/g,"").split(".")[0]:o}(cn[b]),zn&&zn.brave&&typeof zn.brave.isBrave==c&&(cn[S]="Brave"),cn},this.getCPU=function(){var cn={};return cn[x]=o,Ao.call(cn,Qo,Pi.cpu),cn},this.getDevice=function(){var cn={};return cn[I]=o,cn[g]=o,cn[C]=o,Ao.call(cn,Qo,Pi.device),!cn[C]&&Nd&&Nd.mobile&&(cn[C]=M),cn[g]=="Macintosh"&&zn&&typeof zn.standalone!==u&&zn.maxTouchPoints&&zn.maxTouchPoints>2&&(cn[g]="iPad",cn[C]=K),cn},this.getEngine=function(){var cn={};return cn[S]=o,cn[b]=o,Ao.call(cn,Qo,Pi.engine),cn},this.getOS=function(){var cn={};return cn[S]=o,cn[b]=o,Ao.call(cn,Qo,Pi.os),!cn[S]&&Nd&&Nd.platform!="Unknown"&&(cn[S]=Nd.platform.replace(/chrome os/i,q).replace(/macos/i,et)),cn},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Qo},this.setUA=function(cn){return Qo=typeof cn===_&&cn.length>350?rr(cn,350):cn,this},this.setUA(Qo),this};Ec.VERSION="0.7.34",Ec.BROWSER=It([S,b,m]),Ec.CPU=It([x]),Ec.DEVICE=It([g,I,C,D,M,z,K,nt,dt]),Ec.ENGINE=Ec.OS=It([S,b]),s.exports&&(e=s.exports=Ec),e.UAParser=Ec;var nl=typeof i!==u&&(i.jQuery||i.Zepto);if(nl&&!nl.ua){var kE=new Ec;nl.ua=kE.getResult(),nl.ua.get=function(){return kE.getUA()},nl.ua.set=function(Yi){kE.setUA(Yi);var sr=kE.getResult();for(var zn in sr)nl.ua[zn]=sr[zn]}}})(typeof window=="object"?window:mt)})(Kh,Kh.exports);const CA=new(Rt(Kh.exports));let Ou=CA.getResult(),NS=null;function ln(s){if(!NS){Ou=CA.getResult();const e=function(u){if(u.engine.name==="Blink"&&u.browser.name!=="WeChat")return un.CHROME;switch(u.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return un.CHROME;case"Safari":case"Mobile Safari":return un.SAFARI;case"Edge":return un.EDGE;case"Firefox":return un.FIREFOX;case"QQBrowser":return un.QQ;case"Opera":return un.OPERA;case"WeChat":return un.WECHAT;default:return u.browser.name||""}}(Ou),i=function(u){let h;return h=u.engine.name==="Blink"?u.engine.version||"":u.browser.version||"",h.split(".")[0]}(Ou),o=function(u){return u.os.name==="Windows"?u.os.version?u.os.name+" "+u.os.version:u.os.name:u.os.name||""}(Ou),c=Ou.os.version;if(!(e&&i&&o&&c))return{name:e,version:i,os:o,osVersion:c};NS={name:e,version:i,os:o,osVersion:c}}return NS}function Jm(){return ln().os}function vA(){const s=ln();return"".concat(s.os," ").concat(s.osVersion)}function DS(){const s=ln();return!!(Ou.engine.name==="WebKit"&&s.os===gr.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&s.name!==un.SAFARI||ys()&&s.name!==un.SAFARI)}function zP(){const s=ln();if(DS()){if(s.os===gr.MAC_OS)return!0;if(s.os===gr.IOS){const e=Ou.os.version&&Ou.os.version.split(".");if(e&&Number(e[0])===14&&e[1]&&Number(e[1])>=3||e&&Number(e[0])>14)return!0}}return!1}function JP(){return Ou.engine.name==="WebKit"}function Nu(){return ln().name===un.CHROME}function Or(){return ln().name===un.SAFARI}function Ln(){return ln().name===un.FIREFOX}function ys(){return ln().os===gr.IOS}function IA(s){const e=ln();return!(e.name!==un.CHROME||!e.osVersion)&&Number(e.version)>=s}function XP(s){const e=ln();return!(e.name!==un.EDGE||!e.osVersion)&&Number(e.version)>=s}function QP(s){const e=ln();return!(e.name!==un.OPERA||!e.osVersion)&&Number(e.version)>=s}function ZP(){const s=ln();return!(s.name!==un.CHROME||!s.osVersion)&&Number(s.version)<=90}function $P(){const s=ln();if(s.os!==gr.IOS||!s.osVersion)return!1;const e=s.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Yh(){const s=ln();if(s.os!==gr.IOS||!s.osVersion)return!1;const e=s.osVersion.split(".");return Number(e[0])===15}function y_(){const s=ln();if(s.os!==gr.IOS||!s.osVersion)return!1;const e=s.osVersion.split(".");return Number(e[0])===16}function Lo(){const s=ln();if(s.os!==gr.IOS||!s.osVersion)return!1;const e=s.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Va(){return Or()&&navigator.maxTouchPoints>0}function A_(){return ln().name===un.WECHAT}function tL(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Du(){const s=ln();return s.name===un.EDGE||s.name===un.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function ia(){return Jm()===gr.ANDROID}function $c(){const s=ln();return ia()&&(s.name===un.CHROME||s.name===un.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var j;(function(s){s.UNEXPECTED_ERROR="UNEXPECTED_ERROR",s.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",s.TIMEOUT="TIMEOUT",s.INVALID_PARAMS="INVALID_PARAMS",s.NOT_READABLE="NOT_READABLE",s.NOT_SUPPORTED="NOT_SUPPORTED",s.INVALID_OPERATION="INVALID_OPERATION",s.OPERATION_ABORTED="OPERATION_ABORTED",s.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",s.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",s.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",s.DATACHANNEL_FAILED="DATACHANNEL_FAILED",s.NETWORK_ERROR="NETWORK_ERROR",s.NETWORK_TIMEOUT="NETWORK_TIMEOUT",s.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",s.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",s.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",s.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",s.ELECTRON_IS_NULL="ELECTRON_IS_NULL",s.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",s.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",s.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",s.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",s.PERMISSION_DENIED="PERMISSION_DENIED",s.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",s.TRACK_IS_DISABLED="TRACK_IS_DISABLED",s.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",s.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",s.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",s.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",s.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",s.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",s.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",s.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",s.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",s.UID_CONFLICT="UID_CONFLICT",s.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",s.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",s.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",s.INVALID_TRACK="INVALID_TRACK",s.SENDER_NOT_FOUND="SENDER_NOT_FOUND",s.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",s.SET_ANSWER_FAILED="SET_ANSWER_FAILED",s.ICE_FAILED="ICE_FAILED",s.PC_CLOSED="PC_CLOSED",s.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",s.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",s.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",s.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",s.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",s.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",s.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",s.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",s.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",s.INVALID_REMOTE_USER="INVALID_REMOTE_USER",s.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",s.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",s.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",s.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",s.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",s.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",s.WS_ABORT="WS_ABORT",s.WS_DISCONNECT="WS_DISCONNECT",s.WS_ERR="WS_ERR",s.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",s.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",s.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",s.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",s.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",s.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",s.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",s.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",s.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",s.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",s.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",s.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",s.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",s.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",s.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",s.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",s.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",s.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",s.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",s.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",s.INVALID_PLUGIN="INVALID_PLUGIN",s.DISCONNECT_P2P="DISCONNECT_P2P",s.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",s.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",s.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",s.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",s.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",s.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",s.PROHIBITED_OPERATION="PROHIBITED_OPERATION",s.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",s.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED"})(j||(j={}));let ft=class extends Error{constructor(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(e),A(this,"code",void 0),A(this,"message",void 0),A(this,"data",void 0),A(this,"name","AgoraRTCException"),this.code=s,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return s==="error"&&(e||console).error(this.toString()),s==="warning"&&(e||console).warn(this.toString()),this}throw(s){throw this.print("error",s),this}};function td(s,e){if(typeof s!="boolean")throw new ft(j.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function cr(s,e,i){if(!Jt(i).call(i,s))throw new ft(j.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(i)))}function hn(s,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(s<i||s>o||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(c){return typeof c=="number"&&c%1==0}(s))throw new ft(j.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(i,", ").concat(o,"]. integer only"))}function PS(s,e){if(typeof s!="number"){if(!(s.min||s.max||s.ideal||s.exact))throw new ft(j.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));s.min!==void 0&&hn(s.min,"".concat(e,".min"),0,1/0),s.max!==void 0&&hn(s.max,"".concat(e,".max"),1,1/0),s.exact!==void 0&&hn(s.exact,"".concat(e,".exact"),1,1/0),s.ideal!==void 0&&hn(s.ideal,"".concat(e,".ideal"),1,1/0)}else hn(s,e,1,1/0)}function fs(s,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,c=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(s==null)throw new ft(j.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!b_(s,i,o,c))throw new ft(j.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(i,",").concat(o,"].").concat(c?" ASCII characters only.":""))}function jd(s,e){if(!Array.isArray(s))throw new ft(j.INVALID_PARAMS,"".concat(e," should be an array"))}function xn(s){return s==null}function b_(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,o=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof s=="string"&&s.length<=i&&s.length>=e&&(!o||function(c){if(typeof c!="string")return!1;for(let u=0;u<c.length;u+=1){const h=c.charCodeAt(u);if(h<0||h>255)return!1}return!0}(s))}function eL(s,e,i){if("getBigUint64"in DataView.prototype)return s.getBigUint64(e,i);const o=s.getUint32(e,i),c=s.getUint32(e+4,i),u=0,h=1;return BigInt(o*h+c*u)<<BigInt(32)|BigInt(o*u+c*h)}function LS(s,e,i,o){if("setBigUint64"in DataView.prototype)return s.setBigUint64(e,i,o);const c=Number(i>>BigInt(32)),u=Number(i&BigInt(4294967295));s.setUint32(e,c,o),s.setUint32(e+4,u,o)}var fl,w_;(function(s){s.COVERED="COVERED",s.POSITION="POSITION",s.SIZE="SIZE",s.STYLE="STYLE"})(fl||(fl={})),function(s){s.UNMOUNTED="UNMOUNTED",s.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(w_||(w_={}));const Xm=new class{constructor(){A(this,"_clientSize",null),A(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),A(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),A(this,"getStyle",s=>window.getComputedStyle(s,null)),A(this,"checkCssVisibleProperty",s=>{var e;let i=!0;const o=this.getStyle(s),{display:c,visibility:u,opacity:h,filter:_}=o;return(c==="none"||Jt(e=["hidden","collapse"]).call(e,u)||Number(h)<.1)&&(i=!1),i?(_&&_.split(" ").filter(m=>{var g;const S=m.split("(")[0];return Jt(g=["brightness","blur","opacity"]).call(g,S)}).map(m=>{const[g,S]=m.split(/\(|\)/);return[g,Number(S.match(/^[0-9\.]+/))]}).forEach(m=>{const[g,S]=m;switch(g){case"brightness":(S<.1||S>3)&&(i=!1);break;case"blur":S>3&&(i=!1);break;case"opacity":S<.1&&(i=!1)}}),i):!1}),A(this,"checkPropertyUpToAllParentNodes",(s,e)=>{let i=!0,o=!0;const c=h=>e(h);let u=s;for(;u&&o;)c(u)||(i=!1,o=!1),u=u.parentElement,u||(o=!1);return i}),A(this,"checkActualCssVisibleIncludeInherit",s=>this.checkPropertyUpToAllParentNodes(s,this.checkCssVisibleProperty)),A(this,"getSizeAboutClient",s=>{const{width:e,height:i,left:o,right:c,top:u,bottom:h}=s.getBoundingClientRect(),_=this.getClientWidth(),m=this.getClientHeight();return{width:e,height:i,left:o,right:c,top:u,bottom:h,clientWidth:_,clientHeight:m,clientMin:Math.min(_,m)}}),A(this,"checkActualSize",()=>{const{width:s,height:e,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(s,e,i)}),A(this,"elementFromPoint",(s,e)=>document.elementFromPoint?document.elementFromPoint(s,e):null),A(this,"checkCoverForAPoint",(s,e,i)=>{const o=this.elementFromPoint(s,e);return o!==null&&o!==i}),A(this,"getPointPositionList",()=>{const{width:s,height:e,left:i,top:o}=this._clientSize,c=s/6,u=e/6,h=[],_=10**6;for(let m=0;m<5;m++)for(let g=0;g<5;g++){const S=(i*_+(m===0?.1:m===4?(c*m*_-1e5)/_:c*m)*_)/_,C=(o*_+(g===0?.1:g===4?(u*g*_-1e5)/_:u*g)*_)/_;h.push({x:S,y:C})}return[...h]}),A(this,"checkElementCover",s=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,s)).filter(e=>!!e).length>6),A(this,"checkSizeIsVisible",(s,e,i)=>(s>50||i/s<=10)&&(e>50||i/e<=10)),A(this,"checkSizeOfPartInClient",()=>{const{left:s,right:e,top:i,bottom:o,clientHeight:c,clientWidth:u,clientMin:h}=this._clientSize;let _,m,g,S;if(s<0)_=0;else{if(!(s<u))return!1;_=s}if(e<0)return!1;if(m=e<u?e:u,i<0)g=0;else{if(!(i<c))return!1;g=i}if(o<0)return!1;S=o<c?o:c;const C=m-_,I=S-g;return this.checkSizeIsVisible(C,I,h)}),A(this,"returnHiddenResult",s=>(this._clientSize=null,{visible:!1,reason:s})),A(this,"checkOneElementVisible",s=>{if(s instanceof HTMLElement){if(this.checkElementIsMountedOnDom(s)){if(this.checkActualCssVisibleIncludeInherit(s)){if(this._clientSize=this.getSizeAboutClient(s),this.checkElementCover(s))return this.returnHiddenResult(fl.COVERED);{const e=this.checkActualSize(),i=this.checkSizeOfPartInClient();return e&&!i?this.returnHiddenResult(fl.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(fl.SIZE)}}return this.returnHiddenResult(fl.STYLE)}return this.returnHiddenResult(w_.UNMOUNTED)}return this.returnHiddenResult(w_.INVALID_HTML_ELEMENT)}),A(this,"checkElementIsMountedOnDom",s=>this.checkPropertyUpToAllParentNodes(s,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function Qm(s){return new TextEncoder().encode(s)}const yA=function(s,e){const i=new Uint8Array(s.byteLength+e.byteLength);return i.set(new Uint8Array(s),0),i.set(new Uint8Array(e),s.byteLength),i},nL=async s=>{const e=function(u){const h=window.atob(u),_=new Uint8Array(new ArrayBuffer(h.length));for(let m=0;m<h.length;m+=1)_[m]=h.charCodeAt(m);return _}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),i=await window.crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),o=Qm(s),c=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},i,o);return function(u){let h="";for(let _=0;_<u.length;_+=1)h+=String.fromCharCode(u[_]);return window.btoa(h)}(new Uint8Array(c))},kS=async s=>function(e,i){let o="";return new Uint8Array(e).forEach(c=>{o+=c.toString(i).padStart(2,"0")}),o}(await crypto.subtle.digest("SHA-256",Qm(s)),16);class oi{constructor(){A(this,"_events",{}),A(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(i=>i.listener):[]}on(e,i){this._events[e]||(this._events[e]=[]);const o=this._events[e];this._indexOfListener(o,i)===-1&&o.push({listener:i,once:!1})}once(e,i){this._events[e]||(this._events[e]=[]);const o=this._events[e];this._indexOfListener(o,i)===-1&&o.push({listener:i,once:!0})}off(e,i){if(!this._events[e])return;const o=this._events[e],c=this._indexOfListener(o,i);c!==-1&&o.splice(c,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const i=this._events[e].map(h=>h);for(var o=arguments.length,c=new Array(o>1?o-1:0),u=1;u<o;u++)c[u-1]=arguments[u];for(let h=0;h<i.length;h+=1){const _=i[h];_.once&&this.off(e,_.listener),_.listener.apply(this,c||[])}}safeEmit(e){for(var i=arguments.length,o=new Array(i>1?i-1:0),c=1;c<i;c++)o[c-1]=arguments[c];[...this._events[e]||[]].forEach(u=>{u.once&&this.off(e,u.listener);try{u.listener.apply(this,o)}catch(h){console.error("safeEmit event:".concat(e," error ").concat(h==null?void 0:h.toString()))}})}_indexOfListener(e,i){let o=e.length;for(;o--;)if(e[o].listener===i)return o;return-1}}let O_=null;function iL(){if(O_)return O_;if(window.electron)return O_=window.electron;if(!window.require)return null;try{return O_=window.require("electron"),O_}catch{return null}}var tr,gi,AA,Fe,We,Tr,Ds,Pu;function rL(s){return hn(s.timeout,"config.timeout",0,1e5),hn(s.timeoutFactor,"config.timeoutFactor",0,100,!1),hn(s.maxRetryCount,"config.maxRetryConfig",0,1/0),hn(s.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function N_(s){if(!Array.isArray(s)||s.length<1)return!1;try{s.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function sL(s){return fs(s.turnServerURL,"turnServerURL"),fs(s.username,"username"),fs(s.password,"password"),s.udpport&&hn(s.udpport,"udpport",1,99999,!0),s.forceturn&&td(s.forceturn,"forceturn"),s.security&&td(s.security,"security"),s.tcpport&&hn(s.tcpport,"tcpport",1,99999,!0),!0}function oL(s){return s.level!==void 0&&cr(s.level,"level",[1,2,3]),s.delay!==void 0&&hn(s.delay,"delay",0,3e3,!0),!0}function zi(s,e){for(var i=arguments.length,o=new Array(i>2?i-2:0),c=2;c<i;c++)o[c-2]=arguments[c];return s.getListeners(e).length===0?ut.reject(new ft(j.UNEXPECTED_ERROR,"can not emit promise")):new ut((u,h)=>{s.emit(e,...o,u,h)})}function kn(s,e){if(s.getListeners(e).length===0)return ut.resolve();for(var i=arguments.length,o=new Array(i>2?i-2:0),c=2;c<i;c++)o[c-2]=arguments[c];return zi(s,e,...o)}function ko(s,e){if(s.getListeners(e).length===0)return null;for(var i=arguments.length,o=new Array(i>2?i-2:0),c=2;c<i;c++)o[c-2]=arguments[c];return gl(s,e,...o)}function gl(s,e){let i=null,o=null;for(var c=arguments.length,u=new Array(c>2?c-2:0),h=2;h<c;h++)u[h-2]=arguments[h];if(s.emit(e,...u,_=>{i=_},_=>{o=_}),o!==null)throw o;if(i===null)throw new ft(j.UNEXPECTED_ERROR,"handler is not sync");return i}(function(s){s.CREATE_CLIENT="createClient",s.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",s.SET_AREA="setArea",s.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",s.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",s.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",s.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",s.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",s.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",s.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",s.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",s.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",s.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",s.START_PROXY_SERVER="Client.startProxyServer",s.STOP_PROXY_SERVER="Client.stopProxyServer",s.SET_PROXY_SERVER="Client.setProxyServer",s.SET_TURN_SERVER="Client.setTurnServer",s.SET_CLIENT_ROLE="Client.setClientRole",s.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",s.ENABLE_DUAL_STREAM="Client.enableDualStream",s.DISABLE_DUAL_STREAM="Client.disableDualStream",s.JOIN="Client.join",s.LEAVE="Client.leave",s.PUBLISH="Client.publish",s.UNPUBLISH="Client.unpublish",s.SUBSCRIBE="Client.subscribe",s.MASS_SUBSCRIBE="Client.massSubscribe",s.MASS_UNSUBSCRIBE="Client.massUnsubscribe",s.UNSUBSCRIBE="Client.unsubscribe",s.RENEW_TOKEN="Client.renewToken",s.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",s.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",s.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",s.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",s.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",s.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",s.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",s.DATACHANNEL_FAILBACK="Client._datachannelFailback",s.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",s.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",s.START_LIVE_STREAMING="Client.startLiveStreaming",s.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",s.STOP_LIVE_STREAMING="Client.stopLiveStreaming",s.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",s.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",s.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",s.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",s.SET_CONFIG_DISTRIBUTE="_configDistribute",s.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",s.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",s.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",s.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",s.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",s.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",s.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",s.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",s.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",s.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",s.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",s.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",s.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",s.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",s.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",s.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",s.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",s.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",s.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",s.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",s.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",s.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",s.STREAM_TYPE_CHANGE="streamTypeChange",s.CONNECTION_STATE_CHANGE="connectionStateChange",s.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",s.IMAGE_MODERATION_UPLOAD="imageModerationUpload"})(tr||(tr={})),function(s){s.TRACER="tracer"}(gi||(gi={})),function(s){s[s.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",s[s.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",s[s.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(AA||(AA={})),function(s){s.LEAVE="LEAVE",s.NETWORK_ERROR="NETWORK_ERROR",s.SERVER_ERROR="SERVER_ERROR",s.UID_BANNED="UID_BANNED",s.IP_BANNED="IP_BANNED",s.CHANNEL_BANNED="CHANNEL_BANNED",s.FALLBACK="FALLBACK",s.LICENSE_MISSING="LICENSE_MISSING",s.LICENSE_EXPIRED="LICENSE_EXPIRED",s.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",s.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",s.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",s.LICENSE_ILLEGAL="LICENSE_ILLEGAL",s.TOKEN_EXPIRE="TOKEN_EXPIRE"}(Fe||(Fe={})),function(s){s.CONNECTION_STATE_CHANGE="connection-state-change",s.MEDIA_RECONNECT_START="media-reconnect-start",s.MEDIA_RECONNECT_END="media-reconnect-end",s.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",s.USER_JOINED="user-joined",s.USER_LEAVED="user-left",s.USER_PUBLISHED="user-published",s.USER_UNPUBLISHED="user-unpublished",s.USER_INFO_UPDATED="user-info-updated",s.CLIENT_BANNED="client-banned",s.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",s.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",s.VOLUME_INDICATOR="volume-indicator",s.CRYPT_ERROR="crypt-error",s.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",s.NETWORK_QUALITY="network-quality",s.STREAM_TYPE_CHANGED="stream-type-changed",s.STREAM_FALLBACK="stream-fallback",s.RECEIVE_METADATA="receive-metadata",s.STREAM_MESSAGE="stream-message",s.LIVE_STREAMING_ERROR="live-streaming-error",s.LIVE_STREAMING_WARNING="live-streaming-warning",s.INJECT_STREAM_STATUS="stream-inject-status",s.EXCEPTION="exception",s.ERROR="error",s.P2P_LOST="p2p_lost",s.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",s.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",s.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",s.PUBLISHED_USER_LIST="published-user-list",s.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",s.CONTENT_INSPECT_ERROR="content-inspect-error",s.CONTENT_INSPECT_RESULT="content-inspect-result",s.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(We||(We={})),function(s){s.NETWORK_ERROR="NETWORK_ERROR",s.SERVER_ERROR="SERVER_ERROR",s.MULTI_IP="MULTI_IP",s.TIMEOUT="TIMEOUT",s.OFFLINE="OFFLINE",s.LEAVE="LEAVE",s.P2P_FAILED="P2P_FAILED",s.FALLBACK="FALLBACK"}(Tr||(Tr={})),function(s){s.ONLINE="ONLINE",s.OFFLINE="OFFLINE"}(Ds||(Ds={})),function(s){s.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",s.ONLINE="ONLINE",s.OFFLINE="OFFLINE"}(Pu||(Pu={}));const er=new class extends oi{set networkState(s){this.emit(Pu.NETWORK_STATE_CHANGE,s,this._networkState),s===Ds.ONLINE?this.emit(Pu.ONLINE):s===Ds.OFFLINE&&(this.onlineWaiter=new ut(e=>{this.once(Pu.ONLINE,()=>{this.onlineWaiter=void 0,e(Ds.ONLINE)})}),this.emit(Pu.OFFLINE)),this._networkState=s}get networkState(){return this._networkState}get isOnline(){return this._networkState===Ds.ONLINE}constructor(){super(),A(this,"_moduleName","network-indicator"),A(this,"_networkState",Ds.ONLINE),A(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Ds.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Ds.OFFLINE})}};var aL=kr,qB=Ns,cL=fh,dL=Cu,zB=TypeError,Zm=function(s){return function(e,i,o,c){aL(i);var u=qB(e),h=cL(u),_=dL(u),m=s?_-1:0,g=s?-1:1;if(o<2)for(;;){if(m in h){c=h[m],m+=g;break}if(m+=g,s?m<0:_<=m)throw zB("Reduce of empty array with no initial value")}for(;s?m>=0:_>m;m+=g)m in h&&(c=i(c,h[m],m,u));return c}},uL={left:Zm(!1)}.left;Ce({target:"Array",proto:!0,forced:!__&&Pa>79&&Pa<83||!_y("reduce")},{reduce:function(s){var e=arguments.length;return uL(this,s,e,e>1?arguments[1]:void 0)}});var lL=al("Array").reduce,hL=le,pL=lL,bA=Array.prototype,Lu=Rt(function(s){var e=s.reduce;return s===bA||hL(bA,s)&&e===bA.reduce?pL:e});function _L(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function ra(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?_L(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):_L(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function qh(s,e){const i=s.indexOf(e);i!==-1&&s.splice(i,1)}function zh(s){const e=[];return s.forEach(i=>{e.indexOf(i)===-1&&e.push(i)}),e}function MS(s){ut!==void 0?ut.resolve().then(s):setTimeout(s,0)}function Jn(s){return JSON.parse(JSON.stringify(s))}function Jh(s){try{return Jn(s)}catch{return s}}const EL={};function Xh(s,e){EL[e]||(EL[e]=!0,s())}function D_(s){const e=window.atob(s),i=new Uint8Array(new ArrayBuffer(e.length));for(let o=0;o<e.length;o+=1)i[o]=e.charCodeAt(o);return i}function Qh(s){let e="";for(let i=0;i<s.length;i+=1)e+=String.fromCharCode(s[i]);return window.btoa(e)}function wA(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];const o=Lu(e).call(e,(h,_)=>h+_.length,0),c=new Uint8Array(new ArrayBuffer(o));let u=0;return e.forEach(h=>{c.set(h,u),u+=h.length}),c}function Gd(s){return window.TextEncoder?new TextEncoder().encode(s).length:s.length}function mL(s){let e=0;return/DingTalk/i.test(navigator.userAgent)&&s.realFormData&&(s=s.realFormData),s.forEach(i=>{e+=typeof i=="string"?Gd(i):i.size}),e+138}function fL(s){const e=new ft(j.TIMEOUT,"timeout");return new ut((i,o)=>{window.setTimeout(()=>o(e),s)})}function Mr(s){return new ut(e=>{window.setTimeout(e,s)})}function Hn(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,s).toLowerCase();return i.length===s?"".concat(e).concat(i):"".concat(e).concat(i)+Hn(s-i.length,"")}function OA(){return Hn(32,"").toUpperCase()}const US=()=>{},gL=new class{constructor(){A(this,"fnMap",new Map)}throttleByKey(s,e,i,o){for(var c=arguments.length,u=new Array(c>4?c-4:0),h=4;h<c;h++)u[h-4]=arguments[h];if(this.fnMap.has(e)){const _=this.fnMap.get(e);if(_.threshold!==i){_.fn(..._.args),clearTimeout(_.timer);const m=window.setTimeout(()=>{const g=this.fnMap.get(e);g&&g.fn(...g.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:s,threshold:i,timer:m,args:u,skipFn:o})}else _.skipFn&&_.skipFn(..._.args),this.fnMap.set(e,ra(ra({},_),{},{fn:s,args:u,skipFn:o}))}else{const _=window.setTimeout(()=>{const m=this.fnMap.get(e);m&&m.fn(...m.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:s,threshold:i,timer:_,args:u,skipFn:o})}}},TL=gL.throttleByKey.bind(gL);function SL(s){return typeof s=="object"&&s!==null&&!(s instanceof RegExp)}function xS(s,e){if(!SL(s)||!SL(e)||Array.isArray(s)&&!Array.isArray(e)||!Array.isArray(s)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(s)){const i=[...s];for(let o=0;o<e.length;o++)i[o]=xS(s[o],e[o]);return i}{const i=ra({},s);for(const o in e)Object.prototype.hasOwnProperty.call(e,o)&&(Object.prototype.hasOwnProperty.call(s,o)?i[o]=xS(s[o],e[o]):i[o]=e[o]);return i}}function NA(s,e){let i=[0];if(i=new Array(e).fill(0),s===0)return i;let o=0;for(;s>0&&(i[o]=255&s,s>>=8,o++,o!==e););return i}let JB=1,VS=console;class Sr{static setLogger(e){VS=e}constructor(e){A(this,"lockingPromise",ut.resolve()),A(this,"locks",0),A(this,"name",""),A(this,"lockId",void 0),this.lockId=JB++,e&&(this.name=e),VS.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let i;this.locks+=1,VS.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:""));const o=new ut(u=>{i=()=>{this.locks-=1,VS.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:"")),u()}}),c=this.lockingPromise.then(()=>i);return this.lockingPromise=this.lockingPromise.then(()=>o),c}}function P_(s,e){return function(i,o,c){const u=c.value;if(typeof u!="function")throw new Error("Cannot use mutex on object property.");return c.value=async function(){const h=this[e];if(!h)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(s));const _=await h.lock("From ".concat(s,".").concat(o));try{for(var m=arguments.length,g=new Array(m),S=0;S<m;S++)g[S]=arguments[S];return await u.apply(this,g)}finally{_()}},c}}const nr={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function $m(s,e){const i=Math.floor(e.timeout*Math.pow(e.timeoutFactor,s));return Math.min(e.maxRetryTimeout,i)}function ed(s,e,i,o){const c=Object.assign({},nr,o);let u=c.timeout;const h=async()=>{await function(g){return new ut(S=>{window.setTimeout(S,g)})}(u),u*=c.timeoutFactor,u=Math.min(c.maxRetryTimeout,u)};let _=!1;const m=new ut(async(g,S)=>{e=e||(()=>!1),i=i||(()=>!0);for(let C=0;C<c.maxRetryCount;C+=1){if(_)return S(new ft(j.OPERATION_ABORTED));try{const I=await s();if(!e(I,C)||C+1===c.maxRetryCount)return g(I);await h()}catch(I){if(!i(I,C)||C+1===c.maxRetryCount)return S(I);await h()}}});return m.cancel=()=>_=!0,m}let FS=class{constructor(s){A(this,"input",[]),A(this,"size",void 0),this.size=s}add(s){this.input.push(s),this.input.length>this.size&&this.input.splice(0,1)}mean(){var s;return this.input.length===0?0:Lu(s=this.input).call(s,(e,i)=>e+i)/this.input.length}};function RL(s,e){return function(){return s.apply(e,arguments)}}const{toString:XB}=Object.prototype,{getPrototypeOf:DA}=Object,Zh=(BS=Object.create(null),s=>{const e=XB.call(s);return BS[e]||(BS[e]=e.slice(8,-1).toLowerCase())});var BS;const nd=s=>(s=s.toLowerCase(),e=>Zh(e)===s),jS=s=>e=>typeof e===s,{isArray:$h}=Array,tp=jS("undefined"),PA=nd("ArrayBuffer"),QB=jS("string"),Fa=jS("function"),LA=jS("number"),ku=s=>s!==null&&typeof s=="object",tf=s=>{if(Zh(s)!=="object")return!1;const e=DA(s);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Symbol.toStringTag in s||Symbol.iterator in s)},ef=nd("Date"),ZB=nd("File"),$B=nd("Blob"),F=nd("FileList"),tj=nd("URLSearchParams");function nf(s,e,{allOwnKeys:i=!1}={}){if(s==null)return;let o,c;if(typeof s!="object"&&(s=[s]),$h(s))for(o=0,c=s.length;o<c;o++)e.call(null,s[o],o,s);else{const u=i?Object.getOwnPropertyNames(s):Object.keys(s),h=u.length;let _;for(o=0;o<h;o++)_=u[o],e.call(null,s[_],_,s)}}function GS(s,e){e=e.toLowerCase();const i=Object.keys(s);let o,c=i.length;for(;c-- >0;)if(o=i[c],e===o.toLowerCase())return o;return null}const CL=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:YE,WS=s=>!tp(s)&&s!==CL,L_=(k_=typeof Uint8Array<"u"&&DA(Uint8Array),s=>k_&&s instanceof k_);var k_;const Wd=nd("HTMLFormElement"),ep=(({hasOwnProperty:s})=>(e,i)=>s.call(e,i))(Object.prototype),vL=nd("RegExp"),kA=(s,e)=>{const i=Object.getOwnPropertyDescriptors(s),o={};nf(i,(c,u)=>{let h;(h=e(c,u,s))!==!1&&(o[u]=h||c)}),Object.defineProperties(s,o)},MA="abcdefghijklmnopqrstuvwxyz",IL="0123456789",yL={DIGIT:IL,ALPHA:MA,ALPHA_DIGIT:MA+MA.toUpperCase()+IL},ej=nd("AsyncFunction");var Yt={isArray:$h,isArrayBuffer:PA,isBuffer:function(s){return s!==null&&!tp(s)&&s.constructor!==null&&!tp(s.constructor)&&Fa(s.constructor.isBuffer)&&s.constructor.isBuffer(s)},isFormData:s=>{let e;return s&&(typeof FormData=="function"&&s instanceof FormData||Fa(s.append)&&((e=Zh(s))==="formdata"||e==="object"&&Fa(s.toString)&&s.toString()==="[object FormData]"))},isArrayBufferView:function(s){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(s):s&&s.buffer&&PA(s.buffer),e},isString:QB,isNumber:LA,isBoolean:s=>s===!0||s===!1,isObject:ku,isPlainObject:tf,isUndefined:tp,isDate:ef,isFile:ZB,isBlob:$B,isRegExp:vL,isFunction:Fa,isStream:s=>ku(s)&&Fa(s.pipe),isURLSearchParams:tj,isTypedArray:L_,isFileList:F,forEach:nf,merge:function s(){const{caseless:e}=WS(this)&&this||{},i={},o=(c,u)=>{const h=e&&GS(i,u)||u;tf(i[h])&&tf(c)?i[h]=s(i[h],c):tf(c)?i[h]=s({},c):$h(c)?i[h]=c.slice():i[h]=c};for(let c=0,u=arguments.length;c<u;c++)arguments[c]&&nf(arguments[c],o);return i},extend:(s,e,i,{allOwnKeys:o}={})=>(nf(e,(c,u)=>{i&&Fa(c)?s[u]=RL(c,i):s[u]=c},{allOwnKeys:o}),s),trim:s=>s.trim?s.trim():s.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:s=>(s.charCodeAt(0)===65279&&(s=s.slice(1)),s),inherits:(s,e,i,o)=>{s.prototype=Object.create(e.prototype,o),s.prototype.constructor=s,Object.defineProperty(s,"super",{value:e.prototype}),i&&Object.assign(s.prototype,i)},toFlatObject:(s,e,i,o)=>{let c,u,h;const _={};if(e=e||{},s==null)return e;do{for(c=Object.getOwnPropertyNames(s),u=c.length;u-- >0;)h=c[u],o&&!o(h,s,e)||_[h]||(e[h]=s[h],_[h]=!0);s=i!==!1&&DA(s)}while(s&&(!i||i(s,e))&&s!==Object.prototype);return e},kindOf:Zh,kindOfTest:nd,endsWith:(s,e,i)=>{s=String(s),(i===void 0||i>s.length)&&(i=s.length),i-=e.length;const o=s.indexOf(e,i);return o!==-1&&o===i},toArray:s=>{if(!s)return null;if($h(s))return s;let e=s.length;if(!LA(e))return null;const i=new Array(e);for(;e-- >0;)i[e]=s[e];return i},forEachEntry:(s,e)=>{const i=(s&&s[Symbol.iterator]).call(s);let o;for(;(o=i.next())&&!o.done;){const c=o.value;e.call(s,c[0],c[1])}},matchAll:(s,e)=>{let i;const o=[];for(;(i=s.exec(e))!==null;)o.push(i);return o},isHTMLForm:Wd,hasOwnProperty:ep,hasOwnProp:ep,reduceDescriptors:kA,freezeMethods:s=>{kA(s,(e,i)=>{if(Fa(s)&&["arguments","caller","callee"].indexOf(i)!==-1)return!1;const o=s[i];Fa(o)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))})},toObjectSet:(s,e)=>{const i={},o=c=>{c.forEach(u=>{i[u]=!0})};return $h(s)?o(s):o(String(s).split(e)),i},toCamelCase:s=>s.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,i,o){return i.toUpperCase()+o}),noop:()=>{},toFiniteNumber:(s,e)=>(s=+s,Number.isFinite(s)?s:e),findKey:GS,global:CL,isContextDefined:WS,ALPHABET:yL,generateString:(s=16,e=yL.ALPHA_DIGIT)=>{let i="";const{length:o}=e;for(;s--;)i+=e[Math.random()*o|0];return i},isSpecCompliantForm:function(s){return!!(s&&Fa(s.append)&&s[Symbol.toStringTag]==="FormData"&&s[Symbol.iterator])},toJSONObject:s=>{const e=new Array(10),i=(o,c)=>{if(ku(o)){if(e.indexOf(o)>=0)return;if(!("toJSON"in o)){e[c]=o;const u=$h(o)?[]:{};return nf(o,(h,_)=>{const m=i(h,c+1);!tp(m)&&(u[_]=m)}),e[c]=void 0,u}}return o};return i(s,0)},isAsyncFn:ej,isThenable:s=>s&&(ku(s)||Fa(s))&&Fa(s.then)&&Fa(s.catch)};function ui(s,e,i,o,c){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=s,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),o&&(this.request=o),c&&(this.response=c)}Yt.inherits(ui,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Yt.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const HS=ui.prototype,AL={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(s=>{AL[s]={value:s}}),Object.defineProperties(ui,AL),Object.defineProperty(HS,"isAxiosError",{value:!0}),ui.from=(s,e,i,o,c,u)=>{const h=Object.create(HS);return Yt.toFlatObject(s,h,function(_){return _!==Error.prototype},_=>_!=="isAxiosError"),ui.call(h,s.message,e,i,o,c),h.cause=s,h.name=s.name,u&&Object.assign(h,u),h};function UA(s){return Yt.isPlainObject(s)||Yt.isArray(s)}function bL(s){return Yt.endsWith(s,"[]")?s.slice(0,-2):s}function wL(s,e,i){return s?s.concat(e).map(function(o,c){return o=bL(o),!i&&c?"["+o+"]":o}).join(i?".":""):e}const OL=Yt.toFlatObject(Yt,{},null,function(s){return/^is[A-Z]/.test(s)});function Hs(s,e,i){if(!Yt.isObject(s))throw new TypeError("target must be an object");e=e||new FormData;const o=(i=Yt.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(I,b){return!Yt.isUndefined(b[I])})).metaTokens,c=i.visitor||g,u=i.dots,h=i.indexes,_=(i.Blob||typeof Blob<"u"&&Blob)&&Yt.isSpecCompliantForm(e);if(!Yt.isFunction(c))throw new TypeError("visitor must be a function");function m(I){if(I===null)return"";if(Yt.isDate(I))return I.toISOString();if(!_&&Yt.isBlob(I))throw new ui("Blob is not supported. Use a Buffer instead.");return Yt.isArrayBuffer(I)||Yt.isTypedArray(I)?_&&typeof Blob=="function"?new Blob([I]):Buffer.from(I):I}function g(I,b,x){let D=I;if(I&&!x&&typeof I=="object"){if(Yt.endsWith(b,"{}"))b=o?b:b.slice(0,-2),I=JSON.stringify(I);else if(Yt.isArray(I)&&function(M){return Yt.isArray(M)&&!M.some(UA)}(I)||(Yt.isFileList(I)||Yt.endsWith(b,"[]"))&&(D=Yt.toArray(I)))return b=bL(b),D.forEach(function(M,K){!Yt.isUndefined(M)&&M!==null&&e.append(h===!0?wL([b],K,u):h===null?b:b+"[]",m(M))}),!1}return!!UA(I)||(e.append(wL(x,b,u),m(I)),!1)}const S=[],C=Object.assign(OL,{defaultVisitor:g,convertValue:m,isVisitable:UA});if(!Yt.isObject(s))throw new TypeError("data must be an object");return function I(b,x){if(!Yt.isUndefined(b)){if(S.indexOf(b)!==-1)throw Error("Circular reference detected in "+x.join("."));S.push(b),Yt.forEach(b,function(D,M){(!(Yt.isUndefined(D)||D===null)&&c.call(e,D,Yt.isString(M)?M.trim():M,x,C))===!0&&I(D,x?x.concat(M):[M])}),S.pop()}}(s),e}function NL(s){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(s).replace(/[!'()~]|%20|%00/g,function(i){return e[i]})}function KS(s,e){this._pairs=[],s&&Hs(s,this,e)}const YS=KS.prototype;function nj(s){return encodeURIComponent(s).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function np(s,e,i){if(!e)return s;const o=i&&i.encode||nj,c=i&&i.serialize;let u;if(u=c?c(e,i):Yt.isURLSearchParams(e)?e.toString():new KS(e,i).toString(o),u){const h=s.indexOf("#");h!==-1&&(s=s.slice(0,h)),s+=(s.indexOf("?")===-1?"?":"&")+u}return s}YS.append=function(s,e){this._pairs.push([s,e])},YS.toString=function(s){const e=s?function(i){return s.call(this,i,NL)}:NL;return this._pairs.map(function(i){return e(i[0])+"="+e(i[1])},"").join("&")};var DL=class{constructor(){this.handlers=[]}use(s,e,i){return this.handlers.push({fulfilled:s,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(s){this.handlers[s]&&(this.handlers[s]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(s){Yt.forEach(this.handlers,function(e){e!==null&&s(e)})}},PL={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},rf={isBrowser:!0,classes:{URLSearchParams:typeof URLSearchParams<"u"?URLSearchParams:KS,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const xA=typeof window<"u"&&typeof document<"u",LL=(Ba=typeof navigator<"u"&&navigator.product,xA&&["ReactNative","NativeScript","NS"].indexOf(Ba)<0);var Ba;const ij=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function";var Hd={...Object.freeze({__proto__:null,hasBrowserEnv:xA,hasStandardBrowserEnv:LL,hasStandardBrowserWebWorkerEnv:ij}),...rf};function qS(s){function e(i,o,c,u){let h=i[u++];if(h==="__proto__")return!0;const _=Number.isFinite(+h),m=u>=i.length;return h=!h&&Yt.isArray(c)?c.length:h,m?(Yt.hasOwnProp(c,h)?c[h]=[c[h],o]:c[h]=o,!_):(c[h]&&Yt.isObject(c[h])||(c[h]=[]),e(i,o,c[h],u)&&Yt.isArray(c[h])&&(c[h]=function(g){const S={},C=Object.keys(g);let I;const b=C.length;let x;for(I=0;I<b;I++)x=C[I],S[x]=g[x];return S}(c[h])),!_)}if(Yt.isFormData(s)&&Yt.isFunction(s.entries)){const i={};return Yt.forEachEntry(s,(o,c)=>{e(function(u){return Yt.matchAll(/\w+|\[(\w*)]/g,u).map(h=>h[0]==="[]"?"":h[1]||h[0])}(o),c,i,0)}),i}return null}const zS={transitional:PL,adapter:["xhr","http"],transformRequest:[function(s,e){const i=e.getContentType()||"",o=i.indexOf("application/json")>-1,c=Yt.isObject(s);if(c&&Yt.isHTMLForm(s)&&(s=new FormData(s)),Yt.isFormData(s))return o?JSON.stringify(qS(s)):s;if(Yt.isArrayBuffer(s)||Yt.isBuffer(s)||Yt.isStream(s)||Yt.isFile(s)||Yt.isBlob(s))return s;if(Yt.isArrayBufferView(s))return s.buffer;if(Yt.isURLSearchParams(s))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),s.toString();let u;if(c){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(h,_){return Hs(h,new Hd.classes.URLSearchParams,Object.assign({visitor:function(m,g,S,C){return Hd.isNode&&Yt.isBuffer(m)?(this.append(g,m.toString("base64")),!1):C.defaultVisitor.apply(this,arguments)}},_))}(s,this.formSerializer).toString();if((u=Yt.isFileList(s))||i.indexOf("multipart/form-data")>-1){const h=this.env&&this.env.FormData;return Hs(u?{"files[]":s}:s,h&&new h,this.formSerializer)}}return c||o?(e.setContentType("application/json",!1),function(h,_,m){if(Yt.isString(h))try{return(_||JSON.parse)(h),Yt.trim(h)}catch(g){if(g.name!=="SyntaxError")throw g}return(m||JSON.stringify)(h)}(s)):s}],transformResponse:[function(s){const e=this.transitional||zS.transitional,i=e&&e.forcedJSONParsing,o=this.responseType==="json";if(s&&Yt.isString(s)&&(i&&!this.responseType||o)){const c=!(e&&e.silentJSONParsing)&&o;try{return JSON.parse(s)}catch(u){if(c)throw u.name==="SyntaxError"?ui.from(u,ui.ERR_BAD_RESPONSE,this,null,this.response):u}}return s}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Hd.classes.FormData,Blob:Hd.classes.Blob},validateStatus:function(s){return s>=200&&s<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Yt.forEach(["delete","get","head","post","put","patch"],s=>{zS.headers[s]={}});var M_=zS;const sf=Yt.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),JS=Symbol("internals");function U_(s){return s&&String(s).trim().toLowerCase()}function XS(s){return s===!1||s==null?s:Yt.isArray(s)?s.map(XS):String(s)}function VA(s,e,i,o,c){return Yt.isFunction(o)?o.call(this,e,i):(c&&(e=i),Yt.isString(e)?Yt.isString(o)?e.indexOf(o)!==-1:Yt.isRegExp(o)?o.test(e):void 0:void 0)}class of{constructor(e){e&&this.set(e)}set(e,i,o){const c=this;function u(_,m,g){const S=U_(m);if(!S)throw new Error("header name must be a non-empty string");const C=Yt.findKey(c,S);(!C||c[C]===void 0||g===!0||g===void 0&&c[C]!==!1)&&(c[C||m]=XS(_))}const h=(_,m)=>Yt.forEach(_,(g,S)=>u(g,S,m));return Yt.isPlainObject(e)||e instanceof this.constructor?h(e,i):Yt.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim())?h((_=>{const m={};let g,S,C;return _&&_.split(`
`).forEach(function(I){C=I.indexOf(":"),g=I.substring(0,C).trim().toLowerCase(),S=I.substring(C+1).trim(),!g||m[g]&&sf[g]||(g==="set-cookie"?m[g]?m[g].push(S):m[g]=[S]:m[g]=m[g]?m[g]+", "+S:S)}),m})(e),i):e!=null&&u(i,e,o),this}get(e,i){if(e=U_(e)){const o=Yt.findKey(this,e);if(o){const c=this[o];if(!i)return c;if(i===!0)return function(u){const h=Object.create(null),_=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let m;for(;m=_.exec(u);)h[m[1]]=m[2];return h}(c);if(Yt.isFunction(i))return i.call(this,c,o);if(Yt.isRegExp(i))return i.exec(c);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,i){if(e=U_(e)){const o=Yt.findKey(this,e);return!(!o||this[o]===void 0||i&&!VA(0,this[o],o,i))}return!1}delete(e,i){const o=this;let c=!1;function u(h){if(h=U_(h)){const _=Yt.findKey(o,h);!_||i&&!VA(0,o[_],_,i)||(delete o[_],c=!0)}}return Yt.isArray(e)?e.forEach(u):u(e),c}clear(e){const i=Object.keys(this);let o=i.length,c=!1;for(;o--;){const u=i[o];e&&!VA(0,this[u],u,e,!0)||(delete this[u],c=!0)}return c}normalize(e){const i=this,o={};return Yt.forEach(this,(c,u)=>{const h=Yt.findKey(o,u);if(h)return i[h]=XS(c),void delete i[u];const _=e?function(m){return m.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(g,S,C)=>S.toUpperCase()+C)}(u):String(u).trim();_!==u&&delete i[u],i[_]=XS(c),o[_]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const i=Object.create(null);return Yt.forEach(this,(o,c)=>{o!=null&&o!==!1&&(i[c]=e&&Yt.isArray(o)?o.join(", "):o)}),i}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,i])=>e+": "+i).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...i){const o=new this(e);return i.forEach(c=>o.set(c)),o}static accessor(e){const i=(this[JS]=this[JS]={accessors:{}}).accessors,o=this.prototype;function c(u){const h=U_(u);i[h]||(function(_,m){const g=Yt.toCamelCase(" "+m);["get","set","has"].forEach(S=>{Object.defineProperty(_,S+g,{value:function(C,I,b){return this[S].call(this,m,C,I,b)},configurable:!0})})}(o,u),i[h]=!0)}return Yt.isArray(e)?e.forEach(c):c(e),this}}of.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Yt.reduceDescriptors(of.prototype,({value:s},e)=>{let i=e[0].toUpperCase()+e.slice(1);return{get:()=>s,set(o){this[i]=o}}}),Yt.freezeMethods(of);var Mu=of;function FA(s,e){const i=this||M_,o=e||i,c=Mu.from(o.headers);let u=o.data;return Yt.forEach(s,function(h){u=h.call(i,u,c.normalize(),e?e.status:void 0)}),c.normalize(),u}function BA(s){return!(!s||!s.__CANCEL__)}function id(s,e,i){ui.call(this,s??"canceled",ui.ERR_CANCELED,e,i),this.name="CanceledError"}Yt.inherits(id,ui,{__CANCEL__:!0});var jA=Hd.hasStandardBrowserEnv?{write(s,e,i,o,c,u){const h=[s+"="+encodeURIComponent(e)];Yt.isNumber(i)&&h.push("expires="+new Date(i).toGMTString()),Yt.isString(o)&&h.push("path="+o),Yt.isString(c)&&h.push("domain="+c),u===!0&&h.push("secure"),document.cookie=h.join("; ")},read(s){const e=document.cookie.match(new RegExp("(^|;\\s*)("+s+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(s){this.write(s,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function kL(s,e){return s&&!function(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}(e)?function(i,o){return o?i.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):i}(s,e):e}var ML=Hd.hasStandardBrowserEnv?function(){const s=/(msie|trident)/i.test(navigator.userAgent),e=document.createElement("a");let i;function o(c){let u=c;return s&&(e.setAttribute("href",u),u=e.href),e.setAttribute("href",u),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return i=o(window.location.href),function(c){const u=Yt.isString(c)?o(c):c;return u.protocol===i.protocol&&u.host===i.host}}():function(){return!0};function GA(s,e){let i=0;const o=function(c,u){c=c||10;const h=new Array(c),_=new Array(c);let m,g=0,S=0;return u=u!==void 0?u:1e3,function(C){const I=Date.now(),b=_[S];m||(m=I),h[g]=C,_[g]=I;let x=S,D=0;for(;x!==g;)D+=h[x++],x%=c;if(g=(g+1)%c,g===S&&(S=(S+1)%c),I-m<u)return;const M=b&&I-b;return M?Math.round(1e3*D/M):void 0}}(50,250);return c=>{const u=c.loaded,h=c.lengthComputable?c.total:void 0,_=u-i,m=o(_);i=u;const g={loaded:u,total:h,progress:h?u/h:void 0,bytes:_,rate:m||void 0,estimated:m&&h&&u<=h?(h-u)/m:void 0,event:c};g[e?"download":"upload"]=!0,s(g)}}var rj=typeof XMLHttpRequest<"u"&&function(s){return new Promise(function(e,i){let o=s.data;const c=Mu.from(s.headers).normalize();let u,h,{responseType:_,withXSRFToken:m}=s;function g(){s.cancelToken&&s.cancelToken.unsubscribe(u),s.signal&&s.signal.removeEventListener("abort",u)}if(Yt.isFormData(o)){if(Hd.hasStandardBrowserEnv||Hd.hasStandardBrowserWebWorkerEnv)c.setContentType(!1);else if((h=c.getContentType())!==!1){const[x,...D]=h?h.split(";").map(M=>M.trim()).filter(Boolean):[];c.setContentType([x||"multipart/form-data",...D].join("; "))}}let S=new XMLHttpRequest;if(s.auth){const x=s.auth.username||"",D=s.auth.password?unescape(encodeURIComponent(s.auth.password)):"";c.set("Authorization","Basic "+btoa(x+":"+D))}const C=kL(s.baseURL,s.url);function I(){if(!S)return;const x=Mu.from("getAllResponseHeaders"in S&&S.getAllResponseHeaders());(function(D,M,K){const z=K.config.validateStatus;K.status&&z&&!z(K.status)?M(new ui("Request failed with status code "+K.status,[ui.ERR_BAD_REQUEST,ui.ERR_BAD_RESPONSE][Math.floor(K.status/100)-4],K.config,K.request,K)):D(K)})(function(D){e(D),g()},function(D){i(D),g()},{data:_&&_!=="text"&&_!=="json"?S.response:S.responseText,status:S.status,statusText:S.statusText,headers:x,config:s,request:S}),S=null}if(S.open(s.method.toUpperCase(),np(C,s.params,s.paramsSerializer),!0),S.timeout=s.timeout,"onloadend"in S?S.onloadend=I:S.onreadystatechange=function(){S&&S.readyState===4&&(S.status!==0||S.responseURL&&S.responseURL.indexOf("file:")===0)&&setTimeout(I)},S.onabort=function(){S&&(i(new ui("Request aborted",ui.ECONNABORTED,s,S)),S=null)},S.onerror=function(){i(new ui("Network Error",ui.ERR_NETWORK,s,S)),S=null},S.ontimeout=function(){let x=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const D=s.transitional||PL;s.timeoutErrorMessage&&(x=s.timeoutErrorMessage),i(new ui(x,D.clarifyTimeoutError?ui.ETIMEDOUT:ui.ECONNABORTED,s,S)),S=null},Hd.hasStandardBrowserEnv&&(m&&Yt.isFunction(m)&&(m=m(s)),m||m!==!1&&ML(C))){const x=s.xsrfHeaderName&&s.xsrfCookieName&&jA.read(s.xsrfCookieName);x&&c.set(s.xsrfHeaderName,x)}o===void 0&&c.setContentType(null),"setRequestHeader"in S&&Yt.forEach(c.toJSON(),function(x,D){S.setRequestHeader(D,x)}),Yt.isUndefined(s.withCredentials)||(S.withCredentials=!!s.withCredentials),_&&_!=="json"&&(S.responseType=s.responseType),typeof s.onDownloadProgress=="function"&&S.addEventListener("progress",GA(s.onDownloadProgress,!0)),typeof s.onUploadProgress=="function"&&S.upload&&S.upload.addEventListener("progress",GA(s.onUploadProgress)),(s.cancelToken||s.signal)&&(u=x=>{S&&(i(!x||x.type?new id(null,s,S):x),S.abort(),S=null)},s.cancelToken&&s.cancelToken.subscribe(u),s.signal&&(s.signal.aborted?u():s.signal.addEventListener("abort",u)));const b=function(x){const D=/^([-+\w]{1,25})(:?\/\/|:)/.exec(x);return D&&D[1]||""}(C);b&&Hd.protocols.indexOf(b)===-1?i(new ui("Unsupported protocol "+b+":",ui.ERR_BAD_REQUEST,s)):S.send(o||null)})};const WA={http:null,xhr:rj};Yt.forEach(WA,(s,e)=>{if(s){try{Object.defineProperty(s,"name",{value:e})}catch{}Object.defineProperty(s,"adapterName",{value:e})}});const HA=s=>`- ${s}`,sj=s=>Yt.isFunction(s)||s===null||s===!1;var UL={getAdapter:s=>{s=Yt.isArray(s)?s:[s];const{length:e}=s;let i,o;const c={};for(let u=0;u<e;u++){let h;if(i=s[u],o=i,!sj(i)&&(o=WA[(h=String(i)).toLowerCase()],o===void 0))throw new ui(`Unknown adapter '${h}'`);if(o)break;c[h||"#"+u]=o}if(!o){const u=Object.entries(c).map(([h,_])=>`adapter ${h} `+(_===!1?"is not supported by the environment":"is not available in the build"));throw new ui("There is no suitable adapter to dispatch the request "+(e?u.length>1?`since :
`+u.map(HA).join(`
`):" "+HA(u[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return o},adapters:WA};function QS(s){if(s.cancelToken&&s.cancelToken.throwIfRequested(),s.signal&&s.signal.aborted)throw new id(null,s)}function xL(s){return QS(s),s.headers=Mu.from(s.headers),s.data=FA.call(s,s.transformRequest),["post","put","patch"].indexOf(s.method)!==-1&&s.headers.setContentType("application/x-www-form-urlencoded",!1),UL.getAdapter(s.adapter||M_.adapter)(s).then(function(e){return QS(s),e.data=FA.call(s,s.transformResponse,e),e.headers=Mu.from(e.headers),e},function(e){return BA(e)||(QS(s),e&&e.response&&(e.response.data=FA.call(s,s.transformResponse,e.response),e.response.headers=Mu.from(e.response.headers))),Promise.reject(e)})}const VL=s=>s instanceof Mu?s.toJSON():s;function x_(s,e){e=e||{};const i={};function o(g,S,C){return Yt.isPlainObject(g)&&Yt.isPlainObject(S)?Yt.merge.call({caseless:C},g,S):Yt.isPlainObject(S)?Yt.merge({},S):Yt.isArray(S)?S.slice():S}function c(g,S,C){return Yt.isUndefined(S)?Yt.isUndefined(g)?void 0:o(void 0,g,C):o(g,S,C)}function u(g,S){if(!Yt.isUndefined(S))return o(void 0,S)}function h(g,S){return Yt.isUndefined(S)?Yt.isUndefined(g)?void 0:o(void 0,g):o(void 0,S)}function _(g,S,C){return C in e?o(g,S):C in s?o(void 0,g):void 0}const m={url:u,method:u,data:u,baseURL:h,transformRequest:h,transformResponse:h,paramsSerializer:h,timeout:h,timeoutMessage:h,withCredentials:h,withXSRFToken:h,adapter:h,responseType:h,xsrfCookieName:h,xsrfHeaderName:h,onUploadProgress:h,onDownloadProgress:h,decompress:h,maxContentLength:h,maxBodyLength:h,beforeRedirect:h,transport:h,httpAgent:h,httpsAgent:h,cancelToken:h,socketPath:h,responseEncoding:h,validateStatus:_,headers:(g,S)=>c(VL(g),VL(S),!0)};return Yt.forEach(Object.keys(Object.assign({},s,e)),function(g){const S=m[g]||c,C=S(s[g],e[g],g);Yt.isUndefined(C)&&S!==_||(i[g]=C)}),i}const KA="1.6.7",af={};["object","boolean","number","function","string","symbol"].forEach((s,e)=>{af[s]=function(i){return typeof i===s||"a"+(e<1?"n ":" ")+s}});const YA={};af.transitional=function(s,e,i){function o(c,u){return"[Axios v"+KA+"] Transitional option '"+c+"'"+u+(i?". "+i:"")}return(c,u,h)=>{if(s===!1)throw new ui(o(u," has been removed"+(e?" in "+e:"")),ui.ERR_DEPRECATED);return e&&!YA[u]&&(YA[u]=!0,console.warn(o(u," has been deprecated since v"+e+" and will be removed in the near future"))),!s||s(c,u,h)}};var V_={assertOptions:function(s,e,i){if(typeof s!="object")throw new ui("options must be an object",ui.ERR_BAD_OPTION_VALUE);const o=Object.keys(s);let c=o.length;for(;c-- >0;){const u=o[c],h=e[u];if(h){const _=s[u],m=_===void 0||h(_,u,s);if(m!==!0)throw new ui("option "+u+" must be "+m,ui.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new ui("Unknown option "+u,ui.ERR_BAD_OPTION)}},validators:af};const ja=V_.validators;let ZS=class{constructor(s){this.defaults=s,this.interceptors={request:new DL,response:new DL}}async request(s,e){try{return await this._request(s,e)}catch(i){if(i instanceof Error){let o;Error.captureStackTrace?Error.captureStackTrace(o={}):o=new Error;const c=o.stack?o.stack.replace(/^.+\n/,""):"";i.stack?c&&!String(i.stack).endsWith(c.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+c):i.stack=c}throw i}}_request(s,e){typeof s=="string"?(e=e||{}).url=s:e=s||{},e=x_(this.defaults,e);const{transitional:i,paramsSerializer:o,headers:c}=e;i!==void 0&&V_.assertOptions(i,{silentJSONParsing:ja.transitional(ja.boolean),forcedJSONParsing:ja.transitional(ja.boolean),clarifyTimeoutError:ja.transitional(ja.boolean)},!1),o!=null&&(Yt.isFunction(o)?e.paramsSerializer={serialize:o}:V_.assertOptions(o,{encode:ja.function,serialize:ja.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let u=c&&Yt.merge(c.common,c[e.method]);c&&Yt.forEach(["delete","get","head","post","put","patch","common"],b=>{delete c[b]}),e.headers=Mu.concat(u,c);const h=[];let _=!0;this.interceptors.request.forEach(function(b){typeof b.runWhen=="function"&&b.runWhen(e)===!1||(_=_&&b.synchronous,h.unshift(b.fulfilled,b.rejected))});const m=[];let g;this.interceptors.response.forEach(function(b){m.push(b.fulfilled,b.rejected)});let S,C=0;if(!_){const b=[xL.bind(this),void 0];for(b.unshift.apply(b,h),b.push.apply(b,m),S=b.length,g=Promise.resolve(e);C<S;)g=g.then(b[C++],b[C++]);return g}S=h.length;let I=e;for(C=0;C<S;){const b=h[C++],x=h[C++];try{I=b(I)}catch(D){x.call(this,D);break}}try{g=xL.call(this,I)}catch(b){return Promise.reject(b)}for(C=0,S=m.length;C<S;)g=g.then(m[C++],m[C++]);return g}getUri(s){return np(kL((s=x_(this.defaults,s)).baseURL,s.url),s.params,s.paramsSerializer)}};Yt.forEach(["delete","get","head","options"],function(s){ZS.prototype[s]=function(e,i){return this.request(x_(i||{},{method:s,url:e,data:(i||{}).data}))}}),Yt.forEach(["post","put","patch"],function(s){function e(i){return function(o,c,u){return this.request(x_(u||{},{method:s,headers:i?{"Content-Type":"multipart/form-data"}:{},url:o,data:c}))}}ZS.prototype[s]=e(),ZS.prototype[s+"Form"]=e(!0)});var $S=ZS;class tR{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let i;this.promise=new Promise(function(c){i=c});const o=this;this.promise.then(c=>{if(!o._listeners)return;let u=o._listeners.length;for(;u-- >0;)o._listeners[u](c);o._listeners=null}),this.promise.then=c=>{let u;const h=new Promise(_=>{o.subscribe(_),u=_}).then(c);return h.cancel=function(){o.unsubscribe(u)},h},e(function(c,u,h){o.reason||(o.reason=new id(c,u,h),i(o.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const i=this._listeners.indexOf(e);i!==-1&&this._listeners.splice(i,1)}static source(){let e;return{token:new tR(function(i){e=i}),cancel:e}}}var qA=tR;const zA={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(zA).forEach(([s,e])=>{zA[e]=s});var FL=zA;const As=function s(e){const i=new $S(e),o=RL($S.prototype.request,i);return Yt.extend(o,$S.prototype,i,{allOwnKeys:!0}),Yt.extend(o,i,null,{allOwnKeys:!0}),o.create=function(c){return s(x_(e,c))},o}(M_);As.Axios=$S,As.CanceledError=id,As.CancelToken=qA,As.isCancel=BA,As.VERSION=KA,As.toFormData=Hs,As.AxiosError=ui,As.Cancel=As.CanceledError,As.all=function(s){return Promise.all(s)},As.spread=function(s){return function(e){return s.apply(null,e)}},As.isAxiosError=function(s){return Yt.isObject(s)&&s.isAxiosError===!0},As.mergeConfig=x_,As.AxiosHeaders=Mu,As.formToJSON=s=>qS(Yt.isHTMLForm(s)?new FormData(s):s),As.getAdapter=UL.getAdapter,As.HttpStatusCode=FL,As.default=As;var Ks=As;function eR(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function BL(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?eR(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):eR(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}let nR,iR=0,rR=0;function sR(s,e,i,o){return new ut((c,u)=>{e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),iR+=Gd(e.data)):i&&(e.data.size?iR+=e.data.size:e.data instanceof FormData?iR+=mL(e.data):iR+=Gd(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=s,Ks.request(e).then(h=>{typeof h.data=="string"?rR+=Gd(h.data):h.data instanceof ArrayBuffer||h.data instanceof Uint8Array?rR+=h.data.byteLength:rR+=Gd(JSON.stringify(h.data)),c(h.data)}).catch(h=>{Ks.isCancel(h)?u(new ft(j.OPERATION_ABORTED,"cancel token canceled")):h.code==="ECONNABORTED"?u(new ft(j.NETWORK_TIMEOUT,h.message)):h.response?u(new ft(j.NETWORK_RESPONSE_ERROR,h.response.status)):u(new ft(j.NETWORK_ERROR,h.message))})})}async function sa(s,e){const i=new Blob([e.data],{type:"buffer"});return await sR(s,BL(BL({},e),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const oj=()=>(nR||nR||(nR=(window.location.protocol.split(":")[0]||"").toUpperCase(),nR))==="HTTPS",jL=()=>window.isSecureContext!==void 0,Ga=function(s){if(s.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return s;const e=s.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){const o=e[1],c=e[2];return"".concat(o,".").concat(c)}const i=s.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){const o=i[1],c=i[2];return"".concat(o,".").concat(100*(Number(c)+1))}return"4.0.0.999"}("4.20.2"),JA=function(){try{return JSON.parse("true")===!0}catch{return!0}}();var Uu;(function(s){s.Default="default",s.Auto="auto",s.Relay="relay",s.SdRtn="sd-rtn"})(Uu||(Uu={}));const oR="v4.20.2-0-g8ae7fdad(3/20/2024, 4:48:46 PM)",bs={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function Mn(s,e,i){var o,c;Jt(o=Object.keys(bs)).call(o,s)&&(!i&&Jt(c=Object.keys(Tl)).call(c,s)||(bs[s]=e,s==="ENABLE_VIDEO_SEI"&&e===!0&&(bs.ENABLE_ENCODED_TRANSFORM=!0)))}function Q(s){return bs[s]}const Tl={};function GL(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function re(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?GL(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):GL(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}var Be;(function(s){s.SET_SESSION_ID="SET_SESSION_ID",s.SET_P2P_ID="SET_P2P_id",s.SET_DC_ID="SET_DC_id",s.SET_UID="SET_UID",s.SET_INT_UID="SET_INT_UID",s.SET_PUB_ID="SET_PUB_ID",s.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",s.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",s.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",s.AVOID_JOIN_START="AVOID_JOIN_START",s.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",s.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",s.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",s.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",s.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",s.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",s.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",s.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",s.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",s.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",s.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",s.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",s.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",s.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",s.RESET_KEY_METRICS="RESET_KEY_METRICS",s.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",s.SET_USE_P2P="SET_USE_P2P",s.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE"})(Be||(Be={}));class aj{constructor(e,i,o,c){A(this,"state",void 0),this.state={codec:e,audioCodec:i,mode:o,clientId:c,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:Uu.Default}}dispatch(e){this.state=function(i,o){switch(o.type){case Be.SET_SESSION_ID:return re(re({},i),{},{sessionId:o.sessionId});case Be.SET_P2P_ID:return re(re({},i),{},{p2pId:o.p2pId});case Be.SET_UID:return re(re({},i),{},{uid:o.uid});case Be.SET_INT_UID:return re(re({},i),{},{intUid:o.intUid});case Be.SET_PUB_ID:return re(re({},i),{},{pubId:o.pubId});case Be.KEY_METRIC_CLIENT_CREATED:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{clientCreated:o.metric})});case Be.KEY_METRIC_JOIN_START:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{joinStart:o.metric})});case Be.AVOID_JOIN_START:return re(re({},i),{},{avoidJoinStart:o.avoidJoinStart});case Be.KEY_METRIC_JOIN_END:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{joinEnd:o.metric})});case Be.KEY_METRIC_REQUEST_AP_START:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{requestAPStart:o.metric})});case Be.KEY_METRIC_REQUEST_AP_END:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{requestAPEnd:o.metric})});case Be.KEY_METRIC_JOIN_GATEWAY_START:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{joinGatewayStart:o.metric})});case Be.KEY_METRIC_JOIN_GATEWAY_END:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{joinGatewayEnd:o.metric})});case Be.KEY_METRIC_PEER_CONNECTION_START:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{peerConnectionStart:o.metric})});case Be.KEY_METRIC_PEER_CONNECTION_END:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{peerConnectionEnd:o.metric})});case Be.KEY_METRIC_DESCRIPTION_START:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{descriptionStart:o.metric})});case Be.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{signalChannelOpen:o.metric})});case Be.KEY_METRIC_ICE_CONNECTION_END:return re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{iceConnectionEnd:o.metric})});case Be.KEY_METRIC_PUBLISH:{const c=i.keyMetrics.publish,u=c.findIndex(h=>h.trackId===o.metric.trackId);return u!==-1?(c[u]=re(re({},c[u]),o.metric),re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{publish:[...c]})})):re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{publish:[...i.keyMetrics.publish,o.metric]})})}case Be.KEY_METRIC_SUBSCRIBE:{const c=i.keyMetrics.subscribe,u=c.findIndex(h=>h.userId===o.metric.userId&&h.type===o.metric.type);return u!==-1?(c[u]=re(re({},c[u]),o.metric),re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{subscribe:[...c]})})):re(re({},i),{},{keyMetrics:re(re({},i.keyMetrics),{},{subscribe:[...i.keyMetrics.subscribe,o.metric]})})}case Be.SET_CLOUD_PROXY_SERVER_MODE:return i.cloudProxyServerMode=o.mode,i;case Be.RECORD_JOIN_CHANNEL_SERVICE:return typeof o.index!="number"?i.joinChannelServiceRecords=[...i.joinChannelServiceRecords,o.record]:(i.joinChannelServiceRecords[o.index]=re(re({},i.joinChannelServiceRecords[o.index]),o.record),i.joinChannelServiceRecords=[...i.joinChannelServiceRecords]),i;case Be.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return i.joinChannelServiceRecords=[],i;case Be.RESET_KEY_METRICS:return i.keyMetrics={publish:[],subscribe:[]},i;case Be.SET_USE_DATACHANNEL:return re(re({},i),{},{useDataChannel:o.val});case Be.SET_USE_P2P:return re(re({},i),{},{useP2P:o.val});case Be.SET_TRANSPORT_TYPE:return re(re({},i),{},{p2pTransport:o.val});default:return i}}(this.state,e)}set sessionId(e){this.dispatch({type:Be.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:Be.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:Be.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:Be.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:Be.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:Be.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:Be.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:Be.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:Be.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:Be.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:Be.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Be.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:Be.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Be.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Be.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Be.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Be.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Be.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Be.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:Be.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Be.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Be.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,i,o,c){this.dispatch({type:Be.KEY_METRIC_PUBLISH,metric:re(re({trackId:e,type:i},o&&{publishStart:o}),c&&{publishEnd:c})})}subscribe(e,i,o,c,u,h,_){this.dispatch({type:Be.KEY_METRIC_SUBSCRIBE,metric:re(re(re(re(re({userId:e,type:i},o&&{subscribeStart:o}),c&&{subscribeEnd:c}),u&&{firstFrame:u}),h&&{streamAdded:h}),_&&{firstDecoded:_})})}massSubscribe(e,i,o,c){e.forEach(u=>{this.dispatch({type:Be.KEY_METRIC_SUBSCRIBE,metric:re(re(re({userId:u.userId,type:u.type},i&&{subscribeStart:i}),o&&{subscribeEnd:o}),c&&{firstFrame:c})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,i){e.service==="gateway"&&Array.isArray(e.urls)&&(e.urls=e.urls.map(o=>o.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof i!="number"?(this.dispatch({type:Be.RECORD_JOIN_CHANNEL_SERVICE,record:re(re({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(i<0||i>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Be.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:i}),i)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Be.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Be.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:Be.AVOID_JOIN_START,avoidJoinStart:e})}}var Sl,XA;(function(s){s.h264="h264",s.h265="h265",s.vp8="vp8",s.vp9="vp9",s.av1="av1"})(Sl||(Sl={})),function(s){s.opus="opus",s.pcma="pcma",s.pcmu="pcmu",s.g722="g722"}(XA||(XA={}));const QA=128,cj=96,cf=1e3,ip=10;let WL=0;const Rl=new class extends oi{reportLogUploadError(s){this.emit("REPORT_LOG_UPLOAD",s)}};class dj{constructor(e){A(this,"logger",void 0),A(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];this.logger.debug(...this.prefixLists,...i)}info(){for(var e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];this.logger.info(...this.prefixLists,...i)}warning(){for(var e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];this.logger.warning(...this.prefixLists,...i)}error(){for(var e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];this.logger.error(...this.prefixLists,...i)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function ZA(){const s=new Date;return s.toTimeString().split(" ")[0]+":"+s.getMilliseconds()}function HL(){const s=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+s.getUTCMilliseconds():s.toTimeString().split(" ")[0]+":"+s.getMilliseconds()}const Wa={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},df=Date.now(),uf=s=>{for(const e in Wa)if(Object.prototype.hasOwnProperty.call(Wa,e)&&Wa[e]===s)return e;return"DEFAULT"},O=new class{constructor(){A(this,"proxyServerURL",void 0),A(this,"logLevel",Wa.DEBUG),A(this,"uploadState","collecting"),A(this,"uploadLogWaitingList",[]),A(this,"uploadLogUploadingList",[]),A(this,"uploadErrorCount",0),A(this,"currentLogID",0),A(this,"url",void 0),A(this,"extLog",(s,e)=>{this.appendLogToWaitingList(s,...e)})}debug(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];const o=[Wa.DEBUG].concat(e);this.log.apply(this,o)}info(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];const o=[Wa.INFO].concat(e);this.log.apply(this,o)}warning(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];const o=[Wa.WARNING].concat(e);this.log.apply(this,o)}warn(){this.warning(...arguments)}error(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];const o=[Wa.ERROR].concat(e);this.log.apply(this,o)}upload(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];const o=[Wa.DEBUG].concat(e);this.uploadLog.apply(this,o)}setLogLevel(s){s=Math.min(Math.max(0,s),4),this.logLevel=s}enableLogUpload(){Mn("UPLOAD_LOG",!0)}disableLogUpload(){Mn("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(s){this.proxyServerURL=s}prefix(s){return new dj(this).prefix(s)}log(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];if(Date.now()-df<100)return void setTimeout(()=>{this.log(...e)},Date.now()-df);const o=Math.max(0,Math.min(4,e[0]));if(e[0]=ZA()+" Agora-SDK [".concat(uf(o),"]:"),this.appendLogToWaitingList(o,...e),o<this.logLevel)return;const c=ZA()+" %cAgora-SDK [".concat(uf(o),"]:");let u=[];if(!Q("USE_NEW_LOG"))switch(o){case Wa.DEBUG:u=[c,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,u);break;case Wa.INFO:u=[c,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,u);break;case Wa.WARNING:u=[c,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,u);break;case Wa.ERROR:u=[c,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,u)}}uploadLog(){for(var s=arguments.length,e=new Array(s),i=0;i<s;i++)e[i]=arguments[i];if(Date.now()-df<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-df);const o=Math.max(0,Math.min(4,e[0]));e[0]=ZA()+" Agora-SDK [".concat(uf(o),"]:"),this.appendLogToWaitingList(o,...e)}appendLogToWaitingList(s){if(!Q("UPLOAD_LOG"))return;for(var e=arguments.length,i=new Array(e>1?e-1:0),o=1;o<e;o++)i[o-1]=arguments[o];Array.isArray(i[0])?i[0][0]=HL()+" Agora-SDK [".concat(uf(s),"]:"):i[0]=HL()+" Agora-SDK [".concat(uf(s),"]:");let c="";i.forEach(u=>{typeof u=="object"&&(u=JSON.stringify(u)),c+="".concat(u," ")}),this.uploadLogWaitingList.push({payload_str:c,log_level:s,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const s=this.uploadLogUploadingList,e={sdk_version:Ga,process_id:Q("PROCESS_ID"),payload:JSON.stringify(s)};return ed(async()=>{const i=await Ks.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(Q("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(Q("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(i.data!=="OK"){const o=new Error("unexpected upload log response");throw o.response=i,o}},()=>(this.uploadLogUploadingList=[],!1),i=>(i.response?Rl.reportLogUploadError({status:i.response.status,data:i.response.data,headers:i.response.headers,message:i.message}):i.request?Rl.reportLogUploadError({status:i.request.status,message:i.message}):Rl.reportLogUploadError({status:-1,message:i.message}),!0),{timeout:Q("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:Q("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,Q("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),Q("UPLOAD_LOG_INTERVAL"))}).catch(s=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),Q("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),Q("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var KL,YL;function uj(s){return fs(s.reportId,"params.reportId",0,100,!1),fs(s.category,"params.category",0,100,!1),fs(s.event,"params.event",0,100,!1),fs(s.label,"params.label",0,100,!1),hn(s.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(function(s){s.FREE="free",s.UPLOADING="uploading"})(KL||(KL={})),function(s){s[s.MISC=0]="MISC",s[s.INTERNAL_EVENT=1]="INTERNAL_EVENT",s[s.PUBLIC_EVENT=2]="PUBLIC_EVENT",s[s.WEB_EVENT=3]="WEB_EVENT",s[s.INTERNAL_API=4]="INTERNAL_API",s[s.WEB_API=5]="WEB_API",s[s.PUBLIC_API=6]="PUBLIC_API"}(YL||(YL={}));const qL={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var Rr,ei,$A,zL;function JL(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Le(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?JL(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):JL(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}(function(s){s.PUBLISH="publish",s.SUBSCRIBE="subscribe",s.WS_COMPRESSOR_INIT="ws_compressor_init",s.SESSION_INIT="session_init",s.JOIN_CHOOSE_SERVER="join_choose_server",s.REQ_USER_ACCOUNT="req_user_account",s.JOIN_GATEWAY="join_gateway",s.REJOIN_GATEWAY="rejoin_gateway",s.STREAM_SWITCH="stream_switch",s.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",s.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",s.FIRST_VIDEO_RECEIVED="first_video_received",s.FIRST_AUDIO_RECEIVED="first_audio_received",s.FIRST_VIDEO_DECODE="first_video_decode",s.FIRST_AUDIO_DECODE="first_audio_decode",s.ON_ADD_AUDIO_STREAM="on_add_audio_stream",s.ON_ADD_VIDEO_STREAM="on_add_video_stream",s.ON_UPDATE_STREAM="on_update_stream",s.ON_REMOVE_STREAM="on_remove_stream",s.USER_ANALYTICS="req_user_analytics",s.PC_STATS="pc_stats",s.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities"})(Rr||(Rr={})),function(s){s.SESSION="io.agora.pb.Wrtc.Session",s.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",s.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",s.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",s.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",s.PUBLISH="io.agora.pb.Wrtc.Publish",s.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",s.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",s.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",s.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",s.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",s.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",s.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",s.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",s.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",s.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",s.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",s.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",s.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",s.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",s.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",s.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",s.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",s.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",s.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",s.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",s.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",s.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",s.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",s.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",s.PC_STATS="io.agora.pb.Wrtc.PCStats",s.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities"}(ei||(ei={})),function(s){s[s.WORKER_EVENT=156]="WORKER_EVENT",s[s.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}($A||($A={})),function(s){s[s.SESSION=26]="SESSION",s[s.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",s[s.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",s[s.JOIN_GATEWAY=28]="JOIN_GATEWAY",s[s.PUBLISH=30]="PUBLISH",s[s.SUBSCRIBE=29]="SUBSCRIBE",s[s.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",s[s.STREAM_SWITCH=32]="STREAM_SWITCH",s[s.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",s[s.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",s[s.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",s[s.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",s[s.API_INVOKE=41]="API_INVOKE",s[s.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",s[s.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",s[s.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",s[s.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",s[s.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",s[s.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",s[s.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",s[s.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",s[s.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",s[s.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",s[s.WORKER_EVENT=156]="WORKER_EVENT",s[s.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",s[s.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",s[s.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",s[s.USER_ANALYTICS=1e4]="USER_ANALYTICS",s[s.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(zL||(zL={}));class rp{constructor(){A(this,"baseInfoMap",new Map),A(this,"proxyServer",void 0),A(this,"eventUploadTimer",void 0),A(this,"setSessionIdTimer",void 0),A(this,"url",void 0),A(this,"backupUrl",void 0),A(this,"_appId",void 0),A(this,"keyEventUploadPendingItems",[]),A(this,"normalEventUploadPendingItems",[]),A(this,"apiInvokeUploadPendingItems",[]),A(this,"apiInvokeCount",0),A(this,"ltsList",[]),A(this,"lastSendNormalEventTime",Date.now()),A(this,"customReportCounterTimer",void 0),A(this,"customReportCount",0),A(this,"extApiInvoke",async e=>{for(const i of e){const o=Le(Le({},i),{},{sid:null,invokeId:++this.apiInvokeCount,tag:gi.TRACER});this.sendApiInvoke(o)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),Q("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),Q("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void O.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const i=this.baseInfoMap.get(e),o=Date.now(),c=i.startTime;i.startTime=o,O.debug("rewrite session ".concat(e," startTime: ").concat(o," , ").concat(o-c,"ms")),this.baseInfoMap.set(e,i)}setAppId(e){this._appId=e}reportApiInvoke(e,i,o){i.timeout=i.timeout||6e4,i.reportResult=i.reportResult===void 0||i.reportResult;const c=Date.now();this.apiInvokeCount+=1;const u=this.apiInvokeCount,h=()=>({tag:i.tag,invokeId:u,sid:e,name:i.name,apiInvokeTime:c,options:i.options,states:i.states||null}),_=!!Q("SHOW_REPORT_INVOKER_LOG");_&&O.info("".concat(i.name," start"),i.options);let m=!1;Mr(i.timeout).then(()=>{m||(this.sendApiInvoke(Le(Le({},h()),{},{error:j.API_INVOKE_TIMEOUT,success:!1})),O.debug("".concat(i.name," timeout")))});const g=new ft(j.UNEXPECTED_ERROR,"".concat(i.name,": this api invoke is end"));return{onSuccess:S=>{const C=()=>{if(m)throw g;return m=!0,this.sendApiInvoke(Le(Le({},h()),{},{success:!0},i.reportResult&&{result:S})),_&&O.info("".concat(i.name," onSuccess")),S};return o?TL(C,i.name+"Success",o,()=>m=!0):C()},onError:S=>{const C=()=>{if(m)throw S;m=!0,this.sendApiInvoke(Le(Le({},h()),{},{success:!1,error:S})),_&&O.info("".concat(i.name," onFailure"),S.toString())};return o?TL(C,i.name+"Error",o,()=>m=!0):C()}}}sessionInit(e,i){if(this.baseInfoMap.has(e))return;const o=Date.now(),c=this.createBaseInfo(e,o);c.cname=i.cname;const u=Object.assign({},{willUploadConsoleLog:Q("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:JA?"global":"oversea",areas:Q("AREAS")&&Q("AREAS").join(",")},i.extend),{stringUid:h,channelProfile:_,channelMode:m,isABTestSuccess:g,lsid:S,clientRole:C}=i,I=Date.now(),b=Le(Le({},c),{},{eventType:Rr.SESSION_INIT,appid:i.appid,browser:navigator.userAgent,build:oR,lts:I,elapse:I-o,extend:JSON.stringify(u),mode:i.mode,process:Q("PROCESS_ID"),appType:Q("APP_TYPE"),success:!0,version:Ga,stringUid:h,channelProfile:_,channelMode:m,isABTestSuccess:g,lsid:S,clientType:20,clientRole:C,serviceId:Q("PROCESS_ID"),extensionID:Q("PLUGIN_INFO").join(",")||""});this.send({type:ei.SESSION,data:b},!0)}joinChooseServer(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{eventType:Rr.JOIN_CHOOSE_SERVER,lts:u,eventElapse:u-i.lts,chooseServerAddr:i.csAddr,errorCode:i.ec,elapse:u-o.startTime,success:i.succ,chooseServerAddrList:JSON.stringify(i.serverList),uid:i.uid?parseInt(i.uid):null,cid:i.cid?parseInt(i.cid):null,chooseServerIp:i.csIp||"",opid:i.opid,unilbsServerIds:i.unilbsServerIds,extend:i.extend||void 0,isHttp3:i.isHttp3});this.send({type:ei.JOIN_CHOOSE_SERVER,data:h},!0)}reqUserAccount(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{eventType:Rr.REQ_USER_ACCOUNT,lts:u,success:i.success,serverAddress:i.serverAddr,stringUid:i.stringUid,uid:i.uid,errorCode:i.errorCode,elapse:u-o.startTime,eventElapse:u-i.lts,extend:JSON.stringify(i.extend)});this.send({type:ei.REQ_USER_ACCOUNT,data:h},!0)}joinGateway(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info;i.vid&&(c.vid=i.vid),c.uid=i.uid,c.cid=i.cid;const u=Date.now(),{firstSuccess:h,avoidJoinStartTime:_,isProxy:m,addr:g}=i,S=u-(h&&_?_:o.startTime),C=Le(Le({},c),{},{eventType:Rr.JOIN_GATEWAY,lts:u,gatewayAddr:i.addr,success:i.succ,errorCode:i.ec,elapse:S,eventElapse:u-i.lts,firstSuccess:h,signalChannel:i.signalChannel}),I=C.success?1:0;if(i.succ&&(o.lastJoinSuccessTime=u),h)this.send({type:ei.JOIN_GATEWAY,data:C},!0);else{let b;if(g)if(m){const D=g.match(/h=(\d{1,3}-){3}\d{1,3}/g),M=g.match(/p=[0-9]{1,6}/g);b={isSuccess:I,gatewayIp:D&&D.length?D[0].split("=")[1].replace(/-/g,"."):"",port:M&&M.length?M[0].split("=")[1]:"",isProxy:m?1:0}}else{const D=g.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),M=g.match(/(:|p=)[0-9]{1,6}/g);b={isSuccess:I,gatewayIp:D&&D.length?D[0].split("//")[1].replace(/-/g,"."):"",port:M&&M.length?M[0].split(/:|p=/g)[1]:"",isProxy:m?1:0}}else b={isSuccess:I,gatewayIp:"",port:"",isProxy:m?1:0};delete C.success,delete C.eventType,delete C.firstSuccess,C.vid=Number(C.vid);const x=Object.assign({},C,b,{eventType:Rr.REJOIN_GATEWAY});this.send({type:ei.RE_JOIN_GATEWAY,data:x},!0)}}joinChannelTimeout(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=Date.now(),u=Le(Le({},o.info),{},{lts:c,timeout:i,elapse:c-o.startTime});this.send({type:ei.JOIN_CHANNEL_TIMEOUT,data:u},!0)}publish(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{eventType:Rr.PUBLISH,lts:u,eventElapse:i.eventElapse,elapse:u-o.startTime,success:i.succ,errorCode:i.ec,videoName:i.videoName,audioName:i.audioName,screenName:i.screenName,screenshare:i.screenshare,audio:i.audio,video:i.video,p2pid:i.p2pid,publishRequestid:i.publishRequestid});this.send({type:ei.PUBLISH,data:h},!0)}subscribe(e,i,o){const c=this.baseInfoMap.get(e);if(!c)return;const u=c.info,h=Date.now(),_=Le(Le({},u),{},{eventType:Rr.SUBSCRIBE,lts:h,eventElapse:i.eventElapse,elapse:h-c.startTime,success:i.succ,errorCode:i.ec,video:i.video,audio:i.audio,subscribeRequestid:i.subscribeRequestid,p2pid:i.p2pid},o&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof i.peerid=="string"?_.peerSuid=i.peerid:_.peer=i.peerid,this.send({type:ei.SUBSCRIBE,data:_},!0)}wsCompressorInit(e){var i;const o=[...lo(i=this.baseInfoMap).call(i)],c=o.length?o[0]:"UnableToGetSid",u=this.baseInfoMap.get(c);if(!u)return;const h=u.info,_=Date.now(),m=Le(Le({},h),{},{eventType:Rr.WS_COMPRESSOR_INIT,lts:_,eventElapse:e.eventElapse,elapse:_-u.startTime,status:e.status?1:2});this.send({type:ei.WS_COMPRESSOR_INIT,data:m},!0)}firstRemoteVideoDecode(e,i,o,c){const u=this.baseInfoMap.get(e);if(!u)return;const h=u.info,_=Date.now(),m=Le(Le(Le({},h),c),{},{elapse:_-u.startTime,eventType:i,lts:_,firstDecodeFrame:Math.max(_-u.startTime,0),apEnd:Math.max(c.apEnd-u.startTime,0),apStart:Math.max(c.apStart-u.startTime,0),joinGwEnd:Math.max(c.joinGwEnd-u.startTime,0),joinGwStart:Math.max(c.joinGwStart-u.startTime,0),pcEnd:Math.max(c.pcEnd-u.startTime,0),pcStart:Math.max(c.pcStart-u.startTime,0),subscriberEnd:Math.max(c.subscriberEnd-u.startTime,0),subscriberStart:Math.max(c.subscriberStart-u.startTime,0),videoAddNotify:Math.max(c.videoAddNotify-u.startTime,0)});this.send({type:o,data:m},!0)}firstRemoteFrame(e,i,o,c){const u=this.baseInfoMap.get(e);if(!u)return;const h=u.info,_=Date.now(),m=Le(Le(Le({},h),c),{},{elapse:_-u.startTime,eventType:i,lts:_});this.send({type:o,data:m},!0)}pcStats(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le(Le({},c),i),{},{vid:c.vid===void 0?0:Number(c.vid),elapse:u-o.startTime,eventType:Rr.PC_STATS,lts:u});this.send({type:ei.PC_STATS,data:h},!0)}updateRemoteRTPCapabilities(e,i){if(e){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le(Le({},c),i),{},{vid:c.vid===void 0?0:Number(c.vid),eventType:Rr.UPDATE_REMOTE_RTPCAPABILITIES,lts:u});this.send({type:ei.UPDATE_REMOTE_RTPCAPABILITIES,data:h},!0)}}onGatewayStream(e,i,o,c){const u=this.baseInfoMap.get(e);if(!u)return;const h=u.info,_=Date.now(),m=Le(Le(Le({},h),c),{},{eventType:i,lts:_});this.send({type:o,data:m},!0)}streamSwitch(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{eventType:Rr.STREAM_SWITCH,lts:u,isDual:i.isdual,elapse:u-o.startTime,success:i.succ});this.send({type:ei.STREAM_SWITCH,data:h},!0)}requestProxyAppCenter(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{eventType:Rr.REQUEST_PROXY_APPCENTER,lts:u,eventElapse:u-i.lts,elapse:u-o.startTime,APAddr:i.APAddr,workerManagerList:i.workerManagerList,response:i.response,errorCode:i.ec,success:i.succ});this.send({type:ei.REQUEST_PROXY_APPCENTER,data:h},!0)}requestProxyWorkerManager(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{eventType:Rr.REQUEST_PROXY_WORKER_MANAGER,lts:u,eventElapse:u-i.lts,elapse:u-o.startTime,workerManagerAddr:i.workerManagerAddr,response:i.response,errorCode:i.ec,success:i.succ});this.send({type:ei.REQUEST_PROXY_WORKER_MANAGER,data:h},!0)}setProxyServer(e){this.proxyServer=e,e?O.debug("reportProxyServerurl: ".concat(e)):O.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le({},c),{},{subscribeElapse:i.subscribeElapse,peer:i.peer,peerPublishDuration:Math.max(i.audioPublishDuration,i.videoPublishDuration),audiotag:i.audioPublishDuration>0?1:-1,videotag:i.videoPublishDuration>0?1:-1,lts:u,elapse:u-o.startTime,joinChannelSuccessElapse:u-(o.lastJoinSuccessTime||u),peerPublishDurationVideo:i.videoPublishDuration,peerPublishDurationAudio:i.audioPublishDuration});this.send({type:ei.PEER_PUBLISH_STATUS,data:h},!0)}workerEvent(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now();(function(_,m,g){const S=_[m];if(!S||typeof S!="string")return[_];_[m]="";const C=Gd(JSON.stringify(_));let I=0;const b=[];let x=0;for(let D=0;D<S.length;D++)x+=S.charCodeAt(D)<=127?1:3,x<=g-C||(b[b.length]=ra(ra({},_),{},{[m]:S.substring(I,D)}),I=D,x=S.charCodeAt(D)<=127?1:3);return I!==S.length-1&&(b[b.length]=ra(ra({},_),{},{[m]:S.substring(I)})),b})(Le(Le(Le({},c),i),{},{elapse:u-o.startTime,lts:u,productType:"WebRTC"}),"payload",1300).forEach(_=>this.send({type:ei.WORKER_EVENT,data:_},!0))}apworkerEvent(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le(Le({},c),i),{},{elapse:u-o.startTime,lts:u});this.send({type:ei.AP_WORKER_EVENT,data:h},!0)}joinWebProxyAP(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le(Le({},c),i),{},{elapse:u-o.startTime,lts:u,extend:i.extend||void 0});this.send({type:ei.JOIN_WEB_PROXY_AP,data:h},!0)}WebSocketQuit(e,i){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),h=Le(Le(Le({},c),i),{},{elapse:u-o.startTime,lts:u});this.send({type:ei.WEBSOCKET_QUIT,data:h},!0)}async sendCustomReportMessage(e,i){if(this.customReportCount+=i.length,this.customReportCount>Q("CUSTOM_REPORT_LIMIT"))throw new ft(j.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const o=Date.now(),c=i.map(u=>({type:ei.USER_ANALYTICS,data:Le(Le({sid:e},u),{},{lts:o})}));try{Q("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(c):await this.postDataToStatsCollector(c)}catch(u){throw O.error("send custom report message failed",u.toString()),new ft(j.CUSTOM_REPORT_SEND_FAILED,u.message)}}sendApiInvoke(e){const i=Q("NOT_REPORT_EVENT");if(e.tag&&Jt(i)&&Jt(i).call(i,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const o=this.baseInfoMap.get(e.sid);if(!o)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:c,uid:u,cid:h}=o.info;let _;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof ft){const{code:g,message:S}=e.error;_=g||S||e.error.toString()}else _=e.error.toString();const m={invokeId:e.invokeId,sid:e.sid,cname:c,cid:h,uid:u,lts:e.lts,success:e.success,elapse:e.lts-o.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?_:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:ei.API_INVOKE,data:m},!1),!0}appendSessionId(){rp.__CLIENT_LIST__.forEach(e=>{if(e._sessionId){const i=this.apiInvokeUploadPendingItems.length;for(let o=0;o<i;o++){const c=this.apiInvokeUploadPendingItems.shift();c&&(c.sid=e._sessionId,this.sendApiInvoke(Object.assign({},c)))}}})}send(e,i){if(i)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>Q("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,i){const o=[],c=[];for(;e.length;){const h=e.shift();o.length<20?o.push(h):c.push(h)}e.push(...c);for(const h of[...o]){var u;this.ltsList.indexOf(h.data.lts)!==-1?(h.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(h.data.lts)):(this.ltsList.push(h.data.lts),l_(u=this.ltsList).call(u,(_,m)=>_-m))}return i||(this.lastSendNormalEventTime=Date.now()),Q("ENABLE_EVENT_REPORT")&&o.length&&(Q("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(o):this.postDataToStatsCollector(o)).catch((h=>_=>{Q("EVENT_REPORT_RETRY")&&(i?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(h):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(h),this.normalEventUploadPendingItems.length>Q("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-Q("NORMAL_EVENT_QUEUE_CAPACITY")),O.warning("report: drop normal events"))))})(o)),e}async postDataToStatsCollector2(e){er.networkState===Ds.OFFLINE&&await ut.race([er.onlineWaiter,Mr(2*nr.maxRetryTimeout)]);const i=u=>{let h=new Uint8Array;return u.forEach(_=>{const m=Qm(JSON.stringify(_.data)),g=new ArrayBuffer(5),S=(I=>{let b=0;return Object.entries(ei).forEach(x=>{let[D,M]=x;M===I.type&&(b=EventNameToID[D])}),b})(_),C=new DataView(g);C.setUint16(0,m.byteLength,!0),C.setUint8(2,255&S),C.setUint8(3,S>>>8&255),C.setUint8(4,S>>>16&255),h=yA(h,new Uint8Array(g)),h=yA(h,m)}),h},o="event";let c=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Q("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(o):"https://".concat(Q("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(o);for(let u=0;u<2;u+=1){u===1&&(c=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Q("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(o):"https://".concat(Q("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(o));try{await sR(c,{timeout:1e4,data:i(e),headers:Le(Le({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(h){if(u===1)throw h;continue}return}}async postDataToStatsCollector(e){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const o={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(h=>JSON.stringify(h)),vid:(h=>{const _=h&&h.data.sid&&this.baseInfoMap.get(h.data.sid);return _&&_.info.vid&&+_.info.vid||0})(e[0])};er.networkState===Ds.OFFLINE&&await ut.race([er.onlineWaiter,Mr(2*nr.maxRetryTimeout)]);const c=i?"/events/proto-raws":"/events/messages";let u=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Q("EVENT_REPORT_DOMAIN"),"&p=").concat(Q("STATS_COLLECTOR_PORT"),"&d=").concat(c):"https://".concat(Q("EVENT_REPORT_DOMAIN"),":").concat(Q("STATS_COLLECTOR_PORT")).concat(c));for(let h=0;h<2;h+=1){h===1&&(u=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Q("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(Q("STATS_COLLECTOR_PORT"),"&d=").concat(c):"https://".concat(Q("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(Q("STATS_COLLECTOR_PORT")).concat(c)));try{i?await sa(u,{timeout:1e4,data:o}):await sR(u,{timeout:1e4,data:o})}catch(_){if(h===1)throw _;continue}return}}createBaseInfo(e,i){const o=Object.assign({},qL);return o.sid=e,this.baseInfoMap.set(e,{info:o,startTime:i}),o}reportResourceTiming(e,i){const o=performance.getEntriesByName(e),c=o[o.length-1];c&&this.reportApiInvoke(i,{name:"Client.resourceTiming",options:c,tag:gi.TRACER}).onSuccess()}}function ce(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,i,o){const c=o.value;if(typeof c=="function"){const u=s.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);o.value=function(){for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];let g=_;if(s.argsMap)try{g=s.argsMap(this,..._)}catch(C){O.warning(C),g=[]}try{JSON.stringify(g)}catch{O.warning("arguments for method ".concat(u,".").concat(String(i)," not serializable for apiInvoke.")),g=[]}const S=(s.report||ne).reportApiInvoke(this._sessionId||null,{name:"".concat(u,".").concat(String(i)),options:g,tag:gi.TRACER,reportResult:s.reportResult},s.throttleTime);try{const C=c.apply(this,_);return C instanceof ut?C.then(I=>(S.onSuccess(s.reportResult&&I),I)).catch(I=>{throw S.onError(I),I}):(S.onSuccess(s.reportResult&&C),C)}catch(C){throw S.onError(C),C}}}return o}}A(rp,"__CLIENT_LIST__",[]);const ne=new rp;Rl.on("REPORT_LOG_UPLOAD",s=>{s.networkState=er.networkState,ne.reportApiInvoke(null,{name:"logUploadError",options:s,tag:gi.TRACER})});const lj=["CHINA","GLOBAL"],Ps=function(){const s="us".concat("erna","me"),e="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const o=i.join(""),c=[];for(let _=0;_<6;_++)c.push("1");const u=c.join(""),h={};return h[s]=o,h[e]=u,Object.assign(h,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Ps,JA||(bs.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],bs.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],bs.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],bs.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],bs.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],bs.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],bs.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",bs.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",bs.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",bs.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",bs.AREAS=["NORTH_AMERICA","OVERSEA"]);const XL=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Cl=[];function sp(s,e){return!!e&&Cl.some(i=>i.uid===s&&i.channelName===e)}rp.__CLIENT_LIST__=Cl;var lf,po,F_,B_,_o,ns,ae,Me,Gt,ie,rd,Re,Sc,is,Se,ki,xu,aR=al("Array").values,QL=cl,ZL=Zn,hj=le,pj=aR,cR=Array.prototype,$L={DOMTokenList:!0,NodeList:!0},Rc=Rt(function(s){var e=s.values;return s===cR||hj(cR,s)&&e===cR.values||ZL($L,QL(s))?pj:e});function Tt(s,e,i,o){var c,u=arguments.length,h=u<3?e:o===null?o=Object.getOwnPropertyDescriptor(e,i):o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")h=Reflect.decorate(s,e,i,o);else for(var _=s.length-1;_>=0;_--)(c=s[_])&&(h=(u<3?c(h):u>3?c(e,i,h):c(e,i))||h);return u>3&&h&&Object.defineProperty(e,i,h),h}function V(s,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(s,e)}(function(s){s.L1T1="L1T1",s.L1T2="L1T2",s.L1T3="L1T3",s.L2T1_KEY="L2T1_KEY",s.L2T2_KEY="L2T2_KEY",s.L2T3_KEY="L2T3_KEY",s.L3T1_KEY="L3T1_KEY",s.L3T2_KEY="L3T2_KEY",s.L3T3_KEY="L3T3_KEY"})(lf||(lf={})),function(s){s.CERTIFICATE="certificate",s.CODEC="codec",s.CANDIDATE_PAIR="candidate-pair",s.LOCAL_CANDIDATE="local-candidate",s.REMOTE_CANDIDATE="remote-candidate",s.INBOUND="inbound-rtp",s.TRACK="track",s.OUTBOUND="outbound-rtp",s.PC="peer-connection",s.REMOTE_INBOUND="remote-inbound-rtp",s.REMOTE_OUTBOUND="remote-outbound-rtp",s.TRANSPORT="transport",s.CSRC="csrc",s.DATA_CHANNEL="data-channel",s.STREAM="stream",s.SENDER="sender",s.RECEIVER="receiver"}(po||(po={})),function(s){s[s.ACCESS_POINT=101]="ACCESS_POINT",s[s.UNILBS=201]="UNILBS",s[s.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(F_||(F_={})),function(s){s[s.IIIEGAL_APPID=1]="IIIEGAL_APPID",s[s.IIIEGAL_UID=2]="IIIEGAL_UID",s[s.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(B_||(B_={})),function(s){s[s.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",s[s.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",s[s.INTERNAL_ERROR=8]="INTERNAL_ERROR",s[s.NO_AUTHORIZED=9]="NO_AUTHORIZED",s[s.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",s[s.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",s[s.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",s[s.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",s[s.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",s[s.USER_OVERLOAD=16]="USER_OVERLOAD",s[s.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",s[s.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(_o||(_o={})),function(s){s[s.NO_FLAG_SET=100]="NO_FLAG_SET",s[s.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",s[s.INVALID_FALG_SET=102]="INVALID_FALG_SET",s[s.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",s[s.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",s[s.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",s[s.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",s[s.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",s[s.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",s[s.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",s[s.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",s[s.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",s[s.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",s[s.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",s[s.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",s[s.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",s[s.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",s[s.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",s[s.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(ns||(ns={})),function(s){s[s.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",s[s.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",s[s.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",s[s.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",s[s.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",s[s.K_TICKET_INVALID=7]="K_TICKET_INVALID",s[s.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",s[s.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",s[s.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",s[s.K_UID_BANNED=14]="K_UID_BANNED",s[s.K_IP_BANNED=15]="K_IP_BANNED",s[s.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",s[s.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",s[s.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",s[s.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",s[s.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",s[s.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",s[s.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",s[s.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",s[s.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",s[s.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",s[s.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",s[s.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",s[s.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",s[s.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",s[s.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",s[s.ERR_INVALID_UID=117]="ERR_INVALID_UID",s[s.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",s[s.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",s[s.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",s[s.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",s[s.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",s[s.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",s[s.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",s[s.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",s[s.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",s[s.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",s[s.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",s[s.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",s[s.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",s[s.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",s[s.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",s[s.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",s[s.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",s[s.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",s[s.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",s[s.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",s[s.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",s[s.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",s[s.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",s[s.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",s[s.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",s[s.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",s[s.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",s[s.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",s[s.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",s[s.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",s[s.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",s[s.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",s[s.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",s[s.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",s[s.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",s[s.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",s[s.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(ae||(ae={})),function(s){s.CONNECTING="connecting",s.CONNECTED="connected",s.RECONNECTING="reconnecting",s.CLOSED="closed"}(Me||(Me={})),function(s){s.WS_CONNECTED="ws_connected",s.WS_RECONNECTING="ws_reconnecting",s.WS_CLOSED="ws_closed",s.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",s.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",s.ON_BINARY_DATA="on_binary_data",s.REQUEST_RECOVER="request_recover",s.REQUEST_JOIN_INFO="request_join_info",s.REQUEST_REJOIN_INFO="req_rejoin_info",s.IS_P2P_DISCONNECTED="is_p2p_dis",s.DISCONNECT_P2P="dis_p2p",s.ABORT_P2P_EXECUTION="abort_p2p_execution",s.NEED_RENEW_SESSION="need-sid",s.REPORT_JOIN_GATEWAY="report_join_gateway",s.REQUEST_TIMEOUT="request_timeout",s.REQUEST_SUCCESS="request_success",s.JOIN_RESPONSE="join_response",s.DATACHANNEL_PRECONNECT="datachannel_preconnect",s.DATACHANNEL_CONNECTING="datachannel_connecting",s.DATACHANNEL_FAILBACK="datachannel_failback",s.P2P_CONNECTION="p2p_connection",s.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",s.P2P_SUBSCRIBE="p2p_subscribe",s.P2P_UNSUBSCRIBE="p2p_unsubscribe",s.P2P_EXCHANGE_SDP="p2p_exchange_sdp",s.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",s.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(Gt||(Gt={})),function(s){s.PING="ping",s.PING_BACK="ping_back",s.JOIN="join_v3",s.REJOIN="rejoin_v3",s.LEAVE="leave",s.SET_CLIENT_ROLE="set_client_role",s.PUBLISH="publish",s.PUBLISH_DATASTREAM="publish_datastream",s.UNPUBLISH="unpublish",s.UNPUBLISH_DATASTREAM="unpublish_datastream",s.SUBSCRIBE="subscribe",s.PRE_SUBSCRIBE="pre_subscribe",s.SUBSCRIBE_DATASTREAM="subscribe_datastream",s.SUBSCRIBE_STREAMS="subscribe_streams",s.UNSUBSCRIBE="unsubscribe",s.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",s.UNSUBSCRIBE_STREAMS="unsubscribe_streams",s.SUBSCRIBE_CHANGE="subscribe_change",s.TRAFFIC_STATS="traffic_stats",s.RENEW_TOKEN="renew_token",s.SWITCH_VIDEO_STREAM="switch_video_stream",s.DEFAULT_VIDEO_STREAM="default_video_stream",s.SET_FALLBACK_OPTION="set_fallback_option",s.GATEWAY_INFO="gateway_info",s.CONTROL="control",s.SEND_METADATA="send_metadata",s.DATA_STREAM="data_stream",s.PICK_SVC_LAYER="pick_svc_layer",s.RESTART_ICE="restart_ice",s.CONNECT_PC="connect_pc",s.SET_VIDEO_PROFILE="set_video_profile",s.SET_PARAMETER="set_parameter",s.SET_RTM2_FLAG="set_rtm2_flag"}(ie||(ie={})),function(s){s.WRTC_STATS="wrtc_stats",s.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",s.DENOISER_STATS="denoiser_stats",s.EXTENSION_USAGE_STATS="extension_usage_stats"}(rd||(rd={})),function(s){s.ON_USER_ONLINE="on_user_online",s.ON_USER_OFFLINE="on_user_offline",s.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",s.ON_PUBLISH_STREAM="on_publish_stream",s.ON_UPLINK_STATS="on_uplink_stats",s.ON_P2P_LOST="on_p2p_lost",s.ON_REMOVE_STREAM="on_remove_stream",s.ON_ADD_AUDIO_STREAM="on_add_audio_stream",s.ON_ADD_VIDEO_STREAM="on_add_video_stream",s.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",s.ON_USER_BANNED="on_user_banned",s.ON_USER_LICENSE_BANNED="on_user_license_banned",s.ON_NOTIFICATION="on_notification",s.ON_CRYPT_ERROR="on_crypt_error",s.MUTE_AUDIO="mute_audio",s.MUTE_VIDEO="mute_video",s.UNMUTE_AUDIO="unmute_audio",s.UNMUTE_VIDEO="unmute_video",s.ON_P2P_OK="on_p2p_ok",s.RECEIVE_METADATA="receive_metadata",s.ON_DATA_STREAM="on_data_stream",s.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",s.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",s.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",s.ENABLE_LOCAL_VIDEO="enable_local_video",s.DISABLE_LOCAL_VIDEO="disable_local_video",s.ENABLE_LOCAL_AUDIO="enable_local_audio",s.DISABLE_LOCAL_AUDIO="disable_local_audio",s.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Re||(Re={})),function(s){s.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",s.NEED_ANSWER="NEED_ANSWER",s.NEED_RENEGOTIATE="NEED_RENEGOTIATE",s.P2P_LOST="P2P_LOST",s.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",s.NEED_UNPUB="NEED_UNPUB",s.NEED_UNSUB="NEED_UNSUB",s.NEED_UPLOAD="NEED_UPLOAD",s.NEED_CONTROL="NEED_CONTROL",s.START_RECONNECT="START_RECONNECT",s.END_RECONNECT="END_RECONNECT",s.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(Sc||(Sc={})),function(s){s.SEND_ONLY="SEND_ONLY",s.RECEIVE_ONLY="RECEIVE_ONLY"}(is||(is={})),function(s){s.CONNECTED="websocket:connected",s.RECONNECTING="websocket:reconnecting",s.WILL_RECONNECT="websocket:will_reconnect",s.CLOSED="websocket:closed",s.FAILED="websocket:failed",s.ON_MESSAGE="websocket:on_message",s.REQUEST_NEW_URLS="websocket:request_new_urls",s.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",s.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(Se||(Se={}));class st extends ft{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),A(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,O)}throw(){super.throw(O)}}function tb(s){if(typeof s!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(s))throw O.error("Invalid Channel Name ".concat(s)),new st(j.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function eb(s){if(e=s,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||b_(s,1,255)))throw new st(j.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof s=="string"&&O.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}(function(s){s.TRANSCODE="mix_streaming",s.RAW="raw_streaming",s.INJECT="inject_streaming"})(ki||(ki={})),function(s){s[s.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",s[s.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",s[s.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",s[s.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",s[s.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",s[s.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",s[s.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",s[s.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",s[s.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",s[s.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",s[s.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(xu||(xu={}));const _j={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},nb={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function ib(s,e){fs(s.url,"".concat(e,".url"),1,1e3,!1),xn(s.x)||hn(s.x,"".concat(e,".x"),0,1e4),xn(s.y)||hn(s.y,"".concat(e,".y"),0,1e4),xn(s.width)||hn(s.width,"".concat(e,".width"),0,1e4),xn(s.height)||hn(s.height,"".concat(e,".height"),0,1e4),xn(s.zOrder)||hn(s.zOrder,"".concat(e,".zOrder"),0,255),xn(s.alpha)||hn(s.alpha,"".concat(e,".alpha"),0,1,!1)}const rb={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},tk={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var Cc,vl,vi,oa,Ae,aa,ws,Kd,rn,Ni,op,dr,hf,tn;function sb(s){if(!s.channelName)throw new st(j.INVALID_PARAMS,"invalid channelName in info");if(typeof s.uid!="number")throw new st(j.INVALID_PARAMS,"invalid uid in info, uid must be a number");return s.token&&fs(s.token,"info.token",1,2047),eb(s.uid),tb(s.channelName),!0}(function(s){s.WARNING="@live_uap-warning",s.ERROR="@line_uap-error",s.PUBLISH_STREAM_STATUS="@live_uap-publish-status",s.INJECT_STREAM_STATUS="@live_uap-inject-status",s.WORKER_STATUS="@live_uap-worker-status",s.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(Cc||(Cc={})),function(s){s.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(vl||(vl={})),function(s){s[s.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",s[s.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",s[s.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",s[s.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",s[s.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",s[s.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",s[s.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",s[s.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",s[s.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",s[s.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",s[s.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",s[s.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",s[s.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",s[s.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",s[s.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",s[s.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",s[s.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",s[s.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",s[s.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",s[s.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",s[s.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(vi||(vi={})),function(s){s.CONNECT_FAILED="connect failed",s.CONNECT_TIMEOUT="connect timeout",s.WS_DISCONNECTED="websocket disconnected",s.REQUEST_TIMEOUT="request timeout",s.REQUEST_FAILED="request failed",s.WAIT_STATUS_TIMEOUT="wait status timeout",s.WAIT_STATUS_ERROR="wait status error",s.BAD_STATE="bad state",s.WS_ABORT="ws abort",s.AP_REQUEST_TIMEOUT="AP request timeout",s.AP_JSON_PARSE_ERROR="AP json parse error",s.AP_REQUEST_ERROR="AP request error",s.AP_REQUEST_ABORT="AP request abort"}(oa||(oa={})),function(s){s[s.SetSdkProfile=0]="SetSdkProfile",s[s.SetSourceChannel=1]="SetSourceChannel",s[s.SetSourceUserId=2]="SetSourceUserId",s[s.SetDestChannel=3]="SetDestChannel",s[s.StartPacketTransfer=4]="StartPacketTransfer",s[s.StopPacketTransfer=5]="StopPacketTransfer",s[s.UpdateDestChannel=6]="UpdateDestChannel",s[s.Reconnect=7]="Reconnect",s[s.SetVideoProfile=8]="SetVideoProfile"}(Ae||(Ae={})),function(s){s.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",s.NETWORK_CONNECTED="NETWORK_CONNECTED",s.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",s.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",s.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",s.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",s.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",s.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",s.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",s.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(aa||(aa={})),function(s){s.RELAY_STATE_IDLE="RELAY_STATE_IDLE",s.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",s.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",s.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(ws||(ws={})),function(s){s.RELAY_OK="RELAY_OK",s.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",s.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",s.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(Kd||(Kd={})),function(s){s.High="high",s.Low="low",s.Audio="audio",s.Screen="screen",s.ScreenLow="screen_low"}(rn||(rn={})),function(s){s.DISCONNECT="disconnect",s.CONNECTION_STATE_CHANGE="connection-state-change",s.NETWORK_QUALITY="network-quality",s.STREAM_TYPE_CHANGE="stream-type-change",s.IS_P2P_DISCONNECTED="is-p2p-dis",s.DISCONNECT_P2P="dis-p2p",s.REQUEST_NEW_GATEWAY_LIST="req-gate-url",s.NEED_RENEW_SESSION="need-sid",s.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",s.JOIN_RESPONSE="join-response",s.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",s.RESET_CONNECTION_EVENTS="reset-connection-events",s.DATACHANNEL_PRECONNECT="datachannel_preconnect",s.DATACHANNEL_FAILBACK="datachannel_failback",s.RESET_SIGNAL="reset-signal"}(Ni||(Ni={})),function(s){s.P2P_DISCONNECTED="P2P_DISCONNECTED",s.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",s.TIMEOUT="TIMEOUT",s.UNKNOWN_REASON="UNKNOWN_REASON"}(op||(op={})),function(s){s[s.Nothing=0]="Nothing",s[s.Audio=1]="Audio",s[s.LwoVideo=2]="LwoVideo",s[s.Video=4]="Video",s[s.Data=8]="Data",s[s.DataStream0=256]="DataStream0",s[s.DataStream1=512]="DataStream1",s[s.DataStream2=1024]="DataStream2",s[s.DataStream3=2048]="DataStream3",s[s.DataStream4=4096]="DataStream4",s[s.DataStream5=8192]="DataStream5",s[s.DataStream6=16384]="DataStream6",s[s.DataStream7=32768]="DataStream7"}(dr||(dr={})),function(s){s[s.websocket=0]="websocket",s[s.datachannel=1]="datachannel"}(hf||(hf={})),function(s){s.CHINA="CHINA",s.ASIA="ASIA",s.NORTH_AMERICA="NORTH_AMERICA",s.EUROPE="EUROPE",s.JAPAN="JAPAN",s.INDIA="INDIA",s.KOREA="KOREA",s.HKMC="HKMC",s.US="US",s.OCEANIA="OCEANIA",s.SOUTH_AMERICA="SOUTH_AMERICA",s.AFRICA="AFRICA",s.OVERSEA="OVERSEA",s.GLOBAL="GLOBAL",s.EXTENSIONS="EXTENSIONS"}(tn||(tn={}));const pf=[tn.AFRICA,tn.ASIA,tn.CHINA,tn.EUROPE,tn.GLOBAL,tn.INDIA,tn.JAPAN,tn.NORTH_AMERICA,tn.OCEANIA,tn.OVERSEA,tn.SOUTH_AMERICA];var Ur;(function(s){s.CHINA="CN",s.ASIA="AS",s.NORTH_AMERICA="NA",s.EUROPE="EU",s.JAPAN="JP",s.INDIA="IN",s.KOREA="KR",s.HKMC="HK",s.US="US",s.OCEANIA="OC",s.SOUTH_AMERICA="SA",s.AFRICA="AF",s.OVERSEA="OVERSEA",s.GLOBAL="GLOBAL",s.EXTENSIONS="GLOBAL"})(Ur||(Ur={}));const dR={CHINA:{},ASIA:{CODE:Ur.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Ur.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Ur.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Ur.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Ur.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Ur.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Ur.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Ur.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Ur.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Ur.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Ur.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Ur.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Ur.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var j_,ob,Xt,Wr,ca,yt,En,_e,uR,Mo,da,ur,vc,Mi,Ha,lR,Eo,Uo,xo,li,sd,Ic,ek,_f;JA&&(dR.CHINA={CODE:Ur.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(s){s.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(j_||(j_={}));class nk extends oi{constructor(e,i){super(),A(this,"onICEConnectionStateChange",void 0),A(this,"onConnectionStateChange",void 0),A(this,"onDTLSTransportStateChange",void 0),A(this,"onDTLSTransportError",void 0),A(this,"onICETransportStateChange",void 0),A(this,"onFirstAudioReceived",void 0),A(this,"onFirstVideoReceived",void 0),A(this,"onFirstAudioDecoded",void 0),A(this,"onFirstVideoDecoded",void 0),A(this,"onFirstVideoDecodedTimeout",void 0),A(this,"onSelectedLocalCandidateChanged",void 0),A(this,"onSelectedRemoteCandidateChanged",void 0)}}class Hr extends nk{constructor(e,i){super(e,i)}}(function(s){s.SEND="sendonly",s.RECV="recvonly",s.SENDRECV="sendrecv",s.INACTIVE="inactive"})(ob||(ob={})),function(s){s.VIDEO="video",s.AUDIO="audio"}(Xt||(Xt={})),function(s){s[s.UDP=0]="UDP",s[s.TCP=1]="TCP",s[s.RELAY=2]="RELAY"}(Wr||(Wr={})),function(s){s[s.FIRST_CONNECTION=0]="FIRST_CONNECTION",s[s.TCP_RESTART=1]="TCP_RESTART",s[s.RELAY_RESTART=2]="RELAY_RESTART",s[s.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",s[s.OLD_RESTART=11]="OLD_RESTART",s[s.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(ca||(ca={})),function(s){s.LocalVideoTrack="videoTrack",s.LocalAudioTrack="audioTrack",s.LocalVideoLowTrack="videoLowTrack"}(yt||(yt={})),function(s){s.New="new",s.Connected="connected",s.Reconnecting="reconnecting",s.Disconnected="disconnected"}(En||(En={})),function(s){s.StateChange="stateChange",s.IceConnectionStateChange="iceConnectionStateChange",s.RequestMuteLocal="requestMuteLocal",s.RequestUnmuteLocal="requestUnmuteLocal",s.RequestRePublish="requestRePublish",s.RequestRePublishDataChannel="requestRePublishDataChannel",s.RequestReSubscribe="requestReSubscribe",s.RequestUploadStats="requestUploadStats",s.RequestUpload="requestUpload",s.MediaReconnectStart="MediaReconnectStart",s.MediaReconnectEnd="MediaReconnectEnd",s.NeedSignalRTT="NeedSignalRTT",s.RequestRestartICE="RequestRestartIce",s.PeerConnectionStateChange="PeerConnectionStateChange",s.RequestReconnect="RequestReconnect",s.RequestReconnectPC="RequestReconnectPC",s.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",s.P2PLost="P2PLost",s.UpdateVideoEncoder="UpdateVideoEncoder",s.ConnectionTypeChange="ConnectionTypeChange",s.RequestLowStreamParameter="RequestLowStreamParameter",s.QueryClientConnectionState="QueryClientConnectionState",s.LocalCandidate="LocalCandidate",s.RequestP2PMuteLocal="requestP2PMuteLocal",s.RequestP2PUnPublish="RequestP2PUnPublish",s.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",s.RequestP2PMuteRemote="RequestP2PMuteRemote",s.RequestP2PRestartICE="RequestP2PRestartICE"}(_e||(_e={})),function(s){s.MUTE_LOCAL_VIDEO="mute_local_video",s.MUTE_LOCAL_AUDIO="mute_local_audio",s.UNMUTE_LOCAL_VIDEO="unmute_local_video",s.UNMUTE_LOCAL_AUDIO="unmute_local_audio",s.MUTE_REMOTE_VIDEO="mute_remote_video",s.MUTE_REMOTE_AUDIO="mute_remote_audio",s.UNMUTE_REMOTE_VIDEO="unmute_remote_video",s.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(uR||(uR={})),function(s){s.CONNECTING="CONNECTING",s.RECONNECTING="RECONNECTING",s.CONNECTED="CONNECTED",s.CLOSED="CLOSED"}(Mo||(Mo={})),function(s){s[s.CONNECT_AP=0]="CONNECT_AP",s[s.AP_CONNECTED=1]="AP_CONNECTED",s[s.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",s[s.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",s[s.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",s[s.CONNECT_WORKER=5]="CONNECT_WORKER",s[s.WORKER_CONNECTED=6]="WORKER_CONNECTED",s[s.CLOSED=7]="CLOSED"}(da||(da={})),function(s){s.CONNECTION_STATE_CHANGE="connection-state-change",s.STATE_CHANGE="state-change",s.INSPECT_RESULT="inspect-result",s.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",s.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(ur||(ur={})),function(s){s.NETWORK_ERROR="NETWORK_ERROR",s.SERVER_ERROR="SERVER_ERROR",s.MULTI_IP="MULTI_IP",s.TIMEOUT="TIMEOUT",s.OFFLINE="OFFLINE",s.LEAVE="LEAVE",s.P2P_FAILED="P2P_FAILED",s.FALLBACK="FALLBACK"}(vc||(vc={})),function(s){s.CONNECTED="transmitter:connected",s.RECONNECTING="transmitter:reconnecting",s.WILL_RECONNECT="transmitter:will_reconnect",s.CLOSED="transmitter:closed",s.FAILED="transmitter:failed",s.ON_MESSAGE="transmitter:on_message",s.REQUEST_NEW_URLS="transmitter:request_new_urls",s.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",s.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",s.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",s.FAILBACK="transmitter:failback"}(Mi||(Mi={})),function(s){s.CAMERA_CHANGED="camera-changed",s.MICROPHONE_CHANGED="microphone-changed",s.PLAYBACK_DEVICE_CHANGED="playback-device-changed",s.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",s.AUTOPLAY_FAILED="autoplay-failed",s.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",s.SECURITY_POLICY_VIOLATION="security-policy-violation"}(Ha||(Ha={})),function(s){s[s.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",s[s.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",s[s.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",s[s.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",s[s.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",s[s.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",s[s.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",s[s.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",s[s.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",s[s.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",s[s.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",s[s.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",s[s.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",s[s.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",s[s.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",s[s.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",s[s.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",s[s.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",s[s.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",s[s.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(lR||(lR={})),function(s){s.CONNECTING="CONNECTING",s.RECONNECTING="RECONNECTING",s.CONNECTED="CONNECTED",s.CLOSED="CLOSED"}(Eo||(Eo={})),function(s){s.CONNECTION_STATE_CHANGE="connection-state-change",s.STATE_CHANGE="state-change",s.INSPECT_RESULT="inspect-result",s.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",s.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Uo||(Uo={})),function(s){s[s.CONNECT_AP=0]="CONNECT_AP",s[s.AP_CONNECTED=1]="AP_CONNECTED",s[s.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",s[s.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",s[s.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",s[s.CONNECT_WORKER=5]="CONNECT_WORKER",s[s.WORKER_CONNECTED=6]="WORKER_CONNECTED",s[s.CLOSED=7]="CLOSED"}(xo||(xo={})),function(s){s.CALL="call",s.CANDIDATE="candidate",s.PUBLISH="publish",s.UNPUBLISH="unpublish",s.CONTROL="control",s.RESTART_ICE="restart_ice",s.ACK="ack",s.RESPONSE="response",s.JOIN="join",s.CHECK="check"}(li||(li={})),function(s){s.ABORT="abort"}(sd||(sd={})),function(s){s.MUTE_LOCAL_AUDIO="mute_local_audio",s.MUTE_LOCAL_VIDEO="mute_local_video",s.UNMUTE_LOCAL_AUDIO="unmute_local_audio",s.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(Ic||(Ic={})),function(s){s[s.SUCCESS=1]="SUCCESS",s[s.FAILED=0]="FAILED"}(ek||(ek={})),function(s){s.P2P_TOKEN_TIMEOUT="p2p_token_timeout",s.P2P_TOKEN_CHANGED="p2p_token_changed"}(_f||(_f={}));const Xs={[F_.ACCESS_POINT]:{[ns.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[ns.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[ns.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[ns.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[ns.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[ns.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[ns.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[F_.UNILBS]:{[_o.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[_o.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[_o.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[_o.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[_o.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[_o.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[_o.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[_o.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[_o.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[_o.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[_o.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[_o.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[F_.STRING_UID_ALLOCATOR]:{[B_.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[B_.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[B_.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function hR(s){const e=Xs[Math.floor(s/1e4)];if(!e)return{desc:"unkonw error",retry:!1};const i=e[s%1e4];if(!i){if(Math.floor(s/1e4)===F_.ACCESS_POINT){const o=s%1e4;if(o.toString()[0]==="1")return{desc:s.toString(),retry:!1};if(o.toString()[0]==="2")return{desc:s.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const Ef={[ae.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ae.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ae.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ae.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ae.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ae.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ae.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ae.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ae.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ae.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ae.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ae.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ae.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ae.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ae.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ae.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ae.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ae.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ae.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ae.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ae.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ae.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ae.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ae.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ae.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ae.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ae.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ae.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ae.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ae.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ae.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ae.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ae.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ae.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ae.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ae.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ae.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ae.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ae.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ae.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ae.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ae.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ae.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ae.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ae.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ae.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ae.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ae.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ae.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ae.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ae.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ae.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ae.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ae.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ae.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ae.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ae.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ae.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ae.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ae.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ae.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ae.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ae.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Yd(s){return Ef[s]||{desc:"UNKNOW_ERROR_".concat(s),action:"failed"}}function mf(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function yc(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?mf(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):mf(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function Cr(s){return s.every(e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)}function mn(s,e){if(typeof s=="string")return s;const{proxy:i,host:o,port:c}=s;if(e){const u=Q("JOIN_GATEWAY_FALLBACK_PORT")||443;return u===443?"wss://".concat(o,"/ws/?p=").concat(Number(c)+150):"wss://".concat(o,":").concat(u,"/ws/?p=").concat(Number(c)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(o,"&p=").concat(c):"wss://".concat(o,":").concat(c)}const ik=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,od=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,ab=/wss:\/\/(.+):([0-9]+)\/?/,en=/wss:\/\/(.[^\/]+)\/?/;let rk=0;class pR{constructor(e,i){A(this,"id",0),A(this,"store",void 0),A(this,"recordIndex",void 0),A(this,"websockets",[]),A(this,"try443PortDuration",2e3),A(this,"forceCloseWSDuration",5e3),A(this,"try443PortTimeout",null),A(this,"forceCloseTimeout",null),A(this,"isTry443PortFailed",!1),A(this,"isNormalPortFailed",!1),A(this,"useDoubleDomain",!1),A(this,"useProxy",!1),A(this,"startTime",Date.now()),this.id=++rk,this.try443PortDuration=Q("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=i}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const i=Date.now()-this.startTime;for(var o=arguments.length,c=new Array(o),u=0;u<o;u++)c[u]=arguments[u];O.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...c)}createWebSocket(e,i,o){this.logger("createWebSocket:",e,{isTry443Port:i,hasTimeoutDetection:o});const c=Q("GATEWAY_DOMAINS"),u=Date.now(),h=[],_=c.find(S=>{var C;return Jt(C=e.host).call(C,S)});_||(this.useDoubleDomain=!1);const m=[];if(this.useDoubleDomain)c.forEach(S=>{m.push(mn(yc(yc({},e),{},{host:e.host.replace(_,S)}),i))});else{const S=yc({},e);if(i&&_){const C=c.find(I=>I!==_);C&&(S.host=S.host.replace(_,C))}m.push(mn(S,i))}try{m.forEach(S=>{const C=new WebSocket(S);C.binaryType="arraybuffer",h.push(C),this.logger("ws is connecting:",C.url)})}catch(S){if(this.logger("ws create failed"),h.forEach(C=>C.close()),h.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,i,o);if(!i&&Number(e.port)!==443)return this.createWebSocket(e,!0,o);throw new st(j.WS_ERR,"init websocket failed! Error: ".concat(S.toString()))}const g=zm();return this.store&&this.store.recordJoinChannelService({urls:h.map(S=>S.url),service:"gateway"},this.recordIndex),h.forEach(S=>{S.onopen=()=>{this.logger("onopen: ws ".concat(S.url," open cost ").concat(Date.now()-u,"ms")),this.websockets.forEach(C=>{C!==S&&(C.onopen=null,C.onclose=null,C.onmessage=null,C.close(),this.logger("close backup websocket: ".concat(C.url)))}),this.websockets.length=0,g.resolve(S)},S.onclose=C=>{this.logger("onclose: ws ".concat(S.url," closed cost ").concat(Date.now()-u,"ms state: ").concat(S.readyState)),i?this.isTry443PortFailed=Cr(h):this.isNormalPortFailed=Cr(h),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(i&&this.isTry443PortFailed||!i&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(C.reason)),g.reject({code:C.code,reason:op.A_ROUND_WS_FAILED}))},S.onmessage=C=>this.logger("".concat(S.url," onmessage: ").concat(C.data))}),this.websockets.push(...h),o||(()=>{const S=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",g.isResolved),this.websockets.forEach(C=>C.readyState!==WebSocket.OPEN&&C.close())};if(i||this.useProxy)return this.logger("add 5s timeout at ".concat(i?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(S,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",g.isResolved),g.isResolved)return S();ln().os===gr.MAC_OS&&Ln()&&S(),this.createWebSocket(e,!0,!0).then(C=>g.resolve(C)).catch(C=>{this.isNormalPortFailed&&g.reject(C),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(S,this.forceCloseWSDuration)},this.try443PortDuration)})(),g.promise}chooseBestWebsocket(e,i,o,c){return this.useDoubleDomain=!!i,typeof e=="string"&&(e=function(u){let h,_,m;return[,h,_,m]=u.match(ik)||[],h||([,_,m]=u.match(od)||[]),_&&m||([,_,m]=u.match(ab)||[]),_&&m||([,_]=u.match(en)||[]),_||O.warning("un-destructible url: ",u),{proxy:h,host:_,port:m||"443"}}(e)),this.recordIndex=c,this.useProxy=!!e.proxy,o&&this.useProxy&&(O.warn("cannot use 443 only when use proxy"),o=!1),this.createWebSocket(e,!!o,!1).finally(()=>this.clearTimeout())}}function cb(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}class ff extends oi{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var i;Jt(i=["tryNext","recover"]).call(i,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Se.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Se.CONNECTED):this._state==="closed"?this.emit(Se.CLOSED):this._state==="failed"&&this.emit(Se.FAILED))}resetReconnectCount(e){O.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,i){let o=arguments.length>2&&arguments[2]!==void 0&&arguments[2],c=arguments.length>3&&arguments[3]!==void 0&&arguments[3],u=arguments.length>4&&arguments[4]!==void 0&&arguments[4],h=arguments.length>5?arguments[5]:void 0;super(),A(this,"connectionID",0),A(this,"currentURLIndex",0),A(this,"urls",[]),A(this,"_reconnectMode","tryNext"),A(this,"reconnectReason",void 0),A(this,"_initMutex",new Sr("websocket")),A(this,"name",void 0),A(this,"_state","closed"),A(this,"reconnectInterrupter",void 0),A(this,"websocket",void 0),A(this,"retryConfig",void 0),A(this,"reconnectCount",0),A(this,"forceCloseTimeout",5e3),A(this,"onlineReconnectListener",void 0),A(this,"useCompress",void 0),A(this,"tryDoubleDomain",!1),A(this,"use443PortOnly",!1),A(this,"wsInflateLength",0),A(this,"wsDeflateLength",0),A(this,"closeEstablishingWs",()=>{}),A(this,"store",void 0),A(this,"joinGatewayRecordIndex",void 0),this.store=h,this.name=e,this.retryConfig=function(C){for(var I=1;I<arguments.length;I++){var b=arguments[I]!=null?arguments[I]:{};I%2?cb(Object(b),!0).forEach(function(x){A(C,x,b[x])}):Object.getOwnPropertyDescriptors?Object.defineProperties(C,Object.getOwnPropertyDescriptors(b)):cb(Object(b)).forEach(function(x){Object.defineProperty(C,x,Object.getOwnPropertyDescriptor(b,x))})}return C}({},i),this.useCompress=o,this.tryDoubleDomain=c,this.use443PortOnly=u;const{timeout:_,timeoutFactor:m}=i,g=Math.max(300,Math.floor(3*_/5)),S=Math.max(1.2,Math.floor(8*m)/10);Ds.ONLINE&&(this.retryConfig.timeout=g,this.retryConfig.timeoutFactor=S),er.on(Pu.NETWORK_STATE_CHANGE,(C,I)=>{C!==I&&(this.resetReconnectCount("network state change: ".concat(I," -> ").concat(C)),C===Ds.ONLINE?(this.retryConfig.timeout=g,this.retryConfig.timeoutFactor=S):(this.retryConfig.timeout=_,this.retryConfig.timeoutFactor=m))})}getConnection(){return this.websocket||void 0}async init(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const o=await this._initMutex.lock();this.forceCloseTimeout=i,this.urls=e,this.state="connecting";try{const c=zm(),u=this.urls[this.currentURLIndex];this.createWebSocketConnection(u).then(c.resolve).catch(c.reject),this.once(Se.CLOSED,()=>{c.reject(new ft(j.WS_DISCONNECT))}),this.once(Se.CONNECTED,c.resolve),await c.promise}catch{}finally{o()}}close(e,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const o=this.websocket;i?setTimeout(()=>o.close(),500):o.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void O.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),O.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const o=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),o&&o.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new ft(j.WS_ABORT,"websocket is not ready");try{i||(e=JSON.stringify(e)),this.websocket.send(e)}catch(o){throw new ft(j.WS_ERR,"send websocket message error"+o.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var i;const o=zm();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const c=S=>{var C;(C=this.store)===null||C===void 0||C.signalChannelOpen(),O.debug("[".concat(this.name,"] websocket opened:"),S),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),o.resolve()},u=async S=>{var C;if(O.debug("[".concat(this.name,"] websocket close ").concat((C=this.websocket)===null||C===void 0?void 0:C.url,", code: ").concat(S.code,", reason: ").concat(S.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)o.reject(new ft(j.WS_DISCONNECT,"websocket close: ".concat(S.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=S.reason,this.state="reconnecting");const I=ko(this,Se.WILL_RECONNECT,this.reconnectMode,S.reason)||this.reconnectMode,b=await this.reconnectWithAction(I);if(this.state==="closed")return void O.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!b)return o.reject(new ft(j.WS_DISCONNECT,"websocket reconnect failed: ".concat(S.code))),this.close(!0);o.resolve()}},h=S=>{this.emit(Se.ON_MESSAGE,S)},_=S=>{O.warn("[".concat(this.connectionID,"] ws open error ").concat(S))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),Q("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=Q("GATEWAY_WSS_ADDRESS")),O.debug("[".concat(this.name,"] start connect, url:"),e);const m=(i=this.store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var g;const S=await this.chooseBestWebsocketConnection(e);this.websocket=S,c&&c(this.websocket.url),this.websocket.onclose=u,this.websocket.onmessage=h,this.websocket.onerror=_,(g=this.store)===null||g===void 0||g.recordJoinChannelService({endTs:Date.now(),status:"success"},m),this.joinGatewayRecordIndex=m}catch(S){const C=this.state==="closed",I=S instanceof ft,b=I&&S.code===j.WS_ABORT,x=I&&S.code===j.WS_ERR,D=I?S.message:S&&(S.reason||S.toString());O.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(D)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:b?"aborted":"error",errors:[S]},m),C||x?(o.reject(C?new ft(j.WS_DISCONNECT,"websocket is closed: ".concat(D)):new ft(j.WS_ERR,"init websocket failed: ".concat(D))),x&&O.error("[".concat(this.name,"] init websocket failed: ").concat(D))):u&&u(S)}return o.promise}async reconnectWithAction(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;O.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||er.isOnline||!er.onlineWaiter||(this.onlineReconnectListener=er.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let o=!0;if(this.reconnectInterrupter=()=>o=!1,i){const h=$m(this.reconnectCount,this.retryConfig);O.debug("[".concat(this.name,"] wait ").concat(h,"ms to reconnect websocket, mode: ").concat(e)),await ut.race([Mr(h),this.onlineReconnectListener||new ut(()=>{})])}if(this._state==="closed"||!o)return!1;this.reconnectCount+=1;const c=async(h,_)=>{this.emit(Se.RECONNECT_CREATE_CONNECTION,_),await this.createWebSocketConnection(h)};try{if(e==="retry")this.emit(Se.RECONNECT_WAITTING_FINISH,e),await c(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);O.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Se.RECONNECT_WAITTING_FINISH,e),await c(this.urls[this.currentURLIndex],e)}else e==="recover"&&(O.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Se.RECONNECT_WAITTING_FINISH,e),this.urls=await zi(this,Se.REQUEST_NEW_URLS),this.currentURLIndex=0,await c(this.urls[this.currentURLIndex],e))}catch(h){var u;O.error("[".concat(this.name,"] reconnect failed ").concat(h&&h.toString()));const _=h==null||(u=h.data)===null||u===void 0?void 0:u.desc;return Array.isArray(_)&&Jt(_).call(_,"dynamic key expired")?(this.emit(Se.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,i)}return!0}}class Ac extends ff{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){const o=zm(),c=function(h,_){return new pR(h,_)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{O.debug("[choose-best-ws] close establishing websockets"),c.closeAllWebsockets(),o.reject(new ft(j.WS_ABORT,"choose best websocket aborted"))};const u=Q("GATEWAY_DOMAINS");return O.debug("[choose-best-ws] currentDomain: ",e,", domains: ",u,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),c.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(o.resolve).catch(o.reject),o.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class vr extends ff{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){return new ut((o,c)=>{let u=!1;const h=[];this.closeEstablishingWs=()=>{O.debug("[choose-best-ws] close establishing websockets"),h.forEach(x=>{x.onclose=null,x.onopen=null,x.onmessage=null,x.close()}),c(new ft(j.WS_ABORT,"choose best websocket aborted"))};const _=Q("GATEWAY_DOMAINS");let m;const g=e.indexOf("?h="),S=_.find(x=>g!==-1?Jt(e).call(e,x,g):Jt(e).call(e,x));O.debug("[choose-best-ws] currentDomain: ",S,", domains: ",_);let C=!this.tryDoubleDomain||!S;if(!C&&S){var I;const x=Date.now();try{_.forEach(D=>{const M=g===-1?e.replace(S,D):e.substr(0,g)+e.substr(g).replace(S,D),K=new WebSocket(M);K.binaryType="arraybuffer",h.push(K),O.debug("[choose-best-ws] ws is connecting:",K.url)})}catch{for(O.debug("[choose-best-ws] ws create failed, fallback to single url"),h.forEach(M=>M.close());h.length;)h.pop();C=!0}(I=this.store)===null||I===void 0||I.recordJoinChannelService({urls:h.map(D=>D.url),service:"gateway"},i),h.forEach(D=>{D.onopen=()=>{if(u)return;const M=Date.now()-x;O.debug("[choose-best-ws] ws open cost ".concat(M,"ms")),h.filter(K=>K!==D).forEach(K=>{O.debug("[choose-best-ws]close backup websocket: ".concat(K.url)),K.close()}),u=!0,o(D)},D.onclose=M=>{m=M,!u&&(h.find(K=>!(K.readyState===WebSocket.CLOSED||K.readyState===WebSocket.CLOSING))||(O.debug("[choose-best-ws] all websocket is closed"),u=!0,c(m)))},D.onmessage=M=>{O.debug("[choose-best-ws]".concat(D.url," onmessage: ").concat(M.data))}}),Mr(this.forceCloseTimeout).then(()=>{h.forEach(D=>{D.readyState!==WebSocket.OPEN&&D.close()})})}if(C){var b;let x;O.debug("[choose-best-ws] use single url: ",e),(b=this.store)===null||b===void 0||b.recordJoinChannelService({urls:[e],service:"gateway"},i);try{x=new WebSocket(e),h.push(x),x.binaryType="arraybuffer"}catch(D){const M=new ft(j.WS_ERR,"init websocket failed! Error: ".concat(D.toString()));return O.error("[".concat(this.name,"]").concat(M)),void c(M)}x.onopen=()=>{o(x)},x.onclose=D=>{c(D)},x.onmessage=D=>{O.debug("[choose-best-ws]".concat(x.url," onmessage: ").concat(D.data))},Mr(this.forceCloseTimeout).then(()=>{x&&x.readyState!==WebSocket.OPEN&&x.close()})}}).then(o=>(this.closeEstablishingWs=void 0,o)).catch(o=>{throw this.closeEstablishingWs=void 0,o})}}class db extends oi{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Me.CONNECTED?this.emit(Gt.WS_CONNECTED):e===Me.RECONNECTING?this.emit(Gt.WS_RECONNECTING,this._websocketReconnectReason):e===Me.CLOSED&&this.emit(Gt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),A(this,"_disconnectedReason",void 0),A(this,"_websocketReconnectReason",void 0),A(this,"_connectionState",Me.CLOSED),A(this,"reconnectToken",void 0),A(this,"websocket",void 0),A(this,"openConnectionTime",void 0),A(this,"clientId",void 0),A(this,"lastMsgTime",Date.now()),A(this,"uploadCache",[]),A(this,"uploadCacheInterval",void 0),A(this,"rttRolling",new FS(5)),A(this,"pingpongTimer",void 0),A(this,"wsInflateDataTimer",void 0),A(this,"pingpongTimeoutCount",0),A(this,"joinResponse",void 0),A(this,"multiIpOption",void 0),A(this,"initError",void 0),A(this,"spec",void 0),A(this,"store",void 0),A(this,"onWebsocketMessage",o=>{if(o.data instanceof ArrayBuffer)return void this.emit(Gt.ON_BINARY_DATA,o.data);const c=JSON.parse(o.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(c,"_id")){const u="res-@".concat(c._id);this.emit(u,c._result,c._message)}else if(Object.prototype.hasOwnProperty.call(c,"_type")){if(this.emit(c._type,c._message),c._type===Re.ON_NOTIFICATION&&this.handleNotification(c._message),c._type===Re.ON_USER_BANNED)switch(c._message.error_code){case 14:this.close(Fe.UID_BANNED);break;case 15:this.close(Fe.IP_BANNED);break;case 16:this.close(Fe.CHANNEL_BANNED)}if(c._type===Re.ON_USER_LICENSE_BANNED)switch(c._message.error_code){case ae.ERR_LICENSE_MISSING:this.close(Fe.LICENSE_MISSING);break;case ae.ERR_LICENSE_EXPIRED:this.close(Fe.LICENSE_EXPIRED);break;case ae.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Fe.LICENSE_MINUTES_EXCEEDED);break;case ae.ERR_LICENSE_PERIOD_INVALID:this.close(Fe.LICENSE_PERIOD_INVALID);break;case ae.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Fe.LICENSE_MULTIPLE_SDK_SERVICE);break;case ae.ERR_LICENSE_ILLEGAL:this.close(Fe.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new Ac("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Q("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Q("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Me.CONNECTED&&this.reconnect("retry",Tr.OFFLINE)})}async request(e,i,o,c){const u=Hn(6,""),h={_id:u,_type:e,_message:i},_=this.websocket.connectionID,m=()=>new ut((x,D)=>{if(this.connectionState===Me.CONNECTED)return x();const M=()=>{this.off(Gt.WS_CLOSED,K),x()},K=()=>{this.off(Gt.WS_CONNECTED,M),D(new st(j.WS_ABORT))};this.once(Gt.WS_CONNECTED,M),this.once(Gt.WS_CLOSED,K),e!==ie.PUBLISH&&e!==ie.PUBLISH_DATASTREAM&&e!==ie.SUBSCRIBE&&e!==ie.SUBSCRIBE_DATASTREAM&&e!==ie.UNSUBSCRIBE&&e!==ie.UNSUBSCRIBE_DATASTREAM&&e!==ie.UNPUBLISH&&e!==ie.UNPUBLISH_DATASTREAM&&e!==ie.CONTROL&&e!==ie.RESTART_ICE||this.once(Gt.DISCONNECT_P2P,()=>{D(new st(j.DISCONNECT_P2P))}),e!==ie.PUBLISH&&e!==ie.RESTART_ICE||this.once(Gt.ABORT_P2P_EXECUTION,()=>{D(new st(j.DISCONNECT_P2P))})});if(this.connectionState!==Me.CONNECTING&&this.connectionState!==Me.RECONNECTING||e===ie.JOIN||e===ie.REJOIN||await m(),this.websocket.sendMessage(h,!0),c)return;const g=new ut((x,D)=>{let M=!1;const K=(nt,dt)=>{M=!0,x({isSuccess:nt==="success",message:dt||{}}),this.off(Gt.WS_CLOSED,z),this.off(Gt.WS_RECONNECTING,z),this.emit(Gt.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(u),K);const z=()=>{D(new st(j.WS_ABORT,"type: ".concat(e))),this.off(Gt.WS_CLOSED,z),this.off(Gt.WS_RECONNECTING,z),this.off("res-@".concat(u),K)};this.once(Gt.WS_CLOSED,z),this.once(Gt.WS_RECONNECTING,z),Mr(Q("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==_||M||(O.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Gt.REQUEST_TIMEOUT,e,i))})});let S=null;try{S=await g}catch(x){if(this.connectionState===Me.CLOSED||e===ie.LEAVE)throw new st(j.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?x.throw():e===ie.JOIN||e===ie.REJOIN?null:(await m(),await this.request(e,i))}if(S.isSuccess)return S.message;const C=Number(S.message.error_code||S.message.code),I=Yd(C),b=new st(j.UNEXPECTED_RESPONSE,"".concat(I.desc,": ").concat(S.message.error_str),{code:C,data:S.message});return I.action==="success"?S.message:(O.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(C,", message: ").concat(I.desc,", action: ").concat(I.action)),C===ae.ERR_TOO_MANY_BROADCASTERS?((e===ie.JOIN||e===ie.REJOIN)&&(this.initError=b,this.close()),b.throw()):I.action==="failed"?b.throw():I.action==="quit"?(this.initError=b,this.close(),b.throw()):(C===ae.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=S.message.option,O.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Tr.MULTI_IP)):this.reconnect(I.action,Tr.SERVER_ERROR),e===ie.JOIN||e===ie.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new ut(o=>{const c=u=>{(!i||i(u))&&(this.off(e,c),o(u))};this.on(e,c)})}uploadWRTCStats(e){if(!this.store.sessionId)return void O.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(rd.WRTC_STATS,i)}upload(e,i){const o={_type:e,_message:i};try{this.websocket.sendMessage(o)}catch{const u=Q("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(o),this.uploadCache.length>u&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Me.CONNECTED)return;const h=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(h._type,h._message)},Q("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const o={_type:e,_message:i};this.websocket.sendMessage(o)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ut((o,c)=>{this.once(Gt.WS_CONNECTED,()=>o(this.joinResponse)),this.once(Gt.WS_CLOSED,()=>c(this.initError||new st(j.WS_ABORT))),this.connectionState=Me.CONNECTING,this.websocket.init(e).catch(c),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Fe.LEAVE,this.connectionState=Me.CLOSED,O.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===Fe.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ac("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Q("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Q("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(Gt.ABORT_P2P_EXECUTION);const e=await zi(this,Gt.REQUEST_JOIN_INFO),i=await this.request(ie.JOIN,e);if(!i)return this.emit(Gt.REPORT_JOIN_GATEWAY,op.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(Gt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Me.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new st(j.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=gl(this,Gt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const i=await this.request(ie.REJOIN,e);return!!i&&(this.connectionState=Me.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(o=>{this.emit(Re.ON_USER_ONLINE,{uid:o.uid}),o.audio&&this.emit(Re.ON_ADD_AUDIO_STREAM,{uid:o.uid,uint_id:o.uint_id,audio:!0,ssrcId:o.audio_ssrc}),o.video&&this.emit(Re.ON_ADD_VIDEO_STREAM,{uid:o.uid,uint_id:o.uint_id,video:!0,ssrcId:o.video_ssrc}),o.audio_mute?this.emit(Re.MUTE_AUDIO,{uid:o.uid}):this.emit(Re.UNMUTE_AUDIO,{uid:o.uid}),o.video_mute?this.emit(Re.MUTE_VIDEO,{uid:o.uid}):this.emit(Re.UNMUTE_VIDEO,{uid:o.uid}),o.audio_enable_local?this.emit(Re.ENABLE_LOCAL_AUDIO,{uid:o.uid}):this.emit(Re.DISABLE_LOCAL_AUDIO,{uid:o.uid}),o.video_enable_local?this.emit(Re.ENABLE_LOCAL_VIDEO,{uid:o.uid}):this.emit(Re.DISABLE_LOCAL_VIDEO,{uid:o.uid}),o.audio||o.video||this.emit(Re.ON_REMOVE_STREAM,{uid:o.uid,uint_id:o.uint_id})}),!0)}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleNotification(e){O.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Yd(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Fe.UID_BANNED),void this.close()):void this.reconnect(i.action,Tr.SERVER_ERROR);O.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Q("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(O.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>Q("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Tr.TIMEOUT):this.request(ie.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const o=Date.now()-i;this.rttRolling.add(o),Q("REPORT_STATS")&&this.send(ie.PING_BACK,{pingpongElapse:o})}).catch(o=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:i}=this.websocket.getWsInflateData();e!==0&&i!==0&&this.upload(rd.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Se.RECONNECT_WAITTING_FINISH,e=>{this.emit(Gt.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Se.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Gt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Se.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Se.CLOSED,()=>{this.connectionState=Me.CLOSED}),this.websocket.on(Se.FAILED,()=>{this._disconnectedReason=Fe.NETWORK_ERROR,this.connectionState=Me.CLOSED}),this.websocket.on(Se.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Me.CONNECTED?this.connectionState=Me.RECONNECTING:this.connectionState=Me.CONNECTING}),this.websocket.on(Se.WILL_RECONNECT,(e,i,o)=>{const c=gl(this,Gt.IS_P2P_DISCONNECTED),u=c||e!=="retry";c&&e==="retry"&&(O.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=op.P2P_DISCONNECTED),u&&(O.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(Gt.REPORT_JOIN_GATEWAY,i||op.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Gt.NEED_RENEW_SESSION),this.emit(Gt.DISCONNECT_P2P)),o(e)}),this.websocket.on(Se.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{O.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Tr.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(Gt.REPORT_JOIN_GATEWAY,e.message||e.code||op.UNKNOWN_REASON,this.url||""),e instanceof st&&e.code===j.UNEXPECTED_RESPONSE&&e.data.code===ae.ERR_NO_AUTHORIZED)return O.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Tr.SERVER_ERROR);O.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Tr.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Se.REQUEST_NEW_URLS,(e,i)=>{zi(this,Gt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(Se.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Re.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var Ii=`	
\v\f\r                　\u2028\u2029\uFEFF`,Ys=Md,ub=Es,_R=Ii,lb=Qt("".replace),sk=RegExp("^["+_R+"]+"),ok=RegExp("(^|[^"+_R+"])["+_R+"]+$"),ak=function(s){return function(e){var i=ub(Ys(e));return 1&s&&(i=lb(i,sk,"")),2&s&&(i=lb(i,ok,"$1")),i}},ck={trim:ak(3)},dk=bm.PROPER,G_=Nt,ER=Ii,uk=ck.trim;Ce({target:"String",proto:!0,forced:function(s){return G_(function(){return!!ER[s]()||"​᠎"[s]()!=="​᠎"||dk&&ER[s].name!==s})}("trim")},{trim:function(){return uk(this)}});var hi,ua,lk=al("String").trim,hb=le,Il=lk,W_=String.prototype,ap=Rt(function(s){var e=s.trim;return typeof s=="string"||s===W_||hb(W_,s)&&e===W_.trim?Il:e});function $n(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function gf(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?$n(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):$n(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function qt(s){return s.match(/^[\.\:\d]+$/)?"".concat(s.replace(/[^\d]/g,"-"),".").concat(Q("TURN_DOMAIN")):(O.info("Unidentified as ip: ".concat(s,", use as host")),s)}function H(s,e){s.addresses||(s.addresses=[]);const i=function(u,h){if(Q("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return u.map(g=>{let{ip:S,port:C}=g;return{address:"".concat(S,":").concat(C)}});const _=Q("GATEWAY_DOMAINS");let m=_[1]&&Jt(h).call(h,_[1])?1:0;return u.map(g=>{let{domain_prefix:S,port:C,ip:I}=g;if(S)return{address:"".concat(S,".").concat(_[m++%_.length],":").concat(C)};const b=/^[\.\:\d]+$/.test(I),x=b?"".concat(I.replace(/[^\d]/g,"-"),".").concat(_[m++%_.length],":").concat(C):"".concat(I,":").concat(C);return b||O.info("Unidentified as ip: ".concat(I,", use as host")),{ip:I,port:C,address:x}})}(s.addresses,e),o=Array.isArray(s.detail)&&s.detail[18];if(o&&typeof o=="string"){const u=o.split(";");for(let h=0;h<u.length;h++){var c;const _=ap(c=u[h]).call(c);i[h]&&_&&(i[h].ip6=_)}}return{gatewayAddrs:i,uid:s.uid,cid:s.cid,cert:s.cert,vid:s.detail&&s.detail[8],uni_lbs_ip:s.detail&&s.detail[1],res:s,csIp:s.detail&&s.detail[502]}}function _t(s){return typeof s=="number"?s:s.exact||s.ideal||s.max||s.min||0}function qd(s){const e=s._encoderConfig;if(!e)return{};const i={resolution:e.width&&e.height?"".concat(_t(e.width),"x").concat(_t(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(i.maxFrameRate=e.frameRate,i.minFrameRate=e.frameRate):e.frameRate&&(i.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,i.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),i}function lr(s){return s>=0&&s<.17?1:s>=.17&&s<.36?2:s>=.36&&s<.59?3:s>=.59&&s<=1?4:s>1?5:0}function yn(s,e){let i,o,c;switch(e){case hi.CHOOSE_SERVER:o=4096,c="choose server";break;case hi.CLOUD_PROXY:o=1048576,c="proxy";break;case hi.CLOUD_PROXY_5:o=4194304,c="proxy5";break;case hi.CLOUD_PROXY_FALLBACK:o=4194310,c="proxy fallback";break;default:throw new st(j.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:s.detail&&s.detail[502],retry:!1})}if(s.response_body.forEach(u=>{u.buffer&&u.buffer.flag===o&&(i={code:u.buffer.code,addresses:(u.buffer.edges_services||[]).map(h=>gf(gf({},h),{},{ticket:u.buffer.cert})),server_ts:s.enter_ts,uid:u.buffer.uid,cid:u.buffer.cid,cname:u.buffer.cname,detail:gf(gf({},u.buffer.detail),s.detail),flag:u.buffer.flag,opid:s.opid,cert:u.buffer.cert})}),!i)throw new st(j.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(c," from multi unilbs response"),{csIp:s.detail&&s.detail[502]});return i}async function pb(s,e){return await ut.all(s.addresses.map(async i=>({address:qt(i.ip),tcpport:i.port,udpport:i.port,username:e&&Q("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Ps.username,password:e&&Q("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await kS(e.toString()):Ps.password})))}function Nr(s,e){const i=e._videoHeight||e.getMediaStreamTrack(!0).getSettings().height;return i?Math.max(i/_t(s.height),1):(O.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function mo(s){let{candidateType:e,relayProtocol:i,type:o,address:c,port:u,protocol:h}=s;return o==="local-candidate"?{candidateType:e,relayProtocol:i,protocol:h}:{candidateType:e,relayProtocol:i,address:c,port:u,protocol:h}}function Ti(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}(function(s){s[s.CHOOSE_SERVER=11]="CHOOSE_SERVER",s[s.CLOUD_PROXY=18]="CLOUD_PROXY",s[s.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",s[s.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(hi||(hi={}));class hk extends oi{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var i;Jt(i=["tryNext","recover"]).call(i,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Mi.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Mi.CONNECTED):this._state==="closed"?this.emit(Mi.CLOSED):this._state==="failed"&&this.emit(Mi.FAILED))}constructor(e,i,o,c){super(),A(this,"connectionID",0),A(this,"currentURLIndex",0),A(this,"reconnectReason",void 0),A(this,"_reconnectMode","tryNext"),A(this,"_name",void 0),A(this,"_state","closed"),A(this,"_retryConfig",void 0),A(this,"_reconnectCount",0),A(this,"_forceCloseTimeout",5e3),A(this,"_onlineReconnectListener",void 0),A(this,"_closeEstablishingTransmitter",()=>{}),A(this,"_store",void 0),A(this,"_joinChannelServiceRecordIndex",void 0),A(this,"_useCompress",void 0),A(this,"_inflateLength",0),A(this,"_deflateLength",0),this._store=c,this._name=e,this._retryConfig=function(u){for(var h=1;h<arguments.length;h++){var _=arguments[h]!=null?arguments[h]:{};h%2?Ti(Object(_),!0).forEach(function(m){A(u,m,_[m])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(_)):Ti(Object(_)).forEach(function(m){Object.defineProperty(u,m,Object.getOwnPropertyDescriptor(_,m))})}return u}({},i),this._useCompress=o}resetReconnectCount(e){O.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const o=this._transmitter;i?setTimeout(()=>o.close(),500):o.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,i){if(!this._transmitter)return void O.warning("[".concat(this._name,"] can not reconnect, no websocket"));var o;e!==void 0&&(this.reconnectMode=e),O.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((o=this._store)===null||o===void 0||o.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const c=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),c&&c.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const e=this._inflateLength,i=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:i}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}(function(s){s[s.Default=0]="Default",s[s.Ack=1]="Ack"})(ua||(ua={}));class Tf{constructor(e,i,o){A(this,"version",1),A(this,"initialRTO",void 0),A(this,"maxBatchAckCount",void 0),A(this,"maxRTO",void 0),A(this,"initialRTT",void 0),A(this,"ID",void 0),A(this,"rtt",void 0),A(this,"packetNumber",1),A(this,"rtoRatioMap",new Map),A(this,"timeoutMap",new Map),A(this,"unorderedPacketQueue",[]),A(this,"batchAckPacketQueue",[]),A(this,"lastOrderedPacketNumber",0),A(this,"batchAckTimer",void 0),A(this,"sendImpl",void 0),A(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=i,this.ID=Hn(7,"transmitter-"),this.initialRTO=(o==null?void 0:o.initialRTO)!==void 0?o.initialRTO:Q("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(o==null?void 0:o.initialRTT)!==void 0?o.initialRTT:Q("TRANSMITTER_INITIAL_RTT"),this.rtt=(o==null?void 0:o.initialRTT)!==void 0?o.initialRTT:Q("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(o==null?void 0:o.maxBatchAckCount)!==void 0?o.maxBatchAckCount:Q("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(o==null?void 0:o.maxRTO)!==void 0?o.maxRTO:Q("TRANSMITTER_MAX_RTO")}packetize(e,i){return{type:ua.Default,version:this.version,packetNumber:i,payload:e}}serialize(e){switch(e.type){case ua.Default:{let i;typeof e.payload=="string"?i=new TextEncoder().encode(e.payload):i=e.payload;const o=new ArrayBuffer(i.length+15),c=new DataView(o);return c.setUint16(0,e.version),c.setUint8(2,e.type),c.setUint32(3,e.packetNumber),LS(c,7,BigInt(e.sendTs)),new Uint8Array(c.buffer).set(i,15),o}case ua.Ack:{const i=new ArrayBuffer(16),o=new DataView(i);return o.setUint16(0,e.version),o.setUint8(2,e.type),o.setUint32(3,e.maxAckPacketNumber),o.setUint8(7,e.shift),LS(o,8,BigInt(e.ackSendTs)),i}}}deserialize(e){const i=new DataView(e),o=i.getUint16(0),c=i.getUint8(2);switch(c){case ua.Default:{const u=i.getUint32(3),h=eL(i,7),_=e.slice(15),m=new TextDecoder().decode(_);return{version:o,type:c,packetNumber:u,sendTs:Number(h),payload:m}}case ua.Ack:{const u=i.getUint32(3),h=i.getUint8(7),_=eL(i,8);return{version:o,type:c,maxAckPacketNumber:u,shift:h,ackSendTs:Number(_)}}default:throw O.error("[".concat(this.ID,"] Unrecognized packet type ").concat(c)),new Error("Unrecognized packet type ".concat(c))}}sendMessage(e){const i=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const o=this.calculateRTO(i),c=window.setTimeout(()=>{this.resendMessage(i)},o);this.timeoutMap.set(i.packetNumber,c),this.sendPacket(i)}onData(e){const i=this.deserialize(e);i.type===ua.Default?this.ack(i):i.type===ua.Ack&&(this.updateRTT(i,Math.round(performance.now())),this.clearRTO(i))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[i,o]=e;window.clearTimeout(o)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const i=this.calculateRTO(e),o=window.setTimeout(()=>{this.resendMessage(e)},i);this.timeoutMap.set(e.packetNumber,o),this.sendPacket(e)}calculateRTO(e){const i=this.rtoRatioMap.get(e.packetNumber);if(i===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const o=9*this.rtt/8*i;return this.rtoRatioMap.set(e.packetNumber,i+1),o>this.maxRTO?this.maxRTO:o}}updateRTT(e,i){const o=e.ackSendTs;this.rtt=this.rtt*(7/8)+(i-o-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const i=this.unorderedPacketQueue[0];if(!i){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(i.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const i={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:ua.Ack,version:this.version};this.sendPacket(i)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const i={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:ua.Ack,version:this.version};this.sendPacket(i)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:ua.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===ua.Default&&(e.sendTs=Math.round(performance.now()));const i=this.serialize(e);this.sendImpl(i)}clearRTO(e){for(let i=e.maxAckPacketNumber-e.shift;i<=e.maxAckPacketNumber;i++){const o=this.timeoutMap.get(i);o!==void 0&&window.clearTimeout(o),this.timeoutMap.delete(i),this.rtoRatioMap.delete(i)}}}class mR extends hk{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),A(this,"_initMutex",void 0),A(this,"_reconnectInterrupter",void 0),A(this,"_url",void 0),A(this,"_transmitter",void 0),A(this,"_addresses",void 0),A(this,"_reliableTransmission",void 0),this._initMutex=new Sr("datachannel");const{timeout:o,timeoutFactor:c}=i,u=Math.max(300,Math.floor(3*o/5)),h=Math.max(1.2,Math.floor(8*c)/10);Ds.ONLINE&&(this._retryConfig.timeout=u,this._retryConfig.timeoutFactor=h),er.on(Pu.NETWORK_STATE_CHANGE,(_,m)=>{_!==m&&(this.resetReconnectCount("network state change: ".concat(m," -> ").concat(_)),_===Ds.ONLINE?(this._retryConfig.timeout=u,this._retryConfig.timeoutFactor=h):(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=c))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=i;const o=(c,u)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(_=>_.fingerprint||Q("FINGERPRINT"));const h=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(h).then(c).catch(u),this.once(Mi.CLOSED,()=>u(new st(j.WS_DISCONNECT))),this.once(Mi.CONNECTED,()=>c())};return this._initMutex.lock().then(c=>new ut((u,h)=>{o(u,h)}).then(()=>{c()}).catch(()=>{c()}))}sendMessage(e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new st(j.WS_ABORT,"datachannel is not ready");try{i||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(o){throw new st(j.WS_ERR,"send datachannel signal message error"+o.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const i=JSON.stringify(e);return{compressed:i,compressedLength:i.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new ut((i,o)=>{var c;const u=()=>{O.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},h=async S=>{var C;if((C=this._closeEstablishingTransmitter)===null||C===void 0||C.call(this),O.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(S.code,", reason: ").concat(S.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=S.reason,this.state="reconnecting");const I=ko(this,Mi.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,b=await this.reconnectWithAction(I);if(this.state==="closed")return void O.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!b)return o(new st(j.WS_DISCONNECT,"datachannel reconnect failed: ".concat(S.code))),void this.close(!0);i()}else o(new st(j.WS_DISCONNECT,"datachannel close: ".concat(S.code))),this.close()},_=S=>{var C;(C=this._reliableTransmission)===null||C===void 0||C.onData(S.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),O.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const m=(c=this._store)===null||c===void 0?void 0:c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),g=Date.now();zi(this,Mi.TO_CONNECT_DATACHANNEL,e).then(S=>{var C,I;if(!S)throw new Error("transmissonInfo not exist yet");const{transmitter:b,close:x}=S;this._transmitter=b,(C=this._store)===null||C===void 0||C.signalChannelOpen();const D=Date.now()-g;O.debug("[choose dc] dc open cost ".concat(D,"ms")),this._reliableTransmission=new Tf(M=>{var K;this._transmitter&&this._transmitter.readyState==="open"&&((K=this._transmitter)===null||K===void 0||K.send(M))},M=>{typeof M=="string"&&this.emit(Mi.ON_MESSAGE,M)}),this._closeEstablishingTransmitter=()=>{var M;(M=this._reliableTransmission)===null||M===void 0||M.close(),this._reliableTransmission=void 0,x()},u&&u(),b.onclose=h,b.onmessage=_,(I=this._store)===null||I===void 0||I.recordJoinChannelService({endTs:Date.now(),status:"success"},m),this._joinChannelServiceRecordIndex=m}).catch(S=>{var C;if((C=this._store)===null||C===void 0||C.recordJoinChannelService({endTs:Date.now(),status:S instanceof st&&S.code===j.WS_ABORT?"aborted":"error",errors:[S]},m),this.state!=="closed"){if(S instanceof st&&S.code===j.WS_ERR){const I=new st(j.WS_ERR,"init datachannel failed! Error: ".concat(S.toString()));return O.error("[".concat(this._name,"]").concat(I)),void o(I)}h&&h(S)}else o(new st(j.WS_DISCONNECT,"datachannel is closed: ".concat(S.toString())))})})}async reconnectWithAction(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||er.networkState!==Ds.OFFLINE||(this._onlineReconnectListener=er.onlineWaiter&&er.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let o=!0;if(this._reconnectInterrupter=()=>{o=!1},i){const _=$m(this._reconnectCount,this._retryConfig);O.debug("[".concat(this._name,"] wait ").concat(_,"ms to reconnect datachannel, mode: ").concat(e)),await ut.race([Mr(_),this._onlineReconnectListener||new ut(()=>{})])}if(this.state==="closed"||!o)return!1;this._reconnectCount+=1;const c=async(_,m)=>{this.emit(Mi.RECONNECT_CREATE_CONNECTION,m),await this.createTransmitterConnection(_)};try{if(e==="retry"){const _=this._addresses[this.currentURLIndex];this.emit(Mi.RECONNECT_WAITTING_FINISH,e),await c(_,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let m=this.currentURLIndex;m<this._addresses.length;m++){if(this._addresses[m].fingerprint||Q("FINGERPRINT")){this.currentURLIndex=m;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return O.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);O.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const _=this._addresses[this.currentURLIndex];this.emit(Mi.RECONNECT_WAITTING_FINISH,e),await c(_,e)}else e==="recover"&&(O.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Mi.RECONNECT_WAITTING_FINISH,e),this.emit(Mi.FAILBACK));return!0}catch(_){var u,h;return O.error("[".concat(this._name,"] reconnect failed"),_.toString()),_!=null&&(u=_.data)!==null&&u!==void 0&&u.desc&&Array.isArray(_.data.desc)&&_.data.desc.length&&Jt(h=_.data.desc).call(h,"dynamic key expired")?(this.emit(Mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,i)}}}class zd extends oi{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Me.CONNECTED?this.emit(Gt.WS_CONNECTED):e===Me.RECONNECTING?this.emit(Gt.WS_RECONNECTING,this._websocketReconnectReason):e===Me.CLOSED&&this.emit(Gt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),A(this,"_disconnectedReason",void 0),A(this,"_websocketReconnectReason",void 0),A(this,"_connectionState",Me.CLOSED),A(this,"reconnectToken",void 0),A(this,"websocket",void 0),A(this,"openConnectionTime",void 0),A(this,"clientId",void 0),A(this,"lastMsgTime",Date.now()),A(this,"uploadCache",[]),A(this,"uploadCacheInterval",void 0),A(this,"rttRolling",new FS(5)),A(this,"pingpongTimer",void 0),A(this,"inflateDataTimer",void 0),A(this,"pingpongTimeoutCount",0),A(this,"joinResponse",void 0),A(this,"multiIpOption",void 0),A(this,"initError",void 0),A(this,"spec",void 0),A(this,"store",void 0),A(this,"onWebsocketMessage",o=>{if(o instanceof ArrayBuffer)return void this.emit(Gt.ON_BINARY_DATA,o);const c=JSON.parse(o);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(c,"_id")){const u="res-@".concat(c._id);this.emit(u,c._result,c._message)}else if(Object.prototype.hasOwnProperty.call(c,"_type")&&(this.emit(c._type,c._message),c._type===Re.ON_NOTIFICATION&&this.handleNotification(c._message),c._type===Re.ON_USER_BANNED))switch(c._message.error_code){case 14:this.close(Fe.UID_BANNED);break;case 15:this.close(Fe.IP_BANNED);break;case 16:this.close(Fe.CHANNEL_BANNED)}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new mR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Me.CONNECTED&&this.reconnect("retry",vc.OFFLINE)})}async request(e,i,o,c){const u=Hn(6,""),h={_id:u,_type:e,_message:i},_=this.websocket.connectionID,m=()=>new ut((x,D)=>{if(this.connectionState===Me.CONNECTED)return x();const M=()=>{this.off(Gt.WS_CLOSED,K),x()},K=()=>{this.off(Gt.WS_CONNECTED,M),D(new st(j.WS_ABORT))};this.once(Gt.WS_CONNECTED,M),this.once(Gt.WS_CLOSED,K),e!==ie.PUBLISH&&e!==ie.SUBSCRIBE&&e!==ie.UNSUBSCRIBE&&e!==ie.UNPUBLISH&&e!==ie.CONTROL&&e!==ie.RESTART_ICE||this.once(Gt.DISCONNECT_P2P,()=>{D(new st(j.DISCONNECT_P2P))}),e!==ie.PUBLISH&&e!==ie.RESTART_ICE||this.once(Gt.ABORT_P2P_EXECUTION,()=>{D(new st(j.DISCONNECT_P2P))})});if(this.connectionState!==Me.CONNECTING&&this.connectionState!==Me.RECONNECTING||e===ie.JOIN||e===ie.REJOIN||await m(),e===ie.LEAVE&&(this.websocket.unbindDcCloseEventListener(),c=!0),this.websocket.sendMessage(h,!0,!1),c)return;const g=new ut((x,D)=>{let M=!1;const K=(nt,dt)=>{M=!0,x({isSuccess:nt==="success",message:dt||{}}),this.off(Gt.WS_CLOSED,z),this.off(Gt.WS_RECONNECTING,z),this.emit(Gt.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(u),K);const z=()=>{D(new st(j.WS_ABORT,"type: ".concat(e))),this.off(Gt.WS_CLOSED,z),this.off(Gt.WS_RECONNECTING,z),this.off("res-@".concat(u),K)};this.once(Gt.WS_CLOSED,z),this.once(Gt.WS_RECONNECTING,z),Mr(Q("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==_||M||(O.warning("dc request timeout, type: ".concat(e)),this.emit(Gt.REQUEST_TIMEOUT,e,i))})});let S=null;try{S=await g}catch(x){if(this.connectionState===Me.CLOSED||e===ie.LEAVE)throw new st(j.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?x.throw():e===ie.JOIN||e===ie.REJOIN?null:(await m(),await this.request(e,i))}if(S.isSuccess)return S.message;const C=Number(S.message.error_code||S.message.code),I=Yd(C),b=new st(j.UNEXPECTED_RESPONSE,"".concat(I.desc,": ").concat(S.message.error_str),{code:C,data:S.message});return I.action==="success"?S.message:(O.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(C,", message: ").concat(I.desc,", action: ").concat(I.action)),C===ae.ERR_TOO_MANY_BROADCASTERS?((e===ie.JOIN||e===ie.REJOIN)&&(this.initError=b,this.close()),b.throw()):I.action==="failed"?b.throw():I.action==="quit"?(this.initError=b,this.close(),b.throw()):(C===ae.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=S.message.option,O.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",vc.MULTI_IP)):this.reconnect(I.action,vc.SERVER_ERROR),e===ie.JOIN||e===ie.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new ut(o=>{const c=u=>{(!i||i(u))&&(this.off(e,c),o(u))};this.on(e,c)})}uploadWRTCStats(e){if(!this.store.sessionId)return void O.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(rd.WRTC_STATS,i)}upload(e,i){const o={_type:e,_message:i};try{this.websocket.sendMessage(o)}catch{const u=Q("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(o),this.uploadCache.length>u&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Me.CONNECTED)return;const h=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(h._type,h._message)},Q("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const o={_type:e,_message:i};this.websocket.sendMessage(o)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ut((o,c)=>{this.once(Gt.WS_CONNECTED,()=>o(this.joinResponse)),this.once(Gt.WS_CLOSED,()=>c(this.initError||new st(j.WS_ABORT))),this.connectionState=Me.CONNECTING,this.websocket.init(e).catch(c),this.websocket.once(Mi.FAILBACK,()=>{this.openConnectionTime===void 0&&c(new st(j.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{i&&this.openConnectionTime===void 0&&(O.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),c(new st(j.INIT_DATACHANNEL_TIMEOUT)))},Q("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Fe.LEAVE,this.connectionState=Me.CLOSED,O.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===Fe.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new mR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(Gt.ABORT_P2P_EXECUTION);const e=await zi(this,Gt.DATACHANNEL_CONNECTING),i=await this.request(ie.JOIN,e);if(!i)return this.emit(Gt.REPORT_JOIN_GATEWAY,j.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(Gt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Me.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new st(j.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=gl(this,Gt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const i=await this.request(ie.REJOIN,e);return!!i&&(this.connectionState=Me.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(o=>{this.emit(Re.ON_USER_ONLINE,{uid:o.uid}),o.audio&&this.emit(Re.ON_ADD_AUDIO_STREAM,{uid:o.uid,uint_id:o.uint_id,audio:!0,ssrcId:o.audio_ssrc}),o.video&&this.emit(Re.ON_ADD_VIDEO_STREAM,{uid:o.uid,uint_id:o.uint_id,video:!0,ssrcId:o.video_ssrc}),o.audio_mute?this.emit(Re.MUTE_AUDIO,{uid:o.uid}):this.emit(Re.UNMUTE_AUDIO,{uid:o.uid}),o.video_mute?this.emit(Re.MUTE_VIDEO,{uid:o.uid}):this.emit(Re.UNMUTE_VIDEO,{uid:o.uid}),o.audio_enable_local?this.emit(Re.ENABLE_LOCAL_AUDIO,{uid:o.uid}):this.emit(Re.DISABLE_LOCAL_AUDIO,{uid:o.uid}),o.video_enable_local?this.emit(Re.ENABLE_LOCAL_VIDEO,{uid:o.uid}):this.emit(Re.DISABLE_LOCAL_VIDEO,{uid:o.uid}),o.audio||o.video||this.emit(Re.ON_REMOVE_STREAM,{uid:o.uid,uint_id:o.uint_id})}),!0)}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleNotification(e){O.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Yd(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Fe.UID_BANNED),void this.close()):void this.reconnect(i.action,vc.SERVER_ERROR);O.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Q("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(O.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>Q("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",vc.TIMEOUT):this.request(ie.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const o=Date.now()-i;this.rttRolling.add(o),Q("REPORT_STATS")&&this.send(ie.PING_BACK,{pingpongElapse:o})}).catch(o=>{})}handleInflateData(){const{inflateLength:e,deflateLength:i}=this.websocket.getInflateData();e!==0&&i!==0&&this.upload(rd.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Mi.RECONNECT_WAITTING_FINISH,e=>{this.emit(Gt.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Mi.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Gt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Mi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Mi.CLOSED,()=>{this.connectionState=Me.CLOSED}),this.websocket.on(Mi.FAILED,()=>{this._disconnectedReason=Fe.NETWORK_ERROR,this.connectionState=Me.CLOSED}),this.websocket.on(Mi.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Me.CONNECTED?this.connectionState=Me.RECONNECTING:this.connectionState=Me.CONNECTING}),this.websocket.on(Mi.WILL_RECONNECT,(e,i)=>{if(gl(this,Gt.IS_P2P_DISCONNECTED)&&e==="retry")return O.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Gt.NEED_RENEW_SESSION),this.emit(Gt.DISCONNECT_P2P),i("tryNext");e!=="retry"&&(O.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Gt.NEED_RENEW_SESSION),this.emit(Gt.DISCONNECT_P2P)),i(e)}),this.websocket.on(Mi.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{O.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",vc.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(Gt.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof st&&e.code===j.UNEXPECTED_RESPONSE&&e.data.code===ae.ERR_NO_AUTHORIZED)return O.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",vc.SERVER_ERROR);O.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",vc.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Mi.REQUEST_NEW_URLS,(e,i)=>{zi(this,Gt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(Mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Re.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(Mi.TO_CONNECT_DATACHANNEL,async(e,i,o)=>zi(this,Gt.DATACHANNEL_PRECONNECT,e).then(i).catch(o)),this.websocket.on(Mi.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(Gt.DATACHANNEL_FAILBACK)})}}class Vu extends oi{constructor(e,i){super(),A(this,"signal",void 0),A(this,"token",void 0),A(this,"tokenTimeout",void 0),A(this,"tokenInterval",void 0),A(this,"_sequence",0),A(this,"userMap",new Map),A(this,"encoder",new TextEncoder),this.signal=e,this.token=i;const o=()=>{this.signal.connectionState===Me.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(o,1e3):this.tokenInterval=window.setTimeout(o,3*Q("P2P_TOKEN_INTERVAL"))};o()}async send(e,i,o,c,u){var h,_,m;if(this.userMap.size===0)return;const g=Array.from(Rc(h=this.userMap).call(h))[0].token;typeof i!="string"&&(i=JSON.stringify(i)),c=(_=c)!==null&&_!==void 0?_:Hn(6,""),u=(m=u)!==null&&m!==void 0?m:this._sequence++;const S={_id:c,_type:e,_seq:u,_message:i,token:"".concat(this.token,"_").concat(g)};Q("SHOW_P2P_LOG")&&O.debug("send message",S,"noNeedResponse : ".concat(o)),this.splitMessage(JSON.stringify(S)).forEach(I=>{this.signal.request(ie.DATA_STREAM,{payload:Qh(this.encoder.encode(I))})});const C=new ut((I,b)=>{const x=window.setTimeout(()=>{this.off("res-@".concat(c,"_ack"),D),this.off("res-@".concat(c),K),this.off(sd.ABORT,M),O.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(c)),this.userMap.size===0?b(new ft(j.INVALID_REMOTE_USER)):b(new ft(j.TIMEOUT))},Q("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),D=()=>{x&&window.clearTimeout(x),this.off(sd.ABORT,M),o&&I()},M=()=>{x&&window.clearTimeout(x),this.off("res-@".concat(c,"_ack"),D),this.off("res-@".concat(c),K),b(new ft(j.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(c)))};this.once(sd.ABORT,M),this.once("res-@".concat(c,"_ack"),D);const K=(nt,dt)=>{z=!0,x&&window.clearTimeout(x),this.off("res-@".concat(c,"_ack"),D),this.off(sd.ABORT,M),nt==="success"?I(dt):b(new ft(j.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(c)))};let z=!1;o||(this.once("res-@".concat(c),K),Mr(Q("SIGNAL_REQUEST_TIMEOUT")).then(()=>{z||O.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(c,", ").concat(S))}))});try{return await C}catch(I){if(I.code===j.TIMEOUT)return await this.send(e,i,o,c,u);throw I}}onMessage(e){var i;const{_uid:o}=e;let c,u=this.userMap.get(o);if(u)c=u.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==li.CHECK)return;const{token:g}=e;c=new Map,u={uid:o,isStart:!0,token:g,splitMessageMap:c,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(o,u),this.signal.emit(Re.ON_USER_ONLINE,{uid:o}),this.handleUserOnline()}if("id"in e&&"total"in e){var h;const{id:g,total:S}=e,C=(h=c.get(g))!==null&&h!==void 0?h:[];if(C.push(e),c.has(g)||c.set(g,C),C.length!==S)return;{const I=l_(C).call(C,(b,x)=>b.index-x.index).map(b=>b.payload).join("");c.delete(g),(e=JSON.parse(I))._uid=o}}const{_type:_,token:m}=e;if(Jt(i=[li.ACK,li.CHECK]).call(i,_))return _===li.CHECK&&this.handleCheckToken(u,m),void this.receiveMessage(e);m==="".concat(u.token,"_").concat(this.token)?this.handleReceivedMessage(e):O.debug('Receive unexpected message", '.concat(m,", cur_token: ").concat(u.token,"_").concat(this.token),e)}check(){const e={_id:Hn(6,""),token:this.token,_type:li.CHECK};Q("SHOW_P2P_LOG")&&O.debug("send message",e),this.signal.request(ie.DATA_STREAM,{payload:Qh(this.encoder.encode(JSON.stringify(e)))})}ack(e){const i={_id:e,_type:li.ACK,token:this.token};Q("SHOW_P2P_LOG")&&O.debug("send message",i),this.signal.request(ie.DATA_STREAM,{payload:Qh(this.encoder.encode(JSON.stringify(i)))})}response(e,i,o){this.send(li.RESPONSE,JSON.stringify({success:!o,message:i}),!0,e)}handleReceivedMessage(e){const i=()=>{this.userMap.forEach(g=>{const{receivedMessagesMap:S,nextExpectedSequenceNumber:C}=g;for(;S.has(C);){const I=S.get(C);S.delete(C),this.receiveMessage(I),g.nextExpectedSequenceNumber++}})};if(!e)return void i();const{_uid:o,_seq:c}=e,u=this.userMap.get(o),{receivedMessagesMap:h,isStart:_,nextExpectedSequenceNumber:m}=u;if(c<m)return this.ack(e._id),void O.debug("[external-signal] receive old message, seq: ".concat(c,", ").concat(e._message));h.set(c,e),_&&c===m&&(this.receiveMessage(e),h.delete(m),u.nextExpectedSequenceNumber++,i())}receiveMessage(e){const{_id:i,_type:o,_message:c,_uid:u}=e;if(Q("SHOW_P2P_LOG")&&O.debug("receive message",e),i){let h;switch(e._type!==li.ACK&&(c&&(h=JSON.parse(c)),this.ack(e._id)),e._type){case li.CANDIDATE:case li.CONTROL:this.signal.emit(o,h,u);break;case li.PUBLISH:case li.UNPUBLISH:case li.RESTART_ICE:case li.CALL:h.uid=u,zi(this.signal,o,h).then(_=>{this.response(e._id,_)}).catch(()=>{this.response(e._id,void 0,!0)});break;case li.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case li.RESPONSE:{const{success:_,message:m}=h;this.emit("res-@".concat(i),_?"success":"failed",m);break}}}}splitMessage(e){if(e.length<Vu.MAX_MESSAGE_SIZE)return[e];const i=[],{remoteToken:o}=JSON.parse(e),c=Hn(6,"");let u=0,h=800;const _=Math.ceil(e.length/h);for(;e.length>0;){u++;const m={id:c,index:u,total:_,payload:e.slice(0,h),token:"".concat(this.token,"_").concat(o)};JSON.stringify(m).length>Vu.MAX_MESSAGE_SIZE?h-=50:(i.push(m),e=e.slice(h))}return i.map(m=>JSON.stringify(m))}handleCheckToken(e,i){return e.token!==i?(O.debug("token changed, from ".concat(e.token," to ").concat(i)),this.reset(e.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{O.debug("token timeout, ".concat(i)),this.reset(e.uid)},Q("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await zi(this.signal,li.CALL,void 0),i=await this.send(li.CALL,e);this.signal.emit(Gt.P2P_CONNECTION,i,!0)}async reset(e,i){const o=this.userMap.get(e);o&&(this.emit(sd.ABORT),this.signal.emit(Re.ON_USER_OFFLINE,{uid:o.uid,reason:_f.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(O.debug("change local token from ".concat(i," to ").concat(i)),this.token=Hn(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(sd.ABORT)}}A(Vu,"MAX_SIZE",1),A(Vu,"MAX_MESSAGE_SIZE",1024);class _b extends oi{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Me.CONNECTED?this.emit(Gt.WS_CONNECTED):e===Me.RECONNECTING?this.emit(Gt.WS_RECONNECTING,this._websocketReconnectReason):e===Me.CLOSED&&this.emit(Gt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),A(this,"_disconnectedReason",void 0),A(this,"_websocketReconnectReason",void 0),A(this,"_connectionState",Me.CLOSED),A(this,"reconnectToken",void 0),A(this,"p2pToken",void 0),A(this,"websocket",void 0),A(this,"openConnectionTime",void 0),A(this,"clientId",void 0),A(this,"lastMsgTime",Date.now()),A(this,"uploadCache",[]),A(this,"uploadCacheInterval",void 0),A(this,"rttRolling",new FS(5)),A(this,"pingpongTimer",void 0),A(this,"pingpongTimeoutCount",0),A(this,"joinResponse",void 0),A(this,"multiIpOption",void 0),A(this,"initError",void 0),A(this,"spec",void 0),A(this,"store",void 0),A(this,"_external_signal",void 0),A(this,"onWebsocketMessage",o=>{if(o.data instanceof ArrayBuffer)return void this.emit(Gt.ON_BINARY_DATA,o.data);const c=JSON.parse(o.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(c,"_id")){const u="res-@".concat(c._id);this.emit(u,c._result,c._message)}else if(Object.prototype.hasOwnProperty.call(c,"_type")){switch(c._type){case Re.ON_DATA_STREAM:return void this.handleDataStream(c._message);case Re.MUTE_AUDIO:case Re.MUTE_VIDEO:case Re.ON_P2P_LOST:case Re.ON_USER_ONLINE:return;case Re.ON_USER_OFFLINE:const{uid:u}=c._message;return O.debug("[".concat(this.clientId,"] user-offline uid: ").concat(u)),void this._external_signal.reset(u)}if(this.emit(c._type,c._message),c._type===Re.ON_NOTIFICATION&&this.handleNotification(c._message),c._type===Re.ON_USER_BANNED)switch(c._message.error_code){case 14:this.close(Fe.UID_BANNED);break;case 15:this.close(Fe.IP_BANNED);break;case 16:this.close(Fe.CHANNEL_BANNED)}if(c._type===Re.ON_USER_LICENSE_BANNED)switch(c._message.error_code){case ae.ERR_LICENSE_MISSING:this.close(Fe.LICENSE_MISSING);break;case ae.ERR_LICENSE_EXPIRED:this.close(Fe.LICENSE_EXPIRED);break;case ae.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Fe.LICENSE_MINUTES_EXCEEDED);break;case ae.ERR_LICENSE_PERIOD_INVALID:this.close(Fe.LICENSE_PERIOD_INVALID);break;case ae.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Fe.LICENSE_MULTIPLE_SDK_SERVICE);break;case ae.ERR_LICENSE_ILLEGAL:this.close(Fe.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new Ac("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Q("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Q("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Me.CONNECTED&&this.reconnect("retry",Tr.OFFLINE)}),this.p2pToken=Hn(6,""),this._external_signal=new Vu(this,this.p2pToken)}async request(e,i,o,c){const u=Hn(6,""),h={_id:u,_type:e,_message:i},_=this.websocket.connectionID,m=()=>new ut((x,D)=>{if(this.connectionState===Me.CONNECTED)return x();const M=()=>{this.off(Gt.WS_CLOSED,K),x()},K=()=>{this.off(Gt.WS_CONNECTED,M),D(new ft(j.WS_ABORT))};this.once(Gt.WS_CONNECTED,M),this.once(Gt.WS_CLOSED,K)});if(this.connectionState!==Me.CONNECTING&&this.connectionState!==Me.RECONNECTING||e===ie.JOIN||e===ie.REJOIN||await m(),this.websocket.sendMessage(h,!0),c)return;const g=new ut((x,D)=>{let M=!1;const K=(nt,dt)=>{M=!0,x({isSuccess:nt==="success",message:dt||{}}),this.off(Gt.WS_CLOSED,z),this.off(Gt.WS_RECONNECTING,z),this.emit(Gt.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(u),K);const z=()=>{D(new ft(j.WS_ABORT,"type: ".concat(e))),this.off(Gt.WS_CLOSED,z),this.off(Gt.WS_RECONNECTING,z),this.off("res-@".concat(u),K)};this.once(Gt.WS_CLOSED,z),this.once(Gt.WS_RECONNECTING,z),Mr(Q("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==_||M||(O.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Gt.REQUEST_TIMEOUT,e,i))})});let S=null;try{S=await g}catch(x){if(this.connectionState===Me.CLOSED||e===ie.LEAVE)throw new ft(j.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?x.throw():e===ie.JOIN||e===ie.REJOIN?null:(await m(),await this.request(e,i))}if(S.isSuccess)return S.message;const C=Number(S.message.error_code||S.message.code),I=Yd(C),b=new ft(j.UNEXPECTED_RESPONSE,"".concat(I.desc,": ").concat(S.message.error_str),{code:C,data:S.message});return I.action==="success"?S.message:(O.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(C,", message: ").concat(I.desc,", action: ").concat(I.action)),C===ae.ERR_TOO_MANY_BROADCASTERS?((e===ie.JOIN||e===ie.REJOIN)&&(this.initError=b,this.close()),b.throw()):I.action==="failed"?b.throw():I.action==="quit"?(this.initError=b,this.close(),b.throw()):(C===ae.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=S.message.option,O.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Tr.MULTI_IP)):this.reconnect(I.action,Tr.SERVER_ERROR),e===ie.JOIN||e===ie.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new ut(o=>{const c=u=>{(!i||i(u))&&(this.off(e,c),o(u))};this.on(e,c)})}uploadWRTCStats(e){if(!this.store.sessionId)return void O.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(rd.WRTC_STATS,i)}upload(e,i){const o={_type:e,_message:i};try{this.websocket.sendMessage(o)}catch{const u=Q("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(o),this.uploadCache.length>u&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Me.CONNECTED)return;const h=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(h._type,h._message)},Q("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const o={_type:e,_message:i};this.websocket.sendMessage(o)}async sendExtensionMessage(e,i,o){return await this._external_signal.send(e,i,o)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ut((i,o)=>{this.once(Gt.WS_CONNECTED,()=>i(this.joinResponse)),this.once(Gt.WS_CLOSED,()=>o(this.initError||new ft(j.WS_ABORT))),this.connectionState=Me.CONNECTING,this.websocket.init(e).catch(o)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Fe.LEAVE,this.connectionState=Me.CLOSED,O.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===Fe.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ac("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Q("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Q("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=Hn(6,""),this._external_signal.clear(),this._external_signal=new Vu(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Gt.ABORT_P2P_EXECUTION);const e=await zi(this,Gt.REQUEST_JOIN_INFO),i=await this.request(ie.JOIN,e);if(!i)return this.emit(Gt.REPORT_JOIN_GATEWAY,j.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(Gt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Me.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleDataStream(e){try{var i;const o=D_(e.payload),c=new TextDecoder().decode(o),u=JSON.parse(c);"total"in u&&"id"in u||Jt(i=Object.values(li)).call(i,u._type)?(u._uid=e.uid,this._external_signal.onMessage(u)):this.emit(Re.ON_DATA_STREAM,e)}catch{this.emit(Re.ON_DATA_STREAM,e)}}handleNotification(e){O.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Yd(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Fe.UID_BANNED),void this.close()):void this.reconnect(i.action,Tr.SERVER_ERROR);O.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Q("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(O.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>Q("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Tr.TIMEOUT):this.request(ie.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const o=Date.now()-i;this.rttRolling.add(o),Q("REPORT_STATS")&&this.send(ie.PING_BACK,{pingpongElapse:o})}).catch(o=>{})}handleWebsocketEvents(){this.websocket.on(Se.RECONNECT_WAITTING_FINISH,e=>{this.emit(Gt.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Se.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Gt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Se.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Se.CLOSED,()=>{this.connectionState=Me.CLOSED}),this.websocket.on(Se.FAILED,()=>{this._disconnectedReason=Fe.NETWORK_ERROR,this.connectionState=Me.CLOSED}),this.websocket.on(Se.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Me.CONNECTED?this.connectionState=Me.RECONNECTING:this.connectionState=Me.CONNECTING}),this.websocket.on(Se.WILL_RECONNECT,(e,i,o)=>{e!=="retry"?(O.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Gt.NEED_RENEW_SESSION)):O.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),o(e)}),this.websocket.on(Se.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(Gt.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof ft&&e.code===j.UNEXPECTED_RESPONSE&&e.data.code===ae.ERR_NO_AUTHORIZED)return O.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Tr.SERVER_ERROR);O.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Tr.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Se.REQUEST_NEW_URLS,(e,i)=>{zi(this,Gt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(Se.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Re.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function fR(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function An(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?fR(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):fR(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}const cp=new Map;class pk extends oi{get state(){return this._state}set state(e){if(e===this._state)return;const i=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(Ni.CONNECTION_STATE_CHANGE,e,i,this._disconnectedReason):this.emit(Ni.CONNECTION_STATE_CHANGE,e,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){O.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,i){super(),A(this,"store",void 0),A(this,"joinInfo",void 0),A(this,"key",void 0),A(this,"ntpOffset",0),A(this,"signal",void 0),A(this,"role",void 0),A(this,"inChannelInfo",{joinAt:null,duration:0}),A(this,"spec",void 0),A(this,"_state","DISCONNECTED"),A(this,"_statsCollector",void 0),A(this,"_disconnectedReason",void 0),A(this,"isSignalRecover",!1),A(this,"hasChangeBGPAddress",!1),A(this,"trafficStatsInterval",void 0),A(this,"networkQualityInterval",void 0),A(this,"_joinGatewayStartTime",0),A(this,"_signalTimeout",!1),A(this,"_clientRoleOptions",void 0),A(this,"_isProactiveJoin",!1),this.store=e,this.spec=i,this.signal=this.store.useP2P?new _b(An(An({},i),{},{retryConfig:i.websocketRetryConfig}),e):this.store.useDataChannel?new zd(An(An({},i),{},{retryConfig:i.websocketRetryConfig}),e):new db(An(An({},i),{},{retryConfig:i.websocketRetryConfig}),e),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}async join(e,i,o){if(this.signal instanceof zd){let m=!1;e.cloudProxyServer!=="disabled"?(O.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),m=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(O.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),m=!0):e.apResponse.addresses.some(g=>g.fingerprint)||Q("FINGERPRINT")||(O.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),m=!0),m&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const c=Date.now();let u=cp.get(e.cname);if(u||(u=new Map,cp.set(e.cname,u)),this._isProactiveJoin=!0,u.has(e.uid)){const m=new st(j.UID_CONFLICT);throw ne.joinGateway(e.sid,{lts:c,succ:!1,ec:m.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof zd?"1":"0"}),this._isProactiveJoin=!1,m}u.set(e.uid,!0),this.joinInfo=e,this.key=i;let h=0;this.joinGatewayStartTime=c;const _=e.proxyServer;try{let m;if(O.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof zd?"datachannel":"websocket"," join uid ").concat(h)),this.signal instanceof zd)m=await this.signal.init(e.apResponse.addresses,o);else{const g=e.gatewayAddrs.map(S=>{let{address:C}=S;const[I,b]=C.split(":"),x={host:I,port:b};return e.proxyServer&&(x.proxy=e.proxyServer),x});m=await this.signal.init(g,o)}h=m.uid,O.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof zd?"datachannel":"websocket"," join uid ").concat(h," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(m){throw m&&m.code===j.INIT_WEBSOCKET_TIMEOUT?(O.warning("[".concat(this.store.clientId,"] User join failed"),m.toString()),m):m&&m.code===j.INIT_DATACHANNEL_TIMEOUT?(O.warning("[".concat(this.store.clientId,"] User join datachannel failed"),m.toString()),this.resetSignal(),m):(O.error("[".concat(this.store.clientId,"] User join failed"),m.toString()),ne.joinGateway(e.sid,{lts:c,succ:!1,ec:m.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!_,signalChannel:this.signal instanceof zd?"1":"0"}),this._isProactiveJoin=!1,u.delete(e.uid),this.signal.close(),m)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),O.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(m=>{O.warning("[".concat(this.store.clientId,"] get traffic stats error"),m.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Ni.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Ni.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Ni.NETWORK_QUALITY,{uplinkNetworkQuality:lr(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:lr(this._statsCollector.trafficStats.B_dnq)}):this.emit(Ni.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),h}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==Fe.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Me.CONNECTED||await function(o,c){return c===1/0?o:ut.race([o,fL(c)])}(this.signal.request(ie.LEAVE,void 0,!0),3e3)}catch(o){O.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),o)}this.signal.close(i),i!==Fe.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const c={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:Q("PUB_EXTEND"),twcc:!!Q("PUBLISH_TWCC"),rtx:!!Q("USE_PUB_RTX")};try{return(await this.signal.request(ie.PUBLISH,c,!0))._message}catch(u){if(o&&u.data&&u.data.code===ae.ERR_PUBLISH_REQUEST_INVALID)return O.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),u.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw u}}async publishDataChannel(e,i,o){var c;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const u={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:(c=i.maxRetransmits)!==null&&c!==void 0?c:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(ie.PUBLISH_DATASTREAM,u,!0)}catch(h){if(o&&h.data&&h.data.code===ae.ERR_PUBLISH_REQUEST_INVALID)return O.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),h.toString()),await this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw h}}async unpublish(e,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ie.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(o){O.warning("[".concat(this.store.clientId,"] unpublish warning: "),o)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ut.all(e.map(i=>this.signal.request(ie.UNPUBLISH_DATASTREAM,{channel_id:i},!0)))}catch(i){O.warning("unpublish datachannels warning: ",i)}}async presubscribe(e,i,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const c={stream_id:e,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Q("SUBSCRIBE_TWCC"),rtx:!!Q("USE_SUB_RTX")||void 0,extend:Q("SUB_EXTEND"),svc:Array.isArray(Q("SVC"))&&Q("SVC").length!==0?Q("SVC"):void 0};try{return await this.signal.request(ie.PRE_SUBSCRIBE,c,!0)}catch(u){if(o&&u.data&&u.data.code===ae.ERR_SUBSCRIBE_REQUEST_INVALID)return O.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),u.toString()),this.presubscribe(e,i,!1);throw u}}async subscribe(e,i,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const c={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Q("SUBSCRIBE_TWCC"),rtx:!!Q("USE_SUB_RTX"),extend:Q("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(Q("SVC"))&&Q("SVC").length!==0?Q("SVC"):void 0};try{return(await this.signal.request(ie.SUBSCRIBE,c,!0))._message}catch(u){if(o&&u.data&&u.data.code===ae.ERR_SUBSCRIBE_REQUEST_INVALID)return O.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),u.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw u}}async subscribeDataChannel(e,i,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const c={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(ie.SUBSCRIBE_DATASTREAM,c,!0)}catch(u){if(o&&u.data&&u.data.code===ae.ERR_SUBSCRIBE_REQUEST_INVALID)return O.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),u.toString()),await this.tryUnsubDataChannelBeforeResub(e,i),await this.subscribeDataChannel(e,i,!1);throw u}}async subscribeAll(e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const o={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!Q("USE_SUB_RTX")};try{return await this.signal.request(ie.SUBSCRIBE_STREAMS,o,!0)}catch(c){if(i&&c.data&&c.data.code===ae.ERR_SUBSCRIBE_REQUEST_INVALID)return O.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),c.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw c}}async setVideoProfile(e){const i=function(o){if(!(o.bitrateMax&&o.bitrateMin&&o.frameRate&&o.height&&o.width))return;let c=o.frameRate,u=o.width,h=o.height,_=!0;return typeof c!="number"&&(c=c.exact||c.ideal||c.max||c.min||0,c||(_=!1)),typeof u!="number"&&(u=u.exact||u.ideal||u.max||u.min||0,u||(_=!1)),typeof h!="number"&&(h=h.exact||h.ideal||h.max||h.min||0,c||(_=!1)),_?{stream_type:0,width:u,height:h,fps:c,start_bps:1e3*o.bitrateMax,min_bps:1e3*o.bitrateMin,target_bps:1e3*o.bitrateMax}:void 0}(e);if(i)return this.signal.request(ie.SET_VIDEO_PROFILE,i);O.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(ie.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(o){O.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),o)}}async unsubscribeDataChannel(e,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ut.all(e.map(o=>this.signal.request(ie.UNSUBSCRIBE_DATASTREAM,{stream_id:o,uid:i},!0)))}catch(o){O.warning("unsubscribeDataChannel warning: ",o)}}async massUnsubscribe(e){try{await this.signal.request(ie.UNSUBSCRIBE_STREAMS,e,!0)}catch(i){O.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),i)}}async reconnectPC(e){const{iceParameters:i,dtlsParameters:o,rtpCapabilities:c}=e;return{gatewayEstablishParams:await this.signal.request(ie.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:o,rtpCapabilities:c}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ie.GATEWAY_INFO)}async renewToken(e){await this.signal.request(ie.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,i){if(i&&(this._clientRoleOptions=Object.assign({},i)),this.state!=="CONNECTED")return void(this.role=e);let o,c=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(o=this._clientRoleOptions.delay,c=1):c=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:c=0,await this.signal.request(ie.SET_CLIENT_ROLE,{role:e,level:c,delay:o,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,i){await this.signal.request(ie.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:i})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(ie.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,i){await this.signal.request(ie.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:i})}async pickSVCLayer(e,i){await this.signal.request(ie.PICK_SVC_LAYER,{stream_id:e,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})}async setRTM2Flag(e){await this.signal.request(ie.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,i,o){if(this.signal instanceof _b)return this.signal.sendExtensionMessage(e,i,o)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),An({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(ie.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=cp.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(i){let o;return o=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),o?{username:Ps.username,password:Ps.password,turnServerURL:o[2],tcpport:parseInt(o[3])+30,udpport:parseInt(o[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(An(An({},Ps),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(ie.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(i=>{const o=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(c=>c.peer_uid===i.peer_uid);o&&o.B_st!==i.B_st&&MS(()=>{this.emit(Ni.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new st(j.UNEXPECTED_ERROR,"can not generate join message, no join info");const i=Object.assign({},this.joinInfo.apResponse);let o=Q("REPORT_APP_SCENARIO");if(typeof o!="string")try{o=JSON.stringify(o)}catch{o=void 0}o&&o.length>128&&(o=void 0);const c=An({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Ga,browser:navigator.userAgent,process_id:Q("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:i,extend:Q("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:o,attributes:{userAttributes:{enablePublishedUserList:Q("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:Q("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof Q("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?Q("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof Q("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?Q("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof Q("ENABLE_USER_LICENSE_CHECK")=="boolean"?Q("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:Q("USE_PUB_RTX")===!0||Q("USE_SUB_RTX")===!0||void 0,disableFEC:Q("DISABLE_FEC"),enableNTPReport:!!Q("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!Q("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof Q("ENABLE_DATASTREAM_2")=="boolean"?Q("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!Q("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof Q("USE_XR")=="boolean"?Q("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(c.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(c.aes_mode=this.joinInfo.aesmode,Q("ENCRYPT_AES")?(c.aes_secret=this.joinInfo.aespassword,c.aes_encrypt=!0):c.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(c.aes_salt=this.joinInfo.aessalt)),i.addresses[this.signal.websocket.currentURLIndex]&&(c.ap_response.ticket=i.addresses[this.signal.websocket.currentURLIndex].ticket,delete i.addresses),this.joinInfo.defaultVideoStream!==void 0&&(c.default_video_stream=this.joinInfo.defaultVideoStream),c}getRejoinMessage(){if(!this.joinInfo)throw new st(j.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Gt.WS_RECONNECT_WAITTING_FINISH,e=>{var i;Jt(i=["tryNext","recover"]).call(i,e)&&this.joinInfo&&ne.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(Gt.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(Gt.WS_RECONNECTING,e=>{this.joinInfo&&ne.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Tr.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",ne.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(Gt.WS_CLOSED,e=>{let i;switch(e){case Fe.LEAVE:i=Tr.LEAVE;break;case Fe.UID_BANNED:case Fe.IP_BANNED:case Fe.CHANNEL_BANNED:case Fe.SERVER_ERROR:i=Tr.SERVER_ERROR;break;case Fe.FALLBACK:i=Tr.FALLBACK;break;case Fe.LICENSE_MISSING:case Fe.LICENSE_EXPIRED:case Fe.LICENSE_MINUTES_EXCEEDED:case Fe.LICENSE_PERIOD_INVALID:case Fe.LICENSE_MULTIPLE_SDK_SERVICE:case Fe.LICENSE_ILLEGAL:case Fe.TOKEN_EXPIRE:i=e;break;default:i=Tr.NETWORK_ERROR}O.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+Tr.NETWORK_ERROR)),this.joinInfo&&ne.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===Fe.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=e,e!==Fe.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(Gt.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(O.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),ne.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof zd?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void O.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Mn("EVENT_REPORT_DOMAIN",e[1]),Mn("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Mn("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}),this.signal.on(Re.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(Gt.REQUEST_RECOVER,(e,i,o)=>{if(!this.joinInfo)return o(new st(j.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,zi(this,Ni.REQUEST_NEW_GATEWAY_LIST).then(i).catch(o)}),this.signal.on(Gt.REQUEST_JOIN_INFO,async e=>{var i;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:o,dtlsParameters:c,rtpCapabilities:u}=await zi(this,Ni.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(i=this.joinInfo)===null||i===void 0?void 0:i.turnServer});e(this.getJoinMessage({ortc:{iceParameters:o,dtlsParameters:c,rtpCapabilities:u,version:"2"}}))}),this.signal.on(Gt.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(Gt.REPORT_JOIN_GATEWAY,(e,i)=>{this.joinInfo&&(ne.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof zd?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(Gt.IS_P2P_DISCONNECTED,e=>{e(gl(this,Ni.IS_P2P_DISCONNECTED))}),this.signal.on(Gt.DISCONNECT_P2P,()=>{this.emit(Ni.DISCONNECT_P2P)}),this.signal.on(Gt.NEED_RENEW_SESSION,()=>{this.emit(Ni.NEED_RENEW_SESSION)}),this.signal.on(Gt.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(Gt.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(Gt.JOIN_RESPONSE,e=>{const i=this.getCurrentGatewayAddress();this.emit(Ni.JOIN_RESPONSE,e,i)}),this.signal.on(Gt.DATACHANNEL_PRECONNECT,async(e,i,o)=>{this.updateTurnConfigFromSignal();const c=this.getCurrentGatewayAddress();return zi(this,Ni.DATACHANNEL_PRECONNECT,e,c).then(i).catch(o)}),this.signal.on(Gt.DATACHANNEL_CONNECTING,async e=>{const{iceParameters:i,dtlsParameters:o,rtpCapabilities:c}=await zi(this,Ni.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:o,rtpCapabilities:c,version:"2"}}))}),this.signal.on(Gt.DATACHANNEL_FAILBACK,()=>{O.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Ni.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,i){try{await this.signal.request(ie.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(o){throw O.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),o),o}}async tryUnsubDataChannelBeforeResub(e,i){try{await this.signal.request(ie.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(o){throw O.warning("unsubscribe datachannel warning",o),o}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(ie.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(o){throw O.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),o),o}}async tryUnpubDataChannelBeforeRepub(e,i){try{await this.signal.request(ie.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(o){throw O.warning("unpublish datastream warning: ",o),o}}async tryMassUnsubBeforeResub(e){const i={users:e.map(o=>({stream_id:o.stream_id,stream_type:o.stream_type}))};try{await this.signal.request(ie.UNSUBSCRIBE_STREAMS,i,!0)}catch(o){throw O.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),o),o}}async muteLocal(e,i){const o={action:e.find(c=>c.stream_type===rn.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(ie.CONTROL,o,!0,!0)}catch(c){throw O.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),c),c}}async unmuteLocal(e,i){const o={action:e.find(c=>c.stream_type===rn.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(ie.CONTROL,o,!0,!0)}catch(c){throw O.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),c),c}}async muteRemote(e,i){const o={action:e===Xt.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(ie.CONTROL,o,!0,!0)}catch(c){throw O.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),c),c}}async unmuteRemote(e,i){const o={action:e===Xt.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(ie.CONTROL,o,!0,!0)}catch(c){throw O.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),c),c}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,i){this.signal.upload(e,i)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(ie.RESTART_ICE,i,!0)}catch(o){throw O.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),o),o}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,Tr.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!Q("GATEWAY_WSS_ADDRESS"))return(e=this.joinInfo)!==null&&e!==void 0&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(ie.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Fe.FALLBACK)),this.store.useDataChannel=!1,this.signal=new db(An(An({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Ni.RESET_SIGNAL,hf.websocket)}}let Gi=0,Si=0;function Jd(s,e,i,o){return new ut((c,u)=>{e.timeout=e.timeout||Q("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),Gi+=Gd(e.data)):i&&(e.data.size?Gi+=e.data.size:e.data instanceof FormData?Gi+=mL(e.data):Gi+=Gd(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=s,Ks.request(e).then(h=>{typeof h.data=="string"?Si+=Gd(h.data):h.data instanceof ArrayBuffer||h.data instanceof Uint8Array?Si+=h.data.byteLength:Si+=Gd(JSON.stringify(h.data)),o&&c({data:h.data,headers:h.headers}),c(h.data)}).catch(h=>{Ks.isCancel(h)?u(new st(j.OPERATION_ABORTED,"cancel token canceled")):h.code==="ECONNABORTED"?u(new st(j.NETWORK_TIMEOUT,h.message)):h.response?u(new st(j.NETWORK_RESPONSE_ERROR,h.response.status)):u(new st(j.NETWORK_ERROR,h.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var s;function e(St){var Dt=0;return function(){return Dt<St.length?{done:!1,value:St[Dt++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(St,Dt,zt){return St==Array.prototype||St==Object.prototype||(St[Dt]=zt.value),St},o,c=function(St){St=[typeof globalThis=="object"&&globalThis,St,typeof window=="object"&&window,typeof self=="object"&&self,typeof mt=="object"&&mt];for(var Dt=0;Dt<St.length;++Dt){var zt=St[Dt];if(zt&&zt.Math==Math)return zt}throw Error("Cannot find global object")}(this);function u(St,Dt){if(Dt)t:{var zt=c;St=St.split(".");for(var ye=0;ye<St.length-1;ye++){var an=St[ye];if(!(an in zt))break t;zt=zt[an]}(Dt=Dt(ye=zt[St=St[St.length-1]]))!=ye&&Dt!=null&&i(zt,St,{configurable:!0,writable:!0,value:Dt})}}function h(St){return(St={next:St})[Symbol.iterator]=function(){return this},St}function _(St){var Dt=typeof Symbol<"u"&&Symbol.iterator&&St[Symbol.iterator];return Dt?Dt.call(St):{next:e(St)}}if(u("Symbol",function(St){function Dt(an,xt){this.A=an,i(this,"description",{configurable:!0,writable:!0,value:xt})}if(St)return St;Dt.prototype.toString=function(){return this.A};var zt="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",ye=0;return function an(xt){if(this instanceof an)throw new TypeError("Symbol is not a constructor");return new Dt(zt+(xt||"")+"_"+ye++,xt)}}),u("Symbol.iterator",function(St){if(St)return St;St=Symbol("Symbol.iterator");for(var Dt="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),zt=0;zt<Dt.length;zt++){var ye=c[Dt[zt]];typeof ye=="function"&&typeof ye.prototype[St]!="function"&&i(ye.prototype,St,{configurable:!0,writable:!0,value:function(){return h(e(this))}})}return St}),typeof Object.setPrototypeOf=="function")o=Object.setPrototypeOf;else{var m;t:{var g={};try{g.__proto__={a:!0},m=g.a;break t}catch{}m=!1}o=m?function(St,Dt){if(St.__proto__=Dt,St.__proto__!==Dt)throw new TypeError(St+" is not extensible");return St}:null}var S=o;function C(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function I(St){if(St.m)throw new TypeError("Generator is already running");St.m=!0}function b(St,Dt){return St.h=3,{value:Dt}}function x(St){this.g=new C,this.G=St}function D(St,Dt,zt,ye){try{var an=Dt.call(St.g.j,zt);if(!(an instanceof Object))throw new TypeError("Iterator result "+an+" is not an object");if(!an.done)return St.g.m=!1,an;var xt=an.value}catch(P){return St.g.j=null,St.g.s(P),M(St)}return St.g.j=null,ye.call(St.g,xt),M(St)}function M(St){for(;St.g.h;)try{var Dt=St.G(St.g);if(Dt)return St.g.m=!1,{value:Dt.value,done:!1}}catch(zt){St.g.v=void 0,St.g.s(zt)}if(St.g.m=!1,St.g.l){if(Dt=St.g.l,St.g.l=null,Dt.F)throw Dt.D;return{value:Dt.return,done:!0}}return{value:void 0,done:!0}}function K(St){this.next=function(Dt){return St.o(Dt)},this.throw=function(Dt){return St.s(Dt)},this.return=function(Dt){return function(zt,ye){I(zt.g);var an=zt.g.j;return an?D(zt,"return"in an?an.return:function(xt){return{value:xt,done:!0}},ye,zt.g.return):(zt.g.return(ye),M(zt))}(St,Dt)},this[Symbol.iterator]=function(){return this}}function z(St,Dt){return Dt=new K(new x(Dt)),S&&St.prototype&&S(Dt,St.prototype),Dt}if(C.prototype.o=function(St){this.v=St},C.prototype.s=function(St){this.l={D:St,F:!0},this.h=this.C||this.u},C.prototype.return=function(St){this.l={return:St},this.h=this.u},x.prototype.o=function(St){return I(this.g),this.g.j?D(this,this.g.j.next,St,this.g.o):(this.g.o(St),M(this))},x.prototype.s=function(St){return I(this.g),this.g.j?D(this,this.g.j.throw,St,this.g.o):(this.g.s(St),M(this))},u("Array.prototype.entries",function(St){return St||function(){return function(Dt,zt){Dt instanceof String&&(Dt+="");var ye=0,an=!1,xt={next:function(){if(!an&&ye<Dt.length){var P=ye++;return{value:zt(P,Dt[P]),done:!1}}return an=!0,{done:!0,value:void 0}}};return xt[Symbol.iterator]=function(){return xt},xt}(this,function(Dt,zt){return[Dt,zt]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var nt=function(St,Dt){for(var zt=0;zt<St.length;zt++)Dt(St[zt])},dt=function(St){return St.replace(/\r?\n|\r/g,`\r
`)},it=function(St,Dt,zt){return Dt instanceof Blob?(zt=zt!==void 0?zt+"":typeof Dt.name=="string"?Dt.name:"blob",Dt.name===zt&&Object.prototype.toString.call(Dt)!=="[object Blob]"||(Dt=new File([Dt],zt)),[String(St),Dt]):[String(St),String(Dt)]},at=function(St,Dt){if(St.length<Dt)throw new TypeError(Dt+" argument required, but only "+St.length+" present.")},ht=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,pt=ht.FormData,bt=ht.XMLHttpRequest&&ht.XMLHttpRequest.prototype.send,kt=ht.Request&&ht.fetch,Ne=ht.navigator&&ht.navigator.sendBeacon,Ge=ht.Element&&ht.Element.prototype,Qn=ht.Symbol&&Symbol.toStringTag;Qn&&(Blob.prototype[Qn]||(Blob.prototype[Qn]="Blob"),"File"in ht&&!File.prototype[Qn]&&(File.prototype[Qn]="File"));try{new File([],"")}catch{ht.File=function(Dt,zt,ye){return Dt=new Blob(Dt,ye||{}),Object.defineProperties(Dt,{name:{value:zt},lastModified:{value:+(ye&&ye.lastModified!==void 0?new Date(ye.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Qn&&Object.defineProperty(Dt,Qn,{value:"File"}),Dt}}var Er=function(St){return St.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},jn=function(St){this.i=[];var Dt=this;St&&nt(St.elements,function(zt){if(zt.name&&!zt.disabled&&zt.type!=="submit"&&zt.type!=="button"&&!zt.matches("form fieldset[disabled] *"))if(zt.type==="file"){var ye=zt.files&&zt.files.length?zt.files:[new File([],"",{type:"application/octet-stream"})];nt(ye,function(an){Dt.append(zt.name,an)})}else zt.type==="select-multiple"||zt.type==="select-one"?nt(zt.options,function(an){!an.disabled&&an.selected&&Dt.append(zt.name,an.value)}):zt.type==="checkbox"||zt.type==="radio"?zt.checked&&Dt.append(zt.name,zt.value):(ye=zt.type==="textarea"?dt(zt.value):zt.value,Dt.append(zt.name,ye))})};if((s=jn.prototype).append=function(St,Dt,zt){at(arguments,2),this.i.push(it(St,Dt,zt))},s.delete=function(St){at(arguments,1);var Dt=[];St=String(St),nt(this.i,function(zt){zt[0]!==St&&Dt.push(zt)}),this.i=Dt},s.entries=function St(){var Dt,zt=this;return z(St,function(ye){if(ye.h==1&&(Dt=0),ye.h!=3)return Dt<zt.i.length?ye=b(ye,zt.i[Dt]):(ye.h=0,ye=void 0),ye;Dt++,ye.h=2})},s.forEach=function(St,Dt){at(arguments,1);for(var zt=_(this),ye=zt.next();!ye.done;ye=zt.next()){var an=_(ye.value);ye=an.next().value,an=an.next().value,St.call(Dt,an,ye,this)}},s.get=function(St){at(arguments,1);var Dt=this.i;St=String(St);for(var zt=0;zt<Dt.length;zt++)if(Dt[zt][0]===St)return Dt[zt][1];return null},s.getAll=function(St){at(arguments,1);var Dt=[];return St=String(St),nt(this.i,function(zt){zt[0]===St&&Dt.push(zt[1])}),Dt},s.has=function(St){at(arguments,1),St=String(St);for(var Dt=0;Dt<this.i.length;Dt++)if(this.i[Dt][0]===St)return!0;return!1},s.keys=function St(){var Dt,zt,ye,an,xt=this;return z(St,function(P){if(P.h==1&&(Dt=_(xt),zt=Dt.next()),P.h!=3)return zt.done?void(P.h=0):(ye=zt.value,an=_(ye),b(P,an.next().value));zt=Dt.next(),P.h=2})},s.set=function(St,Dt,zt){at(arguments,2),St=String(St);var ye=[],an=it(St,Dt,zt),xt=!0;nt(this.i,function(P){P[0]===St?xt&&(xt=!ye.push(an)):ye.push(P)}),xt&&ye.push(an),this.i=ye},s.values=function St(){var Dt,zt,ye,an,xt=this;return z(St,function(P){if(P.h==1&&(Dt=_(xt),zt=Dt.next()),P.h!=3)return zt.done?void(P.h=0):(ye=zt.value,(an=_(ye)).next(),b(P,an.next().value));zt=Dt.next(),P.h=2})},jn.prototype._asNative=function(){for(var St=new pt,Dt=_(this),zt=Dt.next();!zt.done;zt=Dt.next()){var ye=_(zt.value);zt=ye.next().value,ye=ye.next().value,St.append(zt,ye)}return St},jn.prototype._blob=function(){var St="----formdata-polyfill-"+Math.random(),Dt=[],zt="--"+St+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(ye,an){return typeof ye=="string"?Dt.push(zt+Er(dt(an))+`"\r
\r
`+dt(ye)+`\r
`):Dt.push(zt+Er(dt(an))+'"; filename="'+Er(ye.name)+`"\r
Content-Type: `+(ye.type||"application/octet-stream")+`\r
\r
`,ye,`\r
`)}),Dt.push("--"+St+"--"),new Blob(Dt,{type:"multipart/form-data; boundary="+St})},jn.prototype[Symbol.iterator]=function(){return this.entries()},jn.prototype.toString=function(){return"[object FormData]"},Ge&&!Ge.matches&&(Ge.matches=Ge.matchesSelector||Ge.mozMatchesSelector||Ge.msMatchesSelector||Ge.oMatchesSelector||Ge.webkitMatchesSelector||function(St){for(var Dt=(St=(this.document||this.ownerDocument).querySelectorAll(St)).length;0<=--Dt&&St.item(Dt)!==this;);return-1<Dt}),Qn&&(jn.prototype[Qn]="FormData"),bt){var Xo=ht.XMLHttpRequest.prototype.setRequestHeader;ht.XMLHttpRequest.prototype.setRequestHeader=function(St,Dt){Xo.call(this,St,Dt),St.toLowerCase()==="content-type"&&(this.B=!0)},ht.XMLHttpRequest.prototype.send=function(St){St instanceof jn?(St=St._blob(),this.B||this.setRequestHeader("Content-Type",St.type),bt.call(this,St)):bt.call(this,St)}}kt&&(ht.fetch=function(St,Dt){return Dt&&Dt.body&&Dt.body instanceof jn&&(Dt.body=Dt.body._blob()),kt.call(this,St,Dt)}),Ne&&(ht.navigator.sendBeacon=function(St,Dt){return Dt instanceof jn&&(Dt=Dt._asNative()),Ne.call(this,St,Dt)}),ht.FormData=jn}})();const gR=()=>{const s=Q("AREAS");return s.length===0&&s.push(tn.GLOBAL),Lu(s).call(s,(e,i,o)=>{const c=Cn(i);return c?o===0?c:"".concat(e,",").concat(c):e},"")},Cn=s=>s===tn.OVERSEA?"".concat(Ur.ASIA,",").concat(Ur.EUROPE,",").concat(Ur.AFRICA,",").concat(Ur.NORTH_AMERICA,",").concat(Ur.SOUTH_AMERICA,",").concat(Ur.OCEANIA):Ur[s],TR=s=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return s.map(i=>{const o=dR[i],c=Object.keys(o);c&&c.map(u=>{u!=="CODE"&&(e[u]=e[u].concat(o[u]))})}),e},Sf={GLOBAL:{ASIA:[tn.CHINA,tn.JAPAN,tn.INDIA,tn.KOREA,tn.HKMC],EUROPE:[],NORTH_AMERICA:[tn.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Rf=Object.keys(Sf[tn.GLOBAL]),Ke=[tn.CHINA,tn.NORTH_AMERICA,tn.EUROPE,tn.ASIA,tn.JAPAN,tn.INDIA,tn.OCEANIA,tn.SOUTH_AMERICA,tn.AFRICA,tn.KOREA,tn.HKMC,tn.US],rs=function(s,e){let i=[];if(Jt(s).call(s,tn.GLOBAL)){const u=[tn.GLOBAL,tn.OVERSEA],h=Object.keys(dR);if(e===tn.GLOBAL)throw new st(j.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===tn.CHINA)i=[tn.OVERSEA];else if(c=e,Jt(Rf).call(Rf,c)){const _=(o=e,Sf[tn.GLOBAL][o]||[]),m=[...u,e,..._];i=h.filter(g=>!Jt(m).call(m,g))}else if(function(_){let m=!1;return Rf.forEach(g=>{var S;Jt(S=Sf[tn.GLOBAL][g]).call(S,_)&&(m=!0)}),m}(e)){const _=function(g){let S;return Rf.forEach(C=>{var I;Jt(I=Sf[tn.GLOBAL][C]).call(I,g)&&(S=C)}),S}(e),m=[...u,_,e];i=h.filter(g=>!Jt(m).call(m,g))}else i=s;i=function(_){const m=[];return Ke.forEach(g=>{Jt(_).call(_,g)&&m.push(g)}),m.concat(_.filter(g=>!Jt(Ke).call(Ke,g)))}(i)}else i=s;var o,c;return i};function fo(s){var e,i;if(!s&&Jt(e=Q("AREAS")).call(e,tn.EXTENSIONS))return O.debug("update area from ap : reset"),void yl(lj,!0);if(!Jt(i=Q("AREAS")).call(i,tn.GLOBAL)||!s)return;let o=dR.EXTENSIONS;o&&(o={CODE:Cn(tn.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(s,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(s,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(s,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(s,".agora.io"),"cds-ap-web-2-".concat(s,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(s,".agora.io"),"sua-ap-web-2-".concat(s,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(s,".agora.io"),"uap-ap-web-2-".concat(s,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(s,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(s,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(s,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(s,".agora.io")]},O.debug("update area from ap success: ".concat(s,",config is "),o),Mn("AREAS",[tn.EXTENSIONS],!0),Object.keys(o).map(c=>{c==="LOG_UPLOAD_SERVER"||c==="EVENT_REPORT_DOMAIN"||c==="EVENT_REPORT_BACKUP_DOMAIN"||c==="PROXY_SERVER_TYPE3"?Mn(c,o[c][0]):Mn(c,o[c])}))}function yl(s){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=ne.reportApiInvoke(null,{name:tr.SET_AREA,options:s,tag:gi.TRACER});try{let o=[];if(typeof s=="string"&&(o=[s]),Array.isArray(s)&&(s.forEach(u=>{if(!Jt(pf).call(pf,u))throw new st(j.INVALID_PARAMS,"invalid area code")}),o=s),Object.prototype.toString.call(s)==="[object Object]"){const{areaCode:u,excludedArea:h}=s;if(!u)throw new st(j.INVALID_PARAMS,"area code is needed");let _=u;typeof u=="string"&&(_=[u]),o=h?rs(_,h):_}if(!e){if(Tl.AREAS){const u=new st(j.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(u),void O.warning("setArea is prohibited because of config-distribute")}if(Jt(o).call(o,tn.GLOBAL)&&Q("AREAS")===tn.EXTENSIONS){const u=new st(j.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(u),void O.warning("setArea is prohibited because of ap extensions")}}Mn("AREAS",o,e);const c=TR(o);Object.keys(c).map(u=>{u==="LOG_UPLOAD_SERVER"||u==="EVENT_REPORT_DOMAIN"||u==="EVENT_REPORT_BACKUP_DOMAIN"||u==="PROXY_SERVER_TYPE3"?Mn(u,c[u][0]):Mn(u,c[u])}),O.debug("set area success:",o.join(","))}catch(o){throw i.onError(o),o}i.onSuccess()}function Kr(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function On(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Kr(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Kr(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}let Vo=1;function Cf(s,e,i,o,c){Vo+=1;const u={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:Vo,requestId:Vo,version:Ga,cname:i.cname},h={service_name:e,json_body:JSON.stringify(u)};let _,m,g=s[0];return ed(async()=>{_=Date.now();const S=await Jd(g,{data:h,cancelToken:o,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(m=Date.now()-_,S.code!==0){const b=new st(j.UNEXPECTED_RESPONSE,"live streaming ap error, code"+S.code,{retry:!0,responseTime:m});throw O.error(b.toString()),b}const C=JSON.parse(S.json_body);if(C.code!==200){const b=new st(j.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(C.code,", reason: ").concat(C.reason),{code:C.code,responseTime:m});throw O.error(b.toString()),b}if(!C.servers||C.servers.length===0){const b=new st(j.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:C.code,responseTime:m});throw O.error(b.toString()),b}const I=function(b,x){return{addressList:b.servers.map(D=>"wss://".concat(D.address.replace(/\./g,"-"),".").concat(Q("WORKER_DOMAIN"),":").concat(D.wss,"?serviceName=").concat(encodeURIComponent(x))),workerToken:b.workerToken,vid:b.vid}}(C,e);return Q("LIVE_STREAMING_ADDRESS")&&(I.addressList=Q("LIVE_STREAMING_ADDRESS")instanceof Array?Q("LIVE_STREAMING_ADDRESS"):[Q("LIVE_STREAMING_ADDRESS")]),On(On({},I),{},{responseTime:m})},(S,C)=>(ne.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(S.addressList),firstSuccess:C===0,responseTime:m,serverIp:s[C%s.length]}),!1),(S,C)=>(ne.apworkerEvent(i.sid,{success:!1,sc:S.data&&S.data.code||200,serviceName:e,responseTime:m,serverIp:s[C%s.length]}),!!(S.code!==j.OPERATION_ABORTED&&S.code!==j.UNEXPECTED_RESPONSE||S.data&&S.data.retry)&&(g=s[(C+1)%s.length],!0)),c)}let Ui=1;function vf(s,e,i,o){let{url:c,areaCode:u}=s;const h=Date.now();let _;const[m,g]=Eb(e,u,[hi.CHOOSE_SERVER]);let S=er.networkState;return ed(async()=>{S&&er.networkState===Ds.OFFLINE&&er.onlineWaiter&&await ut.race([er.onlineWaiter,Mr(o&&o.maxRetryTimeout||nr.maxRetryTimeout)]),S=er.networkState;const{data:C,headers:I}=await Jd(c,{data:m,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);_=I.http3==="1"?1:-1,ne.reportResourceTiming(c,e.sid),If(C,c,e,h,[hi.CHOOSE_SERVER],_);const b=yn(C,hi.CHOOSE_SERVER);return xi(b),H(b,c)},C=>(C&&ne.joinChooseServer(e.sid,{lts:h,succ:!0,csAddr:c,opid:g,serverList:C.gatewayAddrs.map(I=>I.address),ec:null,cid:C.cid.toString(),uid:C.uid.toString(),csIp:C.csIp,unilbsServerIds:[hi.CHOOSE_SERVER].toString(),isHttp3:_}),!1),C=>C.code!==j.OPERATION_ABORTED&&(C.code===j.CAN_NOT_GET_GATEWAY_SERVER?C.data.retry:(ne.joinChooseServer(e.sid,{lts:h,succ:!1,csAddr:c,serverList:null,opid:g,ec:C.code,csIp:C.data&&C.data.csIp,unilbsServerIds:[hi.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:S}),isHttp3:_}),O.warning("[".concat(e.clientId,"] Choose server network error, retry"),C),!0)),o)}function dp(s,e,i,o){let c,{url:u,areaCode:h,serviceIds:_}=s;const m=Date.now(),[g,S]=Eb(e,h,_);let C;return ed(async()=>{C&&er.networkState===Ds.OFFLINE&&er.onlineWaiter&&await ut.race([er.onlineWaiter,Mr(o&&o.maxRetryTimeout||nr.maxRetryTimeout)]),C=er.networkState;const{data:I,headers:b}=await Jd(u,{data:g,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=b.http3==="1"?1:-1,ne.reportResourceTiming(u,e.sid),If(I,u,e,m,_,c);const x=yn(I,hi.CHOOSE_SERVER),D=yn(I,e.cloudProxyServer==="proxy5"?hi.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?hi.CLOUD_PROXY:hi.CLOUD_PROXY_FALLBACK);return xi(x),{gatewayInfo:H(x,u),proxyInfo:D,url:u}},I=>(I.gatewayInfo&&ne.joinChooseServer(e.sid,{lts:m,succ:!0,csAddr:u,serverList:I.gatewayInfo.gatewayAddrs.map(b=>b.address),ec:null,opid:S,cid:I.gatewayInfo.cid.toString(),uid:I.gatewayInfo.uid.toString(),csIp:I.gatewayInfo.csIp,unilbsServerIds:_.toString(),isHttp3:c}),I.proxyInfo&&ne.joinWebProxyAP(e.sid,{lts:m,sucess:1,apServerAddr:u,turnServerAddrList:I.proxyInfo.addresses.map(b=>b.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:_.toString()}),!1),I=>I.code!==j.OPERATION_ABORTED&&(I.code===j.CAN_NOT_GET_GATEWAY_SERVER?I.data.retry:(ne.joinWebProxyAP(e.sid,{lts:m,sucess:0,apServerAddr:u,turnServerAddrList:null,errorCode:I.code,eventType:e.cloudProxyServer,unilbsServerIds:_.toString(),extend:JSON.stringify({networkState:C})}),O.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),I),!0)),o)}const If=(s,e,i,o,c,u)=>{const h=[],_=m=>{m.flag===4096?ne.joinChooseServer(i.sid,{lts:o,succ:!1,csAddr:e,opid:s.opid,serverList:null,ec:m.error.message,csIp:m.error.data&&m.error.data.csIp,unilbsServerIds:c.toString(),isHttp3:u}):m.flag!==1048576&&m.flag!==4194304&&m.flag!==4194310||ne.joinWebProxyAP(i.sid,{lts:o,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:m.error.code,eventType:i.cloudProxyServer,unilbsServerIds:c.toString()})};if(s.response_body.forEach(m=>{const g=m.buffer.code;if(m.uri===23&&g===0&&!m.buffer.edges_services)if(m.buffer.flag===4194310)O.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),m.buffer.edges_services=[];else{const S={error:new st(j.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:s.detail[502]}),flag:m.buffer.flag};h.push(S),_(S)}if(g!==0){const S=hR(g),C={error:new st(j.CAN_NOT_GET_GATEWAY_SERVER,S.desc,{desc:S.desc,retry:S.retry,csIp:s.detail[502]}),flag:m.buffer.flag};m.buffer.flag===4194310?O.warning(C.error.toString()):h.push(C),_(C)}}),h.length)throw O.warning("[".concat(i.clientId,"] multi unilbs ").concat(e," failed, ").concat(h.map(m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message,", retry: ").concat(m.error.data.retry)).join(" | "))),new st(j.CAN_NOT_GET_GATEWAY_SERVER,h.map(m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message)).join(" | "),{retry:!!h.find(m=>m.error.data.retry),csIp:s.detail[502],desc:[...new Set(h.map(m=>{var g;return m==null||(g=m.error)===null||g===void 0||(g=g.data)===null||g===void 0?void 0:g.desc}).filter(m=>!!m))]})},xi=s=>{var e,i,o,c;if(s.addresses&&s.addresses.length===0&&s.code===0)throw new st(j.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:s.detail&&s.detail[502]});if(Q("AP_AREA")&&((o=s.detail)!==null&&o!==void 0&&o[23]&&typeof((c=s.detail)===null||c===void 0?void 0:c[23])=="string"?fo(s.detail[23].toLowerCase()):fo()),(e=s.detail)!==null&&e!==void 0&&e[19]&&typeof((i=s.detail)===null||i===void 0?void 0:i[19])=="string"){const h=s.detail[19],_=h==null?void 0:h.split(";");for(let m=0;m<_.length;m++){var u;const g=ap(u=_[m]).call(u);s.addresses[m]&&_&&(s.addresses[m].fingerprint=g)}}if(Q("GATEWAY_ADDRESS")&&Q("GATEWAY_ADDRESS").length>0){O.debug("assign gateway address to",Q("GATEWAY_ADDRESS"));const h=Q("GATEWAY_ADDRESS").map(_=>{var m,g;const S=(m=(g=s.addresses.find(C=>C.ip===_.ip&&C.port===_.port))===null||g===void 0?void 0:g.fingerprint)!==null&&m!==void 0?m:"";return{ip:_.ip,port:_.port,ticket:s.addresses[0]&&s.addresses[0].ticket,fingerprint:S}});s.addresses=h}},up=(s,e)=>{if(s.response_body&&s.response_body.length){const i=s.response_body[0];if(i.buffer.code!==0){const o=hR(i.buffer.code);throw new st(j.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(o.desc),{retry:o.retry})}return i.buffer.ticket}throw O.debug("update ticket request received ap response without response body:",e),new st(j.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Eb=(s,e,i)=>{const o=Math.floor(Math.random()*1e12),c={appid:s.appId,client_ts:Date.now(),opid:o,sid:s.sid,request_bodies:[{uri:22,buffer:{cname:s.cname,detail:On({6:s.stringUid,11:e,12:Q("USE_NEW_TOKEN")?"1":void 0,22:e},s.apRTM?{26:"RTM2"}:{}),key:s.token,service_ids:i,uid:s.uid||0}}]};c.request_bodies.forEach(h=>{s.multiIP&&s.multiIP.gateway_ip&&(h.buffer.detail[5]=JSON.stringify({vocs_ip:[s.multiIP.uni_lbs_ip],vos_ip:[s.multiIP.gateway_ip]}))});const u=new FormData;return u.append("request",JSON.stringify(c)),[u,o]},Al=(s,e)=>{const i=Math.floor(Math.random()*1e12),o={appid:s.appId,client_ts:Date.now(),opid:i,sid:s.sid,request_bodies:[{uri:28,buffer:{cname:s.cname,detail:{1:"",6:s.stringUid,12:"1"},token:s.token,service_ids:e,uid:s.uid||0,edges_services:s.apResponse.addresses.map(u=>({ip:u.ip,port:u.port}))}}]},c=new FormData;return c.append("request",JSON.stringify(o)),[c,i]};let bc=0;function Ka(s){return ut.all(s.map(e=>e.then(i=>{throw i},i=>i))).then(e=>{throw e},e=>e)}const H_=async s=>{let{fragementLength:e,referenceList:i,asyncMapHandler:o,allFailedhandler:c,promisesCollector:u}=s,h=0;const _=e;let m,g=0;const S=async()=>{const C=(()=>{const I=h*_,b=I+_;return i.slice(I,b).map(o)})();u&&u.push(...C);try{m=await Ka(C)}catch(I){if(g+=_,h++,!(g>=i.length))return void await S();c(I)}C.forEach(I=>I.cancel())};return await S(),m};async function SR(s,e,i,o){return{gatewayInfo:await async function(u,h,_,m){let g=null;const S=[],C=async()=>{const b=Q("WEBCS_DOMAIN").slice(0,Q("AJAX_REQUEST_CONCURRENT")).map(M=>({url:u.proxyServer?"https://".concat(u.proxyServer,"/ap/?url=").concat(M+"/api/v2/transpond/webrtc?v=2"):"https://".concat(M,"/api/v2/transpond/webrtc?v=2"),areaCode:gR()})),x=m.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:b.map(M=>M.url)}),D=await H_({fragementLength:Q("FRAGEMENT_LENGTH"),referenceList:b,asyncMapHandler:M=>(O.debug("[".concat(u.clientId,"] Connect to choose_server:"),M.url),vf(M,u,h,_)),allFailedhandler:M=>{throw m.recordJoinChannelService({endTs:Date.now(),status:"error",errors:M},x),M[0]},promisesCollector:S});return m.recordJoinChannelService({endTs:Date.now(),status:"success"},x),D},I=async()=>{if(await Mr(1e3),g!==null)return g;const b=Q("WEBCS_DOMAIN_BACKUP_LIST").map(M=>({url:u.proxyServer?"https://".concat(u.proxyServer,"/ap/?url=").concat(M+"/api/v2/transpond/webrtc?v=2"):"https://".concat(M,"/api/v2/transpond/webrtc?v=2"),areaCode:gR()})),x=m.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:b.map(M=>M.url)}),D=await H_({fragementLength:Q("FRAGEMENT_LENGTH"),referenceList:b,asyncMapHandler:M=>(O.debug("[".concat(u.clientId,"] Connect to backup choose_server:"),M.url),vf(M,u,h,_)),allFailedhandler:M=>{throw m.recordJoinChannelService({endTs:Date.now(),status:"error",errors:M},x),M[0]},promisesCollector:S});return m.recordJoinChannelService({endTs:Date.now(),status:"success"},x),D};try{return g=await Ka([C(),I()]),S.length&&S.forEach(b=>b.cancel&&typeof b.cancel=="function"&&b.cancel()),g}catch(b){throw b[0]}}(s,e,i,o)}}async function ad(s,e,i,o,c){const u=s.cloudProxyServer;if(u==="disabled"){if(s.useLocalAccessPoint)return await SR(s,e,i,c);if(Q("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:I,proxyInfo:b}=await xr(s,e,i,c);if(s.turnServer&&s.turnServer.mode!=="auto")return{gatewayInfo:I};const x=b.map(D=>({turnServerURL:D.address,tcpport:D.tcpport||Ps.tcpport,udpport:D.udpport||Ps.udpport,username:D.username||Ps.username,password:D.password||Ps.password,forceturn:!1,security:!0}));if(c.useP2P){var h;const D=(h=s.uid)!==null&&h!==void 0?h:I.uid,M="glb:".concat(D.toString()),K=await kS(M),z=b.map(nt=>({turnServerURL:nt.address,tcpport:nt.tcpport||Ps.tcpport,udpport:nt.udpport||Ps.udpport,username:M,password:K,forceturn:!1,security:!0}));x.push(...z)}return s.turnServer={mode:"manual",servers:x},{gatewayInfo:I}}return await SR(s,e,i,c)}const{proxyInfo:_,gatewayInfo:m}=await xr(s,e,i,c),g={gatewayInfo:m},S=_.map(I=>({turnServerURL:I.address,tcpport:u==="proxy3"?void 0:I.tcpport?I.tcpport:Ps.tcpport,udpport:u==="proxy4"?void 0:I.udpport?I.udpport:Ps.udpport,username:I.username||Ps.username,password:I.password||Ps.password,forceturn:u!=="proxy4",security:u==="proxy5"}));if(c.useP2P){var C;const I=(C=s.uid)!==null&&C!==void 0?C:m.uid,b="glb:".concat(I.toString()),x=await kS(b),D=_.map(M=>({turnServerURL:M.address,tcpport:u==="proxy3"?void 0:M.tcpport||Ps.tcpport,udpport:u==="proxy4"?void 0:M.udpport||Ps.udpport,username:b,password:x,forceturn:u!=="proxy4",security:u==="proxy5"}));S.push(...D)}return s.turnServer={mode:"manual",servers:S},O.debug("[".concat(s.clientId,"] set proxy server: ").concat(s.proxyServer,", mode: ").concat(u)),g}async function mb(s,e,i,o,c){const u=Q("ACCOUNT_REGISTER").slice(0,Q("AJAX_REQUEST_CONCURRENT"));let h=[];h=e.proxyServer?u.map(m=>"https://".concat(e.proxyServer,"/ap/?url=").concat(m+"/api/v1")):u.map(m=>"https://".concat(m,"/api/v1"));const _=c==null?void 0:c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:h});try{const m=await async function(g,S,C,I,b){const x=Date.now(),D={sid:C.sid,opid:10,appid:C.appId,string_uid:S};let M=g[0];const K=await ed(()=>Jd(M+"".concat(M.indexOf("?")===-1?"?":"&","action=stringuid"),{data:D,cancelToken:I,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(z,nt)=>{if(z.code===0){if(z.uid<=0||z.uid>=Math.pow(2,32))throw O.error("Invalid Uint Uid ".concat(S," => ").concat(z.uid),z),ne.reqUserAccount(D.sid,{lts:x,success:!1,serverAddr:M,stringUid:D.string_uid,uid:z.uid,errorCode:j.INVALID_UINT_UID_FROM_STRING_UID,extend:D}),new st(j.INVALID_UINT_UID_FROM_STRING_UID);return ne.reqUserAccount(D.sid,{lts:x,success:!0,serverAddr:M,stringUid:D.string_uid,uid:z.uid,errorCode:null,extend:D}),!1}const dt=hR(z.code);return dt.retry&&(M=g[(nt+1)%g.length]),ne.reqUserAccount(D.sid,{lts:x,success:!1,serverAddr:M,stringUid:D.string_uid,uid:z.uid,errorCode:dt.desc,extend:D}),dt.retry},(z,nt)=>z.code!==j.OPERATION_ABORTED&&(ne.reqUserAccount(D.sid,{lts:x,success:!1,serverAddr:M,stringUid:D.string_uid,uid:null,errorCode:z.code,extend:D}),M=g[(nt+1)%g.length],!0),b);if(K.code!==0){const z=hR(K.code);throw new st(j.UNEXPECTED_RESPONSE,z.desc)}return K}(h,s,e,i,o);return c==null||c.recordJoinChannelService({status:"success",endTs:Date.now()},_),m.uid}catch(m){throw c==null||c.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[m]},_),m}}async function Ej(s,e,i){const o=Q("CDS_AP").slice(0,Q("AJAX_REQUEST_CONCURRENT")).map(m=>s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(m+"/api/v1"):"https://".concat(m,"/api/v1?action=config")),c=o.map(m=>function(g,S,C,I){const b=ln(),x={flag:64,cipher_method:0,features:{device:b.name,system:b.os,system_general:navigator.userAgent,vendor:S.appId,version:Ga,cname:S.cname,sid:S.sid,session_id:S.sid,detail:"",proxyServer:S.proxyServer}};return ed(()=>Jd(g,{data:x,timeout:1e3,cancelToken:C,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,D=>D.code!==j.OPERATION_ABORTED,I)}(m,s,e,i));let u=null,h=null,_={};try{u=await Ka(c)}catch(m){if(m.code===j.OPERATION_ABORTED)throw m;h=m}if(c.forEach(m=>m.cancel()),ne.reportApiInvoke(s.sid,{name:tr.REQUEST_CONFIG_DISTRIBUTE,options:{error:h,res:u}}).onSuccess(),u&&u.test_tags)try{_=function(m){if(!m.test_tags)return{};const g=m.test_tags,S=Object.keys(g),C={};return S.forEach(I=>{var b;const x=ap(b=I.slice(4)).call(b),D=JSON.parse(g[I])[1];C[x]=D}),C}(u)}catch{}return _}async function xr(s,e,i,o){const c=Q("PROXY_SERVER_TYPE3"),u=(b,x,D)=>{let M=D||c;return Array.isArray(M)&&(M=x%2==0?c[1]:c[0]),"https://".concat(M,"/ap/?url=").concat(b)};let h=null;const _=[],m=async()=>{const b=Q("WEBCS_DOMAIN").slice(0,Q("AJAX_REQUEST_CONCURRENT")).map((M,K)=>{let z;return z=s.cloudProxyServer==="disabled"&&s.proxyServer?u("".concat(M,"/api/v2/transpond/webrtc?v=2"),K,s.proxyServer):s.cloudProxyServer==="disabled"||s.cloudProxyServer==="fallback"?"https://".concat(M,"/api/v2/transpond/webrtc?v=2"):u("".concat(M,"/api/v2/transpond/webrtc?v=2"),K),{url:z,areaCode:gR(),serviceIds:[hi.CHOOSE_SERVER,s.cloudProxyServer==="proxy5"?hi.CLOUD_PROXY_5:s.cloudProxyServer==="proxy3"||s.cloudProxyServer==="proxy4"?hi.CLOUD_PROXY:hi.CLOUD_PROXY_FALLBACK]}}),x=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:b.map(M=>M.url)}),D=await H_({fragementLength:Q("FRAGEMENT_LENGTH"),referenceList:b,asyncMapHandler:M=>(O.debug("[".concat(s.clientId,"] Connect to choose_server:"),M.url),dp(M,s,e,i)),allFailedhandler:M=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:M},x),M[0]},promisesCollector:_});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},x),D},g=async()=>{if(await Mr(1e3),h!==null)return h;const b=Q("WEBCS_DOMAIN_BACKUP_LIST").map((M,K)=>{let z;return z=s.cloudProxyServer==="disabled"&&s.proxyServer?u("".concat(M,"/api/v2/transpond/webrtc?v=2"),K,s.proxyServer):s.cloudProxyServer==="disabled"||s.cloudProxyServer==="fallback"?"https://".concat(M,"/api/v2/transpond/webrtc?v=2"):u("".concat(M,"/api/v2/transpond/webrtc?v=2"),K),{url:z,areaCode:gR(),serviceIds:[hi.CHOOSE_SERVER,s.cloudProxyServer==="proxy5"?hi.CLOUD_PROXY_5:s.cloudProxyServer==="proxy3"||s.cloudProxyServer==="proxy4"?hi.CLOUD_PROXY:hi.CLOUD_PROXY_FALLBACK]}}),x=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:b.map(M=>M.url)}),D=await H_({fragementLength:Q("FRAGEMENT_LENGTH"),referenceList:b,asyncMapHandler:M=>(O.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),M.url),dp(M,s,e,i)),allFailedhandler:M=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:M},x),M[0]},promisesCollector:_});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},x),D};let S,C,I;try{({gatewayInfo:S,proxyInfo:C,url:I}=await Ka([m(),g()]))}catch(b){throw b[0]}if(_.length&&_.forEach(b=>b.cancel&&typeof b.cancel=="function"&&b.cancel()),!S||!C)throw new st(j.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(s.apUrl=I,s.cloudProxyServer!=="disabled"&&Array.isArray(c)&&I){const b=/^https?:\/\/(.+?)(\/.*)?$/.exec(I)[1];Jt(c).call(c,b)&&(s.proxyServer=b,O.setProxyServer(b),ne.setProxyServer(b))}return h={gatewayInfo:S,proxyInfo:await pb(C,S.uid)},h}async function Vn(s,e,i,o){const c=Q("UAP_AP").slice(0,Q("AJAX_REQUEST_CONCURRENT")).map(u=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(u+"/api/v1?action=uap"):"https://".concat(u,"/api/v1?action=uap"));return await Cf(c,s,e,i,o)}async function K_(s,e,i){const o=Q("UAP_AP").slice(0,Q("AJAX_REQUEST_CONCURRENT")).map(u=>s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(u+"/api/v1?action=uap"):"https://".concat(u,"/api/v1?action=uap")),c=o.map(u=>function(h,_,m,g){const S={command:"convergeAllocateEdge",sid:_.sid,appId:_.appId,token:_.token,ts:Date.now(),version:Ga,cname:_.cname,uid:_.uid.toString(),requestId:Ui,seq:Ui};Ui+=1;const C={service_name:"tele_channel",json_body:JSON.stringify(S)};return ed(async()=>{const I=await Jd(h,{data:C,cancelToken:m,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(I.code!==0){const x=new st(j.UNEXPECTED_RESPONSE,"cross channel ap error, code"+I.code,{retry:!0});throw O.error(x.toString()),x}const b=JSON.parse(I.json_body);if(b.code!==200){const x=new st(j.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(b.code,", reason: ").concat(b.reason));throw O.error(x.toString()),x}if(!b.servers||b.servers.length===0){const x=new st(j.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw O.error(x.toString()),x}return{vid:b.vid,workerToken:b.workerToken,addressList:(Q("CHANNEL_MEDIA_RELAY_SERVERS")||b.servers).map(x=>"wss://".concat(x.address.replace(/\./g,"-"),".").concat(Q("WORKER_DOMAIN"),":").concat(x.wss))}},void 0,I=>!!(I.code!==j.OPERATION_ABORTED&&I.code!==j.UNEXPECTED_RESPONSE||I.data&&I.data.retry),g)}(u,s,e,i));try{const u=await Ka(c);return c.forEach(h=>h.cancel()),u}catch(u){throw u[0]}}async function RR(s,e,i){let o=null;const c=[],u=async h=>{const _=Q(h?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(m=>s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(m+"/api/v2/transpond/webrtc?v=2"):"https://".concat(m,"/api/v2/transpond/webrtc?v=2"));return h&&(await Mr(1e3),o!==null)?o:await H_({fragementLength:Q("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:m=>(O.debug("[".concat(s.clientId,"] update ticket, Connect to ").concat(h?"backup":""," choose_server:"),m),function(g,S,C,I){const[b]=Al(S,[hi.CHOOSE_SERVER]);let x=er.networkState;return ed(async()=>{x&&er.networkState===Ds.OFFLINE&&er.onlineWaiter&&await ut.race([er.onlineWaiter,Mr(I&&I.maxRetryTimeout||nr.maxRetryTimeout)]),x=er.networkState;const D=await Jd(g,{data:b,cancelToken:C,headers:{"Content-Type":"multipart/form-data;"}},!0);return up(D,g)},()=>!1,D=>D.code!==j.OPERATION_ABORTED&&(D.code===j.UPDATE_TICKET_FAILED?D.data.retry:(O.warning("[".concat(S.clientId,"] update ticket network error, retry"),D),!0)),I)}(m,s,e,i)),allFailedhandler:m=>{throw m[0]},promisesCollector:c})};try{return o=await Ka([u(!1),u(!0)]),c.length&&c.forEach(h=>h.cancel&&typeof h.cancel=="function"&&h.cancel()),o}catch(h){throw h[0]}}function fb(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function gb(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?fb(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):fb(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class _k extends oi{get isSuccess(){return!!this.configs}constructor(){super(),A(this,"configs",void 0),A(this,"joinInfo",void 0),A(this,"cancelToken",void 0),A(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),A(this,"interval",void 0),A(this,"mutex",new Sr("config-distribute")),A(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,i){this.joinInfo=e,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),Q("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},Q("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,ne.reportApiInvoke(null,{options:void 0,name:tr.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:gi.TRACER}).onSuccess(JSON.stringify(Tl))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void O.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const i=await this.mutex.lock();try{e=await Ej(this.joinInfo,this.cancelToken,this.retryConfig),O.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(o){const c=new st(j.NETWORK_RESPONSE_ERROR,o);O.warning("[config-distribute] ".concat(c.toString()))}finally{i()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var i;(i=e)&&i.uplink&&i.id&&i.uplink.max_bitrate!==void 0&&i.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(j_.UPDATE_BITRATE_LIMIT,e):this.emit(j_.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&gb({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var i;const o=l_(i=Object.keys(e).filter(u=>/^webrtc_ng_global_parameter/.test(u))).call(i);for(let u=0;u<o.length;u++)for(let h=o.length-1;h>u;h--){const _=o[h];if(typeof e[_].__priority=="number"){const m=e[_].__priority,g=o[h-1];if(typeof e[g].__priority=="number"){if(!(m>e[g].__priority))continue;{const S=_;o[h]=o[h-1],o[h-1]=S}}else{const S=_;o[h]=o[h-1],o[h-1]=S}}}const c={};o.forEach(u=>{const h=e[u],_=h.__expires;Object.keys(h).forEach(m=>{m==="__priority"||m==="__expires"||Object.prototype.hasOwnProperty.call(c,m)||(c[m]=gb({value:h[m]},_&&{expires:_}))})});try{(function(_){try{const m=Date.now();Object.keys(_).forEach(g=>{switch(g){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(bs,g)){const{value:S,expires:C}=_[g];if(C&&C<=m)return;Tl[g]=S,bs[g]=S,O.debug("Update global parameters from config distribute",g,S)}}})}catch(m){O.error("Error update config immediately: ".concat(_),m.message)}})(c);const u=JSON.stringify(c),h=window.btoa(u);window.localStorage.setItem("websdk_ng_global_parameter",h),O.debug("Caching global parameters ".concat(u))}catch(u){O.error("Error caching global parameters:",u.message)}}}const ss={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function sn(){return ss}var hr;function lp(s,e,i){return{sampleRate:s,stereo:e,bitrate:i}}function Ze(s,e,i,o,c){return{width:s,height:e,frameRate:i,bitrateMin:o,bitrateMax:c}}function Ya(s,e,i,o,c){return{width:{max:s},height:{max:e},frameRate:i,bitrateMin:o,bitrateMax:c}}function Yr(s,e){return{numSpatialLayers:s,numTemporalLayers:e}}(function(s){s.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",s.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",s.IOS_INTERRUPTION_START="ios-interruption-start",s.IOS_INTERRUPTION_END="ios-interruption-end",s.STATE_CHANGE="state-change"})(hr||(hr={}));const Y_={"90p":Ze(160,90),"90p_1":Ze(160,90),"120p":Ze(160,120,15,30,65),"120p_1":Ze(160,120,15,30,65),"120p_3":Ze(120,120,15,30,50),"120p_4":Ze(212,120),"180p":Ze(320,180,15,30,140),"180p_1":Ze(320,180,15,30,140),"180p_3":Ze(180,180,15,30,100),"180p_4":Ze(240,180,15,30,120),"240p":Ze(320,240,15,40,200),"240p_1":Ze(320,240,15,40,200),"240p_3":Ze(240,240,15,40,140),"240p_4":Ze(424,240,15,40,220),"360p":Ze(640,360,15,80,400),"360p_1":Ze(640,360,15,80,400),"360p_3":Ze(360,360,15,80,260),"360p_4":Ze(640,360,30,80,600),"360p_6":Ze(360,360,30,80,400),"360p_7":Ze(480,360,15,80,320),"360p_8":Ze(480,360,30,80,490),"360p_9":Ze(640,360,15,80,800),"360p_10":Ze(640,360,24,80,800),"360p_11":Ze(640,360,24,80,1e3),"480p":Ze(640,480,15,100,500),"480p_1":Ze(640,480,15,100,500),"480p_2":Ze(640,480,30,100,1e3),"480p_3":Ze(480,480,15,100,400),"480p_4":Ze(640,480,30,100,750),"480p_6":Ze(480,480,30,100,600),"480p_8":Ze(848,480,15,100,610),"480p_9":Ze(848,480,30,100,930),"480p_10":Ze(640,480,10,100,400),"720p":Ze(1280,720,15,120,1130),"720p_auto":Ze(1280,720,30,900,3e3),"720p_1":Ze(1280,720,15,120,1130),"720p_2":Ze(1280,720,30,120,2e3),"720p_3":Ze(1280,720,30,120,1710),"720p_5":Ze(960,720,15,120,910),"720p_6":Ze(960,720,30,120,1380),"1080p":Ze(1920,1080,15,120,2080),"1080p_1":Ze(1920,1080,15,120,2080),"1080p_2":Ze(1920,1080,30,120,3e3),"1080p_3":Ze(1920,1080,30,120,3150),"1080p_5":Ze(1920,1080,60,120,4780),"1440p":Ze(2560,1440,30,120,4850),"1440p_1":Ze(2560,1440,30,120,4850),"1440p_2":Ze(2560,1440,60,120,7350),"4k":Ze(3840,2160,30,120,8910),"4k_1":Ze(3840,2160,30,120,8910),"4k_3":Ze(3840,2160,60,120,13500)},Vi=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],Tb={"480p":Ya(640,480,5),"480p_1":Ya(640,480,5),"480p_2":Ya(640,480,30),"480p_3":Ya(640,480,15),"720p":Ya(1280,720,5),"720p_auto":Ze(1280,720,30,900,3e3),"720p_1":Ya(1280,720,5),"720p_2":Ya(1280,720,30),"720p_3":Ya(1280,720,15),"1080p":Ya(1920,1080,5),"1080p_1":Ya(1920,1080,5),"1080p_2":Ya(1920,1080,30),"1080p_3":Ya(1920,1080,15)},cd={"1SL1TL":Yr(1,1),"3SL3TL":Yr(3,3),"2SL3TL":Yr(2,3)};function dd(s){return s||(s="480p_1"),typeof s=="string"?Object.assign({},Y_[s]):s}function q_(s){return typeof s=="string"?Object.assign({},Tb[s]):s}function hp(s){return typeof s=="string"?Object.assign({},cd[s]):s}const Sb={speech_low_quality:lp(16e3,!1),speech_standard:lp(32e3,!1,18),music_standard:lp(48e3,!1),standard_stereo:lp(48e3,!0,56),high_quality:lp(48e3,!1,128),high_quality_stereo:lp(48e3,!0,192)};function z_(s){return typeof s=="string"?Object.assign({},Sb[s]):s}const J_=[];function Rb(s){return cr(s,"mediaSource",["screen","window","application"]),!0}var Vt,Fn,la,Vr,yf,Xd,ni,on,J,Fu;(function(s){s.NEED_RENEGOTIATE="@need_renegotiate",s.NEED_REPLACE_TRACK="@need_replace_track",s.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",s.NEED_CLOSE="@need_close",s.NEED_ENABLE_TRACK="@need_enable_track",s.NEED_DISABLE_TRACK="@need_disable_track",s.NEED_SESSION_ID="@need_sid",s.SET_OPTIMIZATION_MODE="@set_optimization_mode",s.GET_STATS="@get_stats",s.GET_RTC_STATS="@get_rtc_stats",s.GET_LOW_VIDEO_TRACK="@get_low_video_track",s.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",s.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",s.NEED_MUTE_TRACK="@need_mute_track",s.NEED_UNMUTE_TRACK="@need_unmute_track"})(Vt||(Vt={})),function(s){s.SCREEN_TRACK="screen_track",s.CUSTOM_TRACK="custome_track",s.LOW_STREAM="low_stream"}(Fn||(Fn={})),function(s){s[s.HIGH_STREAM=0]="HIGH_STREAM",s[s.LOW_STREAM=1]="LOW_STREAM"}(la||(la={})),function(s){s[s.HIGH_STREAM=0]="HIGH_STREAM",s[s.LOW_STREAM=1]="LOW_STREAM"}(Vr||(Vr={})),function(s){s[s.DISABLE=0]="DISABLE",s[s.LOW_STREAM=1]="LOW_STREAM",s[s.AUDIO_ONLY=2]="AUDIO_ONLY"}(yf||(yf={})),function(s){s.TRANSCEIVER_UPDATED="transceiver-updated",s.SEI_TO_SEND="sei-to-send",s.SEI_RECEIVED="sei-received"}(Xd||(Xd={})),function(s){s.SOURCE_STATE_CHANGE="source-state-change",s.TRACK_ENDED="track-ended",s.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",s.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",s.CLOSED="closed"}(ni||(ni={})),function(s){s.FIRST_FRAME_DECODED="first-frame-decoded",s.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",s.VIDEO_STATE_CHANGED="video-state-changed"}(on||(on={})),function(s){s.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",s.RECEIVE_TRACK_BUFFER="receive_track_buffer",s.ON_AUDIO_BUFFER="on_audio_buffer",s.UPDATE_SOURCE="update_source"}(J||(J={})),function(s){s.UPDATE_TRACK_SOURCE="update-track-source"}(Fu||(Fu={}));const He={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Cb={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Af={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Ek={uplinkNetworkQuality:0,downlinkNetworkQuality:0},mk={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var gs,Ts,pp,Kn,Ss,Ie;(function(s){s.ON_TRACK="on_track",s.ON_NODE="on_node"})(gs||(gs={})),function(s){s.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",s.REQUEST_CONSTRAINTS="request_constraints"}(Ts||(Ts={})),function(s){s.IDLE="IDLE",s.INITING="INITING",s.INITEND="INITEND"}(pp||(pp={})),function(s){s.STATE_CHANGE="state_change",s.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",s.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",s.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(Kn||(Kn={})),function(s){s.NONE="none",s.INIT="init",s.CANPLAY="canplay",s.PLAYING="playing",s.PAUSED="paused",s.SUSPEND="suspend",s.STALLED="stalled",s.WAITING="waiting",s.ERROR="error",s.DESTROYED="destroyed",s.ABORT="abort",s.ENDED="ended",s.EMPTIED="emptied",s.LOADEDDATA="loadeddata"}(Ss||(Ss={})),function(s){s[s.VideoStateStopped=0]="VideoStateStopped",s[s.VideoStateStarting=1]="VideoStateStarting",s[s.VideoStateDecoding=2]="VideoStateDecoding",s[s.VideoStateFrozen=3]="VideoStateFrozen"}(Ie||(Ie={}));const CR={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var X_;(function(s){s.OPEN="open",s.MESSAGE="message",s.CLOSE="close",s.CLOSING="closing",s.ERROR="error"})(X_||(X_={}));class vR extends oi{constructor(e,i){super(),A(this,"_ID",void 0),A(this,"_rtpTransceiver",void 0),A(this,"_lowRtpTransceiver",void 0),A(this,"_hints",[]),A(this,"_isClosed",!1),A(this,"_originMediaStreamTrack",void 0),A(this,"_mediaStreamTrack",void 0),A(this,"_external",{}),this._ID=i||Hn(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(o){Jt(J_).call(J_,o)||J_.push(o)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){const i=ne.reportApiInvoke(null,{name:tr.GET_MEDIA_STREAM_TRACK,options:[],tag:gi.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?i.onSuccess(this._mediaStreamTrack.label):i.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===la.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const i=J_.indexOf(e);i!==-1&&J_.splice(i,1)}(this),this.emit(ni.CLOSED),this.removeAllListeners(Xd.SEI_RECEIVED)}_updateRtpTransceiver(e,i){if(i===la.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(Xd.TRANSCEIVER_UPDATED,e,i)}}class os extends vR{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,i){super(e,i),A(this,"_enabled",!0),A(this,"_muted",!1),A(this,"_isExternalTrack",!1),A(this,"_isClosed",!1),A(this,"_enabledMutex",void 0),A(this,"processor",void 0),A(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Sr("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,i;return(e=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,O.debug("[".concat(this.getTrackId(),"] close")),this.emit(Vt.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,i){let o=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=o,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await kn(this,Vt.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){O.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ni.TRACK_ENDED)}stateCheck(e,i){if(O.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(i,"]")),td(i,e),this._enabled&&this._muted&&e==="enabled"&&i===!1)throw new ft(j.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",O);if(!this._enabled&&!this._muted&&e==="muted"&&i===!0)throw new ft(j.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",O)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():ut.resolve([])}}function ha(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}const bf=window.AudioContext||window.webkitAudioContext;let qs=null;const N=new class extends oi{constructor(){super(...arguments),A(this,"prevState",void 0),A(this,"curState",void 0),A(this,"currentTime",void 0),A(this,"currentTimeStuckAt",void 0),A(this,"interruptDetectorTrack",void 0),A(this,"onLocalAudioTrackMute",()=>{O.info("ios15-interruption-start"),this.emit(hr.IOS_15_16_INTERRUPTION_START)}),A(this,"onLocalAudioTrackUnmute",async()=>{O.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?O.info("ios15-interruption-end-canceled"):(qs&&await qs.suspend(),this.emit(hr.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(s){O.debug("webaudio bindInterruptDetectorTrack ".concat(s.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=s,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(s){O.debug("webaudio unbindInterruptDetectorTrack ".concat(s.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===s&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function fk(){if(!bf)return void O.error("your browser is not support web audio");O.info("create audio context");const s=function(e){for(var i=1;i<arguments.length;i++){var o=arguments[i]!=null?arguments[i]:{};i%2?ha(Object(o),!0).forEach(function(c){A(e,c,o[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ha(Object(o)).forEach(function(c){Object.defineProperty(e,c,Object.getOwnPropertyDescriptor(o,c))})}return e}({},Q("WEBAUDIO_INIT_OPTIONS"));O.debug("audio context init option:",JSON.stringify(s)),qs=new bf(s),N.curState=qs.state,qs.onstatechange=()=>{N.prevState=N.curState,N.curState=qs?qs.state:void 0;const{prevState:e,curState:i}=N,o=i==="running",c=i==="interrupted",u=e==="running",h=e==="suspended",_=e==="interrupted",m=ln().osVersion;(ys()||Va())&&u&&c&&(O.info("ios".concat(m,"-interruption-start")),N.emit(hr.IOS_INTERRUPTION_START)),(ys()||Va())&&(h||_)&&o&&(O.info("ios".concat(m,"-interruption-end")),N.emit(hr.IOS_INTERRUPTION_END)),e!==i&&N.emit(hr.STATE_CHANGE,i,e)},setInterval(()=>{var e;const i=(e=qs)===null||e===void 0?void 0:e.currentTime;N.currentTime!==i?(N.currentTimeStuckAt&&(O.debug("AudioContext current time resume at ".concat(i)),N.currentTimeStuckAt=void 0),N.currentTime=i):(i!==N.currentTimeStuckAt&&(ne.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:gi.TRACER}).onSuccess(),O.warning("AudioContext current time stuck at ".concat(i))),N.currentTimeStuckAt=i)},5e3),async function(e){const i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let o,c=!1,u=!1,h=!1;function _(M){e.state==="running"?m(!1):ys()||Va()?e.state==="suspended"&&(m(!0),M&&e.resume().then(S,S)):e.state!=="closed"&&(m(!0),M&&e.resume().then(S,S))}function m(M){if(c!==M){c=M;for(let K=0,z=i;K<z.length;K+=1){const nt=z[K];M?window.addEventListener(nt,C,{capture:!0,passive:!0}):window.removeEventListener(nt,C,{capture:!0,passive:!0})}}}function g(){_(!0)}function S(){_(!1)}function C(){_(!0)}function I(M){if(!h)if(o.paused)if(M){let K;b(!1),h=!0;try{K=o.play(),K?K.then(x,x):(o.addEventListener("playing",x),o.addEventListener("abort",x),o.addEventListener("error",x))}catch{x()}}else b(!0);else b(!1)}function b(M){if(u!==M){u=M;for(let K=0,z=i;K<z.length;K++){const nt=z[K];M?window.addEventListener(nt,D,{capture:!0,passive:!0}):window.removeEventListener(nt,D,{capture:!0,passive:!0})}}}function x(){o.removeEventListener("playing",x),o.removeEventListener("abort",x),o.removeEventListener("error",x),h=!1,I(!1)}function D(){I(!0)}if(ys()){const M=e.createMediaStreamDestination(),K=document.createElement("div");K.innerHTML="<audio x-webkit-airplay='deny'></audio>",o=K.children.item(0),o.controls=!1,o.disableRemotePlayback=!0,o.preload="auto",o.srcObject=M.stream,I(!0)}N.on(hr.STATE_CHANGE,g),_(!1)}(qs)}function Q_(){if(!qs){if(fk(),!qs)throw new ft(j.NOT_SUPPORTED,"can not create audio context");return qs}return qs}function _p(s){if(function(){if(Dr!==null)return Dr;const o=Q_(),c=o.createBufferSource(),u=o.createGain(),h=o.createGain();c.connect(u),c.connect(h),c.disconnect(u);let _=!1;try{c.disconnect(u)}catch{_=!0}return c.disconnect(),Dr=_,_}())return;const e=s.connect,i=s.disconnect;s.connect=(o,c,u)=>{var h;return s._inputNodes||(s._inputNodes=[]),Jt(h=s._inputNodes).call(h,o)||(o instanceof AudioNode?(s._inputNodes.push(o),e.call(s,o,c,u)):e.call(s,o,c)),s},s.disconnect=(o,c,u)=>{i.call(s),o?qh(s._inputNodes,o):s._inputNodes=[];for(const h of s._inputNodes)e.call(s,h)}}let Dr=null;function pi(s,e){let i=!1;const o=1/e;if(Q("DISABLE_WEBAUDIO")){const c=window.setInterval(()=>{i?window.clearInterval(c):s(performance.now()/1e3)},1e3*o)}else{const c=Q_();let u=c.createGain();u.gain.value=0,u.connect(c.destination);const h=()=>{if(i)return void(u=null);const _=c.createOscillator();_.onended=h,_.connect(u),_.start(0),_.stop(c.currentTime+o),s(c.currentTime)};h()}return()=>{i=!0}}class gk{constructor(){A(this,"context",void 0),A(this,"analyserNode",void 0),A(this,"sourceNode",void 0),this.context=Q_(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||ys()||Va()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const o=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(o);for(let c=0;c<e.length;++c)e[c]=o[c]/128-1}const i=Lu(e).call(e,(o,c)=>o+c*c,0)/e.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,i;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{O.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class me extends oi{get processSourceNode(){return this.sourceNode}set processedNode(e){var i;if(!this.isDestroyed&&this._processedNode!==e){try{var o;(o=this.sourceNode)===null||o===void 0||o.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),A(this,"outputNode",void 0),A(this,"outputTrack",void 0),A(this,"isPlayed",!1),A(this,"context",void 0),A(this,"audioBufferNode",void 0),A(this,"destNode",void 0),A(this,"audioOutputLevel",0),A(this,"volumeLevelAnalyser",void 0),A(this,"_processedNode",void 0),A(this,"playNode",void 0),A(this,"isDestroyed",!1),A(this,"onNoAudioInput",void 0),A(this,"isNoAudioInput",!1),A(this,"_noAudioInputCount",0),this.context=Q_(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),_p(this.outputNode),this.volumeLevelAnalyser=new gk}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit(J.ON_AUDIO_BUFFER,function(o){for(let c=0;c<o.outputBuffer.numberOfChannels;c+=1){const u=o.outputBuffer.getChannelData(c);for(let h=0;h<u.length;h+=1)u[h]=0}return o.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!sn().webAudioMediaStreamDest)throw new ft(j.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&MS(()=>{N.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;ys()||Va()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const i=this.volumeLevelAnalyser.getAnalyserNode();let o;i.getFloatTimeDomainData?(o=new Float32Array(i.fftSize),i.getFloatTimeDomainData(o)):(o=new Uint8Array(i.fftSize),i.getByteTimeDomainData(o));let c=!1;for(let u=0;u<o.length;u++)o[u]!==0&&(c=!0);return c?(this.isNoAudioInput=!1,!0):(await Mr(200),await this.checkHasAudioInput(e?e+1:1)&&c)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,i;(e=this.processedNode)===null||e===void 0||e.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class ee extends me{get isFreeze(){return!1}constructor(e,i,o){var c;if(super(),A(this,"sourceNode",void 0),A(this,"track",void 0),A(this,"clonedTrack",void 0),A(this,"audioElement",void 0),A(this,"isCurrentTrackCloned",!1),A(this,"isRemoteTrack",!1),A(this,"originVolumeLevelAnalyser",void 0),A(this,"rebuildWebAudio",async()=>{if(O.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void O.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>O.info("resume success")),O.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const _=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?_.stop():this.isCurrentTrackCloned=!0;const m=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(m),_p(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const g=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(g,this.context.currentTime),_p(this.outputNode),this.emit(J.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=m,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new ft(j.UNEXPECTED_ERROR);this.track=e;const u=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(u),_p(this.sourceNode),o){const _=o.clone();_.enabled=!0,this.clonedTrack=_,O.debug("create an unmuted track ".concat(_.id," from the original track ").concat(o.id," to get the volume"));const m=this.context.createMediaStreamSource(new MediaStream([_]));_p(m),this.originVolumeLevelAnalyser=new gk,this.originVolumeLevelAnalyser.updateSource(m)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=u;const h=ln();i&&h.os===gr.IOS&&Number((c=h.osVersion)===null||c===void 0?void 0:c.split(".")[0])<15&&(N.on(hr.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(_=>{_||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const i=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(i),_p(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(J.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),N.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const i=e.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),O.debug("create an unmuted track ".concat(i.id," from the original track ").concat(e.id," to get the volume"));const o=this.context.createMediaStreamSource(new MediaStream([i]));_p(o),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(o)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function lt(s,e,i){const o=(u,h)=>u?typeof u!="number"?u.max||u.exact||u.ideal||u.min||h:u:h,c={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:s,maxHeight:o(e.height,1080),maxWidth:o(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(c.video.mandatory.maxFrameRate=e.frameRate.max,c.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(c.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(c)}async function mj(s,e){const i=await vb(s.mediaSource),{sourceId:o,audio:c}=await function(u){let h=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new ut((_,m)=>{const g=document.createElement("div");g.innerText="share screen",g.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const S=document.createElement("div");S.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const C=document.createElement("div");C.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",C.setAttribute("style","height: 12%;");const I=document.createElement("div");I.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const b=document.createElement("div");b.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const x=document.createElement("button");x.innerHTML="cancel",x.setAttribute("style","width: 85px;"),x.onclick=()=>{document.body.removeChild(K);const z=new Error("NotAllowedError");z.name="NotAllowedError",m(z)};let D=h;const M=document.createElement("div");if(h){const z=document.createElement("input");z.setAttribute("type","checkbox");const nt=document.createElement("span");z.setAttribute("style","margin-right: 6px;"),nt.innerText="Share audio",z.checked=D,z.onchange=()=>{D=z.checked},M.appendChild(z),M.appendChild(nt)}b.appendChild(M),b.appendChild(x),S.appendChild(C),S.appendChild(I),S.appendChild(b);const K=document.createElement("div");K.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),K.appendChild(g),K.appendChild(S),document.body.appendChild(K),u.map(z=>{if(z.id){const nt=document.createElement("div");nt.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let dt=z.thumbnail;try{const{width:it}=dt.getSize();it>1920&&(dt=dt.resize({width:1920}))}catch(it){throw it&&it.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),it}nt.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+dt.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+z.name.replace(/[\u00A0-\u9999<>\&]/g,function(it){return"&#"+it.charCodeAt(0)+";"})+"</span>",nt.onclick=()=>{document.body.removeChild(K),_({sourceId:z.id,audio:D})},I.appendChild(nt)}})})}(i,e);return await lt(o,s,c)}async function vb(s){let e=["window","screen"];s!=="application"&&s!=="window"||(e=["window"]),s==="screen"&&(e=["screen"]);const i=iL();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new ft(j.ELECTRON_IS_NULL);let o=null;try{var c;o=((c=i.desktopCapturer)===null||c===void 0?void 0:c.getSources({types:e}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{o=null}o&&o.then||(o=new ut((u,h)=>{i.desktopCapturer.getSources({types:e},(_,m)=>{_?h(_):u(m)})}));try{return await o}catch(u){throw new ft(j.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,u.toString())}}function bl(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}const Bu=new Sr("safari");let Tk=!1,Ib=!1;async function pa(s,e){let i=0,o=null;for(;i<2;)try{o=await fj(s,e,i>0);break}catch(c){if(c instanceof ft)throw O.error("[".concat(e,"] ").concat(c.toString())),c;const u=IR(c.name||c.code||c,c.message);if(u.code===j.MEDIA_OPTION_INVALID){O.debug("[".concat(e,"] detect media option invalid, retry")),i+=1,await Mr(500);continue}throw O.error("[".concat(e,"] ").concat(u.toString())),u}if(!o)throw new ft(j.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return o}async function fj(s,e,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new ft(j.NOT_SUPPORTED,"can not find getUserMedia");i&&(s.video&&(delete s.video.width,delete s.video.height),s.screen&&(delete s.screen.width,delete s.screen.height));const o=sn(),c=new MediaStream;if(s.audioSource&&c.addTrack(s.audioSource),s.videoSource&&c.addTrack(s.videoSource),!s.audio&&!s.video&&!s.screen)return O.debug("Using Video Source/ Audio Source"),c;if(s.screen)if(iL())s.screen.sourceId?Z_(c,await lt(s.screen.sourceId,s.screen,s.screenAudio)):Z_(c,await mj(s.screen,s.screenAudio));else if(Nu()&&s.screen.extensionId&&s.screen.mandatory){if(!o.getStreamFromExtension)throw new ft(j.NOT_SUPPORTED,"This browser does not support screen sharing");O.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const I=await(h=s.screen.extensionId,_=e,new ut((b,x)=>{try{chrome.runtime.sendMessage(h,{getStream:!0},D=>{if(!D||!D.streamId)return O.error("[".concat(_,"] No response from Chrome Plugin. Plugin not installed properly"),D),void x(new ft(j.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));b(D.streamId)})}catch(D){O.error("[".concat(_,"] AgoraRTC screensharing plugin is not accessible(").concat(h,")"),D.toString()),x(new ft(j.CHROME_PLUGIN_NOT_INSTALL))}}));s.screen.mandatory.chromeMediaSourceId=I,Z_(c,await navigator.mediaDevices.getUserMedia({video:{mandatory:s.screen.mandatory}}))}else if(o.getDisplayMedia){var u;s.screen.mediaSource&&Rb(s.screen.mediaSource);const I={width:s.screen.width,height:s.screen.height,frameRate:s.screen.frameRate,displaySurface:(u=s.screen.displaySurface)!==null&&u!==void 0?u:s.screen.mediaSource==="screen"?"monitor":s.screen.mediaSource},{selfBrowserSurface:b,surfaceSwitching:x,systemAudio:D}=s.screen,M={selfBrowserSurface:b,surfaceSwitching:x,systemAudio:D};!b&&delete M.selfBrowserSurface,!x&&delete M.surfaceSwitching,!D&&delete M.systemAudio,O.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:I,audio:!!s.screenAudio,controls:M}));const K=await navigator.mediaDevices.getDisplayMedia(function(z){for(var nt=1;nt<arguments.length;nt++){var dt=arguments[nt]!=null?arguments[nt]:{};nt%2?bl(Object(dt),!0).forEach(function(it){A(z,it,dt[it])}):Object.getOwnPropertyDescriptors?Object.defineProperties(z,Object.getOwnPropertyDescriptors(dt)):bl(Object(dt)).forEach(function(it){Object.defineProperty(z,it,Object.getOwnPropertyDescriptor(dt,it))})}return z}({video:I,audio:!!s.screenAudio},M));Z_(c,K)}else{if(!Ln())throw O.error("[".concat(e,"] This browser does not support screenSharing")),new ft(j.NOT_SUPPORTED,"This browser does not support screen sharing");{s.screen.mediaSource&&Rb(s.screen.mediaSource);const I={video:{mediaSource:s.screen.mediaSource,width:s.screen.width,height:s.screen.height,frameRate:s.screen.frameRate}};O.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(I))),Z_(c,await navigator.mediaDevices.getUserMedia(I))}}var h,_;if(!s.video&&!s.audio)return c;let m={video:s.video,audio:s.audio},g=Q("MEDIA_DEVICE_CONSTRAINTS");if(g)try{typeof g=="string"&&(g=JSON.parse(g)),m=xS(m,g)}catch{}O.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(m)),ln();let S,C=null;(Or()||ys()||DS())&&(C=await Bu.lock());try{S=await navigator.mediaDevices.getUserMedia(m)}catch(I){throw C&&C(),I}return m.audio&&(Tk=!0),m.video&&(Ib=!0),Z_(c,S),C&&C(),c}function IR(s,e){switch(s){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new ft(j.MEDIA_OPTION_INVALID,"".concat(s,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new ft(j.DEVICE_NOT_FOUND,"".concat(s,": ").concat(e));case"NotSupportedError":return new ft(j.NOT_SUPPORTED,"".concat(s,": ").concat(e));case"NotReadableError":return new ft(j.NOT_READABLE,"".concat(s,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new ft(j.PERMISSION_DENIED,"".concat(s,": ").concat(e));case"ConstraintNotSatisfiedError":return new ft(j.CONSTRAINT_NOT_SATISFIED,"".concat(s,": ").concat(e));default:return O.error("getUserMedia unexpected error",s),new ft(j.UNEXPECTED_ERROR,"".concat(s,": ").concat(e))}}function Z_(s,e){const i=s.getVideoTracks()[0],o=s.getAudioTracks()[0],c=e.getVideoTracks()[0],u=e.getAudioTracks()[0];u&&(o&&s.removeTrack(o),s.addTrack(u)),c&&(i&&s.removeTrack(i),s.addTrack(c))}const _a=new class extends oi{get state(){return this._state}set state(s){s!==this._state&&(this.emit(Kn.STATE_CHANGE,s),this._state=s)}constructor(){super(),A(this,"_state",pp.IDLE),A(this,"isAccessMicrophonePermission",!1),A(this,"isAccessCameraPermission",!1),A(this,"lastAccessMicrophonePermission",!1),A(this,"lastAccessCameraPermission",!1),A(this,"checkdeviceMatched",!1),A(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(Q("ENUMERATE_DEVICES_INTERVAL")||(ia()||Jm()===gr.HARMONY_OS)&&Du())&&this.updateDevicesInfo()},Q("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(s=>O.error(s.toString()))}async enumerateDevices(s,e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new ft(j.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const o=await navigator.mediaDevices.enumerateDevices(),c=this.checkMediaDeviceInfoIsOk(o);let u=!this.isAccessMicrophonePermission&&s,h=!this.isAccessCameraPermission&&e;c.audio&&(u=!1),c.video&&(h=!1);let _=null,m=null,g=null;if(!i&&(u||h)){if(Bu.isLocked&&(O.debug("[device manager] wait GUM lock"),(await Bu.lock())(),O.debug("[device manager] GUM unlock")),Tk&&(u=!1,this.isAccessMicrophonePermission=!0),Ib&&(h=!1,this.isAccessCameraPermission=!0),O.debug("[device manager] check media device permissions",s,e,u,h),u&&h){try{g=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(S){const C=IR(S.name||S.code||S,S.message);if(C.code===j.PERMISSION_DENIED)throw C;O.warning("getUserMedia failed in getDevices",C)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(u){try{_=await navigator.mediaDevices.getUserMedia({audio:s})}catch(S){const C=IR(S.name||S.code||S,S.message);if(C.code===j.PERMISSION_DENIED)throw C;O.warning("getUserMedia failed in getDevices",C)}this.isAccessMicrophonePermission=!0}else if(h){try{m=await navigator.mediaDevices.getUserMedia({video:e})}catch(S){const C=IR(S.name||S.code||S,S.message);if(C.code===j.PERMISSION_DENIED)throw C;O.warning("getUserMedia failed in getDevices",C)}this.isAccessCameraPermission=!0}O.debug("[device manager] mic permission",s,"cam permission",e)}try{const S=await navigator.mediaDevices.enumerateDevices();return _&&_.getTracks().forEach(C=>C.stop()),m&&m.getTracks().forEach(C=>C.stop()),g&&g.getTracks().forEach(C=>C.stop()),_=null,m=null,g=null,S}catch(S){return _&&_.getTracks().forEach(C=>C.stop()),m&&m.getTracks().forEach(C=>C.stop()),g&&g.getTracks().forEach(C=>C.stop()),_=null,m=null,g=null,new ft(j.ENUMERATE_DEVICES_FAILED,S.toString()).throw()}}async getRecordingDevices(){let s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,s)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,s)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,s)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(s){let e=null;return this.deviceInfoMap.forEach(i=>{i.device.label===s&&(e=i.device.deviceId)}),e}async getDeviceById(s){const e=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===s);if(!e)throw new ft(j.DEVICE_NOT_FOUND,"deviceId: ".concat(s));return e}async init(){this.state=pp.INITING;try{await this.updateDevicesInfo(),this.state=pp.INITEND}catch(s){throw O.warning("Device Detection functionality cannot start properly.",s.toString()),this.state=pp.IDLE,!(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")&&new ft(j.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),s}}async updateDevicesInfo(){const s=await this.enumerateDevices(!0,!0,!0),e=Date.now(),i=[];if(s[0]&&s[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const c=s.find(h=>h.kind==="audioinput"&&h.deviceId==="default"),u=s.find(h=>h.kind==="audiooutput"&&h.deviceId==="default");c&&u?u.groupId===c.groupId?O.debug("[device-check] default input ".concat(c.label," and output ").concat(u.label," is the same group")):O.warning("[device-check] default input ".concat(c.label," and output ").concat(u.label," is not the same group")):O.debug("[device-check] default input or output not found")}const o=this.checkMediaDeviceInfoIsOk(s);if(s.forEach(c=>{if(!c.deviceId)return;const u=this.deviceInfoMap.get("".concat(c.kind,"_").concat(c.deviceId));if((u?u.state:"INACTIVE")!=="ACTIVE"){const h={initAt:e,updateAt:e,device:c,state:"ACTIVE"};this.deviceInfoMap.set("".concat(c.kind,"_").concat(c.deviceId),h),i.push(h)}u&&(u.updateAt=e)}),this.deviceInfoMap.forEach((c,u)=>{c.state==="ACTIVE"&&c.updateAt!==e&&(c.state="INACTIVE",i.push(c))}),this.state!==pp.INITEND)return o.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(o.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(c=>{switch(c.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Kn.RECORDING_DEVICE_CHANGED,c);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Kn.CAMERA_DEVICE_CHANGED,c);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Kn.PLAYOUT_DEVICE_CHANGED,c)}}),o.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),o.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(s){const e=s.filter(c=>c.kind==="audioinput"),i=s.filter(c=>c.kind==="videoinput"),o={audio:!1,video:!1};for(const c of e)if(c.label&&c.deviceId){o.audio=!0;break}for(const c of i)if(c.label&&c.deviceId){o.video=!0;break}return o}};let wf=!1;const Ea=new class extends oi{constructor(){super(...arguments),A(this,"onAutoplayFailed",void 0),A(this,"onAudioAutoplayFailed",void 0)}};function Sk(){if(ln(),!wf){const s=e=>{e.preventDefault(),wf=!1,$c()?document.body.removeEventListener("click",s,!0):(document.body.removeEventListener("touchstart",s,!0),document.body.removeEventListener("mousedown",s,!0))};wf=!0,$c()?document.body.addEventListener("click",s,!0):(document.body.addEventListener("touchstart",s,!0),document.body.addEventListener("mousedown",s,!0)),O.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Ea.onAutoplayFailed?Ea.onAutoplayFailed():Ea.onAudioAutoplayFailed?O.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):O.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Ea.emit("autoplay-failed")}}function Rk(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Ck(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Rk(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Rk(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function yb(s,e,i,o){if(!s)return;const c=ne.getBaseInfoBySessionId(s);if(!c)return;const u=c.info,h=Date.now(),_=Ck(Ck({},u),{},{vid:u.vid===void 0?0:Number(u.vid),lts:h,elapse:h-c.startTime,cbRegistered:Ea.onAutoplayFailed||Ea.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:e,trackId:o,extend:void 0});ne.send({type:ei.AUTOPLAY_FAILED,data:_},!0)}const vk=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Qs=new class{constructor(){A(this,"onAutoplayFailed",void 0),A(this,"elementMap",new Map),A(this,"elementStateMap",new Map),A(this,"elementsNeedToResume",[]),A(this,"sinkIdMap",new Map),A(this,"autoResumeAfterInterruption",s=>{Array.from(this.elementMap.entries()).forEach(e=>{let[i,o]=e;const c=this.elementStateMap.get(i),u=o.srcObject.getAudioTracks()[0],h=u&&u.readyState;if(O.debug("resume after interrupted, ele: ".concat(c," audio: ").concat(h," ").concat(s)),h==="live"){if(s)return o.pause(),void o.play();if(N.curState==="running")return Yh()?(o.pause(),void o.play()):void(c&&c==="paused"&&o.play())}})}),A(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(s=>{let[e,i]=s;const o=i.srcObject.getAudioTracks()[0];o&&o.readyState==="live"&&(O.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),N.on(hr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),N.on(hr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),N.on(hr.STATE_CHANGE,()=>{ys()&&N.prevState==="suspended"&&N.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(s,e){const i=this.elementMap.get(s);if(this.sinkIdMap.set(s,e),i)try{await i.setSinkId(e)}catch(o){throw new ft(j.PERMISSION_DENIED,"can not set sink id: "+o.toString())}}play(s,e,i,o){if(this.elementMap.has(e))return;const c=document.createElement("audio");c.autoplay=!0,c.srcObject=new MediaStream([s]),this.bindAudioElementEvents(e,c),this.elementMap.set(e,c),this.elementStateMap.set(e,Ss.INIT),this.setVolume(e,i);const u=this.sinkIdMap.get(e);if(u)try{c.setSinkId(u).catch(_=>{O.warning("[".concat(e,"] set sink id failed"),_.toString())})}catch(_){O.warning("[".concat(e,"] set sink id failed"),_.toString())}const h=c.play();h&&h.then&&h.catch(_=>{o&&yb(o,"audio",_.message,e),O.warning("audio element play warning",_.toString()),this.elementMap.has(e)&&_.name==="NotAllowedError"&&(O.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(c),MS(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Sk()}))})}updateTrack(s,e){const i=this.elementMap.get(s);i&&(i.srcObject=new MediaStream([e]))}isPlaying(s){return this.elementMap.has(s)&&this.elementStateMap.get(s)==="playing"}setVolume(s,e){const i=this.elementMap.get(s);i&&(e=Math.max(0,Math.min(100,e)),i.volume=e/100)}stop(s){const e=this.elementMap.get(s);if(this.sinkIdMap.delete(s),!e)return;const i=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(i,1),e.srcObject=null,e.remove(),this.elementMap.delete(s),this.elementStateMap.delete(s)}bindAudioElementEvents(s,e){vk.forEach(i=>{e.addEventListener(i,o=>{const c=this.elementStateMap.get(s),u=o.type==="pause"?"paused":o.type;if(O.debug("[".concat(s,"] audio-element-status change ").concat(c," => ").concat(u)),o.type==="error"){const h=e==null?void 0:e.error;h&&O.error("[".concat(s,"] media error, code: ").concat(h.code,", message: ").concat(h.message))}this.elementStateMap.set(s,u)})})}getPlayerState(s){return this.elementStateMap.get(s)||"uninit"}autoResumeAudioElement(){const s=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(i=>{O.debug("Auto resume audio element success")}).catch(i=>{O.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new ut(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{$c()?document.body.addEventListener("click",s,!0):(document.body.addEventListener("touchstart",s,!0),document.body.addEventListener("mousedown",s,!0))})}};function Wi(){return function(s,e,i){const o=i.value;return typeof o=="function"&&(i.value=function(){this._isClosed&&new ft(j.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",O);for(var c=arguments.length,u=new Array(c),h=0;h<c;h++)u[h]=arguments[h];const _=o.apply(this,u);return _ instanceof ut?new ut((m,g)=>{_.then(m).catch(g)}):_}),i}}function Ik(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function yR(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Ik(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Ik(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class Ab extends oi{constructor(e){super(),A(this,"name","VideoProcessorDestination"),A(this,"ID","0"),A(this,"_source",void 0),A(this,"videoContext",void 0),A(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new ft(j.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new ft(j.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(gs.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(gs.ON_TRACK,void 0)}}class yk extends oi{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i){super(),A(this,"constraintsMap",new Map),A(this,"statsRegistry",[]),A(this,"usageRegistry",[]),A(this,"trackId",void 0),A(this,"direction",void 0),A(this,"_chained",!1),this.trackId=e,this.direction=i}async getConstraints(){return await zi(this,Ts.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,i){var o;return O.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),kn(this,Ts.REQUEST_UPDATE_CONSTRAINTS,Array.from(Rc(o=this.constraintsMap).call(o)))}async requestRevertConstraints(e){var i;if(this.constraintsMap.has(e))return O.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),kn(this,Ts.REQUEST_UPDATE_CONSTRAINTS,Array.from(Rc(i=this.constraintsMap).call(i)))}registerStats(e,i,o){this.statsRegistry.find(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:o})}unregisterStats(e,i){const o=this.statsRegistry.findIndex(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===i);o!==-1&&this.statsRegistry.splice(o,1)}gatherStats(){const e=[];for(const{processorID:i,processorName:o,type:c,cb:u}of this.statsRegistry)try{const h=u();e.push({processorID:i,processorName:o,type:c,stats:h})}catch(h){O.error(new ft(j.UNEXPECTED_ERROR,h.message))}return e}registerUsage(e,i){this.usageRegistry.find(o=>o.processorID===e.ID&&o.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){const i=this.usageRegistry.findIndex(o=>o.processorID===e.ID&&o.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let o=i();o instanceof ut&&(o=await o),e.push(yR(yR({},o),{},{direction:this.direction}))}catch(o){O.error("gather extension usage error",o)}return e}getDirection(){return this.direction}}class Ak extends oi{constructor(e){super(),A(this,"name","AudioProcessorDestination"),A(this,"ID","0"),A(this,"inputTrack",void 0),A(this,"inputNode",void 0),A(this,"audioProcessorContext",void 0),A(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new ft(j.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new ft(j.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(gs.ON_TRACK,void 0),this.emit(gs.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(gs.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(gs.ON_NODE,this.inputNode))}}class bk extends oi{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i,o){super(),A(this,"constraintsMap",new Map),A(this,"statsRegistry",[]),A(this,"audioContext",void 0),A(this,"trackId",void 0),A(this,"direction",void 0),A(this,"usageRegistry",[]),A(this,"_chained",!1),this.audioContext=e,this.trackId=i,this.direction=o}async getConstraints(){return zi(this,Ts.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,i){var o;return O.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),kn(this,Ts.REQUEST_UPDATE_CONSTRAINTS,Array.from(Rc(o=this.constraintsMap).call(o)))}async requestRevertConstraints(e){var i;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),kn(this,Ts.REQUEST_UPDATE_CONSTRAINTS,Array.from(Rc(i=this.constraintsMap).call(i)))}registerStats(e,i,o){this.statsRegistry.find(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:o})}unregisterStats(e,i){const o=this.statsRegistry.findIndex(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===i);o!==-1&&this.statsRegistry.splice(o,1)}gatherStats(){const e=[];for(const{processorID:i,processorName:o,type:c,cb:u}of this.statsRegistry)try{const h=u();e.push({processorID:i,processorName:o,type:c,stats:h})}catch(h){O.error(new ft(j.UNEXPECTED_ERROR,h.message))}return e}registerUsage(e,i){this.usageRegistry.find(o=>o.processorID===e.ID&&o.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){const i=this.usageRegistry.findIndex(o=>o.processorID===e.ID&&o.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let o=i();o instanceof ut&&(o=await o),e.push(yR(yR({},o),{},{direction:this.direction}))}catch(o){O.error("gather extension usage error",o)}return e}getDirection(){return this.direction}}class Of extends oi{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),A(this,"context",void 0),A(this,"processSourceNode",void 0),A(this,"outputTrack",void 0),A(this,"processedNode",void 0),A(this,"clonedTrack",void 0),A(this,"outputNode",void 0),this.outputNode=new gj}setVolume(){}createOutputTrack(){throw new ft(j.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class gj{disconnect(){}connect(){}}function bb(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function wb(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?bb(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):bb(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class Nn extends os{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Qs.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,i,o,c){super(e,o),A(this,"trackMediaType","audio"),A(this,"_encoderConfig",void 0),A(this,"_trackSource",void 0),A(this,"_enabled",!0),A(this,"_volume",100),A(this,"_useAudioElement",!0),A(this,"_bypassWebAudio",!1),A(this,"processor",void 0),A(this,"_processorContext",void 0),A(this,"_processorDestination",void 0),A(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=i,this._getOriginVolumeLevel=!!c,this._trackSource=new Of,Q("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),Q("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Or()&&!qs?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){hn(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Qs.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void O.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const i=this._source.createOutputTrack();this._mediaStreamTrack!==i&&(this._mediaStreamTrack=i,kn(this,Vt.NEED_REPLACE_TRACK,this).then(()=>{O.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(o=>{O.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),o)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!Nu()&&Q("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new ft(j.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Qs.setSinkID(this.getTrackId(),e)}async setEnabled(e,i,o){return this._setEnabled(e,i,o)}async _setEnabled(e,i,o){if(!o){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(O.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{o||(this._enabled=!0),await kn(this,Vt.NEED_ENABLE_TRACK,this),O.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(c){throw o||(this._enabled=!1),O.error("[".concat(this.getTrackId(),"] setEnabled to true error"),c.toString()),c}}else{this._originMediaStreamTrack.enabled=!1,o||(this._enabled=!1);try{await kn(this,Vt.NEED_DISABLE_TRACK,this)}catch(c){throw o||(this._enabled=!0),O.error("[".concat(this.getTrackId(),"] setEnabled to false error"),c.toString()),c}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,O.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await kn(this,Vt.NEED_MUTE_TRACK,this):await kn(this,Vt.NEED_UNMUTE_TRACK,this))}getStats(){return Xh(()=>{O.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),ko(this,Vt.GET_STATS)||wb({},He)}setAudioFrameCallback(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(J.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(i),this._source.removeAllListeners(J.ON_AUDIO_BUFFER),this._source.on(J.ON_AUDIO_BUFFER,o=>e(o))}play(){O.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(O.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Qs.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){O.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Qs.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];O.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Qs.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,i){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await kn(this,Vt.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return ut.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new ft(j.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new ft(j.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const i=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,i.reset()}bindProcessorDestinationEvents(e){e.on(gs.ON_TRACK,async i=>{i?i!==this._mediaStreamTrack&&(this._mediaStreamTrack=i,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(i),await kn(this,Vt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await kn(this,Vt.NEED_REPLACE_TRACK,this))}),e.on(gs.ON_NODE,i=>{this._source.processedNode=i})}unbindProcessorDestinationEvents(e){e.removeAllListeners(gs.ON_TRACK),e.removeAllListeners(gs.ON_NODE)}bindProcessorContextEvents(e){e.on(Ts.REQUEST_CONSTRAINTS,async i=>{i(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(Ts.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof Of&&(this._trackSource=new ee(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new bk(this._source.context,this.getTrackId(),"local"),i=new Ak(e);return this._processorContext=e,this._processorDestination=i,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(i),this._source.on(J.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Qs.stop(this.getTrackId()),this._source.play()),kn(this,Vt.NEED_REPLACE_MIXING_TRACK,this).then(()=>{O.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(o=>{O.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),o)})),{processorContext:e,processorDestination:i}}}Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e],throttleTime:300}),V("design:type",Function),V("design:paramtypes",[Number]),V("design:returntype",void 0)],Nn.prototype,"setVolume",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],Nn.prototype,"setPlaybackDevice",null),Tt([P_("LocalAudioTrack","_enabledMutex"),ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean,Object,Boolean]),V("design:returntype",ut)],Nn.prototype,"setEnabled",null),Tt([P_("LocalAudioTrack","_enabledMutex"),ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean]),V("design:returntype",ut)],Nn.prototype,"setMuted",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",Object)],Nn.prototype,"getStats",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[Object,Number]),V("design:returntype",void 0)],Nn.prototype,"setAudioFrameCallback",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Nn.prototype,"play",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Nn.prototype,"stop",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Nn.prototype,"close",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e.name]}),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",Object)],Nn.prototype,"pipe",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Nn.prototype,"unpipe",null);class wl extends Nn{get __className__(){return"MicrophoneAudioTrack"}constructor(e,i,o,c){super(e,i.encoderConfig?z_(i.encoderConfig):{},c,Q("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),A(this,"_config",void 0),A(this,"_deviceName","default"),A(this,"_constraints",void 0),A(this,"_originalConstraints",void 0),A(this,"_enabled",!0),this._config=i,this._constraints=o,this._originalConstraints=o,this._deviceName=e.label,typeof i.bypassWebAudio=="boolean"&&(this._bypassWebAudio=i.bypassWebAudio),(Yh()||y_())&&N.bindInterruptDetectorTrack(this)}async setDevice(e){if(O.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const i=await _a.getDeviceById(e),o={};o.audio=wb({},this._constraints),o.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let c=null;try{c=await pa(o,this.getTrackId())}catch(u){throw O.error("[".concat(this.getTrackId(),"] setDevice failed"),u.toString()),c=await pa({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!1),u}await this._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!1),this._deviceName=i.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(i){throw O.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{const i=await _a.getDeviceById(e);this._deviceName=i.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(i){throw O.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}O.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,i,o){if(i)return O.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!o){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(O.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){var c;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(c=this._source.clonedTrack)===null||c===void 0||c.stop(),o||(this._enabled=!1);try{await kn(this,Vt.NEED_DISABLE_TRACK,this)}catch(_){throw O.error("[".concat(this.getTrackId(),"] setEnabled false failed"),_.toString()),_}return}const u=wb({},this._constraints),h=_a.searchDeviceIdByName(this._deviceName);h&&!u.deviceId&&(u.deviceId=h);try{o||(this._enabled=!0);const _=await pa({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(_.getAudioTracks()[0],!1),await kn(this,Vt.NEED_ENABLE_TRACK,this)}catch(_){throw o||(this._enabled=!1),O.error("[".concat(this.getTrackId(),"] setEnabled true failed"),_.toString()),_}O.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Yh()||y_())&&N.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((ys()||Va())&&this._enabled&&!this._isClosed&&N.duringInterruption){const e=async()=>{N.off(hr.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(O.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};N.on(hr.IOS_INTERRUPTION_END,e)}else O.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ni.TRACK_ENDED)}async renewMediaStreamTrack(e){const i=e||this._constraints,o=_a.searchDeviceIdByName(this._deviceName);if(o&&!i.deviceId&&(i.deviceId=o),this._constraints=i,this._enabled){this._originMediaStreamTrack.stop();const c=await pa({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Ts.REQUEST_UPDATE_CONSTRAINTS,async(i,o,c)=>{try{const u=Object.assign({},this._originalConstraints,...i);await this.renewMediaStreamTrack(u),o()}catch(u){c(u)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Ts.REQUEST_UPDATE_CONSTRAINTS)}}Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],wl.prototype,"setDevice",null),Tt([P_("MicrophoneAudioTrack","_enabledMutex"),ce({argsMap:(s,e,i)=>[s.getTrackId(),e,i]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean,Boolean,Boolean]),V("design:returntype",ut)],wl.prototype,"setEnabled",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],wl.prototype,"close",null);class Ol extends Nn{get __className__(){return"BufferSourceAudioTrack"}constructor(e,i,o,c){super(i.createOutputTrack(),o,c),A(this,"source",void 0),A(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=i,this._bufferSource.on(J.AUDIO_SOURCE_STATE_CHANGE,u=>{this.safeEmit(ni.SOURCE_STATE_CHANGE,u)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){hn(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e,s.duration]}),Wi(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",void 0)],Ol.prototype,"startProcessAudioBuffer",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Ol.prototype,"pauseProcessAudioBuffer",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[Number]),V("design:returntype",void 0)],Ol.prototype,"seekAudioBuffer",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Ol.prototype,"resumeProcessAudioBuffer",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Ol.prototype,"stopProcessAudioBuffer",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Ol.prototype,"close",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),Wi(),V("design:type",Function),V("design:paramtypes",[Number]),V("design:returntype",void 0)],Ol.prototype,"setAudioBufferPlaybackSpeed",null);class pr extends Nn{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Q_().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Hn(8,"track-mix-")),A(this,"trackList",void 0),A(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(O.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):O.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){O.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}qh(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(i=>{i instanceof pr?i.emit(Xd.TRANSCEIVER_UPDATED,e):i._updateRtpTransceiver(e)}))}}function Nf(s){const e={};s.facingMode&&(e.facingMode=s.facingMode),s.cameraId&&(e.deviceId={exact:s.cameraId});const i=dd(s.encoderConfig);return i.width!=null&&(e.width=i.width),i.height!=null&&(e.height=i.height),!tL()&&i.frameRate&&(e.frameRate=i.frameRate),ln().name===un.EDGE&&typeof e.frameRate=="object"&&(e.frameRate.max=60),Ln()&&(e.frameRate={ideal:30,max:30}),e}function wk(s){const e={};if(tL()||(s.AGC!==void 0&&(e.autoGainControl=s.AGC),s.AEC!==void 0&&(e.echoCancellation=s.AEC),s.ANS!==void 0&&(e.noiseSuppression=s.ANS,Nu()&&s.ANS&&(e.googHighpassFilter=s.ANS))),s.encoderConfig){const i=z_(s.encoderConfig);e.channelCount=i.stereo?2:1,e.sampleRate=i.sampleRate,e.sampleSize=i.sampleSize}return s.microphoneId&&(e.deviceId={exact:s.microphoneId}),ia()&&(e.sampleRate=void 0),e}class Tj extends me{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(J.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),A(this,"audioBuffer",void 0),A(this,"sourceNode",void 0),A(this,"startPlayTime",0),A(this,"startPlayOffset",0),A(this,"pausePlayTime",0),A(this,"options",void 0),A(this,"currentLoopCount",0),A(this,"currentPlaybackSpeed",100),A(this,"_currentState","stopped"),this.audioBuffer=e,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):O.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const Ok=new Map;async function Sj(s,e){let i=null;if(typeof s=="string"){const c=Ok.get(s);if(c)return O.debug("use cached audio resource: ",s),c;try{i=(await ed(()=>Ks.get(s,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(u){throw new ft(j.FETCH_AUDIO_FILE_FAILED,u.toString())}}else i=await new ut((u,h)=>{const _=new FileReader;_.onload=m=>{m.target?u(m.target.result):h(new ft(j.READ_LOCAL_AUDIO_FILE_ERROR))},_.onerror=()=>{h(new ft(j.READ_LOCAL_AUDIO_FILE_ERROR))},_.readAsArrayBuffer(s)});const o=await function(c){const u=Q_();return new ut((h,_)=>{u.decodeAudioData(c,m=>{h(m)},m=>{_(new ft(j.DECODE_AUDIO_FILE_FAILED,m.toString()))})})}(i);return typeof s=="string"&&e&&Ok.set(s,o),o}const Ob=s=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new ut((i,o)=>{e.toBlob(async c=>{if(e.remove(),c){const u=await Nk(c);i({buffer:u,width:e.width,height:e.height})}else o(new ft(j.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},s,1)})},Nk=async s=>{const e=await s.arrayBuffer();return new Uint8Array(e)};function Dk(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function AR(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Dk(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Dk(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class Nb{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(O.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var i;e!==this._videoState&&(O.debug("[".concat(this.trackId,"] video-status change ").concat(this._videoState," => ").concat(e)),this._videoState=e,(i=this.onVideoStateChanged)===null||i===void 0||i.call(this,this.videoState))}constructor(e){A(this,"trackId",void 0),A(this,"config",void 0),A(this,"onFirstVideoFrameDecoded",void 0),A(this,"onVideoStateChanged",void 0),A(this,"freezeTimeCounterList",[]),A(this,"renderFreezeAccTime",0),A(this,"isKeepLastFrame",!1),A(this,"timeUpdatedCount",0),A(this,"freezeTime",0),A(this,"playbackTime",0),A(this,"lastTimeUpdatedTime",0),A(this,"autoplayFailed",!1),A(this,"videoTrack",void 0),A(this,"videoElement",void 0),A(this,"cacheVideoElement",void 0),A(this,"_videoState",Ie.VideoStateStopped),A(this,"videoElementCheckInterval",void 0),A(this,"videoElementFreezeTimeout",void 0),A(this,"_videoElementStatus",Ss.NONE),A(this,"isGettingVideoDimensions",!1),A(this,"startGetVideoDimensions",()=>{const i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return O.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),A(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&N.curState==="running"&&(O.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(vA())),Lo()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),A(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Ss.PLAYING;break;case"loadeddata":if(this.videoState=Ie.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Ss.CANPLAY;break;case"stalled":this.videoElementStatus=Ss.STALLED;break;case"suspend":this.videoElementStatus=Ss.SUSPEND;break;case"pause":this.videoElementStatus=Ss.PAUSED,ys()||Va()||Or()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(O.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Ss.WAITING;break;case"abort":this.videoElementStatus=Ss.ABORT;break;case"ended":this.videoElementStatus=Ss.ENDED;break;case"emptied":this.videoElementStatus=Ss.EMPTIED;break;case"error":{this.videoElementStatus=Ss.ERROR;const o=this.videoElement.error;o&&O.error("[".concat(this.trackId,"] media error, code: ").concat(o.code,", message: ").concat(o.message));break}case"timeupdate":{const o=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=o);const c=o-this.lastTimeUpdatedTime,u=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=o,qa.lastVisibleTime<qa.lastHiddenTime||u<qa.lastHiddenTime||u<qa.lastVisibleTime)return;for(c>Q("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=c),this.playbackTime+=c;this.playbackTime>=6e3;){this.playbackTime-=6e3;const h=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(h),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),A(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(O.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(vA())),Lo()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),N.on(hr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),N.on(hr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const i=this.videoElement.play();i&&i.catch&&i.catch(c=>{e&&yb(e,"video",c.message,this.trackId),c.name==="NotAllowedError"?(O.warning("detected video element autoplay failed",c),this.autoplayFailed=!0,this.handleAutoPlayFailed()):O.warning("[".concat(this.trackId,"] play warning: "),c)});const o=ln();if((o.name==="Safari"&&Number(o.version)===15||Yh())&&i&&i.then){const c=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(c).catch(c)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const i=e.getContext("2d");if(!i)return O.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,e.width,e.height);const o=i.getImageData(0,0,e.width,e.height);return e.remove(),o}async getCurrentFrameToUint8Array(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const o=document.createElement("canvas");o.width=this.videoElement.videoWidth,o.height=this.videoElement.videoHeight;const c=o.getContext("2d");return c?(c.drawImage(this.videoElement,0,0,o.width,o.height),new ut((u,h)=>{o.toBlob(async _=>{if(o.remove(),_){const m=await Nk(_);u({buffer:m,width:o.width,height:o.height})}else h(new ft(j.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,i<0?.1:i>1?1:i)})):await Ob(e)}destroy(){N.off(hr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),N.off(hr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Ie.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Ss.INIT,!this.videoElementCheckInterval&&(Pk.forEach(u=>{this.videoElement.addEventListener(u,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(u){return u!==document.body&&document.body.contains(u)})(this.videoElement)||(this.videoElementStatus=Ss.DESTROYED)},1e3),Q("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,i;let u;const h=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",h),this.videoElementFreezeTimeout=window.setTimeout(_,Q("VIDEO_FREEZE_DURATION")))},_=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Ie.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Ie.VideoStateFrozen:document.addEventListener("visibilitychange",h))},m=(g,S)=>{if(this.videoElementStatus===Ss.PLAYING){if(u){const b=S.presentationTime-u.presentationTime;this.videoState===Ie.VideoStateStarting&&(this.videoState=Ie.VideoStateDecoding),this.videoState===Ie.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(_,Q("VIDEO_FREEZE_DURATION"))),b<Q("VIDEO_FREEZE_DURATION")&&this.videoState===Ie.VideoStateFrozen&&(this.videoState=Ie.VideoStateDecoding),b>Q("VIDEO_FREEZE_DURATION")&&qa.lastVisibleTime>=qa.lastHiddenTime&&u.timestamp>qa.lastVisibleTime&&u.timestamp>qa.lastHiddenTime&&(this.renderFreezeAccTime+=b)}u=AR(AR({},S),{},{timestamp:g})}var C,I;Q("ENABLE_VIDEO_FRAME_CALLBACK")&&((C=(I=this.videoElement).requestVideoFrameCallback)===null||C===void 0||C.call(I,m))};(e=(i=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(i,m)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),ia()&&(this.videoElement.poster="noposter");const o=ln();o.name==="Safari"&&Number(o.version)===15||Yh()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ln()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ln()&&this.videoElement.load());const c=this.videoElement.play();c!==void 0&&c.catch(u=>{O.debug("[".concat(this.trackId,"] playback interrupted"),u.toString())})}resetVideoElement(){Pk.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Ss.NONE}handleAutoPlayFailed(){const e=i=>{i.preventDefault(),this.videoElement.play().then(()=>{O.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(o=>{O.error(o)}),this.autoplayFailed=!1,$c()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};$c()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Sk()}}const Pk=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class Lk extends Nb{constructor(e){super(e),A(this,"container",void 0),A(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const i=e.element;i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var i;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,o):await Ob(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",Q("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function kk(s){return new ut((e,i)=>{let o=!1;const c=document.createElement("video");c.setAttribute("autoplay",""),c.setAttribute("muted",""),c.muted=!0,c.autoplay=!0,c.setAttribute("playsinline",""),c.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(c);const u=ys()?"canplay":"playing";c.addEventListener(u,()=>{const h=c.videoWidth,_=c.videoHeight;!h&&Ln()||(o=!0,c.srcObject=null,c.remove(),e([h,_]))}),c.srcObject=new MediaStream([s]),c.play().catch(US),setTimeout(()=>{o||(c.srcObject=null,c.remove(),e([c.videoWidth,c.videoHeight]))},4e3)})}const Db=async(s,e,i)=>{const o=function(h){const _=[];for(let m=0;m<h.length;m+=2)_.push(parseInt(h.slice(m,m+2),16));return Uint8Array.from(_)}(function(h){const _="0123456789abcdef";function m(bt){let kt,Ne="";for(kt=0;kt<=3;kt++)Ne+=_.charAt(bt>>8*kt+4&15)+_.charAt(bt>>8*kt&15);return Ne}function g(bt,kt){const Ne=(65535&bt)+(65535&kt);return(bt>>16)+(kt>>16)+(Ne>>16)<<16|65535&Ne}function S(bt,kt,Ne,Ge,Qn,Er){return g(function(jn,Xo){return jn<<Xo|jn>>>32-Xo}(g(g(kt,bt),g(Ge,Er)),Qn),Ne)}function C(bt,kt,Ne,Ge,Qn,Er,jn){return S(kt&Ne|~kt&Ge,bt,kt,Qn,Er,jn)}function I(bt,kt,Ne,Ge,Qn,Er,jn){return S(kt&Ge|Ne&~Ge,bt,kt,Qn,Er,jn)}function b(bt,kt,Ne,Ge,Qn,Er,jn){return S(kt^Ne^Ge,bt,kt,Qn,Er,jn)}function x(bt,kt,Ne,Ge,Qn,Er,jn){return S(Ne^(kt|~Ge),bt,kt,Qn,Er,jn)}const D=function(bt){let kt;const Ne=1+(bt.length+8>>6),Ge=new Array(16*Ne);for(kt=0;kt<16*Ne;kt++)Ge[kt]=0;for(kt=0;kt<bt.length;kt++)Ge[kt>>2]|=bt.charCodeAt(kt)<<kt%4*8;return Ge[kt>>2]|=128<<kt%4*8,Ge[16*Ne-2]=8*bt.length,Ge}(h);let M,K,z,nt,dt,it=1732584193,at=-271733879,ht=-1732584194,pt=271733878;for(M=0;M<D.length;M+=16)K=it,z=at,nt=ht,dt=pt,it=C(it,at,ht,pt,D[M+0],7,-680876936),pt=C(pt,it,at,ht,D[M+1],12,-389564586),ht=C(ht,pt,it,at,D[M+2],17,606105819),at=C(at,ht,pt,it,D[M+3],22,-1044525330),it=C(it,at,ht,pt,D[M+4],7,-176418897),pt=C(pt,it,at,ht,D[M+5],12,1200080426),ht=C(ht,pt,it,at,D[M+6],17,-1473231341),at=C(at,ht,pt,it,D[M+7],22,-45705983),it=C(it,at,ht,pt,D[M+8],7,1770035416),pt=C(pt,it,at,ht,D[M+9],12,-1958414417),ht=C(ht,pt,it,at,D[M+10],17,-42063),at=C(at,ht,pt,it,D[M+11],22,-1990404162),it=C(it,at,ht,pt,D[M+12],7,1804603682),pt=C(pt,it,at,ht,D[M+13],12,-40341101),ht=C(ht,pt,it,at,D[M+14],17,-1502002290),at=C(at,ht,pt,it,D[M+15],22,1236535329),it=I(it,at,ht,pt,D[M+1],5,-165796510),pt=I(pt,it,at,ht,D[M+6],9,-1069501632),ht=I(ht,pt,it,at,D[M+11],14,643717713),at=I(at,ht,pt,it,D[M+0],20,-373897302),it=I(it,at,ht,pt,D[M+5],5,-701558691),pt=I(pt,it,at,ht,D[M+10],9,38016083),ht=I(ht,pt,it,at,D[M+15],14,-660478335),at=I(at,ht,pt,it,D[M+4],20,-405537848),it=I(it,at,ht,pt,D[M+9],5,568446438),pt=I(pt,it,at,ht,D[M+14],9,-1019803690),ht=I(ht,pt,it,at,D[M+3],14,-187363961),at=I(at,ht,pt,it,D[M+8],20,1163531501),it=I(it,at,ht,pt,D[M+13],5,-1444681467),pt=I(pt,it,at,ht,D[M+2],9,-51403784),ht=I(ht,pt,it,at,D[M+7],14,1735328473),at=I(at,ht,pt,it,D[M+12],20,-1926607734),it=b(it,at,ht,pt,D[M+5],4,-378558),pt=b(pt,it,at,ht,D[M+8],11,-2022574463),ht=b(ht,pt,it,at,D[M+11],16,1839030562),at=b(at,ht,pt,it,D[M+14],23,-35309556),it=b(it,at,ht,pt,D[M+1],4,-1530992060),pt=b(pt,it,at,ht,D[M+4],11,1272893353),ht=b(ht,pt,it,at,D[M+7],16,-155497632),at=b(at,ht,pt,it,D[M+10],23,-1094730640),it=b(it,at,ht,pt,D[M+13],4,681279174),pt=b(pt,it,at,ht,D[M+0],11,-358537222),ht=b(ht,pt,it,at,D[M+3],16,-722521979),at=b(at,ht,pt,it,D[M+6],23,76029189),it=b(it,at,ht,pt,D[M+9],4,-640364487),pt=b(pt,it,at,ht,D[M+12],11,-421815835),ht=b(ht,pt,it,at,D[M+15],16,530742520),at=b(at,ht,pt,it,D[M+2],23,-995338651),it=x(it,at,ht,pt,D[M+0],6,-198630844),pt=x(pt,it,at,ht,D[M+7],10,1126891415),ht=x(ht,pt,it,at,D[M+14],15,-1416354905),at=x(at,ht,pt,it,D[M+5],21,-57434055),it=x(it,at,ht,pt,D[M+12],6,1700485571),pt=x(pt,it,at,ht,D[M+3],10,-1894986606),ht=x(ht,pt,it,at,D[M+10],15,-1051523),at=x(at,ht,pt,it,D[M+1],21,-2054922799),it=x(it,at,ht,pt,D[M+8],6,1873313359),pt=x(pt,it,at,ht,D[M+15],10,-30611744),ht=x(ht,pt,it,at,D[M+6],15,-1560198380),at=x(at,ht,pt,it,D[M+13],21,1309151649),it=x(it,at,ht,pt,D[M+4],6,-145523070),pt=x(pt,it,at,ht,D[M+11],10,-1120210379),ht=x(ht,pt,it,at,D[M+2],15,718787259),at=x(at,ht,pt,it,D[M+9],21,-343485551),it=g(it,K),at=g(at,z),ht=g(ht,nt),pt=g(pt,dt);return m(it)+m(at)+m(ht)+m(pt)}(""+e+i)).slice(0,16),c=o.slice(0,12),u=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:c},u,s))},Mk=async(s,e,i)=>await Db(s.buffer,e,i);function Uk(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function jt(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Uk(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Uk(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class ke extends os{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Ss.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,i,o,c,u,h){if(super(e,u),A(this,"trackMediaType","video"),A(this,"_player",void 0),A(this,"isUseScaleResolutionDownBy",!1),A(this,"_videoVisibleTimer",null),A(this,"_statsTimer",null),A(this,"_previousVideoVisibleStatus",void 0),A(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),A(this,"_encoderConfig",void 0),A(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),A(this,"_optimizationMode",void 0),A(this,"_videoHeight",void 0),A(this,"_videoWidth",void 0),A(this,"_forceBitrateLimit",void 0),A(this,"_enabled",!0),A(this,"processorDestination",void 0),A(this,"_processorContext",void 0),Or()){const{width:_,height:m}=e.getSettings();this._videoWidth=_,this._videoHeight=m}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=i,this._scalabilityMode=o,this._optimizationMode=c,this._hints=h||[],this._hints.indexOf(Fn.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(_,m,g){const S=ln();return!(S.name!==_||!S.osVersion)&&Number(S.version)===m}(un.CHROME,115)&&Jm().indexOf("Windows")!==-1){const _=function(m,g){if("VideoFrame"in window&&"TransformStream"in window&&sn().supportWebRTCInsertableStream){const S=new MediaStreamTrackProcessor(m),C=new MediaStreamTrackGenerator({kind:"video"});let I,b,x=Date.now();const D=()=>{M&&(clearInterval(M),M=void 0),I&&(I.close(),I=void 0),m.stop(),b=void 0,C.removeEventListener("ended",D)};let M=window.setInterval(()=>{if(b&&I&&Date.now()-x>1e3)try{C.readyState==="live"?b.enqueue(I.clone()):D()}catch{D()}},1e3);const K=new TransformStream({transform:(z,nt)=>{C.readyState==="live"?(b=nt,x=Date.now(),I===void 0?(I=z,nt.enqueue(z.clone())):(nt.enqueue(I),I=z)):z.close()}});return C.addEventListener("ended",D),S.readable.pipeThrough(K).pipeTo(C.writable),C}}(e);_&&(O.info("local screen video track begin to inject frame"),this._mediaStreamTrack=_)}i&&this._hints.indexOf(Fn.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this._processorContext=new yk(this.getTrackId(),"local"),this.processorDestination=new Ab(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const c=document.getElementById(e);c?e=c:(O.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}O.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));const o=jt(jt(jt({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(o):(e instanceof HTMLVideoElement?this._player=new Nb(o):this._player=new Lk(o),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const c=this.getVideoElementVisibleStatus();this.safeEmit(ni.VIDEO_ELEMENT_VISIBLE_STATUS,c)}catch{}},Q("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,O.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(O.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await kn(this,Vt.NEED_DISABLE_TRACK,this)}catch(o){throw O.error("[".concat(this.getTrackId(),"] setEnabled to false error"),o.toString()),o}return i||(this._enabled=!1),void O.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await kn(this,Vt.NEED_ENABLE_TRACK,this)}catch(o){throw O.error("[".concat(this.getTrackId(),"] setEnabled to true error"),o.toString()),o}O.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,O.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await kn(this,Vt.NEED_MUTE_TRACK,this):await kn(this,Vt.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,i){if(!this._enabled)throw new ft(j.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=dd(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const o=Nf({encoderConfig:e});(Or()||ys()||Va())&&(o.deviceId=void 0),O.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(o));try{await this._originMediaStreamTrack.applyConstraints(o),this.updateMediaStreamTrackResolution()}catch(c){const u=new ft(j.UNEXPECTED_ERROR,c.toString());throw O.error("[".concat(this.getTrackId(),"] applyConstraints error"),u.toString()),u}}this._encoderConfig=e,this._hints.indexOf(Fn.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await kn(this,Vt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(O)}}getStats(){return Xh(()=>{O.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),ko(this,Vt.GET_STATS)||jt({},Cb)}async setBeautyEffect(e){O.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,i):await Ob(e)}async setBitrateLimit(e){if(O.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin=e.min_bitrate);try{await kn(this,Vt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(O)}}}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void O.error(j.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const i=this._optimizationMode;try{this._optimizationMode=e,await kn(this,Vt.SET_OPTIMIZATION_MODE,this)}catch(o){throw this._optimizationMode=i,O.error("[".concat(this.getTrackId(),"] set optimization mode failed"),o.toString()),o}O.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return O.error(j.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,O.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){kk(this._originMediaStreamTrack).then(e=>{let[i,o]=e;this._videoHeight=o,this._videoWidth=i}).catch(US)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new ft(j.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");O.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=dd(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(Fn.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await kn(this,Vt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(O)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:i,frameRate:o}=this.getMediaStreamTrackSettings();if(!e||!i||!o)return;const{bitrateMax:c,bitrateMin:u}=this._encoderConfig;if(u==null||c==null){const{max:h,min:_}=function(m,g,S,C,I){const b=Q("BITRATE_ADAPTER_TYPE");if(b==="DEFAULT_BITRATE")return{min:C,max:I};if(I===void 0){var x;const M=Math.floor(200*Math.pow(S/15,.6)*Math.pow(m*g/640/360,.75));I=b==="STANDARD_BITRATE"?4*M:2*M,C=(x=C)!==null&&x!==void 0?x:M}else{var D;C=(D=C)!==null&&D!==void 0?D:Math.floor(I/10)}return{min:C,max:I}}(e,i,o,u,c);this._encoderConfig.bitrateMin=_,this._encoderConfig.bitrateMax=h,O.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(i,", fps: ").concat(o,"] => [brMax: ").concat(h,", brMin: ").concat(_,"]"))}}getVideoElementVisibleStatus(){try{var e,i;const o=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),c={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:o==null?void 0:o.parentElement},{element:u,slot:h}=c;if(this.isPlaying&&u instanceof HTMLVideoElement&&h instanceof HTMLElement){const _=Xm.checkOneElementVisible(u),m=Object.assign({},_);if(m.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=m.visible;const g=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});m.visible?g.onSuccess("Video is visible"):g.onSuccess("Invisible because of ".concat(m.reason))}return m}return}catch(o){throw new ft(j.GET_VIDEO_ELEMENT_VISIBLE_ERROR,o.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new ft(j.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],o=this._encoderConfig;e&&(o=jt(jt({},o),dd(e))),o=Jh(o);const c=Hn(8,"track-video-cloned-"),u=new ke(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,o,Jh(this._scalabilityMode),this._optimizationMode,c,Jh(this._hints));return e&&o&&u.setEncoderConfiguration(o),O.debug("clone video track from ".concat(this.getTrackId()," to ").concat(c,", clone ").concat(i)),u}async replaceTrack(e,i){if(!(e instanceof MediaStreamTrack))throw new ft(j.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new ft(j.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,i,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!Or()&&!ys())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,i=Vi[e],o=-1,c=Date.now();const u=h=>{h>2||h<0||(c=Date.now(),i=Vi[h],this.setSenderConfiguration(i))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{const h=this.getStats(),_=ko(this,Vt.GET_RTC_STATS);if(h.sendPackets>0&&_){o===-1&&(o=Date.now());const m=Date.now();if(m-o<1e3||m-c<Q("PROFILE_SWITCH_INTERVAL"))return;const g=h.sendFrameRate,S=.6*i.frameRate,C=.9*i.frameRate;typeof g=="number"&&g>0&&g<S?e>0&&(e--,u(e),O.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(g,", switchProfile to ").concat(e))):_.OutgoingAvailableBandwidth<i.bitrateMin?e>0&&(e--,u(e),O.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(_.OutgoingAvailableBandwidth,", bitrateMin ").concat(i.bitrateMin,", switchProfile to ").concat(e))):typeof g=="number"&&g>C&&e<Vi.length-1&&_.OutgoingAvailableBandwidth>1.2*Vi[e+1].bitrateMin&&(e++,u(e),O.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(g,", OutgoingAvailableBandwidth ").concat(_.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}},Q("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(e){if(Xh(()=>{ne.reportApiInvoke(null,{name:tr.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:gi.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!Q("ENABLE_VIDEO_SEI")||!Q("ENABLE_ENCODED_TRANSFORM"))return void O.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(!(e instanceof Uint8Array))return new ft(j.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const i=this.getRTCRtpTransceiver();if(!i)return void O.warning("Video track is not published, SEI can not be send");const o=i.sender.getParameters();if(o.codecs.length===0)return;const c=o.codecs[0].mimeType.toLocaleLowerCase();c==="video/h264"?this.safeEmit("sei-to-send",e):O.warning("SEI is not supported by ".concat(c))}bindProcessorDestinationEvents(){this.processorDestination.on(gs.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await kn(this,Vt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await kn(this,Vt.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gs.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ts.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ts.REQUEST_CONSTRAINTS)}}Tt([ce({argsMap:(s,e,i)=>[s.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),Wi(),V("design:type",Function),V("design:paramtypes",[Object,Object]),V("design:returntype",void 0)],ke.prototype,"play",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ke.prototype,"stop",null),Tt([P_("LocalVideoTrack","_enabledMutex"),ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean,Boolean]),V("design:returntype",ut)],ke.prototype,"setEnabled",null),Tt([P_("LocalVideoTrack","_enabledMutex"),ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean]),V("design:returntype",ut)],ke.prototype,"setMuted",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Object,Boolean]),V("design:returntype",ut)],ke.prototype,"setEncoderConfiguration",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",Object)],ke.prototype,"getStats",null),Tt([ce({argsMap:(s,e,i)=>[s.getTrackId(),e,i]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean,Object]),V("design:returntype",ut)],ke.prototype,"setBeautyEffect",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ImageData)],ke.prototype,"getCurrentFrameData",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[String,Number]),V("design:returntype",ut)],ke.prototype,"getCurrentFrameImage",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],ke.prototype,"setBitrateLimit",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],ke.prototype,"setOptimizationMode",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",void 0)],ke.prototype,"setScalabiltyMode",null),Tt([Wi(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ke.prototype,"updateMediaStreamTrackResolution",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e.name]}),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",Object)],ke.prototype,"pipe",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ke.prototype,"unpipe",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ke.prototype,"close",null),Tt([ce({argsMap:(s,e,i)=>[s.getTrackId(),e.label,i]}),V("design:type",Function),V("design:paramtypes",[MediaStreamTrack,Boolean]),V("design:returntype",ut)],ke.prototype,"replaceTrack",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ke.prototype,"startMonitorStats",null);class Rs extends ke{get __className__(){return"CameraVideoTrack"}constructor(e,i,o,c,u,h){super(e,dd(i.encoderConfig),c,u,h),A(this,"_config",void 0),A(this,"_originalConstraints",void 0),A(this,"_constraints",void 0),A(this,"_enabled",!0),A(this,"_deviceName","default"),A(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Yh()||y_())&&!function(){const _=ln();if(_.os!==gr.IOS||!_.osVersion)return!1;const m=_.osVersion.split(".");return Number(m[0])===15&&Number(m[1])>=2}()&&A_()&&this._enabled&&!this._isClosed&&(O.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=i,this._originalConstraints=o,this._constraints=o,this._deviceName=e.label,this._encoderConfig=dd(this._config.encoderConfig),N.on(hr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),N.on(hr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(O.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const i=await _a.getDeviceById(e),o={};o.video=jt({},this._constraints),o.video.deviceId={exact:e},o.video.facingMode=void 0,this._originMediaStreamTrack.stop();let c=null;try{c=await pa(o,this.getTrackId())}catch(u){throw O.error("[".concat(this.getTrackId(),"] setDevice failed"),u.toString()),c=await pa({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(c.getVideoTracks()[0],!1),u}await this._updateOriginMediaStreamTrack(c.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=i.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(i){throw O.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{const i=await _a.getDeviceById(e);this._deviceName=i.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(i){throw O.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}O.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){O.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const i={video:jt(jt({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let o=null;try{o=await pa(i,this.getTrackId())}catch(c){throw O.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),c.toString()),o=await pa({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),c}await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=jt({},i.video),O.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(O.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const o=await pa({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1)}await kn(this,Vt.NEED_ENABLE_TRACK,this)}catch(o){throw O.error("[".concat(this.getTrackId(),"] setEnabled true error"),o.toString()),o}this.updateMediaStreamTrackResolution(),O.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),i||(this._enabled=!1);try{await kn(this,Vt.NEED_DISABLE_TRACK,this)}catch(o){throw O.error("[".concat(this.getTrackId(),"] setEnabled to false error"),o.toString()),o}O.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,i){if(!this._enabled)throw new ft(j.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=dd(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin);const o=Jn(this._config);o.encoderConfig=e;const c=Nf(o);(Or()||ys()||Va())&&(c.deviceId=void 0),O.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(c));try{await this._originMediaStreamTrack.applyConstraints(c),this.updateMediaStreamTrackResolution()}catch(u){const h=new ft(j.UNEXPECTED_ERROR,u.toString());throw O.error("[".concat(this.getTrackId(),"] applyConstraints error"),h.toString()),h}this._config=o,this._constraints=c,this._originalConstraints=c,this._encoderConfig=e,this._hints.indexOf(Fn.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await kn(this,Vt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(u){return u.throw(O)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((ys()||Va())&&this._enabled&&!this._isClosed&&N.duringInterruption){const e=async()=>{N.off(hr.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(O.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};N.on(hr.IOS_INTERRUPTION_END,e)}else O.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ni.TRACK_ENDED)}async renewMediaStreamTrack(e){const i=e||this._constraints,o=_a.searchDeviceIdByName(this._deviceName);if(o&&!i.deviceId&&(i.deviceId={exact:o}),this._enabled){const c=await pa({video:i},this.getTrackId());this._constraints=i,await this._updateOriginMediaStreamTrack(c.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),N.off(hr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),N.off(hr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],o=this._encoderConfig;e&&(o=jt(jt({},o),dd(e))),o=Jh(o);const c=Hn(8,"track-cam-cloned-"),u=new Rs(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,Jh(jt(jt({},this._config),{},{encoderConfig:o})),Jh(this._constraints),Jh(this._scalabilityMode),this._optimizationMode,c);return e&&o&&u.setEncoderConfiguration(o),O.debug("clone track from ".concat(this.getTrackId()," to ").concat(c,", clone ").concat(i)),u}bindProcessorContextEvents(){this.processorContext.on(Ts.REQUEST_UPDATE_CONSTRAINTS,async(e,i,o)=>{try{const c=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(c),i()}catch(c){o(c)}}),this.processorContext.on(Ts.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}}function Df(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function $_(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Df(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Df(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function ma(s,e,i,o){i.optimizationMode&&(o&&o.width&&o.height?(i.encoderConfig=$_($_({},o),{},{bitrateMin:o.bitrateMin,bitrateMax:o.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(e.contentHint=i.optimizationMode,e.contentHint===i.optimizationMode?O.debug("[".concat(s,"] set content hint to"),i.optimizationMode):O.debug("[".concat(s,"] set content hint failed")))):O.warning("[".concat(s,"] can not apply optimization mode bitrate config, no encoderConfig")))}function Ls(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function de(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Ls(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Ls(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Rs.prototype,"setDevice",null),Tt([P_("CameraVideoTrack","_enabledMutex"),ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Boolean,Boolean]),V("design:returntype",ut)],Rs.prototype,"setEnabled",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e]}),Wi(),V("design:type",Function),V("design:paramtypes",[Object,Boolean]),V("design:returntype",ut)],Rs.prototype,"setEncoderConfiguration",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Rs.prototype,"close",null);class Yn extends vR{getUserId(){return this._userId}constructor(e,i,o,c){super(e,"track-".concat(e.kind,"-").concat(i,"-").concat(c.clientId,"_").concat(Hn(5,""))),A(this,"_userId",void 0),A(this,"_uintId",void 0),A(this,"_isDestroyed",!1),A(this,"store",void 0),A(this,"processor",void 0),this._userId=i,this._uintId=o,this.store=c}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,O.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class fe extends Yn{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Ss.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,i,o,c){super(e,i,o,c),A(this,"_videoVisibleTimer",null),A(this,"_previousVideoVisibleStatus",void 0),A(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),A(this,"trackMediaType","video"),A(this,"_videoWidth",void 0),A(this,"_videoHeight",void 0),A(this,"_player",void 0),A(this,"processorDestination",void 0),A(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new yk(this.getTrackId(),"remote"),this.processorDestination=new Ab(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Xh(()=>{O.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),ko(this,Vt.GET_STATS)||de({},mk)}play(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const c=document.getElementById(e);c?e=c:(O.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}O.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));const o=de(de({fit:"cover"},i),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(o):(e instanceof HTMLVideoElement?this._player=new Nb(o):this._player=new Lk(o),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(on.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=c=>{this.safeEmit(on.VIDEO_STATE_CHANGED,c)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const c=this.getVideoElementVisibleStatus();this.safeEmit(on.VIDEO_ELEMENT_VISIBLE_STATUS,c)}catch{}},Q("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,O.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){kk(this._originMediaStreamTrack).then(e=>{let[i,o]=e;this._videoHeight=o,this._videoWidth=i}).catch(US)}_updatePlayerSource(){O.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,i;const o=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),c={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:o==null?void 0:o.parentElement},{element:u,slot:h}=c;if(this.isPlaying&&u instanceof HTMLVideoElement&&h instanceof HTMLElement){const _=Xm.checkOneElementVisible(u),m=Object.assign({},_);if(m.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=m.visible;const g=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});m.visible?g.onSuccess("Video is visible"):g.onSuccess("Invisible because of ".concat(m.reason))}return m}return}catch(o){throw new ft(j.GET_VIDEO_ELEMENT_VISIBLE_ERROR,o.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new ft(j.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gs.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gs.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(Xd.SEI_RECEIVED,e)}}Tt([ce({argsMap:(s,e,i)=>[s.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),V("design:type",Function),V("design:paramtypes",[Object,Object]),V("design:returntype",void 0)],fe.prototype,"play",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],fe.prototype,"stop",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e.name]}),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",Object)],fe.prototype,"pipe",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],fe.prototype,"unpipe",null);class ue extends Yn{get isPlaying(){return this._useAudioElement?Qs.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,i,o,c){super(e,i,o,c),A(this,"trackMediaType","audio"),A(this,"_source",void 0),A(this,"_useAudioElement",!0),A(this,"_volume",100),A(this,"processorContext",void 0),A(this,"processorDestination",void 0),A(this,"_played",!1),A(this,"_bypassWebAudio",!1),Q("DISABLE_WEBAUDIO")?(this._source=new Of,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new ee(e,!0),Q("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(J.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(on.FIRST_FRAME_DECODED)}),this.processorContext=new bk(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Ak(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(J.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(J.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(i),this._source.removeAllListeners(J.ON_AUDIO_BUFFER),this._source.on(J.ON_AUDIO_BUFFER,o=>e(o))}setVolume(e){this._volume=e,this._useAudioElement?Qs.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!Nu()&&Q("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new ft(j.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Qs.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Xh(()=>{O.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),ko(this,Vt.GET_STATS)||de({},Af)}play(){O.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(O.debug("[".concat(this.getTrackId(),"] use audio element to play")),Qs.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){O.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Qs.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];O.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Qs.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new ft(j.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new ft(j.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new ft(j.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const i=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,i.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gs.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(gs.ON_NODE,e=>{this._source.processedNode=e;const i=!e;this._useAudioElement!==i&&(this._played?(this.stop(),this._useAudioElement=i,this.play()):this._useAudioElement=i)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gs.ON_TRACK),this.processorDestination.removeAllListeners(gs.ON_NODE)}}Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e],throttleTime:300}),V("design:type",Function),V("design:paramtypes",[Number]),V("design:returntype",void 0)],ue.prototype,"setVolume",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e]}),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],ue.prototype,"setPlaybackDevice",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ue.prototype,"play",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ue.prototype,"stop",null),Tt([ce({argsMap:(s,e)=>[s.getTrackId(),e.name]}),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",Object)],ue.prototype,"pipe",null),Tt([ce({argsMap:s=>[s.getTrackId()]}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],ue.prototype,"unpipe",null);const qa=new class extends oi{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),A(this,"_lastHiddenTime",0),A(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),O.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */function Ue(s){let e=s.length;for(;--e>=0;)s[e]=0}const Os=256,be=286,Nl=30,Dl=15,ud=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),bR=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Pb=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),wR=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ju=new Array(576);Ue(ju);const wc=new Array(60);Ue(wc);const Ep=new Array(512);Ue(Ep);const Fi=new Array(256);Ue(Fi);const OR=new Array(29);Ue(OR);const Cs=new Array(Nl);function ld(s,e,i,o,c){this.static_tree=s,this.extra_bits=e,this.extra_base=i,this.elems=o,this.max_length=c,this.has_stree=s&&s.length}let Zs,mp,fn;function Fr(s,e){this.dyn_tree=s,this.max_code=0,this.stat_desc=e}Ue(Cs);const Pf=s=>s<256?Ep[s]:Ep[256+(s>>>7)],Ji=(s,e)=>{s.pending_buf[s.pending++]=255&e,s.pending_buf[s.pending++]=e>>>8&255},xe=(s,e,i)=>{s.bi_valid>16-i?(s.bi_buf|=e<<s.bi_valid&65535,Ji(s,s.bi_buf),s.bi_buf=e>>16-s.bi_valid,s.bi_valid+=i-16):(s.bi_buf|=e<<s.bi_valid&65535,s.bi_valid+=i)},hd=(s,e,i)=>{xe(s,i[2*e],i[2*e+1])},as=(s,e)=>{let i=0;do i|=1&s,s>>>=1,i<<=1;while(--e>0);return i>>>1},Lf=(s,e,i)=>{const o=new Array(16);let c,u,h=0;for(c=1;c<=Dl;c++)h=h+i[c-1]<<1,o[c]=h;for(u=0;u<=e;u++){let _=s[2*u+1];_!==0&&(s[2*u]=as(o[_]++,_))}},NR=s=>{let e;for(e=0;e<be;e++)s.dyn_ltree[2*e]=0;for(e=0;e<Nl;e++)s.dyn_dtree[2*e]=0;for(e=0;e<19;e++)s.bl_tree[2*e]=0;s.dyn_ltree[512]=1,s.opt_len=s.static_len=0,s.sym_next=s.matches=0},Lb=s=>{s.bi_valid>8?Ji(s,s.bi_buf):s.bi_valid>0&&(s.pending_buf[s.pending++]=s.bi_buf),s.bi_buf=0,s.bi_valid=0},kb=(s,e,i,o)=>{const c=2*e,u=2*i;return s[c]<s[u]||s[c]===s[u]&&o[e]<=o[i]},Kt=(s,e,i)=>{const o=s.heap[i];let c=i<<1;for(;c<=s.heap_len&&(c<s.heap_len&&kb(e,s.heap[c+1],s.heap[c],s.depth)&&c++,!kb(e,o,s.heap[c],s.depth));)s.heap[i]=s.heap[c],i=c,c<<=1;s.heap[i]=o},go=(s,e,i)=>{let o,c,u,h,_=0;if(s.sym_next!==0)do o=255&s.pending_buf[s.sym_buf+_++],o+=(255&s.pending_buf[s.sym_buf+_++])<<8,c=s.pending_buf[s.sym_buf+_++],o===0?hd(s,c,e):(u=Fi[c],hd(s,u+Os+1,e),h=ud[u],h!==0&&(c-=OR[u],xe(s,c,h)),o--,u=Pf(o),hd(s,u,i),h=bR[u],h!==0&&(o-=Cs[u],xe(s,o,h)));while(_<s.sym_next);hd(s,256,e)},pd=(s,e)=>{const i=e.dyn_tree,o=e.stat_desc.static_tree,c=e.stat_desc.has_stree,u=e.stat_desc.elems;let h,_,m,g=-1;for(s.heap_len=0,s.heap_max=573,h=0;h<u;h++)i[2*h]!==0?(s.heap[++s.heap_len]=g=h,s.depth[h]=0):i[2*h+1]=0;for(;s.heap_len<2;)m=s.heap[++s.heap_len]=g<2?++g:0,i[2*m]=1,s.depth[m]=0,s.opt_len--,c&&(s.static_len-=o[2*m+1]);for(e.max_code=g,h=s.heap_len>>1;h>=1;h--)Kt(s,i,h);m=u;do h=s.heap[1],s.heap[1]=s.heap[s.heap_len--],Kt(s,i,1),_=s.heap[1],s.heap[--s.heap_max]=h,s.heap[--s.heap_max]=_,i[2*m]=i[2*h]+i[2*_],s.depth[m]=(s.depth[h]>=s.depth[_]?s.depth[h]:s.depth[_])+1,i[2*h+1]=i[2*_+1]=m,s.heap[1]=m++,Kt(s,i,1);while(s.heap_len>=2);s.heap[--s.heap_max]=s.heap[1],((S,C)=>{const I=C.dyn_tree,b=C.max_code,x=C.stat_desc.static_tree,D=C.stat_desc.has_stree,M=C.stat_desc.extra_bits,K=C.stat_desc.extra_base,z=C.stat_desc.max_length;let nt,dt,it,at,ht,pt,bt=0;for(at=0;at<=Dl;at++)S.bl_count[at]=0;for(I[2*S.heap[S.heap_max]+1]=0,nt=S.heap_max+1;nt<573;nt++)dt=S.heap[nt],at=I[2*I[2*dt+1]+1]+1,at>z&&(at=z,bt++),I[2*dt+1]=at,dt>b||(S.bl_count[at]++,ht=0,dt>=K&&(ht=M[dt-K]),pt=I[2*dt],S.opt_len+=pt*(at+ht),D&&(S.static_len+=pt*(x[2*dt+1]+ht)));if(bt!==0){do{for(at=z-1;S.bl_count[at]===0;)at--;S.bl_count[at]--,S.bl_count[at+1]+=2,S.bl_count[z]--,bt-=2}while(bt>0);for(at=z;at!==0;at--)for(dt=S.bl_count[at];dt!==0;)it=S.heap[--nt],it>b||(I[2*it+1]!==at&&(S.opt_len+=(at-I[2*it+1])*I[2*it],I[2*it+1]=at),dt--)}})(s,e),Lf(i,g,s.bl_count)},At=(s,e,i)=>{let o,c,u=-1,h=e[1],_=0,m=7,g=4;for(h===0&&(m=138,g=3),e[2*(i+1)+1]=65535,o=0;o<=i;o++)c=h,h=e[2*(o+1)+1],++_<m&&c===h||(_<g?s.bl_tree[2*c]+=_:c!==0?(c!==u&&s.bl_tree[2*c]++,s.bl_tree[32]++):_<=10?s.bl_tree[34]++:s.bl_tree[36]++,_=0,u=c,h===0?(m=138,g=3):c===h?(m=6,g=3):(m=7,g=4))},gn=(s,e,i)=>{let o,c,u=-1,h=e[1],_=0,m=7,g=4;for(h===0&&(m=138,g=3),o=0;o<=i;o++)if(c=h,h=e[2*(o+1)+1],!(++_<m&&c===h)){if(_<g)do hd(s,c,s.bl_tree);while(--_!=0);else c!==0?(c!==u&&(hd(s,c,s.bl_tree),_--),hd(s,16,s.bl_tree),xe(s,_-3,2)):_<=10?(hd(s,17,s.bl_tree),xe(s,_-3,3)):(hd(s,18,s.bl_tree),xe(s,_-11,7));_=0,u=c,h===0?(m=138,g=3):c===h?(m=6,g=3):(m=7,g=4)}};let ge=!1;const za=(s,e,i,o)=>{xe(s,0+(o?1:0),3),Lb(s),Ji(s,i),Ji(s,~i),i&&s.pending_buf.set(s.window.subarray(e,e+i),s.pending),s.pending+=i};var Oc=s=>{ge||((()=>{let e,i,o,c,u;const h=new Array(16);for(o=0,c=0;c<28;c++)for(OR[c]=o,e=0;e<1<<ud[c];e++)Fi[o++]=c;for(Fi[o-1]=c,u=0,c=0;c<16;c++)for(Cs[c]=u,e=0;e<1<<bR[c];e++)Ep[u++]=c;for(u>>=7;c<Nl;c++)for(Cs[c]=u<<7,e=0;e<1<<bR[c]-7;e++)Ep[256+u++]=c;for(i=0;i<=Dl;i++)h[i]=0;for(e=0;e<=143;)ju[2*e+1]=8,e++,h[8]++;for(;e<=255;)ju[2*e+1]=9,e++,h[9]++;for(;e<=279;)ju[2*e+1]=7,e++,h[7]++;for(;e<=287;)ju[2*e+1]=8,e++,h[8]++;for(Lf(ju,287,h),e=0;e<Nl;e++)wc[2*e+1]=5,wc[2*e]=as(e,5);Zs=new ld(ju,ud,257,be,Dl),mp=new ld(wc,bR,0,Nl,Dl),fn=new ld(new Array(0),Pb,0,19,7)})(),ge=!0),s.l_desc=new Fr(s.dyn_ltree,Zs),s.d_desc=new Fr(s.dyn_dtree,mp),s.bl_desc=new Fr(s.bl_tree,fn),s.bi_buf=0,s.bi_valid=0,NR(s)},Br=(s,e,i,o)=>{let c,u,h=0;s.level>0?(s.strm.data_type===2&&(s.strm.data_type=(_=>{let m,g=4093624447;for(m=0;m<=31;m++,g>>>=1)if(1&g&&_.dyn_ltree[2*m]!==0)return 0;if(_.dyn_ltree[18]!==0||_.dyn_ltree[20]!==0||_.dyn_ltree[26]!==0)return 1;for(m=32;m<Os;m++)if(_.dyn_ltree[2*m]!==0)return 1;return 0})(s)),pd(s,s.l_desc),pd(s,s.d_desc),h=(_=>{let m;for(At(_,_.dyn_ltree,_.l_desc.max_code),At(_,_.dyn_dtree,_.d_desc.max_code),pd(_,_.bl_desc),m=18;m>=3&&_.bl_tree[2*wR[m]+1]===0;m--);return _.opt_len+=3*(m+1)+5+5+4,m})(s),c=s.opt_len+3+7>>>3,u=s.static_len+3+7>>>3,u<=c&&(c=u)):c=u=i+5,i+4<=c&&e!==-1?za(s,e,i,o):s.strategy===4||u===c?(xe(s,2+(o?1:0),3),go(s,ju,wc)):(xe(s,4+(o?1:0),3),((_,m,g,S)=>{let C;for(xe(_,m-257,5),xe(_,g-1,5),xe(_,S-4,4),C=0;C<S;C++)xe(_,_.bl_tree[2*wR[C]+1],3);gn(_,_.dyn_ltree,m-1),gn(_,_.dyn_dtree,g-1)})(s,s.l_desc.max_code+1,s.d_desc.max_code+1,h+1),go(s,s.dyn_ltree,s.dyn_dtree)),NR(s),o&&Lb(s)},xk=(s,e,i)=>(s.pending_buf[s.sym_buf+s.sym_next++]=e,s.pending_buf[s.sym_buf+s.sym_next++]=e>>8,s.pending_buf[s.sym_buf+s.sym_next++]=i,e===0?s.dyn_ltree[2*i]++:(s.matches++,e--,s.dyn_ltree[2*(Fi[i]+Os+1)]++,s.dyn_dtree[2*Pf(e)]++),s.sym_next===s.sym_end),Qd={_tr_init:Oc,_tr_stored_block:za,_tr_flush_block:Br,_tr_tally:xk,_tr_align:s=>{xe(s,2,3),hd(s,256,ju),(e=>{e.bi_valid===16?(Ji(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(s)}},$s=(s,e,i,o)=>{let c=65535&s|0,u=s>>>16&65535|0,h=0;for(;i!==0;){h=i>2e3?2e3:i,i-=h;do c=c+e[o++]|0,u=u+c|0;while(--h);c%=65521,u%=65521}return c|u<<16|0};const _d=new Uint32Array((()=>{let s,e=[];for(var i=0;i<256;i++){s=i;for(var o=0;o<8;o++)s=1&s?3988292384^s>>>1:s>>>1;e[i]=s}return e})());var qr=(s,e,i,o)=>{const c=_d,u=o+i;s^=-1;for(let h=o;h<u;h++)s=s>>>8^c[255&(s^e[h])];return-1^s},ai={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Gu={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Pl,_tr_stored_block:Mb,_tr_flush_block:Rj,_tr_tally:Ja,_tr_align:Cj}=Qd,{Z_NO_FLUSH:Nc,Z_PARTIAL_FLUSH:Vk,Z_FULL_FLUSH:Ub,Z_FINISH:Xa,Z_BLOCK:xb,Z_OK:to,Z_STREAM_END:Fk,Z_STREAM_ERROR:Zd,Z_DATA_ERROR:vj,Z_BUF_ERROR:Vb,Z_DEFAULT_COMPRESSION:Ij,Z_FILTERED:Bk,Z_HUFFMAN_ONLY:kf,Z_RLE:Fb,Z_FIXED:Mf,Z_DEFAULT_STRATEGY:yj,Z_UNKNOWN:Xi,Z_DEFLATED:Uf}=Gu,tE=286,eE=30,Bb=19,Fo=2*tE+1,jk=15,Ll=258,fa=262,fp=42,Wu=113,Dc=666,zs=(s,e)=>(s.msg=ai[e],e),Gk=s=>2*s-(s>4?9:0),kl=s=>{let e=s.length;for(;--e>=0;)s[e]=0},Aj=s=>{let e,i,o,c=s.w_size;e=s.hash_size,o=e;do i=s.head[--o],s.head[o]=i>=c?i-c:0;while(--e);e=c,o=e;do i=s.prev[--o],s.prev[o]=i>=c?i-c:0;while(--e)};let Ml=(s,e,i)=>(e<<s.hash_shift^i)&s.hash_mask;const Qa=s=>{const e=s.state;let i=e.pending;i>s.avail_out&&(i=s.avail_out),i!==0&&(s.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+i),s.next_out),s.next_out+=i,e.pending_out+=i,s.total_out+=i,s.avail_out-=i,e.pending-=i,e.pending===0&&(e.pending_out=0))},Za=(s,e)=>{Rj(s,s.block_start>=0?s.block_start:-1,s.strstart-s.block_start,e),s.block_start=s.strstart,Qa(s.strm)},yi=(s,e)=>{s.pending_buf[s.pending++]=e},xf=(s,e)=>{s.pending_buf[s.pending++]=e>>>8&255,s.pending_buf[s.pending++]=255&e},jb=(s,e,i,o)=>{let c=s.avail_in;return c>o&&(c=o),c===0?0:(s.avail_in-=c,e.set(s.input.subarray(s.next_in,s.next_in+c),i),s.state.wrap===1?s.adler=$s(s.adler,e,c,i):s.state.wrap===2&&(s.adler=qr(s.adler,e,c,i)),s.next_in+=c,s.total_in+=c,c)},$d=(s,e)=>{let i,o,c=s.max_chain_length,u=s.strstart,h=s.prev_length,_=s.nice_match;const m=s.strstart>s.w_size-fa?s.strstart-(s.w_size-fa):0,g=s.window,S=s.w_mask,C=s.prev,I=s.strstart+Ll;let b=g[u+h-1],x=g[u+h];s.prev_length>=s.good_match&&(c>>=2),_>s.lookahead&&(_=s.lookahead);do if(i=e,g[i+h]===x&&g[i+h-1]===b&&g[i]===g[u]&&g[++i]===g[u+1]){u+=2,i++;do;while(g[++u]===g[++i]&&g[++u]===g[++i]&&g[++u]===g[++i]&&g[++u]===g[++i]&&g[++u]===g[++i]&&g[++u]===g[++i]&&g[++u]===g[++i]&&g[++u]===g[++i]&&u<I);if(o=Ll-(I-u),u=I-Ll,o>h){if(s.match_start=e,h=o,o>=_)break;b=g[u+h-1],x=g[u+h]}}while((e=C[e&S])>m&&--c!=0);return h<=s.lookahead?h:s.lookahead},gp=s=>{const e=s.w_size;let i,o,c;do{if(o=s.window_size-s.lookahead-s.strstart,s.strstart>=e+(e-fa)&&(s.window.set(s.window.subarray(e,e+e-o),0),s.match_start-=e,s.strstart-=e,s.block_start-=e,s.insert>s.strstart&&(s.insert=s.strstart),Aj(s),o+=e),s.strm.avail_in===0)break;if(i=jb(s.strm,s.window,s.strstart+s.lookahead,o),s.lookahead+=i,s.lookahead+s.insert>=3)for(c=s.strstart-s.insert,s.ins_h=s.window[c],s.ins_h=Ml(s,s.ins_h,s.window[c+1]);s.insert&&(s.ins_h=Ml(s,s.ins_h,s.window[c+3-1]),s.prev[c&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=c,c++,s.insert--,!(s.lookahead+s.insert<3)););}while(s.lookahead<fa&&s.strm.avail_in!==0)},Wk=(s,e)=>{let i,o,c,u=s.pending_buf_size-5>s.w_size?s.w_size:s.pending_buf_size-5,h=0,_=s.strm.avail_in;do{if(i=65535,c=s.bi_valid+42>>3,s.strm.avail_out<c||(c=s.strm.avail_out-c,o=s.strstart-s.block_start,i>o+s.strm.avail_in&&(i=o+s.strm.avail_in),i>c&&(i=c),i<u&&(i===0&&e!==Xa||e===Nc||i!==o+s.strm.avail_in)))break;h=e===Xa&&i===o+s.strm.avail_in?1:0,Mb(s,0,0,h),s.pending_buf[s.pending-4]=i,s.pending_buf[s.pending-3]=i>>8,s.pending_buf[s.pending-2]=~i,s.pending_buf[s.pending-1]=~i>>8,Qa(s.strm),o&&(o>i&&(o=i),s.strm.output.set(s.window.subarray(s.block_start,s.block_start+o),s.strm.next_out),s.strm.next_out+=o,s.strm.avail_out-=o,s.strm.total_out+=o,s.block_start+=o,i-=o),i&&(jb(s.strm,s.strm.output,s.strm.next_out,i),s.strm.next_out+=i,s.strm.avail_out-=i,s.strm.total_out+=i)}while(h===0);return _-=s.strm.avail_in,_&&(_>=s.w_size?(s.matches=2,s.window.set(s.strm.input.subarray(s.strm.next_in-s.w_size,s.strm.next_in),0),s.strstart=s.w_size,s.insert=s.strstart):(s.window_size-s.strstart<=_&&(s.strstart-=s.w_size,s.window.set(s.window.subarray(s.w_size,s.w_size+s.strstart),0),s.matches<2&&s.matches++,s.insert>s.strstart&&(s.insert=s.strstart)),s.window.set(s.strm.input.subarray(s.strm.next_in-_,s.strm.next_in),s.strstart),s.strstart+=_,s.insert+=_>s.w_size-s.insert?s.w_size-s.insert:_),s.block_start=s.strstart),s.high_water<s.strstart&&(s.high_water=s.strstart),h?4:e!==Nc&&e!==Xa&&s.strm.avail_in===0&&s.strstart===s.block_start?2:(c=s.window_size-s.strstart,s.strm.avail_in>c&&s.block_start>=s.w_size&&(s.block_start-=s.w_size,s.strstart-=s.w_size,s.window.set(s.window.subarray(s.w_size,s.w_size+s.strstart),0),s.matches<2&&s.matches++,c+=s.w_size,s.insert>s.strstart&&(s.insert=s.strstart)),c>s.strm.avail_in&&(c=s.strm.avail_in),c&&(jb(s.strm,s.window,s.strstart,c),s.strstart+=c,s.insert+=c>s.w_size-s.insert?s.w_size-s.insert:c),s.high_water<s.strstart&&(s.high_water=s.strstart),c=s.bi_valid+42>>3,c=s.pending_buf_size-c>65535?65535:s.pending_buf_size-c,u=c>s.w_size?s.w_size:c,o=s.strstart-s.block_start,(o>=u||(o||e===Xa)&&e!==Nc&&s.strm.avail_in===0&&o<=c)&&(i=o>c?c:o,h=e===Xa&&s.strm.avail_in===0&&i===o?1:0,Mb(s,s.block_start,i,h),s.block_start+=i,Qa(s.strm)),h?3:1)},Gb=(s,e)=>{let i,o;for(;;){if(s.lookahead<fa){if(gp(s),s.lookahead<fa&&e===Nc)return 1;if(s.lookahead===0)break}if(i=0,s.lookahead>=3&&(s.ins_h=Ml(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),i!==0&&s.strstart-i<=s.w_size-fa&&(s.match_length=$d(s,i)),s.match_length>=3)if(o=Ja(s,s.strstart-s.match_start,s.match_length-3),s.lookahead-=s.match_length,s.match_length<=s.max_lazy_match&&s.lookahead>=3){s.match_length--;do s.strstart++,s.ins_h=Ml(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart;while(--s.match_length!=0);s.strstart++}else s.strstart+=s.match_length,s.match_length=0,s.ins_h=s.window[s.strstart],s.ins_h=Ml(s,s.ins_h,s.window[s.strstart+1]);else o=Ja(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++;if(o&&(Za(s,!1),s.strm.avail_out===0))return 1}return s.insert=s.strstart<2?s.strstart:2,e===Xa?(Za(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Za(s,!1),s.strm.avail_out===0)?1:2},nE=(s,e)=>{let i,o,c;for(;;){if(s.lookahead<fa){if(gp(s),s.lookahead<fa&&e===Nc)return 1;if(s.lookahead===0)break}if(i=0,s.lookahead>=3&&(s.ins_h=Ml(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),s.prev_length=s.match_length,s.prev_match=s.match_start,s.match_length=2,i!==0&&s.prev_length<s.max_lazy_match&&s.strstart-i<=s.w_size-fa&&(s.match_length=$d(s,i),s.match_length<=5&&(s.strategy===Bk||s.match_length===3&&s.strstart-s.match_start>4096)&&(s.match_length=2)),s.prev_length>=3&&s.match_length<=s.prev_length){c=s.strstart+s.lookahead-3,o=Ja(s,s.strstart-1-s.prev_match,s.prev_length-3),s.lookahead-=s.prev_length-1,s.prev_length-=2;do++s.strstart<=c&&(s.ins_h=Ml(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart);while(--s.prev_length!=0);if(s.match_available=0,s.match_length=2,s.strstart++,o&&(Za(s,!1),s.strm.avail_out===0))return 1}else if(s.match_available){if(o=Ja(s,0,s.window[s.strstart-1]),o&&Za(s,!1),s.strstart++,s.lookahead--,s.strm.avail_out===0)return 1}else s.match_available=1,s.strstart++,s.lookahead--}return s.match_available&&(o=Ja(s,0,s.window[s.strstart-1]),s.match_available=0),s.insert=s.strstart<2?s.strstart:2,e===Xa?(Za(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Za(s,!1),s.strm.avail_out===0)?1:2};function Pc(s,e,i,o,c){this.good_length=s,this.max_lazy=e,this.nice_length=i,this.max_chain=o,this.func=c}const Vf=[new Pc(0,0,0,0,Wk),new Pc(4,4,8,4,Gb),new Pc(4,5,16,8,Gb),new Pc(4,6,32,32,Gb),new Pc(4,4,16,16,nE),new Pc(8,16,32,32,nE),new Pc(8,16,128,128,nE),new Pc(8,32,128,256,nE),new Pc(32,128,258,1024,nE),new Pc(32,258,258,4096,nE)];function bj(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Uf,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*Fo),this.dyn_dtree=new Uint16Array(2*(2*eE+1)),this.bl_tree=new Uint16Array(2*(2*Bb+1)),kl(this.dyn_ltree),kl(this.dyn_dtree),kl(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(jk+1),this.heap=new Uint16Array(2*tE+1),kl(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*tE+1),kl(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Ff=s=>{if(!s)return 1;const e=s.state;return!e||e.strm!==s||e.status!==fp&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==Wu&&e.status!==Dc?1:0},Hk=s=>{if(Ff(s))return zs(s,Zd);s.total_in=s.total_out=0,s.data_type=Xi;const e=s.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?fp:Wu,s.adler=e.wrap===2?0:1,e.last_flush=-2,Pl(e),to},Tp=s=>{const e=Hk(s);var i;return e===to&&((i=s.state).window_size=2*i.w_size,kl(i.head),i.max_lazy_match=Vf[i.level].max_lazy,i.good_match=Vf[i.level].good_length,i.nice_match=Vf[i.level].nice_length,i.max_chain_length=Vf[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0),e},Wb=(s,e,i,o,c,u)=>{if(!s)return Zd;let h=1;if(e===Ij&&(e=6),o<0?(h=0,o=-o):o>15&&(h=2,o-=16),c<1||c>9||i!==Uf||o<8||o>15||e<0||e>9||u<0||u>Mf||o===8&&h!==1)return zs(s,Zd);o===8&&(o=9);const _=new bj;return s.state=_,_.strm=s,_.status=fp,_.wrap=h,_.gzhead=null,_.w_bits=o,_.w_size=1<<_.w_bits,_.w_mask=_.w_size-1,_.hash_bits=c+7,_.hash_size=1<<_.hash_bits,_.hash_mask=_.hash_size-1,_.hash_shift=~~((_.hash_bits+3-1)/3),_.window=new Uint8Array(2*_.w_size),_.head=new Uint16Array(_.hash_size),_.prev=new Uint16Array(_.w_size),_.lit_bufsize=1<<c+6,_.pending_buf_size=4*_.lit_bufsize,_.pending_buf=new Uint8Array(_.pending_buf_size),_.sym_buf=_.lit_bufsize,_.sym_end=3*(_.lit_bufsize-1),_.level=e,_.strategy=u,_.method=i,Tp(s)};var wj=(s,e)=>{if(Ff(s)||e>xb||e<0)return s?zs(s,Zd):Zd;const i=s.state;if(!s.output||s.avail_in!==0&&!s.input||i.status===Dc&&e!==Xa)return zs(s,s.avail_out===0?Vb:Zd);const o=i.last_flush;if(i.last_flush=e,i.pending!==0){if(Qa(s),s.avail_out===0)return i.last_flush=-1,to}else if(s.avail_in===0&&Gk(e)<=Gk(o)&&e!==Xa)return zs(s,Vb);if(i.status===Dc&&s.avail_in!==0)return zs(s,Vb);if(i.status===fp&&i.wrap===0&&(i.status=Wu),i.status===fp){let c=Uf+(i.w_bits-8<<4)<<8,u=-1;if(u=i.strategy>=kf||i.level<2?0:i.level<6?1:i.level===6?2:3,c|=u<<6,i.strstart!==0&&(c|=32),c+=31-c%31,xf(i,c),i.strstart!==0&&(xf(i,s.adler>>>16),xf(i,65535&s.adler)),s.adler=1,i.status=Wu,Qa(s),i.pending!==0)return i.last_flush=-1,to}if(i.status===57){if(s.adler=0,yi(i,31),yi(i,139),yi(i,8),i.gzhead)yi(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),yi(i,255&i.gzhead.time),yi(i,i.gzhead.time>>8&255),yi(i,i.gzhead.time>>16&255),yi(i,i.gzhead.time>>24&255),yi(i,i.level===9?2:i.strategy>=kf||i.level<2?4:0),yi(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(yi(i,255&i.gzhead.extra.length),yi(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(s.adler=qr(s.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(yi(i,0),yi(i,0),yi(i,0),yi(i,0),yi(i,0),yi(i,i.level===9?2:i.strategy>=kf||i.level<2?4:0),yi(i,3),i.status=Wu,Qa(s),i.pending!==0)return i.last_flush=-1,to}if(i.status===69){if(i.gzhead.extra){let c=i.pending,u=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+u>i.pending_buf_size;){let _=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+_),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>c&&(s.adler=qr(s.adler,i.pending_buf,i.pending-c,c)),i.gzindex+=_,Qa(s),i.pending!==0)return i.last_flush=-1,to;c=0,u-=_}let h=new Uint8Array(i.gzhead.extra);i.pending_buf.set(h.subarray(i.gzindex,i.gzindex+u),i.pending),i.pending+=u,i.gzhead.hcrc&&i.pending>c&&(s.adler=qr(s.adler,i.pending_buf,i.pending-c,c)),i.gzindex=0}i.status=73}if(i.status===73){if(i.gzhead.name){let c,u=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>u&&(s.adler=qr(s.adler,i.pending_buf,i.pending-u,u)),Qa(s),i.pending!==0)return i.last_flush=-1,to;u=0}c=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,yi(i,c)}while(c!==0);i.gzhead.hcrc&&i.pending>u&&(s.adler=qr(s.adler,i.pending_buf,i.pending-u,u)),i.gzindex=0}i.status=91}if(i.status===91){if(i.gzhead.comment){let c,u=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>u&&(s.adler=qr(s.adler,i.pending_buf,i.pending-u,u)),Qa(s),i.pending!==0)return i.last_flush=-1,to;u=0}c=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,yi(i,c)}while(c!==0);i.gzhead.hcrc&&i.pending>u&&(s.adler=qr(s.adler,i.pending_buf,i.pending-u,u))}i.status=103}if(i.status===103){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(Qa(s),i.pending!==0))return i.last_flush=-1,to;yi(i,255&s.adler),yi(i,s.adler>>8&255),s.adler=0}if(i.status=Wu,Qa(s),i.pending!==0)return i.last_flush=-1,to}if(s.avail_in!==0||i.lookahead!==0||e!==Nc&&i.status!==Dc){let c=i.level===0?Wk(i,e):i.strategy===kf?((u,h)=>{let _;for(;;){if(u.lookahead===0&&(gp(u),u.lookahead===0)){if(h===Nc)return 1;break}if(u.match_length=0,_=Ja(u,0,u.window[u.strstart]),u.lookahead--,u.strstart++,_&&(Za(u,!1),u.strm.avail_out===0))return 1}return u.insert=0,h===Xa?(Za(u,!0),u.strm.avail_out===0?3:4):u.sym_next&&(Za(u,!1),u.strm.avail_out===0)?1:2})(i,e):i.strategy===Fb?((u,h)=>{let _,m,g,S;const C=u.window;for(;;){if(u.lookahead<=Ll){if(gp(u),u.lookahead<=Ll&&h===Nc)return 1;if(u.lookahead===0)break}if(u.match_length=0,u.lookahead>=3&&u.strstart>0&&(g=u.strstart-1,m=C[g],m===C[++g]&&m===C[++g]&&m===C[++g])){S=u.strstart+Ll;do;while(m===C[++g]&&m===C[++g]&&m===C[++g]&&m===C[++g]&&m===C[++g]&&m===C[++g]&&m===C[++g]&&m===C[++g]&&g<S);u.match_length=Ll-(S-g),u.match_length>u.lookahead&&(u.match_length=u.lookahead)}if(u.match_length>=3?(_=Ja(u,1,u.match_length-3),u.lookahead-=u.match_length,u.strstart+=u.match_length,u.match_length=0):(_=Ja(u,0,u.window[u.strstart]),u.lookahead--,u.strstart++),_&&(Za(u,!1),u.strm.avail_out===0))return 1}return u.insert=0,h===Xa?(Za(u,!0),u.strm.avail_out===0?3:4):u.sym_next&&(Za(u,!1),u.strm.avail_out===0)?1:2})(i,e):Vf[i.level].func(i,e);if(c!==3&&c!==4||(i.status=Dc),c===1||c===3)return s.avail_out===0&&(i.last_flush=-1),to;if(c===2&&(e===Vk?Cj(i):e!==xb&&(Mb(i,0,0,!1),e===Ub&&(kl(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),Qa(s),s.avail_out===0))return i.last_flush=-1,to}return e!==Xa?to:i.wrap<=0?Fk:(i.wrap===2?(yi(i,255&s.adler),yi(i,s.adler>>8&255),yi(i,s.adler>>16&255),yi(i,s.adler>>24&255),yi(i,255&s.total_in),yi(i,s.total_in>>8&255),yi(i,s.total_in>>16&255),yi(i,s.total_in>>24&255)):(xf(i,s.adler>>>16),xf(i,65535&s.adler)),Qa(s),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?to:Fk)},Oj=(s,e)=>{let i=e.length;if(Ff(s))return Zd;const o=s.state,c=o.wrap;if(c===2||c===1&&o.status!==fp||o.lookahead)return Zd;if(c===1&&(s.adler=$s(s.adler,e,i,0)),o.wrap=0,i>=o.w_size){c===0&&(kl(o.head),o.strstart=0,o.block_start=0,o.insert=0);let m=new Uint8Array(o.w_size);m.set(e.subarray(i-o.w_size,i),0),e=m,i=o.w_size}const u=s.avail_in,h=s.next_in,_=s.input;for(s.avail_in=i,s.next_in=0,s.input=e,gp(o);o.lookahead>=3;){let m=o.strstart,g=o.lookahead-2;do o.ins_h=Ml(o,o.ins_h,o.window[m+3-1]),o.prev[m&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=m,m++;while(--g);o.strstart=m,o.lookahead=2,gp(o)}return o.strstart+=o.lookahead,o.block_start=o.strstart,o.insert=o.lookahead,o.lookahead=0,o.match_length=o.prev_length=2,o.match_available=0,s.next_in=h,s.input=_,s.avail_in=u,o.wrap=c,to},Bf={deflateInit:(s,e)=>Wb(s,e,Uf,15,8,yj),deflateInit2:Wb,deflateReset:Tp,deflateResetKeep:Hk,deflateSetHeader:(s,e)=>Ff(s)||s.state.wrap!==2?Zd:(s.state.gzhead=e,to),deflate:wj,deflateEnd:s=>{if(Ff(s))return Zd;const e=s.state.status;return s.state=null,e===Wu?zs(s,vj):to},deflateSetDictionary:Oj,deflateInfo:"pako deflate (from Nodeca project)"};const Nj=(s,e)=>Object.prototype.hasOwnProperty.call(s,e);var DR={assign:function(s){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const i=e.shift();if(i){if(typeof i!="object")throw new TypeError(i+"must be non-object");for(const o in i)Nj(i,o)&&(s[o]=i[o])}}return s},flattenChunks:s=>{let e=0;for(let o=0,c=s.length;o<c;o++)e+=s[o].length;const i=new Uint8Array(e);for(let o=0,c=0,u=s.length;o<u;o++){let h=s[o];i.set(h,c),c+=h.length}return i}};let Kk=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Kk=!1}const jf=new Uint8Array(256);for(let s=0;s<256;s++)jf[s]=s>=252?6:s>=248?5:s>=240?4:s>=224?3:s>=192?2:1;jf[254]=jf[254]=1;var Gf={string2buf:s=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(s);let e,i,o,c,u,h=s.length,_=0;for(c=0;c<h;c++)i=s.charCodeAt(c),(64512&i)==55296&&c+1<h&&(o=s.charCodeAt(c+1),(64512&o)==56320&&(i=65536+(i-55296<<10)+(o-56320),c++)),_+=i<128?1:i<2048?2:i<65536?3:4;for(e=new Uint8Array(_),u=0,c=0;u<_;c++)i=s.charCodeAt(c),(64512&i)==55296&&c+1<h&&(o=s.charCodeAt(c+1),(64512&o)==56320&&(i=65536+(i-55296<<10)+(o-56320),c++)),i<128?e[u++]=i:i<2048?(e[u++]=192|i>>>6,e[u++]=128|63&i):i<65536?(e[u++]=224|i>>>12,e[u++]=128|i>>>6&63,e[u++]=128|63&i):(e[u++]=240|i>>>18,e[u++]=128|i>>>12&63,e[u++]=128|i>>>6&63,e[u++]=128|63&i);return e},buf2string:(s,e)=>{const i=e||s.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(s.subarray(0,e));let o,c;const u=new Array(2*i);for(c=0,o=0;o<i;){let h=s[o++];if(h<128){u[c++]=h;continue}let _=jf[h];if(_>4)u[c++]=65533,o+=_-1;else{for(h&=_===2?31:_===3?15:7;_>1&&o<i;)h=h<<6|63&s[o++],_--;_>1?u[c++]=65533:h<65536?u[c++]=h:(h-=65536,u[c++]=55296|h>>10&1023,u[c++]=56320|1023&h)}}return((h,_)=>{if(_<65534&&h.subarray&&Kk)return String.fromCharCode.apply(null,h.length===_?h:h.subarray(0,_));let m="";for(let g=0;g<_;g++)m+=String.fromCharCode(h[g]);return m})(u,c)},utf8border:(s,e)=>{(e=e||s.length)>s.length&&(e=s.length);let i=e-1;for(;i>=0&&(192&s[i])==128;)i--;return i<0||i===0?e:i+jf[s[i]]>e?i:e}},Yk=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const qk=Object.prototype.toString,{Z_NO_FLUSH:Dj,Z_SYNC_FLUSH:zk,Z_FULL_FLUSH:Pj,Z_FINISH:Lj,Z_OK:Wf,Z_STREAM_END:Sp,Z_DEFAULT_COMPRESSION:Hb,Z_DEFAULT_STRATEGY:kj,Z_DEFLATED:Jk}=Gu;function Hf(s){this.options=DR.assign({level:Hb,method:Jk,chunkSize:16384,windowBits:15,memLevel:8,strategy:kj},s||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Yk,this.strm.avail_out=0;let i=Bf.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==Wf)throw new Error(ai[i]);if(e.header&&Bf.deflateSetHeader(this.strm,e.header),e.dictionary){let o;if(o=typeof e.dictionary=="string"?Gf.string2buf(e.dictionary):qk.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,i=Bf.deflateSetDictionary(this.strm,o),i!==Wf)throw new Error(ai[i]);this._dict_set=!0}}function Xk(s,e){const i=new Hf(e);if(i.push(s,!0),i.err)throw i.msg||ai[i.err];return i.result}Hf.prototype.push=function(s,e){const i=this.strm,o=this.options.chunkSize;let c,u;if(this.ended)return!1;for(u=e===~~e?e:e===!0?Lj:Dj,typeof s=="string"?i.input=Gf.string2buf(s):qk.call(s)==="[object ArrayBuffer]"?i.input=new Uint8Array(s):i.input=s,i.next_in=0,i.avail_in=i.input.length;;)if(i.avail_out===0&&(i.output=new Uint8Array(o),i.next_out=0,i.avail_out=o),(u===zk||u===Pj)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(c=Bf.deflate(i,u),c===Sp)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),c=Bf.deflateEnd(this.strm),this.onEnd(c),this.ended=!0,c===Wf;if(i.avail_out!==0){if(u>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(i.avail_in===0)break}else this.onData(i.output)}return!0},Hf.prototype.onData=function(s){this.chunks.push(s)},Hf.prototype.onEnd=function(s){s===Wf&&(this.result=DR.flattenChunks(this.chunks)),this.chunks=[],this.err=s,this.msg=this.strm.msg};var Mj={deflate:Xk};const Hu=16209;var Kb=function(s,e){let i,o,c,u,h,_,m,g,S,C,I,b,x,D,M,K,z,nt,dt,it,at,ht,pt,bt;const kt=s.state;i=s.next_in,pt=s.input,o=i+(s.avail_in-5),c=s.next_out,bt=s.output,u=c-(e-s.avail_out),h=c+(s.avail_out-257),_=kt.dmax,m=kt.wsize,g=kt.whave,S=kt.wnext,C=kt.window,I=kt.hold,b=kt.bits,x=kt.lencode,D=kt.distcode,M=(1<<kt.lenbits)-1,K=(1<<kt.distbits)-1;t:do{b<15&&(I+=pt[i++]<<b,b+=8,I+=pt[i++]<<b,b+=8),z=x[I&M];e:for(;;){if(nt=z>>>24,I>>>=nt,b-=nt,nt=z>>>16&255,nt===0)bt[c++]=65535&z;else{if(!(16&nt)){if((64&nt)==0){z=x[(65535&z)+(I&(1<<nt)-1)];continue e}if(32&nt){kt.mode=16191;break t}s.msg="invalid literal/length code",kt.mode=Hu;break t}dt=65535&z,nt&=15,nt&&(b<nt&&(I+=pt[i++]<<b,b+=8),dt+=I&(1<<nt)-1,I>>>=nt,b-=nt),b<15&&(I+=pt[i++]<<b,b+=8,I+=pt[i++]<<b,b+=8),z=D[I&K];n:for(;;){if(nt=z>>>24,I>>>=nt,b-=nt,nt=z>>>16&255,!(16&nt)){if((64&nt)==0){z=D[(65535&z)+(I&(1<<nt)-1)];continue n}s.msg="invalid distance code",kt.mode=Hu;break t}if(it=65535&z,nt&=15,b<nt&&(I+=pt[i++]<<b,b+=8,b<nt&&(I+=pt[i++]<<b,b+=8)),it+=I&(1<<nt)-1,it>_){s.msg="invalid distance too far back",kt.mode=Hu;break t}if(I>>>=nt,b-=nt,nt=c-u,it>nt){if(nt=it-nt,nt>g&&kt.sane){s.msg="invalid distance too far back",kt.mode=Hu;break t}if(at=0,ht=C,S===0){if(at+=m-nt,nt<dt){dt-=nt;do bt[c++]=C[at++];while(--nt);at=c-it,ht=bt}}else if(S<nt){if(at+=m+S-nt,nt-=S,nt<dt){dt-=nt;do bt[c++]=C[at++];while(--nt);if(at=0,S<dt){nt=S,dt-=nt;do bt[c++]=C[at++];while(--nt);at=c-it,ht=bt}}}else if(at+=S-nt,nt<dt){dt-=nt;do bt[c++]=C[at++];while(--nt);at=c-it,ht=bt}for(;dt>2;)bt[c++]=ht[at++],bt[c++]=ht[at++],bt[c++]=ht[at++],dt-=3;dt&&(bt[c++]=ht[at++],dt>1&&(bt[c++]=ht[at++]))}else{at=c-it;do bt[c++]=bt[at++],bt[c++]=bt[at++],bt[c++]=bt[at++],dt-=3;while(dt>2);dt&&(bt[c++]=bt[at++],dt>1&&(bt[c++]=bt[at++]))}break}}break}}while(i<o&&c<h);dt=b>>3,i-=dt,b-=dt<<3,I&=(1<<b)-1,s.next_in=i,s.next_out=c,s.avail_in=i<o?o-i+5:5-(i-o),s.avail_out=c<h?h-c+257:257-(c-h),kt.hold=I,kt.bits=b};const Kf=15,Qk=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Ul=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Uj=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),xj=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Yf=(s,e,i,o,c,u,h,_)=>{const m=_.bits;let g,S,C,I,b,x,D=0,M=0,K=0,z=0,nt=0,dt=0,it=0,at=0,ht=0,pt=0,bt=null;const kt=new Uint16Array(16),Ne=new Uint16Array(16);let Ge,Qn,Er,jn=null;for(D=0;D<=Kf;D++)kt[D]=0;for(M=0;M<o;M++)kt[e[i+M]]++;for(nt=m,z=Kf;z>=1&&kt[z]===0;z--);if(nt>z&&(nt=z),z===0)return c[u++]=20971520,c[u++]=20971520,_.bits=1,0;for(K=1;K<z&&kt[K]===0;K++);for(nt<K&&(nt=K),at=1,D=1;D<=Kf;D++)if(at<<=1,at-=kt[D],at<0)return-1;if(at>0&&(s===0||z!==1))return-1;for(Ne[1]=0,D=1;D<Kf;D++)Ne[D+1]=Ne[D]+kt[D];for(M=0;M<o;M++)e[i+M]!==0&&(h[Ne[e[i+M]]++]=M);if(s===0?(bt=jn=h,x=20):s===1?(bt=Qk,jn=Ul,x=257):(bt=Uj,jn=xj,x=0),pt=0,M=0,D=K,b=u,dt=nt,it=0,C=-1,ht=1<<nt,I=ht-1,s===1&&ht>852||s===2&&ht>592)return 1;for(;;){Ge=D-it,h[M]+1<x?(Qn=0,Er=h[M]):h[M]>=x?(Qn=jn[h[M]-x],Er=bt[h[M]-x]):(Qn=96,Er=0),g=1<<D-it,S=1<<dt,K=S;do S-=g,c[b+(pt>>it)+S]=Ge<<24|Qn<<16|Er|0;while(S!==0);for(g=1<<D-1;pt&g;)g>>=1;if(g!==0?(pt&=g-1,pt+=g):pt=0,M++,--kt[D]==0){if(D===z)break;D=e[i+h[M]]}if(D>nt&&(pt&I)!==C){for(it===0&&(it=nt),b+=K,dt=D-it,at=1<<dt;dt+it<z&&(at-=kt[dt+it],!(at<=0));)dt++,at<<=1;if(ht+=1<<dt,s===1&&ht>852||s===2&&ht>592)return 1;C=pt&I,c[C]=nt<<24|dt<<16|b-u|0}}return pt!==0&&(c[b+pt]=D-it<<24|64<<16|0),_.bits=nt,0};const{Z_FINISH:Yb,Z_BLOCK:Vj,Z_TREES:PR,Z_OK:Rp,Z_STREAM_END:qb,Z_NEED_DICT:Fj,Z_STREAM_ERROR:ga,Z_DATA_ERROR:zb,Z_MEM_ERROR:$a,Z_BUF_ERROR:LR,Z_DEFLATED:tc}=Gu,kR=16180,iE=16190,Ed=16191,xl=16192,ec=16194,MR=16199,UR=16200,md=16206,jr=16209,Zk=s=>(s>>>24&255)+(s>>>8&65280)+((65280&s)<<8)+((255&s)<<24);function $k(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Vl=s=>{if(!s)return 1;const e=s.state;return!e||e.strm!==s||e.mode<kR||e.mode>16211?1:0},tM=s=>{if(Vl(s))return ga;const e=s.state;return s.total_in=s.total_out=e.total=0,s.msg="",e.wrap&&(s.adler=1&e.wrap),e.mode=kR,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Rp},qf=s=>{if(Vl(s))return ga;const e=s.state;return e.wsize=0,e.whave=0,e.wnext=0,tM(s)},eM=(s,e)=>{let i;if(Vl(s))return ga;const o=s.state;return e<0?(i=0,e=-e):(i=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?ga:(o.window!==null&&o.wbits!==e&&(o.window=null),o.wrap=i,o.wbits=e,qf(s))},nM=(s,e)=>{if(!s)return ga;const i=new $k;s.state=i,i.strm=s,i.window=null,i.mode=kR;const o=eM(s,e);return o!==Rp&&(s.state=null),o};let Cp,zf,Jf=!0;const Bj=s=>{if(Jf){Cp=new Int32Array(512),zf=new Int32Array(32);let e=0;for(;e<144;)s.lens[e++]=8;for(;e<256;)s.lens[e++]=9;for(;e<280;)s.lens[e++]=7;for(;e<288;)s.lens[e++]=8;for(Yf(1,s.lens,0,288,Cp,0,s.work,{bits:9}),e=0;e<32;)s.lens[e++]=5;Yf(2,s.lens,0,32,zf,0,s.work,{bits:5}),Jf=!1}s.lencode=Cp,s.lenbits=9,s.distcode=zf,s.distbits=5},Jb=(s,e,i,o)=>{let c;const u=s.state;return u.window===null&&(u.wsize=1<<u.wbits,u.wnext=0,u.whave=0,u.window=new Uint8Array(u.wsize)),o>=u.wsize?(u.window.set(e.subarray(i-u.wsize,i),0),u.wnext=0,u.whave=u.wsize):(c=u.wsize-u.wnext,c>o&&(c=o),u.window.set(e.subarray(i-o,i-o+c),u.wnext),(o-=c)?(u.window.set(e.subarray(i-o,i),0),u.wnext=o,u.whave=u.wsize):(u.wnext+=c,u.wnext===u.wsize&&(u.wnext=0),u.whave<u.wsize&&(u.whave+=c))),0};var Lc=(s,e)=>{let i,o,c,u,h,_,m,g,S,C,I,b,x,D,M,K,z,nt,dt,it,at,ht,pt=0;const bt=new Uint8Array(4);let kt,Ne;const Ge=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Vl(s)||!s.output||!s.input&&s.avail_in!==0)return ga;i=s.state,i.mode===Ed&&(i.mode=xl),h=s.next_out,c=s.output,m=s.avail_out,u=s.next_in,o=s.input,_=s.avail_in,g=i.hold,S=i.bits,C=_,I=m,ht=Rp;t:for(;;)switch(i.mode){case kR:if(i.wrap===0){i.mode=xl;break}for(;S<16;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(2&i.wrap&&g===35615){i.wbits===0&&(i.wbits=15),i.check=0,bt[0]=255&g,bt[1]=g>>>8&255,i.check=qr(i.check,bt,2,0),g=0,S=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&g)<<8)+(g>>8))%31){s.msg="incorrect header check",i.mode=jr;break}if((15&g)!==tc){s.msg="unknown compression method",i.mode=jr;break}if(g>>>=4,S-=4,at=8+(15&g),i.wbits===0&&(i.wbits=at),at>15||at>i.wbits){s.msg="invalid window size",i.mode=jr;break}i.dmax=1<<i.wbits,i.flags=0,s.adler=i.check=1,i.mode=512&g?16189:Ed,g=0,S=0;break;case 16181:for(;S<16;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(i.flags=g,(255&i.flags)!==tc){s.msg="unknown compression method",i.mode=jr;break}if(57344&i.flags){s.msg="unknown header flags set",i.mode=jr;break}i.head&&(i.head.text=g>>8&1),512&i.flags&&4&i.wrap&&(bt[0]=255&g,bt[1]=g>>>8&255,i.check=qr(i.check,bt,2,0)),g=0,S=0,i.mode=16182;case 16182:for(;S<32;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}i.head&&(i.head.time=g),512&i.flags&&4&i.wrap&&(bt[0]=255&g,bt[1]=g>>>8&255,bt[2]=g>>>16&255,bt[3]=g>>>24&255,i.check=qr(i.check,bt,4,0)),g=0,S=0,i.mode=16183;case 16183:for(;S<16;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}i.head&&(i.head.xflags=255&g,i.head.os=g>>8),512&i.flags&&4&i.wrap&&(bt[0]=255&g,bt[1]=g>>>8&255,i.check=qr(i.check,bt,2,0)),g=0,S=0,i.mode=16184;case 16184:if(1024&i.flags){for(;S<16;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}i.length=g,i.head&&(i.head.extra_len=g),512&i.flags&&4&i.wrap&&(bt[0]=255&g,bt[1]=g>>>8&255,i.check=qr(i.check,bt,2,0)),g=0,S=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&(b=i.length,b>_&&(b=_),b&&(i.head&&(at=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(o.subarray(u,u+b),at)),512&i.flags&&4&i.wrap&&(i.check=qr(i.check,o,b,u)),_-=b,u+=b,i.length-=b),i.length))break t;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(_===0)break t;b=0;do at=o[u+b++],i.head&&at&&i.length<65536&&(i.head.name+=String.fromCharCode(at));while(at&&b<_);if(512&i.flags&&4&i.wrap&&(i.check=qr(i.check,o,b,u)),_-=b,u+=b,at)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(_===0)break t;b=0;do at=o[u+b++],i.head&&at&&i.length<65536&&(i.head.comment+=String.fromCharCode(at));while(at&&b<_);if(512&i.flags&&4&i.wrap&&(i.check=qr(i.check,o,b,u)),_-=b,u+=b,at)break t}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;S<16;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(4&i.wrap&&g!==(65535&i.check)){s.msg="header crc mismatch",i.mode=jr;break}g=0,S=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),s.adler=i.check=0,i.mode=Ed;break;case 16189:for(;S<32;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}s.adler=i.check=Zk(g),g=0,S=0,i.mode=iE;case iE:if(i.havedict===0)return s.next_out=h,s.avail_out=m,s.next_in=u,s.avail_in=_,i.hold=g,i.bits=S,Fj;s.adler=i.check=1,i.mode=Ed;case Ed:if(e===Vj||e===PR)break t;case xl:if(i.last){g>>>=7&S,S-=7&S,i.mode=md;break}for(;S<3;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}switch(i.last=1&g,g>>>=1,S-=1,3&g){case 0:i.mode=16193;break;case 1:if(Bj(i),i.mode=MR,e===PR){g>>>=2,S-=2;break t}break;case 2:i.mode=16196;break;case 3:s.msg="invalid block type",i.mode=jr}g>>>=2,S-=2;break;case 16193:for(g>>>=7&S,S-=7&S;S<32;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if((65535&g)!=(g>>>16^65535)){s.msg="invalid stored block lengths",i.mode=jr;break}if(i.length=65535&g,g=0,S=0,i.mode=ec,e===PR)break t;case ec:i.mode=16195;case 16195:if(b=i.length,b){if(b>_&&(b=_),b>m&&(b=m),b===0)break t;c.set(o.subarray(u,u+b),h),_-=b,u+=b,m-=b,h+=b,i.length-=b;break}i.mode=Ed;break;case 16196:for(;S<14;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(i.nlen=257+(31&g),g>>>=5,S-=5,i.ndist=1+(31&g),g>>>=5,S-=5,i.ncode=4+(15&g),g>>>=4,S-=4,i.nlen>286||i.ndist>30){s.msg="too many length or distance symbols",i.mode=jr;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;S<3;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}i.lens[Ge[i.have++]]=7&g,g>>>=3,S-=3}for(;i.have<19;)i.lens[Ge[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,kt={bits:i.lenbits},ht=Yf(0,i.lens,0,19,i.lencode,0,i.work,kt),i.lenbits=kt.bits,ht){s.msg="invalid code lengths set",i.mode=jr;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;pt=i.lencode[g&(1<<i.lenbits)-1],M=pt>>>24,K=pt>>>16&255,z=65535&pt,!(M<=S);){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(z<16)g>>>=M,S-=M,i.lens[i.have++]=z;else{if(z===16){for(Ne=M+2;S<Ne;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(g>>>=M,S-=M,i.have===0){s.msg="invalid bit length repeat",i.mode=jr;break}at=i.lens[i.have-1],b=3+(3&g),g>>>=2,S-=2}else if(z===17){for(Ne=M+3;S<Ne;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}g>>>=M,S-=M,at=0,b=3+(7&g),g>>>=3,S-=3}else{for(Ne=M+7;S<Ne;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}g>>>=M,S-=M,at=0,b=11+(127&g),g>>>=7,S-=7}if(i.have+b>i.nlen+i.ndist){s.msg="invalid bit length repeat",i.mode=jr;break}for(;b--;)i.lens[i.have++]=at}}if(i.mode===jr)break;if(i.lens[256]===0){s.msg="invalid code -- missing end-of-block",i.mode=jr;break}if(i.lenbits=9,kt={bits:i.lenbits},ht=Yf(1,i.lens,0,i.nlen,i.lencode,0,i.work,kt),i.lenbits=kt.bits,ht){s.msg="invalid literal/lengths set",i.mode=jr;break}if(i.distbits=6,i.distcode=i.distdyn,kt={bits:i.distbits},ht=Yf(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,kt),i.distbits=kt.bits,ht){s.msg="invalid distances set",i.mode=jr;break}if(i.mode=MR,e===PR)break t;case MR:i.mode=UR;case UR:if(_>=6&&m>=258){s.next_out=h,s.avail_out=m,s.next_in=u,s.avail_in=_,i.hold=g,i.bits=S,Kb(s,I),h=s.next_out,c=s.output,m=s.avail_out,u=s.next_in,o=s.input,_=s.avail_in,g=i.hold,S=i.bits,i.mode===Ed&&(i.back=-1);break}for(i.back=0;pt=i.lencode[g&(1<<i.lenbits)-1],M=pt>>>24,K=pt>>>16&255,z=65535&pt,!(M<=S);){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(K&&(240&K)==0){for(nt=M,dt=K,it=z;pt=i.lencode[it+((g&(1<<nt+dt)-1)>>nt)],M=pt>>>24,K=pt>>>16&255,z=65535&pt,!(nt+M<=S);){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}g>>>=nt,S-=nt,i.back+=nt}if(g>>>=M,S-=M,i.back+=M,i.length=z,K===0){i.mode=16205;break}if(32&K){i.back=-1,i.mode=Ed;break}if(64&K){s.msg="invalid literal/length code",i.mode=jr;break}i.extra=15&K,i.mode=16201;case 16201:if(i.extra){for(Ne=i.extra;S<Ne;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}i.length+=g&(1<<i.extra)-1,g>>>=i.extra,S-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;pt=i.distcode[g&(1<<i.distbits)-1],M=pt>>>24,K=pt>>>16&255,z=65535&pt,!(M<=S);){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if((240&K)==0){for(nt=M,dt=K,it=z;pt=i.distcode[it+((g&(1<<nt+dt)-1)>>nt)],M=pt>>>24,K=pt>>>16&255,z=65535&pt,!(nt+M<=S);){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}g>>>=nt,S-=nt,i.back+=nt}if(g>>>=M,S-=M,i.back+=M,64&K){s.msg="invalid distance code",i.mode=jr;break}i.offset=z,i.extra=15&K,i.mode=16203;case 16203:if(i.extra){for(Ne=i.extra;S<Ne;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}i.offset+=g&(1<<i.extra)-1,g>>>=i.extra,S-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){s.msg="invalid distance too far back",i.mode=jr;break}i.mode=16204;case 16204:if(m===0)break t;if(b=I-m,i.offset>b){if(b=i.offset-b,b>i.whave&&i.sane){s.msg="invalid distance too far back",i.mode=jr;break}b>i.wnext?(b-=i.wnext,x=i.wsize-b):x=i.wnext-b,b>i.length&&(b=i.length),D=i.window}else D=c,x=h-i.offset,b=i.length;b>m&&(b=m),m-=b,i.length-=b;do c[h++]=D[x++];while(--b);i.length===0&&(i.mode=UR);break;case 16205:if(m===0)break t;c[h++]=i.length,m--,i.mode=UR;break;case md:if(i.wrap){for(;S<32;){if(_===0)break t;_--,g|=o[u++]<<S,S+=8}if(I-=m,s.total_out+=I,i.total+=I,4&i.wrap&&I&&(s.adler=i.check=i.flags?qr(i.check,c,I,h-I):$s(i.check,c,I,h-I)),I=m,4&i.wrap&&(i.flags?g:Zk(g))!==i.check){s.msg="incorrect data check",i.mode=jr;break}g=0,S=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;S<32;){if(_===0)break t;_--,g+=o[u++]<<S,S+=8}if(4&i.wrap&&g!==(4294967295&i.total)){s.msg="incorrect length check",i.mode=jr;break}g=0,S=0}i.mode=16208;case 16208:ht=qb;break t;case jr:ht=zb;break t;case 16210:return $a;default:return ga}return s.next_out=h,s.avail_out=m,s.next_in=u,s.avail_in=_,i.hold=g,i.bits=S,(i.wsize||I!==s.avail_out&&i.mode<jr&&(i.mode<md||e!==Yb))&&Jb(s,s.output,s.next_out,I-s.avail_out),C-=s.avail_in,I-=s.avail_out,s.total_in+=C,s.total_out+=I,i.total+=I,4&i.wrap&&I&&(s.adler=i.check=i.flags?qr(i.check,c,I,s.next_out-I):$s(i.check,c,I,s.next_out-I)),s.data_type=i.bits+(i.last?64:0)+(i.mode===Ed?128:0)+(i.mode===MR||i.mode===ec?256:0),(C===0&&I===0||e===Yb)&&ht===Rp&&(ht=LR),ht},ks={inflateReset:qf,inflateReset2:eM,inflateResetKeep:tM,inflateInit:s=>nM(s,15),inflateInit2:nM,inflate:Lc,inflateEnd:s=>{if(Vl(s))return ga;let e=s.state;return e.window&&(e.window=null),s.state=null,Rp},inflateGetHeader:(s,e)=>{if(Vl(s))return ga;const i=s.state;return(2&i.wrap)==0?ga:(i.head=e,e.done=!1,Rp)},inflateSetDictionary:(s,e)=>{const i=e.length;let o,c,u;return Vl(s)?ga:(o=s.state,o.wrap!==0&&o.mode!==iE?ga:o.mode===iE&&(c=1,c=$s(c,e,i,0),c!==o.check)?zb:(u=Jb(s,e,i,i),u?(o.mode=16210,$a):(o.havedict=1,Rp)))},inflateInfo:"pako inflate (from Nodeca project)"},Xf=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const iM=Object.prototype.toString,{Z_NO_FLUSH:jj,Z_FINISH:rE,Z_OK:vp,Z_STREAM_END:Xb,Z_NEED_DICT:Qb,Z_STREAM_ERROR:Qf,Z_DATA_ERROR:Zf,Z_MEM_ERROR:Gj}=Gu;function sE(s){this.options=DR.assign({chunkSize:65536,windowBits:15,to:""},s||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||s&&s.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits)==0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Yk,this.strm.avail_out=0;let i=ks.inflateInit2(this.strm,e.windowBits);if(i!==vp)throw new Error(ai[i]);if(this.header=new Xf,ks.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=Gf.string2buf(e.dictionary):iM.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=ks.inflateSetDictionary(this.strm,e.dictionary),i!==vp)))throw new Error(ai[i])}function Ip(s,e){const i=new sE(e);if(i.push(s),i.err)throw i.msg||ai[i.err];return i.result}sE.prototype.push=function(s,e){const i=this.strm,o=this.options.chunkSize,c=this.options.dictionary;let u,h,_;if(this.ended)return!1;for(h=e===~~e?e:e===!0?rE:jj,iM.call(s)==="[object ArrayBuffer]"?i.input=new Uint8Array(s):i.input=s,i.next_in=0,i.avail_in=i.input.length;;){for(i.avail_out===0&&(i.output=new Uint8Array(o),i.next_out=0,i.avail_out=o),u=ks.inflate(i,h),u===Qb&&c&&(u=ks.inflateSetDictionary(i,c),u===vp?u=ks.inflate(i,h):u===Zf&&(u=Qb));i.avail_in>0&&u===Xb&&i.state.wrap>0&&s[i.next_in]!==0;)ks.inflateReset(i),u=ks.inflate(i,h);switch(u){case Qf:case Zf:case Qb:case Gj:return this.onEnd(u),this.ended=!0,!1}if(_=i.avail_out,i.next_out&&(i.avail_out===0||u===Xb))if(this.options.to==="string"){let m=Gf.utf8border(i.output,i.next_out),g=i.next_out-m,S=Gf.buf2string(i.output,m);i.next_out=g,i.avail_out=o-g,g&&i.output.set(i.output.subarray(m,m+g),0),this.onData(S)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(u!==vp||_!==0){if(u===Xb)return u=ks.inflateEnd(this.strm),this.onEnd(u),this.ended=!0,!0;if(i.avail_in===0)break}}return!0},sE.prototype.onData=function(s){this.chunks.push(s)},sE.prototype.onEnd=function(s){s===vp&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=DR.flattenChunks(this.chunks)),this.chunks=[],this.err=s,this.msg=this.strm.msg};var rM={inflate:Ip};const{deflate:sM}=Mj,{inflate:Wj}=rM;var $f,Hj=sM,Kj=Wj;(function(s){s[s.ONE_BYTE=0]="ONE_BYTE",s[s.TWO_BYTE=1]="TWO_BYTE"})($f||($f={}));class Yj{constructor(){A(this,"_sequence",0),A(this,"_startTime",Date.now()),A(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const i={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const _=new Uint8Array(4);_.set([1,0,0,0]);const m={id:0,length:4,data:_.buffer},g={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[m]};i.commonPacketHeader.extension=1,i.extension=g,i.payload=this.compress(e),i.commonPacketHeader.length=8+(i.extension.length+2)+i.payload.byteLength}else i.commonPacketHeader.length=8+i.payload.byteLength;Q("SHOW_DATASTREAM2_LOG")&&O.debug("send data header: ".concat(JSON.stringify(i.commonPacketHeader)));const o=new ArrayBuffer(i.commonPacketHeader.length),c=new Uint8Array(o),u=new DataView(o);let h=0;if(u.setUint16(h,i.commonPacketHeader.extension<<15|i.commonPacketHeader.reserved<<14|i.commonPacketHeader.length,!0),h+=2,u.setUint32(h,i.commonPacketHeader.sequence,!0),h+=4,u.setUint16(h,i.commonStreamHeader,!0),h+=2,i.extension){const _=this.serializeExtension(i.extension);c.set(new Uint8Array(_),h),h+=_.byteLength}if(c.set(new Uint8Array(i.payload),h),h+=i.payload.byteLength,h!==i.commonPacketHeader.length)throw Error("serialize error!");return o}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const i=new DataView(e);let o=0;const c=i.getUint16(o,!0);o+=2;const u={length:16383&c,reserved:(16384&c)>>14,extension:(32768&c)>>15,sequence:i.getUint16(o+2,!0)<<16|i.getUint16(o,!0)};let h,_;if(o+=4,Q("SHOW_DATASTREAM2_LOG")&&O.debug("receive data header: ".concat(JSON.stringify(u))),i.getUint16(o,!0),o+=2,u.extension){_=this.deserializeExtension(e.slice(o)),o+=2+_.length,h=e.slice(o);let m=!1;if(_.datas.length>0){const g=_.datas.find(S=>S.id===0);g&&(m=(1&new DataView(g.data).getUint32(0,!0))==1)}h=m?this.decompress(h):h}else h=e.slice(8);return h}serializeExtension(e){const{profile:i,length:o,datas:c}=e,u=new ArrayBuffer(o+2),h=new Uint8Array(u),_=new DataView(u);let m=0;if(_.setUint8(m++,i),_.setUint8(m++,o),c.forEach(g=>{i?(_.setUint8(m++,g.id),_.setUint8(m++,g.length),h.set(new Uint8Array(g.data),m),m+=g.data.byteLength):(_.setUint8(m++,g.id|g.length<<4),h.set(new Uint8Array(g.data),m),m+=g.data.byteLength)}),m!==o+2)throw Error("serialize extension error, is ".concat(m,"!==").concat(o+2));return u}deserializeExtension(e){const i=new DataView(e);let o=0;const c=i.getUint8(o);o++;const u=i.getUint8(o);o++;const h=c===$f.TWO_BYTE,_=[],m=new DataView(e,2);let g=0;for(;g<u;){let S=0,C=0,I=new ArrayBuffer(0);h?(S=m.getUint8(g),g++,C=m.getUint8(g),g++):(S=15&m.getUint8(g),C=m.getUint8(g)>>4,g++),C>0&&(I=m.buffer.slice(g+2,g+2+C),g+=I.byteLength),_.push({id:S,length:C,data:I})}if(g!==u)throw Error("parse error");return{profile:c,length:u,datas:_}}decompress(e){return Kj(new Uint8Array(e))}compress(e){return Hj(new Uint8Array(e))}}class Zb extends oi{constructor(e,i){super(),A(this,"_version",1),A(this,"_type",3),A(this,"_config",void 0),A(this,"_originDataChannel",void 0),A(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),A(this,"_dataStreamPacketHandler",void 0),A(this,"_datachannelEventMap",new Map),this._config=e,i&&(this._originDataChannel=i,this._bandDataChannelEvents(i)),this._initPacketHeader(),this._dataStreamPacketHandler=new Yj}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return Q("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,i;return(e=(i=this._originDataChannel)===null||i===void 0?void 0:i.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,i;return(e=(i=this._originDataChannel)===null||i===void 0?void 0:i.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new ut((e,i)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();const o=setTimeout(()=>{var c;i(new ft(j.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((c=this._originDataChannel)===null||c===void 0?void 0:c.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(o),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(o),new ft(j.DATACHANNEL_CONNECTION_TIMEOUT)}}else i(new ft(j.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[X_.OPEN,X_.CLOSE,X_.ERROR].forEach(i=>{const o=()=>{this.emit(i)};this._datachannelEventMap.set(i,o),e.addEventListener(i,o)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(i=>{let[o,c]=i;e.removeEventListener(o,c)}),this._datachannelEventMap.clear()}}class qj extends Zb{constructor(e){super(e),A(this,"_messageListener",void 0),this._messageListener=i=>{if(i.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const o=i.data.slice(0,this._dataStreamPacketHeader.byteLength),c=new DataView(o).getUint8(3);if(c!==this.id)return void(Q("SHOW_DATASTREAM2_LOG")&&O.debug("invalid datachannel id: ".concat(c," !== ").concat(this.id)));let u=i.data.slice(this._dataStreamPacketHeader.byteLength);u=this._dataStreamPacketHandler.deserialize(u),this.emit(X_.MESSAGE,u)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class oM extends Zb{send(e){if(this._originDataChannel){let i=e;i=this._dataStreamPacketHandler.serialize(e);const o=new Uint8Array(this._dataStreamPacketHeader.byteLength+i.byteLength);o.set(new Uint8Array(this._dataStreamPacketHeader),0),o.set(new Uint8Array(i),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(o.buffer)}}}var zj=Nt,Jj=ze("iterator"),$b=!zj(function(){var s=new URL("b?a=1&b=2&c=3","http://a"),e=s.searchParams,i=new URLSearchParams("a=1&a=2"),o="";return s.pathname="c%20d",e.forEach(function(c,u){e.delete("b"),o+=u+c}),i.delete("a",2),!s.toJSON||!i.has("a",1)||i.has("a",2)||!e.size&&!0||!e.sort||s.href!=="http://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[Jj]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://тест").host!=="xn--e1aybc"||new URL("http://a#б").hash!=="#%D0%B1"||o!=="a1c3"||new URL("http://x",void 0).host!=="x"}),tg=xd,oE=Ce,yp=Te,eg=Wn,kc=Qt,nc=wr,ng=$b,aE=xd,aM=ul,Xj=function(s,e,i){for(var o in e)i&&i.unsafe&&s[o]?s[o]=e[o]:tg(s,o,e[o],i);return s},tw=ll,cM=k0,ig=n_,ew=Vy,xR=wn,nw=Zn,dM=Do,uM=cl,VR=$i,rg=fr,eo=Es,iw=Iu,FR=No,sg=ms,lM=km,Fl=Vm,cE=nS,tu=ze("iterator"),dE="URLSearchParams",Bl=dE+"Iterator",eu=ig.set,Ta=ig.getterFor(dE),uE=ig.getterFor(Bl),Bo=Object.getOwnPropertyDescriptor,Sa=function(s){if(!nc)return yp[s];var e=Bo(yp,s);return e&&e.value},rw=Sa("fetch"),og=Sa("Request"),ag=Sa("Headers"),sw=og&&og.prototype,hM=ag&&ag.prototype,pM=yp.RegExp,Qj=yp.TypeError,ow=yp.decodeURIComponent,_M=yp.encodeURIComponent,zr=kc("".charAt),nn=kc([].join),jl=kc([].push),BR=kc("".replace),Jr=kc([].shift),Ap=kc([].splice),Xe=kc("".split),Mc=kc("".slice),aw=/\+/g,EM=Array(4),Zj=function(s){return EM[s-1]||(EM[s-1]=pM("((?:%[\\da-f]{2}){"+s+"})","gi"))},$j=function(s){try{return ow(s)}catch{return s}},fd=function(s){var e=BR(s,aw," "),i=4;try{return ow(e)}catch{for(;i;)e=BR(e,Zj(i--),$j);return e}},cw=/[!'()~]|%20/g,jR={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},tG=function(s){return jR[s]},cg=function(s){return BR(_M(s),cw,tG)},Gl=cM(function(s,e){eu(this,{type:Bl,iterator:sg(Ta(s).entries),kind:e})},"Iterator",function(){var s=uE(this),e=s.kind,i=s.iterator.next(),o=i.value;return i.done||(i.value=e==="keys"?o.key:e==="values"?o.value:[o.key,o.value]),i},!0),dw=function(s){this.entries=[],this.url=null,s!==void 0&&(rg(s)?this.parseObject(s):this.parseQuery(typeof s=="string"?zr(s,0)==="?"?Mc(s,1):s:eo(s)))};dw.prototype={type:dE,bindURL:function(s){this.url=s,this.update()},parseObject:function(s){var e,i,o,c,u,h,_,m=lM(s);if(m)for(i=(e=sg(s,m)).next;!(o=eg(i,e)).done;){if(u=(c=sg(VR(o.value))).next,(h=eg(u,c)).done||(_=eg(u,c)).done||!eg(u,c).done)throw Qj("Expected sequence with length 2");jl(this.entries,{key:eo(h.value),value:eo(_.value)})}else for(var g in s)nw(s,g)&&jl(this.entries,{key:g,value:eo(s[g])})},parseQuery:function(s){if(s)for(var e,i,o=Xe(s,"&"),c=0;c<o.length;)(e=o[c++]).length&&(i=Xe(e,"="),jl(this.entries,{key:fd(Jr(i)),value:fd(nn(i,"="))}))},serialize:function(){for(var s,e=this.entries,i=[],o=0;o<e.length;)s=e[o++],jl(i,cg(s.key)+"="+cg(s.value));return nn(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Wt=function(){ew(this,vn);var s=eu(this,new dw(arguments.length>0?arguments[0]:void 0));nc||(this.size=s.entries.length)},vn=Wt.prototype;if(Xj(vn,{append:function(s,e){var i=Ta(this);Fl(arguments.length,2),jl(i.entries,{key:eo(s),value:eo(e)}),nc||this.length++,i.updateURL()},delete:function(s){for(var e=Ta(this),i=Fl(arguments.length,1),o=e.entries,c=eo(s),u=i<2?void 0:arguments[1],h=u===void 0?u:eo(u),_=0;_<o.length;){var m=o[_];if(m.key!==c||h!==void 0&&m.value!==h)_++;else if(Ap(o,_,1),h!==void 0)break}nc||(this.size=o.length),e.updateURL()},get:function(s){var e=Ta(this).entries;Fl(arguments.length,1);for(var i=eo(s),o=0;o<e.length;o++)if(e[o].key===i)return e[o].value;return null},getAll:function(s){var e=Ta(this).entries;Fl(arguments.length,1);for(var i=eo(s),o=[],c=0;c<e.length;c++)e[c].key===i&&jl(o,e[c].value);return o},has:function(s){for(var e=Ta(this).entries,i=Fl(arguments.length,1),o=eo(s),c=i<2?void 0:arguments[1],u=c===void 0?c:eo(c),h=0;h<e.length;){var _=e[h++];if(_.key===o&&(u===void 0||_.value===u))return!0}return!1},set:function(s,e){var i=Ta(this);Fl(arguments.length,1);for(var o,c=i.entries,u=!1,h=eo(s),_=eo(e),m=0;m<c.length;m++)(o=c[m]).key===h&&(u?Ap(c,m--,1):(u=!0,o.value=_));u||jl(c,{key:h,value:_}),nc||(this.size=c.length),i.updateURL()},sort:function(){var s=Ta(this);cE(s.entries,function(e,i){return e.key>i.key?1:-1}),s.updateURL()},forEach:function(s){for(var e,i=Ta(this).entries,o=dM(s,arguments.length>1?arguments[1]:void 0),c=0;c<i.length;)o((e=i[c++]).value,e.key,this)},keys:function(){return new Gl(this,"keys")},values:function(){return new Gl(this,"values")},entries:function(){return new Gl(this,"entries")}},{enumerable:!0}),aE(vn,tu,vn.entries,{}),aE(vn,"toString",function(){return Ta(this).serialize()},{enumerable:!0}),nc&&aM(vn,"size",{get:function(){return Ta(this).entries.length},configurable:!0,enumerable:!0}),tw(Wt,dE),oE({global:!0,forced:!ng},{URLSearchParams:Wt}),!ng&&xR(ag)){var lE=kc(hM.has),eG=kc(hM.set),mM=function(s){if(rg(s)){var e,i=s.body;if(uM(i)===dE)return e=s.headers?new ag(s.headers):new ag,lE(e,"content-type")||eG(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),iw(s,{body:FR(0,eo(i)),headers:FR(0,e)})}return s};if(xR(rw)&&oE({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(s){return rw(s,arguments.length>1?mM(arguments[1]):{})}}),xR(og)){var Ku=function(s){return ew(this,sw),new og(s,arguments.length>1?mM(arguments[1]):{})};sw.constructor=Ku,Ku.prototype=sw,oE({global:!0,dontCallGetSet:!0,forced:!0},{Request:Ku})}}var no,hE={URLSearchParams:Wt,getState:Ta},bp=wr,Ra=Qt,uw=Wn,lw=Nt,GR=vh,nG=mm,fM=Eh,Js=Ns,Ca=fh,nu=Object.assign,Wl=Object.defineProperty,Ms=Ra([].concat),iu=!nu||lw(function(){if(bp&&nu({b:1},nu(Wl({},"a",{enumerable:!0,get:function(){Wl(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var s={},e={},i=Symbol(),o="abcdefghijklmnopqrst";return s[i]=7,o.split("").forEach(function(c){e[c]=c}),nu({},s)[i]!=7||GR(nu({},e)).join("")!=o})?function(s,e){for(var i=Js(s),o=arguments.length,c=1,u=nG.f,h=fM.f;o>c;)for(var _,m=Ca(arguments[c++]),g=u?Ms(GR(m),u(m)):GR(m),S=g.length,C=0;S>C;)_=g[C++],bp&&!uw(h,m,_)||(i[_]=m[_]);return i}:nu,hw=$i,WR=HD,$e=Do,gt=Wn,gM=Ns,_i=function(s,e,i,o){try{return o?e(hw(i)[0],i[1]):e(i)}catch(c){WR(s,"throw",c)}},TM=jD,pE=$v,SM=Cu,jo=Jv,Dn=ms,_E=km,Hl=Array,Yu=Qt,dg=2147483647,RM=/[^\0-\u007E]/,pw=/[.\u3002\uFF0E\uFF61]/g,_w="Overflow: input needs wider integers to process",Ew=RangeError,iG=Yu(pw.exec),wp=Math.floor,ug=String.fromCharCode,mw=Yu("".charCodeAt),fw=Yu([].join),vs=Yu([].push),rG=Yu("".replace),HR=Yu("".split),EE=Yu("".toLowerCase),Go=function(s){return s+22+75*(s<26)},gw=function(s,e,i){var o=0;for(s=i?wp(s/700):s>>1,s+=wp(s/e);s>455;)s=wp(s/35),o+=36;return wp(o+36*s/(s+38))},va=function(s){var e=[];s=function(K){for(var z=[],nt=0,dt=K.length;nt<dt;){var it=mw(K,nt++);if(it>=55296&&it<=56319&&nt<dt){var at=mw(K,nt++);(64512&at)==56320?vs(z,((1023&it)<<10)+(1023&at)+65536):(vs(z,it),nt--)}else vs(z,it)}return z}(s);var i,o,c=s.length,u=128,h=0,_=72;for(i=0;i<s.length;i++)(o=s[i])<128&&vs(e,ug(o));var m=e.length,g=m;for(m&&vs(e,"-");g<c;){var S=dg;for(i=0;i<s.length;i++)(o=s[i])>=u&&o<S&&(S=o);var C=g+1;if(S-u>wp((dg-h)/C))throw Ew(_w);for(h+=(S-u)*C,u=S,i=0;i<s.length;i++){if((o=s[i])<u&&++h>dg)throw Ew(_w);if(o==u){for(var I=h,b=36;;){var x=b<=_?1:b>=_+26?26:b-_;if(I<x)break;var D=I-x,M=36-x;vs(e,ug(Go(x+D%M))),I=wp(D/M),b+=36}vs(e,ug(Go(I))),_=gw(h,C,g==m),h=0,g++}}h++,u++}return fw(e,"")},CM=Ce,KR=wr,sG=$b,Us=Te,Bi=Do,ic=Qt,lg=xd,rc=ul,vM=Vy,hg=Zn,Tw=iu,Op=function(s){var e=gM(s),i=pE(this),o=arguments.length,c=o>1?arguments[1]:void 0,u=c!==void 0;u&&(c=$e(c,o>2?arguments[2]:void 0));var h,_,m,g,S,C,I=_E(e),b=0;if(!I||this===Hl&&TM(I))for(h=SM(e),_=i?new this(h):Hl(h);h>b;b++)C=u?c(e[b],b):e[b],jo(_,b,C);else for(S=(g=Dn(e,I)).next,_=i?new this:[];!(m=gt(S,g)).done;b++)C=u?_i(g,c,[m.value,b],!0):m.value,jo(_,b,C);return _.length=b,_},Ia=lI,IM=eD.codeAt,yM=function(s){var e,i,o=[],c=HR(rG(EE(s),pw,"."),".");for(e=0;e<c.length;e++)i=c[e],vs(o,iG(RM,i)?"xn--"+va(i):i);return fw(o,".")},qu=Es,AM=ll,Sw=Vm,Rw=hE,Cw=n_,bM=Cw.set,pg=Cw.getterFor("URL"),wM=Rw.URLSearchParams,OM=Rw.getState,mE=Us.URL,YR=Us.TypeError,_g=Us.parseInt,NM=Math.floor,vw=Math.pow,sc=ic("".charAt),Uc=ic(/./.exec),fE=ic([].join),DM=ic(1 .toString),PM=ic([].pop),Np=ic([].push),qR=ic("".replace),LM=ic([].shift),Ri=ic("".split),gE=ic("".slice),Eg=ic("".toLowerCase),kM=ic([].unshift),zR="Invalid scheme",Kl="Invalid host",Iw="Invalid port",gd=/[a-z]/i,MM=/[\d+-.a-z]/i,JR=/\d/,UM=/^0x/i,xM=/^[0-7]+$/,VM=/^\d+$/,yw=/^[\da-f]+$/i,FM=/[\0\t\n\r #%/:<>?@[\\\]^|]/,BM=/[\0\t\n\r #/:<>?@[\\\]^|]/,jM=/^[\u0000-\u0020]+/,GM=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,WM=/[\t\n\r]/g,TE=function(s){var e,i,o,c;if(typeof s=="number"){for(e=[],i=0;i<4;i++)kM(e,s%256),s=NM(s/256);return fE(e,".")}if(typeof s=="object"){for(e="",o=function(u){for(var h=null,_=1,m=null,g=0,S=0;S<8;S++)u[S]!==0?(g>_&&(h=m,_=g),m=null,g=0):(m===null&&(m=S),++g);return g>_&&(h=m,_=g),h}(s),i=0;i<8;i++)c&&s[i]===0||(c&&(c=!1),o===i?(e+=i?":":"::",c=!0):(e+=DM(s[i],16),i<7&&(e+=":")));return"["+e+"]"}return s},mg={},Xr=Tw({},mg,{" ":1,'"':1,"<":1,">":1,"`":1}),Ai=Tw({},Xr,{"#":1,"?":1,"{":1,"}":1}),SE=Tw({},Ai,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Yl=function(s,e){var i=IM(s,0);return i>32&&i<127&&!hg(e,s)?s:encodeURIComponent(s)},Hi={ftp:21,file:null,http:80,https:443,ws:80,wss:443},fg=function(s,e){var i;return s.length==2&&Uc(gd,sc(s,0))&&((i=sc(s,1))==":"||!e&&i=="|")},Aw=function(s){var e;return s.length>1&&fg(gE(s,0,2))&&(s.length==2||(e=sc(s,2))==="/"||e==="\\"||e==="?"||e==="#")},bw=function(s){return s==="."||Eg(s)==="%2e"},XR={},ww={},QR={},Ow={},Nw={},ZR={},Dw={},Pw={},gg={},Tg={},$R={},tC={},eC={},nC={},Lw={},iC={},Dp={},Td={},kw={},ql={},ru={},rC=function(s,e,i){var o,c,u,h=qu(s);if(e){if(c=this.parse(h))throw YR(c);this.searchParams=null}else{if(i!==void 0&&(o=new rC(i,!0)),c=this.parse(h,null,o))throw YR(c);(u=OM(new wM)).bindURL(this),this.searchParams=u}};rC.prototype={type:"URL",parse:function(s,e,i){var o,c,u,h,_,m=this,g=e||XR,S=0,C="",I=!1,b=!1,x=!1;for(s=qu(s),e||(m.scheme="",m.username="",m.password="",m.host=null,m.port=null,m.path=[],m.query=null,m.fragment=null,m.cannotBeABaseURL=!1,s=qR(s,jM,""),s=qR(s,GM,"$1")),s=qR(s,WM,""),o=Op(s);S<=o.length;){switch(c=o[S],g){case XR:if(!c||!Uc(gd,c)){if(e)return zR;g=QR;continue}C+=Eg(c),g=ww;break;case ww:if(c&&(Uc(MM,c)||c=="+"||c=="-"||c=="."))C+=Eg(c);else{if(c!=":"){if(e)return zR;C="",g=QR,S=0;continue}if(e&&(m.isSpecial()!=hg(Hi,C)||C=="file"&&(m.includesCredentials()||m.port!==null)||m.scheme=="file"&&!m.host))return;if(m.scheme=C,e)return void(m.isSpecial()&&Hi[m.scheme]==m.port&&(m.port=null));C="",m.scheme=="file"?g=nC:m.isSpecial()&&i&&i.scheme==m.scheme?g=Ow:m.isSpecial()?g=Pw:o[S+1]=="/"?(g=Nw,S++):(m.cannotBeABaseURL=!0,Np(m.path,""),g=kw)}break;case QR:if(!i||i.cannotBeABaseURL&&c!="#")return zR;if(i.cannotBeABaseURL&&c=="#"){m.scheme=i.scheme,m.path=Ia(i.path),m.query=i.query,m.fragment="",m.cannotBeABaseURL=!0,g=ru;break}g=i.scheme=="file"?nC:ZR;continue;case Ow:if(c!="/"||o[S+1]!="/"){g=ZR;continue}g=gg,S++;break;case Nw:if(c=="/"){g=Tg;break}g=Td;continue;case ZR:if(m.scheme=i.scheme,c==no)m.username=i.username,m.password=i.password,m.host=i.host,m.port=i.port,m.path=Ia(i.path),m.query=i.query;else if(c=="/"||c=="\\"&&m.isSpecial())g=Dw;else if(c=="?")m.username=i.username,m.password=i.password,m.host=i.host,m.port=i.port,m.path=Ia(i.path),m.query="",g=ql;else{if(c!="#"){m.username=i.username,m.password=i.password,m.host=i.host,m.port=i.port,m.path=Ia(i.path),m.path.length--,g=Td;continue}m.username=i.username,m.password=i.password,m.host=i.host,m.port=i.port,m.path=Ia(i.path),m.query=i.query,m.fragment="",g=ru}break;case Dw:if(!m.isSpecial()||c!="/"&&c!="\\"){if(c!="/"){m.username=i.username,m.password=i.password,m.host=i.host,m.port=i.port,g=Td;continue}g=Tg}else g=gg;break;case Pw:if(g=gg,c!="/"||sc(C,S+1)!="/")continue;S++;break;case gg:if(c!="/"&&c!="\\"){g=Tg;continue}break;case Tg:if(c=="@"){I&&(C="%40"+C),I=!0,u=Op(C);for(var D=0;D<u.length;D++){var M=u[D];if(M!=":"||x){var K=Yl(M,SE);x?m.password+=K:m.username+=K}else x=!0}C=""}else if(c==no||c=="/"||c=="?"||c=="#"||c=="\\"&&m.isSpecial()){if(I&&C=="")return"Invalid authority";S-=Op(C).length+1,C="",g=$R}else C+=c;break;case $R:case tC:if(e&&m.scheme=="file"){g=iC;continue}if(c!=":"||b){if(c==no||c=="/"||c=="?"||c=="#"||c=="\\"&&m.isSpecial()){if(m.isSpecial()&&C=="")return Kl;if(e&&C==""&&(m.includesCredentials()||m.port!==null))return;if(h=m.parseHost(C))return h;if(C="",g=Dp,e)return;continue}c=="["?b=!0:c=="]"&&(b=!1),C+=c}else{if(C=="")return Kl;if(h=m.parseHost(C))return h;if(C="",g=eC,e==tC)return}break;case eC:if(!Uc(JR,c)){if(c==no||c=="/"||c=="?"||c=="#"||c=="\\"&&m.isSpecial()||e){if(C!=""){var z=_g(C,10);if(z>65535)return Iw;m.port=m.isSpecial()&&z===Hi[m.scheme]?null:z,C=""}if(e)return;g=Dp;continue}return Iw}C+=c;break;case nC:if(m.scheme="file",c=="/"||c=="\\")g=Lw;else{if(!i||i.scheme!="file"){g=Td;continue}if(c==no)m.host=i.host,m.path=Ia(i.path),m.query=i.query;else if(c=="?")m.host=i.host,m.path=Ia(i.path),m.query="",g=ql;else{if(c!="#"){Aw(fE(Ia(o,S),""))||(m.host=i.host,m.path=Ia(i.path),m.shortenPath()),g=Td;continue}m.host=i.host,m.path=Ia(i.path),m.query=i.query,m.fragment="",g=ru}}break;case Lw:if(c=="/"||c=="\\"){g=iC;break}i&&i.scheme=="file"&&!Aw(fE(Ia(o,S),""))&&(fg(i.path[0],!0)?Np(m.path,i.path[0]):m.host=i.host),g=Td;continue;case iC:if(c==no||c=="/"||c=="\\"||c=="?"||c=="#"){if(!e&&fg(C))g=Td;else if(C==""){if(m.host="",e)return;g=Dp}else{if(h=m.parseHost(C))return h;if(m.host=="localhost"&&(m.host=""),e)return;C="",g=Dp}continue}C+=c;break;case Dp:if(m.isSpecial()){if(g=Td,c!="/"&&c!="\\")continue}else if(e||c!="?")if(e||c!="#"){if(c!=no&&(g=Td,c!="/"))continue}else m.fragment="",g=ru;else m.query="",g=ql;break;case Td:if(c==no||c=="/"||c=="\\"&&m.isSpecial()||!e&&(c=="?"||c=="#")){if((_=Eg(_=C))===".."||_==="%2e."||_===".%2e"||_==="%2e%2e"?(m.shortenPath(),c=="/"||c=="\\"&&m.isSpecial()||Np(m.path,"")):bw(C)?c=="/"||c=="\\"&&m.isSpecial()||Np(m.path,""):(m.scheme=="file"&&!m.path.length&&fg(C)&&(m.host&&(m.host=""),C=sc(C,0)+":"),Np(m.path,C)),C="",m.scheme=="file"&&(c==no||c=="?"||c=="#"))for(;m.path.length>1&&m.path[0]==="";)LM(m.path);c=="?"?(m.query="",g=ql):c=="#"&&(m.fragment="",g=ru)}else C+=Yl(c,Ai);break;case kw:c=="?"?(m.query="",g=ql):c=="#"?(m.fragment="",g=ru):c!=no&&(m.path[0]+=Yl(c,mg));break;case ql:e||c!="#"?c!=no&&(c=="'"&&m.isSpecial()?m.query+="%27":m.query+=c=="#"?"%23":Yl(c,mg)):(m.fragment="",g=ru);break;case ru:c!=no&&(m.fragment+=Yl(c,Xr))}S++}},parseHost:function(s){var e,i,o;if(sc(s,0)=="["){if(sc(s,s.length-1)!="]"||(e=function(c){var u,h,_,m,g,S,C,I=[0,0,0,0,0,0,0,0],b=0,x=null,D=0,M=function(){return sc(c,D)};if(M()==":"){if(sc(c,1)!=":")return;D+=2,x=++b}for(;M();){if(b==8)return;if(M()!=":"){for(u=h=0;h<4&&Uc(yw,M());)u=16*u+_g(M(),16),D++,h++;if(M()=="."){if(h==0||(D-=h,b>6))return;for(_=0;M();){if(m=null,_>0){if(!(M()=="."&&_<4))return;D++}if(!Uc(JR,M()))return;for(;Uc(JR,M());){if(g=_g(M(),10),m===null)m=g;else{if(m==0)return;m=10*m+g}if(m>255)return;D++}I[b]=256*I[b]+m,++_!=2&&_!=4||b++}if(_!=4)return;break}if(M()==":"){if(D++,!M())return}else if(M())return;I[b++]=u}else{if(x!==null)return;D++,x=++b}}if(x!==null)for(S=b-x,b=7;b!=0&&S>0;)C=I[b],I[b--]=I[x+S-1],I[x+--S]=C;else if(b!=8)return;return I}(gE(s,1,-1)),!e))return Kl;this.host=e}else if(this.isSpecial()){if(s=yM(s),Uc(FM,s)||(e=function(c){var u,h,_,m,g,S,C,I=Ri(c,".");if(I.length&&I[I.length-1]==""&&I.length--,(u=I.length)>4)return c;for(h=[],_=0;_<u;_++){if((m=I[_])=="")return c;if(g=10,m.length>1&&sc(m,0)=="0"&&(g=Uc(UM,m)?16:8,m=gE(m,g==8?1:2)),m==="")S=0;else{if(!Uc(g==10?VM:g==8?xM:yw,m))return c;S=_g(m,g)}Np(h,S)}for(_=0;_<u;_++)if(S=h[_],_==u-1){if(S>=vw(256,5-u))return null}else if(S>255)return null;for(C=PM(h),_=0;_<h.length;_++)C+=h[_]*vw(256,3-_);return C}(s),e===null))return Kl;this.host=e}else{if(Uc(BM,s))return Kl;for(e="",i=Op(s),o=0;o<i.length;o++)e+=Yl(i[o],mg);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return hg(Hi,this.scheme)},shortenPath:function(){var s=this.path,e=s.length;!e||this.scheme=="file"&&e==1&&fg(s[0],!0)||s.length--},serialize:function(){var s=this,e=s.scheme,i=s.username,o=s.password,c=s.host,u=s.port,h=s.path,_=s.query,m=s.fragment,g=e+":";return c!==null?(g+="//",s.includesCredentials()&&(g+=i+(o?":"+o:"")+"@"),g+=TE(c),u!==null&&(g+=":"+u)):e=="file"&&(g+="//"),g+=s.cannotBeABaseURL?h[0]:h.length?"/"+fE(h,"/"):"",_!==null&&(g+="?"+_),m!==null&&(g+="#"+m),g},setHref:function(s){var e=this.parse(s);if(e)throw YR(e);this.searchParams.update()},getOrigin:function(){var s=this.scheme,e=this.port;if(s=="blob")try{return new Pp(s.path[0]).origin}catch{return"null"}return s!="file"&&this.isSpecial()?s+"://"+TE(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(s){this.parse(qu(s)+":",XR)},getUsername:function(){return this.username},setUsername:function(s){var e=Op(qu(s));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<e.length;i++)this.username+=Yl(e[i],SE)}},getPassword:function(){return this.password},setPassword:function(s){var e=Op(qu(s));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<e.length;i++)this.password+=Yl(e[i],SE)}},getHost:function(){var s=this.host,e=this.port;return s===null?"":e===null?TE(s):TE(s)+":"+e},setHost:function(s){this.cannotBeABaseURL||this.parse(s,$R)},getHostname:function(){var s=this.host;return s===null?"":TE(s)},setHostname:function(s){this.cannotBeABaseURL||this.parse(s,tC)},getPort:function(){var s=this.port;return s===null?"":qu(s)},setPort:function(s){this.cannotHaveUsernamePasswordPort()||((s=qu(s))==""?this.port=null:this.parse(s,eC))},getPathname:function(){var s=this.path;return this.cannotBeABaseURL?s[0]:s.length?"/"+fE(s,"/"):""},setPathname:function(s){this.cannotBeABaseURL||(this.path=[],this.parse(s,Dp))},getSearch:function(){var s=this.query;return s?"?"+s:""},setSearch:function(s){(s=qu(s))==""?this.query=null:(sc(s,0)=="?"&&(s=gE(s,1)),this.query="",this.parse(s,ql)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var s=this.fragment;return s?"#"+s:""},setHash:function(s){(s=qu(s))!=""?(sc(s,0)=="#"&&(s=gE(s,1)),this.fragment="",this.parse(s,ru)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Pp=function(s){var e=vM(this,To),i=Sw(arguments.length,1)>1?arguments[1]:void 0,o=bM(e,new rC(s,!1,i));KR||(e.href=o.serialize(),e.origin=o.getOrigin(),e.protocol=o.getProtocol(),e.username=o.getUsername(),e.password=o.getPassword(),e.host=o.getHost(),e.hostname=o.getHostname(),e.port=o.getPort(),e.pathname=o.getPathname(),e.search=o.getSearch(),e.searchParams=o.getSearchParams(),e.hash=o.getHash())},To=Pp.prototype,oc=function(s,e){return{get:function(){return pg(this)[s]()},set:e&&function(i){return pg(this)[e](i)},configurable:!0,enumerable:!0}};if(KR&&(rc(To,"href",oc("serialize","setHref")),rc(To,"origin",oc("getOrigin")),rc(To,"protocol",oc("getProtocol","setProtocol")),rc(To,"username",oc("getUsername","setUsername")),rc(To,"password",oc("getPassword","setPassword")),rc(To,"host",oc("getHost","setHost")),rc(To,"hostname",oc("getHostname","setHostname")),rc(To,"port",oc("getPort","setPort")),rc(To,"pathname",oc("getPathname","setPathname")),rc(To,"search",oc("getSearch","setSearch")),rc(To,"searchParams",oc("getSearchParams")),rc(To,"hash",oc("getHash","setHash"))),lg(To,"toJSON",function(){return pg(this).serialize()},{enumerable:!0}),lg(To,"toString",function(){return pg(this).serialize()},{enumerable:!0}),mE){var Mw=mE.createObjectURL,Je=mE.revokeObjectURL;Mw&&lg(Pp,"createObjectURL",Bi(Mw,mE)),Je&&lg(Pp,"revokeObjectURL",Bi(Je,mE))}AM(Pp,"URL"),CM({global:!0,forced:!sG,sham:!KR},{URL:Pp});var HM=Ce,KM=Nt,YM=Vm,Uw=Es,qM=$b,xw=qi("URL");HM({target:"URL",stat:!0,forced:!(qM&&KM(function(){xw.canParse()}))},{canParse:function(s){var e=YM(arguments.length,1),i=Uw(s),o=e<2||arguments[1]===void 0?void 0:Uw(arguments[1]);try{return!!new xw(i,o)}catch{return!1}}});var Vw=Rt($r.URL);function Sg(){const s=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>Vw.revokeObjectURL(s),0),new Worker(Vw.createObjectURL(s))}const io=new Map,qn=new Map;async function Fw(s){if(!sn().supportWebRTCEncodedTransform)return void O.warning("browser not support audio encoded transform");if(qn.has(s))return;const e={track:s.track};if(Nu()){if(!s.createEncodedStreams)return void O.warning("browser not support createEncodedStreams() API");let o=null;try{o=s.createEncodedStreams()}catch(u){return void O.error("create audio-encoded-streams error",u&&u.message)}const c=new TransformStream({transform(u,h){e.controller||(e.controller=h),s.track&&s.track.id!==e.track.id&&(O.debug("audio track changed: ".concat(e.track.id," => ").concat(s.track.id)),e.track.removeEventListener("ended",i),e.track=s.track,e.track.addEventListener("ended",i)),h.enqueue(u)}});o.readable.pipeThrough(c).pipeTo(o.writable)}else if(Or()){if(typeof RTCRtpScriptTransform>"u")return void O.warning("browser not support RTCRtpScriptTransform");const o=Sg(),c=new MessageChannel;await new ut(h=>o.onmessage=_=>{_.data==="registered"&&h(void 0)});const u=new RTCRtpScriptTransform(o,{name:"rx",port:c.port2},[c.port2]);s.transform=u,await new ut(h=>o.onmessage=_=>{_.data==="started"&&h(void 0)}),c.port1.onmessage=h=>{var _;h.data.transformed&&s.track&&((_=s.track)===null||_===void 0?void 0:_.id)!==e.track.id&&(O.debug("audio track changed: ".concat(e.track.id," => ").concat(s.track.id)),e.track.removeEventListener("ended",i),e.track=s.track,e.track.addEventListener("ended",i))},e.worker=o}function i(){s.track.removeEventListener("ended",i),function(o){const c=qn.get(o);if(c){qn.delete(o);try{var u,h;(u=c.controller)===null||u===void 0||u.terminate(),(h=c.worker)===null||h===void 0||h.terminate()}catch(_){O.warning(_&&_.message)}}}(s)}qn.set(s,e),s.track.addEventListener("ended",i)}function Bw(s){const e=new DataView(s.data);if(e.getUint8(0)===0&&e.getUint8(1)===0&&e.getUint8(2)===0&&e.getUint8(3)===1&&e.getUint8(4)===6){let i=6,o=0,c=0;for(;(c=e.getUint8(i++))===255;)o+=255;o+=c;const u=function(h,_,m){let g=new Uint8Array(h,_,m),S=[],C=0;for(;C<m;)C+3<m&&g[C]===0&&g[C+1]===0&&g[C+2]===3&&(g[C+3]===0||g[C+3]===1||g[C+3]===2||g[C+3]===3)?(S.push(g[C],g[C+1],g[C+3]),C+=4):(S.push(g[C]),C++);return new Uint8Array(S)}(s.data,i,o);return new Uint8Array(u)}return null}function zM(s,e){const i=function(m){const g=m.length;let S=[],C=0;for(;C<g;)C+2<g&&m[C]===0&&m[C+1]===0&&(m[C+2]===0||m[C+2]===1||m[C+2]===2||m[C+2]===3)?(S.push(m[C],m[C+1],3,m[C+2]),C+=3):(S.push(m[C]),C++);return new Uint8Array(S)}(e),o=i.length,c=Math.floor(o/255),u=o%255,h=new Uint8Array(6+c+1+o+s.byteLength);h[0]=0,h[1]=0,h[2]=0,h[3]=1,h[4]=6,h[5]=101;let _=0;for(;_<c;)h[6+_]=255,_++;return h[6+_]=u,_++,h.set(i,6+_),h.set(new Uint8Array(s),6+_+o),h.buffer}const Rg=new Map,RE=new Map;async function JM(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!sn().supportWebRTCEncodedTransform)return void O.warning("browser not support video encoded transform");if(!s.track)return;if(RE.has(s)){const c=RE.get(s);return void(c&&(c.onSei=e.onSei))}const i={track:s.track,onSei:e.onSei};if(Nu()){if(!s.createEncodedStreams)return void O.warning("browser not support createEncodedStreams() API");let c=null;try{c=s.createEncodedStreams()}catch(h){return void O.error("create video-encoded-streams error",h&&h.message)}const u=new TransformStream({transform(h,_){i.controller||(i.controller=_),s.track&&s.track.id!==i.track.id&&(O.debug("video track changed: ".concat(i.track.id," => ").concat(s.track.id)),i.track.removeEventListener("ended",o),i.track=s.track,i.track.addEventListener("ended",o));const m=Bw(h);m&&i.onSei&&i.onSei(m),_.enqueue(h)}});c.readable.pipeThrough(u).pipeTo(c.writable)}else if(Or()){if(typeof RTCRtpScriptTransform>"u")return void O.warning("browser not support RTCRtpScriptTransform");const c=Sg(),u=new MessageChannel;await new ut(_=>c.onmessage=m=>{m.data==="registered"&&_(void 0)});const h=new RTCRtpScriptTransform(c,{name:"rx",port:u.port2},[u.port2]);s.transform=h,await new ut(_=>c.onmessage=m=>{m.data==="started"&&_(void 0)}),u.port1.onmessage=_=>{var m;_.data.transformed&&s.track&&((m=s.track)===null||m===void 0?void 0:m.id)!==i.track.id?(O.debug("video track changed: ".concat(i.track.id," => ").concat(s.track.id)),i.track.removeEventListener("ended",o),i.track=s.track,i.track.addEventListener("ended",o)):_.data.sei&&i.onSei&&i.onSei(_.data.sei)},i.worker=c}function o(){if(s.track){if(this.id!==s.track.id)return;s.track.removeEventListener("ended",o)}(function(c){const u=RE.get(c);if(u){RE.delete(c);try{var h,_;(h=u.controller)===null||h===void 0||h.terminate(),(_=u.worker)===null||_===void 0||_.terminate()}catch(m){O.warning(m&&m.message)}}})(s)}RE.set(s,i),s.track.addEventListener("ended",o)}(function(){const s=ln();ss.getDisplayMedia=function(e){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),ss.getStreamFromExtension=s.name===un.CHROME&&Number(s.version)>34,ss.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let i=!1;try{e.addTransceiver("audio"),i=!0}catch{}return e.close(),i}(),ss.supportMinBitrate=s.name===un.CHROME||s.name===un.EDGE,ss.supportSetRtpSenderParameters=function(){const e=ln();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!Du()||!(!Or()&&!DS())||e.name===un.FIREFOX&&Number(e.version)>=64}(),s.name===un.SAFARI&&(Number(s.version)>=14?ss.supportDualStream=!0:ss.supportDualStream=!1),ss.webAudioMediaStreamDest=function(){const e=ln();return!(e.name===un.SAFARI&&Number(e.version)<12)}(),ss.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),ss.supportWebGL=typeof WebGLRenderingContext<"u",ss.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Du()||(ss.webAudioWithAEC=!0),ss.supportShareAudio=function(){const e=ln();return(e.os===gr.WIN_10||e.os===gr.WIN_81||e.os===gr.WIN_7||e.os===gr.LINUX||e.os===gr.MAC_OS||e.os===gr.CHROMIUM_OS)&&e.name===un.CHROME&&Number(e.version)>=74}(),ss.supportDataChannel=function(){return!!(IA(76)||function(e){const i=ln();return!(i.name!==un.FIREFOX||!i.osVersion)&&Number(i.version)>=e}(68)||function(e){const i=ln();return!(i.name!==un.SAFARI||!i.osVersion)&&Number(i.version)>=e}(14))}(),ss.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!Ln()&&!!e&&e.prototype.setConfiguration instanceof Function}(),ss.supportWebRTCEncodedTransform=function(){const e=ln();return e.name==="Chrome"&&Number(e.version)>=86||e.name==="Safari"&&Number(e.version)>=15}(),ss.supportWebRTCInsertableStream=function(){const e=ln();return(e.name===un.CHROME||e.name===un.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),MS(()=>{ss.supportDualStreamEncoding=function(){const e=ln();return Q("DISABLE_WEBAUDIO")?!0:e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&Q("CHROME_DUAL_STREAM_USE_ENCODING"))}(),O.info("browser compatibility",JSON.stringify(ss),JSON.stringify(s))})})();class ac extends oi{constructor(){super(...arguments),A(this,"resultStorage",new Map)}setLocalAudioStats(e,i,o){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(o,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(o,i))}setLocalVideoStats(e,i,o){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(o,i)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(o,i)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(o))}setRemoteAudioStats(e,i){const o=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",o,this.checkAudioOutputLevel(i))}setRemoteVideoStats(e,i){const o=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",o,this.checkVideoDecode(i))}record(e,i,o){if(Q("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const c=this.resultStorage.get(e);if(c&&(c.result.push(o),c.result.length>=5)){var u;const h=Jt(u=c.result).call(u,!0);c.isPrevNormal&&!h&&this.emit("exception",jw[e],e,i),!c.isPrevNormal&&h&&this.emit("exception",jw[e]+2e3,e+"_RECOVER",i),c.isPrevNormal=h,c.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,i){return i instanceof pr&&!i.isActive||!!i.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,i){let o=null;i._encoderConfig&&i._encoderConfig.frameRate&&(o=_t(i._encoderConfig.frameRate));const c=e.captureFrameRate;return!o||!c||!(o>10&&c<5||o<10&&o>=5&&c<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,i){return!!i.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,i){return i instanceof pr&&!i.isActive||!!i.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const jw={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},cs=new class{markSubscribeStart(s,e){performance.mark("agora-web-sdk/".concat(s,"/subscribe-").concat(e))}markPublishStart(s,e){performance.mark("agora-web-sdk/".concat(s,"/publish-").concat(e))}measureFromSubscribeStart(s,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(s,"/subscribe-").concat(e));if(i.length>0){const o=i[i.length-1];return Math.round(performance.now()-o.startTime)}return 0}measureFromPublishStart(s,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(s,"/publish-").concat(e));if(i.length>0){const o=i[i.length-1];return Math.round(performance.now()-o.startTime)}return 0}};function sC(s,e){this.v=s,this.k=e}function Pe(s){return new sC(s,0)}var XM=Wh,QM=Bd;Ce({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var s=QM.f(this);return{promise:s.promise,resolve:s.resolve,reject:s.reject}}});var xs=Bd,ZM=ho;Ce({target:"Promise",stat:!0,forced:!0},{try:function(s){var e=xs.f(this),i=ZM(s);return(i.error?e.reject:e.resolve)(i.value),e.promise}});var zl=Rt(XM),Lp=yu.f("asyncIterator"),zu=Rt(Lp);function CE(s){var e,i;function o(u,h){try{var _=s[u](h),m=_.value,g=m instanceof sC;zl.resolve(g?m.v:m).then(function(S){if(g){var C=u==="return"?"return":"next";if(!m.k||S.done)return o(C,S);S=s[C](S).value}c(_.done?"return":"normal",S)},function(S){o("throw",S)})}catch(S){c("throw",S)}}function c(u,h){switch(u){case"return":e.resolve({value:h,done:!0});break;case"throw":e.reject(h);break;default:e.resolve({value:h,done:!1})}(e=e.next)?o(e.key,e.arg):i=null}this._invoke=function(u,h){return new zl(function(_,m){var g={key:u,arg:h,resolve:_,reject:m,next:null};i?i=i.next=g:(e=i=g,o(u,h))})},typeof s.return!="function"&&(this.return=void 0)}function Wo(s){return function(){return new CE(s.apply(this,arguments))}}CE.prototype[typeof u_=="function"&&zu||"@@asyncIterator"]=function(){return this},CE.prototype.next=function(s){return this._invoke("next",s)},CE.prototype.throw=function(s){return this._invoke("throw",s)},CE.prototype.return=function(s){return this._invoke("return",s)};var $M=Rt($r.Object.getOwnPropertySymbols),oC=Ce,aC=wv.indexOf,cC=_y,Gw=fi([].indexOf),Cg=!!Gw&&1/Gw([1],1,-0)<0;oC({target:"Array",proto:!0,forced:Cg||!cC("indexOf")},{indexOf:function(s){var e=arguments.length>1?arguments[1]:void 0;return Cg?Gw(this,s,e)||0:aC(this,s,e)}});var oG=al("Array").indexOf,vg=le,kp=oG,dC=Array.prototype,Ww=Rt(function(s){var e=s.indexOf;return s===dC||vg(dC,s)&&e===dC.indexOf?kp:e}),Qr=Ns,uC=vh;Ce({target:"Object",stat:!0,forced:Nt(function(){uC(1)})},{keys:function(s){return uC(Qr(s))}});var t1=Rt($r.Object.keys);function lC(s,e){if(s==null)return{};var i,o,c=function(h,_){if(h==null)return{};var m,g,S={},C=t1(h);for(g=0;g<C.length;g++)m=C[g],Ww(_).call(_,m)>=0||(S[m]=h[m]);return S}(s,e);if($M){var u=$M(s);for(o=0;o<u.length;o++)i=u[o],Ww(e).call(e,i)>=0||Object.prototype.propertyIsEnumerable.call(s,i)&&(c[i]=s[i])}return c}var Mp={exports:{}};(function(s,e){s.exports=(()=>{var i={8:(u,h,_)=>{_.r(h),_.d(h,{Parser:()=>Ne,Printer:()=>Xo,parse:()=>ye,print:()=>an});const m=`
`,g="".concat("\r").concat(m),S=" ";let C;function I(xt){return xt>="0"&&xt<="9"}function b(xt){return xt>="!"&&xt<="~"}function x(xt){return b(xt)||xt>=""&&xt<="ÿ"}function D(xt){return xt==="!"||xt>="#"&&xt<="'"||xt>="*"&&xt<="+"||xt>="-"&&xt<="."||xt>="0"&&xt<="9"||xt>="A"&&xt<="Z"||xt>="^"&&xt<="~"}function M(xt){return xt>="1"&&xt<="9"}function K(xt){return xt>="A"&&xt<="Z"||xt>="a"&&xt<="z"}function z(xt){return xt==="d"||xt==="h"||xt==="m"||xt==="s"}function nt(xt){return xt>""&&xt<"	"||xt>"\v"&&xt<"\f"||xt>""&&xt<"ÿ"}function dt(xt){return K(xt)||I(xt)||xt==="+"||xt==="/"}function it(xt){return I(xt)||K(xt)||xt==="+"||xt==="/"||xt==="-"||xt==="_"}function at(xt){return K(xt)||I(xt)||xt==="+"||xt==="/"}function ht(xt,P){var q=Object.keys(xt);if(Object.getOwnPropertySymbols){var et=Object.getOwnPropertySymbols(xt);P&&(et=et.filter(function(It){return Object.getOwnPropertyDescriptor(xt,It).enumerable})),q.push.apply(q,et)}return q}function pt(xt){for(var P=1;P<arguments.length;P++){var q=arguments[P]!=null?arguments[P]:{};P%2?ht(Object(q),!0).forEach(function(et){bt(xt,et,q[et])}):Object.getOwnPropertyDescriptors?Object.defineProperties(xt,Object.getOwnPropertyDescriptors(q)):ht(Object(q)).forEach(function(et){Object.defineProperty(xt,et,Object.getOwnPropertyDescriptor(q,et))})}return xt}function bt(xt,P,q){return P in xt?Object.defineProperty(xt,P,{value:q,enumerable:!0,configurable:!0,writable:!0}):xt[P]=q,xt}(function(xt){xt.VERSION="v",xt.ORIGIN="o",xt.SESSION_NAME="s",xt.INFORMATION="i",xt.URI="u",xt.EMAIL="e",xt.PHONE="p",xt.CONNECTION="c",xt.BANDWIDTH="b",xt.TIME="t",xt.REPEAT="r",xt.ZONE_ADJUSTMENTS="z",xt.KEY="k",xt.ATTRIBUTE="a",xt.MEDIA="m"})(C||(C={}));class kt{consumeText(P,q){let et=q;for(;et<P.length;){const It=P[et];if(It==="\0"||It==="\r"||It===m)break;et+=1}if(et-q==0)throw new Error("Invalid text, at ".concat(P));return et}consumeUnicastAddress(P,q,et){return this.consumeTill(P,q,S)}consumeOneOrMore(P,q,et){let It=q;for(;et(P[It]);)It++;if(It-q==0)throw new Error("Invalid rule at ".concat(q,"."));return It}consumeSpace(P,q){if(P[q]===S)return q+1;throw new Error("Invalid space at ".concat(q,"."))}consumeIP4Address(P,q){let et=q;for(let It=0;It<4;It++)if(et=this.consumeDecimalUChar(P,et),It!==3){if(P[et]!==".")throw new Error("Invalid IP4 address.");et++}return et}consumeDecimalUChar(P,q){let et=q;for(let oe=0;oe<3&&I(P[et]);oe++,et++);if(et-q==0)throw new Error("Invalid decimal uchar.");const It=parseInt(P.slice(q,et));if(It>=0&&It<=255)return et;throw new Error("Invalid decimal uchar")}consumeIP6Address(P,q){let et=this.consumeHexpart(P,q);return P[et]===":"&&(et+=1,et=this.consumeIP4Address(P,et)),et}consumeHexpart(P,q){let et=q;if(P[et]===":"&&P[et+1]===":"){et+=2;try{et=this.consumeHexseq(P,et)}catch{}return et}if(et=this.consumeHexseq(P,et),P[et]===":"&&P[et+1]===":"){et+=2;try{et=this.consumeHexseq(P,et)}catch{}return et}return et}consumeHexseq(P,q){let et=q;for(;et=this.consumeHex4(P,et),P[et]===":"&&P[et+1]!==":";)et+=1;return et}consumeHex4(P,q){let et=0;for(;et<4;et++)if(!((It=P[q+et])>="0"&&It<="9"||It>="a"&&It<="f"||It>="A"&&It<="F")){if(et===0)throw new Error("Invalid hex 4");break}var It;return q+et}consumeFQDN(P,q){let et=q;for(;I(P[et])||K(P[et])||P[et]==="-"||P[et]===".";)et+=1;if(et-q<4)throw new Error("Invalid FQDN");return et}consumeExtnAddr(P,q){return this.consumeOneOrMore(P,q,x)}consumeMulticastAddress(P,q,et){switch(et){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(P,q);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(P,q);default:try{return this.consumeFQDN(P,q)}catch{return this.consumeExtnAddr(P,q)}}}consumeIP6MulticastAddress(P,q){const et=this.consumeHexpart(P,q);return P[et]==="/"?this.consumeInteger(P,et+1):et}consumeIP4MulticastAddress(P,q){let et=q+3;const It=P.slice(q,et),oe=parseInt(It);if(oe<224||oe>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let ii=0;ii<3;ii++){if(P[et]!==".")throw new Error("Invalid IP4 multicast address.");et+=1,et=this.consumeDecimalUChar(P,et)}return P[et]==="/"&&(et+=1),et=this.consumeTTL(P,et),P[et]==="/"&&(et=this.consumeInteger(P,et)),et}consumeInteger(P,q){if(!M(P[q]))throw new Error("Invalid integer.");for(q+=1;I(P[q]);)q+=1;return q}consumeTTL(P,q){if(P[q]==="0")return q+1;if(!M(P[q]))throw new Error("Invalid TTL.");q+=1;for(let et=0;et<2&&I(P[q]);et++)q+=1;return q}consumeToken(P,q){return this.consumeOneOrMore(P,q,D)}consumeTime(P,q){let et=q;if(P[et]==="0")return et+1;for(M(P[et])&&(et+=1);I(P[et]);)et++;if(et-q<10)throw new Error("Invalid time");return et}consumeAddress(P,q){return this.consumeTill(P,q,S)}consumeTypedTime(P,q){let et=q;return et=this.consumeOneOrMore(P,et,I),z(P[et])?et+1:et}consumeRepeatInterval(P,q){if(!M(P[q]))throw new Error("Invalid repeat interval");for(q+=1;I(P[q]);)q+=1;return z(P[q])&&(q+=1),q}consumePort(P,q){return this.consumeOneOrMore(P,q,I)}consume(P,q,et){for(let It=0;It<et.length;It++){if(q+It>=P.length)throw new Error("consume exceeding value length");if(P[q+It]!==et[It])throw new Error("consume ".concat(et," failed at ").concat(It))}return q+et.length}consumeTill(P,q,et){let It=q;for(;It<P.length&&(typeof et!="string"||P[It]!==et)&&(typeof et!="function"||!et(P[It]));)It++;return It}}class Ne extends kt{constructor(){super(),bt(this,"records",[]),bt(this,"currentLine",0)}parse(P){const q=this.probeEOL(P);this.records=P.split(q).filter(sr=>!!sr.trim()).map(this.parseLine),this.currentLine=0;const et=this.parseVersion(),It=this.parseOrigin(),oe=this.parseSessionName(),ii=this.parseInformation(),rr=this.parseUri(),Ao=this.parseEmail(),uu=this.parsePhone(),jp=this.parseConnection(),UC=this.parseBandWidth(),Ec=this.parseTimeFields(),nl=this.parseKey(),kE=this.parseSessionAttribute(),Yi=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:et,origin:It,sessionName:oe,information:ii,uri:rr,emails:Ao,phones:uu,connection:jp,bandwidths:UC,timeFields:Ec,key:nl,attributes:kE,mediaDescriptions:Yi}}getCurrentRecord(){const P=this.records[this.currentLine];if(!P)throw new Error("Record doesn't exit.");return P}probeEOL(P){for(let q=0;q<P.length;q++)if(P[q]===m)return P[q-1]==="\r"?g:m;throw new Error("Invalid newline character.")}parseLine(P,q){if(P.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const et=P[0];if(P[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:et,value:P.slice(2),line:q,cur:0}}parseSessionAttribute(){const P=new Qn;for(;this.currentLine<this.records.length;){const q=this.getCurrentRecord();if(q.type!==C.ATTRIBUTE)break;const et={attField:this.extractOneOrMore(q,It=>D(It)&&It!==":"),_cur:0};q.value[q.cur]===":"&&(q.cur+=1,et.attValue=this.extractOneOrMore(q,nt)),P.parse(et),this.currentLine++}return P.digest()}parseMediaAttributes(P){const q=new Er(P);for(;this.currentLine<this.records.length;){const et=this.getCurrentRecord();if(et.type!==C.ATTRIBUTE)break;const It={attField:this.extractOneOrMore(et,oe=>D(oe)&&oe!==":"),_cur:0};et.value[et.cur]===":"&&(et.cur+=1,It.attValue=this.extractOneOrMore(et,nt)),q.parse(It),this.currentLine++}return q.digest()}parseKey(){const P=this.getCurrentRecord();if(P.type===C.KEY){if(P.value==="prompt"||P.value==="clear:"||P.value==="base64:"||P.value==="uri:")return P.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const P=this.getCurrentRecord();if(P.type===C.ZONE_ADJUSTMENTS){const q=[];for(;;)try{const et=this.extract(P,this.consumeTime);this.consumeSpaceForRecord(P);let It=!1;P.value[P.cur]==="-"&&(It=!0,P.cur+=1);const oe=this.extract(P,this.consumeTypedTime);q.push({time:et,typedTime:oe,back:It})}catch{break}if(q.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,q}return[]}parseRepeat(){const P=[];for(;;){const q=this.getCurrentRecord();if(q.type!==C.REPEAT)break;{const et=this.extract(q,this.consumeRepeatInterval),It=this.parseTypedTime(q);P.push({repeatInterval:et,typedTimes:It}),this.currentLine++}}return P}parseTypedTime(P){const q=[];for(;;)try{this.consumeSpaceForRecord(P),q.push(this.extract(P,this.consumeTypedTime))}catch{break}if(q.length===0)throw new Error("Invalid typed time.");return q}parseTime(){const P=this.getCurrentRecord(),q=this.extract(P,this.consumeTime);this.consumeSpaceForRecord(P);const et=this.extract(P,this.consumeTime);return this.currentLine++,{startTime:q,stopTime:et}}parseBandWidth(){const P=[];for(;this.currentLine<this.records.length;){const q=this.getCurrentRecord();if(q.type!==C.BANDWIDTH)break;{const et=this.extractOneOrMore(q,D);if(q.value[q.cur]!==":")throw new Error("Invalid bandwidth field.");q.cur++;const It=this.extractOneOrMore(q,I);P.push({bwtype:et,bandwidth:It}),this.currentLine++}}return P}parseVersion(){const P=this.getCurrentRecord();if(P.type!==C.VERSION)throw new Error("first sdp record must be version");const q=P.value.slice(0,this.consumeOneOrMore(P.value,0,I));if(q.length!==P.value.length)throw new Error('invalid proto version, "v='.concat(P.value,'"'));return this.currentLine++,q}parseOrigin(){const P=this.getCurrentRecord();if(P.type!==C.ORIGIN)throw new Error("second line of sdp must be origin");const q=this.extractOneOrMore(P,x);this.consumeSpaceForRecord(P);const et=this.extractOneOrMore(P,I);this.consumeSpaceForRecord(P);const It=this.extractOneOrMore(P,I);this.consumeSpaceForRecord(P);const oe=this.extractOneOrMore(P,D);this.consumeSpaceForRecord(P);const ii=this.extractOneOrMore(P,D);this.consumeSpaceForRecord(P);const rr=this.extract(P,this.consumeUnicastAddress);return this.currentLine++,{username:q,sessId:et,sessVersion:It,nettype:oe,addrtype:ii,unicastAddress:rr}}parseSessionName(){const P=this.getCurrentRecord();if(P.type===C.SESSION_NAME){const q=this.extract(P,this.consumeText);return this.currentLine++,q}}parseInformation(){const P=this.getCurrentRecord();if(P.type!==C.INFORMATION)return;const q=this.extract(P,this.consumeText);return this.currentLine++,q}parseUri(){const P=this.getCurrentRecord();if(P.type===C.URI)return this.currentLine++,P.value}parseEmail(){const P=[];for(;;){const q=this.getCurrentRecord();if(q.type!==C.EMAIL)break;P.push(q.value),this.currentLine++}return P}parsePhone(){const P=[];for(;;){const q=this.getCurrentRecord();if(q.type!==C.PHONE)break;P.push(q.value),this.currentLine++}return P}parseConnection(){const P=this.getCurrentRecord();if(P.type===C.CONNECTION){const q=this.extractOneOrMore(P,D);this.consumeSpaceForRecord(P);const et=this.extractOneOrMore(P,D);this.consumeSpaceForRecord(P);const It=this.extract(P,this.consumeAddress);return this.currentLine++,{nettype:q,addrtype:et,address:It}}}parseMedia(){const P=this.getCurrentRecord(),q=this.extract(P,this.consumeToken);this.consumeSpaceForRecord(P);let et=this.extract(P,this.consumePort);P.value[P.cur]==="/"&&(P.cur+=1,et+=this.extract(P,this.consumeInteger)),this.consumeSpaceForRecord(P);const It=[];for(It.push(this.extract(P,this.consumeToken));P.value[P.cur]==="/";)P.cur+=1,It.push(this.extract(P,this.consumeToken));if(It.length===0)throw new Error("Invalid proto");const oe=this.parseFmt(P);return this.currentLine++,{mediaType:q,port:et,protos:It,fmts:oe}}parseTimeFields(){const P=[];for(;this.getCurrentRecord().type===C.TIME;){const q=this.parseTime(),et=this.parseRepeat(),It=this.parseZone();P.push({time:q,repeats:et,zones:It})}return P}parseMediaDescription(){const P=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===C.MEDIA;){const q=this.parseMedia(),et=this.parseInformation(),It=this.parseConnections(),oe=this.parseBandWidth(),ii=this.parseKey(),rr=this.parseMediaAttributes(q);P.push({media:q,information:et,connections:It,bandwidths:oe,key:ii,attributes:rr})}return P}parseConnections(){const P=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===C.CONNECTION;)P.push(this.parseConnection());return P}parseFmt(P){const q=[];for(;;)try{this.consumeSpaceForRecord(P),q.push(this.extract(P,this.consumeToken))}catch{break}if(q.length===0)throw new Error("Invalid fmts");return q}extract(P,q,...et){const It=q.call(this,P.value,P.cur,...et),oe=P.value.slice(P.cur,It);return P.cur=It,oe}extractOneOrMore(P,q){const et=this.consumeOneOrMore(P.value,P.cur,q),It=P.value.slice(P.cur,et);return P.cur=et,It}consumeSpaceForRecord(P){if(P.value[P.cur]!==S)throw new Error("Invalid space at ".concat(P.cur,"."));P.cur+=1}}class Ge extends kt{constructor(...P){super(...P),bt(this,"attributes",void 0),bt(this,"digested",!1)}extractOneOrMore(P,q,et){const It=this.consumeOneOrMore(P.attValue,P._cur,q),oe=P.attValue.slice(P._cur,It),[ii,rr]=et||[];if(typeof ii=="number"&&oe.length<ii)throw new Error("error in length, should be more or equal than ".concat(ii," characters."));if(typeof rr=="number"&&oe.length>rr)throw new Error("error in length, should be less or equal than ".concat(rr," characters."));return P._cur=It,oe}consumeAttributeSpace(P){if(P.attValue[P._cur]!==S)throw new Error("Invalid space at ".concat(P._cur,"."));P._cur+=1}extract(P,q,...et){if(!P.attValue)throw new Error("Nothing to extract from attValue.");const It=q.call(this,P.attValue,P._cur,...et),oe=P.attValue.slice(P._cur,It);return P._cur=It,oe}atEnd(P){if(!P.attValue)throw new Error;return P._cur>=P.attValue.length}peekChar(P){if(!P.attValue)throw new Error;return P.attValue[P._cur]}peek(P,q){if(!P.attValue)throw new Error;for(let et=0;et<q.length;et++)if(q[et]!==P.attValue[P._cur+et])return!1;return!0}parseIceUfrag(P){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(P,dt,[4,256])}parseIcePwd(P){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(P,dt,[22,256])}parseIceOptions(P){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const q=[];for(;!this.atEnd(P);){q.push(this.extractOneOrMore(P,dt));try{this.consumeAttributeSpace(P)}catch(et){if(this.atEnd(P))break;throw et}}this.attributes.iceOptions=q}parseFingerprint(P){const q=this.extract(P,this.consumeToken);this.consumeAttributeSpace(P);const et=this.extract(P,this.consumeTill);this.attributes.fingerprints.push({hashFunction:q,fingerprint:et})}parseExtmap(P){const q=this.extractOneOrMore(P,I);let et;this.peekChar(P)==="/"&&(this.extract(P,this.consume,"/"),et=this.extract(P,this.consumeToken)),this.consumeAttributeSpace(P);const It=this.extract(P,this.consumeTill,S),oe=pt(pt({entry:parseInt(q,10)},et&&{direction:et}),{},{extensionName:It});this.peekChar(P)===S&&(this.consumeAttributeSpace(P),oe.extensionAttributes=this.extract(P,this.consumeTill)),this.attributes.extmaps.push(oe)}parseSetup(P){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const q=this.extract(P,this.consumeTill);if(q!=="active"&&q!=="passive"&&q!=="actpass"&&q!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=q}}class Qn extends Ge{constructor(...P){super(...P),bt(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(P){if(this.digested)throw new Error("already digested");try{switch(P.attField){case"group":this.parseGroup(P);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(P);break;case"ice-pwd":this.parseIcePwd(P);break;case"ice-options":this.parseIceOptions(P);break;case"fingerprint":this.parseFingerprint(P);break;case"setup":this.parseSetup(P);break;case"tls-id":this.parseTlsId(P);break;case"identity":this.parseIdentity(P);break;case"extmap":this.parseExtmap(P);break;case"msid-semantic":this.parseMsidSemantic(P);break;default:P.ignored=!0,this.attributes.unrecognized.push(P)}}catch(q){throw console.error("parsing session attribute ".concat(P.attField,' error, "a=').concat(P.attField,":").concat(P.attValue,'"')),q}if(!P.ignored&&P.attValue&&!this.atEnd(P))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(P){const q=this.extract(P,this.consumeToken),et=[];for(;!this.atEnd(P)&&this.peekChar(P)===S;)this.consumeAttributeSpace(P),et.push(this.extract(P,this.consumeToken));this.attributes.groups.push({semantic:q,identificationTag:et})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(P){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(P,it)}parseIdentity(P){const q=this.extractOneOrMore(P,at),et=[];for(;!this.atEnd(P)&&this.peekChar(P)===S;){this.consumeAttributeSpace(P);const It=this.extract(P,this.consumeToken);this.extract(P,this.consume,"=");const oe=this.extractOneOrMore(P,ii=>ii!==S&&nt(ii));et.push({name:It,value:oe})}this.attributes.identities.push({assertionValue:q,extensions:et})}parseMsidSemantic(P){this.peekChar(P)===S&&this.consumeAttributeSpace(P);const q={semantic:this.extract(P,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(P)}catch{break}if(this.peekChar(P)==="*"){this.extract(P,this.consume,"*"),q.applyForAll=!0;break}{const et=this.extract(P,this.consumeTill,S);q.identifierList.push(et)}}this.attributes.msidSemantic=q}}class Er extends Ge{constructor(P){super(),bt(this,"attributes",void 0),P.protos.indexOf("RTP")!==-1||P.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(P){if(this.digested)throw new Error("already digested");try{switch(P.attField){case"extmap":this.parseExtmap(P);break;case"setup":this.parseSetup(P);break;case"ice-ufrag":this.parseIceUfrag(P);break;case"ice-pwd":this.parseIcePwd(P);break;case"ice-options":this.parseIceOptions(P);break;case"candidate":this.parseCandidate(P);break;case"remote-candidate":this.parseRemoteCandidate(P);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(P);break;case"rtpmap":this.parseRtpmap(P);break;case"ptime":this.parsePtime(P);break;case"maxptime":this.parseMaxPtime(P);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(P);break;case"ssrc":this.parseSSRC(P);break;case"fmtp":this.parseFmtp(P);break;case"rtcp-fb":this.parseRtcpFb(P);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(P);break;case"mid":this.parseMid(P);break;case"msid":this.parseMsid(P);break;case"imageattr":this.parseImageAttr(P);break;case"rid":this.parseRid(P);break;case"simulcast":this.parseSimulcast(P);break;case"sctp-port":this.parseSctpPort(P);break;case"max-message-size":this.parseMaxMessageSize(P);break;case"ssrc-group":this.parseSSRCGroup(P);break;default:P.ignored=!0,this.attributes.unrecognized.push(P)}}catch(q){throw console.error("parsing media attribute ".concat(P.attField,' error, "a=').concat(P.attField,":").concat(P.attValue,'"')),q}if(!P.ignored&&P.attValue&&!this.atEnd(P))throw new Error("attribute parsing error")}parseCandidate(P){const q=this.extractOneOrMore(P,dt,[1,32]);this.consumeAttributeSpace(P);const et=this.extractOneOrMore(P,I,[1,5]);this.consumeAttributeSpace(P);const It=this.extract(P,this.consumeToken);this.consumeAttributeSpace(P);const oe=this.extractOneOrMore(P,I,[1,10]);this.consumeAttributeSpace(P);const ii=this.extract(P,this.consumeAddress);this.consumeAttributeSpace(P);const rr=this.extract(P,this.consumePort);this.consumeAttributeSpace(P),this.extract(P,this.consume,"typ"),this.consumeAttributeSpace(P);const Ao={foundation:q,componentId:et,transport:It,priority:oe,connectionAddress:ii,port:rr,type:this.extract(P,this.consumeToken),extension:{}};for(this.peek(P," raddr")&&(this.extract(P,this.consume," raddr"),this.consumeAttributeSpace(P),Ao.relAddr=this.extract(P,this.consumeAddress)),this.peek(P," rport")&&(this.extract(P,this.consume," rport"),this.consumeAttributeSpace(P),Ao.relPort=this.extract(P,this.consumePort));this.peekChar(P)===S;){this.consumeAttributeSpace(P);const uu=this.extract(P,this.consumeToken);this.consumeAttributeSpace(P),Ao.extension[uu]=this.extractOneOrMore(P,b)}this.attributes.candidates.push(Ao)}parseRemoteCandidate(P){const q=[];for(;;){const et=this.extractOneOrMore(P,I,[1,5]);this.consumeAttributeSpace(P);const It=this.extract(P,this.consumeAddress);this.consumeAttributeSpace(P);const oe=this.extract(P,this.consumePort);q.push({componentId:et,connectionAddress:It,port:oe});try{this.consumeAttributeSpace(P)}catch{break}}this.attributes.remoteCandidatesList.push(q)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(P){const q=this.extract(P,this.consumeToken);this.consumeAttributeSpace(P);const et=this.extract(P,this.consumeTill,"/");this.extract(P,this.consume,"/");const It={encodingName:et,clockRate:this.extractOneOrMore(P,I)};this.atEnd(P)||this.peekChar(P)!=="/"||(this.extract(P,this.consume,"/"),It.encodingParameters=parseInt(this.extract(P,this.consumeTill),10));const oe=this.attributes.payloads.find(ii=>ii.payloadType===parseInt(q,10));oe?oe.rtpMap=It:this.attributes.payloads.push({payloadType:parseInt(q,10),rtpMap:It,rtcpFeedbacks:[]})}parsePtime(P){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(P,this.consumeTill)}parseMaxPtime(P){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(P,this.consumeTill)}parseDirection(P){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=P.attField}parseSSRC(P){const q=this.extractOneOrMore(P,I);this.consumeAttributeSpace(P);const et=this.extract(P,this.consumeTill,":");let It;this.peekChar(P)===":"&&(this.extract(P,this.consume,":"),It=this.extract(P,this.consumeTill));const oe=this.attributes.ssrcs.find(ii=>ii.ssrcId===parseInt(q,10));oe?oe.attributes[et]=It:this.attributes.ssrcs.push({ssrcId:parseInt(q,10),attributes:{[et]:It}})}parseFmtp(P){const q=this.extract(P,this.consumeTill,S);this.consumeAttributeSpace(P);const et=this.extract(P,this.consumeTill),It={};et.split(";").forEach(ii=>{let[rr,Ao]=ii.split("=");rr=rr.trim();const uu=typeof Ao=="string"?Ao.trim():null;typeof rr=="string"&&rr.length>0&&(It[rr]=uu)});const oe=this.attributes.payloads.find(ii=>ii.payloadType===parseInt(q,10));oe?oe.fmtp={parameters:It}:this.attributes.payloads.push({payloadType:parseInt(q,10),rtcpFeedbacks:[],fmtp:{parameters:It}})}parseFmtParameters(P){const q={},et=this.extract(P,this.consumeTill,"=");P._cur++;const It=this.extract(P,this.consumeTill,";");for(q[et]=It;P.attValue[P._cur]===";";){const oe=this.extract(P,this.consumeTill,"=");P._cur++;const ii=this.extract(P,this.consumeTill,";");q[oe]=ii}return q}parseRtcpFb(P){let q="";q=this.peekChar(P)==="*"?this.extract(P,this.consume,"*"):this.extract(P,this.consumeTill,S),this.consumeAttributeSpace(P);const et=this.extract(P,this.consumeTill,S);let It;if(et==="trr-int")It={type:et,interval:this.extract(P,this.consumeTill)};else{const oe={type:et};this.peekChar(P)===S&&(this.consumeAttributeSpace(P),oe.parameter=this.extract(P,this.consumeToken),this.peekChar(P)===S&&(oe.additional=this.extract(P,this.consumeTill))),It=oe}if(q==="*")this.attributes.rtcpFeedbackWildcards.push(It);else{const oe=this.attributes.payloads.find(ii=>ii.payloadType===parseInt(q,10));oe?oe.rtcpFeedbacks.push(It):this.attributes.payloads.push({payloadType:parseInt(q,10),rtcpFeedbacks:[It]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(P){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const q={port:this.extract(P,this.consumePort)};this.peekChar(P)===S&&(this.consumeAttributeSpace(P),q.netType=this.extractOneOrMore(P,D),this.consumeAttributeSpace(P),q.addressType=this.extractOneOrMore(P,D),this.consumeAttributeSpace(P),q.address=this.extract(P,this.consumeAddress)),this.attributes.rtcp=q}parseMsid(P){const q={id:this.extractOneOrMore(P,D,[1,64])};this.peekChar(P)===S&&(this.consumeAttributeSpace(P),q.appdata=this.extractOneOrMore(P,D,[1,64])),this.attributes.msids.push(q)}parseImageAttr(P){this.attributes.imageattr.push(P.attValue)}parseRid(P){const q=this.extractOneOrMore(P,It=>K(It)||I(It)||It==="_"||It==="-");this.consumeAttributeSpace(P);const et={id:q,direction:this.extract(P,this.consumeToken),params:[]};if(this.peekChar(P)===S){if(this.consumeAttributeSpace(P),this.peek(P,"pt=")){this.extract(P,this.consume,"pt=");const It=[];for(;;){const oe=this.extract(P,this.consumeToken);It.push(oe);try{this.extract(P,this.consume,",")}catch{break}}et.payloads=It,this.peekChar(P)===S&&this.extract(P,this.consume,S)}for(;;){const It=this.extract(P,this.consumeToken);switch(It){case"depend":{const oe={type:It,rids:this.extract(P,this.consume,"=").split(",")};et.params.push(oe);break}default:{const oe={type:It};this.peekChar(P)==="="&&(this.extract(P,this.consume,"="),oe.val=this.extract(P,this.consumeTill,";")),et.params.push(oe)}}try{this.extract(P,this.consume,";")}catch{break}}}this.attributes.rids.push(et)}parseSimulcast(P){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=P.attValue,this.extract(P,this.consumeTill)}parseSctpPort(P){this.attributes.sctpPort=this.extractOneOrMore(P,I,[1,5])}parseMaxMessageSize(P){this.attributes.maxMessageSize=this.extractOneOrMore(P,I,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(P){this.attributes.mid=this.extract(P,this.consumeToken)}parseSSRCGroup(P){const q=this.extract(P,this.consumeToken),et=[];for(;;)try{this.consumeAttributeSpace(P);const It=this.extract(P,this.consumeInteger);et.push(parseInt(It,10))}catch{break}this.attributes.ssrcGroups.push({semantic:q,ssrcIds:et})}}function jn(xt,P,q){return P in xt?Object.defineProperty(xt,P,{value:q,enumerable:!0,configurable:!0,writable:!0}):xt[P]=q,xt}class Xo{constructor(){jn(this,"eol",g)}print(P,q){let et="";return q&&(this.eol=q),et+=this.printVersion(P.version),et+=this.printOrigin(P.origin),et+=this.printSessionName(P.sessionName),et+=this.printInformation(P.information),et+=this.printUri(P.uri),et+=this.printEmail(P.emails),et+=this.printPhone(P.phones),et+=this.printConnection(P.connection),et+=this.printBandwidth(P.bandwidths),et+=this.printTimeFields(P.timeFields),et+=this.printKey(P.key),et+=this.printSessionAttributes(P.attributes),et+=this.printMediaDescription(P.mediaDescriptions),et}printVersion(P){return"v=".concat(P).concat(this.eol)}printOrigin(P){return"o=".concat(P.username," ").concat(P.sessId," ").concat(P.sessVersion," ").concat(P.nettype," ").concat(P.addrtype," ").concat(P.unicastAddress).concat(this.eol)}printSessionName(P){return P?"s=".concat(P).concat(this.eol):""}printInformation(P){return P?"i=".concat(P).concat(this.eol):""}printUri(P){return P?"u=".concat(P).concat(this.eol):""}printEmail(P){let q="";for(const et of P)q+="e=".concat(et).concat(this.eol);return q}printPhone(P){let q="";for(const et of P)q+="e=".concat(et).concat(this.eol);return q}printConnection(P){return P?"c=".concat(P.nettype," ").concat(P.addrtype," ").concat(P.address).concat(this.eol):""}printBandwidth(P){let q="";for(const et of P)q+="b=".concat(et.bwtype,":").concat(et.bandwidth).concat(this.eol);return q}printTimeFields(P){let q="";for(const et of P){q+="t=".concat(et.time.startTime," ").concat(et.time.startTime).concat(this.eol);for(const It of et.repeats)q+="r=".concat(It.repeatInterval," ").concat(It.typedTimes.join(" ")).concat(this.eol);et.zoneAdjustments&&(q+="z=",q+="z=".concat(et.zoneAdjustments.map(It=>"".concat(It.time," ").concat(It.back?"-":""," ").concat(It.typedTime)).join(" ")).concat(this.eol),q+=this.eol)}return q}printKey(P){return P?"k=".concat(P).concat(this.eol):""}printAttributes(P){let q="";for(const et of P)q+="a=".concat(et.attField).concat(et.attValue?":".concat(et.attValue):"").concat(this.eol);return q}printMediaDescription(P){let q="";for(const et of P)q+=this.printMedia(et.media),q+=this.printInformation(et.information),q+=this.printConnections(et.connections),q+=this.printBandwidth(et.bandwidths),q+=this.printKey(et.key),q+=this.printMediaAttributes(et);return q}printConnections(P){let q="";for(const et of P)q+=this.printConnection(et);return q}printMedia(P){return"m=".concat(P.mediaType," ").concat(P.port," ").concat(P.protos.join("/")," ").concat(P.fmts.join(" ")).concat(this.eol)}printSessionAttributes(P){return new Dt(this.eol).print(P)}printMediaAttributes(P){return new zt(this.eol).print(P)}}class St{constructor(P){jn(this,"eol",void 0),this.eol=P}printIceUfrag(P){return P===void 0?"":"a=ice-ufrag:".concat(P).concat(this.eol)}printIcePwd(P){return P===void 0?"":"a=ice-pwd:".concat(P).concat(this.eol)}printIceOptions(P){return P===void 0?"":"a=ice-options:".concat(P.join(S)).concat(this.eol)}printFingerprints(P){return P.length>0?P.map(q=>"a=fingerprint:".concat(q.hashFunction).concat(S).concat(q.fingerprint)).join(this.eol)+this.eol:""}printExtmap(P){return P.map(q=>"a=extmap:".concat(q.entry).concat(q.direction?"/".concat(q.direction):"").concat(S).concat(q.extensionName).concat(q.extensionAttributes?"".concat(S).concat(q.extensionAttributes):"").concat(this.eol)).join("")}printSetup(P){return P===void 0?"":"a=setup:".concat(P).concat(this.eol)}printUnrecognized(P){return P.map(q=>"a=".concat(q.attField).concat(q.attValue?":".concat(q.attValue):"").concat(this.eol)).join("")}}class Dt extends St{print(P){let q="";return q+=this.printGroups(P.groups),q+=this.printMsidSemantic(P.msidSemantic),q+=this.printIceLite(P.iceLite),q+=this.printIceUfrag(P.iceUfrag),q+=this.printIcePwd(P.icePwd),q+=this.printIceOptions(P.iceOptions),q+=this.printFingerprints(P.fingerprints),q+=this.printSetup(P.setup),q+=this.printTlsId(P.tlsId),q+=this.printIdentity(P.identities),q+=this.printExtmap(P.extmaps),q+=this.printUnrecognized(P.unrecognized),q}printGroups(P){let q="";return P.length>0&&(q+=P.map(et=>"a=group:".concat(et.semantic).concat(et.identificationTag.map(It=>"".concat(S).concat(It)).join("")).concat(this.eol)).join("")),q}printIceLite(P){return P===void 0?"":"a=ice-lite"+this.eol}printTlsId(P){return P?"a=tls-id:".concat(P).concat(this.eol):""}printIdentity(P){return P.length===0?"":P.map(q=>"a=identity:".concat(q.assertionValue).concat(q.extensions.map(et=>"".concat(S).concat(et.name).concat(et.value?"=".concat(et.value):"")))).join(this.eol)+this.eol}printMsidSemantic(P){if(!P)return"";let q="a=msid-semantic:".concat(P.semantic);return P.applyForAll?q+="".concat(S,"*"):P.identifierList.length>0&&(q+=P.identifierList.map(et=>"".concat(S).concat(et))),q+this.eol}}class zt extends St{print(P){const q=P.attributes;let et="";return et+=this.printRTCP(q.rtcp),et+=this.printIceUfrag(q.iceUfrag),et+=this.printIcePwd(q.icePwd),et+=this.printIceOptions(q.iceOptions),et+=this.printCandidates(q.candidates),et+=this.printRemoteCandidatesList(q.remoteCandidatesList),et+=this.printEndOfCandidates(q.endOfCandidates),et+=this.printFingerprints(q.fingerprints),et+=this.printSetup(q.setup),et+=this.printMid(q.mid),et+=this.printExtmap(q.extmaps),et+=this.printRTPRelated(q),et+=this.printPtime(q.ptime),et+=this.printMaxPtime(q.maxPtime),et+=this.printDirection(q.direction),et+=this.printSSRCGroups(q.ssrcGroups),et+=this.printSSRC(q.ssrcs),et+=this.printRTCPMux(q.rtcpMux),et+=this.printRTCPMuxOnly(q.rtcpMuxOnly),et+=this.printRTCPRsize(q.rtcpRsize),et+=this.printMSId(q.msids),et+=this.printImageattr(q.imageattr),et+=this.printRid(q.rids),et+=this.printSimulcast(q.simulcast),et+=this.printSCTPPort(q.sctpPort),et+=this.printMaxMessageSize(q.maxMessageSize),et+=this.printUnrecognized(q.unrecognized),et}printCandidates(P){return P.map(q=>"a=candidate:".concat(q.foundation).concat(S).concat(q.componentId).concat(S).concat(q.transport).concat(S).concat(q.priority).concat(S).concat(q.connectionAddress).concat(S).concat(q.port).concat(S,"typ").concat(S).concat(q.type).concat(q.relAddr?"".concat(S,"raddr").concat(S).concat(q.relAddr):"").concat(q.relPort?"".concat(S,"rport").concat(S).concat(q.relPort):"").concat(Object.keys(q.extension).map(et=>"".concat(S).concat(et).concat(S).concat(q.extension[et])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(P){return P.map(q=>"a=remote-candidates:".concat(q.join(S)).concat(this.eol)).join("")}printEndOfCandidates(P){return P===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(P){if(!P.payloads)return"";const q=P.payloads;let et="";et+=P.rtcpFeedbackWildcards.map(It=>this.printRTCPFeedback("*",It)).join("");for(const It of q)et+=this.printRtpMap(It.payloadType,It.rtpMap),et+=this.printFmtp(It.payloadType,It.fmtp),et+=It.rtcpFeedbacks.map(oe=>this.printRTCPFeedback(It.payloadType,oe)).join("");return et}printFmtp(P,q){if(!q)return"";const et=Object.keys(q.parameters);return et.length===1&&q.parameters[et[0]]===null?"a=fmtp:".concat(P).concat(S).concat(et[0]).concat(this.eol):"a=fmtp:".concat(P).concat(S).concat(Object.keys(q.parameters).map(It=>"".concat(It,"=").concat(q.parameters[It])).join(";")).concat(this.eol)}printRtpMap(P,q){return q?"a=rtpmap:".concat(P).concat(S).concat(q.encodingName,"/").concat(q.clockRate).concat(q.encodingParameters?"/".concat(q.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(P,q){let et="a=rtcp-fb:".concat(P).concat(S),It=q;return It.type==="trr-int"?et+="ttr-int".concat(S).concat(It.interval):(et+="".concat(It.type),It.parameter&&(et+="".concat(S).concat(It.parameter),It.additional&&(et+="".concat(S).concat(It.additional)))),et+this.eol}printPtime(P){return P===void 0?"":"a=ptime:".concat(P).concat(this.eol)}printMaxPtime(P){return P===void 0?"":"a=maxptime:".concat(P).concat(this.eol)}printDirection(P){return P===void 0?"":"a=".concat(P).concat(this.eol)}printSSRC(P){return P.map(q=>Object.keys(q.attributes).map(et=>"a=ssrc:".concat(q.ssrcId.toString(10)).concat(S).concat(et).concat(q.attributes[et]?":".concat(q.attributes[et]):"").concat(this.eol)).join("")).join("")}printRTCPMux(P){return P===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(P){return P===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(P){return P===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(P){if(P===void 0)return"";let q="a=rtcp:".concat(P.port);return P.netType&&(q+="".concat(S).concat(P.netType)),P.addressType&&(q+="".concat(S).concat(P.addressType)),P.address&&(q+="".concat(S).concat(P.address)),q+this.eol}printMSId(P){return P.map(q=>"a=msid:".concat(q.id).concat(q.appdata?"".concat(S).concat(q.appdata):"").concat(this.eol)).join("")}printImageattr(P){return P.map(q=>"a=imageattr:".concat(q).concat(this.eol)).join("")}printRid(P){return P.map(q=>{let et="a=rid:".concat(q.id).concat(S).concat(q.direction);return q.payloads&&(et+="".concat(S,"pt=").concat(q.payloads.join(","))),q.params.length>0&&(et+="".concat(S).concat(q.params.map(It=>It.type==="depend"?"depend=".concat(It.rids.join(",")):"".concat(It.type,"=").concat(It.val)).join(";"))),et+this.eol}).join("")}printSimulcast(P){return P===void 0?"":"a=simulcast:".concat(P).concat(this.eol)}printSCTPPort(P){return P===void 0?"":"a=sctp-port:".concat(P).concat(this.eol)}printMaxMessageSize(P){return P===void 0?"":"a=max-message-size:".concat(P).concat(this.eol)}printMid(P){return P===void 0?"":"a=mid:".concat(P).concat(this.eol)}printSSRCGroups(P){return P.map(q=>"a=ssrc-group:".concat(q.semantic).concat(q.ssrcIds.map(et=>"".concat(S).concat(et.toString(10))).join("")).concat(this.eol)).join("")}}function ye(xt){return new Ne().parse(xt)}function an(xt,P){return new Xo().print(xt,P)}}},o={};function c(u){if(o[u])return o[u].exports;var h=o[u]={exports:{}};return i[u](h,h.exports,c),h.exports}return c.d=(u,h)=>{for(var _ in h)c.o(h,_)&&!c.o(u,_)&&Object.defineProperty(u,_,{enumerable:!0,get:h[_]})},c.o=(u,h)=>Object.prototype.hasOwnProperty.call(u,h),c.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})},c(8)})()})(Mp);var ci=Mp.exports;function Ho(s){if(Array.isArray(s))return s.map(i=>i);if(!Hw(s))return s;const e={};for(const i in s){const o=s[i];Hw(o)||Array.isArray(o)?e[i]=Ho(o):e[i]=o}return e}function Hw(s){return!(typeof s!="object"||Array.isArray(s)||!s)}class hC{constructor(e){A(this,"input",[]),A(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const ya={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},xc={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:ya,remoteCandidate:ya}},Kw={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},Yw={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},qw={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},Jl={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function Up(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function pC(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Up(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Up(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class Ig{constructor(e,i){A(this,"onFirstVideoReceived",void 0),A(this,"onFirstVideoDecoded",void 0),A(this,"onFirstAudioReceived",void 0),A(this,"onFirstVideoDecodedTimeout",void 0),A(this,"onFirstAudioDecoded",void 0),A(this,"onSelectedLocalCandidateChanged",void 0),A(this,"onSelectedRemoteCandidateChanged",void 0),A(this,"videoIsReady",!1),A(this,"videoIsReady2",{}),A(this,"pc",void 0),A(this,"options",void 0),A(this,"intervalTimer",void 0),A(this,"stats",Ho(xc)),A(this,"isFirstVideoReceived",{}),A(this,"isFirstVideoDecoded",{}),A(this,"isFirstAudioReceived",{}),A(this,"isFirstAudioDecoded",{}),A(this,"isFirstVideoDecodedTimeout",{}),A(this,"lossRateWindowStats",[]),this.pc=e,this.options=i,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new ut(e=>{e({local:pC({},ya),remote:pC({},ya)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,i){this.videoIsReady2[e]=i}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const i=this.lossRateWindowStats.length,o=["videoSend","audioSend","videoRecv","audioRecv"];let c=0,u=0,h=0,_=0;for(const m of o)e[m].forEach((g,S)=>{if(!this.lossRateWindowStats[i-1][m][S]||!this.lossRateWindowStats[0][m][S])return;const C=this.lossRateWindowStats[i-1][m][S].packets-this.lossRateWindowStats[0][m][S].packets,I=this.lossRateWindowStats[i-1][m][S].packetsLost-this.lossRateWindowStats[0][m][S].packetsLost;m==="videoSend"||m==="audioSend"?(c+=C,h+=I):(u+=C,_+=I),Number.isNaN(C)||Number.isNaN(C)?g.packetLostRate=0:g.packetLostRate=C<=0||I<=0?0:I/(C+I)});e.sendPacketLossRate=c<=0||h<=0?0:h/(c+h),e.recvPacketLossRate=u<=0||_<=0?0:_/(u+_)}}function zw(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function _C(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?zw(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):zw(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class e1 extends Ig{constructor(){super(...arguments),A(this,"_stats",xc),A(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),i=this.statsResponsesToObjects(e);this._stats=Ho(xc);const o=i.filter(u=>u.type==="ssrc");this.processSSRCStats(o);const c=i.find(u=>u.type==="VideoBwe");c&&this.processBandwidthStats(c),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(i=>{var o;const c=Jt(o=i.id).call(o,"send");switch("".concat(i.mediaType,"_").concat(c?"send":"recv")){case"video_send":{const u=Ho(Yw);u.codec=i.googCodecName,u.adaptionChangeReason="none",i.googCpuLimitedResolution&&(u.adaptionChangeReason="cpu"),i.googBandwidthLimitedResolution&&(u.adaptionChangeReason="bandwidth"),u.avgEncodeMs=Number(i.googAvgEncodeMs),u.inputFrame={width:Number(i.googFrameWidthInput)||Number(i.googFrameWidthSent),height:Number(i.googFrameHeightInput)||Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},u.sentFrame={width:Number(i.googFrameWidthSent),height:Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},u.firsCount=Number(i.googFirReceived),u.nacksCount=Number(i.googNacksReceived),u.plisCount=Number(i.googPlisReceived),u.frameCount=Number(i.framesEncoded),u.bytes=Number(i.bytesSent),u.packets=Number(i.packetsSent),u.packetsLost=Number(i.packetsLost),u.ssrc=Number(i.ssrc),u.rttMs=Number(i.googRtt||0),this._stats.videoSend.push(u),this._stats.rtt=u.rttMs;break}case"video_recv":{const u=Ho(Kw),h=this.lastDecodeVideoReceiverStats.get(Number(i.ssrc));if(u.codec=i.googCodecName,u.targetDelayMs=Number(i.googTargetDelayMs),u.renderDelayMs=Number(i.googRenderDelayMs),u.currentDelayMs=Number(i.googCurrentDelayMs),u.minPlayoutDelayMs=Number(i.googMinPlayoutDelayMs),u.decodeMs=Number(i.googDecodeMs),u.maxDecodeMs=Number(i.googMaxDecodeMs),u.receivedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateReceived)},u.decodedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateDecoded)},u.decodeFrameRate=Number(i.googFrameRateDecoded),u.outputFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateOutput)},u.jitterBufferMs=Number(i.googJitterBufferMs),u.firsCount=Number(i.googFirsSent),u.nacksCount=Number(i.googNacksSent),u.plisCount=Number(i.googPlisSent),u.framesDecodeCount=Number(i.framesDecoded),u.bytes=Number(i.bytesReceived),u.packets=Number(i.packetsReceived),u.packetsLost=Number(i.packetsLost),u.ssrc=Number(i.ssrc),u.packets>0&&!this.isFirstVideoReceived[u.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(u.ssrc),this.isFirstVideoReceived[u.ssrc]=!0),u.framesDecodeCount>0&&!this.isFirstVideoDecoded[u.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(u.ssrc,u.decodedFrame.width,u.decodedFrame.height),this.isFirstVideoDecoded[u.ssrc]=!0),h){const _=h.stats,m=Date.now()-h.lts;u.framesDecodeFreezeTime=_.framesDecodeFreezeTime,u.framesDecodeInterval=_.framesDecodeInterval,u.framesDecodeCount>_.framesDecodeCount&&this.isFirstVideoDecoded[u.ssrc]?(h.lts=Date.now(),u.framesDecodeInterval=m,u.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(i.ssrc,10))?u.framesDecodeFreezeTime+=u.framesDecodeInterval:this.setVideoIsReady2(parseInt(i.ssrc,10),!0))):u.framesDecodeCount<h.stats.framesDecodeCount&&(u.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(u.ssrc,{stats:_C({},u),lts:Date.now()}),this._stats.videoRecv.push(u);break}case"audio_recv":{const u=Ho(Jl);u.codec=i.googCodecName,u.outputLevel=Math.abs(Number(i.audioOutputLevel))/32767,u.decodingCNG=Number(i.googDecodingCNG),u.decodingCTN=Number(i.googDecodingCTN),u.decodingCTSG=Number(i.googDecodingCTSG),u.decodingNormal=Number(i.googDecodingNormal),u.decodingPLC=Number(i.googDecodingPLC),u.decodingPLCCNG=Number(i.googDecodingPLCCNG),u.expandRate=Number(i.googExpandRate),u.accelerateRate=Number(i.googAccelerateRate),u.preemptiveExpandRate=Number(i.googPreemptiveExpandRate),u.secondaryDecodedRate=Number(i.googSecondaryDecodedRate),u.speechExpandRate=Number(i.googSpeechExpandRate),u.preferredJitterBufferMs=Number(i.googPreferredJitterBufferMs),u.jitterBufferMs=Number(i.googJitterBufferMs),u.jitterMs=Number(i.googJitterReceived),u.bytes=Number(i.bytesReceived),u.packets=Number(i.packetsReceived),u.packetsLost=Number(i.packetsLost),u.ssrc=Number(i.ssrc),u.receivedFrames=Number(i.googDecodingCTN)||Number(i.packetsReceived),u.droppedFrames=Number(i.googDecodingPLC)+Number(i.googDecodingPLCCNG)||Number(i.packetsLost),u.receivedFrames>0&&!this.isFirstAudioReceived[u.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(u.ssrc),this.isFirstAudioReceived[u.ssrc]=!0),u.decodingNormal>0&&!this.isFirstAudioDecoded[u.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(u.ssrc),this.isFirstAudioDecoded[u.ssrc]=!0),this._stats.audioRecv.push(u);break}case"audio_send":{const u=Ho(qw);u.codec=i.googCodecName,u.inputLevel=Math.abs(Number(i.audioInputLevel))/32767,u.aecReturnLoss=Number(i.googEchoCancellationReturnLoss||0),u.aecReturnLossEnhancement=Number(i.googEchoCancellationReturnLossEnhancement||0),u.residualEchoLikelihood=Number(i.googResidualEchoLikelihood||0),u.residualEchoLikelihoodRecentMax=Number(i.googResidualEchoLikelihoodRecentMax||0),u.bytes=Number(i.bytesSent),u.packets=Number(i.packetsSent),u.packetsLost=Number(i.packetsLost),u.ssrc=Number(i.ssrc),u.rttMs=Number(i.googRtt||0),this._stats.rtt=u.rttMs,this._stats.audioSend.push(u);break}}})}_getStats(){return new ut((e,i)=>{this.pc.getStats(e,i)})}statsResponsesToObjects(e){const i=[];return e.result().forEach(o=>{const c={id:o.id,timestamp:o.timestamp.valueOf().toString(),type:o.type};o.names().forEach(u=>{c[u]=o.stat(u)}),i.push(c)}),i}}function Jw(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Xl(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Jw(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Jw(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class cc extends Ig{constructor(){super(...arguments),A(this,"_stats",xc),A(this,"report",void 0),A(this,"lastDecodeVideoReceiverStats",new Map),A(this,"lastVideoFramesRecv",new Map),A(this,"lastVideoFramesSent",new Map),A(this,"lastVideoFramesDecode",new Map),A(this,"lastVideoJBDelay",new Map),A(this,"lastAudioJBDelay",new Map),A(this,"mediaBytesSent",new Map),A(this,"mediaBytesRetransmit",new Map),A(this,"mediaBytesTargetEncode",new Map),A(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Ho(xc),this.report.forEach(e=>{switch(e.type){case po.OUTBOUND:case po.INBOUND:{const i=e.mediaType||e.kind,o=!i&&"frameWidth"in e,c=!i&&!("frameWidth"in e);e.type===po.OUTBOUND?i==="audio"||c?this.processAudioOutboundStats(e):(i==="video"||o)&&this.processVideoOutboundStats(e):e.type===po.INBOUND&&(i==="audio"||c?this.processAudioInboundStats(e):(i==="video"||o)&&this.processVideoInboundStats(e));break}case po.TRANSPORT:{const i=this.report.get(e.selectedCandidatePairId);i&&this.processCandidatePairStats(i);break}case po.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),i={local:Xl({},ya),remote:Xl({},ya)};return e.forEach(o=>{let c;if(o.type===po.TRANSPORT&&(c=e.get(o.selectedCandidatePairId)),o.type===po.CANDIDATE_PAIR&&o.selected&&(c=o),c){const u=(h,_)=>{h.type=_.type,h.id=_.id,_.address&&(h.address=_.address),_.candidateType&&(h.candidateType=_.candidateType),_.port&&(h.port=_.port),_.priority&&(h.priority=_.priority),_.protocol&&(h.protocol=_.protocol),_.relayProtocol&&(h.relayProtocol=_.relayProtocol)};if(c.localCandidateId){const h=e.get(c.localCandidateId);h&&u(i.local,h)}if(c.remoteCandidateId){const h=e.get(c.remoteCandidateId);h&&u(i.remote,h)}}}),i}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(i=>{e.currentRoundTripTime&&(i.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(i=>{e.currentRoundTripTime&&(i.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const i=this.report.get(e.localCandidateId);i&&this.processCandidateStats(i)}if(e.remoteCandidateId){const i=this.report.get(e.remoteCandidateId);i&&this.processCandidateStats(i)}}processCandidateStats(e){let i;e.type===po.LOCAL_CANDIDATE&&(i=this._stats.selectedCandidatePair.localCandidate),e.type===po.REMOTE_CANDIDATE&&(i=this._stats.selectedCandidatePair.remoteCandidate),i&&(i.type=e.type,i.id=e.id,e.address&&(i.address=e.address),e.candidateType&&(i.candidateType=e.candidateType),e.port&&(i.port=e.port),e.priority&&(i.priority=e.priority),e.protocol&&(i.protocol=e.protocol),e.relayProtocol&&(i.relayProtocol=e.relayProtocol),e.type===po.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==i.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Xl({},i),Xl({},this.stats.selectedCandidatePair.localCandidate)),e.type===po.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==i.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Xl({},i),Xl({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let i=this._stats.audioRecv.find(o=>o.ssrc===e.ssrc);i||(i=Ho(Jl),this._stats.audioRecv.push(i)),i.ssrc=e.ssrc,i.packets=e.packetsReceived,i.packetsLost=e.packetsLost,i.bytes=e.bytesReceived,i.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,i),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),i.receivedFrames||(i.receivedFrames=e.packetsReceived),i.droppedFrames||(i.droppedFrames=e.packetsLost),i.receivedFrames>0&&!this.isFirstAudioReceived[i.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(i.ssrc),this.isFirstAudioReceived[i.ssrc]=!0),i.outputLevel&&i.outputLevel>0&&!this.isFirstAudioDecoded[i.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(i.ssrc),this.isFirstAudioDecoded[i.ssrc]=!0),typeof e.concealedSamples=="number"&&(i.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let i=this._stats.videoRecv.find(h=>h.ssrc===e.ssrc);i||(i=Ho(Kw),this._stats.videoRecv.push(i)),i.ssrc=e.ssrc,i.packets=e.packetsReceived,i.packetsLost=e.packetsLost,i.bytes=e.bytesReceived,i.firsCount=e.firCount,i.nacksCount=e.nackCount,i.plisCount=e.pliCount,i.framesDecodeCount=e.framesDecoded,i.totalInterFrameDelay=e.totalInterFrameDelay,i.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const o=this.lastDecodeVideoReceiverStats.get(i.ssrc),c=this.lastVideoFramesDecode.get(i.ssrc),u=Date.now();if(i.framesDecodeCount>0&&!this.isFirstVideoDecoded[i.ssrc]){const h=i.decodedFrame?i.decodedFrame.width:0,_=i.decodedFrame?i.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(i.ssrc,h,_),this.isFirstVideoDecoded[i.ssrc]=!0}if(o){const h=o.stats,_=u-o.lts;i.framesDecodeFreezeTime=h.framesDecodeFreezeTime,i.framesDecodeInterval=h.framesDecodeInterval,!this.isFirstVideoDecoded[i.ssrc]&&_>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[i.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(i.ssrc),this.isFirstVideoDecodedTimeout[i.ssrc]=!0),i.framesDecodeCount>h.framesDecodeCount&&this.isFirstVideoDecoded[i.ssrc]?(o.lts=Date.now(),i.framesDecodeInterval=_,i.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?i.framesDecodeFreezeTime+=i.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):i.framesDecodeCount<h.framesDecodeCount&&(i.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(o.stats.framesDecodeCount>e.framesDecoded?i.qpSumPerFrame=e.qpSum/e.framesDecoded:i.qpSumPerFrame=(e.qpSum-o.qpSum)/(e.framesDecoded-o.stats.framesDecodeCount))}c&&u-c.lts>=800?(i.decodeFrameRate=Math.round((i.framesDecodeCount-c.count)/((u-c.lts)/1e3)),this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:u,rate:i.decodeFrameRate})):c?i.decodeFrameRate=c.rate:this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:u,rate:0}),e.totalDecodeTime&&(i.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,i),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(i.framesRateFirefox=e.framerateMean),i.packets>0&&!this.isFirstVideoReceived[i.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(i.ssrc),this.isFirstVideoReceived[i.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(i.ssrc,{stats:Xl({},i),lts:o?o.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let i=this._stats.videoSend.find(c=>c.ssrc===e.ssrc);i||(i=Ho(Yw),this._stats.videoSend.push(i));const o=this.mediaBytesSent.get(e.ssrc);if(o)o.add(e.bytesSent);else{const c=new hC(10);c.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,c)}if(e.retransmittedBytesSent!==void 0){const c=this.mediaBytesRetransmit.get(e.ssrc);if(c)c.add(e.retransmittedBytesSent);else{const u=new hC(10);u.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,u)}}if(e.totalEncodedBytesTarget){const c=this.mediaBytesTargetEncode.get(e.ssrc);if(c)c.add(e.totalEncodedBytesTarget);else{const u=new hC(10);u.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,u)}}if(i.ssrc=e.ssrc,i.bytes=e.bytesSent,i.packets=e.packetsSent,i.firsCount=e.firCount,i.nacksCount=e.nackCount,i.plisCount=e.pliCount,i.frameCount=e.framesEncoded,i.adaptionChangeReason=e.qualityLimitationReason,i.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const c=this.lastEncoderMs.get(e.ssrc);if(!c||c.lastFrameCount>e.framesEncoded)i.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const u=e.framesEncoded-c.lastFrameCount,h=e.totalEncodeTime-c.lastEncoderTime;i.avgEncodeMs=1e3*h/u}}if(e.framesEncoded&&e.qpSum){const c=this.lastEncoderMs.get(e.ssrc);!c||c.lastFrameCount>e.framesEncoded?i.qpSumPerFrame=e.qpSum/e.framesEncoded:i.qpSumPerFrame=(e.qpSum-c.lastQpSum)/(e.framesEncoded-c.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,i),this.processVideoTrackSenderStats(e,e.trackId,i),e.remoteId)this.processRemoteInboundStats(e.remoteId,i);else{const c=this.findRemoteStatsId(e.ssrc,po.REMOTE_INBOUND);c&&this.processRemoteInboundStats(c,i)}}processAudioOutboundStats(e){let i=this._stats.audioSend.find(o=>o.ssrc===e.ssrc);if(i||(i=Ho(qw),this._stats.audioSend.push(i)),i.ssrc=e.ssrc,i.packets=e.packetsSent,i.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,i),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,i),e.remoteId)this.processRemoteInboundStats(e.remoteId,i);else{const o=this.findRemoteStatsId(e.ssrc,po.REMOTE_INBOUND);o&&this.processRemoteInboundStats(o,i)}}findRemoteStatsId(e,i){var o;const c=Array.from(Rc(o=this.report).call(o)).find(u=>u.type===i&&u.ssrc===e);return c?c.id:null}processVideoMediaSource(e,i){const o=this.report.get(e);o&&o.width&&o.height&&o.framesPerSecond&&(i.inputFrame={width:o.width,height:o.height,frameRate:o.framesPerSecond})}processAudioMediaSource(e,i){const o=this.report.get(e);o&&(i.inputLevel=o.audioLevel)}processVideoTrackSenderStats(e,i,o){var c,u,h,_;const m=i?this.report.get(i):void 0,g=(c=m==null?void 0:m.framesSent)!==null&&c!==void 0?c:e.framesSent;if(typeof g!="number")return;let S=(u=m==null?void 0:m.frameWidth)!==null&&u!==void 0?u:e.frameWidth,C=(h=m==null?void 0:m.frameHeight)!==null&&h!==void 0?h:e.frameHeight,I=(_=m==null?void 0:m.framesPerSecond)!==null&&_!==void 0?_:e.framesPerSecond;if(typeof S=="number"&&typeof C=="number"||(S=0,C=0),I==null){const b=Date.now(),x=this.lastVideoFramesSent.get(o.ssrc);x&&b-x.lts>=800?(I=Math.round((g-x.count)/((b-x.lts)/1e3)),this.lastVideoFramesSent.set(o.ssrc,{count:g,lts:b,rate:I})):x?I=x.rate:this.lastVideoFramesSent.set(o.ssrc,{count:g,lts:b,rate:0})}o.sentFrame={width:S,height:C,frameRate:Math.max(0,I)}}processVideoTrackReceiverStats(e,i,o){var c,u,h,_,m;const g=i?this.report.get(i):void 0,S=(c=g==null?void 0:g.framesReceived)!==null&&c!==void 0?c:e.framesReceived,C=(u=g==null?void 0:g.frameWidth)!==null&&u!==void 0?u:e.frameWidth,I=(h=g==null?void 0:g.frameHeight)!==null&&h!==void 0?h:e.frameHeight,b=(_=g==null?void 0:g.jitterBufferDelay)!==null&&_!==void 0?_:e.jitterBufferDelay,x=(m=g==null?void 0:g.jitterBufferEmittedCount)!==null&&m!==void 0?m:e.jitterBufferEmittedCount;if(typeof S=="number"){const D=this.lastVideoFramesRecv.get(o.ssrc),M=Date.now();o.framesReceivedCount=S;let K=0;D&&M-D.lts>=800?(K=Math.round((S-D.count)/((M-D.lts)/1e3)),this.lastVideoFramesRecv.set(o.ssrc,{count:S,lts:M,rate:K})):D?K=D.rate:this.lastVideoFramesRecv.set(o.ssrc,{count:S,lts:M,rate:0}),o.receivedFrame={width:C||0,height:I||0,frameRate:K||0},o.decodedFrame={width:C||0,height:I||0,frameRate:o.decodeFrameRate||0},o.outputFrame={width:C||0,height:I||0,frameRate:o.decodeFrameRate||0}}if(b&&x){const D=this.lastVideoJBDelay.get(o.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let M=D.jitterBufferMs;const K=x-D.jitterBufferEmittedCount;K>0&&(M=1e3*(b-D.jitterBufferDelay)/K),o.jitterBufferMs=M,o.currentDelayMs=Math.round(M),this.lastVideoJBDelay.set(o.ssrc,{jitterBufferDelay:b,jitterBufferEmittedCount:x,jitterBufferMs:o.currentDelayMs})}}processAudioTrackSenderStats(e,i,o){var c,u,h,_;const m=i?this.report.get(i):void 0,g=(c=(u=m==null?void 0:m.echoReturnLoss)!==null&&u!==void 0?u:e.echoReturnLoss)!==null&&c!==void 0?c:0,S=(h=(_=m==null?void 0:m.echoReturnLossEnhancement)!==null&&_!==void 0?_:e.echoReturnLossEnhancement)!==null&&h!==void 0?h:0;o.aecReturnLoss=g,o.aecReturnLossEnhancement=S}processAudioTrackReceiverStats(e,i,o){var c,u,h,_,m,g,S;const C=i?this.report.get(i):void 0,I=(c=C==null?void 0:C.removedSamplesForAcceleration)!==null&&c!==void 0?c:e.removedSamplesForAcceleration,b=(u=C==null?void 0:C.totalSamplesReceived)!==null&&u!==void 0?u:e.totalSamplesReceived,x=(h=C==null?void 0:C.jitterBufferDelay)!==null&&h!==void 0?h:e.jitterBufferDelay,D=(_=C==null?void 0:C.jitterBufferEmittedCount)!==null&&_!==void 0?_:e.jitterBufferEmittedCount,M=(m=C==null?void 0:C.audioLevel)!==null&&m!==void 0?m:e==null?void 0:e.audioLevel,K=(g=C==null?void 0:C.totalSamplesDuration)!==null&&g!==void 0?g:e==null?void 0:e.totalSamplesDuration,z=(S=C==null?void 0:C.concealedSamples)!==null&&S!==void 0?S:e.concealedSamples;if(I&&b&&(o.accelerateRate=I/b),x&&D){const dt=this.lastAudioJBDelay.get(o.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let it=dt.jitterBufferMs;const at=D-dt.jitterBufferEmittedCount;at>0&&(it=1e3*(x-dt.jitterBufferDelay)/at),o.jitterBufferMs=Math.round(it),this.lastAudioJBDelay.set(o.ssrc,{jitterBufferDelay:x,jitterBufferEmittedCount:D,jitterBufferMs:o.jitterBufferMs})}o.outputLevel=M;let nt=1920;K&&b&&(nt=b/K/50,o.receivedFrames=Math.round(b/nt)),z&&(o.droppedFrames=Math.round(z/nt))}processRemoteInboundStats(e,i){const o=this.report.get(e);o&&(i.packetsLost=o.packetsLost,o.roundTripTime&&(i.rttMs=1e3*o.roundTripTime),o.jitter&&(i.jitterMs=1e3*o.jitter),o.timestamp&&(i.timestamp=o.timestamp))}getCodecFromCodecStats(e){const i=this.report.get(e);if(!i)return"";const o=i.mimeType.match(/\/(.*)$/);return o&&o[1]?o[1]:""}updateSendBitrate(){let e=0,i=null,o=null;this.mediaBytesSent.forEach(u=>{e+=u.diffMean()}),this.mediaBytesRetransmit.forEach(u=>{i=i===null?u.diffMean():i+u.diffMean()}),this.mediaBytesTargetEncode.forEach(u=>{o=o===null?u.diffMean():o+u.diffMean()});const c=i!==null?e-i:e;this._stats.bitrate={actualEncoded:8*c/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},i!==null&&(this._stats.bitrate.retransmit=8*i/(this.options.updateInterval/1e3)),o!==null&&(this._stats.bitrate.targetEncoded=8*o/(this.options.updateInterval/1e3))}}class EC extends Ig{updateStats(){return ut.resolve()}}function Ju(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,c=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const u=function(){const h=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return h&&h[0]?Number(h[0].split("/")[1]):null}();return u?u<76?new e1(s,{updateInterval:e,lossRateInterval:i,freezeRateLimit:o,firstVideoDecodedTimeout:c}):new cc(s,{updateInterval:e,lossRateInterval:i,freezeRateLimit:o,firstVideoDecodedTimeout:c}):function(h){return!!window.RTCStatsReport&&h.getStats()instanceof ut}(s)?new cc(s,{updateInterval:e,lossRateInterval:i,freezeRateLimit:o,firstVideoDecodedTimeout:c}):new EC(s,{updateInterval:e,lossRateInterval:i,freezeRateLimit:o,firstVideoDecodedTimeout:c})}function vE(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function mC(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?vE(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):vE(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function Ql(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;const{filterRTX:c,filterVideoFec:u,filterAudioFec:h,filterAudioCodec:_,filterVideoCodec:m}=e,{useXR:g}=i;let S=[],C=[],I=[],b=[],x=!1,D=!1;if(ci.parse(s).mediaDescriptions.forEach(K=>{o&&o!==K.attributes.direction||(K.media.mediaType!=="video"||x||(C=K.attributes.payloads,b=K.attributes.extmaps,x=!0),K.media.mediaType!=="audio"||D||(S=K.attributes.payloads,I=K.attributes.extmaps,D=!0))}),!b||C.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!I||S.length===0)throw new Error("Cannot get audio capabilities from SDP.");C.forEach(K=>{var z;(z=K.rtpMap)!==null&&z!==void 0&&z.clockRate&&(K.rtpMap.clockRate=parseInt(K.rtpMap.clockRate)),g&&K.rtcpFeedbacks.push({type:"rrtr"})}),S.forEach(K=>{var z;(z=K.rtpMap)!==null&&z!==void 0&&z.clockRate&&(K.rtpMap.clockRate=parseInt(K.rtpMap.clockRate)),g&&K.rtcpFeedbacks.push({type:"rrtr"})}),c&&(S=S.filter(K=>{var z;return((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())!=="rtx"}),C=C.filter(K=>{var z;return((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())!=="rtx"})),u&&(C=C.filter(K=>{var z;return!/(red)|(ulpfec)|(flexfec)/i.test(((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName)||"")})),h&&(S=S.filter(K=>{var z;return!/(red)|(ulpfec)|(flexfec)/i.test(((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName)||"")})),_&&(_==null?void 0:_.length)>0&&(S=S.filter(K=>{var z;return Jt(_).call(_,((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())||"")})),m&&(m==null?void 0:m.length)>0&&(C=C.filter(K=>{var z;return Jt(m).call(m,((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())||"")}));const M=Q("UNSUPPORTED_VIDEO_CODEC");return M&&M.length>0&&(C=C.filter(K=>!(K.rtpMap&&Jt(M).call(M,K.rtpMap.encodingName.toLowerCase())))),{audioCodecs:S,videoCodecs:C,audioExtensions:I,videoExtensions:b}}function Vc(s){const e=ci.parse(s);let i,o;for(const c of e.mediaDescriptions){if(!i){const u=c.attributes.iceUfrag,h=c.attributes.icePwd;if(!u||!h)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:u,icePwd:h}}if(!o){const u=c.attributes.fingerprints;u.length>0&&(o={fingerprints:u})}}if(!o&&e.attributes.fingerprints.length>0&&(o={fingerprints:e.attributes.fingerprints}),!o||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:o}}function fC(s,e){const i=[],o=s.attributes.ssrcGroups.filter(h=>h.semantic==="FID"),c=s.attributes.ssrcGroups.find(h=>h.semantic==="SIM"),u=s.attributes.ssrcs;if(c)c.ssrcIds.forEach(h=>{var _;const m=(_=o.find(g=>g.ssrcIds[0]===h))===null||_===void 0?void 0:_.ssrcIds[1];i.push({ssrcId:h,rtx:e?m:void 0})});else if(o.length>0){const h=o[0].ssrcIds[0],_=o[0].ssrcIds[1];i.push({ssrcId:h,rtx:e?_:void 0})}else{if(u.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:u[0].ssrcId})}return i}function Xw(s,e){const{cname:i}=s;let o;e&&e.ip&&typeof e.port=="number"?(o=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],O.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(o.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),O.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):o=s.iceParameters.candidates.map(_=>({foundation:_.foundation,componentId:"1",transport:_.protocol,priority:_.priority.toString(),connectionAddress:_.ip,port:_.port.toString(),type:_.type,extension:{}}));const c={fingerprints:s.dtlsParameters.fingerprints.map(_=>({hashFunction:_.algorithm,fingerprint:_.fingerprint}))},u={iceUfrag:s.iceParameters.iceUfrag,icePwd:s.iceParameters.icePwd};let h;switch(s.dtlsParameters.role){case"server":h="passive";break;case"client":h="active";break;case"auto":h="actpass"}return{dtlsParameters:c,iceParameters:u,candidates:o,rtpCapabilities:xp(s.rtpCapabilities),setup:h,cname:i}}function ro(s,e,i){const o=[],c=[];return s.forEach(u=>{let{ssrcId:h,rtx:_}=u;const m=Hn(8,"track-"),g={ssrcId:h,attributes:mC({label:m,mslabel:i=i||Hn(10,""),msid:"".concat(i," ").concat(m)},e&&{cname:e})};if(o.push(g),_!==void 0){const S={ssrcId:_,attributes:mC({label:m,mslabel:i,msid:"".concat(i," ").concat(m)},e&&{cname:e})};o.push(S),c.push({semantic:"FID",ssrcIds:[h,_]})}}),s.length>1&&c.push({semantic:"SIM",ssrcIds:s.map(u=>{let{ssrcId:h}=u;return h})}),{ssrcs:o,ssrcGroups:c}}function so(s,e){e instanceof Nn&&s.attributes.payloads.forEach(i=>{var o;const c=(o=i.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase();if(!c||["opus","pcmu","pcma","g722"].indexOf(c)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";const u=e._encoderConfig;u&&c!=="pcmu"&&c!=="pcma"&&c!=="g722"&&(u.bitrate&&!Ln()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*u.bitrate))),u.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(u.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(u.sampleRate)),u.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1"))})}function yg(s){const e=s.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");e!==-1&&s.attributes.unrecognized.splice(e,1)}function Sd(s,e){var i;if(!(e instanceof ke&&e._encoderConfig&&e._hints.indexOf(Fn.SCREEN_TRACK)===-1))return;const o=e._encoderConfig;sn().supportMinBitrate&&o.bitrateMin&&s.attributes.payloads.forEach(c=>{var u,h;Jt(u=["h264","h265","vp8","vp9","av1"]).call(u,((h=c.rtpMap)===null||h===void 0?void 0:h.encodingName.toLowerCase())||"")&&(c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["x-google-min-bitrate"]="".concat(o.bitrateMin))}),sn().supportMinBitrate&&!Jt(i=e._hints).call(i,Fn.LOW_STREAM)&&o.bitrateMax&&s.attributes.payloads.forEach(c=>{var u,h;Jt(u=["h264","h265","vp8","vp9","av1"]).call(u,((h=c.rtpMap)===null||h===void 0?void 0:h.encodingName.toLowerCase())||"")&&(c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["x-google-start-bitrate"]="".concat(Q("X_GOOGLE_START_BITRATE")||Math.floor(o.bitrateMax)))})}function Ag(s){if(s.media.mediaType!=="video")return;const e=ln();if(e.name!==un.SAFARI&&e.os!==gr.IOS)return;const i=s.attributes.extmaps.findIndex(o=>/video-orientation/g.test(o.extensionName));i!==-1&&s.attributes.extmaps.splice(i,1)}function IE(s,e,i){if(!e)return;let o,c;if(s.media.mediaType==="video"?(o=i.videoExtensions,c=i.videoCodecs):(o=i.audioExtensions,c=i.audioCodecs),e.twcc===!0){const u=o.find(h=>h.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u&&(s.attributes.extmaps.find(_=>_.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||s.attributes.extmaps.push({entry:u.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(_,m){return m.filter(g=>!!_.find(S=>S.payloadType===g.payloadType&&!!S.rtcpFeedbacks.find(C=>C.type==="transport-cc")))}(c,s.attributes.payloads).forEach(_=>{_.rtcpFeedbacks.find(m=>m.type==="transport-cc")||_.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(e.twcc===!1){const u=s.attributes.extmaps.findIndex(h=>h.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u!==-1&&s.attributes.extmaps.splice(u,1),s.attributes.payloads.forEach(h=>{const _=h.rtcpFeedbacks.findIndex(m=>m.type==="transport-cc");_!==-1&&h.rtcpFeedbacks.splice(_,1)})}if(e.remb===!0){const u=o.find(h=>h.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");u&&(s.attributes.extmaps.find(_=>_.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||s.attributes.extmaps.push({entry:u.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(_,m){return m.filter(g=>!!_.find(S=>S.payloadType===g.payloadType&&!!S.rtcpFeedbacks.find(C=>C.type==="goog-remb")))}(c,s.attributes.payloads).forEach(_=>{_.rtcpFeedbacks.find(m=>m.type==="goog-remb")||_.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(e.remb===!1){const u=s.attributes.extmaps.findIndex(h=>h.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");u!==-1&&s.attributes.extmaps.splice(u,1),s.attributes.payloads.forEach(h=>{const _=h.rtcpFeedbacks.findIndex(m=>m.type==="goog-remb");_!==-1&&h.rtcpFeedbacks.splice(_,1)})}}function yE(s,e,i){if(Ln()||s.media.mediaType!=="video"||!(e instanceof ke)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!Q("SIMULCAST")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;const o=i==="vp8"?2:e._scalabilityMode.numSpatialLayers,c=s.attributes.ssrcs[0],u=s.attributes.ssrcGroups.find(_=>_.semantic==="FID"&&_.ssrcIds[0]===c.ssrcId),h={semantic:"SIM",ssrcIds:[c.ssrcId]};for(let _=1;_<o;_++)s.attributes.ssrcs.push({ssrcId:c.ssrcId+_,attributes:Jn(c.attributes)}),h.ssrcIds.push(c.ssrcId+_),u&&(s.attributes.ssrcs.push({ssrcId:u.ssrcIds[1]+_,attributes:Jn(c.attributes)}),s.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[c.ssrcId+_,u.ssrcIds[1]+_]}));s.attributes.ssrcGroups.unshift(h)}async function bg(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const o=(await i.createOffer()).sdp,{send:c,recv:u,sendrecv:h}=function(){let _=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},g=arguments.length>2?arguments[2]:void 0;const S=Ql(g,_,m,"sendonly"),C=Ql(g,_,m,"recvonly"),I={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},b={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},x={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(So(S,C,"videoExtensions",I,b,x),So(S,C,"videoCodecs",I,b,x),So(S,C,"audioExtensions",I,b,x),So(S,C,"audioCodecs",I,b,x),Q("RAISE_H264_BASELINE_PRIORITY")){const D=x.videoCodecs.findIndex(M=>{var K,z;return((K=M.rtpMap)===null||K===void 0?void 0:K.encodingName.toLocaleLowerCase())==="h264"&&((z=M.fmtp)===null||z===void 0?void 0:z.parameters["profile-level-id"])==="42001f"});if(D!==-1){const M=x.videoCodecs.findIndex(K=>{var z;return((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLocaleLowerCase())==="h264"});if(M<D){O.debug("raising H264 baseline profile priority");const K=x.videoCodecs[D];x.videoCodecs.splice(D,1),x.videoCodecs.splice(M,0,K)}M!==-1&&(b.videoCodecs=b.videoCodecs.filter(K=>{var z,nt;return!(((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLocaleLowerCase())==="h264"&&((nt=K.fmtp)===null||nt===void 0?void 0:nt.parameters["profile-level-id"])!=="42001f")})),M!==-1&&Q("FILTER_SEND_H264_BASELINE")&&(I.videoCodecs=I.videoCodecs.filter(K=>{var z,nt;return!(((z=K.rtpMap)===null||z===void 0?void 0:z.encodingName.toLocaleLowerCase())==="h264"&&((nt=K.fmtp)===null||nt===void 0?void 0:nt.parameters["profile-level-id"])!=="42001f")}))}}return{send:I,recv:b,sendrecv:x}}(s,e,o);try{i.close()}catch{}return{send:c,recv:u,sendrecv:h}}function Fc(){const s={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Ql(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(So(s,e,"videoExtensions",i,o,c),So(s,e,"videoCodecs",i,o,c),So(s,e,"audioExtensions",i,o,c),So(s,e,"audioCodecs",i,o,c),Q("RAISE_H264_BASELINE_PRIORITY")){const u=c.videoCodecs.findIndex(h=>h.rtpMap&&h.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&h.fmtp&&h.fmtp.parameters["profile-level-id"]==="42001f");if(u!==-1){const h=c.videoCodecs.findIndex(_=>_.rtpMap&&_.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(h<u){O.debug("raising H264 baseline profile priority");const _=c.videoCodecs[u];c.videoCodecs.splice(u,1),c.videoCodecs.splice(h,0,_)}h!==-1&&(o.videoCodecs=o.videoCodecs.filter(_=>!(_.rtpMap&&_.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&_.fmtp&&_.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:i,recv:o,sendrecv:c}}function So(s,e,i,o,c,u){if(i==="videoExtensions"||i==="audioExtensions"){const h=[];return s[i].forEach(_=>{e[i].some((m,g)=>{if(_.entry===m.entry&&_.extensionName===m.extensionName)return h.push(g),!0})?u[i].push(_):o[i].push(_)}),void e[i].forEach((_,m)=>{h.indexOf(m)===-1&&c[i].push(_)})}if(i==="videoCodecs"||i==="audioCodecs"){const h=[];return s[i].forEach(_=>{e[i].some((m,g)=>{if(_.payloadType===m.payloadType&&JSON.stringify(_)===JSON.stringify(m))return h.push(g),!0})?u[i].push(_):o[i].push(_)}),void e[i].forEach((_,m)=>{h.indexOf(m)===-1&&c[i].push(_)})}}function xp(s){const{send:e,recv:i,sendrecv:o}=s;if(!o){if(!e||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:i}}let c,u;return e?(c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c.audioCodecs=[...e.audioCodecs,...o.audioCodecs],c.videoCodecs=[...e.videoCodecs,...o.videoCodecs],c.audioExtensions=[...e.audioExtensions,...o.audioExtensions],c.videoExtensions=[...e.videoExtensions,...o.videoExtensions]):c=o,i?(u={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},u.audioCodecs=[...i.audioCodecs,...o.audioCodecs],u.videoCodecs=[...i.videoCodecs,...o.videoCodecs],u.audioExtensions=[...i.audioExtensions,...o.audioExtensions],u.videoExtensions=[...i.videoExtensions,...o.videoExtensions]):u=o,{send:c,recv:u}}function Rd(s){s.media.mediaType==="audio"&&s.attributes.payloads.filter(e=>{var i;return((i=e.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Zl(s){s.mediaDescriptions.forEach(e=>{e.media.mediaType!=="video"&&e.media.mediaType!=="audio"||e.attributes.payloads.forEach(i=>{i.rtcpFeedbacks.findIndex(o=>o.type==="rrtr")===-1&&i.rtcpFeedbacks.push({type:"rrtr"})})})}function su(s,e,i,o){let c=[];if(s===Xt.VIDEO){if(Q("H264_PROFILE_LEVEL_ID")&&o==="h264"&&(c=e.videoCodecs.filter(u=>{var h;return Jt(h=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(h,o)&&u&&u.fmtp&&u.fmtp.parameters["profile-level-id"]===Q("H264_PROFILE_LEVEL_ID")})),!Array.isArray(c)||c.length===0){let u=[];const h=[],_=[];i.videoCodecs.forEach(m=>{var g,S,C;Jt(g=m.rtpMap&&m.rtpMap.encodingName.toLowerCase()||"").call(g,o)&&u.push(m),Jt(S=m.rtpMap&&m.rtpMap.encodingName.toLowerCase()||"").call(S,"vp8")&&h.push(m),Jt(C=m.rtpMap&&m.rtpMap.encodingName.toLowerCase()||"").call(C,"h264")&&_.push(m)}),u.length===0&&(h.length!==0?(u=h,O.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: vp8"))):_.length!==0&&(u=_,O.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: h264")))),u.length!==0&&(c=e.videoCodecs.filter(m=>u.some(g=>g.payloadType===m.payloadType)))}if(Q("USE_PUB_RTX")){const u=c.map(_=>_.payloadType.toString()),h=e.videoCodecs.filter(_=>_.rtpMap&&_.rtpMap.encodingName==="rtx"&&Jt(u).call(u,_.fmtp&&_.fmtp.parameters.apt||""));c=[...c,...h]}c.length===0&&(O.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),c=e.videoCodecs)}else c=e.audioCodecs.filter(u=>{var h;return Jt(h=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(h,o)}),c.length===0&&(O.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),c=e.audioCodecs.filter(u=>{var h;return Jt(h=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(h,"opus")}));return c}let gC=class{get localCapabilities(){return Jn(this._localCapabilities)}get rtpCapabilities(){return Jn(this._rtpCapabilities)}get candidates(){return Jn(this._candidates)}get iceParameters(){return Jn(this._iceParameters)}get dtlsParameters(){return Jn(this._dtlsParameters)}constructor(s){A(this,"sessionDesc",void 0),A(this,"_localCapabilities",void 0),A(this,"_rtpCapabilities",void 0),A(this,"_candidates",void 0),A(this,"_iceParameters",void 0),A(this,"_dtlsParameters",void 0),A(this,"setup",void 0),A(this,"currentMidIndex",void 0),A(this,"cname","o/i14u9pJrxRKAsu"),A(this,"firefoxSsrcMidMap",new Map),s=Jn(s);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:o,remoteRTPCapabilities:c,localCapabilities:u,direction:h,setup:_,videoCodec:m,audioCodec:g}=s;let S;this.setup=_,S=h===is.RECEIVE_ONLY?ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=c,this._candidates=o,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=u;const C=h===is.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,I=h===is.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,b=h===is.RECEIVE_ONLY?c.send.videoCodecs:su(Xt.VIDEO,C,I,m),x=h===is.RECEIVE_ONLY?c.send.audioCodecs:su(Xt.AUDIO,C,I,g);for(const D of S.mediaDescriptions){if(D.attributes.iceUfrag=e.iceUfrag,D.attributes.icePwd=e.icePwd,D.attributes.fingerprints=i.fingerprints,D.attributes.candidates=o,D.attributes.setup=this.setup,D.media.mediaType==="application"&&(D.attributes.sctpPort="5000"),D.media.mediaType==="video"&&(D.media.fmts=b.map(M=>M.payloadType.toString(10)),D.attributes.payloads=b,D.attributes.extmaps=C.videoExtensions,Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:M,ssrcGroups:K}=ro([{ssrcId:4e4,rtx:Q("USE_SUB_RTX")?40001:void 0}],this.cname);D.attributes.ssrcs=M,D.attributes.ssrcGroups=K}if(D.media.mediaType==="audio"&&(D.media.fmts=x.map(M=>M.payloadType.toString(10)),D.attributes.payloads=x,D.attributes.extmaps=C.audioExtensions,Rd(D),Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:M,ssrcGroups:K}=ro([{ssrcId:2e4}],this.cname);D.attributes.ssrcs=M,D.attributes.ssrcGroups=K}}this.sessionDesc=S,this.currentMidIndex=S.mediaDescriptions.length-1}toString(){return ci.print(this.sessionDesc)}hasMid(s){return Array.isArray(s)?s.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===s)}send(s,e,i,o,c){i=i.replace(/ /g,"-");const{ssrcs:u,ssrcGroups:h}=ro(e,this.cname,Q("SYNC_GROUP")?i:void 0),_=this.findPreloadMediaDesc(u);if(_){if(Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,_.attributes.mid),c&&(c.twcc||c.remb)){const m=this.sessionDesc.mediaDescriptions.indexOf(_);return this.sessionDesc.mediaDescriptions[m]=this.mungSendMediaDesc(_,c),{mid:_.attributes.mid,needExchangeSDP:!0}}return{mid:_.attributes.mid,needExchangeSDP:!1}}{const m=this.findAvailableMediaIndex(s,u,o);let g;return m===-1?(g=this.createOrRecycleSendMedia(s,u,h,"sendonly",o,c),this.updateBundleMids()):(g=Jn(this.sessionDesc.mediaDescriptions[m]),g.attributes.direction="sendonly",g.attributes.ssrcs=u,g.attributes.ssrcGroups=h,this.sessionDesc.mediaDescriptions[m]=this.mungSendMediaDesc(g,c)),Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,g.attributes.mid),{needExchangeSDP:!0,mid:g.attributes.mid}}}stopSending(s){const e=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&s.indexOf(i.attributes.mid)!==-1);if(e.length!==s.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(i=>{i.attributes.ssrcs=[]}),this.updateBundleMids()}receive(s,e,i){const o=[];return s.forEach(c=>{const u=c._mediaStreamTrack.kind,h=this.findAvailableRecvMediaIndex(u);let _,m=!1;h===-1?(m=!0,_=this.createOrRecycleRecvMedia(c,[],"recvonly",e,i),this.updateBundleMids()):(_=Jn(this.sessionDesc.mediaDescriptions[h]),_.attributes.direction="recvonly"),o.push({mid:_.attributes.mid,needCreateTransceiver:m})}),o}stopReceiving(s){const e=this.sessionDesc.mediaDescriptions.filter(i=>s.indexOf(i.attributes.mid)!==-1);if(e.length!==s.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(s){const{foundation:e,protocol:i,address:o,port:c,type:u,relatedAddress:h,relatedPort:_,priority:m}=new RTCIceCandidate(s),g={foundation:e??"",componentId:"1",transport:i??"",priority:m?m+"":"",connectionAddress:o??"",port:c?c+"":"",type:u?u+"":"",relAddr:h??"",relPort:_?_+"":"",extension:{}};this.candidates.some(S=>S.priority===g.priority&&S.connectionAddress===g.connectionAddress&&S.port===g.port)||(this._candidates.push(g),this.sessionDesc.mediaDescriptions.forEach(S=>{S.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(s,e,i,o,c){const u=s._mediaStreamTrack.kind,h=this.rtpCapabilities.recv,_=su(u,h,this.localCapabilities.send,u===Xt.AUDIO?c:o),m=u===Xt.VIDEO?h.videoExtensions:h.audioExtensions,g="".concat(++this.currentMidIndex);let S={media:{mediaType:u,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:_.map(I=>I.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:m,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:_,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(g)}};S=this.mungRecvMediaDsec(S,s);const C=this.findFirstClosedMedia(u);if(C){const I=this.sessionDesc.mediaDescriptions.indexOf(C);this.sessionDesc.mediaDescriptions[I]=S}else this.sessionDesc.mediaDescriptions.push(S);return S}muteRemote(s){const e=this.sessionDesc.mediaDescriptions.filter(i=>Jt(s).call(s,i.attributes.mid||""));if(e.length!==s.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(s){const e=this.sessionDesc.mediaDescriptions.filter(i=>Jt(s).call(s,i.attributes.mid||""));if(e.length!==s.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="recvonly"})}findAvailableMediaIndex(s,e,i){return this.sessionDesc.mediaDescriptions.findIndex(o=>{const c=o.media.mediaType===s&&o.media.port!=="0"&&(o.attributes.direction==="sendonly"||o.attributes.direction==="sendrecv")&&o.attributes.ssrcs.length===0;if(Ln()){if(c){const u=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(u||o.attributes.mid!=="0"&&o.attributes.mid!=="1")||!(!u||u!==o.attributes.mid)}return!1}return c&&o.attributes.mid===i})}findAvailableRecvMediaIndex(s){return this.sessionDesc.mediaDescriptions.findIndex(e=>{const i=e.media.mediaType===s&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&i})}predictReceivingMids(s){const e=[];for(let i=0;i<s;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}restartICE(s){s=Jn(s),this._iceParameters=s,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=s.iceUfrag,e.attributes.icePwd=s.icePwd})}createOrRecycleSendMedia(s,e,i,o,c,u){const h=this.rtpCapabilities.send,_=s===Xt.VIDEO?h.videoCodecs:h.audioCodecs,m=s===Xt.VIDEO?h.videoExtensions:h.audioExtensions;Ln()&&(c="".concat(++this.currentMidIndex));let g={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:_.map(C=>C.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:m,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:_,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:o,rtcpMux:!0,rtcpRsize:!0,mid:c}};g=this.mungSendMediaDesc(g,u);const S=this.findFirstClosedMedia(s);if(S){const C=this.sessionDesc.mediaDescriptions.indexOf(S);this.sessionDesc.mediaDescriptions[C]=g}else this.sessionDesc.mediaDescriptions.push(g);return g}mungRecvMediaDsec(s,e,i){const o=Jn(s);return yg(o),so(o,e),Sd(o,e),Ag(o),IE(o,i,this.localCapabilities.send),o}mungSendMediaDesc(s,e){const i=Jn(s);return IE(i,e,this.localCapabilities.recv),Rd(i),i}updateRecvMedia(s,e){const i=this.sessionDesc.mediaDescriptions.findIndex(o=>o.attributes.mid===s);if(i!==-1){const o=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=o}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(s=>s.media.port!=="0").map(s=>s.attributes.mid)}findPreloadMediaDesc(s){return this.sessionDesc.mediaDescriptions.find(e=>{var i;return((i=e.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===s[0].ssrcId})}findFirstClosedMedia(s){return this.sessionDesc.mediaDescriptions.find(e=>Ln()?e.media.port==="0"&&e.media.mediaType===s:e.media.port==="0")}};const aG=["sdp"];function Qw(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function ou(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Qw(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Qw(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}let Ko=class KC extends nk{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,i;return(e=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,i,o){super(e,i),A(this,"direction",void 0),A(this,"name",void 0),A(this,"store",void 0),A(this,"spec",void 0),A(this,"peerConnection",void 0),A(this,"initialOffer",void 0),A(this,"transport",void 0),A(this,"statsFilter",void 0),A(this,"localCandidateCount",0),A(this,"allCandidatesReceived",!1),A(this,"localCandidateAddress",null),A(this,"useXR",Q("USE_XR")),A(this,"filter",{filterRTX:!Q("USE_PUB_RTX")&&!Q("USE_SUB_RTX"),filterVideoFec:Q("FILTER_VIDEO_FEC"),filterAudioFec:Q("FILTER_AUDIO_FEC")}),A(this,"extension",{useXR:this.useXR}),A(this,"_isInRestartIce",!1),A(this,"mutex",new Sr("P2PConnection-mutex")),A(this,"onLocalCandidate",void 0),A(this,"remoteSDP",void 0),A(this,"pendingCandidates",[]),A(this,"localCapabilities",void 0),A(this,"isReady",!1),A(this,"restartCnt",0),A(this,"curTurnServerIndex",0),this.store=i,this.spec=e,this.peerConnection=new RTCPeerConnection(KC.resolvePCConfiguration(e,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=o??is.SEND_ONLY,this.name=this.direction===is.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Ju(this.peerConnection,Q("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const i=await bg(this.filter,this.extension);if(this.localCapabilities=xp(i),e){const{sdp:o}=e,c=lC(e,aG),u=function(){const S={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},C=Ql(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),I={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},b={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},x={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(So(C,S,"videoExtensions",I,b,x),So(C,S,"videoCodecs",I,b,x),So(C,S,"audioExtensions",I,b,x),So(C,S,"audioCodecs",I,b,x),Q("RAISE_H264_BASELINE_PRIORITY")){const D=x.videoCodecs.findIndex(M=>M.rtpMap&&M.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&M.fmtp&&M.fmtp.parameters["profile-level-id"]==="42001f");if(D!==-1){const M=x.videoCodecs.findIndex(K=>K.rtpMap&&K.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(M<D){O.debug("raising H264 baseline profile priority");const K=x.videoCodecs[D];x.videoCodecs.splice(D,1),x.videoCodecs.splice(M,0,K)}M!==-1&&Q("FILTER_SEND_H264_BASELINE")&&(I.videoCodecs=I.videoCodecs.filter(K=>!(K.rtpMap&&K.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&K.fmtp&&K.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:I,recv:b,sendrecv:x}}(this.filter,this.extension,o);this.remoteSDP=new gC({remoteIceParameters:c.iceParameters,remoteDtlsParameters:c.dtlsParameters,candidates:[],remoteRTPCapabilities:u,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const h=await this.peerConnection.createAnswer();if(!h.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const _=Vc(h.sdp);await this.peerConnection.setLocalDescription(h);const m=await Fc(this.filter,this.extension,h.sdp);this.localCapabilities=xp(m);const g=this.peerConnection.getTransceivers()[0];return g!=null&&g.receiver&&g.receiver.transport&&this.tryBindTransportEvents(g.receiver.transport),ou(ou({},_),{},{sdp:h.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const o=await this.peerConnection.createOffer();if(!o.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const c=Vc(o.sdp);return this.initialOffer=o,ou(ou({},c),{},{sdp:o.sdp})}}catch(i){throw new ft(j.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:i,iceParameters:o,dtlsParameters:c}=e,u=await Fc(this.filter,this.extension,i);this.remoteSDP=new gC({remoteIceParameters:o,remoteDtlsParameters:c,candidates:[],remoteRTPCapabilities:u,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const h=this.peerConnection.getTransceivers()[0];h!=null&&h.sender&&h.sender.transport&&this.tryBindTransportEvents(h.sender.transport)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[])}catch(i){throw new ft(j.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(i.toString()))}}send(e,i,o){var c=this;return Wo(function*(){const u=yield Pe(c.mutex.lock("From P2PConnection.send"));try{if(!c.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const h=[],_=c.remoteSDP.receive(e,i,o);e.forEach((M,K)=>{if(_[K].needCreateTransceiver){const z=c.peerConnection.addTransceiver(M._mediaStreamTrack,{direction:"sendonly"});h.push(z),M._updateRtpTransceiver(z)}else{const z=c.peerConnection.getTransceivers().find(nt=>nt.mid===_[K].mid);if(!z)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(_[K].mid));h.push(z),M._updateRtpTransceiver(z)}}),Ln()&&Q("SIMULCAST")===!0&&(yield Pe(c.applySimulcastForFirefox(h,e)));const m=_.map(M=>M.mid),g=yield Pe(c.peerConnection.createOffer()),S=c.mungSendOfferSDP(g.sdp,e,m),C=ci.parse(S),I=m.map(M=>{const K=C.mediaDescriptions.find(z=>z.attributes.mid===M);if(!K)throw new Error("Cannot extract ssrc from mediaDescription.");return fC(K,Q("USE_PUB_RTX"))}),b=h.map((M,K)=>{const z=m[K];return{localSSRC:I[K],id:z}});yield Pe(c.peerConnection.setLocalDescription({type:"offer",sdp:S}));try{yield b}catch(M){const K=c.remoteSDP.toString();throw yield Pe(c.peerConnection.setLocalDescription({type:"offer",sdp:S})),yield Pe(c.peerConnection.setRemoteDescription({type:"answer",sdp:K})),yield Pe(c.stopSending(m,!0)),M}yield Pe(c.applySimulcastEncodings(h,e)),yield Pe(c.applySendEncodings(h,e));const x=c.remoteSDP.toString(),D=c.logSDPExchange(S,"offer","local","send");return D==null||D(x),yield Pe(c.setRemoteDescription({type:"answer",sdp:x})),h.map((M,K)=>{const z=m[K];return{localSSRC:I[K],id:z}})}catch(h){throw h instanceof ft?h:new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(h.toString()))}finally{u()}})()}async stopSending(e,i){const o=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const c=this.peerConnection.getTransceivers().filter(m=>e.indexOf(m.mid)!==-1);if(c.length!==e.length)throw new Error("Transceivers' length (".concat(c.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));c.map(m=>{var g;m.direction="inactive",(g=m.stop)===null||g===void 0||g.call(m)});const u=await this.peerConnection.createOffer(),h=this.logSDPExchange(u.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(u),this.remoteSDP.stopReceiving(e);const _=this.remoteSDP.toString();h==null||h(_),await this.setRemoteDescription({type:"answer",sdp:_})}catch(c){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(c.toString()))}finally{o&&o()}}async receive(e,i,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:h}=this.remoteSDP.send(e,i,o,c);if(h){const m=this.remoteSDP.toString(),g=this.logSDPExchange(m,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:m});const S=await this.peerConnection.createAnswer(),C=this.mungReceiveAnswerSDP(S.sdp,u,e);g==null||g(C||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:C}),O.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else O.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const _=this.peerConnection.getTransceivers().find(m=>m.mid===u);if(!_||_.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:_.receiver.track,mid:_.mid,transceiver:_}}catch(u){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async mockReceive(e,i,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:h}=this.remoteSDP.send(e,i,o,c);if(h){const _=this.remoteSDP.toString(),m=this.logSDPExchange(_,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:_});const g=await this.peerConnection.createAnswer(),S=this.mungReceiveAnswerSDP(g.sdp,u,e);m==null||m(S||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:S}),O.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else O.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(u){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===Uu.Auto&&(this.store.p2pTransport=Uu.SdRtn,sn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(KC.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,sn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(KC.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;const i=await this.peerConnection.createOffer({iceRestart:!0});if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:o}=Vc(i.sdp);return this.store.descriptionStart(),this.direction===is.SEND_ONLY&&await this.peerConnection.setLocalDescription(i),o}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===is.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const i=await this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:o}=Vc(i.sdp);return await this.peerConnection.setLocalDescription(i),o}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const u=this.remoteSDP.toString(),h=this.logSDPExchange(c,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),h==null||h(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new ft(j.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,i){const o=this.peerConnection.getTransceivers().filter(c=>c.mid===e);o.length===1&&(this.isVP8Simulcast(i)?Ln()||await this.applySimulcastEncodings(o,[i]):await this.applySendEncodings(o,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const o=this.peerConnection.getTransceivers().find(c=>c.mid===i);o&&await o.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const i=e[0].transport.iceTransport,{local:o,remote:c}=i.getSelectedCandidatePair();return{local:ou(ou({},ya),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port}),remote:ou(ou({},ya),{},{candidateType:c.type,protocol:c.protocol,address:c.address,port:c.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,i;Jt(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(i=this.onICEConnectionStateChange)===null||i===void 0||i.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var i;e.candidate.candidate&&(this.localCandidateAddress=e.candidate.address,(i=this.onLocalCandidate)===null||i===void 0||i.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else this.allCandidatesReceived=!0,O.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,i){let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const c={iceServers:[]};var u;return e.iceServers?c.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(N_(e.turnServer.servers)?c.iceServers=e.turnServer.servers:(c.iceServers&&c.iceServers.push(...KC.turnServerConfigToIceServers(e.turnServer.servers,i,o)),Q("USE_TURN_SERVER_OF_GATEWAY")&&c.iceServers&&e.turnServer.serversFromGateway&&c.iceServers.push(...KC.turnServerConfigToIceServers(e.turnServer.serversFromGateway,i,o)),Jt(u=[Uu.Relay,Uu.SdRtn]).call(u,i)&&(c.iceTransportPolicy="relay"),Q("FORCE_TURN_TCP")?c.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(h=>{h.forceturn&&(c.iceTransportPolicy="relay")}))),Q("ENABLE_ENCODED_TRANSFORM")&&sn().supportWebRTCEncodedTransform&&(c.encodedInsertableStreams=!0),O.debug("P2PConnection p2pTransport is ".concat(i)),c}static turnServerConfigToIceServers(e,i){let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const c=[],u=e.filter(_=>_.tcpport);O.debug("P2PConnection turnServers is ".concat(u,", current index is ").concat(o));const h=u.length>o?u[o]:u[0];switch(i){case Uu.SdRtn:const _=e.filter(g=>{var S;return Jt(S=g.username).call(S,"glb:")&&g.turnServerURL==g.turnServerURL}),m=_.length>o?_[o]:_[0];m&&(c.push({username:m.username,credential:m.password,credentialType:"password",urls:"turn:".concat(qt(m.turnServerURL),":").concat(m.tcpport,"?transport=udp")}),c.push({username:m.username,credential:m.password,credentialType:"password",urls:"turns:".concat(qt(m.turnServerURL),":").concat(m.tcpport,"?transport=tcp")}));break;case Uu.Relay:h&&(c.push({username:h.username,credential:h.password,credentialType:"password",urls:"turn:".concat(h.turnServerURL,":").concat(h.tcpport,"?transport=udp")}),c.push({username:h.username,credential:h.password,credentialType:"password",urls:"turns:".concat(qt(h.turnServerURL),":").concat(h.tcpport,"?transport=tcp")}));break;default:h&&(c.push({username:h.username,credential:h.password,credentialType:"password",urls:"turn:".concat(h.turnServerURL,":").concat(h.tcpport,"?transport=udp")}),c.push({username:h.username,credential:h.password,credentialType:"password",urls:"turns:".concat(qt(h.turnServerURL),":").concat(h.tcpport,"?transport=tcp")}),c.push({username:h.username,credential:h.password,credentialType:"password",urls:"stun:".concat(h.turnServerURL,":").concat(h.tcpport)}))}return c}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var o;e!=null&&e.state&&((o=this.onDTLSTransportStateChange)===null||o===void 0||o.call(this,e.state))},e.onerror=o=>{var c;(c=this.onDTLSTransportError)===null||c===void 0||c.call(this,"error"in o?o.error:o)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const o=e==null?void 0:e.iceTransport.state;var c;o&&((c=this.onICETransportStateChange)===null||c===void 0||c.call(this,o))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:o,remote:c}=i.getSelectedCandidatePair();O.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol}),", remote ").concat(JSON.stringify({candidateType:c.type,protocol:c.protocol,address:c.address,port:c.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var o;if(i||(i=this.peerConnection.getSenders().find(S=>S.track===e._mediaStreamTrack)),!i)return O.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return O.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!sn().supportSetRtpSenderParameters)return O.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const c={},u={};switch(e._optimizationMode){case"motion":c.degradationPreference="maintain-framerate";break;case"detail":c.degradationPreference="maintain-resolution";break;default:c.degradationPreference="balanced"}if(e._encoderConfig){var h;const{bitrateMax:S,frameRate:C,scaleResolutionDownBy:I}=e._encoderConfig;S&&(u.maxBitrate=1e3*S),Jt(h=e._hints).call(h,Fn.LOW_STREAM)&&(C&&(u.maxFramerate=_t(C)),I&&I>=1&&(u.scaleResolutionDownBy=I))}if(Q("DSCP_TYPE")&&Du()){var _;const S=Q("DSCP_TYPE");Jt(_=["very-low","low","medium","high"]).call(_,S)&&(u.networkPriority=S)}const m=i.getParameters(),g=(o=m.encodings)===null||o===void 0?void 0:o[0];Ln()&&!g&&(c.encodings=[u]),g&&Object.assign(g,u),Object.assign(m,c),O.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(m.encodings))),await i.setParameters(m)}async applySendEncodings(e,i){try{if(!sn().supportSetRtpSenderParameters||e.length!==i.length)return;for(let o=0;o<e.length;o++){const c=e[o],u=i[o];u instanceof ke&&!this.isVP8Simulcast(u)&&await this.updateRtpSenderEncodings(u,c.sender)}}catch{O.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,i,o){const c=ci.parse(e);return i.forEach((u,h)=>{const _=o[h],m=c.mediaDescriptions.find(g=>g.attributes.mid===_);m&&(so(m,u),yE(m,u,this.store.codec))}),ci.print(c)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,i,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let m=0;m<e.length;m++){var o,c,u,h,_;const g=e[m],S=i[m];if(S instanceof ke&&!Jt(o=S._hints).call(o,Fn.LOW_STREAM)&&(c=S._encoderConfig)!==null&&c!==void 0&&c.bitrateMax&&((u=S._encoderConfig)===null||u===void 0?void 0:u.bitrateMax)>200&&(h=S._scalabilityMode)!==null&&h!==void 0&&h.numSpatialLayers&&((_=S._scalabilityMode)===null||_===void 0?void 0:_.numSpatialLayers)>1&&this.store.codec==="vp8"){const C={},I={high:1e3*(S._encoderConfig.bitrateMax-50),medium:5e4};C.encodings=[{rid:"m",active:!0,maxBitrate:I.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:I.high}];const b=g.sender.getParameters();await g.sender.setParameters(Object.assign(b,C))}}}async applySimulcastEncodings(e,i){if(!Ln()&&e.length===i.length)for(let o=0;o<e.length;o++){const c=i[o];if(c instanceof ke&&this.isVP8Simulcast(c)){const u=e[o],h={},_={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:_.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:_.medium,scaleResolutionDownBy:4}];const m=u.sender.getParameters();await u.sender.setParameters(Object.assign(m,h))}}}isVP8Simulcast(e){var i,o,c,u,h;return!!(e instanceof ke&&Q("SIMULCAST")&&this.store.codec==="vp8"&&!Jt(i=e._hints).call(i,Fn.LOW_STREAM)&&(o=e._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((c=e._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)>200&&(u=e._scalabilityMode)!==null&&u!==void 0&&u.numSpatialLayers&&((h=e._scalabilityMode)===null||h===void 0?void 0:h.numSpatialLayers)>1)}logSDPExchange(e,i,o,c){if(Q("SDP_LOGGING"))return O.upload("[".concat(this.store.clientId,"] exchanging ").concat(o," ").concat(i," SDP during P2PConnection.").concat(c,`
`),e),i==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(h=>h.mid&&e.indexOf(h.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(h=>{h.direction="inactive"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.muteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.setRemoteDescription({type:"answer",sdp:u})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(h=>h.mid&&e.indexOf(h.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async h=>{h.direction="sendonly"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.unmuteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.setRemoteDescription({type:"answer",sdp:u})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}async getRemoteSSRC(e,i){var o,c;if(i=(o=i)!==null&&o!==void 0?o:(c=this.currentRemoteDescription)===null||c===void 0?void 0:c.sdp){var u;const h=(u=ci.parse(i).mediaDescriptions.find(_=>_.attributes.mid===e))===null||u===void 0?void 0:u.attributes.ssrcs;return h==null?void 0:h[0].ssrcId}}async setRemoteDescription(e){var i;await this.peerConnection.setRemoteDescription(e),Jt(i=["connected","completed"]).call(i,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,i,o){const c=ci.parse(e),u=c.mediaDescriptions.find(h=>h.attributes.mid===i);return u&&(o===Xt.AUDIO&&u.media.mediaType==="audio"&&Rd(u),this.useXR&&Zl(c)),ci.print(c)}};function Yo(s,e,i){const o=s[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const c=this.mutex,u=await c.lock("From P2PConnection.".concat(e));try{for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];return await o.apply(this,_)}finally{u()}},i}function wg(s,e){let i=document.createElement("video"),o=document.createElement("canvas");i.setAttribute("style","display:none"),o.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),o.width=_t(e.width),o.height=_t(e.height);const c=_t(e.framerate||15);document.body.append(i),document.body.append(o);let u=s._mediaStreamTrack;i.srcObject=new MediaStream([u]),i.play();const h=o.getContext("2d");if(!h)throw new st(j.UNEXPECTED_ERROR,"can not get canvas context");const _=sn(),m=o.captureStream(_.supportRequestFrame?0:c).getVideoTracks()[0];m.canvas||(m.canvas=o),o.startCapture=()=>{if(!i)return o.stopCapture&&o.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const S=i.videoWidth,C=i.videoHeight/S,I=o.width*C;Math.abs(I-o.height)>=2&&(O.debug("adjust low stream resolution","".concat(o.width,"x").concat(o.height," -> ").concat(o.width,"x").concat(I)),o.height=I)}h.drawImage(i,0,0,o.width,o.height),m.requestFrame&&m.requestFrame(),u!==s._mediaStreamTrack&&(u=s._mediaStreamTrack,i.srcObject=new MediaStream([u]))},o.stopCapture=pi(()=>o.startCapture&&o.startCapture(),c);const g=m.stop;return m.stop=()=>{g.call(m),i&&(i.remove(),i.srcObject=null,i=null),o&&(o.width=0,o.remove(),o.stopCapture&&o.stopCapture(),o.startCapture=void 0,o.stopCapture=void 0,o=null),O.debug("clean low stream renderer")},m}var Og,TC,Ir,Xu,ds,$l,Zw,Cd,dc,th,Vs;Tt([Yo,V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Ko.prototype,"establish",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Ko.prototype,"connect",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[String,Array,String,String]),V("design:returntype",ut)],Ko.prototype,"receive",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[String,Array,String,String]),V("design:returntype",ut)],Ko.prototype,"mockReceive",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ko.prototype,"stopReceiving",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Ko.prototype,"restartICE",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Ko.prototype,"close",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],Ko.prototype,"updateEncoderConfig",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],Ko.prototype,"updateSendParameters",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[os,String]),V("design:returntype",ut)],Ko.prototype,"replaceTrack",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ko.prototype,"muteLocal",null),Tt([Yo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ko.prototype,"unmuteLocal",null),function(s){s[s.HEIGHT=2033]="HEIGHT",s[s.FRAME_RATE=2034]="FRAME_RATE",s[s.WIDTH=2035]="WIDTH"}(Og||(Og={})),function(s){s[s.HEIGHT=2072]="HEIGHT",s[s.FRAME_RATE=2074]="FRAME_RATE",s[s.WIDTH=2076]="WIDTH"}(TC||(TC={})),function(s){s[s.FRAME_RATE=2002]="FRAME_RATE",s[s.WIDTH=2003]="WIDTH",s[s.HEIGHT=2004]="HEIGHT",s[s.PACKAGE_LOST=2005]="PACKAGE_LOST",s[s.AVG_ENCODE=2007]="AVG_ENCODE",s[s.NACKS=2009]="NACKS",s[s.PLIS=2010]="PLIS",s[s.FIRS=2011]="FIRS",s[s.BITRATE=2012]="BITRATE",s[s.PACKAGE_RATE=2031]="PACKAGE_RATE",s[s.ADAPTATION=2032]="ADAPTATION",s[s.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",s[s.BANDWIDTH=2061]="BANDWIDTH",s[s.RETRANSMIT=2062]="RETRANSMIT",s[s.TARGET_ENCODED=2064]="TARGET_ENCODED",s[s.TRANSMIT=2066]="TRANSMIT",s[s.FREEZE=2082]="FREEZE",s[s.DISABLED=2095]="DISABLED",s[s.PLAYER_STATUS=2128]="PLAYER_STATUS",s[s.QP_SUM=2143]="QP_SUM"}(Ir||(Ir={})),function(s){s[s.BITRATE=2069]="BITRATE",s[s.PACKAGE_LOST=2070]="PACKAGE_LOST",s[s.PACKAGE_RATE=2071]="PACKAGE_RATE",s[s.HEIGHT=2073]="HEIGHT",s[s.FRAME_RATE=2075]="FRAME_RATE",s[s.WIDTH=2077]="WIDTH"}(Xu||(Xu={})),function(s){s[s.JITTER=-1]="JITTER",s[s.PACKAGE_LOST=2014]="PACKAGE_LOST",s[s.WIDTH=2018]="WIDTH",s[s.HEIGHT=2019]="HEIGHT",s[s.FRAME_RATE=2020]="FRAME_RATE",s[s.JITTER_BUFFER=2023]="JITTER_BUFFER",s[s.CURRENT_DELAY=2024]="CURRENT_DELAY",s[s.NACKS=2026]="NACKS",s[s.PLIS=2027]="PLIS",s[s.FIRS=2028]="FIRS",s[s.BITRATE=2029]="BITRATE",s[s.PACKAGE_RATE=2078]="PACKAGE_RATE",s[s.FREEZE=2084]="FREEZE",s[s.DISABLED=2101]="DISABLED",s[s.PLAYER_STATUS=2129]="PLAYER_STATUS",s[s.QP_SUM=2144]="QP_SUM",s[s.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(ds||(ds={})),function(s){s[s.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",s[s.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",s[s.FREEZE_TIME=2109]="FREEZE_TIME",s[s.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}($l||($l={})),function(s){s[s.PCM_LEVEL=2104]="PCM_LEVEL"}(Zw||(Zw={})),function(s){s[s.PACKAGE_LOST=-1]="PACKAGE_LOST",s[s.LEVEL=2038]="LEVEL",s[s.BITRATE=2039]="BITRATE",s[s.PACKAGE_RATE=2040]="PACKAGE_RATE",s[s.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",s[s.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",s[s.FREEZE=2081]="FREEZE",s[s.DISABLED=2096]="DISABLED"}(Cd||(Cd={})),function(s){s[s.BITRATE=2044]="BITRATE",s[s.PACKAGE_LOST=2045]="PACKAGE_LOST",s[s.PACKAGE_RATE=2046]="PACKAGE_RATE",s[s.CURRENT_DELAY=2047]="CURRENT_DELAY",s[s.JITTER_BUFFER=2054]="JITTER_BUFFER",s[s.JITTER=2055]="JITTER",s[s.FREEZE=2083]="FREEZE",s[s.DISABLED=2102]="DISABLED",s[s.PCM_LEVEL=2105]="PCM_LEVEL",s[s.PLAYER_STATUS=2130]="PLAYER_STATUS",s[s.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(dc||(dc={})),function(s){s[s.FREEZE_TIME=-1]="FREEZE_TIME",s[s.LEVEL=2043]="LEVEL"}(th||(th={})),function(s){s[s.RTT=2006]="RTT",s[s.CONN_TYPE=801]="CONN_TYPE"}(Vs||(Vs={}));const uc=1e3,eh=3;function Ve(s,e,i){i!=null&&Number.isFinite(i)&&(s[e]=Math.round(Math.max(0,i)))}function $w(s){const e={[Vs.CONN_TYPE]:0,[Vs.RTT]:s.rtt};switch(s.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=s.selectedCandidatePair.localCandidate.relayProtocol;i==="udp"&&(e[Vs.CONN_TYPE]=1),i==="tcp"&&(e[Vs.CONN_TYPE]=3),i==="tls"&&(e[Vs.CONN_TYPE]=4);break}case"srflx":e[Vs.CONN_TYPE]=2}return e}class tO extends oi{constructor(e){super(),A(this,"store",void 0),A(this,"uploadWRTCStatsTimer",void 0),A(this,"uploadOutboundDenoiserStatsTimer",void 0),A(this,"uploadExtStatsTimer",void 0),A(this,"uploadExtUsageStatsTimer",void 0),A(this,"uploadInboundExtStatsTimer",void 0),A(this,"requestStats",void 0),A(this,"requestTransportStats",void 0),A(this,"requestLocalMedia",void 0),A(this,"requestRemoteMedia",void 0),A(this,"requestAllTracks",void 0),A(this,"requestVideoIsReady",void 0),A(this,"requestUploadStats",void 0),A(this,"requestUpload",void 0),A(this,"uploadOutboundStarted",!1),A(this,"uploadInboundStarted",!1),A(this,"uploadTransportStarted",!1),A(this,"uploadExtensionUsageStarted",!1),A(this,"lastRecvStats",void 0),A(this,"lastSendStats",void 0),A(this,"lastFullRecvStats",void 0),A(this,"lastFullSendStats",void 0),A(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let i,o;if(this.uploadTransportStarted&&(i=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!i&&this.uploadOutboundStarted&&(i=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),i||o){const c={};if(this.uploadTransportStarted&&i){const u=this.getTransportStats(i,o,e);u&&(c.misc=[u])}if(this.uploadOutboundStarted&&i){const u=this.getOutboundStats(i,e?this.lastSendStats:this.lastFullSendStats,e);u&&(c.outbound=[u])}if(this.uploadInboundStarted&&o){const u=this.getInboundStats(o,e?this.lastRecvStats:this.lastFullRecvStats,e);u&&(c.inbound=u)}this.requestUploadStats(c)}this.lastRecvStats=o,this.lastSendStats=i,e||(this.lastFullRecvStats=o,this.lastFullSendStats=i)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==eh),++e===eh+1&&(e=1)},uc)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,i,o){if(!this.requestStats)return;if(o)return e.rtt==null?void 0:{addition:{[Vs.RTT]:e.rtt,[Vs.CONN_TYPE]:void 0}};const c=$w(e);if(this.store.useP2P){if(i){const u=$w(i);c[Vs.CONN_TYPE]+=u[Vs.CONN_TYPE]<<3}c[Vs.CONN_TYPE]+=110}else c[Vs.CONN_TYPE]+=100;return{addition:c}}getOutboundStats(e,i,o){if(!this.requestUploadStats||!this.requestLocalMedia)return;const c=this.requestLocalMedia();if(!c||c.length===0)return;let u,h,_;return c.forEach(m=>{let[g,{track:S,ssrcs:C}]=m;switch(g){case yt.LocalVideoLowTrack:case yt.LocalVideoTrack:if(g===yt.LocalVideoTrack){const I=function(D,M,K,z,nt){const dt=M.videoSend.find(bt=>bt.ssrc===D);if(!dt)return;const it={},{sentFrame:at,inputFrame:ht}=dt;if(ht&&at){const bt=ht.frameRate,kt=at.frameRate;it[Ir.FREEZE]=function(Ne,Ge){let Qn=!0;return Qn=!(Ne<=5)&&(Ne<=10?Ge<3:Ne<=20?Ge<4:Ge<5),Qn}(bt,kt)?1:0}if(Ve(it,Ir.QP_SUM,dt.qpSumPerFrame),nt)return it;switch(at&&(Ve(it,Ir.HEIGHT,at.height),Ve(it,Ir.WIDTH,at.width),Ve(it,Ir.FRAME_RATE,at.frameRate)),it[Ir.DISABLED]=z._originMediaStreamTrack&&!z._originMediaStreamTrack.enabled||z._mediaStreamTrack&&!z._mediaStreamTrack.enabled?1:0,dt.adaptionChangeReason){case"none":it[Ir.ADAPTATION]=0;break;case"cpu":it[Ir.ADAPTATION]=1;break;case"bandwidth":it[Ir.ADAPTATION]=2;break;case"other":it[Ir.ADAPTATION]=3}it[Ir.PLAYER_STATUS]=CR[z._player?z._player.videoElementStatus:"uninit"],Ve(it,Ir.NACKS,dt.nacksCount),Ve(it,Ir.PLIS,dt.plisCount),Ve(it,Ir.FIRS,dt.firsCount),Ve(it,Ir.AVG_ENCODE,dt.avgEncodeMs);const pt=K&&K.videoSend.find(bt=>bt.ssrc===D);if(pt){let bt=nt?uc:uc*eh;pt.timestamp&&dt.timestamp&&(bt=dt.timestamp-pt.timestamp),pt.packets!=null&&dt.packets!=null&&Ve(it,Ir.PACKAGE_RATE,1e3*(dt.packets-pt.packets)/bt),dt.packetsLost!=null&&pt.packetsLost!=null&&Ve(it,Ir.PACKAGE_LOST,dt.packetsLost-pt.packetsLost),pt.bytes!=null&&dt.bytes!=null&&Ve(it,Ir.BITRATE,8*(dt.bytes-pt.bytes)/bt)}return it}(C[0].ssrcId,e,i,S,o),b=o?null:function(D,M,K){const z=M.videoSend.find(pt=>pt.ssrc===D);if(!z)return null;const nt={},dt=z.inputFrame,it=dt&&dt.height||K&&K._videoHeight||0,at=dt&&dt.width||K&&K._videoWidth||0,ht=dt&&dt.frameRate||0;return Ve(nt,Og.HEIGHT,it),Ve(nt,Og.WIDTH,at),Ve(nt,Og.FRAME_RATE,ht),nt}(C[0].ssrcId,e,S),x=o?null:function(D){const M={};return Ve(M,Ir.RETRANSMIT,D.bitrate.retransmit),Ve(M,Ir.TARGET_ENCODED,D.bitrate.targetEncoded),Ve(M,Ir.ACTUAL_ENCODED,D.bitrate.actualEncoded),Ve(M,Ir.TRANSMIT,D.bitrate.transmit),Ve(M,Ir.BANDWIDTH,D.sendBandwidth),M}(e);h=Object.assign({},I,b,x)}else _=o?void 0:function(I,b,x){const D=b.videoSend.find(z=>z.ssrc===I);if(!D)return;const M={},K=D.sentFrame;if(K&&(Ve(M,Xu.HEIGHT,K.height),Ve(M,Xu.WIDTH,K.width),Ve(M,Xu.FRAME_RATE,K.frameRate)),x){const z=x.videoSend.find(nt=>nt.ssrc===I);if(z){let nt=uc*eh;z.timestamp&&D.timestamp&&(nt=D.timestamp-z.timestamp),z.packets!=null&&D.packets!=null&&Ve(M,Xu.PACKAGE_RATE,1e3*(D.packets-z.packets)/nt),D.packetsLost!=null&&z.packetsLost!=null&&Ve(M,Xu.PACKAGE_LOST,D.packetsLost-z.packetsLost),z.bytes!=null&&D.bytes!=null&&Ve(M,Xu.BITRATE,8*(D.bytes-z.bytes)/nt)}}return M}(C[0].ssrcId,e,i);break;case yt.LocalAudioTrack:u=o?void 0:function(I,b,x,D){const M=b.audioSend.find(it=>it.ssrc===I);if(!M)return;const K={};K[Cd.DISABLED]=D._originMediaStreamTrack&&!D._originMediaStreamTrack.enabled||D._mediaStreamTrack&&!D._mediaStreamTrack.enabled?1:0;const z=D._source.getAccurateVolumeLevel(),nt=M.inputLevel;Ve(K,Cd.LEVEL,100*(nt??z)),Ve(K,Zw.PCM_LEVEL,100*z),Ve(K,Cd.AEC_RETURN_LOSS,M.aecReturnLoss),Ve(K,Cd.AEC_RETURN_LOSS_ENH,M.aecReturnLossEnhancement),K[Cd.FREEZE]=0;const dt=x&&x.audioSend.find(it=>it.ssrc===I);if(dt){let it=uc*eh;dt.timestamp&&M.timestamp&&(it=M.timestamp-dt.timestamp),dt.bytes!=null&&M.bytes!=null&&Ve(K,Cd.BITRATE,8*(M.bytes-dt.bytes)/it),dt.packets!=null&&M.packets!=null&&Ve(K,Cd.PACKAGE_RATE,1e3*(M.packets-dt.packets)/it)}return K}(C[0].ssrcId,e,i,S)}}),{high:h,low:_,audio:u}}getInboundStats(e,i,o){if(!this.requestRemoteMedia)return;const c=this.requestRemoteMedia()||[],u=[];return c.forEach(h=>{let[_,m]=h;const g={peer:_.uid};if(m.has(Xt.VIDEO)&&_.videoTrack){const S=_._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(_._videoSSRC)||!1,C=_.videoTrack?function(I,b,x,D,M,K,z){const nt=b.videoRecv.find(bt=>bt.ssrc===I);if(!nt)return;const dt={},{receivedFrame:it,outputFrame:at,decodeFrameRate:ht}=nt,pt=x&&x.videoRecv.find(bt=>bt.ssrc===I);if(dt[ds.FREEZE]=M&&Pr.isRemoteVideoFreeze(D,nt,pt)?1:0,Ve(dt,$l.FRAME_RATE_DECODE,ht),Ve(dt,ds.QP_SUM,nt.qpSumPerFrame),nt.framesRateFirefox&&Ve(dt,ds.FRAME_RATE,nt.framesRateFirefox),it&&Ve(dt,ds.FRAME_RATE,it.frameRate),pt){const bt=b.timestamp-x.timestamp||(z?uc:eh*uc);nt.packetsLost!=null&&pt.packetsLost!=null&&Ve(dt,ds.PACKAGE_LOST,nt.packetsLost-pt.packetsLost),pt.bytes!=null&&nt.bytes!=null&&Ve(dt,ds.BITRATE,8*(nt.bytes-pt.bytes)/bt),pt.packets!=null&&nt.packets!=null&&Ve(dt,ds.PACKAGE_RATE,1e3*(nt.packets-pt.packets)/bt)}if(z)return dt;if(it?(Ve(dt,ds.HEIGHT,it.height),Ve(dt,ds.WIDTH,it.width)):D&&(Ve(dt,ds.HEIGHT,D._videoHeight||0),Ve(dt,ds.WIDTH,D._videoWidth||0)),at&&Ve(dt,$l.FRAME_RATE_RENDER,at.frameRate),Ve(dt,ds.JITTER_BUFFER,nt.jitterBufferMs),Ve(dt,ds.CURRENT_DELAY,nt.currentDelayMs),Ve(dt,ds.FIRS,nt.firsCount),Ve(dt,ds.NACKS,nt.nacksCount),Ve(dt,ds.PLIS,nt.plisCount),D){dt[ds.DISABLED]=D._originMediaStreamTrack.enabled&&D._mediaStreamTrack.enabled?0:1;const bt=D._player;if(bt){const{freezeTimeCounterList:kt,renderFreezeAccTime:Ne}=bt;if(kt&&kt.length>0&&Ve(dt,$l.FREEZE_TIME,kt.splice(0,1)[0]),K&&qa.visibility==="visible"){const Ge=Math.min(6e3,Ne);bt.renderFreezeAccTime=Math.max(0,Ne-Ge),Ve(dt,$l.FREEZE_TIME_RENDER,Ge)}}}if(dt[ds.PLAYER_STATUS]=CR[D._player?D._player.videoElementStatus:"uninit"],pt&&nt.totalInterFrameDelay!==void 0&&nt.totalSquaredInterFrameDelay!==void 0&&pt.totalInterFrameDelay!==void 0&&pt.totalSquaredInterFrameDelay!==void 0){const bt=nt.totalInterFrameDelay-pt.totalInterFrameDelay,kt=nt.totalSquaredInterFrameDelay-pt.totalSquaredInterFrameDelay,Ne=nt.framesDecodeCount-pt.framesDecodeCount,Ge=bt/Ne*1e3,Qn=Math.round(1e3*Math.sqrt((kt-Math.pow(bt,2)/Ne)/Ne));!isNaN(Qn)&&Ge+Qn>Math.max(3*Ge,Ge+150)&&(dt[ds.I_FRAME_DELAY]=Qn)}return dt}(_._videoSSRC,e,i,_.videoTrack,S===!0,this.needUploadRenderFreezeTime,o):void 0;C&&(g.video=C)}if(m.has(Xt.AUDIO)&&_.audioTrack){const S=_.audioTrack?function(C,I,b,x,D){const M=I.audioRecv.find(bt=>bt.ssrc===C);if(!M)return;const K={},z=b&&b.audioRecv.find(bt=>bt.ssrc===C),{receivedFrames:nt,droppedFrames:dt}=M;var it,at;if(Ve(K,dc.JITTER,M.jitterMs),nt!=null&&dt!=null&&(K[dc.FREEZE]=(at=dt,(it=nt)===0||100*at/it>20?1:0)),z){const bt=I.timestamp-b.timestamp||(D?uc:uc*eh);M.packets!=null&&z.packets!=null&&Ve(K,dc.PACKAGE_RATE,1e3*(M.packets-z.packets)/bt),z.bytes!=null&&M.bytes!=null&&Ve(K,dc.BITRATE,8*(M.bytes-z.bytes)/bt),M.packetsLost!=null&&z.packetsLost!=null&&Ve(K,dc.PACKAGE_LOST,M.packetsLost-z.packetsLost)}if(D)return K;const ht=x._source.getAccurateVolumeLevel(),pt=M.outputLevel;if(Ve(K,th.LEVEL,100*(pt??ht)),Ve(K,dc.PCM_LEVEL,100*ht),x&&(K[dc.DISABLED]=x._originMediaStreamTrack.enabled&&x._mediaStreamTrack.enabled?0:1),Ve(K,dc.JITTER_BUFFER,M.jitterBufferMs),Ve(K,dc.CURRENT_DELAY,M.jitterBufferMs),K[dc.PLAYER_STATUS]=CR[Qs.getPlayerState(x.getTrackId())],z){const bt=M.concealedSamples-z.concealedSamples;bt>0&&Ve(K,dc.CONCEALED_SAMPLES,bt)}return K}(_._audioSSRC,e,i,_.audioTrack,o):void 0;S&&(g.audio=S)}(g.video||g.audio)&&u.push(g)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,u}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find(i=>i instanceof wl);if(e&&e._external.getDenoiserStats){const i=e._external.getDenoiserStats();i&&this.requestUpload(rd.DENOISER_STATS,i)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[i,o]=e;o.has(Xt.VIDEO)&&i.videoTrack&&i.videoTrack.getProcessorStats().forEach(c=>{this.requestUpload&&this.requestUpload(c.type,c.stats)}),o.has(Xt.AUDIO)&&i.audioTrack&&i.audioTrack.getProcessorStats().forEach(c=>{this.requestUpload&&this.requestUpload(c.type,c.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const i=Date.now(),o={connectionInterval:Q("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:i};let c=[];const u=this.requestAllTracks&&this.requestAllTracks()||[];for(const g of u)!g.muted&&g.enabled&&(c=c.concat(await g.getProcessorUsage()));const h=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[g,S]of h)S.has(Xt.VIDEO)&&g.videoTrack&&(c=c.concat(await g.videoTrack.getProcessorUsage())),S.has(Xt.AUDIO)&&g.audioTrack&&(c=c.concat(await g.audioTrack.getProcessorUsage()));if(c.length===0)return;o.details=function(g,S){const C={};for(const{id:D,value:M,level:K,direction:z}of g){var I;const nt=(I=S.get(D))!==null&&I!==void 0?I:0,dt=M===2?nt+Q("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:nt;var b,x;S.set(D,dt),C[D]?(M===2&&(C[D].value=M),K>C[D].level&&(C[D].level=K),z==="remote"&&(C[D].remoteUidCount+=1),C[D].totalTs=(b=S.get(D))!==null&&b!==void 0?b:0):C[D]={value:M,level:K,remoteUidCount:z==="local"?0:1,totalTs:(x=S.get(D))!==null&&x!==void 0?x:0}}return Object.keys(C).map(D=>{const{level:M,value:K,totalTs:z}=C[D];return{id:D,level:M,value:K,totalTs:z}})}(c,e);const _=Date.now(),m=_>i?_:i+1;this.requestUpload&&this.requestUpload(rd.EXTENSION_USAGE_STATS,{usageStats:o,sendTs:m})},Q("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class Zr{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,i){A(this,"uid",void 0),A(this,"_uintid",void 0),A(this,"_trust_in_room_",!0),A(this,"_trust_audio_enabled_state_",!0),A(this,"_trust_video_enabled_state_",!0),A(this,"_trust_audio_mute_state_",!0),A(this,"_trust_video_mute_state_",!0),A(this,"_audio_muted_",!1),A(this,"_video_muted_",!1),A(this,"_audio_enabled_",!0),A(this,"_video_enabled_",!0),A(this,"_audio_added_",!1),A(this,"_video_added_",!1),A(this,"_is_pre_created",!1),A(this,"_video_pre_subscribed",!1),A(this,"_audio_pre_subscribed",!1),A(this,"_trust_video_stream_added_state_",!0),A(this,"_trust_audio_stream_added_state_",!0),A(this,"_audioTrack",void 0),A(this,"_videoTrack",void 0),A(this,"_dataChannels",[]),A(this,"_audioSSRC",void 0),A(this,"_videoSSRC",void 0),A(this,"_audioOrtc",void 0),A(this,"_videoOrtc",void 0),A(this,"_cname",void 0),A(this,"_rtxSsrcId",void 0),A(this,"_videoMid",void 0),A(this,"_audioMid",void 0),this.uid=e,this._uintid=i}}var lc;function n1(s,e){var i;let o;switch(e){case yt.LocalAudioTrack:o=rn.Audio;break;case yt.LocalVideoTrack:o=Jt(i=s._hints).call(i,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalVideoLowTrack:o=rn.Low}return o}function SC(s){const e=sn();if(s.some(i=>i._bypassWebAudio))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function eO(s,e){SC(s);const i=new pr;return s.forEach(o=>i.addAudioTrack(o)),i}function i1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Ng(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?i1(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):i1(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}(function(s){s.SEND_ONLY="SEND_ONLY",s.RECEIVE_ONLY="RECEIVE_ONLY"})(lc||(lc={}));class _r extends oi{get state(){return this._state}set state(e){const i=this._state;this._state=e,this.emit(_e.StateChange,i,this._state)}constructor(e,i){super(),A(this,"store",void 0),A(this,"statsUploader",void 0),A(this,"sendConnection",void 0),A(this,"recvConnection",void 0),A(this,"localTrackMap",new Map),A(this,"remoteUserMap",new Map),A(this,"localDataChannels",[]),A(this,"pendingLocalTracks",[]),A(this,"pendingRemoteTracks",[]),A(this,"statsCollector",void 0),A(this,"dtlsFailedCount",0),A(this,"sendMutex",new Sr("P2PChannel2-send-mutex")),A(this,"recvMutex",new Sr("P2PChannel2-recv-mutex")),A(this,"_state",En.Disconnected),A(this,"_restartStates",["disconnected","failed"]),A(this,"reconnectInterval",void 0),A(this,"uploadUnplinkStarted",!1),A(this,"uploadDownlinkStarted",!1),A(this,"uplinkStateUploadInterval",void 0),A(this,"downlinkStatsUploadInterval",void 0),A(this,"handleMuteLocalTrack",async(o,c,u)=>{const h=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==En.Connected)return void u(new ft(j.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const g=this.filterTobeMutedTracks(o);if(g.length===0)return void c();const S=g.find(x=>x[0]==="videoLowTrack");S&&S[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(g.map(x=>{let[,{id:D}]=x;return D}));let C=!1;var _,m;o.trackMediaType==="video"?C=!((_=this.localTrackMap.get(yt.LocalAudioTrack))===null||_===void 0||!_.track._muted):C=((m=this.localTrackMap.get(yt.LocalVideoTrack))===null||m===void 0?void 0:m.id)===void 0;const I=this.createMuteMessage(g);await kn(this,_e.RequestMuteLocal,I);const b=o.trackMediaType==="video"?Ic.MUTE_LOCAL_VIDEO:Ic.MUTE_LOCAL_AUDIO;await kn(this,_e.RequestP2PMuteLocal,{action:b,message:I,isMuteAll:C}),c()}catch(g){u(g)}finally{h()}}),A(this,"handleUnmuteLocalTrack",async(o,c,u)=>{const h=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==En.Connected)return void u(new ft(j.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const _=this.filterTobeUnmutedTracks(o);if(_.length===0)return void c();await this.sendConnection.unmuteLocal(_.map(S=>{let[,{id:C}]=S;return C}));const m=this.createUnmuteMessage(_),g=o.trackMediaType==="video"?Ic.UNMUTE_LOCAL_VIDEO:Ic.UNMUTE_LOCAL_AUDIO;await kn(this,_e.RequestP2PMuteLocal,{action:g,message:m}),c()}catch(_){u(_)}finally{h()}}),A(this,"handleUpdateVideoEncoder",async(o,c,u)=>{const h=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const _=this.localTrackMap.get(yt.LocalVideoTrack);if(!this.sendConnection||!_||_.track!==o||this.state!==En.Connected)return void c();const{id:m,track:g}=_;m&&(await this.sendConnection.updateSendParameters(m,g),await this.sendConnection.updateEncoderConfig(m,g),this.emit(_e.UpdateVideoEncoder,g)),c()}catch(_){u(_)}finally{h()}}),A(this,"handleSetOptimizationMode",async(o,c,u)=>{const h=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const _=this.localTrackMap.get(yt.LocalVideoTrack);if(!this.sendConnection||!_||_.track!==o||this.state!==En.Connected)return;const{id:m,track:g}=_;m&&await this.sendConnection.updateSendParameters(m,g),c()}catch(_){u(_)}finally{h()}}),A(this,"handleReplaceTrack",async(o,c,u,h)=>{let _;O.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(o.getTrackId(),"]")),typeof h=="boolean"&&h||(_=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var m;const S=Array.from(this.localTrackMap.entries()).find(C=>{let[,{track:I}]=C;return o===I});if(!this.sendConnection||!S||S[1].id===void 0||this.state!==En.Connected)return void c();if(await((m=this.sendConnection)===null||m===void 0?void 0:m.replaceTrack(o,S[1].id)),S[0]===yt.LocalVideoTrack&&sn().supportDualStreamEncoding){const C=this.localTrackMap.get(yt.LocalVideoLowTrack);if(C){const I=o._mediaStreamTrack.clone();C.track._originMediaStreamTrack.stop(),C.track._mediaStreamTrack=I,C.track._originMediaStreamTrack=I,await new ut((b,x)=>{this.handleReplaceTrack(C.track,b,x,!0)})}}c()}catch(S){u(S)}finally{var g;(g=_)===null||g===void 0||g()}}),A(this,"handleGetLocalVideoStats",o=>{o(this.statsCollector.getLocalVideoTrackStats())}),A(this,"handleGetLocalAudioStats",o=>{o(this.statsCollector.getLocalAudioTrackStats())}),A(this,"handleGetRemoteVideoStats",o=>this.statsCollector.getRemoteVideoTrackStats(o.uid)[o.uid]),A(this,"handleGetRemoteAudioStats",o=>this.statsCollector.getRemoteAudioTrackStats(o.uid)[o.uid]),this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new tO(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(o=>{o&&(o.iceConnectionState!=="disconnected"&&o.iceConnectionState!=="failed"||this.handleDisconnect(o.direction))})},Q("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,i){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,i,o,c,u,h){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,i){let o;try{if(i){this.recvConnection&&(O.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),o=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new Ko(e,this.store,is.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const c=await this.recvConnection.establish(i);return{iceParameters:c.iceParameters,dtlsParameters:c.dtlsParameters,sdp:c.sdp}}{this.state=En.New,this.sendConnection&&(O.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),o=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new Ko(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const c=await this.sendConnection.establish();return{iceParameters:c.iceParameters,dtlsParameters:c.dtlsParameters,sdp:c.sdp}}}finally{o&&o()}}async p2pConnect(e){if(!this.sendConnection)throw new ft(j.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=En.Connected}async addRemoteCandidate(e,i){if(i===is.RECEIVE_ONLY){if(!this.sendConnection)throw new ft(j.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new ft(j.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,i,o){var c=this;return Wo(function*(){const u=yield Pe(c.sendMutex.lock("From P2PChannel.publish"));try{if(!c.sendConnection||c.state!==En.Connected){c.throwIfTrackTypeNotMatch(e);const S=e.filter(C=>c.pendingLocalTracks.indexOf(C)===-1);return void(c.pendingLocalTracks=c.pendingLocalTracks.concat(S))}c.store.pubId=c.store.pubId+1,cs.markPublishStart(c.store.clientId,c.store.pubId);const h=c.filterTobePublishedTracks(e,i,o);if(h.length===0)return void(yield Pe(c.tryToUnmuteAudio(e)));h.forEach(S=>{let{track:C,type:I}=S;const b=Date.now();c.store.publish(C.getTrackId(),I===yt.LocalAudioTrack?"audio":"video",b)}),c.bindLocalTrackEvents(h);const _=yield Pe(c.sendConnection.send(h.map(S=>{let{track:C}=S;return C}),c.store.codec,c.store.audioCodec)),m=(yield Pe(_.next())).value,g=c.createGatewayPublishMessage(h,m);try{yield g}catch(S){throw _.throw(S),(S==null?void 0:S.code)===j.WS_ABORT&&h.forEach(C=>{let{track:I}=C;c.pendingLocalTracks.indexOf(I)===-1&&c.pendingLocalTracks.push(I)}),c.unbindLocalTrackEvents(h),S}yield Pe(_.next()),h.forEach(S=>{let{type:C}=S;c.statsCollector.addLocalStats(C)}),c.statsUploader.startUploadOutboundStats(),c.assignLocalTracks(h,m),h.forEach(S=>{let{track:C,type:I}=S;const b=Date.now();c.store.publish(C.getTrackId(),I===yt.LocalAudioTrack?"audio":"video",void 0,b)}),c.startUploadUplinkState()}finally{u()}})()}async unpublish(e){if(!this.sendConnection||this.state!==En.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(u=>!Jt(e).call(e,u)));const i=this.filterTobeUnpublishedTracks(e);if(i.length===0)return;const o=i.find(u=>u[0]==="videoLowTrack");o&&o[1].track.close();const c=this.createGatewayUnpublishMessage(i);if(await this.sendConnection.stopSending(i.map(u=>{let[,{id:h}]=u;return h})),this.withdrawLocalTracks(i),this.unbindLocalTrackEvents(i.map(u=>{let[h,{track:_}]=u;return{type:h,track:_}})),i.forEach(u=>{let[h]=u;this.statsCollector.removeLocalStats(h)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===En.Connected)return o&&o[1].track.close(),c;e.forEach(u=>{const h=this.pendingLocalTracks.indexOf(u);h!==-1&&this.pendingLocalTracks.splice(h,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const i=[],o=[];Array.from(this.localTrackMap.entries()).forEach(c=>{let[u,{track:h,ssrcs:_}]=c;const m={stream_type:n1(h,u),ssrcs:_};h._muted||!h._enabled?i.push(m):o.push(m)}),i.length>0&&i.forEach(c=>{kn(this,_e.RequestMuteLocal,[c])}),o.length>0&&o.forEach(c=>{kn(this,_e.RequestUnmuteLocal,[c])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return Wo(function*(){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(O.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await zi(this,_e.RequestRePublish,this.pendingLocalTracks),this.emit(_e.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,i,o,c){var u;if(!this.recvConnection)throw new ft(j.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((u=this.remoteUserMap.get(e))!==null&&u!==void 0&&u.has(i))return;const{track:h,mid:_,transceiver:m}=await this.recvConnection.receive(i,[{ssrcId:o}],String(e.uid),c);i===Xt.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(h):(e._audioTrack=new ue(h,e.uid,e._uintid,this.store),O.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),m&&e._audioTrack._updateRtpTransceiver(m),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=o,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(h):(e._videoTrack=new fe(h,e.uid,e._uintid,this.store),O.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),m&&e._videoTrack._updateRtpTransceiver(m),this.bindRemoteTrackEvents(e,e._videoTrack));const g=this.remoteUserMap.get(e);g?g.set(i,_):this.remoteUserMap.set(e,new Map([[i,_]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const S=this.pendingRemoteTracks.findIndex(C=>{let{user:I,kind:b}=C;return I.uid===e.uid&&i===b});S!==-1&&(this.pendingRemoteTracks.splice(S,1),this.emit(_e.MediaReconnectEnd,e.uid))}async mockSubscribe(e,i,o,c){if(!this.recvConnection)throw new ft(j.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(i,[{ssrcId:o}],String(e.uid),c)}async unsubscribe(e,i,o){const c=this.pendingRemoteTracks.filter(h=>{let{user:_,kind:m}=h;return i!==void 0?_.uid===e.uid&&i===m:_.uid===e.uid});if(c.forEach(h=>{const _=this.pendingRemoteTracks.indexOf(h);this.pendingRemoteTracks.splice(_,1)}),this.recvConnection||o||c.forEach(h=>{let{kind:_}=h;var m;if(_===Xt.AUDIO)(m=e._audioTrack)===null||m===void 0||m._destroy(),e._audioTrack=void 0;else if(_===Xt.VIDEO){var g;(g=e._videoTrack)===null||g===void 0||g._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;const u=this.filterTobeUnSubscribedTracks(e,i);u.length!==0&&(await this.recvConnection.stopReceiving(u.map(h=>{let[,{id:_}]=h;return _})),this.withdrawRemoteTracks(u),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),u.forEach(h=>{let[_,{kind:m}]=h;var g,S;if(m===Xt.VIDEO&&_._videoSSRC&&((g=this.recvConnection)===null||g===void 0||g.setStatsRemoteVideoIsReady(_._videoSSRC,!1)),m===Xt.VIDEO)this.unbindRemoteTrackEvents(_._videoTrack),o||((S=_._videoTrack)===null||S===void 0||S._destroy(),_._videoTrack=void 0);else if(m===Xt.AUDIO){var C;this.unbindRemoteTrackEvents(_._audioTrack),!o&&((C=_._audioTrack)===null||C===void 0||C._destroy(),_._audioTrack=void 0)}}),u.forEach(h=>{let[,{kind:_}]=h;kn(this,_e.RequestP2PMuteRemote,_)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach(i=>{let[,o]=i;[Xt.VIDEO,Xt.AUDIO].forEach(c=>{o.has(c)?kn(this,_e.RequestP2PUnmuteRemote,c):kn(this,_e.RequestP2PMuteRemote,c)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new ft(j.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,i){if(!this.recvConnection)return;const o=this.remoteUserMap.get(e);if(!o)return void O.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!o.get(i))return void O.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const c=i===Xt.VIDEO?e._videoSSRC:e._audioSSRC;c!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(c,!1)}async unmuteRemote(e,i){return this.unmuteRemoteNoLock(e,i)}async unmuteRemoteNoLock(e,i){if(!this.recvConnection)return;const o=this.remoteUserMap.get(e);if(!o)return void O.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));o.get(i)||O.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const i=this.localTrackMap.get(yt.LocalAudioTrack);if((i==null?void 0:i.track)instanceof pr){const o=i.track;return Array.from(this.localTrackMap.entries()).filter(c=>{let[u]=c;return u!==yt.LocalAudioTrack}).filter(c=>{let[u]=c;return!(e&&u===yt.LocalVideoLowTrack)}).map(c=>{let[,{track:u}]=c;return u}).concat(o.trackList)}return Array.from(this.localTrackMap.entries()).filter(o=>{let[c]=o;return!(e&&c===yt.LocalVideoLowTrack)}).map(o=>{let[,{track:c}]=o;return c})}reportPublishEvent(e,i,o,c,u){if(e){const _=this.localTrackMap.get(yt.LocalAudioTrack),m=c?this.localTrackMap.get(yt.LocalVideoLowTrack):this.localTrackMap.get(yt.LocalVideoTrack);ne.publish(this.store.sessionId,{eventElapse:cs.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:i,audioName:_==null?void 0:_.track.getTrackLabel(),videoName:m==null?void 0:m.track.getTrackLabel(),screenshare:(m==null?void 0:m.track._hints.indexOf(Fn.SCREEN_TRACK))!==-1,audio:!!_,video:!!m,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}else{var h;o||(o=[]);const _=o.find(g=>g instanceof Nn),m=c?(h=this.localTrackMap.get(yt.LocalVideoTrack))===null||h===void 0?void 0:h.track:o.find(g=>g instanceof ke);ne.publish(this.store.sessionId,{eventElapse:cs.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:i,audioName:_==null?void 0:_.getTrackLabel(),videoName:m==null?void 0:m.getTrackLabel(),screenshare:(m==null?void 0:m._hints.indexOf(Fn.SCREEN_TRACK))!==-1,audio:!!_,video:!!m,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}}reportSubscribeEvent(e,i,o,c){const u=c===Xt.VIDEO?o._videoSSRC:o._audioSSRC;u&&ne.subscribe(this.store.sessionId,{succ:e,ec:i,video:c===Xt.VIDEO,audio:c===Xt.AUDIO,peerid:o.uid,subscribeRequestid:c===Xt.VIDEO?o._videoSSRC:o._audioSSRC,p2pid:this.store.p2pId,eventElapse:cs.measureFromSubscribeStart(this.store.clientId,u)})}reset(){O.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Sr("P2PChannel2-send-mutex"),this.sendMutex=new Sr("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(yt.LocalAudioTrack);if((e==null?void 0:e.track)instanceof pr){if(e.track.trackList.length>0){const i=e.track;e.track.trackList.forEach(o=>{i.removeAudioTrack(o)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=En.Disconnected}getStats(e){var i,o;return e?(o=this.recvConnection)===null||o===void 0?void 0:o.getStats():(i=this.sendConnection)===null||i===void 0?void 0:i.getStats()}getRemoteVideoIsReady(e){var i;return((i=this.recvConnection)===null||i===void 0?void 0:i.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(yt.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(yt.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const i=this.localTrackMap.get(e);return i&&i.track instanceof ke||i&&i.track instanceof Nn?i.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,i){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!i||o.has(i))}async hasRemoteMediaWithLock(e,i){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!i||o.has(i))}getRemoteMedia(e){var i;const o=Array.from(lo(i=this.remoteUserMap).call(i)).find(c=>c.uid===e);return o?{audioTrack:o.audioTrack,audioSSRC:o._audioSSRC,videoTrack:o.videoTrack,videoSSRC:o._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(o=>{let[c]=o;return{uid:c.uid,level:c.audioTrack?100*c.audioTrack._source.getAccurateVolumeLevel():0}});const i=this.localTrackMap.get(yt.LocalAudioTrack);return i&&e.push({level:100*i.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=l_(e).call(e,(o,c)=>o.level-c.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(O.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=En.Reconnecting,Q("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[i]=e;var o;i._videoTrack&&i._videoTrack._player&&((o=i._videoTrack._player.getVideoElement())===null||o===void 0||o.pause(),i._videoTrack._player.isKeepLastFrame=!0,i._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var i;let[o,{track:c}]=e;switch(o){case yt.LocalVideoTrack:Jt(i=c._hints).call(i,Fn.LOW_STREAM)?c.close():this.pendingLocalTracks.push(c);break;case yt.LocalAudioTrack:c instanceof pr?this.pendingLocalTracks=this.pendingLocalTracks.concat(c.trackList):this.pendingLocalTracks.push(c)}}),this.emit(_e.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[i,o]=e;Array.from(lo(o).call(o)).forEach(c=>{this.setPendingRemoteMedia(i,c)}),this.emit(_e.MediaReconnectStart,i.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),O.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,i){for(const o of this.pendingRemoteTracks){const{user:c,kind:u}=o;if((e instanceof Zr?e.uid:e)===c.uid&&i===u)return!0}return!1}setPendingRemoteMedia(e,i){this.hasPendingRemoteMedia(e,i)||this.pendingRemoteTracks.push({user:e,kind:i})}async restartICE(e,i){let o,c;if(e===is.SEND_ONLY){if(!this.sendConnection)throw new ft(j.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");o=await this.sendMutex.lock("From P2PChannel.restartICE"),c=this.sendConnection}else{if(!this.recvConnection)throw new ft(j.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");o=await this.recvMutex.lock("From P2PChannel.restartICE"),c=this.recvConnection}try{if(i){const u=await c.restartICE(i);return c.isInRestartIce=!1,u}{const u=await c.restartICE();if(u){const h=await zi(this,_e.RequestP2PRestartICE,{direction:is.RECEIVE_ONLY,iceParameter:u});await c.restartICE(h),c.isInRestartIce=!1}}}finally{o()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),i=this.localTrackMap.get(yt.LocalVideoTrack),o=this.localTrackMap.get(yt.LocalAudioTrack),c=e.videoSend.find(x=>{var D;return x.ssrc===(i==null||(D=i.ssrcs)===null||D===void 0?void 0:D[0].ssrcId)}),u=e.audioSend.find(x=>{var D;return x.ssrc===(o==null||(D=o.ssrcs)===null||D===void 0?void 0:D[0].ssrcId)});if(!c||!u)return 1;const h=ko(this,_e.NeedSignalRTT),_=c?c.rttMs:void 0,m=u?u.rttMs:void 0,g=_&&m?(_+m)/2:_||m,S=(g&&h?(g+h)/2:g||h)||0,C=100*e.sendPacketLossRate*.7/50+.3*S/1500,I=C<.17?1:C<.36?2:C<.59?3:C<.1?4:5,b=i==null?void 0:i.track;if(b&&b._encoderConfig&&b._hints.indexOf(Fn.SCREEN_TRACK)===-1){const x=b._encoderConfig.bitrateMax,D=e.bitrate.actualEncoded;if(x&&D){const M=(1e3*x-D)/(1e3*x);return XL[M<.15?0:M<.3?1:M<.45?2:M<.6?3:4][I]}}return I}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let i=0;return Array.from(this.remoteUserMap.entries()).forEach(o=>{let[c]=o;const u=c._audioSSRC,h=c._videoSSRC,_=e.audioRecv.find(D=>D.ssrc===u),m=e.videoRecv.find(D=>D.ssrc===h);if(!_&&!m)return void(i+=1);const g=ko(this,_e.NeedSignalRTT),S=e.rtt,C=(S&&g?(S+g)/2:S||g)||0,I=_?_.jitterMs:void 0,b=e.recvPacketLossRate;let x=.7*b*100/50+.3*C/1500;I&&(x=.6*b*100/50+.2*C/1500+.2*I/400),i+=x<.1?1:x<.17?2:x<.36?3:x<.59?4:5}),this.remoteUserMap.size>0?Math.round(i/this.remoteUserMap.size):i}async muteLocalTrack(e){return new ut((i,o)=>{this.handleMuteLocalTrack(e,i,o)})}filterTobePublishedTracks(e,i,o){const c=[],u=sn(),h=this.getAllTracks();e=zh(e=e.filter(g=>h.indexOf(g)===-1));let _=!1,m=!1;for(const g of e){if(g instanceof ke&&(this.localTrackMap.has(yt.LocalVideoTrack)||_?new ft(j.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(c.push({track:g,type:yt.LocalVideoTrack}),_=!0),i)){const S=this.getLowVideoTrack(g,o);c.push({track:S,type:yt.LocalVideoLowTrack})}if(g instanceof Nn){const S=this.localTrackMap.get(yt.LocalAudioTrack);if(S){if(!(S.track instanceof pr))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(g._bypassWebAudio)throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");S.track.addAudioTrack(g),this.bindLocalAudioTrackEvents(g,!0)}else if(m){const C=c.find(I=>{let{type:b}=I;return b===yt.LocalAudioTrack});if(!(C.track instanceof pr))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(g._bypassWebAudio)throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");C.track.addAudioTrack(g)}else{if(!u.webAudioMediaStreamDest||g instanceof pr||g._bypassWebAudio)c.push({track:g,type:yt.LocalAudioTrack});else{const C=new pr;C.addAudioTrack(g),c.push({track:C,type:yt.LocalAudioTrack})}m=!0}}}return c}filterTobeUnpublishedTracks(e){const i=[],o=this.getAllTracks();e=zh(e=e.filter(c=>o.indexOf(c)!==-1));for(const c of e){if(c instanceof Nn){const u=this.localTrackMap.get(yt.LocalAudioTrack);if(!u)continue;u.track instanceof pr?(u.track.removeAudioTrack(c),this.unbindLocalAudioTrackEvents(c),u.track.trackList.length===0&&(i.push([yt.LocalAudioTrack,u]),u.track.close())):i.push([yt.LocalAudioTrack,u])}if(c instanceof ke){const u=this.localTrackMap.get(yt.LocalVideoTrack);if(!u)continue;i.push([yt.LocalVideoTrack,u]);const h=this.localTrackMap.get(yt.LocalVideoLowTrack);h&&i.push([yt.LocalVideoLowTrack,h])}}return i}bindLocalTrackEvents(e){e.forEach(i=>{let{track:o,type:c}=i;switch(c){case yt.LocalVideoTrack:o.addListener(Vt.GET_STATS,this.handleGetLocalVideoStats),o.addListener(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(Vt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.addListener(Vt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.addListener(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.addListener(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case yt.LocalAudioTrack:this.bindLocalAudioTrackEvents(o)}})}bindLocalAudioTrackEvents(e,i){e instanceof pr?e.trackList.forEach(o=>{o.addListener(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(Vt.GET_STATS,this.handleGetLocalAudioStats),o.addListener(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(Vt.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),i||e.addListener(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(i=>{let[o,{track:c}]=i;return{track:c,type:o}})),e.forEach(i=>{let{track:o,type:c}=i;switch(c){case yt.LocalVideoTrack:o.off(Vt.GET_STATS,this.handleGetLocalVideoStats),o.off(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.off(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.off(Vt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.off(Vt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.off(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.off(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.off(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case yt.LocalAudioTrack:this.unbindLocalAudioTrackEvents(o)}})}unbindLocalAudioTrackEvents(e){e instanceof pr?e.trackList.forEach(i=>{i.off(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(Vt.GET_STATS,this.handleGetLocalAudioStats),i.off(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(Vt.GET_STATS,this.handleGetLocalAudioStats),e.off(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,i){i instanceof fe&&i.addListener(Vt.GET_STATS,o=>{o(this.handleGetRemoteVideoStats(e))}),i instanceof ue&&i.addListener(Vt.GET_STATS,o=>{o(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Vt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[i,o]=e;o.has(Xt.AUDIO)&&this.unbindRemoteTrackEvents(i._audioTrack),o.has(Xt.VIDEO)&&this.unbindRemoteTrackEvents(i._videoTrack)})}createGatewayPublishMessage(e,i){return e.map((o,c)=>{var u;let h,{track:_,type:m}=o;switch(m){case yt.LocalAudioTrack:h=rn.Audio;break;case yt.LocalVideoTrack:h=Jt(u=_._hints).call(u,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalVideoLowTrack:h=rn.Low}return{kind:m===yt.LocalAudioTrack?Xt.AUDIO:Xt.VIDEO,stream_type:h,mid:i[c].id,ssrcs:i[c].localSSRC,isMuted:_.muted||!_.enabled}})}createGatewayUnpublishMessage(e){return e.map(i=>{var o;let c,[u,{track:h,ssrcs:_,id:m}]=i;switch(u){case yt.LocalVideoTrack:c=Jt(o=h._hints).call(o,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalAudioTrack:c=rn.Audio;break;case yt.LocalVideoLowTrack:c=rn.Low}return{stream_type:c,ssrcs:_,mid:m}})}assignLocalTracks(e,i){e.forEach((o,c)=>{let{track:u,type:h}=o;this.localTrackMap.set(h,{track:u,id:i[c].id,ssrcs:i[c].localSSRC})})}withdrawLocalTracks(e){e.forEach(i=>{let[o]=i;this.localTrackMap.delete(o)})}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{var o;O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(i,")")),this.emit(_e.PeerConnectionStateChange,i),i!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),i==="connected"&&(e.isInRestartIce=!1),Jt(o=this._restartStates).call(o,i)&&!e.isInRestartIce&&(i==="disconnected"&&await Mr(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=i=>{i!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(i,")")),ne.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:i,tag:gi.TRACER}).onSuccess(),this.emit(_e.IceConnectionStateChange,i)},e.onICETransportStateChange=i=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(i,")"))},e.onDTLSTransportStateChange=i=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(i,")"))},e.onDTLSTransportError=i=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(i,")"))},e.onFirstAudioDecoded=i=>{var o;const c=Array.from(lo(o=this.remoteUserMap).call(o)).find(h=>h._audioSSRC===i);var u;c&&(this.store.subscribe(c.uid,"audio",void 0,void 0,void 0,Date.now()),(u=c.audioTrack)===null||u===void 0||u.emit(on.FIRST_FRAME_DECODED),ne.firstRemoteFrame(this.store.sessionId,Rr.FIRST_AUDIO_DECODE,ei.FIRST_AUDIO_DECODE,{peer:c._uintid,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=i=>{var o;const c=Array.from(lo(o=this.remoteUserMap).call(o)).find(u=>u._audioSSRC===i);c&&ne.firstRemoteFrame(this.store.sessionId,Rr.FIRST_AUDIO_RECEIVED,ei.FIRST_AUDIO_RECEIVED,{peer:c._uintid,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(i,o,c)=>{this.reportVideoFirstFrameDecoded(i,o,c)},e.onFirstVideoReceived=i=>{var o;const c=Array.from(lo(o=this.remoteUserMap).call(o)).find(u=>u._videoSSRC===i);c&&ne.firstRemoteFrame(this.store.sessionId,Rr.FIRST_VIDEO_RECEIVED,ei.FIRST_VIDEO_RECEIVED,{peer:c._uintid,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(i,o)=>{const c=i.candidateType==="relay",u=o.candidateType==="relay";o.candidateType!=="unknown"&&c===u||this.emit(_e.ConnectionTypeChange,c),O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(mo(o))," -> ").concat(JSON.stringify(mo(i)),")"))},e.onSelectedRemoteCandidateChanged=(i,o)=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(mo(o))," -> ").concat(JSON.stringify(mo(i)),")"))},e.onFirstVideoDecodedTimeout=i=>{this.reportVideoFirstFrameDecoded(i,void 0,void 0,!0)},e.onLocalCandidate=i=>{this.emit(_e.LocalCandidate,{candidate:i,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const i=e===is.SEND_ONLY?this.sendConnection:this.recvConnection;i&&!i.isInRestartIce&&(i.isInRestartIce=!0,O.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(i.name,"] start use restartICE")),e===is.SEND_ONLY?this.restartICE(e):zi(this,_e.RequestP2PRestartICE,{direction:is.SEND_ONLY}))}filterTobeMutedTracks(e){const i=[];if(this.getAllTracks().indexOf(e)===-1)return i;const o=this.localTrackMap.get(yt.LocalAudioTrack);if(e instanceof Nn&&(o==null?void 0:o.track)instanceof pr)return o.track.isActive||i.push([yt.LocalAudioTrack,o]),i;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:h}]=u;return e===h});if(c&&(i.push(c),c[0]===yt.LocalVideoTrack)){const u=this.localTrackMap.get(yt.LocalVideoLowTrack);u&&i.push([yt.LocalVideoLowTrack,u])}return i}filterTobeUnmutedTracks(e){const i=[],o=this.localTrackMap.get(yt.LocalAudioTrack);if(e instanceof Nn&&(o==null?void 0:o.track)instanceof pr)return o.track.isActive&&i.push([yt.LocalAudioTrack,o]),i;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:h}]=u;return e===h});if(c)if(c[0]===yt.LocalVideoTrack){i.push(c);const u=this.localTrackMap.get(yt.LocalVideoLowTrack);u&&i.push([yt.LocalVideoLowTrack,u])}else i.push(c);return i}createMuteMessage(e){return e.map(i=>{var o;let c,[u,{track:h,ssrcs:_,id:m}]=i;switch(u){case yt.LocalAudioTrack:c=rn.Audio;break;case yt.LocalVideoTrack:c=Jt(o=h._hints).call(o,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalVideoLowTrack:c=rn.Low}return{stream_type:c,ssrcs:_,mid:m}})}createUnmuteMessage(e){return e.map(i=>{var o;let c,[u,{track:h,ssrcs:_,id:m}]=i;switch(u){case yt.LocalAudioTrack:c=rn.Audio;break;case yt.LocalVideoTrack:c=Jt(o=h._hints).call(o,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalVideoLowTrack:c=rn.Low}return{stream_type:c,ssrcs:_,mid:m}})}filterTobeUnSubscribedTracks(e,i){const o=[],c=this.remoteUserMap.get(e);if(!c)return o;if(i){const u=c.get(i);if(!u)return o;o.push([e,{kind:i,id:u}])}else Array.from(c.entries()).forEach(u=>{let[h,_]=u;o.push([e,{kind:h,id:_}])});return o}createUnsubscribeMessage(e){const i=[];return e.forEach(o=>{let[c,{kind:u,id:h}]=o;switch(u){case Xt.VIDEO:return void(c._videoSSRC&&i.push({stream_type:Xt.VIDEO,ssrcId:c._videoSSRC}));case Xt.AUDIO:return void(c._audioSSRC&&i.push({stream_type:Xt.AUDIO,ssrcId:c._audioSSRC}))}}),i}withdrawRemoteTracks(e){e.forEach(i=>{let[o,{kind:c}]=i;const u=this.remoteUserMap.get(o);u&&(u.delete(c),Array.from(u.entries()).length===0&&this.remoteUserMap.delete(o))})}async updateBitrateLimit(e){const i=this.localTrackMap.get(yt.LocalVideoTrack),o=this.localTrackMap.get(yt.LocalVideoLowTrack);i&&await i.track.setBitrateLimit(e.uplink),o&&e.low_stream_uplink&&await o.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,i=this.recvConnection.peerConnectionState;return e!=="connected"&&i!=="connected"}return!0}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof Nn){const o=this.filterTobeUnmutedTracks(e[i]);if(o.length===0)continue;const c=this.createUnmuteMessage(o);return void await kn(this,_e.RequestUnmuteLocal,c)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:i}]=e;return!!i}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var i;return!((i=this.recvConnection)===null||i===void 0||!i.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,i)=>this.emit(_e.RequestUpload,e,i),this.statsUploader.requestUploadStats=e=>this.emit(_e.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Mr($m(this.dtlsFailedCount,nr)),this.emit(_e.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(yt.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof ke)}throwIfTrackTypeNotMatch(e){if(e.filter(i=>i instanceof ke).length>1)throw new ft(j.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(i=>i instanceof Nn).length>1&&(e.some(i=>i instanceof Nn&&i._bypassWebAudio)||!sn().webAudioMediaStreamDest))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const i of e){if(i instanceof ke&&this.pendingLocalTracks.some(o=>o instanceof ke))throw new ft(j.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(i instanceof Nn&&this.pendingLocalTracks.some(o=>o instanceof Nn)&&(!sn().webAudioMediaStreamDest||i._bypassWebAudio||this.pendingLocalTracks.some(o=>o instanceof Nn&&o._bypassWebAudio)))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,i){const o=!Q("DISABLE_DUAL_STREAM_USE_ENCODING")&&sn().supportDualStreamEncoding,c=Ng(Ng({},{width:160,height:120,framerate:15,bitrate:50}),i);let u;u=o?e._mediaStreamTrack.clone():wg(e,c);const h=Hn(8,"track-low-"),_=new ke(u,Ng(Ng({},o&&{scaleResolutionDownBy:Nr(c,e)}),{},{frameRate:c.framerate,bitrateMax:c.bitrate,bitrateMin:c.bitrate}),void 0,void 0,h);return _.on(Xd.TRANSCEIVER_UPDATED,m=>{e._updateRtpTransceiver(m,la.LOW_STREAM)}),_._hints.push(Fn.LOW_STREAM),e.addListener(Vt.NEED_CLOSE,()=>{_.close()}),_}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,i,o,c){var u;const h=Array.from(lo(u=this.remoteUserMap).call(u)).find(_=>_._videoSSRC===e);if(h){c||this.store.subscribe(h.uid,"video",void 0,void 0,void 0,void 0,Date.now());const _=this.store.keyMetrics,m=_.subscribe.find(g=>g.userId===h.uid&&g.type==="video");ne.firstRemoteVideoDecode(this.store.sessionId,Rr.FIRST_VIDEO_DECODE,ei.FIRST_VIDEO_DECODE,{peer:h._uintid,videowidth:i,videoheight:o,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:_.requestAPEnd||0,apStart:_.requestAPStart||0,joinGwEnd:_.joinGatewayEnd||0,joinGwStart:_.joinGatewayStart||0,pcEnd:_.peerConnectionEnd||0,pcStart:_.peerConnectionStart||0,subscriberEnd:(m==null?void 0:m.subscribeEnd)||0,subscriberStart:(m==null?void 0:m.subscribeStart)||0,videoAddNotify:(m==null?void 0:m.streamAdded)||0,state:c?1:0})}}async remoteMediaSsrcChanged(e,i,o){if(!this.recvConnection)return!1;const c=this.remoteUserMap.get(e);if(!c)return!1;const u=c.get(i);if(!u)return!1;const h=await this.recvConnection.getRemoteSSRC(u);return h!==void 0&&h!==o}resetConnection(e){O.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===En.Connected?(O.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new ft(j.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new ft(j.NOT_SUPPORTED)}async subscribeDataChannel(e,i){throw new ft(j.NOT_SUPPORTED)}async unsubscribeDataChannel(e,i){throw new ft(j.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,i){throw new ft(j.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,i){throw new ft(j.NOT_SUPPORTED)}async preConnect(e,i,o,c,u,h){throw new ft(j.NOT_SUPPORTED)}getEstablishParams(){throw new ft(j.NOT_SUPPORTED)}async reSubscribe(e){throw new ft(j.NOT_SUPPORTED)}async updateVideoStreamParameter(e,i){throw new ft(j.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[i,{track:o}]=e;i===yt.LocalVideoLowTrack?o._updateRtpTransceiver(void 0,la.LOW_STREAM):o._updateRtpTransceiver(void 0)})}}function vd(s){return function(e,i,o){const c=e[i];if(typeof c!="function")throw new Error("Cannot use mutex on object property.");return o.value=async function(){for(var u=arguments.length,h=new Array(u),_=0;_<u;_++)h[_]=arguments[_];switch(s){case lc.SEND_ONLY:{const m=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await c.apply(this,h)}finally{m()}}case lc.RECEIVE_ONLY:{const m=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await c.apply(this,h)}finally{m()}}default:{const m=await this.sendMutex.lock("From P2PChannel2.".concat(i)),g=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await c.apply(this,h)}finally{m(),g()}}}},o}}function r1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function nh(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?r1(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):r1(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}Tt([vd(lc.SEND_ONLY),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],_r.prototype,"p2pConnect",null),Tt([vd(lc.SEND_ONLY),V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],_r.prototype,"unpublish",null),Tt([vd(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],_r.prototype,"unpublishLowStream",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String,Number,String]),V("design:returntype",ut)],_r.prototype,"subscribe",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String,Number,String]),V("design:returntype",ut)],_r.prototype,"mockSubscribe",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String,Boolean]),V("design:returntype",ut)],_r.prototype,"unsubscribe",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String]),V("design:returntype",ut)],_r.prototype,"muteRemote",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String]),V("design:returntype",ut)],_r.prototype,"unmuteRemote",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String]),V("design:returntype",ut)],_r.prototype,"hasRemoteMediaWithLock",null),Tt([vd(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],_r.prototype,"disconnectForReconnect",null),Tt([vd(lc.RECEIVE_ONLY),V("design:type",Function),V("design:paramtypes",[Zr,String,Number]),V("design:returntype",ut)],_r.prototype,"remoteMediaSsrcChanged",null);class Pr{constructor(e){A(this,"store",void 0),A(this,"onStatsException",void 0),A(this,"onUploadPublishDuration",void 0),A(this,"onStatsChanged",void 0),A(this,"localStats",new Map),A(this,"remoteStats",new Map),A(this,"updateStatsInterval",void 0),A(this,"trafficStats",void 0),A(this,"trafficStatsPeerList",[]),A(this,"uplinkStats",void 0),A(this,"exceptionMonitor",void 0),A(this,"p2pChannel",void 0),A(this,"scalabilityMode",lf.L1T1),A(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new ac,this.exceptionMonitor.on("exception",(i,o,c)=>{this.onStatsException&&this.onStatsException(i,o,c)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(yt.LocalAudioTrack)||nh({},He)}getLocalVideoTrackStats(){return this.localStats.get(yt.LocalVideoTrack)||nh({},Cb)}getRemoteAudioTrackStats(e){const i=(u,h)=>{if(!this.trafficStats)return h;const _=this.trafficStats.peer_delay.find(m=>m.peer_uid===u);return _&&(h.publishDuration=_.B_ppad+(Date.now()-this.trafficStats.timestamp)),h},o={};if(e){var c;const u=(c=this.remoteStats.get(e))===null||c===void 0?void 0:c.audioStats;u&&(o[e]=i(e,u))}else Array.from(this.remoteStats.entries()).forEach(u=>{let[h,{audioStats:_}]=u;_&&(o[h]=i(h,_))});return o}getRemoteNetworkQualityStats(e){const i={};if(e){var o;const c=(o=this.remoteStats.get(e))===null||o===void 0?void 0:o.networkStats;c&&(i[e]=c)}else Array.from(this.remoteStats.entries()).forEach(c=>{let[u,{networkStats:h}]=c;h&&(i[u]=h)});return i}getRemoteVideoTrackStats(e){const i=(u,h)=>{if(!this.trafficStats)return h;const _=this.trafficStats.peer_delay.find(m=>m.peer_uid===u);return _&&(h.publishDuration=_.B_ppvd+(Date.now()-this.trafficStats.timestamp)),h},o={};if(e){var c;const u=(c=this.remoteStats.get(e))===null||c===void 0?void 0:c.videoStats;u&&(o[e]=i(e,u))}else Array.from(this.remoteStats.entries()).forEach(u=>{let[h,{videoStats:_}]=u;_&&(o[h]=i(h,_))});return o}getRTCStats(){let e=0,i=0,o=0,c=0;const u=this.localStats.get(yt.LocalAudioTrack);u&&(e+=u.sendBytes,i+=u.sendBitrate);const h=this.localStats.get(yt.LocalVideoTrack);h&&(e+=h.sendBytes,i+=h.sendBitrate);const _=this.localStats.get(yt.LocalVideoLowTrack);_&&(e+=_.sendBytes,i+=_.sendBitrate),this.remoteStats.forEach(g=>{let{audioStats:S,videoStats:C}=g;S&&(o+=S.receiveBytes,c+=S.receiveBitrate),C&&(o+=C.receiveBytes,c+=C.receiveBitrate)});let m=1;return this.trafficStats&&(m+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:m,SendBitrate:i,SendBytes:e,RecvBytes:o,RecvBitrate:c,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),e.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var o;const c=(o=this.p2pChannel)===null||o===void 0?void 0:o.getRemoteMedia(i.peer_uid),u=c!=null&&c.videoSSRC?cs.measureFromSubscribeStart(this.store.clientId,c.videoSSRC):0,h=c!=null&&c.audioSSRC?cs.measureFromSubscribeStart(this.store.clientId,c.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,u>h?u:h),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&O.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,i,o){if(!e)return!1;const c=!!o&&i.framesDecodeFreezeTime>o.framesDecodeFreezeTime,u=!o||i.framesDecodeCount>o.framesDecodeCount;return c||!u}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(i=>{let[o,c]=i;switch(o){case yt.LocalVideoTrack:case yt.LocalVideoLowTrack:{const h=c,_=nh({},Cb),m=e.getStats(),g=e.getLocalMedia(o);if(m){const S=m.videoSend.find(C=>C.ssrc===(g==null?void 0:g.ssrcs[0].ssrcId));if(S){const C=e.getLocalVideoSize(),I=e.getEncoderConfig(yt.LocalVideoTrack);S.codec!=="H264"&&S.codec!=="H265"&&S.codec!=="VP8"&&S.codec!=="VP9"&&S.codec!=="AV1X"&&S.codec!=="AV1"||(_.codecType=S.codec),_.sendBytes=S.bytes,_.sendBitrate=h?8*Math.max(0,_.sendBytes-h.sendBytes):0,S.inputFrame?(_.captureFrameRate=S.inputFrame.frameRate,_.captureResolutionHeight=S.inputFrame.height,_.captureResolutionWidth=S.inputFrame.width):C&&(_.captureResolutionWidth=C.width,_.captureResolutionHeight=C.height),S.sentFrame?(_.sendFrameRate=S.sentFrame.frameRate,_.sendResolutionHeight=S.sentFrame.height,_.sendResolutionWidth=S.sentFrame.width):C&&(_.sendResolutionWidth=C.width,_.sendResolutionHeight=C.height),S.avgEncodeMs&&(_.encodeDelay=S.avgEncodeMs),I&&I.bitrateMax&&(_.targetSendBitrate=1e3*I.bitrateMax),_.sendPackets=S.packets,_.sendPacketsLost=S.packetsLost,_.sendJitterMs=S.jitterMs,_.sendRttMs=S.rttMs,_.totalDuration=h?h.totalDuration+1:1,_.totalFreezeTime=h?h.totalFreezeTime:0,this.isLocalVideoFreeze(S)&&(_.totalFreezeTime+=1),S.scalabilityMode&&this.scalabilityMode!==S.scalabilityMode&&(O.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(S.scalabilityMode)),this.scalabilityMode=S.scalabilityMode)}this.trafficStats&&(_.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var u;this.localStats.set(o,_),((h==null?void 0:h.sendResolutionWidth)!==_.sendResolutionWidth||(h==null?void 0:h.sendResolutionHeight)!==_.sendResolutionHeight)&&((u=this.onStatsChanged)===null||u===void 0||u.call(this,"resolution",{width:_.sendResolutionWidth,height:_.sendResolutionHeight})),_&&g&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,g.track,_);break}case yt.LocalAudioTrack:{const h=c,_=nh({},He),m=e.getStats(),g=e.getLocalMedia(o);if(m){const S=m.audioSend.find(C=>C.ssrc===(g==null?void 0:g.ssrcs[0].ssrcId));if(S){if(S.codec!=="opus"&&S.codec!=="aac"&&S.codec!=="PCMU"&&S.codec!=="PCMA"&&S.codec!=="G722"||(_.codecType=S.codec),S.inputLevel)_.sendVolumeLevel=Math.round(32767*S.inputLevel);else{const C=e.getLocalAudioVolume();C&&(_.sendVolumeLevel=Math.round(32767*C))}_.sendBytes=S.bytes,_.sendPackets=S.packets,_.sendPacketsLost=S.packetsLost,_.sendJitterMs=S.jitterMs,_.sendRttMs=S.rttMs,_.sendBitrate=h?8*Math.max(0,_.sendBytes-h.sendBytes):0}}this.trafficStats&&(_.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(yt.LocalAudioTrack,_),_&&g&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,g.track,_);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(i=>{var o,c;let[u,{videoStats:h,audioStats:_,videoPcStats:m}]=i;const g=_,S=h,C=m,I=nh({},Af),b=nh({},mk),x=nh({},Ek),{audioTrack:D,videoTrack:M,audioSSRC:K,videoSSRC:z}=e.getRemoteMedia(u);let nt;nt=e instanceof _r?e.getStats(!0):e.getStats();const dt=(o=nt)===null||o===void 0?void 0:o.audioRecv.find(ht=>ht.ssrc===K),it=(c=nt)===null||c===void 0?void 0:c.videoRecv.find(ht=>ht.ssrc===z),at=this.trafficStats&&this.trafficStats.peer_delay.find(ht=>ht.peer_uid===u);if(dt&&(dt.codec!=="opus"&&dt.codec!=="aac"&&dt.codec!=="PCMU"&&dt.codec!=="PCMA"&&dt.codec!=="G722"||(I.codecType=dt.codec),dt.outputLevel?I.receiveLevel=Math.round(32767*dt.outputLevel):D&&(I.receiveLevel=Math.round(32767*D.getVolumeLevel())),I.receiveBytes=dt.bytes,I.receivePackets=dt.packets,I.receivePacketsLost=dt.packetsLost,I.packetLossRate=I.receivePacketsLost/(I.receivePackets+I.receivePacketsLost),I.receiveBitrate=g?8*Math.max(0,I.receiveBytes-g.receiveBytes):0,I.totalDuration=g?g.totalDuration+1:1,I.totalFreezeTime=g?g.totalFreezeTime:0,I.freezeRate=I.totalFreezeTime/I.totalDuration,I.receiveDelay=dt.jitterBufferMs,I.totalDuration>10&&Pr.isRemoteAudioFreeze(D)&&(I.totalFreezeTime+=1)),it){it.codec!=="H264"&&it.codec!=="H265"&&it.codec!=="VP8"&&it.codec!=="VP9"&&it.codec!=="AV1X"&&it.codec!=="AV1"||(b.codecType=it.codec),b.receiveBytes=it.bytes,b.receiveBitrate=S?8*Math.max(0,b.receiveBytes-S.receiveBytes):0,b.decodeFrameRate=it.decodeFrameRate<0?0:it.decodeFrameRate,b.renderFrameRate=it.decodeFrameRate<0?0:it.decodeFrameRate,it.outputFrame&&(b.renderFrameRate=it.outputFrame.frameRate),it.receivedFrame?(b.receiveFrameRate=it.receivedFrame.frameRate,b.receiveResolutionHeight=it.receivedFrame.height,b.receiveResolutionWidth=it.receivedFrame.width):M&&(b.receiveResolutionHeight=M._videoHeight||0,b.receiveResolutionWidth=M._videoWidth||0),it.framesRateFirefox!==void 0&&(b.receiveFrameRate=Math.round(it.framesRateFirefox)),b.receivePackets=it.packets,b.receivePacketsLost=it.packetsLost,b.packetLossRate=b.receivePacketsLost/(b.receivePackets+b.receivePacketsLost),b.totalDuration=S?S.totalDuration+1:1,b.totalFreezeTime=S?S.totalFreezeTime:0,b.receiveDelay=it.jitterBufferMs||0;const ht=!!z&&e.getRemoteVideoIsReady(z);M&&ht&&Pr.isRemoteVideoFreeze(M,it,C)&&(b.totalFreezeTime+=1),b.freezeRate=b.totalFreezeTime/b.totalDuration}at&&(I.end2EndDelay=at.B_ad,b.end2EndDelay=at.B_vd,I.transportDelay=at.B_ed,b.transportDelay=at.B_ed,I.currentPacketLossRate=at.B_ealr4/100,b.currentPacketLossRate=at.B_evlr4/100,x.uplinkNetworkQuality=at.B_punq?at.B_punq:0,x.downlinkNetworkQuality=at.B_pdnq?at.B_pdnq:0),this.remoteStats.set(u,{audioStats:I,videoStats:b,videoPcStats:it,networkStats:x}),D&&this.exceptionMonitor.setRemoteAudioStats(D,I),M&&this.exceptionMonitor.setRemoteVideoStats(M,b)})}}function nO(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Dg(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?nO(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):nO(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class cG extends oi{constructor(e,i,o,c){super(),A(this,"spec",void 0),A(this,"token",void 0),A(this,"websocket",void 0),A(this,"pingpongTimer",void 0),A(this,"reconnectMode","retry"),A(this,"serviceMode",void 0),A(this,"reqId",0),A(this,"commandReqId",0),A(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),A(this,"handleWebSocketMessage",u=>{if(!u.data)return;const h=JSON.parse(u.data);h.requestId?this.emit("@".concat(h.requestId,"-").concat(h.sid),h):this.serviceMode===ki.INJECT?this.emit(Cc.INJECT_STREAM_STATUS,h):(ne.workerEvent(this.spec.sid,{actionType:"status",serverCode:h.code,workerType:this.serviceMode===ki.TRANSCODE?1:2}),this.emit(Cc.PUBLISH_STREAM_STATUS,h))}),this.spec=i,this.token=e,this.serviceMode=c,this.websocket=new vr("live-streaming",o),this.websocket.on(Se.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Se.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Se.REQUEST_NEW_URLS,(u,h)=>{zi(this,Cc.REQUEST_NEW_ADDRESS).then(u).catch(h)}),this.websocket.on(Se.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,i,o,c){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const u=this.commandReqId,h=this.reqId;if(!h||!this.websocket)throw new st(j.UNEXPECTED_ERROR);const _=Dg({command:e,sdkVersion:Ga==="4.20.2"?"0.0.1":Ga,seq:h,requestId:h,allocate:o,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new st(j.WS_DISCONNECT);const m=()=>new ut((I,b)=>{this.websocket.once(Se.CLOSED,()=>b(new st(j.WS_ABORT))),this.websocket.once(Se.CONNECTED,I)});this.websocket.state!=="connected"&&await m(),_.clientRequest&&(_.clientRequest.workerToken=this.token);const g=new ut((I,b)=>{const x=()=>{b(new st(j.WS_ABORT))};this.websocket.once(Se.RECONNECTING,x),this.websocket.once(Se.CLOSED,x),this.once("@".concat(h,"-").concat(this.spec.sid),D=>{I(D)})});c&&ne.workerEvent(this.spec.sid,Dg(Dg({},c),{},{requestId:u,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));const S=Date.now();this.websocket.sendMessage(_);let C=null;try{C=await g}catch(I){if(this.websocket.state==="closed")throw I;return await m(),await this.request(e,i,o)}return c&&ne.workerEvent(this.spec.sid,Dg(Dg({},c),{},{requestId:u,actionType:"response",payload:JSON.stringify(C.serverResponse),serverCode:C.code,success:C.code===200,responseTime:Date.now()-S})),C.code!==200&&this.handleResponseError(C),C}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=Ga==="4.20.2"?"0.0.1":Ga;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case vi.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void O.warning("live stream response already exists stream");case vi.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case vi.LIVE_STREAM_RESPONSE_BAD_STREAM:case vi.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new st(j.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case vi.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case vi.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new st(j.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case vi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const i=new st(j.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Cc.WARNING,i,e.serverResponse.url)}case vi.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const i=new st(j.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Cc.WARNING,i,e.serverResponse.url)}case vi.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case vi.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new st(j.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case vi.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const i=new st(j.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Cc.WARNING,i,e.serverResponse.url)}case vi.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case vi.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case vi.LIVE_STREAM_RESPONSE_WORKER_LOST:case vi.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case vi.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case vi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case vi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case vi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case vi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new st(j.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(US)},6e3)}}function s1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Fs(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?s1(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):s1(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class o1 extends oi{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:nr,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:nr;super(),A(this,"onLiveStreamWarning",void 0),A(this,"onLiveStreamError",void 0),A(this,"onInjectStatusChange",void 0),A(this,"spec",void 0),A(this,"retryTimeout",1e4),A(this,"connection",void 0),A(this,"httpRetryConfig",void 0),A(this,"wsRetryConfig",void 0),A(this,"streamingTasks",new Map),A(this,"isStartingStreamingTask",!1),A(this,"taskMutex",new Sr("live-streaming")),A(this,"cancelToken",Ks.CancelToken.source()),A(this,"transcodingConfig",void 0),A(this,"injectConfig",Fs({},tk)),A(this,"injectLoopTimes",0),A(this,"uapResponse",void 0),A(this,"lastTaskId",1),A(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=o,this.wsRetryConfig=i}async setTranscodingConfig(e){const i=Fs(Fs({},rb),e);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(O.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(h=>Fs(Fs(Fs({},_j),h),{},{zOrder:h.zOrder?h.zOrder+1:1}))),function(h){xn(h.width)||hn(h.width,"config.width",0,1e4),xn(h.height)||hn(h.height,"config.height",0,1e4),xn(h.videoBitrate)||hn(h.videoBitrate,"config.videoBitrate",1,1e6),xn(h.videoFrameRate)||hn(h.videoFrameRate,"config.videoFrameRate"),xn(h.lowLatency)||td(h.lowLatency,"config.lowLatency"),xn(h.audioSampleRate)||cr(h.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),xn(h.audioBitrate)||hn(h.audioBitrate,"config.audioBitrate",1,128),xn(h.audioChannels)||cr(h.audioChannels,"config.audioChannels",[1,2,3,4,5]),xn(h.videoGop)||hn(h.videoGop,"config.videoGop"),xn(h.videoCodecProfile)||cr(h.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),xn(h.userCount)||hn(h.userCount,"config.userCount",0,17),xn(h.backgroundColor)||hn(h.backgroundColor,"config.backgroundColor",0,16777215),xn(h.userConfigExtraInfo)||fs(h.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),h.transcodingUsers&&!xn(h.transcodingUsers)&&(jd(h.transcodingUsers,"config.transcodingUsers"),h.transcodingUsers.forEach((_,m)=>{eb(_.uid),xn(_.x)||hn(_.x,"transcodingUser[".concat(m,"].x"),0,1e4),xn(_.y)||hn(_.y,"transcodingUser[".concat(m,"].y"),0,1e4),xn(_.width)||hn(_.width,"transcodingUser[".concat(m,"].width"),0,1e4),xn(_.height)||hn(_.height,"transcodingUser[".concat(m,"].height"),0,1e4),xn(_.zOrder)||hn(_.zOrder-1,"transcodingUser[".concat(m,"].zOrder"),0,100),xn(_.alpha)||hn(_.alpha,"transcodingUser[".concat(m,"].alpha"),0,1,!1)})),xn(h.watermark)||ib(h.watermark,"watermark"),xn(h.backgroundImage)||ib(h.backgroundImage,"backgroundImage"),h.images&&!xn(h.images)&&(jd(h.images,"config.images"),h.images.forEach((_,m)=>{ib(_,"images[".concat(m,"]"))}))}(i);const o=[];i.images&&o.push(...i.images.map(h=>Fs(Fs(Fs({},nb),h),{},{zOrder:255}))),i.backgroundImage&&(o.push(Fs(Fs(Fs({},nb),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(o.push(Fs(Fs(Fs({},nb),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=o,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(h=>Fs({},h)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const c=(i.userConfigs||[]).map(h=>typeof h.uid=="number"?ut.resolve(h.uid):mb(h.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await ut.all(c)).forEach((h,_)=>{i.userConfigs&&i.userConfigs[_]&&(i.userConfigs[_].uid=h)}),this.transcodingConfig=i,this.connection)try{var u;const h=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Rc(u=this.streamingTasks).call(u)).map(_=>_.taskId).join("#")});O.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(h.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(h){if(!h.data||!h.data.retry)throw h;h.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(_=>{O.warning("[".concat(this.spec.clientId,"] live streaming receive error"),h.toString(),"try to republish",_.url),this.startLiveStreamingTask(_.url,_.mode,h).then(()=>{O.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(_.url," success"))}).catch(m=>{O.error("[".concat(this.spec.clientId,"] live streaming republish failed"),_.url,m.toString()),this.onLiveStreamError&&this.onLiveStreamError(_.url,m)})})}}setInjectStreamConfig(e,i){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=i}async startLiveStreamingTask(e,i,o){var c;if(Array.from(Rc(c=this.streamingTasks).call(c)).find(m=>m.mode===ki.INJECT)&&i===ki.INJECT)return new st(j.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===ki.TRANSCODE)throw new st(j.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let u={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};O.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));const h=await this.taskMutex.lock();if(!this.connection&&o)return void h();if(this.streamingTasks.get(e)&&!o)return h(),new st(j.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(m){throw h(),m}switch(i){case ki.TRANSCODE:u.transcodingConfig=Fs({},this.transcodingConfig);break;case ki.RAW:break;case ki.INJECT:u={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(u.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const _=this.lastTaskId++;try{const m=new ut((S,C)=>{Mr(this.retryTimeout).then(()=>{if(o)return C(o);const I=this.statusError.get(e);return I?(this.statusError.delete(e),C(I)):void 0})}),g=await ut.race([this.connection.request("request",{clientRequest:u},!0,{url:e,command:"PublishStream",workerType:i===ki.TRANSCODE?1:2,requestByUser:!o,tid:_.toString()}),m]);this.isStartingStreamingTask=!1,O.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(g.code)),this.streamingTasks.set(e,{clientRequest:u,mode:i,url:e,taskId:_}),h()}catch(m){if(h(),this.isStartingStreamingTask=!1,!m.data||!m.data.retry||o)throw m;return m.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,i,m)):await this.startLiveStreamingTask(e,i,m)}}stopLiveStreamingTask(e){return new ut((i,o)=>{const c=this.streamingTasks.get(e);if(!c||!this.connection)return new st(j.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const u=c.mode;c.abortTask=()=>{O.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:u===ki.INJECT?"UninjectStream":"UnpublishStream",url:c.url}},!1,{url:e,command:"UnPublishStream",workerType:u===ki.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(h=>{O.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(h.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&u!==ki.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),u===ki.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(xu.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)}).catch(o)})}async controlInjectStream(e,i,o,c){const u=this.streamingTasks.get(e);if(!u||!this.connection||u.mode!==ki.INJECT)throw new st(j.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:i,audioVolume:o,position:c}})).serverResponse}resetAllTask(){var e;const i=Array.from(Rc(e=this.streamingTasks).call(e));this.terminate();for(const o of i)this.startLiveStreamingTask(o.url,o.mode).catch(c=>{this.onLiveStreamError&&this.onLiveStreamError(o.url,c)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Ks.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new st(j.UNEXPECTED_ERROR,"live streaming connection has already connected");const i=await zi(this,vl.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=i,this.connection=new cG(i.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(Cc.WARNING,(o,c)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(c,o)),this.connection.on(Cc.PUBLISH_STREAM_STATUS,o=>this.handlePublishStreamServer(o)),this.connection.on(Cc.INJECT_STREAM_STATUS,o=>this.handleInjectStreamServerStatus(o)),this.connection.on(Cc.REQUEST_NEW_ADDRESS,(o,c)=>{if(!this.connection)return c(new st(j.UNEXPECTED_ERROR,"can not get new live streaming address list"));zi(this,vl.REQUEST_WORKER_MANAGER_LIST,e).then(u=>{this.uapResponse=u,o(u.addressList)}).catch(c)}),await this.connection.init(i.addressList),this.connection}handlePublishStreamServer(e){const i=e.serverStatus&&e.serverStatus.url||"empty_url",o=this.streamingTasks.get(i),c=e.reason;switch(e.code){case vi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case vi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case vi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case vi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const h=new st(j.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(o)return O.error(h.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,h);if(!this.isStartingStreamingTask)return;this.statusError.set(i,h)}case vi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const h=new st(j.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,c);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,h)}case vi.LIVE_STREAM_RESPONSE_WORKER_LOST:case vi.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var u;if(!this.connection)return;this.connection.tryNextAddress();const h=Array.from(Rc(u=this.streamingTasks).call(u));for(const _ of h)_.abortTask?_.abortTask():(O.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",_.url),this.startLiveStreamingTask(_.url,_.mode,new st(j.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{O.debug("[".concat(this.spec.clientId,"] republish live stream success"),_.url)}).catch(m=>{O.error(m.toString()),this.onLiveStreamError&&this.onLiveStreamError(_.url,m)}));return}}}handleInjectStreamServerStatus(e){const i=Number(e.uid),o=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(xu.INJECT_STREAM_STATUS_START_SUCCESS,i,o));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(xu.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,o),void this.streamingTasks.delete(o);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(xu.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,o),void this.streamingTasks.delete(o);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(xu.INJECT_STREAM_STATUS_BROKEN,i,o),void this.streamingTasks.delete(o);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(xu.INJECT_STREAM_STATUS_START_TIMEOUT,i,o),void this.streamingTasks.delete(o);default:return void O.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class RC{constructor(){A(this,"destChannelMediaInfos",new Map),A(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){sb(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){sb(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){tb(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function a1(s){if(!(s instanceof RC))return new st(j.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=s.getSrcChannelMediaInfo(),i=s.getDestChannelMediaInfo();if(!e)return new st(j.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new st(j.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class dG extends oi{constructor(e,i,o){super(),A(this,"ws",void 0),A(this,"requestId",1),A(this,"heartBeatTimer",void 0),A(this,"joinInfo",void 0),A(this,"clientId",void 0),A(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),A(this,"onClose",c=>{this.emit("close"),this.dispose()}),A(this,"onMessage",c=>{const u=JSON.parse(c.data);if(!u||u.command!=="serverResponse"||!u.requestId)return u&&u.command==="serverStatus"&&u.serverStatus&&u.serverStatus.command?(this.emit("status",u.serverStatus),void this.emit(u.serverStatus.command,u.serverStatus)):void 0;this.emit("req_".concat(u.requestId),u)}),this.joinInfo=e,this.clientId=i,this.ws=new vr("cross-channel-".concat(this.clientId),o),this.ws.on(Se.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Se.CONNECTED,this.onOpen),this.ws.on(Se.ON_MESSAGE,this.onMessage),this.ws.on(Se.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const i=this.requestId++;return e.requestId=i,e.seq=i,this.ws.sendMessage(e),i}waitStatus(e){return new ut((i,o)=>{const c=window.setTimeout(()=>{o(new st(j.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,u=>{window.clearTimeout(c),u.state&&u.state!==0?o(new st(j.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(c),o(new st(j.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new st(j.WS_DISCONNECT);const i=()=>new ut((h,_)=>{this.ws.once(Se.CLOSED,()=>_(new st(j.WS_ABORT))),this.ws.once(Se.CONNECTED,h)});this.ws.state!=="connected"&&await i();const o=this.sendMessage(e),c=new ut((h,_)=>{const m=()=>{_(new st(j.WS_ABORT))};this.ws.once(Se.RECONNECTING,m),this.ws.once(Se.CLOSED,m),this.once("req_".concat(o),h),Mr(3e3).then(()=>{this.removeAllListeners("req_".concat(o)),this.ws.off(Se.RECONNECTING,m),this.ws.off(Se.CLOSED,m),_(new st(j.TIMEOUT,"cross channel ws request timeout"))})}),u=await c;if(!u||u.code!==200)throw new st(j.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(u)));return u}async connect(e){this.ws.removeAllListeners(Se.REQUEST_NEW_URLS),this.ws.on(Se.REQUEST_NEW_URLS,i=>{i(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const i=this.requestId++;return e.requestId=i,this.ws.sendMessage(e),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class iO extends oi{set state(e){e!==this._state&&(e!==ws.RELAY_STATE_FAILURE&&(this.errorCode=Kd.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,o,c,u){super(),A(this,"joinInfo",void 0),A(this,"sid",void 0),A(this,"clientId",void 0),A(this,"cancelToken",Ks.CancelToken.source()),A(this,"workerToken",void 0),A(this,"requestId",0),A(this,"signal",void 0),A(this,"prevChannelMediaConfig",void 0),A(this,"httpRetryConfig",void 0),A(this,"_resolution",void 0),A(this,"_state",ws.RELAY_STATE_IDLE),A(this,"errorCode",Kd.RELAY_OK),A(this,"onStatus",h=>{O.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(h))),h&&h.command&&(h.command==="onAudioPacketReceived"&&this.emit("event",aa.PACKET_RECEIVED_AUDIO_FROM_SRC),h.command==="onVideoPacketReceived"&&this.emit("event",aa.PACKET_RECEIVED_VIDEO_FROM_SRC),h.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Kd.SRC_TOKEN_EXPIRED,this.state=ws.RELAY_STATE_FAILURE),h.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Kd.DEST_TOKEN_EXPIRED,this.state=ws.RELAY_STATE_FAILURE))}),A(this,"onReconnect",async()=>{O.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",aa.NETWORK_DISCONNECTED),this.state=ws.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(h=>{this.state!==ws.RELAY_STATE_IDLE&&(O.error("auto restart channel media relay failed",h.toString()),this.errorCode=Kd.SERVER_CONNECTION_LOST,this.state=ws.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=i,this.sid=OA(),this.signal=new dG(this.joinInfo,this.clientId,o),this.httpRetryConfig=c,this._resolution=u}async startChannelMediaRelay(e){if(this.state!==ws.RELAY_STATE_IDLE)throw new st(j.INVALID_OPERATION);this.state=ws.RELAY_STATE_CONNECTING,await this.connect(),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new st(j.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new st(j.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new st(j.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==ws.RELAY_STATE_RUNNING)throw new st(j.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==ws.RELAY_STATE_RUNNING)throw new st(j.INVALID_OPERATION);const i=this.genMessage(Ae.SetVideoProfile);await this.signal.request(i),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),O.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=ws.RELAY_STATE_IDLE,this.dispose()}dispose(){O.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Ks.CancelToken.source(),this.state=ws.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await K_(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",aa.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const i=this.genMessage(Ae.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const o=this.genMessage(Ae.SetSdkProfile,e);await this.signal.request(o),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const c=this.genMessage(Ae.SetSourceChannel,e);await this.signal.request(c),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",aa.PACKET_JOINED_SRC_CHANNEL),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const u=this.genMessage(Ae.SetSourceUserId,e);await this.signal.request(u),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const h=this.genMessage(Ae.SetDestChannel,e);await this.signal.request(h),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",aa.PACKET_JOINED_DEST_CHANNEL),O.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const _=this.genMessage(Ae.StartPacketTransfer,e);await this.signal.request(_),this.emit("event",aa.PACKET_SENT_TO_DEST_CHANNEL),this.state=ws.RELAY_STATE_RUNNING,O.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const i=this.genMessage(Ae.UpdateDestChannel,e);await this.signal.request(i),this.emit("event",aa.PACKET_UPDATE_DEST_CHANNEL),O.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Ae.StopPacketTransfer);await this.signal.request(e),O.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,i){const o=[],c=[],u=[];this.requestId+=1;const h={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Ga,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};h.sdkVersion==="4.20.2"&&(h.sdkVersion="0.0.1");let _=null,m=null;switch(e){case Ae.SetSdkProfile:return h.clientRequest={command:"SetSdkProfile",type:"multi_channel"},h;case Ae.SetSourceChannel:if(m=i&&i.getSrcChannelMediaInfo(),!m)throw new st(j.UNEXPECTED_ERROR,"can not find source config");return h.clientRequest={command:"SetSourceChannel",uid:"0",channelName:m.channelName,token:m.token||this.joinInfo.appId},h;case Ae.SetSourceUserId:if(m=i&&i.getSrcChannelMediaInfo(),!m)throw new st(j.UNEXPECTED_ERROR,"can not find source config");return h.clientRequest={command:"SetSourceUserId",uid:m.uid+""},h;case Ae.SetDestChannel:if(_=i&&i.getDestChannelMediaInfo(),!_)throw new st(j.UNEXPECTED_ERROR,"can not find dest config");return _.forEach(g=>{o.push(g.channelName),c.push(g.uid+""),u.push(g.token||this.joinInfo.appId)}),h.clientRequest={command:"SetDestChannel",channelName:o,uid:c,token:u},h;case Ae.StartPacketTransfer:return h.clientRequest={command:"StartPacketTransfer"},h;case Ae.Reconnect:return h.clientRequest={command:"Reconnect"},h;case Ae.StopPacketTransfer:return h.clientRequest={command:"StopPacketTransfer"},h;case Ae.UpdateDestChannel:if(_=i&&i.getDestChannelMediaInfo(),!_)throw new st(j.UNEXPECTED_ERROR,"can not find dest config");return _.forEach(g=>{o.push(g.channelName),c.push(g.uid+""),u.push(g.token||this.joinInfo.appId)}),h.clientRequest={command:"UpdateDestChannel",channelName:o,uid:c,token:u},h;case Ae.SetVideoProfile:h.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return h}}function CC(s){var e={},i=!1;function o(c,u){return i=!0,{done:!1,value:new sC(u=new zl(function(h){h(s[c](u))}),1)}}return e[u_!==void 0&&sD||"@@iterator"]=function(){return this},e.next=function(c){return i?(i=!1,c):o("next",c)},typeof s.throw=="function"&&(e.throw=function(c){if(i)throw i=!1,c;return o("throw",c)}),typeof s.return=="function"&&(e.return=function(c){return i?(i=!1,c):o("return",c)}),e}var rO=Rt(Lp);function c1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function hc(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?c1(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):c1(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function sO(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function vC(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?sO(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):sO(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class bi extends Hr{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return Jt(i=Object.keys(Sl)).call(i,e)}))]}constructor(e,i){super(e,i),A(this,"store",void 0),A(this,"peerConnection",void 0),A(this,"remoteSDP",void 0),A(this,"initialOffer",void 0),A(this,"statsFilter",void 0),A(this,"useRTX",!1),A(this,"localCapabilities",void 0),A(this,"localCandidateCount",0),A(this,"allCandidatesReceived",!1),A(this,"establishPromise",void 0),A(this,"mutex",new Sr("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(bi.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Ju(this.peerConnection,Q("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=Vc(e.sdp),o=Ql(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:Q("FILTER_VIDEO_FEC"),filterAudioFec:Q("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=o,this.initialOffer=e,vC(vC({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:o},offerSDP:e.sdp})}catch(e){throw new ft(j.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,o,c,u,h){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(m){A(this,"sessionDesc",void 0),A(this,"localCapabilities",void 0),A(this,"rtpCapabilities",void 0),A(this,"candidates",void 0),A(this,"iceParameters",void 0),A(this,"dtlsParameters",void 0),A(this,"setup",void 0),A(this,"currentMidIndex",void 0),A(this,"cname",void 0),m=Jn(m);const{remoteIceParameters:g,remoteDtlsParameters:S,candidates:C,remoteRTPCapabilities:I,remoteSetup:b,localCapabilities:x,sdkCodec:D,cname:M}=m,K=ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=I,this.candidates=C,this.iceParameters=g,this.dtlsParameters=S,this.setup=b,this.localCapabilities=x,this.cname=M;for(let z=0;z<K.mediaDescriptions.length;z++){const nt=K.mediaDescriptions[z];if(nt.attributes.iceUfrag=g.iceUfrag,nt.attributes.icePwd=g.icePwd,nt.attributes.fingerprints=S.fingerprints,nt.attributes.candidates=C,nt.attributes.setup=b,nt.media.mediaType==="video"){nt.media.fmts=I.videoCodecs.map(it=>it.payloadType.toString(10));let dt=I.videoCodecs.filter(it=>{var at,ht;return(at=it.rtpMap)===null||at===void 0?void 0:Jt(ht=at.encodingName.toLowerCase()).call(ht,D)});dt.length===0&&(dt=I.videoCodecs),nt.attributes.payloads=dt,nt.attributes.extmaps=I.videoExtensions}nt.media.mediaType==="audio"&&(nt.media.fmts=I.audioCodecs.map(dt=>dt.payloadType.toString(10)),nt.attributes.payloads=I.audioCodecs,nt.attributes.extmaps=I.audioExtensions),K.mediaDescriptions[z]=this.mungMediaDesc(nt)}this.sessionDesc=K,this.currentMidIndex=K.mediaDescriptions.length-1}toString(){return ci.print(this.sessionDesc)}send(m,g,S){const{ssrcs:C,ssrcGroups:I}=ro(g,this.cname),b=this.sessionDesc.mediaDescriptions.find(M=>m===Xt.VIDEO?M.media.mediaType==="video":M.media.mediaType==="audio"),x=C[0].attributes.label,D=C[0].attributes.mslabel;return b.attributes.ssrcs=b.attributes.ssrcs.concat(C),b.attributes.ssrcGroups=b.attributes.ssrcGroups.concat(I),{id:x,mslabel:D}}batchSend(m){return m.map(g=>{let{kind:S,ssrcMsg:C}=g;return this.send(S,C,void 0)})}stopSending(m){this.sessionDesc.mediaDescriptions.forEach(g=>{const S=[],C=[],I=[];g.attributes.ssrcs.forEach(b=>{Jt(m).call(m,b.attributes.label||"")?I.push(b):S.push(b)}),g.attributes.ssrcGroups.forEach(b=>{var x;Jt(x=I.map(D=>D.ssrcId)).call(x,b.ssrcIds[0])||C.push(b)}),g.attributes.ssrcs=S,g.attributes.ssrcGroups=C})}mute(m){const g=this.sessionDesc.mediaDescriptions.find(S=>S.attributes.mid===m);if(!g)throw new Error("mediaDescription not found with ".concat(m," in remote SDP when calling RemoteSDP.mute."));g.attributes.direction="inactive"}unmute(m){const g=this.sessionDesc.mediaDescriptions.find(S=>S.attributes.mid===m);if(!g)throw new Error("mediaDescription not found with ".concat(m," in remote SDP when calling RemoteSDP.unmute."));g.attributes.direction="sendonly"}receive(m,g,S){m.forEach((C,I)=>{const b=C._mediaStreamTrack,x=this.sessionDesc.mediaDescriptions.findIndex(M=>M.attributes.mid===b.kind),D=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[x],C);this.sessionDesc.mediaDescriptions[x]=D})}stopReceiving(m){}updateCandidates(m){m===Wr.TCP?this.candidates.forEach(g=>{this.candidates.findIndex(S=>S.transport==="tcp"&&S.connectionAddress===g.connectionAddress&&S.port===g.port)===-1&&this.candidates.push(hc(hc({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}):this.candidates=this.candidates.filter(g=>g.transport!=="tcp");for(const g of this.sessionDesc.mediaDescriptions)g.attributes.candidates=this.candidates}restartICE(m){m=Jn(m),this.iceParameters=m,this.sessionDesc.mediaDescriptions.forEach(g=>{g.attributes.iceUfrag=m.iceUfrag,g.attributes.icePwd=m.icePwd})}predictReceivingMids(m){const g=[];for(let S=0;S<m;S++)g.push((this.currentMidIndex+S+1).toString(10));return g}mungRecvMediaDsec(m,g){const S=Jn(m);return so(S,g),Sd(S,g),S}updateRecvMedia(m,g){const S=this.sessionDesc.mediaDescriptions.findIndex(C=>C.attributes.mid===m);if(S!==-1){const C=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[S],g);this.sessionDesc.mediaDescriptions[S]=C}}bumpMid(m){this.currentMidIndex+=m}updateTrackLabel(m,g,S){const C=this.sessionDesc.mediaDescriptions.find(b=>m===Xt.VIDEO?b.attributes.mid==="video":b.attributes.mid==="audio");if(C){const b=C.attributes.ssrcs.find(x=>x.attributes.label===g);var I;b&&(b.attributes.label=S,(I=b.attributes.msid)===null||I===void 0||I.replace(g,S))}}mungMediaDesc(m){const g=Jn(m);return yg(g),function(S){const C=S.attributes.extmaps.find(I=>I.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");C&&S.attributes.extmaps.splice(S.attributes.extmaps.indexOf(C),1),S.attributes.payloads.forEach(I=>{const b=I.rtcpFeedbacks.findIndex(x=>x.type==="transport-cc");b!==-1&&I.rtcpFeedbacks.splice(b,1)})}(g),g}getSSRC(m){for(const g of this.sessionDesc.mediaDescriptions)for(const S of g.attributes.ssrcs)if(S.attributes.label===m)return[S]}}({remoteIceParameters:e,remoteDtlsParameters:i,candidates:o,remoteRTPCapabilities:c.send,remoteSetup:u,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:h});const _=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(_){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(_.toString()))}}async updateRemoteRTPCapabilities(e,i){throw new ft(j.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,i){var o=this;return Wo(function*(){const c=yield Pe(o.mutex.lock());try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const u=e.map(I=>o.peerConnection.addTrack(I._mediaStreamTrack)),h=yield Pe(o.peerConnection.createOffer()),_=ci.parse(h.sdp),m=e.map(I=>{const b=I._mediaStreamTrack,x=_.mediaDescriptions.find(D=>D.attributes.mid===b.kind);if(!x)throw new Error("Cannot extract ssrc from mediaDescription.");return function(D,M,K){const z=D.attributes.ssrcs.filter(dt=>dt.attributes.label===M),nt=D.attributes.ssrcGroups;if(z.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(nt&&z.length>1){const dt=nt.find(it=>it.ssrcIds.indexOf(z[0].ssrcId)!==-1);return dt?[{ssrcId:dt.ssrcIds[0],rtx:K?dt.ssrcIds[1]:void 0}]:[{ssrcId:z[0].ssrcId}]}return[{ssrcId:z[0].ssrcId}]}(x,b.id,o.useRTX)});let g;try{g=yield m}catch(I){throw u.forEach(b=>{Or()&&b.replaceTrack(null),o.peerConnection.removeTrack(b)}),I}const S=o.mungSendOfferSDP(h.sdp,e);o.remoteSDP.receive(e,i,g);const C=o.remoteSDP.toString();return yield Pe(o.peerConnection.setLocalDescription({type:"offer",sdp:S})),yield Pe(o.applySendEncodings(u,e)),yield Pe(o.peerConnection.setRemoteDescription({type:"answer",sdp:C})),e.map((I,b)=>{const x=I._mediaStreamTrack.id;return{localSSRC:m[b],id:x}})}catch(u){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(u.toString()))}finally{c()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getSenders().filter(u=>{var h;return e.indexOf(((h=u.track)===null||h===void 0?void 0:h.id)||"")!==-1});if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(u=>{Or()&&u.replaceTrack(null),this.peerConnection.removeTrack(u)});const o=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}}async receive(e,i,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:u,mslabel:h}=this.remoteSDP.send(e,i,c),_=new ut((S,C)=>{const I=setTimeout(()=>{C(new Error("Cannot receive track, id: ".concat(u)))},1e4),b=x=>{const D=ln();if((D.name==="Safari"&&Number(D.version)===11||ys())&&x.track.id!==u&&x.streams[0].id===h){var M;const K=x.streams[0].getTracks()[0];return(M=this.remoteSDP)===null||M===void 0||M.updateTrackLabel(e,u,x.track.id),this.peerConnection.removeEventListener("track",b),clearTimeout(I),void S(K)}if(x.track.id===u)return this.peerConnection.removeEventListener("track",b),clearTimeout(I),void S(x.track)};this.peerConnection.addEventListener("track",b)}),m=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:m});const g=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(g),{track:await _,id:u}}catch(u){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(o=>{var c;return e.indexOf(((c=o.track)===null||c===void 0?void 0:c.id)||"")!==-1});if(i.length!==e.length)throw new Error("sender' length doesn't match mids' length.");i.map(o=>{if(Or()&&o.track)o.track.enabled=!1;else{const c=o.getParameters();c.encodings.forEach(u=>u.active=!1),o.setParameters(c)}})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(u=>{var h;return e.indexOf(((h=u.track)===null||h===void 0?void 0:h.id)||"")!==-1});if(i.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");i.map(async u=>{if(Or()&&u.track)u.track.enabled=!0;else{const h=u.getParameters();h.encodings.forEach(_=>_.active=!0),await u.setParameters(h)}});const o=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(o);const c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(e){var i=this;return Wo(function*(){const o=yield Pe(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(sn().supportPCSetConfiguration){const m=i.peerConnection.getConfiguration(),g=e===Wr.RELAY?"relay":"all";m.iceTransportPolicy!==g&&(O.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(m.iceTransportPolicy,"] to [").concat(g,"]")),m.iceTransportPolicy=g,i.peerConnection.setConfiguration(m))}else if(e===Wr.RELAY)return;e!==Wr.RELAY&&i.remoteSDP.updateCandidates(e);const c=yield Pe(i.peerConnection.createOffer({iceRestart:!0}));if(!c.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const u=Vc(c.sdp),{remoteIceParameters:h}=yield u.iceParameters;i.remoteSDP.restartICE(h);const _=i.remoteSDP.toString();yield Pe(i.peerConnection.setLocalDescription(c)),yield Pe(i.peerConnection.setRemoteDescription({type:"answer",sdp:_}))}catch(c){O.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),c)}finally{o()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);const u=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new ft(j.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,i){const o=this.peerConnection.getSenders().filter(c=>{var u;return((u=c.track)===null||u===void 0?void 0:u.id)===e});o.length===1&&await this.applySendEncodings(o,[i])}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const o=this.peerConnection.getSenders().find(c=>{var u;return((u=c.track)===null||u===void 0?void 0:u.id)===i});o&&await o.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,i){throw new ft(j.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new ft(j.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,O.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,O.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},Q("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(N_(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...bi.turnServerConfigToIceServers(e.turnServer.servers)),Q("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...bi.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(o=>{o.security?o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),i}async updateRtpSenderEncodings(e,i){var o;if(i||(i=this.peerConnection.getSenders().find(g=>{var S;return((S=g.track)===null||S===void 0?void 0:S.id)===e._mediaStreamTrack.id})),!i)return O.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!sn().supportSetRtpSenderParameters)return O.warn("Browser not support set rtp-sender parameters");const c={},u={};if(e instanceof ke)switch(e._optimizationMode){case"motion":c.degradationPreference="maintain-framerate";break;case"detail":c.degradationPreference="maintain-resolution";break;default:c.degradationPreference="balanced"}if(Q("DSCP_TYPE")&&Du()){var h;const g=Q("DSCP_TYPE");Jt(h=["very-low","low","medium","high"]).call(h,g)&&(u.networkPriority=g)}const _=i.getParameters(),m=(o=_.encodings)===null||o===void 0?void 0:o[0];m&&Object.assign(m,u),Object.assign(_,c),O.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(_.encodings))),await i.setParameters(_)}async applySendEncodings(e,i){try{if(!sn().supportSetRtpSenderParameters||e.length!==i.length)return;for(let o=0;o<e.length;o++){const c=e[o],u=i[o];c&&u&&await this.updateRtpSenderEncodings(u,c)}}catch{O.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,i){const o=ci.parse(e);return i.forEach((c,u)=>{const h=c._mediaStreamTrack,_=o.mediaDescriptions.find(m=>m.attributes.mid===h.kind);_&&so(_,c)}),ci.print(o)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,i,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const i=this.remoteSDP.batchSend(e).map((u,h)=>{let{id:_,mslabel:m}=u;const{kind:g}=e[h];return new ut((S,C)=>{const I=setTimeout(()=>{C(new Error("Cannot receive track, id: ".concat(_)))},1e4),b=x=>{const D=ln();if(D.name==="Safari"&&Number(D.version)===11&&x.track.id!==_&&x.streams[0].id===m){var M;const K=x.streams[0].getTracks()[0];return(M=this.remoteSDP)===null||M===void 0||M.updateTrackLabel(g,_,x.track.id),this.peerConnection.removeEventListener("track",b),clearTimeout(I),void S({track:K,id:_})}if(x.track.id===_)return this.peerConnection.removeEventListener("track",b),clearTimeout(I),void S({track:x.track,id:_})};this.peerConnection.addEventListener("track",b)})}),o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const c=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(c),await ut.all(i)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(sn().supportPCSetConfiguration){const i=bi.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}function oo(s,e,i){const o=s[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const c=this.mutex,u=await c.lock("Locking from P2PConnection.".concat(e));try{for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];return await o.apply(this,_)}finally{u()}},i}function oO(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Qu(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?oO(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):oO(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}Tt([oo,V("design:type",Function),V("design:paramtypes",[Object,Object,Array,Object,String,String]),V("design:returntype",ut)],bi.prototype,"connect",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],bi.prototype,"stopSending",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[String,Array,String,Object]),V("design:returntype",ut)],bi.prototype,"receive",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],bi.prototype,"stopReceiving",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],bi.prototype,"muteRemote",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],bi.prototype,"unmuteRemote",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],bi.prototype,"muteLocal",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],bi.prototype,"unmuteLocal",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],bi.prototype,"close",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],bi.prototype,"updateEncoderConfig",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],bi.prototype,"updateSendParameters",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[os,String]),V("design:returntype",ut)],bi.prototype,"replaceTrack",null),Tt([oo,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],bi.prototype,"getRemoteSSRC",null);const AE="9",aO=4e4;function cO(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Vp(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?cO(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):cO(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class wi extends Hr{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,i;return(e=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return Jt(i=Object.keys(Sl)).call(i,e)}))]}constructor(e,i){super(e,i),A(this,"store",void 0),A(this,"peerConnection",void 0),A(this,"remoteSDP",void 0),A(this,"initialOffer",void 0),A(this,"transportEventReceiver",void 0),A(this,"statsFilter",void 0),A(this,"useXR",Q("USE_XR")),A(this,"localCapabilities",void 0),A(this,"remoteCodecs",void 0),A(this,"localCandidateCount",0),A(this,"allCandidatesReceived",!1),A(this,"dataStreamChannelMap",new Map),A(this,"establishPromise",void 0),A(this,"recoveredDataChannelIds",[]),A(this,"currentDataChannelId",1),A(this,"mutex",new Sr("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(wi.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Ju(this.peerConnection,Q("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void O.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}else O.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=Vc(e.sdp),o=await bg({filterRTX:!Q("USE_PUB_RTX")&&!Q("USE_SUB_RTX"),filterVideoFec:Q("FILTER_VIDEO_FEC"),filterAudioFec:Q("FILTER_AUDIO_FEC"),filterVideoCodec:Q("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=xp(o),this.initialOffer=e,Vp(Vp({},i),{},{rtpCapabilities:o,offerSDP:e.sdp})}catch(e){throw new ft(j.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,o,c,u,h){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return Jn(this._localCapabilities)}get rtpCapabilities(){return Jn(this._rtpCapabilities)}get candidates(){return Jn(this._candidates)}get iceParameters(){return Jn(this._iceParameters)}get dtlsParameters(){return Jn(this._dtlsParameters)}constructor(b){A(this,"sessionDesc",void 0),A(this,"_localCapabilities",void 0),A(this,"_rtpCapabilities",void 0),A(this,"_candidates",void 0),A(this,"_iceParameters",void 0),A(this,"_dtlsParameters",void 0),A(this,"setup",void 0),A(this,"currentMidIndex",void 0),A(this,"cname",void 0),A(this,"firefoxSsrcMidMap",new Map),b=Jn(b);const{remoteIceParameters:x,remoteDtlsParameters:D,candidates:M,remoteRTPCapabilities:K,remoteSetup:z,localCapabilities:nt,cname:dt}=b,it=ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=K,this._candidates=M,this._iceParameters=x,this._dtlsParameters=D,this._localCapabilities=nt,this.setup=z,this.cname=dt;const at=this.rtpCapabilities.send;for(const ht of it.mediaDescriptions){if(ht.attributes.iceUfrag=x.iceUfrag,ht.attributes.icePwd=x.icePwd,ht.attributes.fingerprints=D.fingerprints,ht.attributes.candidates=M,ht.attributes.setup=z,ht.media.mediaType==="video"&&(ht.media.fmts=at.videoCodecs.map(pt=>pt.payloadType.toString(10)),ht.attributes.payloads=at.videoCodecs,ht.attributes.extmaps=at.videoExtensions,Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:pt,ssrcGroups:bt}=ro([{ssrcId:aO,rtx:Q("USE_SUB_RTX")?40001:void 0}],this.cname);ht.attributes.ssrcs=pt,ht.attributes.ssrcGroups=bt}if(ht.media.mediaType==="audio"&&(ht.media.fmts=at.audioCodecs.map(pt=>pt.payloadType.toString(10)),ht.attributes.payloads=at.audioCodecs,ht.attributes.extmaps=at.audioExtensions,Rd(ht),Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:pt,ssrcGroups:bt}=ro([{ssrcId:2e4}],this.cname);ht.attributes.ssrcs=pt,ht.attributes.ssrcGroups=bt}}this.sessionDesc=it,this.currentMidIndex=it.mediaDescriptions.length-1}preloadRemoteMedia(){const b=Q("PRELOAD_MEDIA_COUNT"),x=this.candidates,D=this.dtlsParameters,M=this.iceParameters,K=this.rtpCapabilities.send;for(let z=1;z<b;z++){const nt=2*z+2e4,dt=2*z+aO,{ssrcs:it,ssrcGroups:at}=ro([{ssrcId:nt}],this.cname),{ssrcs:ht,ssrcGroups:pt}=ro([{ssrcId:dt,rtx:Q("USE_SUB_RTX")?dt+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:AE,protos:["UDP","TLS","RTP","SAVPF"],fmts:K.videoCodecs.map(bt=>bt.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:M.iceUfrag,icePwd:M.icePwd,unrecognized:[],candidates:x,extmaps:K.videoExtensions,fingerprints:D.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:ht,ssrcGroups:pt,rtcpFeedbackWildcards:[],payloads:K.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*z)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:AE,protos:["UDP","TLS","RTP","SAVPF"],fmts:K.audioCodecs.map(bt=>bt.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:M.iceUfrag,icePwd:M.icePwd,unrecognized:[],candidates:x,extmaps:K.audioExtensions,fingerprints:D.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:it,ssrcGroups:at,rtcpFeedbackWildcards:[],payloads:K.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*z+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return ci.print(this.sessionDesc)}send(b,x,D,M){const{ssrcs:K,ssrcGroups:z}=ro(x,this.cname,Q("SYNC_GROUP")?D:void 0),nt=this.findPreloadMediaDesc(K);if(nt){if(Ln()&&this.firefoxSsrcMidMap.set(K[0].ssrcId,nt.attributes.mid),M&&(M.twcc||M.remb)){const dt=this.sessionDesc.mediaDescriptions.indexOf(nt);return this.sessionDesc.mediaDescriptions[dt]=this.mungSendMediaDesc(nt,M),{mid:nt.attributes.mid,needExchangeSDP:!0}}return{mid:nt.attributes.mid,needExchangeSDP:!1}}{const dt=this.findAvailableMediaIndex(b,K);let it;return dt===-1||dt===1&&(Or()||ZP())||dt===0&&Q("USE_SUB_RTX")||$P()?(it=this.createOrRecycleSendMedia(b,K,z,"sendonly",M),this.updateBundleMids()):(it=Jn(this.sessionDesc.mediaDescriptions[dt]),it.attributes.direction="sendonly",it.attributes.ssrcs=K,it.attributes.ssrcGroups=z,this.sessionDesc.mediaDescriptions[dt]=this.mungSendMediaDesc(it,M)),Ln()&&this.firefoxSsrcMidMap.set(K[0].ssrcId,it.attributes.mid),{mid:it.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:b,needExchangeSDP:x}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:b.attributes.mid,needExchangeSDP:x}}batchSend(b){const x=b.map(K=>{let{kind:z,ssrcMsg:nt,mslabel:dt}=K;return this.send(z,nt,dt)}),D=[];let M=!1;return x.forEach(K=>{let{mid:z,needExchangeSDP:nt}=K;nt&&(M=!0),D.push(z)}),{mids:D,needExchangeSDP:M}}stopSending(b){const x=this.sessionDesc.mediaDescriptions.filter(D=>D.attributes.mid&&b.indexOf(D.attributes.mid)!==-1);if(x.length!==b.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");x.forEach(D=>{D.attributes.mid==="0"||Ln()||$P()?D.attributes.ssrcs=[]:(D.attributes.ssrcs=[],D.attributes.direction="inactive",D.media.port="0")}),this.updateBundleMids()}mute(b){const x=this.sessionDesc.mediaDescriptions.find(D=>D.attributes.mid===b);if(!x)throw new Error("mediaDescription not found with ".concat(b," in remote SDP when calling RemoteSDP.mute."));x.attributes.direction="inactive"}unmute(b){const x=this.sessionDesc.mediaDescriptions.find(D=>D.attributes.mid===b);if(!x)throw new Error("mediaDescription not found with ".concat(b," in remote SDP when calling RemoteSDP.unmute."));x.attributes.direction="sendonly"}muteRemote(b){const x=this.sessionDesc.mediaDescriptions.filter(D=>Jt(b).call(b,D.attributes.mid||""));if(x.length!==b.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");x.forEach(D=>{D.attributes.direction="inactive"})}unmuteRemote(b){const x=this.sessionDesc.mediaDescriptions.filter(D=>Jt(b).call(b,D.attributes.mid||""));if(x.length!==b.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");x.forEach(D=>{D.attributes.direction="recvonly"})}receive(b,x,D,M){b.forEach((K,z)=>{this.createOrRecycleRecvMedia(K,[],"recvonly",x,D,M[z])}),this.updateBundleMids()}stopReceiving(b){const x=this.sessionDesc.mediaDescriptions.filter(D=>b.indexOf(D.attributes.mid)!==-1);if(x.length!==b.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");x.forEach(D=>{D.media.port="0",D.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(b){const x=this._candidates.filter(D=>D.transport==="udp");if(b===Wr.TCP){if(x.length===0)return;if(Q("TCP_CANDIDATE_ONLY")){const D=this._candidates.filter(M=>M.transport==="tcp");x.forEach(M=>{D.findIndex(K=>K.connectionAddress===M.connectionAddress)===-1&&D.push(Qu(Qu({},M),{},{foundation:"tcpcandidate",priority:Number(M.priority)-1+"",transport:"tcp",port:Number(M.port)+90+""}))}),this._candidates=D}else{const D=[];x.forEach(M=>{D.push(Qu(Qu({},M),{},{foundation:"tcpcandidate",priority:Number(M.priority)-1+"",transport:"tcp",port:Number(M.port)+90+""}))}),this._candidates=[...x,...D]}}else if(b===Wr.RELAY){if(x.length!==0)return;{const D=this._candidates.filter(M=>M.transport==="tcp");D.forEach(M=>{x.push(Qu(Qu({},M),{},{foundation:"udpcandidate",priority:Number(M.priority)+1+"",transport:"udp",port:Number(M.port)-90+""}))}),this._candidates=[...x,...D]}}else x.length===0?(this._candidates.filter(D=>D.transport==="tcp").forEach(D=>{x.push(Qu(Qu({},D),{},{foundation:"udpcandidate",priority:Number(D.priority)+1+"",transport:"udp",port:Number(D.port)-90+""}))}),this._candidates=x):this._candidates=this._candidates.filter(D=>D.transport!=="tcp");for(const D of this.sessionDesc.mediaDescriptions)D.attributes.candidates=this.candidates}restartICE(b){b=Jn(b),this._iceParameters=b,this.sessionDesc.mediaDescriptions.forEach(x=>{x.attributes.iceUfrag=b.iceUfrag,x.attributes.icePwd=b.icePwd})}predictReceivingMids(b){const x=[];for(let D=0;D<b;D++)x.push((this.currentMidIndex+D+1).toString(10));return x}findAvailableMediaIndex(b,x){return this.sessionDesc.mediaDescriptions.findIndex(D=>{const M=D.media.mediaType===b&&D.media.port!=="0"&&(D.attributes.direction==="sendonly"||D.attributes.direction==="sendrecv")&&D.attributes.ssrcs.length===0;if(Ln()){if(M){const K=this.firefoxSsrcMidMap.get(x[0].ssrcId);return!(K||D.attributes.mid!=="0"&&D.attributes.mid!=="1")||!(!K||K!==D.attributes.mid)}return!1}return M})}createOrRecycleDataChannel(){for(const D of this.sessionDesc.mediaDescriptions)if(D.media.mediaType==="application")return{mediaDesc:D,needExchangeSDP:!1};this.currentMidIndex+=1;const b="".concat(this.currentMidIndex),x={media:{mediaType:"application",port:AE,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(b),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(x),{mediaDesc:x,needExchangeSDP:!0}}createOrRecycleRecvMedia(b,x,D,M,K,z){const nt=b._mediaStreamTrack.kind,dt=this.rtpCapabilities.recv,it=su(nt,dt,this.localCapabilities.send,nt===Xt.VIDEO?M:K),at=nt===Xt.VIDEO?dt.videoExtensions:dt.audioExtensions;this.currentMidIndex+=1;const ht="".concat(this.currentMidIndex);let pt={media:{mediaType:nt,port:AE,protos:["UDP","TLS","RTP","SAVPF"],fmts:it.map(kt=>kt.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:at,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:x,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:it,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:D,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(ht)}};pt=this.mungRecvMediaDsec(pt,b,z);const bt=this.findFirstClosedMedia(nt);if(bt){const kt=this.sessionDesc.mediaDescriptions.indexOf(bt);this.sessionDesc.mediaDescriptions[kt]=pt}else this.sessionDesc.mediaDescriptions.push(pt);return pt}updateRemoteCodec(b,x,D){const M=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(pt=>pt.rtpMap&&pt.rtpMap.encodingName.toLowerCase()||"").filter(pt=>{var bt;return Jt(bt=Object.keys(Sl)).call(bt,pt)}))],K=new Set(x);if(M.every(pt=>K.has(pt)))return O.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(x)),!1;const z=this._rtpCapabilities.recv.videoCodecs.filter(pt=>x.some(bt=>{var kt;return Jt(kt=pt.rtpMap&&pt.rtpMap.encodingName.toLowerCase()||"").call(kt,bt)}));if(z.length===0)return O.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(M," codecs: ").concat(x)),!1;const nt=[...new Set(z.map(pt=>pt.rtpMap&&pt.rtpMap.encodingName.toLowerCase()||""))];let dt;if(O.debug("updateRemoteCodec, from ".concat(M," to ").concat(nt)),b.length===0)dt=this.sessionDesc.mediaDescriptions.filter(pt=>pt.media.mediaType==="video"&&pt.attributes.direction==="recvonly");else if(dt=this.sessionDesc.mediaDescriptions.filter(pt=>pt.attributes.mid&&Jt(b).call(b,pt.attributes.mid)&&pt.attributes.direction==="recvonly"),dt.length!==b.length)return O.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(b,", codecs: ").concat(x)),!1;this._rtpCapabilities.recv.videoCodecs=z;const it=this.localCapabilities.send,at=this.rtpCapabilities.recv,ht=su(Xt.VIDEO,at,it,D);return dt.forEach(pt=>{const bt=ht.map(kt=>kt.payloadType.toString(10));O.debug("updateRemoteCodec mid: ".concat(pt.attributes.mid,", from ").concat(pt.attributes.payloads," to ").concat(ht)),pt.attributes.payloads=ht,pt.media.fmts=bt}),!0}createOrRecycleSendMedia(b,x,D,M,K){const z=this.rtpCapabilities.send,nt=b===Xt.VIDEO?z.videoCodecs:z.audioCodecs,dt=b===Xt.VIDEO?z.videoExtensions:z.audioExtensions;this.currentMidIndex+=1;const it="".concat(this.currentMidIndex);let at={media:{mediaType:b,port:AE,protos:["UDP","TLS","RTP","SAVPF"],fmts:nt.map(pt=>pt.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:dt,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:x,ssrcGroups:D,rtcpFeedbackWildcards:[],payloads:nt,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:M,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(it)}};at=this.mungSendMediaDesc(at,K);const ht=this.findFirstClosedMedia(b);if(ht){const pt=this.sessionDesc.mediaDescriptions.indexOf(ht);this.sessionDesc.mediaDescriptions[pt]=at}else this.sessionDesc.mediaDescriptions.push(at);return at}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(b=>b.media.port!=="0").map(b=>b.attributes.mid)}mungRecvMediaDsec(b,x,D){const M=Jn(b);return yg(M),so(M,x),Sd(M,x),Ag(M),IE(M,D,this.localCapabilities.send),M}mungSendMediaDesc(b,x){const D=Jn(b);return IE(D,x,this.localCapabilities.recv),Rd(D),D}updateRecvMedia(b,x){const D=this.sessionDesc.mediaDescriptions.findIndex(M=>M.attributes.mid===b);if(D!==-1){const M=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[D],x);this.sessionDesc.mediaDescriptions[D]=M}}bumpMid(b){this.currentMidIndex+=b}findFirstClosedMedia(b){return this.sessionDesc.mediaDescriptions.find(x=>Ln()?x.media.port==="0"&&x.media.mediaType===b:x.media.port==="0")}findPreloadMediaDesc(b){return this.sessionDesc.mediaDescriptions.find(x=>{var D;return((D=x.attributes)===null||D===void 0||(D=D.ssrcs[0])===null||D===void 0?void 0:D.ssrcId)===b[0].ssrcId})}getSSRC(b){var x;return(x=this.sessionDesc.mediaDescriptions.find(D=>D.attributes.mid===b))===null||x===void 0?void 0:x.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:i,candidates:o,remoteRTPCapabilities:c,remoteSetup:u,localCapabilities:this.localCapabilities,cname:h}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const _=this.remoteSDP.toString(),m=ci.parse(this.initialOffer.sdp),g=m.mediaDescriptions.find(b=>b.media.mediaType==="audio");g&&Rd(g),this.useXR&&Zl(m);const S=ci.print(m),C=this.logSDPExchange(S||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:S}),C==null||C(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_});const I=this.peerConnection.getTransceivers()[0];if(I!=null&&I.receiver&&this.tryBindTransportEvents(I.receiver),Q("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const b=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:b});const x=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(x)}}catch(_){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(_.toString()))}}send(e,i,o){var c=this;return Wo(function*(){const u=yield Pe(c.mutex.lock("From P2PConnection.send"));try{if(!c.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const h=[];e.forEach(D=>{const M=c.peerConnection.addTransceiver(D._mediaStreamTrack,{direction:"sendonly"});h.push(M),D._updateRtpTransceiver(M)}),Ln()&&Q("SIMULCAST")===!0&&(yield Pe(c.applySimulcastForFirefox(h,e)));const _=yield Pe(c.peerConnection.createOffer()),m=c.remoteSDP.predictReceivingMids(e.length),g=c.mungSendOfferSDP(_.sdp,e,m),S=ci.parse(g),C=m.map(D=>{const M=S.mediaDescriptions.find(K=>K.attributes.mid===D);if(!M)throw new Error("Cannot extract ssrc from mediaDescription.");return fC(M,Q("USE_PUB_RTX"))});let I;try{I=yield C}catch(D){I=[],c.remoteSDP.receive(e,i,o,I);const M=c.remoteSDP.toString();throw yield Pe(c.peerConnection.setLocalDescription({type:"offer",sdp:g})),yield Pe(c.peerConnection.setRemoteDescription({type:"answer",sdp:M})),yield Pe(c.stopSending(m,!0)),D}c.remoteSDP.receive(e,i,o,I);const b=c.remoteSDP.toString(),x=c.logSDPExchange(g,"offer","local","send");return yield Pe(c.peerConnection.setLocalDescription({type:"offer",sdp:g})),yield Pe(c.applySimulcastEncodings(h,e)),yield Pe(c.applySendEncodings(h,e)),x==null||x(b),yield Pe(c.peerConnection.setRemoteDescription({type:"answer",sdp:b})),h.map((D,M)=>{const K=m[M];return{localSSRC:C[M],id:K,transceiver:D}})}catch(h){throw h instanceof ft?h:new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(h.toString()))}finally{u()}})()}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let o=this.dataStreamChannelMap.get(e);if(o&&o.readyState==="open")O.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const u=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof u!="number")throw new Error("create DataChannel error, because cannot get dc id");o=this.peerConnection.createDataChannel("datastream-channel",{id:u,negotiated:!0,ordered:!1,maxRetransmits:Q("DATASTREAM_MAX_RETRANSMITS")}),o.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,o)}i.forEach(u=>{u._updateOriginDataChannel(o)});const{needExchangeSDP:c}=this.remoteSDP.sendDataChannel();if(c){const u=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:u});const h=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(h),O.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else O.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(o){throw o instanceof ft?o:new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(o.toString()))}}async stopDataChannels(e){try{const i=this.dataStreamChannelMap.get(e);return i&&(i.id&&this.recoveredDataChannelIds.push(i.id),i.close()),void this.dataStreamChannelMap.delete(e)}catch(i){throw i instanceof ft?i:new ft(j.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(i.toString()))}}async stopSending(e,i){const o=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const c=this.peerConnection.getTransceivers().filter(m=>e.indexOf(m.mid)!==-1);if(c.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");c.map(m=>{var g;m.direction="inactive",(g=m.stop)===null||g===void 0||g.call(m)});const u=await this.peerConnection.createOffer(),h=this.logSDPExchange(u.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(u),this.remoteSDP.stopReceiving(e);const _=this.remoteSDP.toString();h==null||h(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(c){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(c.toString()))}finally{o&&o()}}async receive(e,i,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:h}=this.remoteSDP.send(e,i,o,c);if(h){const m=this.remoteSDP.toString(),g=this.logSDPExchange(m,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:m});const S=await this.peerConnection.createAnswer(),C=this.mungReceiveAnswerSDP(S.sdp,u,e);g==null||g(C||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:C}),O.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else O.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const _=this.peerConnection.getTransceivers().find(m=>m.mid===u);if(!_)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:_.receiver.track,id:u,transceiver:_}}catch(u){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:o}=this.remoteSDP.batchSend(e);if(o){const c=this.remoteSDP.toString(),u=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const h=await this.peerConnection.createAnswer();u==null||u(h.sdp||""),await this.peerConnection.setLocalDescription(h),O.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else O.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map(c=>{const u=this.peerConnection.getTransceivers().find(h=>h.mid===c);if(!u)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:u.receiver.track,id:c,transceiver:u}})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(h=>h.mid&&e.indexOf(h.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(h=>{h.direction="inactive"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.muteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(h=>h.mid&&e.indexOf(h.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(h,_)=>{h.direction="sendonly"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.unmuteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(i){throw new ft(j.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(e){var i=this;return Wo(function*(){const o=yield Pe(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(sn().supportPCSetConfiguration){const g=i.peerConnection.getConfiguration(),S=e===Wr.RELAY?"relay":"all";g.iceTransportPolicy!==S&&(O.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(g.iceTransportPolicy,"] to [").concat(S,"]")),g.iceTransportPolicy=S,i.peerConnection.setConfiguration(g))}else if(e===Wr.RELAY)return;i.remoteSDP.updateCandidates(e);const c=yield Pe(i.peerConnection.createOffer({iceRestart:!0}));if(!c.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const u=Vc(c.sdp),{remoteIceParameters:h}=yield u.iceParameters;i.remoteSDP.restartICE(h);const _=i.remoteSDP.toString(),m=i.logSDPExchange(c.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield Pe(i.peerConnection.setLocalDescription(c)),m==null||m(_),yield Pe(i.peerConnection.setRemoteDescription({type:"answer",sdp:_}))}catch(c){O.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),c)}finally{o()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const u=this.remoteSDP.toString(),h=this.logSDPExchange(c,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),h==null||h(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new ft(j.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,i){const o=this.peerConnection.getTransceivers().filter(c=>c.mid===e);o.length===1&&(this.isVP8Simulcast(i)?Ln()||await this.applySimulcastEncodings(o,[i]):await this.applySendEncodings(o,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const o=this.peerConnection.getTransceivers().find(c=>c.mid===i);o&&await o.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const i=e[0].transport.iceTransport,{local:o,remote:c}=i.getSelectedCandidatePair();return{local:Vp(Vp({},ya),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port}),remote:Vp(Vp({},ya),{},{candidateType:c.type,protocol:c.protocol,address:c.address,port:c.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,O.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,O.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},Q("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(N_(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...wi.turnServerConfigToIceServers(e.turnServer.servers)),Q("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...wi.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Q("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(i.iceTransportPolicy="relay")}))),Q("ENABLE_ENCODED_TRANSFORM")&&sn().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(o=>{o.security?o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(qt(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&!Q("FORCE_TURN_TCP")&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),i}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var c;i!=null&&i.state&&((c=this.onDTLSTransportStateChange)===null||c===void 0||c.call(this,i.state))},i.onerror=c=>{var u;(u=this.onDTLSTransportError)===null||u===void 0||u.call(this,"error"in c?c.error:c)};const o=i.iceTransport;o&&(o.onstatechange=()=>{const c=i==null?void 0:i.iceTransport.state;var u;c&&((u=this.onICETransportStateChange)===null||u===void 0||u.call(this,c))},o.getSelectedCandidatePair&&(o.onselectedcandidatepairchange=()=>{if(o.getSelectedCandidatePair()){const{local:c,remote:u}=o.getSelectedCandidatePair();O.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:c.type,protocol:c.protocol}),", remote ").concat(JSON.stringify({candidateType:u.type,protocol:u.protocol,address:u.address,port:u.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var o;if(i||(i=this.peerConnection.getSenders().find(S=>S.track===e._mediaStreamTrack)),!i)return O.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return O.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!sn().supportSetRtpSenderParameters)return O.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const c={},u={};switch(e._optimizationMode){case"motion":c.degradationPreference="maintain-framerate";break;case"detail":c.degradationPreference="maintain-resolution";break;default:c.degradationPreference="balanced"}if(e._encoderConfig){var h;const{bitrateMax:S,frameRate:C,scaleResolutionDownBy:I}=e._encoderConfig;S&&(u.maxBitrate=1e3*S),(Jt(h=e._hints).call(h,Fn.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(C&&(u.maxFramerate=_t(C)),I&&I>=1&&(u.scaleResolutionDownBy=I))}if(Q("DSCP_TYPE")&&Du()){var _;const S=Q("DSCP_TYPE");Jt(_=["very-low","low","medium","high"]).call(_,S)&&(u.networkPriority=S)}const m=i.getParameters(),g=(o=m.encodings)===null||o===void 0?void 0:o[0];Ln()&&!g&&(c.encodings=[u]),g&&Object.assign(g,u),Object.assign(m,c),O.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(m.encodings))),await i.setParameters(m)}async applySendEncodings(e,i){try{if(!sn().supportSetRtpSenderParameters||e.length!==i.length)return;for(let o=0;o<e.length;o++){const c=e[o],u=i[o];u instanceof ke&&!this.isVP8Simulcast(u)&&await this.updateRtpSenderEncodings(u,c.sender)}}catch{O.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,i,o){const c=ci.parse(e);return i.forEach((u,h)=>{const _=o[h],m=c.mediaDescriptions.find(g=>g.attributes.mid===_);m&&(so(m,u),yE(m,u,this.store.codec))}),ci.print(c)}mungReceiveAnswerSDP(e,i,o){const c=ci.parse(e),u=c.mediaDescriptions.find(h=>h.attributes.mid===i);return u&&(o===Xt.AUDIO&&u.media.mediaType==="audio"&&Rd(u),this.useXR&&Zl(c)),ci.print(c)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,i,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let m=0;m<e.length;m++){var o,c,u,h,_;const g=e[m],S=i[m];if(S instanceof ke&&!Jt(o=S._hints).call(o,Fn.LOW_STREAM)&&(c=S._encoderConfig)!==null&&c!==void 0&&c.bitrateMax&&((u=S._encoderConfig)===null||u===void 0?void 0:u.bitrateMax)>200&&(h=S._scalabilityMode)!==null&&h!==void 0&&h.numSpatialLayers&&((_=S._scalabilityMode)===null||_===void 0?void 0:_.numSpatialLayers)>1&&this.store.codec==="vp8"){const C={},I={high:1e3*(S._encoderConfig.bitrateMax-50),medium:5e4};C.encodings=[{rid:"m",active:!0,maxBitrate:I.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:I.high}];const b=g.sender.getParameters();await g.sender.setParameters(Object.assign(b,C))}}}async applySimulcastEncodings(e,i){if(!Ln()&&e.length===i.length)for(let o=0;o<e.length;o++){const c=i[o];if(c instanceof ke&&this.isVP8Simulcast(c)){const u=e[o],h={},_={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:_.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:_.medium,scaleResolutionDownBy:4}];const m=u.sender.getParameters();await u.sender.setParameters(Object.assign(m,h))}}}isVP8Simulcast(e){var i,o,c,u,h;return!!(e instanceof ke&&Q("SIMULCAST")&&this.store.codec==="vp8"&&!Jt(i=e._hints).call(i,Fn.LOW_STREAM)&&(o=e._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((c=e._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)>200&&(u=e._scalabilityMode)!==null&&u!==void 0&&u.numSpatialLayers&&((h=e._scalabilityMode)===null||h===void 0?void 0:h.numSpatialLayers)>1)}logSDPExchange(e,i,o,c){if(Q("SDP_LOGGING"))return O.upload("[".concat(this.store.clientId,"] exchanging ").concat(o," ").concat(i," SDP during P2PConnection.").concat(c,`
`),e),i==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(sn().supportPCSetConfiguration){const i=wi.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}function Ro(s,e,i){const o=s[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const c=this.mutex,u=await c.lock("From P2PConnection.".concat(e));try{for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];return await o.apply(this,_)}finally{u()}},i}function d1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function u1(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?d1(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):d1(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}Tt([Ro,V("design:type",Function),V("design:paramtypes",[Array,Array]),V("design:returntype",ut)],wi.prototype,"updateRemoteRTPCapabilities",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[Object,Object,Array,Object,String,String]),V("design:returntype",ut)],wi.prototype,"connect",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[Object,Array]),V("design:returntype",ut)],wi.prototype,"createDataChannels",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[String,Array,String,Object]),V("design:returntype",ut)],wi.prototype,"receive",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],wi.prototype,"batchReceive",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],wi.prototype,"stopReceiving",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],wi.prototype,"muteRemote",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],wi.prototype,"unmuteRemote",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],wi.prototype,"muteLocal",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],wi.prototype,"unmuteLocal",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],wi.prototype,"close",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],wi.prototype,"updateEncoderConfig",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],wi.prototype,"updateSendParameters",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[os,String]),V("design:returntype",ut)],wi.prototype,"replaceTrack",null),Tt([Ro,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],wi.prototype,"getRemoteSSRC",null);const Fp=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,ih="9",IC=2e4,au=4e4;class l1{get localCapabilities(){return Jn(this._localCapabilities)}get rtpCapabilities(){return Jn(this._rtpCapabilities)}get candidates(){return Jn(this._candidates)}get iceParameters(){return Jn(this._iceParameters)}get dtlsParameters(){return Jn(this._dtlsParameters)}constructor(e){A(this,"sessionDesc",void 0),A(this,"_localCapabilities",void 0),A(this,"_rtpCapabilities",void 0),A(this,"_candidates",void 0),A(this,"_iceParameters",void 0),A(this,"_dtlsParameters",void 0),A(this,"setup",void 0),A(this,"currentMidIndex",void 0),A(this,"cname",void 0),A(this,"firefoxSsrcMidMap",new Map),e=Jn(e);const{remoteIceParameters:i,remoteDtlsParameters:o,candidates:c,remoteRTPCapabilities:u,remoteSetup:h,localCapabilities:_,cname:m}=e,g=ci.parse(Fp);this._rtpCapabilities=u,this._candidates=c,this._iceParameters=i,this._dtlsParameters=o,this._localCapabilities=_,this.setup=h,this.cname=m;const S=this.rtpCapabilities.send;for(const C of g.mediaDescriptions){if(C.attributes.iceUfrag=i.iceUfrag,C.attributes.icePwd=i.icePwd,C.attributes.fingerprints=o.fingerprints,C.attributes.candidates=c,C.attributes.setup=h,C.media.mediaType==="application"&&(C.attributes.sctpPort="5000"),C.media.mediaType==="video"&&(C.media.fmts=S.videoCodecs.map(I=>I.payloadType.toString(10)),C.attributes.payloads=S.videoCodecs,C.attributes.extmaps=S.videoExtensions,Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:I,ssrcGroups:b}=ro([{ssrcId:au,rtx:Q("USE_SUB_RTX")?40001:void 0}],this.cname);C.attributes.ssrcs=I,C.attributes.ssrcGroups=b}if(C.media.mediaType==="audio"&&(C.media.fmts=S.audioCodecs.map(I=>I.payloadType.toString(10)),C.attributes.payloads=S.audioCodecs,C.attributes.extmaps=S.audioExtensions,Rd(C),Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:I,ssrcGroups:b}=ro([{ssrcId:IC}],this.cname);C.attributes.ssrcs=I,C.attributes.ssrcGroups=b}}this.sessionDesc=g,this.currentMidIndex=g.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const i=ci.parse(Fp);this._rtpCapabilities=e;const o=this.rtpCapabilities.send;for(const c of i.mediaDescriptions){if(c.attributes.iceUfrag=this._iceParameters.iceUfrag,c.attributes.icePwd=this._iceParameters.icePwd,c.attributes.fingerprints=this._dtlsParameters.fingerprints,c.attributes.candidates=this._candidates,c.attributes.setup=this.setup,c.media.mediaType==="application"&&(c.attributes.sctpPort="5000"),c.media.mediaType==="video"&&(c.media.fmts=o.videoCodecs.map(u=>u.payloadType.toString(10)),c.attributes.payloads=o.videoCodecs,c.attributes.extmaps=o.videoExtensions,Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:u,ssrcGroups:h}=ro([{ssrcId:au,rtx:Q("USE_SUB_RTX")?40001:void 0}],this.cname);c.attributes.ssrcs=u,c.attributes.ssrcGroups=h}if(c.media.mediaType==="audio"&&(c.media.fmts=o.audioCodecs.map(u=>u.payloadType.toString(10)),c.attributes.payloads=o.audioCodecs,c.attributes.extmaps=o.audioExtensions,Q("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:u,ssrcGroups:h}=ro([{ssrcId:IC}],this.cname);c.attributes.ssrcs=u,c.attributes.ssrcGroups=h}}this.sessionDesc=i,this.currentMidIndex=i.mediaDescriptions.length-1}preloadRemoteMedia(e){const i=this.candidates,o=this.dtlsParameters,c=this.iceParameters,u=this.rtpCapabilities.send;for(let h=1;h<e;h++){const _=2*h+IC,m=2*h+au,{ssrcs:g,ssrcGroups:S}=ro([{ssrcId:_}],this.cname),{ssrcs:C,ssrcGroups:I}=ro([{ssrcId:m,rtx:Q("USE_SUB_RTX")?m+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:ih,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.videoCodecs.map(b=>b.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:c.iceUfrag,icePwd:c.icePwd,unrecognized:[],candidates:i,extmaps:u.videoExtensions,fingerprints:o.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:C,ssrcGroups:I,rtcpFeedbackWildcards:[],payloads:u.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*h-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:ih,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.audioCodecs.map(b=>b.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:c.iceUfrag,icePwd:c.icePwd,unrecognized:[],candidates:i,extmaps:u.audioExtensions,fingerprints:o.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:g,ssrcGroups:S,rtcpFeedbackWildcards:[],payloads:u.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*h)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return ci.print(this.sessionDesc)}send(e,i,o,c){const{ssrcs:u,ssrcGroups:h}=ro(i,this.cname,Q("SYNC_GROUP")?o:void 0),_=this.findPreloadMediaDesc(u);if(_){if(Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,_.attributes.mid),c&&(c.twcc||c.remb)){const m=this.sessionDesc.mediaDescriptions.indexOf(_);return this.sessionDesc.mediaDescriptions[m]=this.mungSendMediaDesc(_,c),{mid:_.attributes.mid,needExchangeSDP:!0}}return{mid:_.attributes.mid,needExchangeSDP:!1}}{const m=this.findAvailableMediaIndex(e,u);let g;return m===-1||Or()||ys()||ZP()||m===0&&Q("USE_SUB_RTX")?(g=this.createOrRecycleSendMedia(e,u,h,"sendonly",c),this.updateBundleMids()):(g=Jn(this.sessionDesc.mediaDescriptions[m]),g.attributes.direction="sendonly",g.attributes.ssrcs=u,g.attributes.ssrcGroups=h,this.sessionDesc.mediaDescriptions[m]=this.mungSendMediaDesc(g,c)),Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,g.attributes.mid),{mid:g.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const i=e.map(u=>{let{kind:h,ssrcMsg:_,mslabel:m}=u;return this.send(h,_,m)}),o=[];let c=!1;return i.forEach(u=>{let{mid:h,needExchangeSDP:_}=u;_&&(c=!0),o.push(h)}),{mids:o,needExchangeSDP:c}}stopSending(e){const i=this.sessionDesc.mediaDescriptions.filter(o=>o.attributes.mid&&e.indexOf(o.attributes.mid)!==-1);if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");i.forEach(o=>{o.attributes.mid==="0"||Ln()||Or()||ys()?o.attributes.ssrcs=[]:(o.attributes.ssrcs=[],o.attributes.direction="inactive",o.media.port="0")}),this.updateBundleMids()}mute(e){const i=this.sessionDesc.mediaDescriptions.find(o=>o.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(e){const i=this.sessionDesc.mediaDescriptions.find(o=>o.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}muteRemote(e){const i=this.sessionDesc.mediaDescriptions.filter(o=>Jt(e).call(e,o.attributes.mid||""));if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(o=>{o.attributes.direction="inactive"})}unmuteRemote(e){const i=this.sessionDesc.mediaDescriptions.filter(o=>Jt(e).call(e,o.attributes.mid||""));if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(o=>{o.attributes.direction="recvonly"})}receive(e,i,o,c){e.forEach((u,h)=>{this.createOrRecycleRecvMedia(u,[],"recvonly",i,o,c[h])}),this.updateBundleMids()}stopReceiving(e){const i=this.sessionDesc.mediaDescriptions.filter(o=>e.indexOf(o.attributes.mid)!==-1);if(i.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");i.forEach(o=>{o.media.port="0",o.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(e){e===Wr.TCP?this._candidates.forEach(i=>{this._candidates.findIndex(o=>o.transport==="tcp"&&o.connectionAddress===i.connectionAddress&&o.port===i.port)===-1&&this._candidates.push(u1(u1({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}):this._candidates=this._candidates.filter(i=>i.transport!=="tcp");for(const i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}restartICE(e){e=Jn(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=e.iceUfrag,i.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const i=[];for(let o=0;o<e;o++)i.push((this.currentMidIndex+o+1).toString(10));return i}findAvailableMediaIndex(e,i){return this.sessionDesc.mediaDescriptions.findIndex(o=>{const c=o.media.mediaType===e&&o.media.port!=="0"&&(o.attributes.direction==="sendonly"||o.attributes.direction==="sendrecv")&&o.attributes.ssrcs.length===0;if(Ln()){if(c){const u=this.firefoxSsrcMidMap.get(i[0].ssrcId);return!(u||o.attributes.mid!=="0"&&o.attributes.mid!=="1")||!(!u||u!==o.attributes.mid)}return!1}return c})}createOrRecycleRecvMedia(e,i,o,c,u,h){const _=e._mediaStreamTrack.kind,m=this.rtpCapabilities.recv,g=su(_,m,this.localCapabilities.send,_===Xt.VIDEO?c:u),S=_===Xt.VIDEO?m.videoExtensions:m.audioExtensions;this.currentMidIndex+=1;const C="".concat(this.currentMidIndex);let I={media:{mediaType:_,port:ih,protos:["UDP","TLS","RTP","SAVPF"],fmts:g.map(x=>x.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:S,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:g,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:o,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(C)}};I=this.mungRecvMediaDsec(I,e,h);const b=this.findFirstClosedMedia(_);if(b){const x=this.sessionDesc.mediaDescriptions.indexOf(b);this.sessionDesc.mediaDescriptions[x]=I}else this.sessionDesc.mediaDescriptions.push(I);return I}updateRemoteCodec(e,i,o){const c=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(I=>I.rtpMap&&I.rtpMap.encodingName.toLowerCase()||"").filter(I=>{var b;return Jt(b=Object.keys(Sl)).call(b,I)}))],u=new Set(i);if(c.every(I=>u.has(I)))return O.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;const h=this._rtpCapabilities.recv.videoCodecs.filter(I=>i.some(b=>{var x;return Jt(x=I.rtpMap&&I.rtpMap.encodingName.toLowerCase()||"").call(x,b)}));if(h.length===0)return O.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(c," codecs: ").concat(i)),!1;const _=[...new Set(h.map(I=>I.rtpMap&&I.rtpMap.encodingName.toLowerCase()||""))];let m;if(O.debug("updateRemoteCodec, from ".concat(c," to ").concat(_)),e.length===0)m=this.sessionDesc.mediaDescriptions.filter(I=>I.media.mediaType==="video"&&I.attributes.direction==="recvonly");else if(m=this.sessionDesc.mediaDescriptions.filter(I=>I.attributes.mid&&Jt(e).call(e,I.attributes.mid)&&I.attributes.direction==="recvonly"),m.length!==e.length)return O.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(i)),!1;this._rtpCapabilities.recv.videoCodecs=h;const g=this.localCapabilities.send,S=this.rtpCapabilities.recv,C=su(Xt.VIDEO,S,g,o);return m.forEach(I=>{const b=C.map(x=>x.payloadType.toString(10));O.debug("updateRemoteCodec mid: ".concat(I.attributes.mid,", from ").concat(I.attributes.payloads," to ").concat(C)),I.attributes.payloads=C,I.media.fmts=b}),!0}createOrRecycleSendMedia(e,i,o,c,u){const h=this.rtpCapabilities.send,_=e===Xt.VIDEO?h.videoCodecs:h.audioCodecs,m=e===Xt.VIDEO?h.videoExtensions:h.audioExtensions;this.currentMidIndex+=1;const g="".concat(this.currentMidIndex);let S={media:{mediaType:e,port:ih,protos:["UDP","TLS","RTP","SAVPF"],fmts:_.map(I=>I.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:m,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:o,rtcpFeedbackWildcards:[],payloads:_,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:c,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(g)}};S=this.mungSendMediaDesc(S,u);const C=this.findFirstClosedMedia(e);if(C){const I=this.sessionDesc.mediaDescriptions.indexOf(C);this.sessionDesc.mediaDescriptions[I]=S}else this.sessionDesc.mediaDescriptions.push(S);return S}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,i,o){const c=Jn(e);return yg(c),so(c,i),Sd(c,i),Ag(c),IE(c,o,this.localCapabilities.send),c}mungSendMediaDesc(e,i){const o=Jn(e);return IE(o,i,this.localCapabilities.recv),Rd(o),o}updateRecvMedia(e,i){const o=this.sessionDesc.mediaDescriptions.findIndex(c=>c.attributes.mid===e);if(o!==-1){const c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[o],i);this.sessionDesc.mediaDescriptions[o]=c}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(i=>Ln()?i.media.port==="0"&&i.media.mediaType===e:i.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(i=>{var o;return((o=i.attributes)===null||o===void 0||(o=o.ssrcs[0])===null||o===void 0?void 0:o.ssrcId)===e[0].ssrcId})}getSSRC(e){var i;return(i=this.sessionDesc.mediaDescriptions.find(o=>o.attributes.mid===e))===null||i===void 0?void 0:i.attributes.ssrcs}}function h1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function bE(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?h1(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):h1(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}class us extends Hr{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=xp(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map(i=>i.rtpMap&&i.rtpMap.encodingName.toLowerCase()||"").filter(i=>{var o;return Jt(o=Object.keys(Sl)).call(o,i)}))]}constructor(e,i,o){super(e,i),A(this,"store",void 0),A(this,"peerConnection",void 0),A(this,"remoteSDP",void 0),A(this,"initialOffer",void 0),A(this,"transportEventReceiver",void 0),A(this,"statsFilter",void 0),A(this,"useXR",Q("USE_XR")),A(this,"localCapabilities",void 0),A(this,"localCandidateCount",0),A(this,"allCandidatesReceived",!1),A(this,"remoteCodecs",void 0),A(this,"dataStreamChannelMap",new Map),A(this,"establishPromise",void 0),A(this,"mutex",new Sr("NVExtentionsConnection-mutex")),A(this,"rtcMedia",void 0),this.store=i,this.peerConnection=o,this.statsFilter=Ju(this.peerConnection,Q("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const o=Vc(i.sdp),c=await bg({filterRTX:!Q("USE_PUB_RTX")&&!Q("USE_SUB_RTX"),filterVideoFec:Q("FILTER_VIDEO_FEC"),filterAudioFec:Q("FILTER_AUDIO_FEC"),filterVideoCodec:Q("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=c,this.initialOffer=i,bE(bE({},o),{},{rtpCapabilities:c,offerSDP:i.sdp})}catch(i){throw new st(j.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(e,i,o,c,u,h){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new l1({remoteIceParameters:e,remoteDtlsParameters:i,candidates:o,remoteRTPCapabilities:c,remoteSetup:u,localCapabilities:xp(this.localCapabilities),cname:h});const _=this.remoteSDP.toString(),m=ci.parse(this.initialOffer.sdp),g=m.mediaDescriptions.find(I=>I.media.mediaType==="audio");g&&Rd(g),this.useXR&&Zl(m);const S=ci.print(m),C=this.logSDPExchange(S||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:S}),C==null||C(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(_){throw new st(j.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(_.toString()))}}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void O.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}else O.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(e){var i,o,c,u;(i=this.remoteSDP)===null||i===void 0||i.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((u=this.remoteSDP)===null||u===void 0||u.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(o=this.remoteSDP)===null||o===void 0||o.preloadRemoteMedia(2);const h=(c=this.remoteSDP)===null||c===void 0?void 0:c.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:h});const _=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(_),O.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,i,o){var c=this;return Wo(function*(){const u=yield Pe(c.mutex.lock("From NVExtentionsConnection.send"));try{if(!c.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const h=[];e.forEach(D=>{const M=c.peerConnection.addTransceiver(D._mediaStreamTrack,{direction:"sendonly"});h.push(M)}),Ln()&&Q("SIMULCAST")===!0&&(yield Pe(c.applySimulcastForFirefox(h,e)));const _=yield Pe(c.peerConnection.createOffer()),m=c.remoteSDP.predictReceivingMids(e.length),g=c.mungSendOfferSDP(_.sdp,e,m),S=ci.parse(g),C=m.map(D=>{const M=S.mediaDescriptions.find(K=>K.attributes.mid===D);if(!M)throw new Error("Cannot extract ssrc from mediaDescription.");return fC(M,Q("USE_PUB_RTX"))});let I;try{I=yield C}catch(D){I=[],c.remoteSDP.receive(e,i,o,I);const M=c.remoteSDP.toString();throw yield Pe(c.peerConnection.setLocalDescription({type:"offer",sdp:g})),yield Pe(c.peerConnection.setRemoteDescription({type:"answer",sdp:M})),yield Pe(c.stopSending(m,!0)),D}c.remoteSDP.receive(e,i,o,I);const b=c.remoteSDP.toString(),x=c.logSDPExchange(g,"offer","local","send");return yield Pe(c.peerConnection.setLocalDescription({type:"offer",sdp:g})),yield Pe(c.applySimulcastEncodings(h,e)),yield Pe(c.applySendEncodings(h,e)),x==null||x(b),yield Pe(c.peerConnection.setRemoteDescription({type:"answer",sdp:b})),h.map((D,M)=>{const K=m[M];return{localSSRC:C[M],id:K,transceiver:D}})}catch(h){throw h instanceof st?h:new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(h.toString()))}finally{u()}})()}async stopSending(e,i){const o=i?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const c=this.peerConnection.getTransceivers().filter(m=>e.indexOf(m.mid)!==-1);if(c.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");c.map(m=>{var g;m.direction="inactive",(g=m.stop)===null||g===void 0||g.call(m)});const u=await this.peerConnection.createOffer(),h=this.logSDPExchange(u.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(u),this.remoteSDP.stopReceiving(e);const _=this.remoteSDP.toString();h==null||h(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(c){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(c.toString()))}finally{o&&o()}}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let o=this.dataStreamChannelMap.get(e);return o&&o.readyState==="open"?O.debug("[P2PConnection] Channels are already available and can be reused directly."):(o=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:Q("DATASTREAM_MAX_RETRANSMITS")}),o.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,o)),void i.forEach(c=>{c._updateOriginDataChannel(o)})}catch(o){throw o instanceof st?o:new st(j.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(o.toString()))}}async stopDataChannels(e){try{const i=this.dataStreamChannelMap.get(e);return i==null||i.close(),void this.dataStreamChannelMap.delete(e)}catch(i){throw i instanceof st?i:new st(j.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(i.toString()))}}async receive(e,i,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:h}=this.remoteSDP.send(e,i,o,c);if(h){const m=this.remoteSDP.toString(),g=this.logSDPExchange(m,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:m});const S=await this.peerConnection.createAnswer(),C=this.mungReceiveAnswerSDP(S.sdp,u,e);g==null||g(C||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:C}),O.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else O.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const _=this.peerConnection.getTransceivers().find(m=>m.mid===u);if(!_)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:_.receiver.track,id:u}}catch(u){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(u.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:o}=this.remoteSDP.batchSend(e);if(o){const c=this.remoteSDP.toString(),u=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const h=await this.peerConnection.createAnswer();u==null||u(h.sdp||""),await this.peerConnection.setLocalDescription(h),O.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else O.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map(c=>{const u=this.peerConnection.getTransceivers().find(h=>h.mid===c);if(!u)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:u.receiver.track,id:c}})}catch(i){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const i=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(i){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(h=>h.mid&&e.indexOf(h.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(h=>{h.direction="inactive"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.muteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(i){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(h=>h.mid&&e.indexOf(h.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(h,_)=>{h.direction="sendonly"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.unmuteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(i){throw new st(j.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(e){var i=this;return Wo(function*(){const o=yield Pe(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(sn().supportPCSetConfiguration){const g=i.peerConnection.getConfiguration(),S=e===Wr.RELAY?"relay":"all";g.iceTransportPolicy!==S&&(O.debug("restartICE change iceTransportPolicy from [".concat(g.iceTransportPolicy,"] to [").concat(S,"]")),g.iceTransportPolicy=S,i.peerConnection.setConfiguration(g))}else if(e===Wr.RELAY)return;e!==Wr.RELAY&&i.remoteSDP.updateCandidates(e);const c=yield Pe(i.peerConnection.createOffer({iceRestart:!0}));if(!c.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const u=Vc(c.sdp),{remoteIceParameters:h}=yield u.iceParameters;i.remoteSDP.restartICE(h);const _=i.remoteSDP.toString(),m=i.logSDPExchange(c.sdp||"","offer","local","restartICE");yield Pe(i.peerConnection.setLocalDescription(c)),m==null||m(_),yield Pe(i.peerConnection.setRemoteDescription({type:"answer",sdp:_}))}catch(c){O.warning("restart ICE failed, abort operation",c)}finally{o()}})()}close(){var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const u=this.remoteSDP.toString(),h=this.logSDPExchange(c,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),h==null||h(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new st(j.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,i){const o=this.peerConnection.getTransceivers().filter(c=>c.mid===e);o.length===1&&(this.isVP8Simulcast(i)?Ln()||await this.applySimulcastEncodings(o,[i]):await this.applySendEncodings(o,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const o=this.peerConnection.getTransceivers().find(c=>c.mid===i);o&&await o.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if((e=this.peerConnection.currentLocalDescription)===null||e===void 0||!e.sdp||!this.localCapabilities)throw new Error;return bE(bE({},Vc(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,O.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,O.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},Q("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(N_(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...us.turnServerConfigToIceServers(e.turnServer.servers)),Q("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...us.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Q("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(o=>{o.security?o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(qt(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&!Q("FORCE_TURN_TCP")&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),i}async applySendEncodings(e,i){try{if(!sn().supportSetRtpSenderParameters||e.length!==i.length)return;for(let C=0;C<e.length;C++){const I=e[C],b=i[C];if(b&&b instanceof ke){var o,c,u;if(this.isVP8Simulcast(b))continue;const x={},D={};switch(b._optimizationMode){case"motion":x.degradationPreference="maintain-framerate";break;case"detail":x.degradationPreference="maintain-resolution";break;default:x.degradationPreference="balanced"}var h,_,m,g;if((o=b._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&(D.maxBitrate=1e3*((h=b._encoderConfig)===null||h===void 0?void 0:h.bitrateMax)),Jt(c=b._hints).call(c,Fn.LOW_STREAM)&&((_=b._encoderConfig)!==null&&_!==void 0&&_.frameRate&&(D.maxFramerate=_t(b._encoderConfig.frameRate)),(m=b._encoderConfig)!==null&&m!==void 0&&m.scaleResolutionDownBy&&((g=b._encoderConfig)===null||g===void 0?void 0:g.scaleResolutionDownBy)>1&&(D.scaleResolutionDownBy=b._encoderConfig.scaleResolutionDownBy)),Q("DSCP_TYPE")&&Du()){var S;const z=Q("DSCP_TYPE");Jt(S=["very-low","low","medium","high"]).call(S,z)&&(D.networkPriority=z)}const M=I.sender.getParameters(),K=(u=M.encodings)===null||u===void 0?void 0:u[0];Ln()&&!K&&(x.encodings=[D]),K&&Object.assign(K,D),Object.assign(M,x),await I.sender.setParameters(M)}}}catch{O.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,i,o){const c=ci.parse(e);return i.forEach((u,h)=>{const _=o[h],m=c.mediaDescriptions.find(g=>g.attributes.mid===_);m&&(so(m,u),yE(m,u,this.store.codec))}),ci.print(c)}mungReceiveAnswerSDP(e,i,o){const c=ci.parse(e),u=c.mediaDescriptions.find(h=>h.attributes.mid===i);return u&&o===Xt.AUDIO&&u.media.mediaType==="audio"&&Rd(u),this.useXR&&Zl(c),ci.print(c)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,i,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let m=0;m<e.length;m++){var o,c,u,h,_;const g=e[m],S=i[m];if(S instanceof ke&&!Jt(o=S._hints).call(o,Fn.LOW_STREAM)&&(c=S._encoderConfig)!==null&&c!==void 0&&c.bitrateMax&&((u=S._encoderConfig)===null||u===void 0?void 0:u.bitrateMax)>200&&(h=S._scalabilityMode)!==null&&h!==void 0&&h.numSpatialLayers&&((_=S._scalabilityMode)===null||_===void 0?void 0:_.numSpatialLayers)>1&&this.store.codec==="vp8"){const C={},I={high:1e3*(S._encoderConfig.bitrateMax-50),medium:5e4};C.encodings=[{rid:"m",active:!0,maxBitrate:I.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:I.high}];const b=g.sender.getParameters();await g.sender.setParameters(Object.assign(b,C))}}}async applySimulcastEncodings(e,i){if(!Ln()&&e.length===i.length)for(let o=0;o<e.length;o++){const c=i[o];if(c instanceof ke&&this.isVP8Simulcast(c)){const u=e[o],h={},_={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:_.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:_.medium,scaleResolutionDownBy:4}];const m=u.sender.getParameters();await u.sender.setParameters(Object.assign(m,h))}}}isVP8Simulcast(e){var i,o,c,u,h;return!!(e instanceof ke&&Q("SIMULCAST")&&this.store.codec==="vp8"&&!Jt(i=e._hints).call(i,Fn.LOW_STREAM)&&(o=e._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((c=e._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)>200&&(u=e._scalabilityMode)!==null&&u!==void 0&&u.numSpatialLayers&&((h=e._scalabilityMode)===null||h===void 0?void 0:h.numSpatialLayers)>1)}logSDPExchange(e,i,o,c){if(Q("SDP_LOGGING"))return O.upload("exchanging ".concat(o," ").concat(i," SDP during NVExtentionsConnection.").concat(c,`
`),e),i==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(sn().supportPCSetConfiguration){const i=us.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}function Co(s,e,i){const o=s[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const c=this.mutex,u=await c.lock("From NVExtentionsConnection.".concat(e));try{for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];return await o.apply(this,_)}finally{u()}},i}function Xn(s){var e,i,o,c=2;for(typeof Symbol<"u"&&(i=rO,o=Symbol.iterator);c--;){if(i&&(e=s[i])!=null)return e.call(s);if(o&&(e=s[o])!=null)return new Pg(e.call(s));i="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function Pg(s){function e(i){if(Object(i)!==i)return ut.reject(new TypeError(i+" is not an object."));var o=i.done;return ut.resolve(i.value).then(function(c){return{value:c,done:o}})}return Pg=function(i){this.s=i,this.n=i.next},Pg.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var o=this.s.return;return o===void 0?ut.resolve({value:i,done:!0}):e(o.apply(this.s,arguments))},throw:function(i){var o=this.s.return;return o===void 0?ut.reject(i):e(o.apply(this.s,arguments))}},new Pg(s)}Tt([Co,V("design:type",Function),V("design:paramtypes",[Object,Object,Array,Object,String,String]),V("design:returntype",ut)],us.prototype,"connect",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Array,Array]),V("design:returntype",ut)],us.prototype,"updateRemoteRTPCapabilities",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],us.prototype,"updateRemoteConnect",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Object,Array]),V("design:returntype",ut)],us.prototype,"createDataChannels",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[String,Array,String,Object]),V("design:returntype",ut)],us.prototype,"receive",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],us.prototype,"batchReceive",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],us.prototype,"stopReceiving",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],us.prototype,"muteRemote",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],us.prototype,"unmuteRemote",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],us.prototype,"muteLocal",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],us.prototype,"unmuteLocal",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],us.prototype,"close",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],us.prototype,"updateEncoderConfig",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],us.prototype,"updateSendParameters",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[os,String]),V("design:returntype",ut)],us.prototype,"replaceTrack",null),Tt([Co,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],us.prototype,"getRemoteSSRC",null);class Oi extends Hr{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,i){super(e,i),A(this,"store",void 0),A(this,"peerConnection",void 0),A(this,"cname",void 0),A(this,"mutex",new Sr("DataChannelConnection-mutex")),A(this,"dataChannel",void 0),A(this,"_p2pConnection",void 0),A(this,"establishPromise",void 0),A(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Oi.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new us(e,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const i=(e=this._nvMedia)===null||e===void 0?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(i)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,i,o,c,u,h){return this.cname=h,await this._p2pConnection.connect(e,i,o,c,u,h),await new ut((_,m)=>{const g=setTimeout(()=>{this.closeSignal(),m(new st(j.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(o))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(g),void _()},this.dataChannel.onerror=S=>{this.closeSignal(),m(S)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,i){return this._p2pConnection.updateRemoteRTPCapabilities(e,i)}send(e,i,o){var c=this;return Wo(function*(){const u=yield Pe(c.mutex.lock("From DataChannelConnection.send"));try{return yield*CC(Xn(c._p2pConnection.send(e,i,o)))}finally{u()}})()}async stopSending(e,i){return this._p2pConnection.stopSending(e,i)}async createDataChannels(e,i){return this._p2pConnection.createDataChannels(e,i)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,i,o,c){return this._nvMedia?(O.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,i,this.cname)):(O.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,i,o,c))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var i=this;return Wo(function*(){return yield*CC(Xn(i._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var i;(i=this._nvMedia)===null||i===void 0||i.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,i){return await this._p2pConnection.updateEncoderConfig(e,i)}async updateSendParameters(e,i){return await this._p2pConnection.updateSendParameters(e,i)}setStatsRemoteVideoIsReady(e,i){this._p2pConnection.setStatsRemoteVideoIsReady(e,i)}async replaceTrack(e,i){return await this._p2pConnection.replaceTrack(e,i)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,i,o,c){if(Q("SDP_LOGGING"))return O.upload("exchanging ".concat(o," ").concat(i," SDP during DataChannelConnection.").concat(c,`
`),e),i==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(N_(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...Oi.turnServerConfigToIceServers(e.turnServer.servers)),Q("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...Oi.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Q("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(o=>{o.security?o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(qt(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&!Q("FORCE_TURN_TCP")&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),i}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var i;return(i=this.onICEConnectionStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var i;return(i=this.onConnectionStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var i;return(i=this.onDTLSTransportStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var i;return(i=this.onDTLSTransportError)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var i;return(i=this.onICETransportStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var i;return(i=this.onFirstAudioReceived)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var i;return(i=this.onFirstVideoReceived)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var i;return(i=this.onFirstAudioDecoded)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,i,o)=>{var c;return(c=this.onFirstVideoDecoded)===null||c===void 0?void 0:c.call(this,e,i,o)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var i;return(i=this.onFirstVideoDecodedTimeout)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,i)=>{var o;return(o=this.onSelectedLocalCandidateChanged)===null||o===void 0?void 0:o.call(this,e,i)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,i)=>{var o;return(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0?void 0:o.call(this,e,i)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function qo(s,e,i){const o=s[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const c=this.mutex,u=await c.lock("From DataChannelConnection.".concat(e));try{for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];return await o.apply(this,_)}finally{u()}},i}function pc(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function cu(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?pc(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):pc(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}function Lg(s){var e,i,o,c=2;for(typeof Symbol<"u"&&(i=rO,o=Symbol.iterator);c--;){if(i&&(e=s[i])!=null)return e.call(s);if(o&&(e=s[o])!=null)return new Di(e.call(s));i="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function Di(s){function e(i){if(Object(i)!==i)return ut.reject(new TypeError(i+" is not an object."));var o=i.done;return ut.resolve(i.value).then(function(c){return{value:c,done:o}})}return Di=function(i){this.s=i,this.n=i.next},Di.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var o=this.s.return;return o===void 0?ut.resolve({value:i,done:!0}):e(o.apply(this.s,arguments))},throw:function(i){var o=this.s.return;return o===void 0?ut.reject(i):e(o.apply(this.s,arguments))}},new Di(s)}Tt([qo,V("design:type",Function),V("design:paramtypes",[Object,Object,Array,Object,String,String]),V("design:returntype",ut)],Oi.prototype,"connect",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[Array,Array]),V("design:returntype",ut)],Oi.prototype,"updateRemoteRTPCapabilities",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[Object,Array]),V("design:returntype",ut)],Oi.prototype,"createDataChannels",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[String,Array,String,Object]),V("design:returntype",ut)],Oi.prototype,"receive",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Oi.prototype,"stopReceiving",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],Oi.prototype,"muteRemote",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],Oi.prototype,"unmuteRemote",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Oi.prototype,"muteLocal",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Oi.prototype,"unmuteLocal",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Oi.prototype,"close",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],Oi.prototype,"updateEncoderConfig",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[String,os]),V("design:returntype",ut)],Oi.prototype,"updateSendParameters",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[os,String]),V("design:returntype",ut)],Oi.prototype,"replaceTrack",null),Tt([qo,V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],Oi.prototype,"getRemoteSSRC",null);class Ki extends oi{get state(){return this._state}set state(e){const i=this._state;this._state=e,this.emit(_e.StateChange,i,this._state)}constructor(e,i){super(),A(this,"store",void 0),A(this,"statsUploader",void 0),A(this,"connection",void 0),A(this,"localTrackMap",new Map),A(this,"remoteUserMap",new Map),A(this,"localDataChannels",[]),A(this,"remoteDataChannelMap",new Map),A(this,"pendingLocalTracks",[]),A(this,"pendingRemoteTracks",[]),A(this,"pendingLocalDataChannels",[]),A(this,"pendingRemoteDataChannels",[]),A(this,"statsCollector",void 0),A(this,"isPlanB",!1),A(this,"shouldForwardP2PCreation",void 0),A(this,"iceFailedCount",0),A(this,"dtlsFailedCount",0),A(this,"mutex",new Sr("P2PChannel-mutex")),A(this,"_state",En.Disconnected),A(this,"_pcStatsUploadType",Q("NEW_ICE_RESTART")?ca.FIRST_CONNECTION:ca.OLD_FIRST_CONNECTION),A(this,"_isInRestartIce",!1),A(this,"_isStartRestartIce",!1),A(this,"_restartStates",["disconnected","failed"]),A(this,"_restartTimer",void 0),A(this,"_isFirstConnected",!0),A(this,"handleMuteLocalTrack",async(o,c,u)=>{const h=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==En.Connected)return void u(new ft(j.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const _=this.filterTobeMutedTracks(o);if(_.length===0)return void c();const m=_.find(S=>S[0]==="videoLowTrack");m&&m[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(_.map(S=>{let[,{id:C}]=S;return C}));const g=this.createMuteMessage(_);await kn(this,_e.RequestMuteLocal,g),c()}catch(_){u(_)}finally{h()}}),A(this,"handleUnmuteLocalTrack",async(o,c,u)=>{const h=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==En.Connected)return void u(new ft(j.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const _=this.filterTobeUnmutedTracks(o);if(_.length===0)return void c();const m=_.find(S=>S[0]==="videoLowTrack");if(m){const S=m[1];if(S.track._originMediaStreamTrack.stop(),!Q("DISABLE_DUAL_STREAM_USE_ENCODING")&&sn().supportDualStreamEncoding){const C=o._mediaStreamTrack.clone();S.track._mediaStreamTrack=C,S.track._originMediaStreamTrack=C}else{const C=wg(o,gl(this,_e.RequestLowStreamParameter));S.track._mediaStreamTrack=C,S.track._originMediaStreamTrack=C}await new ut((C,I)=>{this.handleReplaceTrack(S.track,C,I,!0)})}await this.connection.unmuteLocal(_.map(S=>{let[,{id:C}]=S;return C}));const g=this.createUnmuteMessage(_);await kn(this,_e.RequestUnmuteLocal,g),c()}catch(_){u(_)}finally{h()}}),A(this,"handleUpdateVideoEncoder",async(o,c,u)=>{const h=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const _=this.localTrackMap.get(yt.LocalVideoTrack);if(!this.connection||!_||_.track!==o||this.state!==En.Connected)return void c();const{id:m,track:g}=_;await this.connection.updateSendParameters(m,g),await this.connection.updateEncoderConfig(m,g),this.emit(_e.UpdateVideoEncoder,g),c()}catch(_){u(_)}finally{h()}}),A(this,"handleSetOptimizationMode",async(o,c,u)=>{const h=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const _=this.localTrackMap.get(yt.LocalVideoTrack);if(!this.connection||!_||_.track!==o||this.state!==En.Connected)return;const{id:m,track:g}=_;await this.connection.updateSendParameters(m,g),c()}catch(_){u(_)}finally{h()}}),A(this,"handleReplaceMixingTrack",async(o,c,u,h)=>{if(!this.connection||this.state!==En.Connected)return void c();const _=eO([o]);let m;O.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(_.getTrackId(),"]")),typeof h=="boolean"&&h||(m=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(o,_),c()}catch(S){u(S)}finally{var g;(g=m)===null||g===void 0||g()}}),A(this,"handleReplaceTrack",async(o,c,u,h)=>{let _;O.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(o.getTrackId(),"]")),typeof h=="boolean"&&h||(_=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var m;const S=Array.from(this.localTrackMap.entries()).find(C=>{let[,{track:I}]=C;return o===I});if(!this.connection||!S||this.state!==En.Connected)return void c();if(await((m=this.connection)===null||m===void 0?void 0:m.replaceTrack(o,S[1].id)),this.isPlanB){const C=S[1];C.id=o._mediaStreamTrack.id,this.localTrackMap.set(S[0],C)}if(S[0]===yt.LocalVideoTrack&&!Q("DISABLE_DUAL_STREAM_USE_ENCODING")&&sn().supportDualStreamEncoding){const C=this.localTrackMap.get(yt.LocalVideoLowTrack);if(C){const I=o._mediaStreamTrack.clone();C.track._originMediaStreamTrack.stop(),C.track._mediaStreamTrack=I,C.track._originMediaStreamTrack=I,await new ut((b,x)=>{this.handleReplaceTrack(C.track,b,x,!0)})}}c()}catch(S){u(S)}finally{var g;(g=_)===null||g===void 0||g()}}),A(this,"handleGetRTCStats",o=>{o(this.statsCollector.getRTCStats())}),A(this,"handleGetLocalVideoStats",o=>{o(this.statsCollector.getLocalVideoTrackStats())}),A(this,"handleGetLocalAudioStats",o=>{o(this.statsCollector.getLocalAudioTrackStats())}),A(this,"handleGetRemoteVideoStats",o=>this.statsCollector.getRemoteVideoTrackStats(o.uid)[o.uid]),A(this,"handleGetRemoteAudioStats",o=>this.statsCollector.getRemoteAudioTrackStats(o.uid)[o.uid]),this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new tO(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!sn().supportUnifiedPlan||Q("CHROME_FORCE_PLAN_B")&&Du(),this.shouldForwardP2PCreation=Q("FORWARD_P2P_CREATION")&&sn().supportPCSetConfiguration&&function(){const o=Jm();return o===gr.ANDROID||o===gr.IOS||o===gr.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Oi({},this.store):this.isPlanB?new bi({},this.store):new wi({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,i){var o;this.state=En.New;const c=this.shouldForwardP2PCreation&&((o=this.connection)===null||o===void 0?void 0:o.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!c||(c&&this.connection&&(O.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Oi(e,this.store):this.isPlanB?new bi(e,this.store):new wi(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new ft(j.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=Q("NEW_ICE_RESTART")?ca.FIRST_CONNECTION:ca.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,i,o,c,u,h){if(!this.connection)throw new ft(j.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Oi?this.connection.updateRemoteConnect(c):(this.store.peerConnectionStart(),await this.connection.connect(e,i,o,c,u,h),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=En.Connected)}updateRemoteRTPCapabilities(e){const i=Array.from(this.localTrackMap.entries()).filter(u=>{var h;let[_]=u;return Jt(h=[yt.LocalVideoLowTrack,yt.LocalVideoTrack]).call(h,_)}),o=i.map(u=>{let[,{id:h}]=u;return h}),c=i.map(u=>{let[h]=u;return h});if(this.connection instanceof wi){if(ne.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(c),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!Jt(e).call(e,this.store.codec)){const u=["vp8","h264"].find(h=>Jt(e).call(e,h));u&&(this.store.codec=u,O.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(u,".")))}this.connection.updateRemoteRTPCapabilities(o,e)}}async preConnect(e,i,o,c,u,h){if(!this.connection)throw new ft(j.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const _=await this.connection.connect(e,i,o,c,u,h);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=En.Connected,_}getEstablishParams(){if(this.connection instanceof Oi)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==En.Connected){if(this.state===En.Disconnected)throw new ft(j.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach(o=>{var c;Jt(c=this.pendingLocalDataChannels).call(c,o)||this.pendingLocalDataChannels.push(o)})}const i=this.filterTobePublishedDataChannels(e);i.length!==0&&(i.forEach(o=>{const c=Date.now();this.store.publish(o.id.toString(),"datachannel",c)}),await this.connection.createDataChannels(this.store.uid,i),i.forEach(o=>{this.localDataChannels.push(o);const c=Date.now();this.store.publish(o.id+"","datachannel",void 0,c)}))}publish(e,i,o){var c=this;return Wo(function*(){const u=yield Pe(c.mutex.lock("From P2PChannel.publish"));try{if(!c.connection||c.state!==En.Connected){if(c.state===En.Disconnected)throw new ft(j.UNEXPECTED_ERROR,"PeerConnection already disconnected.");c.throwIfTrackTypeNotMatch(e);const _=e.filter(m=>c.pendingLocalTracks.indexOf(m)===-1);return void(c.pendingLocalTracks=c.pendingLocalTracks.concat(_))}c.store.pubId=c.store.pubId+1,cs.markPublishStart(c.store.clientId,c.store.pubId);const h=c.filterTobePublishedTracks(e,i,o);if(h.length===0)return void(yield Pe(c.tryToUnmuteAudio(e)));yield*CC(Lg(c.doPublish(c.connection,h)))}finally{u()}})()}doPublish(e,i){var o=this;return Wo(function*(){i.forEach(I=>{let{track:b,type:x}=I;const D=Date.now();o.store.publish(b.getTrackId(),x===yt.LocalAudioTrack?"audio":"video",D)}),o.bindLocalTrackEvents(i);const c=i.map(I=>{let{track:b}=I;return b}),u=yield Pe(e.send(i.map(I=>{let{track:b}=I;return b}),o.store.codec,o.store.audioCodec)),h=(yield Pe(u.next())).value,_=o.createGatewayPublishMessage(i,h);let m;try{m=yield _}catch(I){throw u.throw(I),(I==null?void 0:I.code)===j.WS_ABORT&&i.forEach(b=>{let{track:x}=b;o.pendingLocalTracks.indexOf(x)===-1&&o.pendingLocalTracks.push(x)}),o.unbindLocalTrackEvents(i),I}const g=o.mapPubResToRemoteConfig(_,m),S=(yield Pe(u.next(g))).value,C=Q("ENABLE_VIDEO_SEI");c.forEach(async I=>{const b=I.getRTCRtpTransceiver();b&&C&&(I.trackMediaType===Xt.VIDEO?await async function(x,D){if(!sn().supportWebRTCEncodedTransform)return void O.warning("browser not support video encoded transform");if(Rg.has(x)||!x.track)return;const M={track:x.track};if(Nu()){if(!x.createEncodedStreams)return void O.warning("browser not support createEncodedStreams() API");let z=null;try{z=x.createEncodedStreams()}catch(it){return void O.error("create video-encoded-streams error",it&&it.message)}let nt=[];D.on("sei-to-send",it=>{nt.push(it)});const dt=new TransformStream({transform(it,at){M.controller||(M.controller=at),x.track&&x.track.id!==M.track.id&&(O.debug("video track changed: ".concat(M.track.id," => ").concat(x.track.id)),M.track.removeEventListener("ended",K),M.track=x.track,M.track.addEventListener("ended",K));const ht=nt.shift();ht&&(it.data=zM(it.data,ht)),at.enqueue(it)}});z.readable.pipeThrough(dt).pipeTo(z.writable)}else{if(!Or())return;{if(typeof RTCRtpScriptTransform>"u")return void O.warning("browser not support RTCRtpScriptTransform");const z=Sg(),nt=new MessageChannel;await new ut(it=>z.onmessage=at=>{at.data==="registered"&&it(void 0)});const dt=new RTCRtpScriptTransform(z,{name:"tx",port:nt.port2},[nt.port2]);x.transform=dt,await new ut(it=>z.onmessage=at=>{at.data==="started"&&it(void 0)}),D.on("sei-to-send",it=>{nt.port1.postMessage({sei:it})}),nt.port1.onmessage=it=>{var at;it.data.transformed&&x.track&&((at=x.track)===null||at===void 0?void 0:at.id)!==M.track.id&&(O.debug("video track changed: ".concat(M.track.id," => ").concat(x.track.id)),M.track.removeEventListener("ended",K),M.track=x.track,M.track.addEventListener("ended",K))},M.worker=z}}function K(){if(x.track){if(this.id!==x.track.id)return;x.track.removeEventListener("ended",K)}const z=Rg.get(x);if(z){Rg.delete(x);try{var nt,dt;(nt=z.controller)===null||nt===void 0||nt.terminate(),(dt=z.worker)===null||dt===void 0||dt.terminate()}catch(it){O.warning(it&&it.message)}}}Rg.set(x,M),x.track.addEventListener("ended",K)}(b.sender,I):I.trackMediaType===Xt.AUDIO&&await async function(x){if(!sn().supportWebRTCEncodedTransform)return void O.warning("browser not support audio encoded transform");if(io.has(x)||!x.track)return;const D={track:x.track};if(Nu()){if(!x.createEncodedStreams)return void O.warning("browser not support createEncodedStreams() API");let K=null;try{K=x.createEncodedStreams()}catch(nt){return void O.error("create audio-encoded-streams error",nt&&nt.message)}const z=new TransformStream({transform(nt,dt){D.controller||(D.controller=dt),x.track&&x.track.id!==D.track.id&&(O.debug("audio track changed: ".concat(D.track.id," => ").concat(x.track.id)),D.track.removeEventListener("ended",M),D.track=x.track,D.track.addEventListener("ended",M)),dt.enqueue(nt)}});K.readable.pipeThrough(z).pipeTo(K.writable)}else if(Or()){if(typeof RTCRtpScriptTransform>"u")return void O.warning("browser not support RTCRtpScriptTransform");const K=Sg(),z=new MessageChannel;await new ut(dt=>K.onmessage=it=>{it.data==="registered"&&dt(void 0)});const nt=new RTCRtpScriptTransform(K,{name:"tx",port:z.port2},[z.port2]);x.transform=nt,await new ut(dt=>K.onmessage=it=>{it.data==="started"&&dt(void 0)}),z.port1.onmessage=dt=>{var it;dt.data.transformed&&x.track&&((it=x.track)===null||it===void 0?void 0:it.id)!==D.track.id&&(O.debug("audio track changed: ".concat(D.track.id," => ").concat(x.track.id)),D.track.removeEventListener("ended",M),D.track=x.track,D.track.addEventListener("ended",M))},D.worker=K}function M(){if(x.track){if(this.id!==x.track.id)return;x.track.removeEventListener("ended",M)}const K=io.get(x);if(K){io.delete(x);try{var z,nt;(z=K.controller)===null||z===void 0||z.terminate(),(nt=K.worker)===null||nt===void 0||nt.terminate()}catch(dt){O.warning(dt&&dt.message)}}}io.set(x,D),x.track.addEventListener("ended",M)}(b.sender))}),i.forEach(I=>{let{type:b}=I;o.statsCollector.addLocalStats(b)}),o.assignLocalTracks(i,S),o.statsUploader.startUploadOutboundStats(),i.forEach(I=>{let{track:b,type:x}=I;const D=Date.now();o.store.publish(b.getTrackId(),x===yt.LocalAudioTrack?"audio":"video",void 0,D)})})()}async updateVideoStreamParameter(e,i){const o=this.localTrackMap.get(i);if(!o)return;if(!(o.track instanceof ke))return O.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof wi||this.connection instanceof bi))return O.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:c}=o,u=function(h,_){const m={};return h.height&&h.width&&(m.scaleResolutionDownBy=Nr(h,_)),m.maxFramerate=h.framerate?_t(h.framerate):void 0,m.maxBitrate=h.bitrate?1e3*h.bitrate:void 0,m}(e,c);if(c._encoderConfig||(c._encoderConfig={}),i!==yt.LocalVideoLowTrack||!Q("DISABLE_DUAL_STREAM_USE_ENCODING")&&sn().supportDualStreamEncoding)u.scaleResolutionDownBy!=null&&(c._encoderConfig.scaleResolutionDownBy=u.scaleResolutionDownBy);else{const h=c._originMediaStreamTrack;if(!h.canvas)return O.warn("[".concat(c.getTrackId(),"] no canvas on track"));(function(_,m){const g=_.canvas;m.width&&(g.width=_t(m.width)),m.height&&(g.height=_t(m.height)),m.framerate&&(g.stopCapture&&g.stopCapture(),g.stopCapture=pi(()=>{!g.startCapture&&g.stopCapture&&g.stopCapture(),g.startCapture&&g.startCapture()},_t(m.framerate)))})(h,e)}u.maxBitrate!=null&&(c._encoderConfig.bitrateMax=u.maxBitrate/1e3),u.maxFramerate!=null&&(c._encoderConfig.frameRate&&typeof c._encoderConfig.frameRate=="object"?c._encoderConfig.frameRate.max=u.maxFramerate:c._encoderConfig.frameRate={max:u.maxFramerate}),O.debug("[".concat(c.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(c._encoderConfig))),await this.connection.updateRtpSenderEncodings(c)}publishLowStream(e){var i=this;return Wo(function*(){if(!i.connection||i.state!==En.Connected)return;const o=yield Pe(i.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const u=i.localTrackMap.get(yt.LocalVideoTrack);if(!u)throw new ft(j.UNEXPECTED_ERROR,"Could not find high stream");if(i.localTrackMap.has(yt.LocalVideoLowTrack))throw new ft(j.UNEXPECTED_ERROR,"[".concat(i.store.clientId,"] Can't publish low stream when stream already publish"));const h=[{track:i.getLowVideoTrack(u.track,e),type:yt.LocalVideoLowTrack}];if(yield*CC(Lg(i.doPublish(i.connection,h))),u.track.muted||!u.track.enabled){var c;const _=(c=i.localTrackMap.get(yt.LocalVideoLowTrack))===null||c===void 0?void 0:c.id;_!==void 0&&(yield Pe(i.connection.muteLocal([_])))}}finally{o()}})()}async republish(){this.pendingLocalTracks.length>0&&(O.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await zi(this,_e.RequestRePublish,this.pendingLocalTracks),this.emit(_e.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(O.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await zi(this,_e.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let i=this.pendingRemoteTracks.length-1;i>=0;i--){const{user:o,kind:c}=this.pendingRemoteTracks[i];(c!==Xt.AUDIO||o._audio_added_&&o._audioSSRC)&&(c!==Xt.VIDEO||o._video_added_&&o._videoSSRC)||this.pendingRemoteTracks.splice(i,1)}if(e)await zi(this,_e.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:i,kind:o}of this.pendingRemoteTracks)await this.subscribe(i,o,o===Xt.VIDEO?i._videoSSRC:i._audioSSRC);this.pendingRemoteTracks.forEach(i=>{let{user:o}=i;this.emit(_e.MediaReconnectEnd,o.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==En.Connected)return void e.forEach(c=>{const u=this.pendingLocalTracks.indexOf(c);u!==-1&&this.pendingLocalTracks.splice(u,1)});const i=this.filterTobeUnpublishedTracks(e);if(i.length===0)return;const o=i.find(c=>c[0]==="videoLowTrack");return o&&o[1].track.close(),this.doUnpublish(this.connection,i)}async unpublishDataChannel(e){if(!this.connection||this.state!==En.Connected)return void e.forEach(o=>{const c=this.pendingLocalDataChannels.indexOf(o);c!==-1&&this.pendingLocalDataChannels.splice(c,1)});const i=this.filterTobeUnpublishedDataChannels(e);return i.length!==0?(i.forEach(o=>{const c=this.localDataChannels.indexOf(o);c!==-1&&this.localDataChannels.splice(c,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),i.map(o=>o.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==En.Connected)return;const e=this.localTrackMap.get(yt.LocalVideoLowTrack);if(!e)return;e.track.close();const i=[[yt.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,i)}async doUnpublish(e,i){const o=this.createGatewayUnpublishMessage(i);return await e.stopSending(i.map(c=>{let[,{id:u}]=c;return u})),this.withdrawLocalTracks(i),this.unbindLocalTrackEvents(i.map(c=>{let[u,{track:h}]=c;return{type:u,track:h}})),i.forEach(c=>{let[u]=c;this.statsCollector.removeLocalStats(u)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),o}async subscribeDataChannel(e,i){if(!this.connection||this.state!==En.Connected)throw new ft(j.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const o=i.filter(c=>{var u;return!((u=this.remoteDataChannelMap.get(e))!==null&&u!==void 0&&u.get(c.id))});if(o.length!==0)return await this.connection.createDataChannels(e.uid,o),o.forEach(c=>{var u;this.remoteDataChannelMap.has(e)?(u=this.remoteDataChannelMap.get(e))===null||u===void 0||u.set(c.id,c):this.remoteDataChannelMap.set(e,new Map([[c.id,c]]));const h=this.pendingRemoteDataChannels.findIndex(_=>{let{user:m,id:g}=_;return m.uid===e.uid&&g===c.id});h!==-1&&this.pendingRemoteDataChannels.splice(h,1)}),o.map(c=>c.id)}async subscribe(e,i,o,c,u){var h;if(!this.connection||this.state!==En.Connected)throw new ft(j.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((h=this.remoteUserMap.get(e))!==null&&h!==void 0&&h.has(i))return;let _,m,g;if(u){const I=u.find(x=>{let{stream_type:D}=x;return D===i});if(!I)throw new ft(j.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));const b=await this.connection.receive(i,I.ssrcs,String(e._uintid),I.attributes);this.connection instanceof wi&&(g=b.transceiver),_=b.track,m=b.id}else{const I=await this.connection.receive(i,[{ssrcId:o,rtx:c}],String(e._uintid),void 0);this.connection instanceof wi&&(g=I.transceiver),_=I.track,m=I.id}i===Xt.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(_):(e._audioTrack=new ue(_,e.uid,e._uintid,this.store),O.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),g&&e._audioTrack._updateRtpTransceiver(g),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(_):(e._videoTrack=new fe(_,e.uid,e._uintid,this.store),O.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),g&&e._videoTrack._updateRtpTransceiver(g),this.bindRemoteTrackEvents(e,e._videoTrack)),Q("ENABLE_VIDEO_SEI")&&g&&(i==Xt.VIDEO?await JM(g.receiver,{onSei:I=>{var b;(b=e._videoTrack)===null||b===void 0||b._onSei(I)}}):i==Xt.AUDIO&&await Fw(g.receiver));const S=this.remoteUserMap.get(e);S?S.set(i,m):this.remoteUserMap.set(e,new Map([[i,m]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const C=this.pendingRemoteTracks.findIndex(I=>{let{user:b,kind:x}=I;return b.uid===e.uid&&i===x});C!==-1&&(this.pendingRemoteTracks.splice(C,1),this.emit(_e.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==En.Connected)throw new ft(j.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(o=>{var c;let{user:u,mediaType:h}=o;return!((c=this.remoteUserMap.get(u))!==null&&c!==void 0&&c.has(h))});const i=await this.connection.batchReceive(e.map(o=>{let{user:c,mediaType:u,ssrcId:h,rtxSsrcId:_}=o;return{kind:u,ssrcMsg:[{ssrcId:h,rtx:_}],mslabel:String(c._uintid)}}));e.forEach((o,c)=>{let{user:u,mediaType:h}=o;const{track:_,id:m,transceiver:g}=i[c];h===Xt.AUDIO?(u._audioTrack?u._audioTrack._updateOriginMediaStreamTrack(_):(u._audioTrack=new ue(_,u.uid,u._uintid,this.store),O.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(u._audioTrack.getTrackId()))),g&&u._audioTrack._updateRtpTransceiver(g),this.bindRemoteTrackEvents(u,u._audioTrack)):(u._videoTrack?u._videoTrack._updateOriginMediaStreamTrack(_):(u._videoTrack=new fe(_,u.uid,u._uintid,this.store),O.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(u._videoTrack.getTrackId()))),g&&u._videoTrack._updateRtpTransceiver(g),this.bindRemoteTrackEvents(u,u._videoTrack));const S=this.remoteUserMap.get(u);S?S.set(h,m):this.remoteUserMap.set(u,new Map([[h,m]])),this.statsCollector.addRemoteStats(u.uid),this.statsUploader.startUploadInboundStats();const C=this.pendingRemoteTracks.findIndex(I=>{let{user:b,kind:x}=I;return b.uid===u.uid&&h===x});C!==-1&&(this.pendingRemoteTracks.splice(C,1),this.emit(_e.MediaReconnectEnd,u.uid))})}async unsubscribe(e,i,o){const c=this.pendingRemoteTracks.filter(_=>{let{user:m,kind:g}=_;return i!==void 0?m.uid===e.uid&&i===g:m.uid===e.uid});if(c.forEach(_=>{const m=this.pendingRemoteTracks.indexOf(_);this.pendingRemoteTracks.splice(m,1)}),this.connection&&this.state===En.Connected||o||c.forEach(_=>{let{kind:m}=_;var g;if(m===Xt.AUDIO)(g=e._audioTrack)===null||g===void 0||g._destroy(),e._audioTrack=void 0;else if(m===Xt.VIDEO){var S;(S=e._videoTrack)===null||S===void 0||S._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==En.Connected)return;const u=this.filterTobeUnSubscribedTracks(e,i);if(u.length===0)return;await this.connection.stopReceiving(u.map(_=>{let[,{id:m}]=_;return m}));const h=this.createUnsubscribeMessage(u);return this.withdrawRemoteTracks(u),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),u.forEach(_=>{let[m,{kind:g}]=_;var S,C;if(g===Xt.VIDEO&&m._videoSSRC&&((S=this.connection)===null||S===void 0||S.setStatsRemoteVideoIsReady(m._videoSSRC,!1)),g===Xt.VIDEO)this.unbindRemoteTrackEvents(m._videoTrack),o||((C=m._videoTrack)===null||C===void 0||C._destroy(),m._videoTrack=void 0);else if(g===Xt.AUDIO){var I;this.unbindRemoteTrackEvents(m._audioTrack),!o&&((I=m._audioTrack)===null||I===void 0||I._destroy(),m._audioTrack=void 0)}}),h}async unsubscribeDataChannel(e,i){if(i.forEach(u=>{const h=this.pendingRemoteDataChannels.findIndex(_=>_.id===u.id);h!==-1&&this.pendingRemoteDataChannels.splice(h,1)}),!this.connection)return;const o=this.filterTobeUnSubscribedDataChannels(e,i);if(o.length===0)return;i.forEach(u=>{u._close()});const c=this.remoteDataChannelMap.get(e);return o.forEach(u=>{c&&c.delete(u.id)}),c&&c.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),o.map(u=>u.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let i=[];for(const{user:u,mediaType:h}of e){const _=this.pendingRemoteTracks.filter(m=>{let{user:g,kind:S}=m;return h!==void 0?g.uid===u.uid&&h===S:g.uid===u.uid});_.forEach(m=>{const g=this.pendingRemoteTracks.indexOf(m);this.pendingRemoteTracks.splice(g,1)}),i=i.concat(_)}if(!this.connection||this.state!==En.Connected)return void i.forEach(u=>{let{user:h,kind:_}=u;var m;if(_===Xt.AUDIO)(m=h._audioTrack)===null||m===void 0||m._destroy(),h._audioTrack=void 0;else if(_===Xt.VIDEO){var g;(g=h._videoTrack)===null||g===void 0||g._destroy(),h._videoTrack=void 0}});const o=Lu(e).call(e,(u,h)=>{let{user:_,mediaType:m}=h;const g=this.filterTobeUnSubscribedTracks(_,m);return u.concat(g)},[]);if(o.length===0)return;await this.connection.stopReceiving(o.map(u=>{let[,{id:h}]=u;return h}));const c=this.createUnsubscribeAllMessage(o);return this.withdrawRemoteTracks(o),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),o.forEach(u=>{let[h,{kind:_}]=u;var m,g;if(_===Xt.VIDEO&&h._videoSSRC&&((m=this.connection)===null||m===void 0||m.setStatsRemoteVideoIsReady(h._videoSSRC,!1)),_===Xt.VIDEO)this.unbindRemoteTrackEvents(h._videoTrack),(g=h._videoTrack)===null||g===void 0||g._destroy(),h._videoTrack=void 0;else if(_===Xt.AUDIO){var S;this.unbindRemoteTrackEvents(h._audioTrack),(S=h._audioTrack)===null||S===void 0||S._destroy(),h._audioTrack=void 0}}),c}async muteRemote(e,i){if(!this.connection)return;const o=this.remoteUserMap.get(e);if(!o)return void O.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!o.get(i))return void O.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const c=i===Xt.VIDEO?e._videoSSRC:e._audioSSRC;c!==void 0&&this.connection.setStatsRemoteVideoIsReady(c,!1)}async unmuteRemote(e,i){return this.unmuteRemoteNoLock(e,i)}async unmuteRemoteNoLock(e,i){if(!this.connection)return;const o=this.remoteUserMap.get(e);if(!o)return void O.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));o.get(i)||O.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const i=this.localTrackMap.get(yt.LocalAudioTrack);if((i==null?void 0:i.track)instanceof pr){const o=i.track;return Array.from(this.localTrackMap.entries()).filter(c=>{let[u]=c;return u!==yt.LocalAudioTrack}).filter(c=>{let[u]=c;return!(e&&u===yt.LocalVideoLowTrack)}).map(c=>{let[,{track:u}]=c;return u}).concat(o.trackList)}return Array.from(this.localTrackMap.entries()).filter(o=>{let[c]=o;return!(e&&c===yt.LocalVideoLowTrack)}).map(o=>{let[,{track:c}]=o;return c})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,i,o,c,u){if(e){const _=this.localTrackMap.get(yt.LocalAudioTrack),m=c?this.localTrackMap.get(yt.LocalVideoLowTrack):this.localTrackMap.get(yt.LocalVideoTrack);ne.publish(this.store.sessionId,{eventElapse:cs.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:i,audioName:_==null?void 0:_.track.getTrackLabel(),videoName:m==null?void 0:m.track.getTrackLabel(),screenshare:(m==null?void 0:m.track._hints.indexOf(Fn.SCREEN_TRACK))!==-1,audio:!!_,video:!!m,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}else{var h;o||(o=[]);const _=o.find(g=>g instanceof Nn),m=c?(h=this.localTrackMap.get(yt.LocalVideoTrack))===null||h===void 0?void 0:h.track:o.find(g=>g instanceof ke);ne.publish(this.store.sessionId,{eventElapse:cs.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:i,audioName:_==null?void 0:_.getTrackLabel(),videoName:m==null?void 0:m.getTrackLabel(),screenshare:(m==null?void 0:m._hints.indexOf(Fn.SCREEN_TRACK))!==-1,audio:!!_,video:!!m,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}}reportSubscribeEvent(e,i,o,c){const u=c===Xt.VIDEO?o._videoSSRC:o._audioSSRC;u&&ne.subscribe(this.store.sessionId,{succ:e,ec:i,video:c===Xt.VIDEO,audio:c===Xt.AUDIO,peerid:o.uid,subscribeRequestid:c===Xt.VIDEO?o._videoSSRC:o._audioSSRC,p2pid:this.store.p2pId,eventElapse:cs.measureFromSubscribeStart(this.store.clientId,u)})}reset(){O.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Sr("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Oi({},this.store):this.isPlanB?new bi({},this.store):new wi({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(yt.LocalAudioTrack);if((e==null?void 0:e.track)instanceof pr){if(e.track.trackList.length>0){const i=e.track;e.track.trackList.forEach(o=>{i.removeAudioTrack(o)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=En.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var i;return((i=this.connection)===null||i===void 0?void 0:i.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(yt.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(yt.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const i=this.localTrackMap.get(e);return i&&i.track instanceof ke||i&&i.track instanceof Nn?i.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,i){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!i||o.has(i))}async hasRemoteMediaWithLock(e,i){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!i||o.has(i))}getRemoteMedia(e){var i;const o=Array.from(lo(i=this.remoteUserMap).call(i)).find(c=>c.uid===e);return o?{audioTrack:o.audioTrack,audioSSRC:o._audioSSRC,videoTrack:o.videoTrack,videoSSRC:o._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(o=>{let[c]=o;return{uid:c.uid,level:c.audioTrack?100*c.audioTrack._source.getAccurateVolumeLevel():0}});const i=this.localTrackMap.get(yt.LocalAudioTrack);return i&&e.push({level:100*i.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=l_(e).call(e,(o,c)=>o.level-c.level),e}async disconnectForReconnect(){this.connection&&(O.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=En.Reconnecting,Q("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[i]=e;var o;i._videoTrack&&i._videoTrack._player&&((o=i._videoTrack._player.getVideoElement())===null||o===void 0||o.pause(),i._videoTrack._player.isKeepLastFrame=!0,i._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Oi({},this.store):this.isPlanB?new bi({},this.store):new wi({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var i;let[o,{track:c}]=e;switch(o){case yt.LocalVideoTrack:Jt(i=c._hints).call(i,Fn.LOW_STREAM)?c.close():this.pendingLocalTracks.push(c);break;case yt.LocalAudioTrack:c instanceof pr?this.pendingLocalTracks=this.pendingLocalTracks.concat(c.trackList):this.pendingLocalTracks.push(c)}}),this.emit(_e.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[i,o]=e;Array.from(lo(o).call(o)).forEach(c=>{this.setPendingRemoteMedia(i,c)}),this.emit(_e.MediaReconnectStart,i.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[i,o]=e;Array.from(lo(o).call(o)).forEach(c=>{this.setPendingRemoteDataChannel(i,c)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),O.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,i){for(const o of this.pendingRemoteDataChannels){const{user:c,id:u}=o;if((e instanceof Zr?e.uid:e)===c.uid&&u===i)return!0}return!1}setPendingRemoteDataChannel(e,i){this.hasPendingRemoteDataChannel(e,i)||this.pendingRemoteDataChannels.push({user:e,id:i})}hasPendingRemoteMedia(e,i){for(const o of this.pendingRemoteTracks){const{user:c,kind:u}=o;if((e instanceof Zr?e.uid:e)===c.uid&&i===u)return!0}return!1}setPendingRemoteMedia(e,i){this.hasPendingRemoteMedia(e,i)||this.pendingRemoteTracks.push({user:e,kind:i})}restartICE(e){var i=this;return Wo(function*(){if(!i.connection||i.state!==En.Connected||i.connection instanceof Oi)return;const o=yield Pe(i.mutex.lock("From P2PChannel.restartICE"));let c;try{c=yield Pe(i.connection.restartICE(e));const h=yield Pe(c.next());if(h.done)return;const _=h.value,m=yield _;switch(i.reportPCDisconnectedOrFailed(e),e){case Wr.TCP:i._pcStatsUploadType=ca.TCP_RESTART;break;case Wr.RELAY:i._pcStatsUploadType=ca.RELAY_RESTART;break;default:i._pcStatsUploadType=ca.OLD_RESTART}i._isInRestartIce=!0,c.next(m)}catch(h){var u;(u=c)===null||u===void 0||u.throw(h)}finally{o()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),i=this.localTrackMap.get(yt.LocalVideoTrack),o=this.localTrackMap.get(yt.LocalAudioTrack),c=e.videoSend.find(x=>x.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId)),u=e.audioSend.find(x=>x.ssrc===(o==null?void 0:o.ssrcs[0].ssrcId));if(!c||!u)return 1;const h=ko(this,_e.NeedSignalRTT),_=c?c.rttMs:void 0,m=u?u.rttMs:void 0,g=_&&m?(_+m)/2:_||m,S=(g&&h?(g+h)/2:g||h)||0,C=100*e.sendPacketLossRate*.7/50+.3*S/1500,I=C<.17?1:C<.36?2:C<.59?3:C<.1?4:5,b=i==null?void 0:i.track;if(b&&b._encoderConfig&&b._hints.indexOf(Fn.SCREEN_TRACK)===-1){const x=b._encoderConfig.bitrateMax,D=e.bitrate.actualEncoded;if(x&&D){const M=(1e3*x-D)/(1e3*x);return XL[M<.15?0:M<.3?1:M<.45?2:M<.6?3:4][I]}}return I}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let i=0;return Array.from(this.remoteUserMap.entries()).forEach(o=>{let[c]=o;const u=c._audioSSRC,h=c._videoSSRC,_=e.audioRecv.find(D=>D.ssrc===u),m=e.videoRecv.find(D=>D.ssrc===h);if(!_&&!m)return void(i+=1);const g=ko(this,_e.NeedSignalRTT),S=e.rtt,C=(S&&g?(S+g)/2:S||g)||0,I=_?_.jitterMs:void 0,b=e.recvPacketLossRate;let x=.7*b*100/50+.3*C/1500;I&&(x=.6*b*100/50+.2*C/1500+.2*I/400),i+=x<.1?1:x<.17?2:x<.36?3:x<.59?4:5}),this.remoteUserMap.size>0?Math.round(i/this.remoteUserMap.size):i}async muteLocalTrack(e){return new ut((i,o)=>{this.handleMuteLocalTrack(e,i,o)})}async replaceTrack(e,i){var o;if(O.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(i.getTrackId(),"]")),!this.connection||this.state!==En.Connected)return;const c=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:_}]=h;return e===_});if(!c)return;const u=c[0];if(e!==i&&(this.unbindLocalTrackEvents([{track:e,type:u}]),this.bindLocalTrackEvents([{track:i,type:u}]),c[1].track=i),await((o=this.connection)===null||o===void 0?void 0:o.replaceTrack(i,c[1].id)),this.isPlanB){const h=c[1];h.id=i._mediaStreamTrack.id,this.localTrackMap.set(u,h)}if(u===yt.LocalVideoTrack&&!Q("DISABLE_DUAL_STREAM_USE_ENCODING")&&sn().supportDualStreamEncoding){const h=this.localTrackMap.get(yt.LocalVideoLowTrack);if(h){const _=e._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=_,h.track._originMediaStreamTrack=_,await new ut((m,g)=>{this.handleReplaceTrack(h.track,m,g,!0)})}}}filterTobePublishedTracks(e,i,o){const c=[],u=this.getAllTracks();e=zh(e=e.filter(g=>u.indexOf(g)===-1));let h,_=!1;const m=this.localTrackMap.get(yt.LocalAudioTrack);for(const g of e){if(g instanceof ke&&(this.localTrackMap.has(yt.LocalVideoTrack)||_?new ft(j.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(c.push({track:g,type:yt.LocalVideoTrack}),_=!0),i)){const S=this.getLowVideoTrack(g,o);c.push({track:S,type:yt.LocalVideoLowTrack})}if(g instanceof Nn)if(m){const S=m.track;if(S instanceof pr)SC([g]),S.addAudioTrack(g),this.bindLocalAudioTrackEvents(g,!0);else{const C=eO([S,g]);O.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(C.getTrackId(),"]")),this.replaceTrack(S,C)}}else h instanceof pr?(SC([g]),h.addAudioTrack(g)):h||!g._useAudioElement&&sn().webAudioMediaStreamDest&&!g._bypassWebAudio?h=eO(h?[g,h]:[g]):h=g}return h&&(O.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(h.getTrackId(),"]")),c.push({track:h,type:yt.LocalAudioTrack})),c}filterTobeUnpublishedTracks(e){const i=[],o=this.getAllTracks();e=zh(e=e.filter(c=>o.indexOf(c)!==-1));for(const c of e){if(c instanceof Nn){const u=this.localTrackMap.get(yt.LocalAudioTrack);if(!u)continue;u.track instanceof pr?(u.track.removeAudioTrack(c),this.unbindLocalAudioTrackEvents(c),u.track.trackList.length===0&&(i.push([yt.LocalAudioTrack,u]),u.track.close())):i.push([yt.LocalAudioTrack,u])}if(c instanceof ke){const u=this.localTrackMap.get(yt.LocalVideoTrack);if(!u)continue;i.push([yt.LocalVideoTrack,u]);const h=this.localTrackMap.get(yt.LocalVideoLowTrack);h&&i.push([yt.LocalVideoLowTrack,h])}}return i}filterTobePublishedDataChannels(e){return e=(e=zh(e)).filter(i=>this.localDataChannels.findIndex(o=>o.id===i.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=zh(e)).filter(i=>this.localDataChannels.indexOf(i)!==-1)).filter(i=>i._originDataChannel)}bindLocalTrackEvents(e){e.forEach(i=>{let{track:o,type:c}=i;switch(c){case yt.LocalVideoTrack:o.addListener(Vt.GET_STATS,this.handleGetLocalVideoStats),o.addListener(Vt.GET_RTC_STATS,this.handleGetRTCStats),o.addListener(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(Vt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.addListener(Vt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.addListener(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.addListener(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case yt.LocalAudioTrack:this.bindLocalAudioTrackEvents(o)}})}bindLocalAudioTrackEvents(e,i){e instanceof pr?e.trackList.forEach(o=>{o.addListener(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(Vt.GET_STATS,this.handleGetLocalAudioStats),o.addListener(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(Vt.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),i||(e.addListener(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(Vt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(i=>{let[o,{track:c}]=i;return{track:c,type:o}})),e.forEach(i=>{let{track:o,type:c}=i;switch(c){case yt.LocalVideoTrack:o.off(Vt.GET_STATS,this.handleGetLocalVideoStats),o.off(Vt.GET_RTC_STATS,this.handleGetRTCStats),o.off(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.off(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.off(Vt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.off(Vt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.off(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.off(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.off(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case yt.LocalAudioTrack:this.unbindLocalAudioTrackEvents(o)}})}unbindLocalAudioTrackEvents(e){e instanceof pr?e.trackList.forEach(i=>{i.off(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(Vt.GET_STATS,this.handleGetLocalAudioStats),i.off(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(Vt.GET_STATS,this.handleGetLocalAudioStats),e.off(Vt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Vt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Vt.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Vt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(Vt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Vt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,i){i instanceof fe&&i.addListener(Vt.GET_STATS,o=>{o(this.handleGetRemoteVideoStats(e))}),i instanceof ue&&i.addListener(Vt.GET_STATS,o=>{o(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Vt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[i,o]=e;o.has(Xt.AUDIO)&&this.unbindRemoteTrackEvents(i._audioTrack),o.has(Xt.VIDEO)&&this.unbindRemoteTrackEvents(i._videoTrack)})}createGatewayPublishMessage(e,i){return e.map((o,c)=>{var u;let h,_,{track:m,type:g}=o;switch(g){case yt.LocalAudioTrack:h=rn.Audio,_={dtx:m instanceof wl&&m._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case yt.LocalVideoTrack:h=Jt(u=m._hints).call(u,Fn.SCREEN_TRACK)?rn.Screen:rn.High,_=cu(cu({},qd(m)),{},{codec:this.store.codec});break;case yt.LocalVideoLowTrack:h=rn.Low,_=cu(cu({},qd(m)),{},{codec:this.store.codec})}return{stream_type:h,attributes:_,ssrcs:i[c]}})}createGatewayUnpublishMessage(e){return e.map(i=>{var o;let c,[u,{track:h,ssrcs:_,id:m}]=i;switch(u){case yt.LocalVideoTrack:c=Jt(o=h._hints).call(o,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalAudioTrack:c=rn.Audio;break;case yt.LocalVideoLowTrack:c=rn.Low}return{stream_type:c,ssrcs:_,mid:m}})}assignLocalTracks(e,i){e.forEach((o,c)=>{let{track:u,type:h}=o;this.localTrackMap.set(h,{track:u,id:i[c].id,ssrcs:i[c].localSSRC})})}withdrawLocalTracks(e){e.forEach(i=>{let[o]=i;this.localTrackMap.delete(o)})}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{if(O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(_e.PeerConnectionStateChange,i),i!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),i==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),Q("NEW_ICE_RESTART")){var o;if(Jt(o=this._restartStates).call(o,i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const c=_=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")&&(O.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(_)),ko(this,_e.QueryClientConnectionState)==="CONNECTED"&&this.emit(_e.RequestRestartICE,_))},u=()=>{e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="checking"&&e.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),O.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(_e.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},h=Q("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(Q("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&sn().supportPCSetConfiguration)c(Wr.RELAY),this._restartTimer=window.setTimeout(u,h);else if(Ln())c(Wr.UDP),this._restartTimer=window.setTimeout(u,4e3);else{if(c(Wr.TCP),sn().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{c(Wr.RELAY),this._restartTimer=window.setTimeout(u,h)},h));this._restartTimer=window.setTimeout(u,h)}},800))}}else{if(i==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&Q("ICE_RESTART")&&ko(this,_e.QueryClientConnectionState)==="CONNECTED"&&this.emit(_e.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(O.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(_e.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);i==="failed"&&(O.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(_e.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=i=>{i!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(i,")")),ne.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:i,tag:gi.TRACER}).onSuccess(),this.emit(_e.IceConnectionStateChange,i)},e.onICETransportStateChange=i=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(i,")"))},e.onDTLSTransportStateChange=i=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(i,")"))},e.onDTLSTransportError=i=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(i,")"))},e.onFirstAudioDecoded=i=>{var o;const c=Array.from(lo(o=this.remoteUserMap).call(o)).find(h=>h._audioSSRC===i);var u;c&&(this.store.subscribe(c.uid,"audio",void 0,void 0,void 0,Date.now()),(u=c.audioTrack)===null||u===void 0||u.emit(on.FIRST_FRAME_DECODED),ne.firstRemoteFrame(this.store.sessionId,Rr.FIRST_AUDIO_DECODE,ei.FIRST_AUDIO_DECODE,{peer:c._uintid,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=i=>{var o;const c=Array.from(lo(o=this.remoteUserMap).call(o)).find(u=>u._audioSSRC===i);c&&ne.firstRemoteFrame(this.store.sessionId,Rr.FIRST_AUDIO_RECEIVED,ei.FIRST_AUDIO_RECEIVED,{peer:c._uintid,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(i,o,c)=>{this.reportVideoFirstFrameDecoded(i,o,c)},e.onFirstVideoReceived=i=>{var o;const c=Array.from(lo(o=this.remoteUserMap).call(o)).find(u=>u._videoSSRC===i);c&&ne.firstRemoteFrame(this.store.sessionId,Rr.FIRST_VIDEO_RECEIVED,ei.FIRST_VIDEO_RECEIVED,{peer:c._uintid,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(i,o)=>{const c=i.candidateType==="relay",u=o.candidateType==="relay";o.candidateType!=="unknown"&&c===u||this.emit(_e.ConnectionTypeChange,c),O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(mo(o))," -> ").concat(JSON.stringify(mo(i)),")"))},e.onSelectedRemoteCandidateChanged=(i,o)=>{O.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(mo(o))," -> ").concat(JSON.stringify(mo(i)),")"))},e.onFirstVideoDecodedTimeout=i=>{this.reportVideoFirstFrameDecoded(i,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const i=[];if(this.getAllTracks().indexOf(e)===-1)return i;const o=this.localTrackMap.get(yt.LocalAudioTrack);if(e instanceof Nn&&(o==null?void 0:o.track)instanceof pr)return o.track.isActive||i.push([yt.LocalAudioTrack,o]),i;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:h}]=u;return e===h});if(c&&(i.push(c),c[0]===yt.LocalVideoTrack)){const u=this.localTrackMap.get(yt.LocalVideoLowTrack);u&&i.push([yt.LocalVideoLowTrack,u])}return i}filterTobeUnmutedTracks(e){const i=[],o=this.localTrackMap.get(yt.LocalAudioTrack);if(e instanceof Nn&&(o==null?void 0:o.track)instanceof pr)return o.track.isActive&&i.push([yt.LocalAudioTrack,o]),i;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:h}]=u;return e===h});if(c)if(c[0]===yt.LocalVideoTrack){i.push(c);const u=this.localTrackMap.get(yt.LocalVideoLowTrack);u&&i.push([yt.LocalVideoLowTrack,u])}else i.push(c);return i}createMuteMessage(e){return e.map(i=>{var o;let c,[u,{track:h,ssrcs:_,id:m}]=i;switch(u){case yt.LocalAudioTrack:c=rn.Audio;break;case yt.LocalVideoTrack:c=Jt(o=h._hints).call(o,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalVideoLowTrack:c=rn.Low}return{stream_type:c,ssrcs:_,mid:m}})}createUnmuteMessage(e){return e.map(i=>{var o;let c,[u,{track:h,ssrcs:_,id:m}]=i;switch(u){case yt.LocalAudioTrack:c=rn.Audio;break;case yt.LocalVideoTrack:c=Jt(o=h._hints).call(o,Fn.SCREEN_TRACK)?rn.Screen:rn.High;break;case yt.LocalVideoLowTrack:c=rn.Low}return{stream_type:c,ssrcs:_,mid:m}})}filterTobeUnSubscribedTracks(e,i){const o=[],c=this.remoteUserMap.get(e);if(!c)return o;if(i){const u=c.get(i);if(!u)return o;o.push([e,{kind:i,id:u}])}else Array.from(c.entries()).forEach(u=>{let[h,_]=u;o.push([e,{kind:h,id:_}])});return o}filterTobeUnSubscribedDataChannels(e,i){const o=[];return i.forEach(c=>{var u;(u=this.remoteDataChannelMap.get(e))!==null&&u!==void 0&&u.has(c.id)&&o.push(c)}),o}createUnsubscribeMessage(e){const i=[];return e.forEach(o=>{let[c,{kind:u,id:h}]=o;switch(u){case Xt.VIDEO:return void(c._videoSSRC&&i.push({stream_type:Xt.VIDEO,ssrcId:c._videoSSRC}));case Xt.AUDIO:return void(c._audioSSRC&&i.push({stream_type:Xt.AUDIO,ssrcId:c._audioSSRC}))}}),i}createUnsubscribeAllMessage(e){const i=new Map;return e.forEach(o=>{let[c,{kind:u}]=o;if(i.has(c)){let h=i.get(c);u===Xt.VIDEO?h|=dr.Video:h|=dr.Audio,i.set(c,h)}else u===Xt.VIDEO?i.set(c,dr.Video):i.set(c,dr.Audio)}),{users:Array.from(i.entries()).map(o=>{let[c,u]=o;return{stream_id:c.uid,stream_type:u}})}}withdrawRemoteTracks(e){e.forEach(i=>{let[o,{kind:c}]=i;const u=this.remoteUserMap.get(o);u&&(u.delete(c),Array.from(u.entries()).length===0&&this.remoteUserMap.delete(o))})}async updateBitrateLimit(e){const i=this.localTrackMap.get(yt.LocalVideoTrack),o=this.localTrackMap.get(yt.LocalVideoLowTrack);i&&await i.track.setBitrateLimit(e.uplink),o&&e.low_stream_uplink&&await o.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(e,i){return e.map((o,c)=>{var u;let{stream_type:h}=o;return(u=i.find(_=>{let{stream_type:m}=_;return h===m}))===null||u===void 0?void 0:u.attributes})}async tryToUnmuteAudio(e){for(let o=0;o<e.length;o++)if(e[o]instanceof Nn){var i;const c=this.filterTobeUnmutedTracks(e[o]);if(c.length===0)continue;await((i=this.connection)===null||i===void 0?void 0:i.unmuteLocal(c.map(h=>{let[,{id:_}]=h;return _})));const u=this.createUnmuteMessage(c);return void await kn(this,_e.RequestUnmuteLocal,u)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var i;return!((i=this.connection)===null||i===void 0||!i.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,i)=>this.emit(_e.RequestUpload,e,i),this.statsUploader.requestUploadStats=e=>this.emit(_e.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Mr($m(this.dtlsFailedCount,nr)),this.emit(_e.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),i=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),i.length>0&&await zi(this,_e.RequestUnpublishForReconnectPC,i),this.disconnectForReconnect(),this.emit(_e.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(yt.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof ke)}throwIfTrackTypeNotMatch(e){if(e.filter(i=>i instanceof ke).length>1)throw new ft(j.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(i=>i instanceof Nn).length>1&&(e.some(i=>i instanceof Nn&&i._bypassWebAudio)||!sn().webAudioMediaStreamDest))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const i of e){if(i instanceof ke&&this.pendingLocalTracks.some(o=>o instanceof ke))throw new ft(j.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(i instanceof Nn&&this.pendingLocalTracks.some(o=>o instanceof Nn)&&(!sn().webAudioMediaStreamDest||i._bypassWebAudio||this.pendingLocalTracks.some(o=>o instanceof Nn&&o._bypassWebAudio)))throw new ft(j.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,i){const o=!Q("DISABLE_DUAL_STREAM_USE_ENCODING")&&sn().supportDualStreamEncoding,c=cu(cu({},{width:160,height:120,framerate:15,bitrate:50}),i);let u;u=o?e._mediaStreamTrack.clone():wg(e,c);const h=Hn(8,"track-low-"),_=new ke(u,cu(cu({},o&&{scaleResolutionDownBy:Nr(c,e)}),{},{frameRate:c.framerate,bitrateMax:c.bitrate,bitrateMin:c.bitrate}),void 0,void 0,h);return _.on(Xd.TRANSCEIVER_UPDATED,m=>{e._updateRtpTransceiver(m,la.LOW_STREAM)}),_._hints.push(Fn.LOW_STREAM),e.on("sei-to-send",m=>{_.emit("sei-to-send",m)}),e.addListener(Vt.NEED_CLOSE,()=>{_.close()}),_}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,i,o){let c=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof wi){var u,h,_,m;const g=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:S,dtlsTransportState:C,peerConnectionState:I}=this.connection,{local:b,remote:x}=await this.connection.getSelectedCandidatePair();ne.pcStats(this.store.sessionId,{startTime:g,eventElapse:e-g||0,iceconnectionsate:S,dtlsstate:C,connectionstate:I,intSucc:i?1:2,error:c,selectedLocalCandidateProtocol:(u=b==null?void 0:b.protocol)!==null&&u!==void 0?u:"",selectedLocalCandidateType:(h=b.candidateType)!==null&&h!==void 0?h:"",selectedLocalCandidateAddress:"".concat(b.address,":").concat(b.port),selectedRemoteCandidateProtocol:(_=x.protocol)!==null&&_!==void 0?_:"",selectedRemoteCandidateType:(m=x.candidateType)!==null&&m!==void 0?m:"",selectedRemoteCandidateAddress:"".concat(x.address,":").concat(x.port),restartCnt:o})}}reportVideoFirstFrameDecoded(e,i,o,c){var u;const h=Array.from(lo(u=this.remoteUserMap).call(u)).find(_=>_._videoSSRC===e);if(h){c||this.store.subscribe(h.uid,"video",void 0,void 0,void 0,void 0,Date.now());const _=this.store.keyMetrics,m=_.subscribe.find(g=>g.userId===h.uid&&g.type==="video");ne.firstRemoteVideoDecode(this.store.sessionId,Rr.FIRST_VIDEO_DECODE,ei.FIRST_VIDEO_DECODE,{peer:h._uintid,videowidth:i,videoheight:o,subscribeElapse:cs.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:_.requestAPEnd||0,apStart:_.requestAPStart||0,joinGwEnd:_.joinGatewayEnd||0,joinGwStart:_.joinGatewayStart||0,pcEnd:_.peerConnectionEnd||0,pcStart:_.peerConnectionStart||0,subscriberEnd:(m==null?void 0:m.subscribeEnd)||0,subscriberStart:(m==null?void 0:m.subscribeStart)||0,videoAddNotify:(m==null?void 0:m.streamAdded)||0,state:c?1:0})}}async remoteMediaSsrcChanged(e,i,o){if(!this.connection)return!1;const c=this.remoteUserMap.get(e);if(!c)return!1;const u=c.get(i);if(!u)return!1;const h=await this.connection.getRemoteSSRC(u);return h!==void 0&&h!==o}resetConnection(e){O.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===En.Connected?(O.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===hf.datachannel?new Oi({},this.store):this.isPlanB?new bi({},this.store):new wi({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[i,{track:o}]=e;i===yt.LocalVideoLowTrack?o._updateRtpTransceiver(void 0,la.LOW_STREAM):o._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof wi&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===ca.TCP_RESTART&&e===Wr.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,ca.DISCONNECTED_OR_FAILED)))}}function pn(s,e,i){const o=s[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const c=this.mutex,u=await c.lock("From P2PChannel.".concat(e));try{for(var h=arguments.length,_=new Array(h),m=0;m<h;m++)_[m]=arguments[m];return await o.apply(this,_)}finally{u()}},i}function Bp(s){let e=uO();return function(i,o){let c=i.appId;c!==void 0&&(In(o,10),Ad(o,c));let u=i.cid;u!==void 0&&(In(o,16),In(o,u));let h=i.cname;h!==void 0&&(In(o,26),Ad(o,h));let _=i.deviceId;_!==void 0&&(In(o,34),Ad(o,_));let m=i.elapse;m!==void 0&&(In(o,40),Zu(o,m));let g=i.fileSize;g!==void 0&&(In(o,48),Zu(o,Ee(g)));let S=i.height;S!==void 0&&(In(o,56),Zu(o,Ee(S)));let C=i.jpg;C!==void 0&&(In(o,66),In(o,C.length),function(Xo,St){let Dt=wE(Xo,St.length);Xo.bytes.set(St,Dt)}(o,C));let I=i.networkType;I!==void 0&&(In(o,72),Zu(o,Ee(I)));let b=i.osType;b!==void 0&&(In(o,80),Zu(o,Ee(b)));let x=i.requestId;x!==void 0&&(In(o,90),Ad(o,x));let D=i.sdkVersion;D!==void 0&&(In(o,98),Ad(o,D));let M=i.sequence;M!==void 0&&(In(o,104),Zu(o,Ee(M)));let K=i.sid;K!==void 0&&(In(o,114),Ad(o,K));let z=i.timestamp;z!==void 0&&(In(o,120),Zu(o,z));let nt=i.uid;nt!==void 0&&(In(o,128),In(o,nt));let dt=i.vid;dt!==void 0&&(In(o,136),In(o,dt));let it=i.width;it!==void 0&&(In(o,144),Zu(o,Ee(it)));let at=i.service;at!==void 0&&(In(o,152),In(o,at));let ht=i.callbackData;ht!==void 0&&(In(o,162),Ad(o,ht));let pt=i.jpgEncryption;pt!==void 0&&(In(o,168),In(o,pt));let bt=i.requestType;bt!==void 0&&(In(o,176),In(o,bt));let kt=i.scorePorn;kt!==void 0&&(In(o,185),bC(o,kt));let Ne=i.scoreSexy;Ne!==void 0&&(In(o,193),bC(o,Ne));let Ge=i.scoreNeutral;Ge!==void 0&&(In(o,201),bC(o,Ge));let Qn=i.scene;Qn!==void 0&&(In(o,208),In(o,Qn));let Er=i.ossFilePrefix;Er!==void 0&&(In(o,218),Ad(o,Er));let jn=i.serviceVendor;if(jn!==void 0)for(let Xo of jn){In(o,226);let St=uO();vo(Xo,St),In(o,St.limit),m1(o,St),E1(St)}}(s,e),function(i){let o=i.bytes,c=i.limit;return o.length===c?o:o.subarray(0,c)}(e)}function p1(s){return function(i){let o={};t:for(;!Bc(i);){let c=bd(i);switch(c>>>3){case 0:break t;case 1:o.code=bd(i);break;case 2:o.msg=yC(i,bd(i));break;case 3:{let u=_1(i);o.data=Id(i),i.limit=u;break}default:Io(i,7&c)}}return o}({bytes:e=s,offset:0,limit:e.length});var e}function Id(s){let e={};t:for(;!Bc(s);){let i=bd(s);switch(i>>>3){case 0:break t;case 1:e.requestId=yC(s,bd(s));break;case 2:e.requestType=bd(s)>>>0;break;case 3:e.scorePorn=AC(s);break;case 4:e.scoreSexy=AC(s);break;case 5:e.scoreNeutral=AC(s);break;case 6:e.requestScene=bd(s)>>>0;break;case 7:e.scene=bd(s)>>>0;break;default:Io(s,7&i)}}return e}function vo(s,e){let i=s.service;i!==void 0&&(In(e,8),In(e,i));let o=s.vendor;o!==void 0&&(In(e,16),In(e,o));let c=s.token;c!==void 0&&(In(e,26),Ad(e,c));let u=s.callbackUrl;u!==void 0&&(In(e,34),Ad(e,u))}function _1(s){let e=bd(s),i=s.limit;return s.limit=s.offset+e,i}function Io(s,e){switch(e){case 0:for(;128&lO(s););break;case 2:du(s,bd(s));break;case 5:du(s,4);break;case 1:du(s,8);break;default:throw new Error("Unimplemented type: "+e)}}Tt([pn,V("design:type",Function),V("design:paramtypes",[Object,Boolean]),V("design:returntype",ut)],Ki.prototype,"startP2PConnection",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Object,Object,Array,Object,String,String]),V("design:returntype",ut)],Ki.prototype,"connect",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",void 0)],Ki.prototype,"updateRemoteRTPCapabilities",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Object,Object,Array,Object,String,String]),V("design:returntype",ut)],Ki.prototype,"preConnect",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ki.prototype,"publishDataChannel",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ki.prototype,"unpublish",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ki.prototype,"unpublishDataChannel",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Ki.prototype,"unpublishLowStream",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,Array]),V("design:returntype",ut)],Ki.prototype,"subscribeDataChannel",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,String,Number,Number,Array]),V("design:returntype",ut)],Ki.prototype,"subscribe",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ki.prototype,"massSubscribe",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,String,Boolean]),V("design:returntype",ut)],Ki.prototype,"unsubscribe",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,Array]),V("design:returntype",ut)],Ki.prototype,"unsubscribeDataChannel",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Ki.prototype,"massUnsubscribe",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,String]),V("design:returntype",ut)],Ki.prototype,"muteRemote",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,String]),V("design:returntype",ut)],Ki.prototype,"unmuteRemote",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,String]),V("design:returntype",ut)],Ki.prototype,"hasRemoteMediaWithLock",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Ki.prototype,"disconnectForReconnect",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Ki.prototype,"updateBitrateLimit",null),Tt([pn,V("design:type",Function),V("design:paramtypes",[Zr,String,Number]),V("design:returntype",ut)],Ki.prototype,"remoteMediaSsrcChanged",null);let yd=new Float64Array(1),ls=new Uint8Array(yd.buffer);function Ee(s){return{low:s|=0,high:s>>31,unsigned:s>=0}}let dO=[];function uO(){const s=dO.pop();return s?(s.offset=s.limit=0,s):{bytes:new Uint8Array(64),offset:0,limit:0}}function E1(s){dO.push(s)}function du(s,e){if(s.offset+e>s.limit)throw new Error("Skip past limit");s.offset+=e}function Bc(s){return s.offset>=s.limit}function wE(s,e){let i=s.bytes,o=s.offset,c=s.limit,u=o+e;if(u>i.length){let h=new Uint8Array(2*u);h.set(i),s.bytes=h}return s.offset=u,u>c&&(s.limit=u),o}function kg(s,e){let i=s.offset;if(i+e>s.limit)throw new Error("Read past limit");return s.offset+=e,i}function yC(s,e){let i=kg(s,e),o=String.fromCharCode,c=s.bytes,u="�",h="";for(let _=0;_<e;_++){let m,g,S,C,I=c[_+i];(128&I)==0?h+=o(I):(224&I)==192?_+1>=e?h+=u:(m=c[_+i+1],(192&m)!=128?h+=u:(C=(31&I)<<6|63&m,C<128?h+=u:(h+=o(C),_++))):(240&I)==224?_+2>=e?h+=u:(m=c[_+i+1],g=c[_+i+2],(49344&(m|g<<8))!=32896?h+=u:(C=(15&I)<<12|(63&m)<<6|63&g,C<2048||C>=55296&&C<=57343?h+=u:(h+=o(C),_+=2))):(248&I)==240?_+3>=e?h+=u:(m=c[_+i+1],g=c[_+i+2],S=c[_+i+3],(12632256&(m|g<<8|S<<16))!=8421504?h+=u:(C=(7&I)<<18|(63&m)<<12|(63&g)<<6|63&S,C<65536||C>1114111?h+=u:(C-=65536,h+=o(55296+(C>>10),56320+(1023&C)),_+=3))):h+=u}return h}function Ad(s,e){let i=e.length,o=0;for(let h=0;h<i;h++){let _=e.charCodeAt(h);_>=55296&&_<=56319&&h+1<i&&(_=(_<<10)+e.charCodeAt(++h)-56613888),o+=_<128?1:_<2048?2:_<65536?3:4}In(s,o);let c=wE(s,o),u=s.bytes;for(let h=0;h<i;h++){let _=e.charCodeAt(h);_>=55296&&_<=56319&&h+1<i&&(_=(_<<10)+e.charCodeAt(++h)-56613888),_<128?u[c++]=_:(_<2048?u[c++]=_>>6&31|192:(_<65536?u[c++]=_>>12&15|224:(u[c++]=_>>18&7|240,u[c++]=_>>12&63|128),u[c++]=_>>6&63|128),u[c++]=63&_|128)}}function m1(s,e){let i=wE(s,e.limit),o=s.bytes,c=e.bytes;for(let u=0,h=e.limit;u<h;u++)o[u+i]=c[u]}function lO(s){return s.bytes[kg(s,1)]}function hO(s,e){let i=wE(s,1);s.bytes[i]=e}function AC(s){let e=kg(s,8),i=s.bytes;return ls[0]=i[e++],ls[1]=i[e++],ls[2]=i[e++],ls[3]=i[e++],ls[4]=i[e++],ls[5]=i[e++],ls[6]=i[e++],ls[7]=i[e++],yd[0]}function bC(s,e){let i=wE(s,8),o=s.bytes;yd[0]=e,o[i++]=ls[0],o[i++]=ls[1],o[i++]=ls[2],o[i++]=ls[3],o[i++]=ls[4],o[i++]=ls[5],o[i++]=ls[6],o[i++]=ls[7]}function bd(s){let e,i=0,o=0;do e=lO(s),i<32&&(o|=(127&e)<<i),i+=7;while(128&e);return o}function In(s,e){for(e>>>=0;e>=128;)hO(s,127&e|128),e>>>=7;hO(s,e)}function Zu(s,e){let i=e.low>>>0,o=(e.low>>>28|e.high<<4)>>>0,c=e.high>>>24,u=c===0?o===0?i<16384?i<128?1:2:i<1<<21?3:4:o<16384?o<128?5:6:o<1<<21?7:8:c<128?9:10,h=wE(s,u),_=s.bytes;switch(u){case 10:_[h+9]=c>>>7&1;case 9:_[h+8]=u!==9?128|c:127&c;case 8:_[h+7]=u!==8?o>>>21|128:o>>>21&127;case 7:_[h+6]=u!==7?o>>>14|128:o>>>14&127;case 6:_[h+5]=u!==6?o>>>7|128:o>>>7&127;case 5:_[h+4]=u!==5?128|o:127&o;case 4:_[h+3]=u!==4?i>>>21|128:i>>>21&127;case 3:_[h+2]=u!==3?i>>>14|128:i>>>14&127;case 2:_[h+1]=u!==2?i>>>7|128:i>>>7&127;case 1:_[h]=u!==1?128|i:127&i}}function pO(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}const f1=new Map([["moderation",1],["supervise",2]]);class ti extends oi{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const i=this._connectionState;this._connectionState=e,this.emit(ur.CONNECTION_STATE_CHANGE,i,e)}get inspectType(){return this._inspectType}set inspectType(e){var i;this._inspectMode=Lu(i=e.map(o=>f1.get(o)||0)).call(i,(o,c)=>o+c),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),A(this,"name","AgoraRTCVideoContentInspect"),A(this,"_connectionState",Mo.CONNECTING),A(this,"_innerConnectionState",void 0),A(this,"sequence",0),A(this,"inspectStartTime",void 0),A(this,"workerManagerConnection",void 0),A(this,"workerConnection",void 0),A(this,"workerMessageLengthLimit",void 0),A(this,"inspectIntervalMinimum",void 0),A(this,"qualityRatio",void 0),A(this,"_connectInfo",void 0),A(this,"_cancelTokenSource",Ks.CancelToken.source()),A(this,"_retryConfig",void 0),A(this,"wmSequence",0),A(this,"inspectInterval",void 0),A(this,"inspectTimer",null),A(this,"ossFilePrefix",void 0),A(this,"extraInfo",void 0),A(this,"_inspectType",void 0),A(this,"_inspectMode",void 0),A(this,"_quality",1),A(this,"qualityTimer",null),A(this,"_inspectId",void 0),A(this,"_needWorkUrlOnly",!1),A(this,"inspectImage",()=>{if(this.connectionState!==Mo.CONNECTED)throw new st(j.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Mo.CONNECTED?this.requestToInspectImage():O.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Hn(5,"inspect-"),this.workerMessageLengthLimit=Q("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=Q("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=Q("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new vr("worker-manager-"+this._inspectId,nr),this.on(ur.STATE_CHANGE,(i,o)=>{this._innerConnectionState=i,O.debug("[".concat(this._inspectId,"] Inspect operation :").concat(da[i]," ").concat(o||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new vr("worker-"+this._inspectId,nr),this.handleWorkerEvents()}async init(e,i){this.emit(ur.STATE_CHANGE,da.CONNECT_AP),this._connectInfo=e;const o=this._cancelTokenSource.token;return this._retryConfig=i,new ut((c,u)=>{this.on(ur.CONNECTION_STATE_CHANGE,(h,_)=>{_===Mo.CONNECTED&&c()}),this.requestAP(e,o,i).then(h=>{this.connectWorkerManager(h)}).catch(h=>{u(h)})})}async requestAP(e,i,o){const c=Q("WEBCS_DOMAIN").map(_=>"https://".concat(_,"/api/v1")),u=await function(_,m,g,S){let{appId:C,areaCode:I,cname:b,sid:x,token:D,uid:M}=m;bc++;const K="image_moderation_api",z={service_name:K,json_body:JSON.stringify({appId:C,areaCode:I,cname:b,command:"allocateEdge",requestId:bc,seq:bc,sid:x,token:D,ts:Date.now(),uid:M+""})};let nt,dt,it=_[0];return ed(async()=>{nt=Date.now();const at=await Jd(it,{data:z,cancelToken:g,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(dt=Date.now()-nt,at.code!==0){const kt=new st(j.UNEXPECTED_RESPONSE,"image inspect ap error, code"+at.code,{retry:!0,responseTime:dt});throw O.error(kt.toString()),kt}const ht=JSON.parse(at.json_body);if(ht.code!==200){const kt=new st(j.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(ht.code,", reason: ").concat(ht.reason),{code:ht.code,responseTime:dt});throw O.error(kt.toString()),kt}if(!ht.servers||!Array.isArray(ht.servers)||ht.servers.length===0){const kt=new st(j.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:ht.code,responseTime:dt});throw O.error(kt.toString()),kt}const pt=Q("VIDEO_INSPECT_WORKER_MANAGER_HOST"),bt=Q("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:ht.servers.map(kt=>{let{address:Ne,wss:Ge}=kt;if(Ne&&Ge)return"wss://".concat(Ne.replace(/\./g,"-"),".").concat(pt,":").concat(bt||Ge)}).filter(kt=>!!kt),workerToken:ht.workerToken,vid:ht.vid,responseTime:dt}},(at,ht)=>(ne.apworkerEvent(x,{success:!0,sc:200,serviceName:K,responseDetail:JSON.stringify(at.addressList),firstSuccess:ht===0,responseTime:dt,serverIp:_[ht%_.length]}),!1),(at,ht)=>(ne.apworkerEvent(x,{success:!1,sc:at.data&&at.data.code||200,serviceName:K,responseTime:dt,serverIp:_[ht%_.length]}),!!(at.code!==j.OPERATION_ABORTED&&at.code!==j.UNEXPECTED_RESPONSE||at.data&&at.data.retry)&&(it=_[(ht+1)%_.length],!0)),S)}(c,e,i,o);this.emit(ur.STATE_CHANGE,da.AP_CONNECTED);const{addressList:h}=u;return this.wmSequence++,h}async connectWorkerManager(e){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=i,this.emit(ur.STATE_CHANGE,da.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Se.CONNECTED,async()=>{this.emit(ur.STATE_CHANGE,da.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Se.CLOSED,()=>{this._innerConnectionState<da.GET_WORKER_MANAGER_RESPONSE&&O.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Se.FAILED,()=>{this._innerConnectionState<da.GET_WORKER_MANAGER_RESPONSE&&O.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Se.RECONNECTING,()=>{this._innerConnectionState<da.GET_WORKER_MANAGER_RESPONSE&&O.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Se.ON_MESSAGE,async e=>{this.emit(ur.STATE_CHANGE,da.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const o=JSON.parse(e.data);if(o.code!==200)throw O.error("[".concat(this._inspectId,"] Unexpected code ").concat(o.code," from worker manager")),new st(j.UNEXPECTED_RESPONSE,"response code of worker is unexpected",o);if(!(o.serverResponse&&o.serverResponse.portWss&&i))throw O.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(o))),new st(j.UNEXPECTED_RESPONSE,"response content of worker is unexpected",o);{const c=Q("VIDEO_INSPECT_WORKER_PORT")||o.serverResponse.portWss,u=i.replace(/:\d+\/?$/,":".concat(c));this.emit(ur.STATE_CHANGE,da.CONNECT_WORKER,u),this._needWorkUrlOnly?this.emit(ur.REQUEST_NEW_WORKER_URL,u):await this.connectWorker(u)}}),this.workerManagerConnection.on(Se.WILL_RECONNECT,(e,i,o)=>{o(e)}),this.workerManagerConnection.on(Se.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}handleWorkerEvents(){this.workerConnection.on(Se.CONNECTED,async()=>{this.emit(ur.STATE_CHANGE,da.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Mo.CONNECTED}),this.workerConnection.on(Se.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const o=p1(new Uint8Array(e.data));if(Q("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&O.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(o)),o.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(ur.INSPECT_RESULT,void 0,void 0);if(o.data&&o.data.scorePorn&&o.data.scoreSexy&&o.data.scoreNeutral){var i;const c={porn:o.data.scorePorn,sexy:o.data.scoreSexy,neutral:o.data.scoreNeutral},u=Lu(i=Object.keys(c)).call(i,(_,m)=>c[_]>c[m]?_:m,"porn"),h=Object.keys(c).find(_=>_===u);this.emit(ur.INSPECT_RESULT,h)}else this.emit(ur.INSPECT_RESULT,void 0,new st(j.UNEXPECTED_RESPONSE,o.code+"","There is an unexpected data on message"))}else this.emit(ur.INSPECT_RESULT,void 0,new st(j.UNEXPECTED_RESPONSE,o.code+"",o.msg))}else O.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(ur.INSPECT_RESULT,void 0,new st(j.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Se.CLOSED,()=>{this.connectionState=Mo.CLOSED}),this.workerConnection.on(Se.FAILED,()=>{this.connectionState=Mo.CLOSED}),this.workerConnection.on(Se.RECONNECTING,()=>{this.connectionState=this.connectionState===Mo.CONNECTED?Mo.RECONNECTING:Mo.CONNECTING}),this.workerConnection.on(Se.WILL_RECONNECT,(e,i,o)=>{e==="recover"&&o(e),o("tryNext")}),this.workerConnection.on(Se.REQUEST_NEW_URLS,(e,i)=>{this.workerManagerConnection.close(),this.once(ur.REQUEST_NEW_WORKER_URL,o=>{e([o])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(o=>{this.connectWorkerManager(o,!0)}).catch(o=>{i(o)})})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=ko(this,ur.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(ur.INSPECT_RESULT,void 0,new st(j.INVALID_OPERATION,"Only the track being played can be inspected"));const o=await this.generateRequestData(e,i);this.workerConnection.sendMessage(o,!0,!0)}else this.emit(ur.INSPECT_RESULT,void 0,new st(j.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,i){let{appId:o,cname:c,cid:u,vid:h,sid:_,uid:m}=i;const g=Date.now(),S=await e.getCurrentFrameImage("image/jpeg",this.quality),C=await Mk(S,o,c),I=this.sequence+"-"+u+"-"+m+"-"+g+"-"+Hn(12,""),b={appId:o,cid:u,cname:c,deviceId:"",elapse:ti.intToLong(Number(g-this.inspectStartTime)),fileSize:C.byteLength,jpgEncryption:2,height:S.height,width:S.width,jpg:C,networkType:6,osType:7,requestId:I,sdkVersion:"4.20.2",sequence:this.sequence,sid:_,timestamp:ti.intToLong(g),uid:m,vid:h,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete b.callbackData,this.ossFilePrefix===void 0&&delete b.ossFilePrefix;const x=Bp(b);if(x.byteLength<this.workerMessageLengthLimit){if(Q("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const D=function(M){for(var K=1;K<arguments.length;K++){var z=arguments[K]!=null?arguments[K]:{};K%2?pO(Object(z),!0).forEach(function(nt){A(M,nt,z[nt])}):Object.getOwnPropertyDescriptors?Object.defineProperties(M,Object.getOwnPropertyDescriptors(z)):pO(Object(z)).forEach(function(nt){Object.defineProperty(M,nt,Object.getOwnPropertyDescriptor(z,nt))})}return M}({},b);delete D.jpg,O.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(D))}return x}{const D=this.quality*this.qualityRatio;return this.quality=D,await this.generateRequestData(e,{appId:o,cname:c,cid:u,vid:h,sid:_,uid:m})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Ks.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Mo.CLOSED,this.emit(ur.STATE_CHANGE,da.CLOSED)}}function g1(s){let e=function(){const i=T1.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(i,o){let c=i.appId;c!==void 0&&(Bn(o,10),_n(o,c));let u=i.cid;u!==void 0&&(Bn(o,16),Bn(o,u));let h=i.cname;h!==void 0&&(Bn(o,26),_n(o,h));let _=i.deviceId;_!==void 0&&(Bn(o,34),_n(o,_));let m=i.elapse;m!==void 0&&(Bn(o,40),Jo(o,m));let g=i.fileSize;g!==void 0&&(Bn(o,48),Jo(o,yo(g)));let S=i.height;S!==void 0&&(Bn(o,56),Jo(o,yo(S)));let C=i.jpg;C!==void 0&&(Bn(o,66),Bn(o,C.length),EO(o,C));let I=i.networkType;I!==void 0&&(Bn(o,72),Jo(o,yo(I)));let b=i.osType;b!==void 0&&(Bn(o,80),Jo(o,yo(b)));let x=i.requestId;x!==void 0&&(Bn(o,90),_n(o,x));let D=i.sdkVersion;D!==void 0&&(Bn(o,98),_n(o,D));let M=i.sequence;M!==void 0&&(Bn(o,104),Jo(o,yo(M)));let K=i.sid;K!==void 0&&(Bn(o,114),_n(o,K));let z=i.timestamp;z!==void 0&&(Bn(o,120),Jo(o,z));let nt=i.uid;nt!==void 0&&(Bn(o,128),Bn(o,nt));let dt=i.vid;dt!==void 0&&(Bn(o,136),Bn(o,dt));let it=i.width;it!==void 0&&(Bn(o,144),Jo(o,yo(it)));let at=i.service;at!==void 0&&(Bn(o,152),Bn(o,at));let ht=i.callbackData;ht!==void 0&&(Bn(o,162),Bn(o,ht.length),EO(o,ht));let pt=i.ticket;pt!==void 0&&(Bn(o,170),_n(o,pt));let bt=i.vendorConfigs;bt!==void 0&&(Bn(o,178),_n(o,bt))}(s,e),function(i){let o=i.bytes,c=i.limit;return o.length===c?o:o.subarray(0,c)}(e)}function wC(s){return function(i){let o={};t:for(;!Mg(i);){let c=tl(i);switch(c>>>3){case 0:break t;case 1:o.code=tl(i);break;case 2:o.msg=mO(i,tl(i));break;case 3:o.requestId=mO(i,tl(i));break;case 4:o.timestamp=S1(i,!1);break;default:zo(i,7&c)}}return o}({bytes:e=s,offset:0,limit:e.length});var e}function zo(s,e){switch(e){case 0:for(;128&_c(s););break;case 2:$u(s,tl(s));break;case 5:$u(s,4);break;case 1:$u(s,8);break;default:throw new Error("Unimplemented type: "+e)}}function yo(s){return{low:s|=0,high:s>>31,unsigned:s>=0}}let T1=[];function $u(s,e){if(s.offset+e>s.limit)throw new Error("Skip past limit");s.offset+=e}function Mg(s){return s.offset>=s.limit}function Ug(s,e){let i=s.bytes,o=s.offset,c=s.limit,u=o+e;if(u>i.length){let h=new Uint8Array(2*u);h.set(i),s.bytes=h}return s.offset=u,u>c&&(s.limit=u),o}function _O(s,e){let i=s.offset;if(i+e>s.limit)throw new Error("Read past limit");return s.offset+=e,i}function EO(s,e){let i=Ug(s,e.length);s.bytes.set(e,i)}function mO(s,e){let i=_O(s,e),o=String.fromCharCode,c=s.bytes,u="�",h="";for(let _=0;_<e;_++){let m,g,S,C,I=c[_+i];(128&I)==0?h+=o(I):(224&I)==192?_+1>=e?h+=u:(m=c[_+i+1],(192&m)!=128?h+=u:(C=(31&I)<<6|63&m,C<128?h+=u:(h+=o(C),_++))):(240&I)==224?_+2>=e?h+=u:(m=c[_+i+1],g=c[_+i+2],(49344&(m|g<<8))!=32896?h+=u:(C=(15&I)<<12|(63&m)<<6|63&g,C<2048||C>=55296&&C<=57343?h+=u:(h+=o(C),_+=2))):(248&I)==240?_+3>=e?h+=u:(m=c[_+i+1],g=c[_+i+2],S=c[_+i+3],(12632256&(m|g<<8|S<<16))!=8421504?h+=u:(C=(7&I)<<18|(63&m)<<12|(63&g)<<6|63&S,C<65536||C>1114111?h+=u:(C-=65536,h+=o(55296+(C>>10),56320+(1023&C)),_+=3))):h+=u}return h}function _n(s,e){let i=e.length,o=0;for(let h=0;h<i;h++){let _=e.charCodeAt(h);_>=55296&&_<=56319&&h+1<i&&(_=(_<<10)+e.charCodeAt(++h)-56613888),o+=_<128?1:_<2048?2:_<65536?3:4}Bn(s,o);let c=Ug(s,o),u=s.bytes;for(let h=0;h<i;h++){let _=e.charCodeAt(h);_>=55296&&_<=56319&&h+1<i&&(_=(_<<10)+e.charCodeAt(++h)-56613888),_<128?u[c++]=_:(_<2048?u[c++]=_>>6&31|192:(_<65536?u[c++]=_>>12&15|224:(u[c++]=_>>18&7|240,u[c++]=_>>12&63|128),u[c++]=_>>6&63|128),u[c++]=63&_|128)}}function _c(s){return s.bytes[_O(s,1)]}function xg(s,e){let i=Ug(s,1);s.bytes[i]=e}function tl(s){let e,i=0,o=0;do e=_c(s),i<32&&(o|=(127&e)<<i),i+=7;while(128&e);return o}function Bn(s,e){for(e>>>=0;e>=128;)xg(s,127&e|128),e>>>=7;xg(s,e)}function S1(s,e){let i,o=0,c=0,u=0;return i=_c(s),o=127&i,128&i&&(i=_c(s),o|=(127&i)<<7,128&i&&(i=_c(s),o|=(127&i)<<14,128&i&&(i=_c(s),o|=(127&i)<<21,128&i&&(i=_c(s),c=127&i,128&i&&(i=_c(s),c|=(127&i)<<7,128&i&&(i=_c(s),c|=(127&i)<<14,128&i&&(i=_c(s),c|=(127&i)<<21,128&i&&(i=_c(s),u=127&i,128&i&&(i=_c(s),u|=(127&i)<<7))))))))),{low:o|c<<28,high:c>>>4|u<<24,unsigned:e}}function Jo(s,e){let i=e.low>>>0,o=(e.low>>>28|e.high<<4)>>>0,c=e.high>>>24,u=c===0?o===0?i<16384?i<128?1:2:i<1<<21?3:4:o<16384?o<128?5:6:o<1<<21?7:8:c<128?9:10,h=Ug(s,u),_=s.bytes;switch(u){case 10:_[h+9]=c>>>7&1;case 9:_[h+8]=u!==9?128|c:127&c;case 8:_[h+7]=u!==8?o>>>21|128:o>>>21&127;case 7:_[h+6]=u!==7?o>>>14|128:o>>>14&127;case 6:_[h+5]=u!==6?o>>>7|128:o>>>7&127;case 5:_[h+4]=u!==5?128|o:127&o;case 4:_[h+3]=u!==4?i>>>21|128:i>>>21&127;case 3:_[h+2]=u!==3?i>>>14|128:i>>>14&127;case 2:_[h+1]=u!==2?i>>>7|128:i>>>7&127;case 1:_[h]=u!==1?128|i:127&i}}const OE={},fO={},OC=4294967296,R1=OC*OC,el=R1/2;gO(0,!0);const NE=gO(0),DE=PE(0,-2147483648,!1),NC=PE(-1,2147483647,!1);function gO(s,e){let i,o,c;return e?(c=0<=(s>>>=0)&&s<256)&&(o=fO[s],o)?o:(i=PE(s,0,!0),c&&(fO[s]=i),i):(c=-128<=(s|=0)&&s<128)&&(o=OE[s],o)?o:(i=PE(s,s<0?-1:0,!1),c&&(OE[s]=i),i)}function PE(s,e,i){return{low:0|s,high:0|e,unsigned:!!i}}function C1(s,e){if(isNaN(s))return NE;{if(s<=-9223372036854776e3)return DE;if(s+1>=el)return NC}return s<0?NE:PE(s%OC|0,s/OC|0,e)}function v1(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}class DC extends oi{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const i=this._connectionState;this._connectionState=e,this.emit(Uo.CONNECTION_STATE_CHANGE,e,i)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var i;super(),A(this,"name","AgoraRTCImageModeration"),A(this,"_connectionState",Eo.CONNECTING),A(this,"_sequence",0),A(this,"_moderationStartTime",void 0),A(this,"_workerConnection",void 0),A(this,"_workerMessageLengthLimit",void 0),A(this,"_qualityRatio",void 0),A(this,"_connectInfo",void 0),A(this,"_cancelTokenSource",Ks.CancelToken.source()),A(this,"_retryConfig",void 0),A(this,"_moderationInterval",void 0),A(this,"_moderationTimer",null),A(this,"_moderationMode",1),A(this,"_quality",1),A(this,"_qualityTimer",null),A(this,"_ticket",void 0),A(this,"_moderationIntervalMinimum",void 0),A(this,"_uploadFailedNum",0),A(this,"_uploadNum",0),A(this,"_uploadTimer",null),A(this,"_extraInfo",void 0),A(this,"_vendor",""),A(this,"_encoder",new TextEncoder),A(this,"_moderationId",void 0),A(this,"inspectImage",()=>{if(this.connectionState!==Eo.CONNECTED)throw new st(j.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Eo.CONNECTED?this.requestToInspectImage():O.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Hn(5,"image-moderation-"),this._workerMessageLengthLimit=Q("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=Q("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(i=e.interval)!==null&&i!==void 0?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=Q("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new vr("worker-"+this._moderationId,nr),this.on(Uo.STATE_CHANGE,(o,c)=>{O.debug("[".concat(this._moderationId,"] Moderation operation :").concat(xo[o]," ").concat(c||""))}),this.handleWorkerEvents()}async init(e,i){this.emit(Uo.STATE_CHANGE,xo.CONNECT_AP),this._connectInfo=e;const o=this._cancelTokenSource.token;return this._retryConfig=i,new ut((c,u)=>{this.on(Uo.CONNECTION_STATE_CHANGE,(h,_)=>{h===Eo.CONNECTED&&c()}),this.requestAP(e,o,i).then(h=>{this.connectWorker(h)}).catch(h=>{u(h)})})}updateConfig(e){var i;this._moderationInterval=(i=e.interval)!==null&&i!==void 0?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),O.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===Eo.CONNECTED&&this.inspectImage()}async requestAP(e,i,o){const c=Q("WEBCS_DOMAIN").map(m=>"https://".concat(m,"/api/v1")),u=await function(m,g,S,C){let{appId:I,areaCode:b,cname:x,sid:D,token:M,uid:K}=g;bc++;const z="moderation_plugin",nt={service_name:z,json_body:JSON.stringify({appId:I,areaCode:b,cname:x,command:"allocateEdge",requestId:bc,seq:bc,sid:D,appToken:M,ts:Date.now(),uid:K+""})};let dt,it,at=m[0];return ed(async()=>{dt=Date.now();const ht=await Jd(at,{data:nt,cancelToken:S,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(it=Date.now()-dt,ht.code!==0){const kt=new st(j.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+ht.code,{retry:!0,responseTime:it});throw O.error(kt.toString()),kt}const pt=JSON.parse(ht.json_body);if(pt.code!==200){const kt=new st(j.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(pt.code,", reason: ").concat(pt.reason),{code:pt.code,responseTime:it});throw O.error(kt.toString()),kt}if(!pt.servers||!Array.isArray(pt.servers)||pt.servers.length===0){const kt=new st(j.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:pt.code,responseTime:it});throw O.error(kt.toString()),kt}if(!pt.servers.some(kt=>!!kt.wss)){const kt=new st(j.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:pt.code,responseTime:it});throw O.error(kt.toString()),kt}const bt=Q("IMAGE_MODERATION_WORKER_HOST");return{addressList:pt.servers.map(kt=>{let{address:Ne,wss:Ge}=kt;if(Ne&&Ge)return"wss://".concat(Ne.replace(/\./g,"-"),".").concat(bt,":").concat(Ge,"/moderation")}).filter(kt=>!!kt),workerToken:pt.workerToken,vid:pt.vid,ticket:pt.appTicket,responseTime:it}},(ht,pt)=>(ne.apworkerEvent(D,{success:!0,sc:200,serviceName:z,responseDetail:JSON.stringify(ht.addressList),firstSuccess:pt===0,responseTime:it,serverIp:m[pt%m.length]}),!1),(ht,pt)=>(ne.apworkerEvent(D,{success:!1,sc:ht.data&&ht.data.code||200,serviceName:z,responseTime:it,serverIp:m[pt%m.length]}),!!(ht.code!==j.OPERATION_ABORTED&&ht.code!==j.UNEXPECTED_RESPONSE||ht.data&&ht.data.retry)&&(at=m[(pt+1)%m.length],!0)),C)}(c,e,i,o);this.emit(Uo.STATE_CHANGE,xo.AP_CONNECTED);const{addressList:h,ticket:_}=u;return this._ticket=_,h}async connectWorker(e){this.emit(Uo.STATE_CHANGE,xo.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Se.CONNECTED,async()=>{this.emit(Uo.STATE_CHANGE,xo.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Eo.CONNECTED}),this._workerConnection.on(Se.CLOSED,()=>{this.connectionState=Eo.CLOSED}),this._workerConnection.on(Se.FAILED,()=>{this.connectionState=Eo.CLOSED}),this._workerConnection.on(Se.RECONNECTING,()=>{this.connectionState=this.connectionState===Eo.CONNECTED?Eo.RECONNECTING:Eo.CONNECTING}),this._workerConnection.on(Se.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const i=wC(new Uint8Array(e.data));Q("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&O.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,i.code===void 0||i.code===0||(this._uploadFailedNum++,O.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{ne.reportApiInvoke(this._connectInfo.sid||null,{name:tr.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:gi.TRACER}).onError(new st(j.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null},Q("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else O.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Se.WILL_RECONNECT,(e,i,o)=>{e==="recover"&&o(e),o("tryNext")}),this._workerConnection.on(Se.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=ko(this,Uo.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(Q("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&O.debug("Only the track being played can be inspected"));this._sequence++;const o=await this.generateRequestData(e,i);this._workerConnection.sendMessage(o,!0,!0)}else Q("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&O.debug("Only the track being published can be inspected")}async generateRequestData(e,i){let{appId:o,cname:c,cid:u,vid:h,sid:_,uid:m}=i;const g=Date.now(),S=await e.getCurrentFrameImage("image/jpeg",this.quality),C=await Mk(S,o,c),I=this._sequence+"-"+u+"-"+m+"-"+g+"-"+Hn(12,""),b={appId:o,cid:u,cname:c,deviceId:"",elapse:DC.intToLong(Number(g-this._moderationStartTime)),fileSize:S.buffer.byteLength,height:S.height,width:S.width,jpg:C,networkType:6,osType:7,requestId:I,sdkVersion:"4.20.2",sequence:this._sequence,sid:_,timestamp:C1(g),uid:m,vid:h,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete b.callbackData;const x=g1(b);if(x.byteLength<this._workerMessageLengthLimit){if(Q("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const D=function(M){for(var K=1;K<arguments.length;K++){var z=arguments[K]!=null?arguments[K]:{};K%2?v1(Object(z),!0).forEach(function(nt){A(M,nt,z[nt])}):Object.getOwnPropertyDescriptors?Object.defineProperties(M,Object.getOwnPropertyDescriptors(z)):v1(Object(z)).forEach(function(nt){Object.defineProperty(M,nt,Object.getOwnPropertyDescriptor(z,nt))})}return M}({},b);delete D.jpg,O.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(D))}return x}{const D=this.quality*this._qualityRatio;return this.quality=D,await this.generateRequestData(e,{appId:o,cname:c,cid:u,vid:h,sid:_,uid:m})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Ks.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Eo.CLOSED,this.emit(Uo.STATE_CHANGE,xo.CLOSED)}}function PC(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function I1(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?PC(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):PC(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}const LC=Date.now(),kC=20,qe=new Map,Vg=new Map;async function wd(s){const e=qe.get(s),i=Array.isArray(e)&&e[e.length-1],o=Vg.get(s);if(!i)return void(o.isSyncing=!1);const c={uid:i.uid,payload:i.payload};o.firstRecvTs===0&&(o.firstRecvTs=i.recvTs,o.firstSendTs=i.sendTs);const u=i.sendTs-o.firstSendTs,h=u-(Date.now()-o.firstRecvTs);h>0&&(o.firstRecvTs=Date.now()-u);let _=i.mediaDelay+h;_<=0?(e.pop(),jc(i.context,c),_=0):_=Math.min(_,kC),setTimeout(()=>e.length&&wd(s),_)}function jc(s,e){s.safeEmit(We.STREAM_MESSAGE,e.uid,e.payload),s.onStreamMessage&&s.onStreamMessage(e)}function ao(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!s.syncWithAudio)return jc(i,{uid:s.uid,payload:s.payload});const o="".concat(i.id,"-").concat(s.uid),c=qe.get(o)||[],u=c.findIndex(g=>s.sendTs>=g.sendTs),h=I1(I1({},s),{},{context:i,mediaDelay:e,recvTs:Date.now()});u===-1?c.push(h):c.splice(u,0,h),qe.set(o,c);let _=!1;var m;Vg.has(o)?_=!((m=Vg.get(o))===null||m===void 0||!m.isSyncing):Vg.set(o,{isSyncing:_,firstRecvTs:0,firstSendTs:0}),_||wd(o)}const je=ln().name;function y1(){return!function(s,e,i){const o=ln();if(o.os!==gr.IOS||!o.osVersion)return!1;const c=o.osVersion.split(".");return Number(c[0])<s}(16)&&!function(s,e,i){const o=ln();if(o.name!==un.SAFARI||!o.osVersion)return!1;const c=o.version.split(".");return i?e&&Number(c[0])===s&&Number(c[1])<e||Number(c[0])<s:e?Number(c[0])===s&&Number(c[1])<=e||Number(c[0])<s:Number(c[0])<=s}(16,0,!0)}function Od(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function Gc(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Od(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Od(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}Sr.setLogger(O);class Tn extends oi{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let i;if(super(),A(this,"store",void 0),A(this,"_uid",void 0),A(this,"_channelName",void 0),A(this,"_uintUid",void 0),A(this,"_users",[]),A(this,"_config",void 0),A(this,"_clientId",void 0),A(this,"_appId",void 0),A(this,"_sessionId",null),A(this,"_key",void 0),A(this,"_rtmConfig",{}),A(this,"_joinInfo",void 0),A(this,"_gateway",void 0),A(this,"_statsCollector",void 0),A(this,"_configDistribute",void 0),A(this,"_leaveMutex",new Sr("client-leave")),A(this,"_publishMutex",new Sr("client-publish")),A(this,"_renewTokenMutex",new Sr("client-renewtoken")),A(this,"_subscribeMutex",new Sr("client-subscribe")),A(this,"_encryptionMode","none"),A(this,"_encryptionSecret",null),A(this,"_encryptionSalt",null),A(this,"_encryptDataStream",!1),A(this,"_encryptDataStreamKey",null),A(this,"_encryptDataStreamIv",null),A(this,"_proxyServer",void 0),A(this,"_turnServer",{servers:[],mode:"auto"}),A(this,"_cloudProxyServerMode","disabled"),A(this,"_isDualStreamEnabled",!1),A(this,"_defaultStreamFallbackType",void 0),A(this,"_lowStreamParameter",void 0),A(this,"_streamFallbackTypeCacheMap",new Map),A(this,"_remoteStreamTypeCacheMap",new Map),A(this,"_axiosCancelSource",Ks.CancelToken.source()),A(this,"_audioVolumeIndicationInterval",void 0),A(this,"_networkQualityInterval",void 0),A(this,"_userOfflineTimeout",void 0),A(this,"_streamRemovedTimeout",void 0),A(this,"_injectStreamingClient",void 0),A(this,"_liveTranscodeStreamingClient",void 0),A(this,"_liveRawStreamingClient",void 0),A(this,"_channelMediaRelayClient",void 0),A(this,"_networkQualitySensitivity","normal"),A(this,"_p2pChannel",void 0),A(this,"_useLocalAccessPoint",!1),A(this,"_setLocalAPVersion",void 0),A(this,"_joinAndNotLeaveYet",!1),A(this,"_numberOfJoinCount",0),A(this,"_remoteDefaultVideoStreamType",void 0),A(this,"_inspect",void 0),A(this,"_moderation",void 0),A(this,"_license",void 0),A(this,"_pendingPublishedUsers",[]),A(this,"ntpAlignErrorCount",0),A(this,"remoteInboundOffset",0),A(this,"_handleLocalTrackEnable",(o,c,u)=>{this.publish(o,!1).then(c).catch(u)}),A(this,"_handleLocalTrackDisable",(o,c,u)=>{this.unpublish(o).then(c).catch(u)}),A(this,"_handleUserOnline",o=>{if(Q("BLOCK_LOCAL_CLIENT")&&sp(o.uid,this.channelName))return void O.debug("[".concat(o.uid,"] will be ignored in local"));this.isStringUID&&typeof o.uid!="string"&&O.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const c=this._users.find(u=>u.uid===o.uid);if(c)c._trust_in_room_=!0,c._is_pre_created&&(c._is_pre_created=!1,this.safeEmit(We.USER_JOINED,c));else{const u=new Zr(o.uid,o.uint_id||o.uid);this._users.push(u),O.debug("[".concat(this._clientId,"] user online"),o.uid),this.safeEmit(We.USER_JOINED,u)}}),A(this,"_handleUserOffline",o=>{if(Q("BLOCK_LOCAL_CLIENT")&&sp(o.uid,this.channelName))return;const c=this._users.find(u=>u.uid===o.uid);c&&(this._handleRemoveStream(o),this._handleRemoveDataChannels(o),c._audio_pre_subscribed||c._video_pre_subscribed?c._is_pre_created=!0:qh(this._users,c),this._remoteStreamTypeCacheMap.delete(c.uid),this._streamFallbackTypeCacheMap.delete(c.uid),O.debug("[".concat(this._clientId,"] user offline"),o.uid,"reason:",o.reason),this.safeEmit(We.USER_LEAVED,c,o.reason))}),A(this,"_handleAddAudioOrVideoStream",(o,c,u,h,_,m,g)=>{if(Q("BLOCK_LOCAL_CLIENT")&&sp(c,this.channelName))return;const S=this._users.find(I=>I.uid===c);if(!S)return void O.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));O.debug("[".concat(this._clientId,"] stream added with uid ").concat(c,", type ").concat(o)),this.store.subscribe(S.uid,o,void 0,void 0,void 0,Date.now());const C=o==="audio"?S.hasAudio:S.hasVideo;S._uintid||(S._uintid=_||c),o==="audio"?S._trust_audio_stream_added_state_=!0:S._trust_video_stream_added_state_=!0,o==="audio"?(S._audio_added_=!0,u!==void 0&&(S._audioSSRC=u),h!==void 0&&(S._cname=h),m&&(S._audioOrtc=m)):(S._video_added_=!0,u!==void 0&&(S._videoSSRC=u),h!==void 0&&(S._cname=h),g!==void 0&&(S._rtxSsrcId=g),m&&(S._videoOrtc=m)),(o==="audio"?S.hasAudio:S.hasVideo)&&!C&&(O.info("[".concat(this._clientId,"] remote user ").concat(S.uid," published ").concat(o)),this.safeEmit(We.USER_PUBLISHED,S,o)),o==="video"?ne.onGatewayStream(this._sessionId,Rr.ON_ADD_VIDEO_STREAM,ei.ON_ADD_VIDEO_STREAM,{peer:_||c,ssrc:S._videoSSRC}):ne.onGatewayStream(this._sessionId,Rr.ON_ADD_AUDIO_STREAM,ei.ON_ADD_AUDIO_STREAM,{peer:_||c,ssrc:S._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(S,o,u).then(I=>{if(I&&(O.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(S.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Ki))return this._p2pChannel.unsubscribe(S,o,!0).then(()=>this._subscribe(S,o,!0).catch(b=>{O.error("[".concat(this._clientId,"] resubscribe error"),b.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(S,o)&&(O.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(S.uid," after reconnect.")),this._subscribe(S,o,!0).catch(I=>{O.error("[".concat(this._clientId,"] resubscribe error"),I.toString())}))}),A(this,"_handleRemoveStream",o=>{if(Q("BLOCK_LOCAL_CLIENT")&&sp(o.uid,this.channelName))return;const c=this._users.find(h=>h.uid===o.uid);if(!c)return void O.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));O.debug("[".concat(this._clientId,"] stream removed with uid ").concat(o.uid));let u=()=>{};c.hasAudio&&c.hasVideo?u=()=>{O.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished audio track")),this.safeEmit(We.USER_UNPUBLISHED,c,"audio"),O.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished video track")),this.safeEmit(We.USER_UNPUBLISHED,c,"video")}:c.hasVideo?u=()=>{O.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished video track")),this.safeEmit(We.USER_UNPUBLISHED,c,"video")}:c.hasAudio&&(u=()=>{O.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished audio track")),this.safeEmit(We.USER_UNPUBLISHED,c,"audio")}),c._video_pre_subscribed||c._audio_pre_subscribed||(c._trust_audio_stream_added_state_=!0,c._trust_video_stream_added_state_=!0,c._audio_added_=!1,c._video_added_=!1,this._p2pChannel instanceof Ki&&this._p2pChannel.unsubscribe(c).then(h=>{if(h)return this._gateway.unsubscribe(h,c.uid)}),c._audioSSRC=void 0,c._videoSSRC=void 0,c._audioOrtc=void 0,c._videoOrtc=void 0,c._rtxSsrcId=void 0),ne.onGatewayStream(this._sessionId,Rr.ON_REMOVE_STREAM,ei.ON_REMOVE_STREAM,{peer:o.uint_id||o.uid}),u()}),A(this,"_handleSetStreamLocalEnable",(o,c,u)=>{if(Q("BLOCK_LOCAL_CLIENT")&&sp(c,this.channelName))return;const h=this._users.find(g=>g.uid===c);if(!h)return void O.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));O.debug("[".concat(this._clientId,"] local ").concat(o," ").concat(u?"enabled":"disabled"," with uid ").concat(c));const _=o==="audio"?h.hasAudio:h.hasVideo;if(o==="audio"){h._trust_audio_enabled_state_=!0;const g=h._audio_enabled_;if(h._audio_enabled_=u,h._audio_enabled_===g)return;{const S=h._audio_enabled_?"enable-local-audio":"disable-local-audio";O.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(c,", msg: ").concat(S)),this.safeEmit(We.USER_INFO_UPDATED,c,S)}}else{h._trust_video_enabled_state_=!0;const g=h._video_enabled_;if(h._video_enabled_=u,h._video_enabled_===g)return;{const S=h._video_enabled_?"enable-local-video":"disable-local-video";O.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(c,", msg: ").concat(S)),this.safeEmit(We.USER_INFO_UPDATED,c,S)}}const m=o==="audio"?h.hasAudio:h.hasVideo;return _!==m?!_&&m?(O.info("[".concat(this._clientId,"] remote user ").concat(c," published ").concat(o)),void this.safeEmit(We.USER_PUBLISHED,h,o)):(o==="video"&&h._videoTrack&&h._videoTrack._destroy(),this._p2pChannel.muteRemote(h,o),O.info("[".concat(this._clientId,"] remote user ").concat(c," unpublished ").concat(o)),void this.safeEmit(We.USER_UNPUBLISHED,h,o)):void 0}),A(this,"_handleMuteStream",(o,c,u)=>{if(Q("BLOCK_LOCAL_CLIENT")&&sp(o,this.channelName))return;O.debug("[".concat(this._clientId,"] receive mute message"),o,c,u);const h=this._users.find(g=>g.uid===o);if(!h)return void O.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o));const _=c==="audio"?h.hasAudio:h.hasVideo;if(c==="audio"){h._trust_audio_mute_state_=!0;const g=h._audio_muted_;if(h._audio_muted_=u,h._audio_muted_===g)return;{const S=h._audio_muted_?"mute-audio":"unmute-audio";O.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(S)),this.safeEmit(We.USER_INFO_UPDATED,o,S)}}else{h._trust_video_mute_state_=!0;const g=h._video_muted_;if(h._video_muted_=u,h._video_muted_===g)return;{const S=h._video_muted_?"mute-video":"unmute-video";O.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(S)),this.safeEmit(We.USER_INFO_UPDATED,o,S)}}const m=c==="audio"?h.hasAudio:h.hasVideo;if(_!==m){if(!_&&m)return(c==="audio"?h._audioSSRC:h._videoSSRC)?(O.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(c)),void this.safeEmit(We.USER_PUBLISHED,h,c)):void O.warning("[".concat(this._clientId,"] remote user ").concat(o," receive ").concat(c," unmute message  before add stream message, ").concat(c," SSRC doesn't exist yet."));c==="video"&&h._videoTrack&&!h._video_pre_subscribed&&h._videoTrack._destroy(),this._p2pChannel.muteRemote(h,c),O.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(c)),this.safeEmit(We.USER_UNPUBLISHED,h,c)}}),A(this,"_handleP2PLost",async o=>{O.debug("[".concat(this._clientId,"] receive p2p lost"),o),parseInt(o.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():O.warning("[".concat(this._clientId,"] P2PLost stream not found"),o)}),A(this,"_handleTokenWillExpire",()=>{O.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(We.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),A(this,"_handleBeforeUnload",o=>{o.type==="beforeunload"&&o.returnValue!==void 0&&o.returnValue!==""||(this.leave(),O.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),A(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(We.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const o={downlinkNetworkQuality:0,uplinkNetworkQuality:0};o.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),o.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(We.NETWORK_QUALITY,o)}),A(this,"_handleP2PAddAudioOrVideoStream",(o,c,u,h)=>{const _=this._users.find(g=>g.uid===c);if(!_)return void O.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));O.debug("[".concat(this._clientId,"] stream added with uid ").concat(c,", type ").concat(o)),this.store.subscribe(_.uid,o,void 0,void 0,void 0,Date.now());const m=o==="audio"?_.hasAudio:_.hasVideo;o==="audio"?_._trust_audio_stream_added_state_=!0:_._trust_video_stream_added_state_=!0,o==="audio"?(_._audio_added_=!0,u!==void 0&&(_._audioSSRC=u),h!==void 0&&(_._audioMid=h)):(_._video_added_=!0,u!==void 0&&(_._videoSSRC=u),h!==void 0&&(_._videoMid=h)),(o==="audio"?_.hasAudio:_.hasVideo)&&!m&&(O.info("[".concat(this._clientId,"] remote user ").concat(_.uid," published ").concat(o)),this.safeEmit(We.USER_PUBLISHED,_,o)),this._p2pChannel.hasPendingRemoteMedia(_,o)&&(O.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(_.uid," after reconnect.")),this._subscribe(_,o,!0).catch(g=>{O.error("[".concat(this._clientId,"] resubscribe error"),g.toString())}))}),this._config=e,this._clientId=Hn(5,"client-"),this.store=new aj(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),O.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Ga," build: ").concat(oR,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{oL(e.clientRoleOptions),i=Object.assign({},e.clientRoleOptions)}catch(o){O.warning("[".concat(this._clientId,"] ").concat(o.toString()))}this._statsCollector=new Pr(this.store),this._statsCollector.onStatsException=(o,c,u)=>{O.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(o,", msg: ").concat(c,", uid: ").concat(u)),this.safeEmit(We.EXCEPTION,{code:o,msg:c,uid:u})},this._statsCollector.onUploadPublishDuration=(o,c,u,h)=>{const _=this._users.find(m=>m.uid===o);_&&ne.peerPublishStatus(this._sessionId,{subscribeElapse:h,audioPublishDuration:c,videoPublishDuration:u,peer:_._uintid})},this.store.useDataChannel=sn().supportDataChannel&&Q("SIGNAL_CHANNEL"),this.store.useP2P=e.mode==="p2p",this._gateway=new pk(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||nr,httpRetryConfig:e.httpRetryConfig||nr,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:i}),this._configDistribute=new _k,this.store.useP2P?(this._p2pChannel=new _r(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Ki(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,i,o,c,u){let h=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],_=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Mn("JOIN_GATEWAY_USE_443PORT_ONLY",h),Mn("JOIN_GATEWAY_USE_DUAL_DOMAIN",_);const m=this._gateway.signal.websocket;return m instanceof Ac&&(m.use443PortOnly=h,m.tryDoubleDomain=_),async function(g,S,C){I_.get(g)||I_.set(g,[]),Hh.get(g)||Hh.set(g,S),Tc.get(g)||Tc.set(g,0);const I=I_.get(g),b=Hh.get(g);if(!I||!b)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Tc.get(g)===b){const z=zm();I.push(z),await z.promise}Tc.set(g,Tc.get(g)+1);for(var x=arguments.length,D=new Array(x>3?x-3:0),M=3;M<x;M++)D[M-3]=arguments[M];const K=await C(...D);return Tc.set(g,Tc.get(g)-1),Tc.get(g)===b-1&&I.length>0&&(I[0].resolve(),I.shift()),Tc.get(g)===0&&(I_.set(g,[]),Hh.set(g,0),Tc.set(g,0)),K}("client.join",Q("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,i,o,c,u)}async join(e,i,o,c,u){const h=++this._numberOfJoinCount;this.store.joinStart(),c&&(this.store.uid=c);const _=oj(),m=jL()?window.isSecureContext:"Browser Not Support";(!jL()&&!_||!window.isSecureContext)&&O.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");const g=OA();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),O.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const S=ne.reportApiInvoke(g,{name:tr.JOIN,options:[e,i,o,c],states:{isHttps:_,isSecureContext:m},tag:gi.TRACER});ne.setAppId(e);try{if(!o&&o!==null)throw new st(j.INVALID_PARAMS,"Invalid token: ".concat(o,". If you don not use token, set it to null"));o&&fs(o,"token",1,2047),fs(e,"appid",1,2047),tb(i),c&&eb(c),u&&fs(u,"optionalInfo",1,2047)}catch(D){throw S.onError(D),D}if(O.info("[".concat(this._clientId,"] start join channel ").concat(i,", join number: ").concat(h)),this._leaveMutex.isLocked&&(O.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),O.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const D=new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw S.onError(D),D}this._sessionId||(this._sessionId=g,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const C=Gc(Gc({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:i,uid:typeof c!="string"?c:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:o||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:u,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(C.setLocalAPVersion=this._setLocalAPVersion),typeof c=="string"&&(C.stringUid=c,this._uintUid?(C.uid=this._uintUid,this._uintUid=void 0):C.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(C.aesmode=this._encryptionMode,C.aespassword=await nL(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(C.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const D=new TextEncoder,M=Q("USE_PURE_ENCRYPTION_MASTER_KEY")?D.encode(C.appId+this._encryptionSecret+this._encryptionSecret):D.encode(C.appId+C.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(K,z,nt){const dt=await window.crypto.subtle.importKey("raw",z,"PBKDF2",!1,["deriveBits","deriveKey"]),it=K==="aes-128-gcm2"?128:256,at=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:cf,hash:"SHA-256",salt:nt},dt,it+cj);return new Uint8Array(at).subarray(it/8)}(this._encryptionMode,M,D_(this._encryptionSalt)),this._encryptDataStreamKey=await async function(K,z,nt){const dt=await window.crypto.subtle.importKey("raw",z,"PBKDF2",!1,["deriveBits","deriveKey"]),it=K==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:cf,hash:"SHA-256",salt:nt},dt,{name:"AES-GCM",length:it},!0,["encrypt","decrypt"])}(this._encryptionMode,M,D_(this._encryptionSalt))}else m?O.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):O.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,O.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:i,appId:e,stringUid:C.stringUid});const I=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&I===this._sessionId&&ne.joinChannelTimeout(this._sessionId,5)},5e3);try{var b;let D;const M=C.cloudProxyServer;if(Jt(b=["proxy3","proxy4","proxy5"]).call(b,M)){const it=Q("PROXY_SERVER_TYPE3");Array.isArray(it)?C.proxyServer=it[0]:C.proxyServer=it}if(ne.setProxyServer(C.proxyServer),O.setProxyServer(C.proxyServer),this.store.requestAPStart(),C.stringUid&&!C.uid){let it;[it,D]=await ut.all([mb(C.stringUid,C,this._axiosCancelSource.token,this._config.httpRetryConfig||nr,this.store),ad(C,this._axiosCancelSource.token,this._config.httpRetryConfig||nr,!0,this.store)]),O.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(C.stringUid," => ").concat(it)),C.uid=it,D.gatewayInfo.uid=it,D.gatewayInfo.res.uid=it}else D=await ad(C,this._axiosCancelSource.token,this._config.httpRetryConfig||nr,!0,this.store);if(!this._joinAndNotLeaveYet)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(C,this._axiosCancelSource.token),this._configDistribute.on(j_.UPDATE_BITRATE_LIMIT,it=>{this._p2pChannel.updateBitrateLimit(it)})},0),this._key=o||e;const K=D.gatewayInfo,z=C.uid?C.uid:K.uid;this._joinInfo=Gc(Gc({},C),{},{cid:K.cid,uid:z,vid:K.vid,apResponse:K.res,uni_lbs_ip:K.uni_lbs_ip,gatewayAddrs:K.gatewayAddrs}),this.store.intUid=z;const nt=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));S.onSuccess(nt),this._appId=e,this._channelName=C.cname,this._uid=nt,this.store.uid=nt,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Or()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);const dt=C.stringUid?"string uid: ".concat(C.stringUid,",uid: ").concat(C.uid):"uid: ".concat(this._uid);return O.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(i,",").concat(dt)),setTimeout(()=>{O.startUpload()},5e3),this.store.joinEnd(),x=this,Jt(Cl).call(Cl,x)||Cl.push(x),nt}catch(D){const M=Array.isArray(D)?D[0]:D;throw M&&M.code===j.OPERATION_ABORTED?O.warning("[".concat(this._clientId,"] join number: ").concat(h,", Joining channel failed, rollback"),M):O.error("[".concat(this._clientId,"] join number: ").concat(h,", Joining channel failed, rollback"),M),M.code!==j.OPERATION_ABORTED&&this._numberOfJoinCount===h&&(this._gateway.state="DISCONNECTED",this._reset()),S.onError(M),M}var x}_joinGateway(){if(!this._joinInfo||!this._key)throw new st(j.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!Q("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(e=>e).catch(e=>{if(e.code===j.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,Fe.FALLBACK),e;if(e.code===j.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,Fe.FALLBACK),e;throw e}).then(e=>{if(e instanceof st){if(e.code===j.INIT_WEBSOCKET_TIMEOUT){if(O.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new st(j.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const i=Q("PROXY_SERVER_TYPE3");if(Array.isArray(i))if(this._joinInfo.apUrl){const c=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),u=c.slice(c.length-2).join(".");i.forEach(h=>{this._joinInfo&&Jt(h).call(h,u)&&(this._joinInfo.proxyServer=h)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=i[0])}else this._joinInfo.proxyServer=i[0];else this._joinInfo.proxyServer=i;const o=Q("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return o&&o[1]&&o[1]!=="443"&&O.setProxyServer(this._joinInfo.proxyServer),Q("STATS_COLLECTOR_PORT").toString()!=="443"&&ne.setProxyServer(this._joinInfo.proxyServer),ne.reportApiInvoke(this._sessionId,{name:tr.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:gi.TRACER}).onSuccess(),this.safeEmit(We.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),Q("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(c=>{"forceturn"in c&&(c.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(O.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new st(j.INVALID_OPERATION);return ne.reportApiInvoke(this._sessionId,{name:tr.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:gi.TRACER}).onSuccess(),this._joinGateway()}return e}).then(e=>e)}async leave(){O.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Or()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(i){const o=Cl.indexOf(i);o!==-1&&Cl.splice(o,1)}(this);const e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return O.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED"),O.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof os))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new st(j.INVALID_PARAMS,"param list is empty");const o=e;if(this._gateway.role==="audience")throw new st(j.INVALID_OPERATION,"audience can not publish stream");for(const u of o){if(!(u instanceof os))throw new st(j.INVALID_PARAMS,"parameter is not local track");if(!u._enabled&&i)throw new st(j.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(u.getTrackId()))}O.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(o.map(u=>"".concat(u.getTrackId()," "))));const c=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&o.forEach(u=>{const h=this._configDistribute.getBitrateLimit();u instanceof ke&&h&&u.setBitrateLimit(h.uplink)});try{await this._publishHighStream(o),O.info("[".concat(this._clientId,"] Publish success, id ").concat(o.map(u=>"".concat(u.getTrackId()," "))))}catch(u){throw O.error("[".concat(this._clientId,"] publish error"),u.toString()),u}finally{c()}}async _publishDataChannel(e){hn(e.id,"id",0,65535,!0),td(e.ordered,"ordered"),fs(e.metadata,"metadata",0,512),O.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const i=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(c=>c.id===e.id)!==-1)throw new st(j.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new st(j.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&Q("FORCE_TURN")&&!Q("TURN_ENABLE_TCP")&&!Q("TURN_ENABLE_UDP"))throw new st(j.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const o=new oM(e);if(await this._p2pChannel.publishDataChannel([o]),!this._p2pChannel.isP2PDisconnected()){if(typeof o._originDataChannelId!="number")throw O.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new st(j.CREATE_DATACHANNEL_ERROR);try{const c={streamId:e.id,ordered:e.ordered,maxRetransmits:Q("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:o._originDataChannelId};await this._gateway.publishDataChannel(this._uid,c,!0),await o._waitTillOpen()}catch(c){if(c.code!==j.DISCONNECT_P2P)throw c}}return O.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(o.id)),o}catch(o){throw O.error("[".concat(this._clientId,"] publish datachannels error"),o.toString()),o}finally{i()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new st(j.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(e)if(Array.isArray(e))i=e;else{if(!(e instanceof os))return this._unpublishDataChannel([e]);i=[e]}else this.store.useP2P||await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);O.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map(c=>"".concat(c.getTrackId()," "))," "));const o=await this._publishMutex.lock();try{if(this._p2pChannel instanceof _r){const c=await this._p2pChannel.unpublish(i);c&&await this._gateway.sendExtensionMessage(li.UNPUBLISH,{unpubMsg:c},!0)}else{const c=await this._p2pChannel.unpublish(i);c&&await this._gateway.unpublish(c,this._uid),O.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map(u=>"".concat(u.getTrackId()))))}}catch(c){throw O.error("[".concat(this._clientId,"] unpublish error"),c.toString()),c}finally{o&&o()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),O.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(o=>"".concat(o.id," "))," "));const i=await this._publishMutex.lock();try{const o=await this._p2pChannel.unpublishDataChannel(e);o&&await this._gateway.unpublishDataChannel(o),O.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(c=>"".concat(c.id))))}catch(o){throw O.error("[".concat(this._clientId,"] unpublish dataChannel error"),o.toString()),o}finally{i&&i()}}async subscribe(e,i,o){return i==="datachannel"?this._subscribeDataChannel(e,o):this._subscribe(e,i)}async presubscribe(e,i){if(cr(i,"mediaType",["audio","video"]),this._p2pChannel instanceof _r)throw new st(j.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new st(j.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const o=i===Xt.AUDIO,c=i===Xt.VIDEO,u=await this._subscribeMutex.lock();try{const{ssrcId:h,ortc:_,rtxSsrcId:m,cname:g,uint_id:S}=await this._gateway.presubscribe(e,i,!0);if(h==null)throw new st(j.UNEXPECTED_RESPONSE,"no ssrc id");let C=this._users.find(b=>b.uid===e);C||(C=new Zr(e,S||e),C._is_pre_created=!0,this._users.push(C)),g&&(C._cname=g),C._uintid||(C._uintid=S||e),o&&(C._audioSSRC=h,C._audio_pre_subscribed=!0,_&&(C._audioOrtc=_)),c&&(C._videoSSRC=h,C._video_pre_subscribed=!0,_&&(C._videoOrtc=_),m!=null&&(C._rtxSsrcId=m)),O.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(h)),await this._p2pChannel.subscribe(C,i,h,m,_);const I=o?C._audioTrack:C._videoTrack;if(!I)throw new st(j.UNEXPECTED_ERROR,"can not find remote track in user");return o&&(C._trust_audio_stream_added_state_=!0,C._audio_added_=!0),c&&(C._trust_video_stream_added_state_=!0,C._video_added_=!0),I}catch(h){throw O.error("[".concat(this._clientId,"] presub user ").concat(e," error"),h),h}finally{u()}}async _subscribeDataChannel(e,i){var o;if(hn(i,"channelId",0,65535,!0),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(_=>_===e))throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new st(j.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new st(j.INVALID_REMOTE_USER,"user is not published");const c=(o=e._dataChannels)===null||o===void 0?void 0:o.find(_=>_.id===i);if(!c)throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new st(j.REMOTE_USER_IS_NOT_PUBLISHED);const u=await this._subscribeMutex.lock();O.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const _=await this._p2pChannel.subscribeDataChannel(e,[c]);if(_&&Jt(_).call(_,c.id))try{var h;if(typeof c._originDataChannelId!="number")throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new st(j.CREATE_DATACHANNEL_ERROR);const m={id:c.id,datachannelId:c._originDataChannelId,ordered:c.ordered,maxRetransmits:c.maxRetransmits,metadata:(h=c.metadata)!==null&&h!==void 0?h:""};await this._gateway.subscribeDataChannel(e.uid,m,!0),await c._waitTillOpen()}catch(m){if((m==null?void 0:m.code)!==j.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[c]),m;await this._p2pChannel.unsubscribeDataChannel(e,[c]),this._p2pChannel.setPendingRemoteDataChannel(e,c.id)}return O.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),c}finally{u()}}async _p2pSubscribe(e,i,o){if(cr(i,"mediaType",["audio","video"]),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(u=>u===e)){const u=new st(j.INVALID_REMOTE_USER,"user is not in the channel");throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),u}if(!e.hasAudio&&!e.hasVideo){const u=new st(j.INVALID_REMOTE_USER,"user is not published");throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),u}if(!o&&(i==="audio"&&!e.hasAudio||i==="video"&&!e.hasVideo)){const u=new st(j.REMOTE_USER_IS_NOT_PUBLISHED);throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),u}const c=await this._subscribeMutex.lock();O.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const h=i==="audio"?e._audioSSRC:e._videoSSRC,_=i==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,i,Date.now()),this._p2pChannel instanceof _r&&await this._p2pChannel.subscribe(e,i,h,_)}catch(h){throw h}O.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(h=>{O.warning("[".concat(this._clientId,"] auto set fallback failed"),h)});const u=i==="audio"?e._audioTrack:e._videoTrack;if(!u)throw new st(j.UNEXPECTED_ERROR,"can not find remote track in user object");return u}catch(u){throw O.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),u),u}finally{c()}}async _subscribe(e,i,o){if(this._p2pChannel instanceof _r)return this._p2pSubscribe(e,i);if(cr(i,"mediaType",["audio","video"]),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(g=>g===e)){const g=new st(j.INVALID_REMOTE_USER,"user is not in the channel");throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),g}if(!e.hasAudio&&!e.hasVideo){const g=new st(j.INVALID_REMOTE_USER,"user is not published");throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),g}if(!(o||(i!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(i!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const g=new st(j.REMOTE_USER_IS_NOT_PUBLISHED);throw O.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),g}let c=i==="audio"?e._audioSSRC:e._videoSSRC,u=i==="audio"?e._audioOrtc:e._videoOrtc,h=i==="video"?e._rtxSsrcId:void 0,_={stream_type:i==="audio"?Xt.AUDIO:Xt.VIDEO,ssrcId:c};const m=await this._subscribeMutex.lock();O.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const S=i==="audio"?e._audioSSRC:e._videoSSRC;S!==void 0&&S!==c&&(c=S,u=i==="audio"?e._audioOrtc:e._videoOrtc,h=i==="video"?e._rtxSsrcId:void 0,_={stream_type:i==="audio"?Xt.AUDIO:Xt.VIDEO,ssrcId:c}),cs.markSubscribeStart(this.store.clientId,c),this.store.subscribe(e.uid,i,Date.now()),await this._p2pChannel.subscribe(e,i,c,h,u);try{await this._gateway.subscribe(e.uid,_,!0)}catch(C){if((C==null?void 0:C.code)!==j.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,i),C;await this._p2pChannel.unsubscribe(e,i,!0),this._p2pChannel.setPendingRemoteMedia(e,i)}this.store.subscribe(e.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,i)}catch(S){throw this._p2pChannel.reportSubscribeEvent(!1,S==null?void 0:S.code,e,i),S}O.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(S=>{O.warning("[".concat(this._clientId,"] auto set fallback failed"),S)});const g=i==="audio"?e._audioTrack:e._videoTrack;if(!g)throw new st(j.UNEXPECTED_ERROR,"can not find remote track in user object");return g}catch(g){throw O.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),g),g}finally{m()}}async massSubscribe(e){if(jd(e,"subscribeList"),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const i=Date.now(),o=new Map,c=await this._subscribeMutex.lock();O.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(m=>{let{user:g,mediaType:S}=m;return"user: ".concat(g==null?void 0:g.uid,", mediaType: ").concat(S)}).join("; ")));const u=(e=[...e]).map(m=>{let{user:g,mediaType:S}=m;return{user:g,mediaType:S}}),h=await this._p2pChannel.globalLock();try{var _;for(let g=e.length-1;g>=0;g--){const S=e[g],{user:C,mediaType:I}=S;if(cr(I,"mediaType",["audio","video"]),!C){const D=new st(j.INVALID_PARAMS,"user property does not exist in subscribeList item");throw O.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),D}if(!this._users.find(D=>D===C)){const D=new st(j.INVALID_REMOTE_USER,"user is not in the channel");O.error("[".concat(this._clientId,"] can not massSubscribe ").concat(C.uid,", this user is not in the channel")),u[g].error=D,e.splice(g,1);continue}if(I==="audio"&&(!C.hasAudio||C._audioSSRC===void 0)||I==="video"&&(!C.hasVideo||C._videoSSRC===void 0)){const D=new st(j.REMOTE_USER_IS_NOT_PUBLISHED);O.error("[".concat(this._clientId,"] can not subscribe ").concat(C.uid," with mediaType ").concat(I,", remote user is not published")),u[g].error=D,e.splice(g,1);continue}const b=dr.Video|dr.LwoVideo,x=o.get(C);if(x){if(I==="video"?x&b:x&dr.Audio){e.splice(g,1),O.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(C.uid,", mediaType:").concat(I," twice"));continue}o.set(C,x|(I==="video"?b:dr.Audio))}else o.set(C,I==="video"?b:dr.Audio)}for(let g=e.length-1;g>=0;g--){const S=e[g],{user:C,mediaType:I}=S,b=dr.Video|dr.LwoVideo;if(this._p2pChannel.hasRemoteMedia(C,I)){await this._p2pChannel.unmuteRemoteNoLock(C,I);const x=o.get(C);o.set(C,I==="video"?x^b:x^dr.Audio),e.splice(g,1)}}this.store.massSubscribe(e.map(g=>({userId:g.user.uid,type:g.mediaType})),i);const m=Lu(_=Array.from(o.entries())).call(_,(g,S)=>{let[C,I]=S;if(I===0)return g;const b={stream_id:C.uid,stream_type:I};return I&dr.Audio&&(b.audio_ssrc=C._audioSSRC),I&dr.Video&&(b.video_ssrc=C._videoSSRC),g.push(b),g},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(S=>{let{user:C,mediaType:I}=S;return{user:C,mediaType:I,ssrcId:I===Xt.VIDEO?C._videoSSRC:C._audioSSRC,rtxSsrcId:I===Xt.VIDEO?C._rtxSsrcId:void 0}}));const g=new Map;if(m.length>0){const S=await this._gateway.subscribeAll(m,!0);((S==null?void 0:S.users)||[]).forEach(C=>{let{stream_id:I,video_error_code:b,audio_error_code:x,error_code:D}=C;(b||x||D)&&g.set(I,{video_error_code:b,audio_error_code:x,error_code:D})})}if(Array.from(g.entries()).length>0){const S=[];Array.from(g.entries()).forEach(C=>{let[I,b]=C;const x=this.remoteUsers.find(D=>D.uid===I);if(x){let D;b.error_code||b.video_error_code&&b.audio_error_code?D=void 0:b.video_error_code?D=Xt.VIDEO:b.audio_error_code&&(D=Xt.AUDIO),S.push({user:x,mediaType:D})}}),S.length>0&&await this._p2pChannel.massUnsubscribeNoLock(S)}for(const S of u){const C=g.get(S.user.uid);if(C){const I=C.error_code||S.mediaType==="audio"&&C.audio_error_code||S.mediaType==="video"&&C.video_error_code;if(I){const b=Yd(I);O.error("user:".concat(S.user.uid," mediaType:").concat(S.mediaType," has massSubscribe error ").concat(b.desc)),S.error=new st(j.SUBSCRIBE_FAILED,"code ".concat(I,": ").concat(b.desc))}}S.error||(S.mediaType==="video"?S.track=S.user.videoTrack:S.track=S.user.audioTrack)}return this.store.massSubscribe(u.filter(S=>!S.error).map(S=>({userId:S.user.uid,type:S.mediaType})),void 0,Date.now()),u.forEach(S=>{var C;ne.subscribe(this.store.sessionId,{succ:!!S.error,ec:((C=S.error)===null||C===void 0?void 0:C.code)||null,video:S.mediaType===Xt.VIDEO,audio:S.mediaType===Xt.AUDIO,peerid:S.user.uid,subscribeRequestid:S.mediaType===Xt.VIDEO?S.user._videoSSRC:S.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-i)},!0)}),O.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(S=>{let{user:C,mediaType:I}=S;return"user: ".concat(C==null?void 0:C.uid,", mediaType: ").concat(I)}).join("; "))),u}catch(g){throw await this._p2pChannel.massUnsubscribeNoLock(e),g}}finally{h(),c()}}async unsubscribe(e,i,o){if(i||this.store.useP2P){if(i==="datachannel")return this._unsubscribeDataChannel(e,o)}else await this._unsubscribeDataChannel(e,o);if(i&&cr(i,"mediaType",["audio","video"]),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(u=>u===e)){const u=new st(j.INVALID_REMOTE_USER,"user is not in the channel");throw O.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),u}O.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(i));const c=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof _r)await this._p2pChannel.unsubscribe(e,i);else{const u=await this._p2pChannel.unsubscribe(e,i);u&&await this._gateway.unsubscribe(u,e.uid),i&&i!=="audio"||(e._audio_pre_subscribed=!1),i&&i!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&qh(this._users,e),O.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(i))}}catch(u){if(u.code===j.DISCONNECT_P2P)return void O.warning("disconnecting p2p, abort unsubscribe request.");throw O.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),u.toString()),u}finally{c()}}async _unsubscribeDataChannel(e,i){if(i&&hn(i,"id",0,65535,!0),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(c=>c===e)){const c=new st(j.INVALID_REMOTE_USER,"user is not in the channel");throw O.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),c}let o;if(typeof i=="number"){const c=e._dataChannels.find(u=>u.id===i);c&&(o=[c])}else o=e._dataChannels;if(o===void 0){const c=new st(j.REMOTE_USER_IS_NOT_PUBLISHED);throw O.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(i,", remote datachannel is not published")),c}O.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(o.map(c=>c.id)));try{const c=await this._p2pChannel.unsubscribeDataChannel(e,o);c&&await this._gateway.unsubscribeDataChannel(c,e.uid),O.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(c))}catch(c){if(c.code===j.DISCONNECT_P2P)return void O.warning("disconnecting p2p, abort unsubscribe request.");throw O.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),c.toString()),c}}async massUnsubscribe(e){if(jd(e,"unsubscribeList"),!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");O.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(o=>{let{user:c,mediaType:u}=o;return"user: ".concat(c==null?void 0:c.uid,", mediaType: ").concat(u,";")}).join())),e=[...e];const i=new Map;for(let o=e.length-1;o>=0;o--){const{user:c,mediaType:u}=e[o];if(!c){const _=new st(j.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw O.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),_}if(cr(u,"mediaType",["video","audio",void 0]),!this._users.find(_=>_===c)){O.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(c.uid,", user is not in the channel")),e.splice(o,1);continue}const h=dr.Video|dr.LwoVideo;if(i.has(c)){const _=i.get(c);let m;switch(u){case"video":m=_&h;break;case"audio":m=_&dr.Audio;break;default:m=_&(dr.Audio|h)}if(m){O.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(c.uid,",mediaType:").concat(u," twice.")),e.splice(o,1);continue}u?u==="audio"?i.set(c,_|dr.Audio):u==="video"&&i.set(c,_|h):i.set(c,_|dr.Audio|h)}else u?u==="audio"?i.set(c,dr.Audio):u==="video"&&i.set(c,h):i.set(c,dr.Audio|h)}try{const o=await this._p2pChannel.massUnsubscribe(e);o&&await this._gateway.massUnsubscribe(o),O.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(c=>{let{user:u,mediaType:h}=c;return"user: ".concat(u==null?void 0:u.uid,", mediaType: ").concat(h,";")}).join()))}catch(o){if(o.code===j.DISCONNECT_P2P)return void O.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw O.error("[".concat(this._clientId,"] massUnsubscribe error"),o.toString()),o}}async setLowStreamParameter(e){(function(o){if(!o)throw new ft(j.INVALID_PARAMS);xn(o.width)||PS(o.width,"streamParameter.width"),xn(o.height)||PS(o.height,"streamParameter.height"),xn(o.framerate)||PS(o.framerate,"streamParameter.framerate"),xn(o.bitrate)||hn(o.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&O.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),O.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&e.bitrate&&i.bitrate<e.bitrate&&(e.bitrate=i.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,yt.LocalVideoLowTrack)}async enableDualStream(){if(!sn().supportDualStream)throw ne.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new st(j.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new st(j.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw ne.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,ne.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),O.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new st(j.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(yt.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw ne.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,ne.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),O.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,i){if(function(o){cr(o,"role",["audience","host"])}(e),i&&oL(i),this.mode==="rtc"||this.mode==="p2p")throw O.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new st(j.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(i&&i.level&&e==="host")throw new st(j.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new st(j.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,i),this._config.role=e,O.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(i&&i.level))}getRemoteInboundOffset(){var e;const i=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!i||!i.timestamp)return 0;const o=i.timestamp-Date.now();return Math.abs(o)>1e3+i.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?o:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,i){if(fs(e,"proxyServer"),!i){if(this.connectionState!=="DISCONNECTED")throw new st(j.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new st(j.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,ne.setProxyServer(this._proxyServer),O.setProxyServer(this._proxyServer),O.info("[".concat(this._clientId,"] Set proxy server ").concat(i?"by initialize call":""," success."))}setTurnServer(e,i){if(Array.isArray(e)||(e=[e]),!i){if(this.connectionState!=="DISCONNECTED")throw new st(j.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new st(j.INVALID_OPERATION,"You have already set the proxy")}if(N_(e))return this._turnServer={servers:e,mode:"original-manual"},void O.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(e.map(o=>o.urls).join(","),"."));e.forEach(o=>sL(o)),this._turnServer={servers:e,mode:"manual"},O.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new st(j.INVALID_OPERATION,"you should set license before join channel");if(fs(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new st(j.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,O.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new st(j.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new st(j.INVALID_OPERATION,"You have already set the proxy");const i=[3,4,5];let o;switch(e===void 0&&(e=3),e){case 1:case 2:throw new st(j.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:o="proxy3";break;case 4:o="proxy4";break;case 5:o="proxy5";break;default:throw new st(j.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=o,this.store.cloudProxyServerMode=o,O.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new st(j.INVALID_OPERATION,"Stop proxy server after leave channel");ne.setProxyServer(),O.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",O.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new st(j.INVALID_PARAMS,"accessPoints is required.");jd(e.accessPoints.serverList,"accessPoints.serverList"),fs(e.accessPoints.domain,"accessPoints.domain");const i=(b,x)=>{hn(b,x,0,65535,!0)};let o=443;if(e.accessPoints.port&&(i(e.accessPoints.port,"accessPoints.port"),o=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new st(j.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");Q("CLOSE_AFB_FOR_LOCAL_AP")&&(Mn("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Mn("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const c=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,u=e.accessPoints.domain,h=e.accessPoints.serverList.map(b=>c.test(b)?"".concat(b.replace(/\./g,"-"),".").concat(u):b),_=h.map(b=>"".concat(b,":").concat(o));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Mn("WEBCS_DOMAIN",_),Mn("WEBCS_DOMAIN_BACKUP_LIST",_),Mn("GATEWAY_DOMAINS",[u]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(jd(e.report.hostname,"report.hostname"),Mn("EVENT_REPORT_DOMAIN",e.report.hostname[0]),Mn("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(Mn("EVENT_REPORT_DOMAIN",h[0]),Mn("EVENT_REPORT_BACKUP_DOMAIN",h[1]||h[0]));let m=6443;e.report&&e.report.port&&(i(e.report.port,"report.port"),m=e.report.port),Mn("STATS_COLLECTOR_PORT",m),e.report?Mn("ENABLE_EVENT_REPORT",!0):Mn("ENABLE_EVENT_REPORT",!1);let g="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(jd(e.log.hostname,"log.hostname"),g=e.log.hostname[0]):g=h[0];let S=6444;e.log&&e.log.port&&(i(e.log.port,"log.port"),S=e.log.port),Mn("LOG_UPLOAD_SERVER","".concat(g,":").concat(S));let C=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(jd(e.cds.hostname,"cds.hostname"),C=e.cds.hostname):C=h;let I=443;e.cds&&e.cds.port&&(i(e.cds.port,"cds.port"),I=e.cds.port),Mn("CDS_AP",C.map(b=>"".concat(b,":").concat(I))),e.cds?Mn("ENABLE_CONFIG_DISTRIBUTE",!0):Mn("ENABLE_CONFIG_DISTRIBUTE",!1),O.info("set local access point v2 success")}setLocalAccessPoints(e,i){if(jd(e,"serverList"),fs(i,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new st(j.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const o=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(c=>o.test(c)?"".concat(c.replace(/\./g,"-"),".").concat(i):c),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Mn("WEBCS_DOMAIN",e),Mn("WEBCS_DOMAIN_BACKUP_LIST",e),Mn("GATEWAY_DOMAINS",[i]),Mn("EVENT_REPORT_DOMAIN",e[0]),Mn("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),Mn("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),O.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(cr(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(i){throw O.error("[".concat(this._clientId,"] set default remote video stream type error"),i.toString()),i}else O.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,i){cr(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,i),setTimeout(()=>{const o=this._users.find(c=>c.uid===e);o&&o.videoTrack&&o.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(o){throw O.error("[".concat(this._clientId,"] set remote video stream type error"),o.toString()),o}O.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(e,i)}async setStreamFallbackOption(e,i){cr(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,i)}catch(o){throw O.error("[".concat(this._clientId,"] set stream fallback option"),o.toString()),o}O.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(e,i)}setEncryptionConfig(e,i,o,c){(function(h){cr(h,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),fs(i,"secret");const u=["aes-128-gcm2","aes-256-gcm2"];if(Jt(u).call(u,e)){if(!o||!(o instanceof Uint8Array&&o.length===32))throw new st(j.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(o)throw new st(j.INVALID_PARAMS,"current encrypt mode does not need salt");if(c){if(td(c,"encryptDataStream"),!Jt(u).call(u,e))throw new st(j.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(i)||O.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=i,o&&(this._encryptionSalt=Qh(o))}async renewToken(e){if(fs(e,"token",1,2047),!this._key||!this._joinInfo)throw new st(j.INVALID_OPERATION,"renewToken should not be called before user join");const i=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const o=await this._renewTokenMutex.lock();try{if(Q("USE_NEW_TOKEN")){O.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const c=await RR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||nr);O.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:c})}else O.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});O.debug("[".concat(this._clientId,"] renewToken success"))}catch(c){throw this._key=i,this._joinInfo.token=i,O.error("[".concat(this._clientId,"] renewToken failed"),c.toString()),c}finally{o()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?O.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(We.VOLUME_INDICATOR,e)},Q("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),i=this._gateway.getInChannelInfo();return e.Duration=Math.round(i.duration/1e3),e}async startLiveStreaming(e,i){if(!i){if(this.codec!=="h264")throw new st(j.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new st(j.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new st(j.LIVE_STREAMING_TASK_CONFLICT);const o=i?ki.TRANSCODE:ki.RAW;return this._createLiveStreamingClient(o).startLiveStreamingTask(e,o)}setLiveTranscoding(e){return this._createLiveStreamingClient(ki.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const i=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(o=>o&&o.hasUrl(e));if(!i.length)throw new st(j.INVALID_PARAMS,"can not find live streaming url to stop");await ut.all(i.map(o=>o&&o.stopLiveStreamingTask(e)))}async addInjectStreamUrl(e,i){if(!this._joinInfo)throw new st(j.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const o=this._createLiveStreamingClient(ki.INJECT);o.setInjectStreamConfig(i,0),await o.startLiveStreamingTask(e,ki.INJECT)}async removeInjectStreamUrl(){var e;const i=this._createLiveStreamingClient(ki.INJECT),o=Array.from(Rc(e=i.streamingTasks).call(e)).find(c=>c.mode===ki.INJECT);if(!this._joinInfo||!o)throw new st(j.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await i.stopLiveStreamingTask(o.url)}async startChannelMediaRelay(e){a1(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){a1(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){var i;let o=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new st(j.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const u=new TextEncoder;e.payload=u.encode(e.payload)}let c=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Jt(i=["aes-128-gcm2","aes-256-gcm2"]).call(i,this._encryptionMode)&&(c=!0,e.payload=await async function(u,h,_){var m;const g=Lu(m=Array.from(_)).call(m,(M,K)=>M+K,0),S={serverTs:0,seq:WL++,length:_.length,checkSum:g},C=new Uint8Array(NA(g,2)),I=new ArrayBuffer(ip),b=new DataView(I);b.setUint32(0,S.serverTs),b.setUint16(4,S.seq),b.setUint16(6,S.length),b.setUint16(8,S.checkSum);const x=16-_.length%16;_=wA(_,new Uint8Array(x));const D=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:u,tagLength:QA,additionalData:C},h,_);return wA(new Uint8Array(I),new Uint8Array(D))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new st(j.INVALID_PARAMS,c?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ie.DATA_STREAM,{payload:Qh(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-LC},!o)}sendMetadata(e){if(!this._joinInfo)throw new st(j.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new st(j.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ie.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Qh(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(uj),!this._joinInfo)throw new st(j.INVALID_OPERATION,"can not send custom report, not joined");await ne.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,i){cr(i.spatialLayer,"spatialLayer",[0,1,2,3]),cr(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,i)}catch(o){throw O.error("[".concat(this._clientId,"] pick SVC layer failed"),o.toString()),o}}async setRTMConfig(e){const{apRTM:i=!1,rtmFlag:o}=e;if(td(i,"apRTM"),hn(o,"rtmFlag",0),this._rtmConfig.apRTM=i,this._rtmConfig.rtmFlag=o,O.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=i,this._joinInfo.rtmFlag=o,this._gateway.setRTM2Flag(o)}_reset(){if(O.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Ks.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(i=>i._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Sr("client-publish"),this._subscribeMutex=new Sr("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,i){var o;const c=e||OA();e?O.debug("[".concat(this._clientId,"] new Session ").concat(c)):O.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(c));const u=e?"":this._sessionId||"";this._sessionId=c,this.store.sessionId=c;const h={lts:new Date().getTime(),mode:this.mode,stringUid:(i==null?void 0:i.stringUid)||((o=this._joinInfo)===null||o===void 0?void 0:o.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:u,clientRole:this.role==="audience"?2:1};i?ne.sessionInit(this._sessionId,Gc({cname:i.channel,appid:i.appId},h)):this._joinInfo?ne.sessionInit(this._sessionId,Gc({cname:this._joinInfo.cname,appid:this._joinInfo.appId},h)):this._gateway.joinInfo&&ne.sessionInit(this._sessionId,Gc({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},h)),this._joinInfo&&(this._joinInfo.sid=c),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=c)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new st(j.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&Q("FORCE_TURN")&&!Q("TURN_ENABLE_TCP")&&!Q("TURN_ENABLE_UDP"))throw new st(j.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");O.debug("[".concat(this._clientId,"] publish high stream"));try{const o=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof _r){const c=(await o.next()).value;if(c){try{await this._gateway.sendExtensionMessage(li.PUBLISH,c,!0)}catch(u){throw o.throw(u),u}await o.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const c=(await o.next()).value;if(c){var i;let u;try{u=await this._gateway.publish(this._uid,c,!0)}catch(h){if(h.code!==j.DISCONNECT_P2P)throw o.throw(h),h}await o.next(((i=u)===null||i===void 0?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const u of e)u instanceof ke&&u._encoderConfig&&this._gateway.setVideoProfile(u._encoderConfig),!u.muted&&u.enabled||await this._p2pChannel.muteLocalTrack(u)}}catch(o){if(this._p2pChannel.reportPublishEvent(!1,o==null?void 0:o.code,e),(o==null?void 0:o.code)===j.WS_ABORT)return;throw o}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new st(j.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new st(j.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));O.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const o=await this._p2pChannel.publishLowStream(this._lowStreamParameter),c=(await o.next()).value;if(c){var i;let u;try{u=await this._gateway.publish(this._uid,c,!0)}catch(h){if(h.code!==j.DISCONNECT_P2P)throw o.throw(h),h}o.next(((i=u)===null||i===void 0?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(o){if(this._p2pChannel.reportPublishEvent(!1,o==null?void 0:o.code,void 0,!0),(o==null?void 0:o.code)===j.WS_ABORT)return;throw o}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new st(j.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const i=()=>new o1(this._joinInfo,this._config.websocketRetryConfig||nr,this._config.httpRetryConfig||nr),o=c=>{c.onLiveStreamError=(u,h)=>{ne.reportApiInvoke(this._sessionId,{name:tr.ON_LIVE_STREAM_ERROR,options:[u,h],tag:gi.TRACER}).onSuccess(),this.safeEmit(We.LIVE_STREAMING_ERROR,u,h)},c.onLiveStreamWarning=(u,h)=>{ne.reportApiInvoke(this._sessionId,{name:tr.ON_LIVE_STREAM_WARNING,options:[u,h],tag:gi.TRACER}).onSuccess(),this.safeEmit(We.LIVE_STREAMING_WARNING,u,h)},c.on(vl.REQUEST_WORKER_MANAGER_LIST,(u,h,_)=>{if(!this._joinInfo)return _(new st(j.INVALID_OPERATION,"can not find join info to get worker manager"));Vn(u,this._joinInfo,this._axiosCancelSource.token,nr).then(h).catch(_)})};switch(e){case ki.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=i(),o(this._liveRawStreamingClient)),this._liveRawStreamingClient;case ki.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=i(),o(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case ki.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=i(),this._injectStreamingClient.on(vl.REQUEST_WORKER_MANAGER_LIST,(c,u,h)=>{if(!this._joinInfo)return h(new st(j.INVALID_OPERATION,"can not find join info to get worker manager"));Vn(c,this._joinInfo,this._axiosCancelSource.token,nr).then(u).catch(h)}),this._injectStreamingClient.onInjectStatusChange=(c,u,h)=>{this.safeEmit(We.INJECT_STREAM_STATUS,c,u,h)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new st(j.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:i}=this.getLocalVideoStats(),o={width:e,height:i};this._channelMediaRelayClient=new iO(this._joinInfo,this._clientId,this._config.websocketRetryConfig||nr,this._config.httpRetryConfig||nr,o),this._channelMediaRelayClient.on("state",c=>{c===ws.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(We.CHANNEL_MEDIA_RELAY_STATE,c)}),this._channelMediaRelayClient.on("event",c=>{this.safeEmit(We.CHANNEL_MEDIA_RELAY_EVENT,c)}),this._statsCollector.onStatsChanged=(c,u)=>{var h;c==="resolution"&&((h=this._channelMediaRelayClient)===null||h===void 0||h.setVideoProfile(u))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,i){const{added:o,deleted:c}=e,u=[];Array.isArray(o)&&o.length>0&&o.forEach(h=>{const{uid:_,stream_id:m,ordered:g,max_retrans_times:S,metadata:C}=h,I=this._users.find(b=>b._uintid===_);if(!I)return void O.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(O.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(_)),Jt(u).call(u,I)||u.push(I),I._uintid||(I._uintid=_),I._dataChannels.findIndex(b=>b.id===h.stream_id)===-1){const b={id:m,ordered:!!g,maxRetransmits:S,metadata:C},x=new qj(b);I._dataChannels.push(x),O.info("[".concat(this._clientId,"] remote user ").concat(I.uid," published datachannel")),i||this.safeEmit(We.USER_PUBLISHED,I,"datachannel",b)}this._p2pChannel.hasPendingRemoteDataChannel(I,h.stream_id)&&(O.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(I.uid," after reconnect.")),this._subscribeDataChannel(I,h.stream_id).catch(b=>{O.error("[".concat(this._clientId,"] resubscribe datachannel error"),b.toString())}))}),i&&(this.safeEmit(We.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(c)&&c.length>0&&c.forEach(h=>{const{uid:_,stream_id:m}=h,g=this._users.find(C=>C._uintid===_);if(!g)return void O.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const S=g._dataChannels.find(C=>C.id===h.stream_id);S&&(O.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(_)),this._p2pChannel.unsubscribeDataChannel(g,[S]).then(C=>{if(g._dataChannels=g._dataChannels.filter(I=>I!==S),C)return this._gateway.unsubscribeDataChannel(C,g.uid)}),O.info("[".concat(this._clientId,"] remote user ").concat(_," unpublished datachannel ,id:").concat(S.id)),this.safeEmit(We.USER_UNPUBLISHED,g,"datachannel",S._config))})}_handleRemoveDataChannels(e){const i=this._users.find(o=>o.uid===e.uid);if(i){if(i._dataChannels!==void 0&&i._dataChannels.length>0){O.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const o=()=>{O.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach(c=>{this.safeEmit(We.USER_UNPUBLISHED,i,"datachannel",c._config)})};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then(c=>{if(c)return this._gateway.unsubscribeDataChannel(c,i.uid)}),o()}}else O.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Ni.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Ni.CONNECTION_STATE_CHANGE,(e,i,o)=>{var c;if(o===Fe.FALLBACK)return;const u=()=>{this.safeEmit(We.CONNECTION_STATE_CHANGE,e,i,o)};if(ne.reportApiInvoke(this._sessionId||((c=this._gateway.joinInfo)===null||c===void 0?void 0:c.sid)||null,{name:tr.CONNECTION_STATE_CHANGE,options:[e,i,o],tag:gi.TRACER}).onSuccess(JSON.stringify({cur:e,prev:i,reason:o})),O.info("[".concat(this._clientId,"] connection state change: ").concat(i," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void u();if(e==="RECONNECTING")this._users.forEach(_=>{_._trust_in_room_=!1,_._trust_audio_enabled_state_=!1,_._trust_video_enabled_state_=!1,_._trust_audio_mute_state_=!1,_._trust_video_mute_state_=!1,_._trust_audio_stream_added_state_=!1,_._trust_video_stream_added_state_=!1,_._is_pre_created||(_._audio_pre_subscribed||(_._audioSSRC=void 0,_._audioOrtc=void 0),_._video_pre_subscribed||(_._videoSSRC=void 0,_._videoOrtc=void 0,_._rtxSsrcId=void 0),_._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var h;this._streamFallbackTypeCacheMap.forEach((_,m)=>{this._gateway.setStreamFallbackOption(m,_).catch(g=>{O.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),g)})}),this._remoteStreamTypeCacheMap.forEach((_,m)=>{this._gateway.setRemoteVideoStreamType(m,_).catch(g=>{O.warning("[".concat(this._clientId,"] auto set remote stream type failed"),g)})}),this._remoteDefaultVideoStreamType!==void 0&&((h=this._joinInfo)===null||h===void 0?void 0:h.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{O.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(_=>{O.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(_))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(_=>!_._trust_in_room_).forEach(_=>{O.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(_.uid)),this._handleUserOffline({uid:_.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(_=>{_._trust_audio_mute_state_||(O.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(_.uid)),this._handleMuteStream(_.uid,Xt.AUDIO,!1)),_._trust_video_mute_state_||(O.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(_.uid)),this._handleMuteStream(_.uid,Xt.VIDEO,!1)),_._trust_audio_enabled_state_||(O.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(_.uid)),this._handleSetStreamLocalEnable("audio",_.uid,!0)),_._trust_video_enabled_state_||(O.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(_.uid)),this._handleSetStreamLocalEnable("video",_.uid,!0)),_._trust_video_stream_added_state_||(O.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(_.uid)),this._handleResetAddStream(_,"video")),_._trust_audio_stream_added_state_||(O.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(_.uid)),this._handleResetAddStream(_,"audio")),_._video_added_||_._audio_added_||(O.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(_.uid)),this._handleRemoveStream({uid:_.uid,uint_id:_._uintid}))}))},1e3))}u()}),this._gateway.on(Ni.REQUEST_NEW_GATEWAY_LIST,(e,i)=>{if(!this._joinInfo)return i(new st(j.UNEXPECTED_ERROR,"can not recover, no join info"));SR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||nr,this.store).then(o=>{this._joinInfo&&(this._joinInfo.apResponse=o.gatewayInfo.res,this._joinInfo.gatewayAddrs=o.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=o.gatewayInfo.uni_lbs_ip);const c=[];o.gatewayInfo.gatewayAddrs.forEach(u=>{let{address:h}=u;const[_,m]=h.split(":");this._joinInfo&&this._joinInfo.proxyServer?c.push({proxy:this._joinInfo.proxyServer,host:_,port:m}):c.push({host:_,port:m})}),e(c)}).catch(i)}),this._gateway.on(Ni.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(We.NETWORK_QUALITY,e)}),this._gateway.on(Ni.STREAM_TYPE_CHANGE,(e,i)=>{this.safeEmit(We.STREAM_TYPE_CHANGED,e,i),ne.reportApiInvoke(this._sessionId,{name:tr.STREAM_TYPE_CHANGE,options:[e,i],tag:gi.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:i}))}),this._gateway.on(Ni.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(Ni.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(Ni.REQUEST_P2P_CONNECTION_PARAMS,async(e,i,o)=>{try{i(await this._p2pChannel.startP2PConnection(e))}catch(c){o(c)}}),this._gateway.on(Ni.JOIN_RESPONSE,(e,i)=>{if(this.store.useP2P)return;const{dtlsParameters:o,iceParameters:c,candidates:u,rtpCapabilities:h,setup:_,cname:m}=Xw(e.ortc,i);this._p2pChannel.connect(c,o,u,h,_,m)}),this._gateway.on(Ni.REQUEST_DC_CONNECTION_PARAMS,e=>{e(this._p2pChannel.getEstablishParams())}),this._gateway.on(Ni.RESET_SIGNAL,e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()}),this._gateway.on(Ni.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(Ni.DATACHANNEL_PRECONNECT,async(e,i,o,c)=>{var u,h,_,m,g,S;await this._p2pChannel.startP2PConnection({turnServer:(u=this._joinInfo)===null||u===void 0?void 0:u.turnServer},!0);const C=function(I,b){let x;return b&&b.ip&&typeof b.port=="number"?(x=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:b.ip,port:b.port.toString(),type:"host",extension:{}}],O.debug("Using remote candidate from AP ".concat(b.ip,":").concat(b.port)),b.ip6&&(x.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:b.ip6,port:b.port.toString(),type:"host",extension:{}}),O.debug("Using IPV6 remote candidate from AP ".concat(b.ip6,":").concat(b.port)))):x=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:I.ip,port:I.port.toString(),type:"host",extension:{}}],x}(e,i);return this._p2pChannel.preConnect({iceUfrag:"".concat((h=this._joinInfo)===null||h===void 0?void 0:h.apResponse.cid,"_").concat((_=this._joinInfo)===null||_===void 0?void 0:_.apResponse.cert),icePwd:"".concat((m=this._joinInfo)===null||m===void 0?void 0:m.apResponse.cid,"_").concat((g=this._joinInfo)===null||g===void 0?void 0:g.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(S=Q("FINGERPRINT"))!==null&&S!==void 0?S:e.fingerprint}]},C,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(o).catch(c)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Re.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Re.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Re.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc)),this._gateway.signal.on(Re.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(Re.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(Re.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Re.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Re.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Re.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,Xt.AUDIO,!0)),this._gateway.signal.on(Re.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,Xt.AUDIO,!1)),this._gateway.signal.on(Re.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,Xt.VIDEO,!0)),this._gateway.signal.on(Re.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,Xt.VIDEO,!1)),this._gateway.signal.on(Re.RECEIVE_METADATA,e=>{const i=D_(e.metadata);this.safeEmit(We.RECEIVE_METADATA,e.uid,i)}),this._gateway.signal.on(Re.ON_DATA_STREAM,async e=>{var i;if(!e)return;let o=D_(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Jt(i=["aes-128-gcm2","aes-256-gcm2"]).call(i,this._encryptionMode)){if(e.payload.length<ip)throw new st(j.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(ip));o=await async function(h,_,m){const g=m.subarray(0,ip),S=g.slice(8,ip),C=(S[0]<<8)+S[1],I=(g[6]<<8)+g[7],b=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:h,tagLength:QA,additionalData:new Uint8Array(NA(C,2))},_,m.subarray(ip));return new Uint8Array(b).subarray(0,I)}(this._encryptDataStreamIv,this._encryptDataStreamKey,o)}let c=0;if(e.ordered||e.syncWithAudio){const u=this._p2pChannel.getStats(),h=this.remoteUsers.find(m=>m.uid===e.uid),_=u==null?void 0:u.audioRecv.find(m=>m.ssrc===(h==null?void 0:h._audioSSRC));c=_==null?void 0:_.jitterBufferMs}c==null&&(c=0),ao(Gc(Gc({},e),{},{payload:o}),c,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Re.ON_CRYPT_ERROR,()=>{Xh(()=>{O.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(We.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Re.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Re.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{O.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Fe.TOKEN_EXPIRE),this.safeEmit(We.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Re.ON_STREAM_FALLBACK_UPDATE,e=>{O.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(We.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Re.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),O.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(Re.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(Re.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(Gt.REQUEST_TIMEOUT,(e,i)=>{if(this._joinInfo)switch(e){case ie.PUBLISH:{if(!i)return;const u=i.ortc;if(u){var o,c;const h=u.some(g=>{let{stream_type:S}=g;return S===rn.Audio}),_=u.some(g=>{let{stream_type:S}=g;return S!==rn.Audio}),m=u.some(g=>{let{stream_type:S}=g;return S===rn.Screen||S===rn.ScreenLow});i.state==="offer"&&ne.publish(this._joinInfo.sid,{eventElapse:cs.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:j.TIMEOUT,audio:h,video:_,p2pid:i.p2p_id,publishRequestid:this.store.pubId,screenshare:m,audioName:h?(o=u.find(g=>{let{stream_type:S}=g;return S===rn.Audio}))===null||o===void 0||(o=o.ssrcs[0])===null||o===void 0?void 0:o.ssrcId.toString():void 0,videoName:_?(c=u.find(g=>{let{stream_type:S}=g;return S!==rn.Audio}))===null||c===void 0||(c=c.ssrcs[0])===null||c===void 0?void 0:c.ssrcId.toString():void 0})}break}case ie.SUBSCRIBE:i&&ne.subscribe(this._joinInfo.sid,{succ:!1,ec:j.TIMEOUT,audio:i.stream_type===Xt.AUDIO,video:i.stream_type===Xt.VIDEO,peerid:i.stream_id,subscribeRequestid:i.ssrcId,p2pid:this.store.p2pId,eventElapse:cs.measureFromSubscribeStart(this.store.clientId,i.ssrcId)})}}),this._gateway.signal.on(Re.ON_P2P_OK,e=>{}),this._gateway.signal.on(Re.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;Q("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(c=>!sp(c.string_id||c.stream_id,this.channelName)));const i=[],o=[];for(const c of e.users){let u=this._users.find(C=>C._uintid===c.stream_id);u?u._trust_in_room_=!0:(u=new Zr(c.string_id||c.stream_id,c.stream_id),this._users.push(u),this.getListeners(We.PUBLISHED_USER_LIST).length===0&&(O.debug("[".concat(this._clientId,"] user online"),c.stream_id),this.safeEmit(We.USER_JOINED,u)));const h=dr.Audio&c.stream_type,_=(dr.Video|dr.LwoVideo)&c.stream_type,m=(65280&c.stream_type)!=0,g=h&&u.hasAudio,S=_&&u.hasVideo;_&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0,u._videoSSRC=c.video_ssrc,u._rtxSsrcId=c.video_rtx),h&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0,u._audioSSRC=c.audio_ssrc),h&&!g&&this.getListeners(We.PUBLISHED_USER_LIST).length===0&&(O.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published audio")),this.safeEmit(We.USER_PUBLISHED,u,"audio")),_&&!S&&this.getListeners(We.PUBLISHED_USER_LIST).length===0&&(O.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published video")),this.safeEmit(We.USER_PUBLISHED,u,"video")),(h&&!g||_&&!S||m)&&i.push(u),_&&this._p2pChannel.hasPendingRemoteMedia(u,"video")&&o.push({user:u,mediaType:"video"}),h&&this._p2pChannel.hasPendingRemoteMedia(u,"audio")&&o.push({user:u,mediaType:"audio"})}o.length>0&&(O.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(o.map(c=>"user: ".concat(c.user.uid,", mediaType: ").concat(c.mediaType)).join("; ")," ")),this.massSubscribe(o).catch(c=>{O.error("[".concat(this._clientId,"] mass resubscribe error"),c.toString())})),this.getListeners(We.PUBLISHED_USER_LIST).length>0?Q("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(O.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map(c=>c.uid).join(", "))),this.safeEmit(We.PUBLISHED_USER_LIST,i)):O.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map(c=>c.uid).join(", ")))}),this._gateway.signal.on(Re.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:i}=e;this._p2pChannel instanceof Ki&&this._p2pChannel.updateRemoteRTPCapabilities(i.map(o=>o.toLowerCase()).filter(o=>{var c;return Jt(c=Object.keys(Sl)).call(c,o)}))})}_handleP2PEvents(){this._gateway.signal.on(Re.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(li.PUBLISH,(e,i,o)=>{const{uid:c}=e;e.forEach(u=>{const{kind:h,ssrcs:_,mid:m,isMuted:g}=u;this._handleP2PAddAudioOrVideoStream(h,c,_[0].ssrcId,m);const S=this._users.find(C=>C.uid===c);return S&&this._p2pChannel instanceof _r?this._p2pChannel.mockSubscribe(S,h,_[0].ssrcId,m).then(()=>{i()}).catch(o):i(),this._handleMuteStream(c,h,!!g)})}),this._gateway.signal.on(li.CALL,async(e,i,o)=>{if(this._p2pChannel instanceof _r)try{var c;i(await this._p2pChannel.startP2P({turnServer:(c=this._joinInfo)===null||c===void 0?void 0:c.turnServer},e))}catch(u){o(u)}}),this._gateway.signal.on(Gt.P2P_CONNECTION,async e=>{this._p2pChannel instanceof _r&&await this._p2pChannel.p2pConnect(e)}),this._gateway.signal.on(li.UNPUBLISH,async(e,i,o)=>{if(this._p2pChannel instanceof _r){const{unpubMsg:c,uid:u}=e,h=this._users.find(_=>_.uid===u);if(!h)return O.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(u)),void i();try{c.forEach(async _=>{let{stream_type:m}=_;const g=m===rn.Audio?Xt.AUDIO:Xt.VIDEO;await this._p2pChannel.unsubscribe(h,g),this._handleMuteStream(u,g,!0)}),i()}catch(_){o(_)}}}),this._gateway.signal.on(li.CONTROL,async(e,i)=>{const{action:o}=e;switch(o){case Ic.MUTE_LOCAL_VIDEO:this._handleMuteStream(i,Xt.VIDEO,!0);break;case Ic.MUTE_LOCAL_AUDIO:this._handleMuteStream(i,Xt.AUDIO,!0);break;case Ic.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",i),this._handleMuteStream(i,Xt.VIDEO,!1);break;case Ic.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",i),this._handleMuteStream(i,Xt.AUDIO,!1)}}),this._gateway.signal.on(li.RESTART_ICE,async(e,i,o)=>{if(this._p2pChannel instanceof _r)try{const{direction:c,iceParameter:u}=e;c!==is.SEND_ONLY||u?i(await this._p2pChannel.restartICE(c,u)):(this._p2pChannel.handleDisconnect(c),i())}catch(c){o(c)}}),this._gateway.signal.on(li.CANDIDATE,e=>{if(this._p2pChannel instanceof _r){const{candidate:i,direction:o}=e;this._p2pChannel.addRemoteCandidate(i,o)}}),this._p2pChannel.on(_e.RequestP2PRestartICE,async(e,i,o)=>{try{const{direction:c}=e;i(await this._gateway.sendExtensionMessage(li.RESTART_ICE,e,c===is.SEND_ONLY))}catch(c){o(c)}}),this._p2pChannel.on(_e.LocalCandidate,e=>{this._gateway.sendExtensionMessage(li.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(_e.RequestP2PMuteLocal,async(e,i,o)=>{try{await this._gateway.sendExtensionMessage(li.CONTROL,e,!0),i()}catch(c){o(c)}}),this._p2pChannel.on(_e.RequestP2PUnmuteRemote,async(e,i,o)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(c){c.code===j.DISCONNECT_P2P?i():o(c)}else i()}),this._p2pChannel.on(_e.RequestP2PMuteRemote,async(e,i,o)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(c){c.code===j.DISCONNECT_P2P?i():o(c)}else i()}),this._p2pChannel.on(_e.StateChange,(e,i)=>{i===En.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(_e.RequestMuteLocal,async(e,i,o)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(c){c.code===j.DISCONNECT_P2P?i():o(c)}else i()}),this._p2pChannel.on(_e.RequestUnmuteLocal,async(e,i,o)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(c){c.code===j.DISCONNECT_P2P?i():o(c)}else i()}),this._p2pChannel.on(_e.RequestRePublish,(e,i,o)=>{this.publish(e,!1).then(i).catch(o)}),this._p2pChannel.on(_e.RequestRePublishDataChannel,(e,i,o)=>{ut.all(e.map(async c=>{await this._p2pChannel.publishDataChannel([c]);const u={streamId:c.id,ordered:c.ordered,maxRetransmits:c.maxRetransmits,metadata:c.metadata,channelId:c._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,u,!0)}catch(h){if(h.code!==j.DISCONNECT_P2P)throw h}})).then(i).catch(o)}),this._p2pChannel.on(_e.RequestReSubscribe,async(e,i,o)=>{try{for(const{user:c,kind:u}of e)u===Xt.VIDEO?await this.subscribe(c,"video"):await this.subscribe(c,"audio");i()}catch(c){o(c)}}),this._p2pChannel.on(_e.RequestUpload,(e,i)=>{this._gateway.upload(e,i)}),this._p2pChannel.on(_e.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(_e.MediaReconnectStart,e=>{this.safeEmit(We.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(_e.MediaReconnectEnd,e=>{this.safeEmit(We.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(_e.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(_e.RequestRestartICE,async e=>{if(this._p2pChannel instanceof _r)return;const i=await this._p2pChannel.restartICE(e),o=await i.next();if(o.done)return;const c=o.value;let u;try{u=await this._gateway.restartICE({iceParameters:c})}catch(_){return void i.throw(_)}const{iceParameters:h}=function(_){const m=_.iceParameters;return{iceParameters:{iceUfrag:m.iceUfrag,icePwd:m.icePwd}}}(u);await i.next({remoteIceParameters:h})}),this._p2pChannel.on(_e.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(_e.RequestReconnectPC,async()=>{var e;const{iceParameters:i,dtlsParameters:o,rtpCapabilities:c}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:u,gatewayAddress:h}=await this._gateway.reconnectPC({iceParameters:i,dtlsParameters:o,rtpCapabilities:c}),{dtlsParameters:_,iceParameters:m,candidates:g,rtpCapabilities:S,setup:C,cname:I}=Xw(u,h);await this._p2pChannel.connect(m,_,g,S,C,I),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(_e.RequestUnpublishForReconnectPC,async(e,i,o)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),i()):o()}),this._p2pChannel.on(_e.P2PLost,()=>{this.safeEmit(We.P2P_LOST,this.store.uid)}),this._p2pChannel.on(_e.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(_e.ConnectionTypeChange,e=>{this.safeEmit(We.IS_USING_CLOUD_PROXY,e)}),this._p2pChannel.on(_e.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(_e.QueryClientConnectionState,e=>{e(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const i=[...new Set(e.inspectType)];i.forEach(o=>{var c;if(!Jt(c=["supervise","moderation"]).call(c,o))throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(o," is not a valid inspect type."))}),e.inspectType=i}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const i=new ti(e);this._inspect=i,this.handleVideoInspectEvents(this._inspect),await i.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},nr)}catch(i){throw Array.isArray(i)?i[0]:i}}async disableContentInspect(){if(!this._inspect)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,i){if(td(e,"enabled"),e){if(!i)throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(hn(i.interval,"interval",1e3,1/0),i&&i.extraInfo&&i.extraInfo.length>1024)throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(i&&i.vendor&&i.vendor.length>1024)throw new st(j.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(i);const o=new DC(i);this._moderation=o,this.handleImageModerationEvents(this._moderation),await o.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},nr)}catch(o){throw Array.isArray(o)?o[0]:o}}else{if(!this._moderation)throw new st(j.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(o){throw Array.isArray(o)?o[0]:o}}}setP2PTransport(e){if(function(i){cr(i,"transport",["default","auto","relay","sd-rtn"])}(e),this.mode!=="p2p")throw new st(j.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,O.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(Uo.CONNECTION_STATE_CHANGE,(i,o)=>{if(this.safeEmit(We.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,i,o),i===Eo.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new st(j.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(Uo.CLIENT_LOCAL_VIDEO_TRACK,i=>{i(this.localTracks.filter(o=>o.trackMediaType==="video")[0])})}handleVideoInspectEvents(e){e.on(ur.CONNECTION_STATE_CHANGE,(i,o)=>{if(this.safeEmit(We.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,i,o),o===Mo.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(We.CONTENT_INSPECT_ERROR,new st(j.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(ur.INSPECT_RESULT,(i,o)=>{var c;if((o==null?void 0:o.code)===j.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return O.debug("Stop inspect content because that has left channel"),this==null||(c=this._inspect)===null||c===void 0||c.close(),void(this._inspect=void 0);this.safeEmit(We.CONTENT_INSPECT_RESULT,i,o)}),e.on(ur.CLIENT_LOCAL_VIDEO_TRACK,i=>{i(this.localTracks.filter(o=>o.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return O.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){td(e,"enabled"),Mn("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,i){switch(i){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Tn.prototype,"leave",null),Tt([ce({argsMap:(s,e)=>{if(!Array.isArray(e)){if(!(e instanceof os))return[e];e=[e]}return e.map(i=>i?Object(i).toString():"null")}}),V("design:type",Function),V("design:paramtypes",[Object,Boolean]),V("design:returntype",ut)],Tn.prototype,"publish",null),Tt([ce({argsMap:(s,e)=>(e||(e=[]),e instanceof oM?[e.getChannelId()]:(Array.isArray(e)||(e=[e]),e.map(i=>i.getTrackId())))}),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Tn.prototype,"unpublish",null),Tt([ce({argsMap:(s,e,i,o)=>[e.uid,i,o]}),V("design:type",Function),V("design:paramtypes",[Zr,String,Number]),V("design:returntype",ut)],Tn.prototype,"subscribe",null),Tt([ce({argsMap:(s,e,i)=>[e,i]}),V("design:type",Function),V("design:paramtypes",[Object,String]),V("design:returntype",ut)],Tn.prototype,"presubscribe",null),Tt([ce({argsMap:(s,e)=>e.map(i=>{let{user:o,mediaType:c}=i;return[o==null?void 0:o.uid,c]})}),V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Tn.prototype,"massSubscribe",null),Tt([ce({argsMap:(s,e,i,o)=>[e.uid,i,o]}),V("design:type",Function),V("design:paramtypes",[Zr,String,Number]),V("design:returntype",ut)],Tn.prototype,"unsubscribe",null),Tt([ce({argsMap:(s,e)=>e.map(i=>{let{user:o,mediaType:c}=i;return{uid:o==null?void 0:o.uid,mediaType:c}})}),V("design:type",Function),V("design:paramtypes",[Array]),V("design:returntype",ut)],Tn.prototype,"massUnsubscribe",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Tn.prototype,"setLowStreamParameter",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Tn.prototype,"enableDualStream",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Tn.prototype,"disableDualStream",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String,Object]),V("design:returntype",ut)],Tn.prototype,"setClientRole",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String,Boolean]),V("design:returntype",void 0)],Tn.prototype,"setProxyServer",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object,Boolean]),V("design:returntype",void 0)],Tn.prototype,"setTurnServer",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",void 0)],Tn.prototype,"setLicense",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Number]),V("design:returntype",void 0)],Tn.prototype,"startProxyServer",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Tn.prototype,"stopProxyServer",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",void 0)],Tn.prototype,"setLocalAccessPointsV2",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Array,String]),V("design:returntype",void 0)],Tn.prototype,"setLocalAccessPoints",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Number]),V("design:returntype",ut)],Tn.prototype,"setRemoteDefaultVideoStreamType",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object,Number]),V("design:returntype",ut)],Tn.prototype,"setRemoteVideoStreamType",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object,Number]),V("design:returntype",ut)],Tn.prototype,"setStreamFallbackOption",null),Tt([ce({argsMap:(s,e)=>[e]}),V("design:type",Function),V("design:paramtypes",[String,String,Uint8Array,Boolean]),V("design:returntype",void 0)],Tn.prototype,"setEncryptionConfig",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],Tn.prototype,"renewToken",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",void 0)],Tn.prototype,"enableAudioVolumeIndicator",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String,Boolean]),V("design:returntype",ut)],Tn.prototype,"startLiveStreaming",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Tn.prototype,"setLiveTranscoding",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",ut)],Tn.prototype,"stopLiveStreaming",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String,Object]),V("design:returntype",ut)],Tn.prototype,"addInjectStreamUrl",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Tn.prototype,"removeInjectStreamUrl",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[RC]),V("design:returntype",ut)],Tn.prototype,"startChannelMediaRelay",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[RC]),V("design:returntype",ut)],Tn.prototype,"updateChannelMediaRelay",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Tn.prototype,"stopChannelMediaRelay",null),Tt([ce({argsMap:(s,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Tn.prototype,"sendCustomReportMessage",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object,Object]),V("design:returntype",ut)],Tn.prototype,"pickSVCLayer",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Tn.prototype,"setRTMConfig",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Object]),V("design:returntype",ut)],Tn.prototype,"enableContentInspect",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",ut)],Tn.prototype,"disableContentInspect",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Boolean,Object]),V("design:returntype",ut)],Tn.prototype,"setImageModeration",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[String]),V("design:returntype",void 0)],Tn.prototype,"setP2PTransport",null),Tt([ce({reportResult:!0}),V("design:type",Function),V("design:paramtypes",[]),V("design:returntype",Array)],Tn.prototype,"getJoinChannelServiceRecords",null),Tt([ce(),V("design:type",Function),V("design:paramtypes",[Boolean]),V("design:returntype",ut)],Tn.prototype,"setPublishAudioFilterEnabled",null);class rh{constructor(e,i){A(this,"id",0),A(this,"element",void 0),A(this,"peerPair",void 0),A(this,"context",void 0),A(this,"audioPlayerElement",void 0),A(this,"audioTrack",void 0),rh.count+=1,this.id=rh.count,this.element=e,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const i=document.createElement("audio");i.srcObject=new MediaStream([e.track]),i.play(),this.audioPlayerElement=i}}async switchSdp(){if(!this.peerPair)return;const e=async(o,c)=>{const u=c==="offer"?await o.createOffer():await o.createAnswer();return await o.setLocalDescription(u),o.iceGatheringState==="complete"?o.localDescription:new ut(h=>{o.onicegatheringstatechange=()=>{o.iceGatheringState==="complete"&&h(o.localDescription)}})},i=async(o,c)=>await o.setRemoteDescription(c);try{const o=await e(this.peerPair[0],"offer");await i(this.peerPair[1],o);const c=await e(this.peerPair[1],"answer");await i(this.peerPair[0],c)}catch(o){throw new st(j.LOCAL_AEC_ERROR,o.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let i;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(i)}catch(c){throw new st(j.LOCAL_AEC_ERROR,c.toString()).print()}if(!i)throw new st(j.LOCAL_AEC_ERROR,"no dest node when local aec").print();const o=i.stream.getAudioTracks()[0];return this.audioTrack=o,o}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,i=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(i),await this.switchSdp()}close(){O.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}A(rh,"count",0);const Bs=window.AudioContext||window.webkitAudioContext;class TO{constructor(){A(this,"units",[]),A(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return O.debug("the system does not need to process local aec"),-1;this.context||(this.context=new Bs);let i=this.units.find(o=>o&&o.getElement()===e);return i||(i=new rh(e,this.context),this.units.push(i)),i.startEchoCancellation(),O.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return ln().name!==un.SAFARI}}Tt([ce({report:ne}),V("design:type",Function),V("design:paramtypes",[HTMLAudioElement]),V("design:returntype",Number)],TO.prototype,"processExternalMediaAEC",null);const Fg=new TO;function LE(s,e){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(s,c).enumerable})),i.push.apply(i,o)}return i}function SO(s){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?LE(Object(i),!0).forEach(function(o){A(s,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):LE(Object(i)).forEach(function(o){Object.defineProperty(s,o,Object.getOwnPropertyDescriptor(i,o))})}return s}const MC=window||document;function RO(s){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!MC)return;const i=ir._cspEventHandlerPointer;if(i&&e)return void console.error(i,e);const o=c=>{if(!(c&&c.blockedURI&&(ir.onSecurityPolicyViolation||ir.getListeners(Ha.SECURITY_POLICY_VIOLATION).length>0)))return;const u=c.blockedURI;Q("CSP_DETECTED_HOSTNAME_LIST").some(h=>Jt(u).call(u,h))&&(ir.onSecurityPolicyViolation&&typeof ir.onSecurityPolicyViolation=="function"&&ir.onSecurityPolicyViolation(c),ir.getListeners(Ha.SECURITY_POLICY_VIOLATION).length>0&&ir.safeEmit(Ha.SECURITY_POLICY_VIOLATION,c))};i&&MC.removeEventListener("securitypolicyviolation",i),(e||s&&typeof s=="function"||ir.getListeners(Ha.SECURITY_POLICY_VIOLATION).length>0)&&MC.addEventListener("securitypolicyviolation",o),ir._cspEventHandlerPointer=o}Mn("PROCESS_ID","process-".concat(Hn(8,""),"-").concat(Hn(4,""),"-").concat(Hn(4,""),"-").concat(Hn(4,""),"-").concat(Hn(12,""))),function(){let s;try{s=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void O.error("Error loading sdk config",e.message)}if(s)try{const e=JSON.parse(window.atob(s)),i=Date.now();O.debug("Loading global parameters from cache",e),Object.keys(e).forEach(o=>{if(Object.prototype.hasOwnProperty.call(bs,o)){const{value:c,expires:u}=e[o];if(u&&u<=i)return;Tl[o]=c,bs[o]=c}})}catch(e){O.error("Error loading mutableParamsCache: ".concat(s),e.message)}}(),Array.isArray(Tl.AREAS)&&Tl.AREAS.length>0&&yl(Tl.AREAS,!0);const A1=(s,e,i)=>{O.debug("setParameter key:".concat(s,", value:").concat(JSON.stringify(e))),Mn(s,e,i)},ir=function(s){const e=new oi,i=s,o={getListeners:e.getListeners.bind(e),on:(c,u)=>(function(h,_){h===Ha.SECURITY_POLICY_VIOLATION&&RO(_,!0)}(c,u),e.on.bind(e)(c,u)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return SO(SO({},i),o)}({__TRACK_LIST__:J_,VERSION:Ga,BUILD:oR,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:A1,getParameter:Q,getSupportedCodec:async function(){let s={audio:[],video:[]};try{let e=new RTCPeerConnection;e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const i=(await e.createOffer()).sdp;if(!i)return s;e.close(),e=null,s=function(o){const c={video:[],audio:[]};return o.match(/ VP8/i)&&c.video.push("VP8"),o.match(/ VP9/i)&&c.video.push("VP9"),o.match(/ AV1/i)&&c.video.push("AV1"),o.match(/ H264/i)&&c.video.push("H264"),o.match(/ H265/i)&&c.video.push("H265"),o.match(/ opus/i)&&c.audio.push("OPUS"),o.match(/ PCMU/i)&&c.audio.push("PCMU"),o.match(/ PCMA/i)&&c.audio.push("PCMA"),o.match(/ G722/i)&&c.audio.push("G722"),c}(i)}catch(e){throw new st(j.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return s},checkSystemRequirements:function(){const s=ne.reportApiInvoke(null,{name:tr.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:gi.TRACER});let e=!1;try{const u=window.RTCPeerConnection,h=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,_=window.WebSocket;e=!!(u&&h&&_)}catch(u){return O.error("check system requirement failed: ",u),!1}let i=!1;const o=ln();o.name===un.CHROME&&Number(o.version)>=58&&(!JP()||zP())&&(i=!0),o.name===un.FIREFOX&&Number(o.version)>=56&&(i=!0),o.name===un.OPERA&&Number(o.version)>=45&&(i=!0),o.name===un.SAFARI&&Number(o.version)>=11&&(i=!0),(A_()||ln().name===un.QQ)&&(i=!0),O.debug("checkSystemRequirements, api:",e,"browser",i);const c=e&&i;return s.onSuccess(c),c},getDevices:function(s){return _a.enumerateDevices(!0,!0,s)},getMicrophones:function(s){return _a.getRecordingDevices(s)},getCameras:function(s){return _a.getCamerasDevices(s)},getElectronScreenSources:vb,getPlaybackDevices:function(s){return _a.getSpeakers(s)},createClient:function(){var s;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const i=ne.reportApiInvoke(null,{name:tr.CREATE_CLIENT,options:[e],tag:gi.TRACER});try{(function(o){cr(o.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),cr(o.mode,"config.mode",["rtc","live","p2p"]),o.audioCodec!==void 0&&cr(o.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),o.proxyServer!==void 0&&fs(o.proxyServer,"config.proxyServer",1,1e4),o.turnServer!==void 0&&sL(o.turnServer),o.httpRetryConfig!==void 0&&rL(o.httpRetryConfig),o.websocketRetryConfig!==void 0&&rL(o.websocketRetryConfig)})(e)}catch(o){throw i.onError(o),o}return y1()||(e.codec==="vp9"&&(e.codec="vp8",O.debug("browser not support vp9, force use vp8")),Mn("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),i.onSuccess(),new Tn(Gc(Gc({forceWaitGatewayResponse:!0},e),{},{role:Jt(s=["rtc","p2p"]).call(s,e.mode)?"host":e.role||"audience"}))},createCameraVideoTrack:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_CAM_VIDEO_TRACK,options:[$_({},s)]}),i=Nf(s),o=Hn(8,"track-cam-");let c=null;const u=s.encoderConfig==="720p_auto";O.info("start create camera video track with config",JSON.stringify(s),"trackId",o);try{c=(await pa({video:i},o)).getVideoTracks()[0]||null}catch(_){throw e.onError(_),_}if(!c){const _=new ft(j.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(_),_.throw(O)}s.optimizationMode&&ma(o,c,s,dd(s.encoderConfig));const h=new Rs(c,s,i,s.scalabiltyMode?hp(s.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},s.optimizationMode,o);return u&&h.startMonitorStats(),e.onSuccess(h.getTrackId()),O.info("create camera video success, trackId:",o),h},createCustomVideoTrack:function(s){const e=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_CUSTOM_VIDEO_TRACK,options:[s]}),i=new ke(s.mediaStreamTrack,{width:s.width,height:s.height,frameRate:s.frameRate,bitrateMax:s.bitrateMax,bitrateMin:s.bitrateMin},s.scalabiltyMode?hp(s.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},s.optimizationMode,Hn(8,"track-cus-"),[Fn.CUSTOM_TRACK]);return e.onSuccess(i.getTrackId()),O.info("create custom video track success with config",s,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const i=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_SCREEN_VIDEO_TRACK,options:[$_({},s),e]}),o=s.encoderConfig==="720p_auto";s.encoderConfig?typeof s.encoderConfig=="string"||s.encoderConfig.width&&s.encoderConfig.height||(s.encoderConfig.width={max:1920},s.encoderConfig.height={max:1080}):s.encoderConfig="1080p_2";const c=function(C){const I={};C.screenSourceType&&(I.mediaSource=C.screenSourceType),C.extensionId&&Nu()&&(I.extensionId=C.extensionId);const{displaySurface:b,selfBrowserSurface:x,surfaceSwitching:D,systemAudio:M}=C;(IA(107)||XP(107)||QP(93))&&(b&&(cr(b,"displaySurface",["browser","window","monitor"]),I.displaySurface=b),x?(cr(x,"selfBrowserSurface",["exclude","include"]),I.selfBrowserSurface=x):I.selfBrowserSurface="include",D&&(cr(D,"surfaceSwitching",["exclude","include"]),I.surfaceSwitching=D)),(IA(105)||XP(105)||QP(91))&&M&&(cr(M,"systemAudio",["exclude","include"]),I.systemAudio=M),C.electronScreenSourceId&&(I.sourceId=C.electronScreenSourceId);const K=C.encoderConfig?q_(C.encoderConfig):null;return I.mandatory={chromeMediaSource:"desktop",maxWidth:K?K.width:void 0,maxHeight:K?K.height:void 0},K&&(K.frameRate&&(typeof K.frameRate=="number"?(I.mandatory.maxFrameRate=K.frameRate,I.mandatory.minFrameRate=K.frameRate):(I.mandatory.maxFrameRate=K.frameRate.max||K.frameRate.ideal||K.frameRate.exact||void 0,I.mandatory.minFrameRate=K.frameRate.min||K.frameRate.ideal||K.frameRate.exact||void 0),I.frameRate=K.frameRate),K.width&&(I.width=K.width),K.height&&(I.height=K.height)),I}(s),u=Hn(8,"track-scr-v-");let h=null,_=null;const m=sn();if(!m.supportShareAudio&&e==="enable"){const C=new ft(j.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(C),C.throw(O)}O.info("start create screen video track with config",s,"withAudio",e,"trackId",u);try{const C=await pa({screen:c,screenAudio:e==="auto"?m.supportShareAudio:e==="enable"},u);h=C.getVideoTracks()[0]||null,_=C.getAudioTracks()[0]||null}catch(C){throw i.onError(C),C}if(!h){const C=new ft(j.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(C),C.throw(O)}if(!_&&e==="enable"){h&&h.stop();const C=new ft(j.SHARE_AUDIO_NOT_ALLOWED);return i.onError(C),C.throw(O)}s.optimizationMode||(s.optimizationMode="detail"),s.optimizationMode&&(ma(u,h,s,s.encoderConfig&&q_(s.encoderConfig)||void 0),s.encoderConfig&&typeof s.encoderConfig!="string"&&(s.encoderConfig.bitrateMin=s.encoderConfig.bitrateMax));const g=new ke(h,s.encoderConfig?q_(s.encoderConfig):{},s.scalabiltyMode?hp(s.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},s.optimizationMode,u,[Fn.SCREEN_TRACK]);if(o&&g.startMonitorStats(),!_)return i.onSuccess(g.getTrackId()),O.info("create screen video track success","video:",g.getTrackId()),g;const S=new Nn(_,void 0,Hn(8,"track-scr-a-"),!1);return i.onSuccess([g.getTrackId(),S.getTrackId()]),O.info("create screen video track success","video:",g.getTrackId(),"audio:",S.getTrackId()),[g,S]},createMicrophoneAndCameraTracks:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_MIC_AND_CAM_TRACKS,options:[s,e]}),o=e.encoderConfig==="720p_auto",c=Nf(e),u=wk(s),h=Hn(8,"track-mic-"),_=Hn(8,"track-cam-");let m=null,g=null;O.info("start create camera video track(".concat(_,") and microphone audio track(").concat(h,") with config, audio: ").concat(JSON.stringify(s),", video: ").concat(JSON.stringify(e)));try{const I=await pa({audio:u,video:c},"".concat(h,"-").concat(_));m=I.getAudioTracks()[0],g=I.getVideoTracks()[0]}catch(I){throw i.onError(I),I}if(!m||!g){const I=new ft(j.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(I),I.throw(O)}e.optimizationMode&&ma(_,g,e,dd(e.encoderConfig));const S=new wl(m,s,u,h),C=new Rs(g,e,c,e.scalabiltyMode?hp(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,_);return o&&C.startMonitorStats(),i.onSuccess([S.getTrackId(),C.getTrackId()]),O.info("create camera video track(".concat(_,") and microphone audio track(").concat(h,") success")),[S,C]},createMicrophoneAudioTrack:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_MIC_AUDIO_TRACK,options:[s]}),i=wk(s),o=Hn(8,"track-mic-");let c=null;O.info("start create microphone audio track with config",JSON.stringify(s),"trackId",o);try{c=(await pa({audio:i},o)).getAudioTracks()[0]||null}catch(h){throw e.onError(h),h}if(!c){const h=new ft(j.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(h),h.throw(O)}const u=new wl(c,s,i,o);return e.onSuccess(u.getTrackId()),O.info("create microphone audio track success, trackId:",o),u},createCustomAudioTrack:function(s){const e=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_CUSTOM_AUDIO_TRACK,options:[s]}),i=new Nn(s.mediaStreamTrack,s.encoderConfig?z_(s.encoderConfig):{},Hn(8,"track-cus-"),!1);return O.info("create custom audio track success with config",s,"trackId",i.getTrackId()),e.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(s){var e;const{cacheOnlineFile:i,encoderConfig:o}=s;let{source:c}=s;const u={source:c instanceof AudioBuffer?"AudioBuffer":c instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":c,cacheOnlineFile:i,encoderConfig:o},h=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CREATE_BUFFER_AUDIO_TRACK,options:[u]});if(Q("DISABLE_WEBAUDIO"))throw new ft(j.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const _=Hn(8,"track-buf-");O.info("start create buffer source audio track with config",JSON.stringify(u),"trackId",_);const m=c;if(!(c instanceof AudioBuffer))try{c=await Sj(c,i)}catch(C){return h.onError(C),C.throw(O)}const g=new Tj(c),S=new Ol(m,g,o?z_(o):{},_);return O.info("create buffer source audio track success, trackId:",_),h.onSuccess(S.getTrackId()),S},setAppType:function(s){if(O.debug("setAppType: ".concat(s)),!(Number.isInteger(s)&&s>=0))throw O.debug("Invalid appType"),new st(j.INVALID_PARAMS,"invalid app type",s);Mn("APP_TYPE",Math.floor(s))},setLogLevel:function(s){O.setLogLevel(s)},enableLogUpload:function(){Q("USE_NEW_LOG")?Mn("UPLOAD_LOG",!0):O.enableLogUpload()},disableLogUpload:function(){Q("USE_NEW_LOG")?Mn("UPLOAD_LOG",!1):O.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new RC},checkAudioTrackIsActive:async function(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(s instanceof Nn||s instanceof ue)){const m=new st(j.INVALID_TRACK,"the parameter is not a audio track");return i.onError(m),m.throw()}e&&e<1e3&&(e=1e3);const o=s instanceof Nn?s.getTrackLabel():"remote_track",c=s.getVolumeLevel();let u=c,h=c;const _=Date.now();return new ut(m=>{const g=setInterval(()=>{const S=s.getVolumeLevel();u=S>u?S:u,h=S<h?S:h;const C=u-h>1e-4,I=Date.now()-_;if(C||I>e){clearInterval(g);const b=C,x={duration:I,deviceLabel:o,maxVolumeLevel:u,result:b};O.info("[track-".concat(s.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(x))),i.onSuccess(x),m(b)}},200)})},checkVideoTrackIsActive:async function(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=ne.reportApiInvoke(null,{tag:gi.TRACER,name:tr.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(s instanceof ke||s instanceof fe)){const C=new st(j.INVALID_TRACK,"the parameter is not a video track");return i.onError(C),C.throw()}e&&e<1e3&&(e=1e3);const o=s instanceof ke?s.getTrackLabel():"remote_track",c=s.getMediaStreamTrack(!0),u=document.createElement("video");u.style.width="1px",u.style.height="1px",u.setAttribute("muted",""),u.muted=!0,u.setAttribute("playsinline",""),u.controls=!1,(Or()||DS())&&(u.style.opacity="0.01",u.style.position="fixed",u.style.left="0",u.style.top="0",document.body.appendChild(u)),u.srcObject=new MediaStream([c]),u.play();const h=document.createElement("canvas");h.width=160,h.height=120;let _=0,m=0;try{const C=Date.now();_=await function(I,b,x,D){let M,K=0,z=null;return new ut((nt,dt)=>{function it(){K>D&&M&&(M(),nt(K));const at=x.getContext("2d");if(!at){const bt=new st(j.UNEXPECTED_ERROR,"can not get canvas 2d context.");return O.error(bt.toString()),void dt(bt)}at.drawImage(I,0,0,160,120);const ht=at.getImageData(0,0,x.width,x.height),pt=Math.floor(ht.data.length/3);if(z){for(let bt=0;bt<pt;bt+=3)if(ht.data[bt]!==z[bt])return K+=1,void(z=ht.data);z=ht.data}else z=ht.data}setTimeout(()=>{M&&(M(),nt(K))},b),M=pi(()=>{it()},30)})}(u,e,h,4),m=Date.now()-C}catch(C){throw i.onError(C),C}je===un.SAFARI&&(u.pause(),u.remove()),u.srcObject=null;const g=_>4,S={duration:m,changedPicNum:_,deviceLabel:o,result:g};return O.info("[track-".concat(s.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(S))),i.onSuccess(S),g},setArea:yl,audioElementPlayCenter:Qs,resumeAudioContext:function(){Qs.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(s){Fg.processExternalMediaAEC(s)},registerExtensions:function(s){const e=Q("PLUGIN_INFO")||[];s.forEach(i=>{"name"in i&&!Jt(e).call(e,i.name)&&e.push(i.name);const o=i;o.__registered__=!0,o.logger.hookLog=O.extLog,o.reporter.hookApiInvoke=ne.extApiInvoke,o.parameters&&Object.keys(o.parameters).forEach(c=>{o.parameters[c]=Q(c)})}),A1("PLUGIN_INFO",e)},ChannelMediaRelayError:Kd,ChannelMediaRelayEvent:aa,ChannelMediaRelayState:ws,RemoteStreamFallbackType:yf,RemoteStreamType:Vr,ConnectionDisconnectedReason:Fe,AudienceLatencyLevelType:AA,AREAS:tn});return Object.defineProperties(ir,{onAudioAutoplayFailed:{get:()=>Ea.onAudioAutoplayFailed,set:s=>{Ea.onAudioAutoplayFailed=s}},onAutoplayFailed:{get:()=>Ea.onAutoplayFailed,set:s=>{Ea.onAutoplayFailed=s}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>ir._onSecurityPolicyViolation,set(s){ir._onSecurityPolicyViolation=s,RO(s)}},__CLIENT_LIST__:{get:()=>Q("SHOW_GLOBAL_CLIENT_LIST")?Cl:[]}}),_a.on(Kn.CAMERA_DEVICE_CHANGED,s=>{O.info("camera device changed",JSON.stringify(s)),ir.onCameraChanged&&ir.onCameraChanged(s),ir.safeEmit(Ha.CAMERA_CHANGED,s)}),_a.on(Kn.RECORDING_DEVICE_CHANGED,s=>{O.info("microphone device changed",JSON.stringify(s)),ir.onMicrophoneChanged&&ir.onMicrophoneChanged(s),ir.safeEmit(Ha.MICROPHONE_CHANGED,s)}),_a.on(Kn.PLAYOUT_DEVICE_CHANGED,s=>{O.debug("playout device changed",JSON.stringify(s)),ir.onPlaybackDeviceChanged&&ir.onPlaybackDeviceChanged(s),ir.safeEmit(Ha.PLAYBACK_DEVICE_CHANGED,s)}),Qs.onAutoplayFailed=()=>{O.info("detect audio element autoplay failed"),Ea.onAudioAutoplayFailed&&Ea.onAudioAutoplayFailed()},N.on("autoplay-failed",()=>{O.info("detect webaudio autoplay failed"),Ea.onAudioAutoplayFailed&&Ea.onAudioAutoplayFailed(),ir.safeEmit(Ha.AUTOPLAY_FAILED)}),N.on(hr.STATE_CHANGE,(s,e)=>{O.info("audio context state changed: ".concat(e," => ").concat(s)),ir.onAudioContextStateChanged&&ir.onAudioContextStateChanged(s,e),ir.safeEmit(Ha.AUDIO_CONTEXT_STATE_CHANGED,s,e)}),er.on(Pu.NETWORK_STATE_CHANGE,(s,e)=>{O.info("[network-indicator] network state changed, ".concat(e," => ").concat(s))}),window&&(window.__ARTC__=ir),ir})})(T5);const KG=o5(T5.exports);var uo;(function(Y){Y[Y.INIT=0]="INIT",Y[Y.START_RECORD=1]="START_RECORD",Y[Y.CLOSED=2]="CLOSED",Y[Y.SET_TRACKS=3]="SET_TRACKS",Y[Y.SET_CREDENTIALS=4]="SET_CREDENTIALS",Y[Y.SET_ERROR=5]="SET_ERROR",Y[Y.CLOSING=6]="CLOSING"})(uo||(uo={}));const dK=()=>({loading:!1,finish:!1,errorType:void 0}),uK=(Y=dK(),Z)=>{switch(Z.type){case uo.INIT:case uo.CLOSING:return Object.assign(Object.assign({},Y),{loading:!0,errorType:Z.type===uo.INIT?void 0:Y.errorType,finish:!1,tracks:void 0,credentials:void 0});case uo.START_RECORD:return Object.assign(Object.assign({},Y),{loading:!1,finish:!1});case uo.CLOSED:case uo.SET_ERROR:return Object.assign(Object.assign({},Y),{tracks:void 0,credentials:void 0,errorType:Z.type===uo.SET_ERROR?Z.payload:Y.errorType,finish:Z.type===uo.CLOSED?!Z.payload:Y.finish,loading:!1});case uo.SET_TRACKS:return Object.assign(Object.assign({},Y),{tracks:!0});case uo.SET_CREDENTIALS:return Object.assign(Object.assign({},Y),{credentials:Z.payload})}},lK=":host{--video-contracting-color-primary:#604fc6;--video-contracting-color-secondary:#572BB6;--video-contracting-color-success:#2CC13D;--video-contracting-color-error:#EB184C;--video-contracting-color-loading:#fff;display:block;height:100%;width:100%}video-container{display:flex;flex:1}",hK=lK;KG.setLogLevel(4);const pK=class{constructor(Y){ph(this,Y),this.finishVideo=Eu(this,"finishVideo"),this.userCancel=Eu(this,"userCancel"),this.errorException=Eu(this,"errorException"),this.store=cK,this.handleRecording=Z=>{this.recording=Z},this.handleCredentials=Z=>{Z&&this.setCredentials(Z)},this.handleErrorWs=Z=>{Z&&this.setError("exception")},this.handleTimeoutWs=()=>{this.setError("timeout")},this.handleClosedWs=()=>{this.closedVideo(this.close)},this.initWs=()=>{const{setParams:Z,getCredentials:ct,startRecord:mt,stopRecord:Rt}=bH({apiUrl:this.apiUrl,apiKey:this.apiKey,handleRecording:this.handleRecording.bind(this),handleCredentials:this.handleCredentials.bind(this),handleError:this.handleErrorWs.bind(this),handleClosed:this.handleClosedWs.bind(this),handleTimeout:this.handleTimeoutWs.bind(this)});Z({operation:this.operationId,tenant:this.tenantId}),this.getCredentials=ct,this.startRecordWS=mt,this.stopRecordWS=Rt},this.handleTime=Z=>{this.time=Z},this.initTime=()=>{const{start:Z,stop:ct}=a5({onChange:this.handleTime.bind(this)});this.startElapsedTime=Z,this.stopElapsedTime=ct},this.stopClient=async()=>{this.agoraClient.connectionState==="CONNECTED"&&(await this.agoraClient.leave(),this.agoraClient.removeAllListeners())},this.handleStop=()=>{this.stopElapsedTime(),this.stopRecordWS(),this.recording&&this.closingVideo(),this.stopClient()},this.handleStart=async()=>{if(!this.operationId)this.setError("exception");else{this.currentState=0,this.initVideo();try{const Z=await KG.createMicrophoneAndCameraTracks(void 0,{facingMode:"user",encoderConfig:"720p_6"});this.setTracks(),this.videoTracks=Z}catch{this.setError("permissions")}}},this.removeInterval=()=>{this.stateInterval&&(clearInterval(this.stateInterval),this.stateInterval=null)},this.handleClose=Z=>{this.handleStop(),this.close=!0,Z.detail?this.finishVideo.emit(Z.detail):this.userCancel.emit()},this.apiUrl=void 0,this.apiKey=void 0,this.operationId=void 0,this.tenantId=void 0,this.language=void 0,this.fullScreen=void 0,this.close=!1,this.loading=void 0,this.finish=void 0,this.recording=void 0,this.credentials=void 0,this.videoTracks=void 0,this.tracks=void 0,this.currentState=0,this.time="",this.errorType=void 0}async componentWillLoad(){this.agoraClient=KG.createClient({mode:"rtc",codec:"vp8"}),this.store.setStore(aK({reducer:uK})),this.store.mapDispatchToProps(this,{setError:Y=>Z=>{Z({type:uo.SET_ERROR,payload:Y})},initVideo:()=>Y=>{Y({type:uo.INIT})},closingVideo:()=>Y=>{Y({type:uo.CLOSING})},closedVideo:Y=>Z=>{Z({type:uo.CLOSED,payload:Y})},setCredentials:Y=>Z=>{Z({type:uo.SET_CREDENTIALS,payload:Y})},setTracks:()=>Y=>{Y({type:uo.SET_TRACKS})},startRecord:()=>Y=>{Y({type:uo.START_RECORD})}}),this.storeUnsubscribe=this.store.mapStateToProps(this,Y=>Y||{}),this.initWs(),this.initTime()}async watchVideoTracks(Y,Z){this.tracks&&(Z&&this.credentials&&Z.forEach(ct=>{ct.stop(),ct.close()}),this.credentials||this.getCredentials())}async watchCrendentials(){if(this.credentials)try{await this.agoraClient.join(this.credentials.appId,this.credentials.channel,this.credentials.cameraToken,this.credentials.cameraUid),await this.agoraClient.publish([this.videoTracks[0],this.videoTracks[1]]),this.startRecordWS()}catch{this.setError("exception")}}watchRecording(){this.recording?(this.startRecord(),this.startElapsedTime(),this.stateInterval=setInterval(()=>{this.currentState+=1},5e3)):(this.removeInterval(),this.currentState=0)}watchErrorType(){this.errorType&&(this.handleStop(),this.errorException.emit(this.errorType))}watchCurrentState(Y){Y===MG.length&&(this.removeInterval(),this.handleStop())}watchTracks(){!this.tracks&&this.videoTracks&&(this.videoTracks.forEach(Y=>{Y.stop(),Y.close()}),this.videoTracks=null)}disconnectedCallback(){this.storeUnsubscribe(),this.handleStop()}render(){var Y;return he(JO,{key:"ca4d33ab8c46984d5739993619be2b022d02d93a"},!this.close&&he("screen-layout",{key:"1dd0c3a6411107864059afbe34dfc9751d2dfd97",onHandleCloseLayout:this.handleClose.bind(this),fullScreen:this.fullScreen,state:this.time?MG[this.currentState]:void 0,time:this.time,language:this.language},he("video-container",{key:"3e10a5bfd1661f0be7c7e3f9f1464ca4b1feeea7",loading:this.loading,state:this.time?MG[this.currentState]:void 0,language:this.language,error:this.errorType,onHandleClose:Z=>this.handleClose(Z),onHandleStart:this.handleStart.bind(this),video:(Y=this.videoTracks)===null||Y===void 0?void 0:Y[1],finish:this.finish})))}static get watchers(){return{videoTracks:["watchVideoTracks"],credentials:["watchCrendentials"],recording:["watchRecording"],errorType:["watchErrorType"],currentState:["watchCurrentState"],tracks:["watchTracks"]}}};pK.style=hK;export{yK as choose_document,sH as country_widget,cH as desktop_view,lH as facephi_voice_recognition,_H as loading_ellipsis,fH as radio_group,SH as results_info,vH as results_loading,bK as tip_widget,AH as upload_widget,PH as video_assistance,pK as video_recruitment};
